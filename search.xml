<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>OSGI: (二) Apache Felix 介绍 </title>
    <url>/2020/04/13/OSGI-%E4%BA%8C-Apache-Felix-%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h2 id="Felix-项目历史"><a href="#Felix-项目历史" class="headerlink" title="Felix 项目历史"></a>Felix 项目历史</h2><p>作为<a href="http://apache.org" target="_blank" rel="noopener">Apache</a>旗下的其中一个项目，<a href="http://felix.apache.org" target="_blank" rel="noopener">Felix</a>在2006年就拥有了自己的网站。不过一开始似乎进展并不快，直到2007年的七月，才发布了自己的1.0.0版本，其后他们发布了很多与Felix框架相关的<a href="http://maven.apache.org" target="_blank" rel="noopener">Maven</a>插件，到了2008年初，开始对纲要标准（Compendium Specification）进行部分实现。此后Felix项目的发展壮大非常的迅速，那时候的OSGi标准也日趋稳定和完善。时至今日，Felix项目不仅包含了一个OSGi R4(到今天为止，准确的版本号是4.2)服务平台标准的实现，在此之外还包含了很多OSGi相关的技术和功能（非标准），他们能帮助OSGi框架更好的发挥作用. </p>
<h2 id="Felix-项目概述"><a href="#Felix-项目概述" class="headerlink" title="Felix 项目概述"></a>Felix 项目概述</h2><p>整个Felix项目被分解为了若干个子项目，我们可以从SVN上将Felix检出： </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">svn checkout http://svn.apache.org/repos/asf/felix/trunk felix-trunk</span><br></pre></td></tr></table></figure>

<p>完成了上述操作后，我们可以看到有整整57个文件夹，里面除了examples（示例程序）、src（无关紧要的内容，一些图片和css）、commons（项目需要用到的公共包，比如beanutils），还有pom（里面是总体的pom文件）这4个文件夹外，基本都是与Felix项目直接相关的代码，里面除了一些已经发布的，还有非常多的未发布项目。 </p>
<h3 id="Felix对标准的实现情况"><a href="#Felix对标准的实现情况" class="headerlink" title="Felix对标准的实现情况"></a>Felix对标准的实现情况</h3><p>下面我们从一个总体的角度来看看Felix对标准的那些内容进行了实现： </p>
<h4 id="2-1-1-核心标准-Core-Specification"><a href="#2-1-1-核心标准-Core-Specification" class="headerlink" title="2.1.1 核心标准(Core Specification)"></a>2.1.1 核心标准(Core Specification)</h4><p>Felix对核心标准的实现都是通过了[OSGi联盟][OSGi Alliance]认证的。 </p>
<table>
<thead>
<tr>
<th>标准名称</th>
<th>版本号</th>
<th>Felix中的子项目</th>
<th>项目版本</th>
</tr>
</thead>
<tbody><tr>
<td>Framework</td>
<td>R4.2</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Package Admin</td>
<td>1.2 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Start Level</td>
<td>1.1 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Permission Admin</td>
<td>R4.2</td>
<td>Framework Security</td>
<td>1.4.0</td>
</tr>
<tr>
<td>Conditional Permission Admin</td>
<td>R4.2</td>
<td>Framework Security</td>
<td>1.4.0</td>
</tr>
<tr>
<td>URL Handlers</td>
<td>1.0 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Service Hooks</td>
<td>1.0 (R4.2)</td>
<td>Framework</td>
<td></td>
</tr>
</tbody></table>
<h4 id="2-1-2-纲要标准-Compendium-Specification"><a href="#2-1-2-纲要标准-Compendium-Specification" class="headerlink" title="2.1.2 纲要标准(Compendium Specification)"></a>2.1.2 纲要标准(Compendium Specification)</h4><p>在这里我们只把实现并且已经发布过的子项目列举出来： </p>
<table>
<thead>
<tr>
<th>标准名称</th>
<th>版本号</th>
<th>Felix中的子项目</th>
<th>项目版本</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Log Service</td>
<td>1.3 (R4.2)</td>
<td>Log</td>
<td>1.0.0</td>
<td></td>
</tr>
<tr>
<td>Http Service</td>
<td>1.2 (R4.2)</td>
<td>Http Service Projects</td>
<td>2.0.4</td>
<td></td>
</tr>
<tr>
<td>Configuration Admin</td>
<td>1.3 (R4.2)</td>
<td>Configuration Admin</td>
<td>1.2.8</td>
<td>参考实现</td>
</tr>
<tr>
<td>Metatype</td>
<td>1.1 (R4.2)</td>
<td>Metatype</td>
<td>1.0.4</td>
<td>—</td>
</tr>
<tr>
<td>Preferences</td>
<td>1.1 (R4.2)</td>
<td>Preferences</td>
<td>1.0.4</td>
<td>—</td>
</tr>
<tr>
<td>UPnP Device</td>
<td>1.1 (R4.2)</td>
<td>UPnP Base Driver</td>
<td>0.8.0</td>
<td>—</td>
</tr>
<tr>
<td>Declarative Services</td>
<td>1.1 (R4.2)</td>
<td>SCR</td>
<td>1.6.0</td>
<td>通过了R4.2相应的服从测试</td>
</tr>
<tr>
<td>Event Admin</td>
<td>1.2 (R4.2)</td>
<td>Event Admin</td>
<td>1.2.8</td>
<td>同上</td>
</tr>
<tr>
<td>Blueprint</td>
<td>1.0 (R4.2)</td>
<td></td>
<td></td>
<td>由Apache Aries实现</td>
</tr>
<tr>
<td>Tracker</td>
<td>1.4 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
<td>OSG</td>
</tr>
</tbody></table>
<h3 id="2-2-标准以外的相关技术实现"><a href="#2-2-标准以外的相关技术实现" class="headerlink" title="2.2 标准以外的相关技术实现"></a>2.2 标准以外的相关技术实现</h3><h4 id="2-2-1-用于简化OSGi开发的子项目"><a href="#2-2-1-用于简化OSGi开发的子项目" class="headerlink" title="2.2.1 用于简化OSGi开发的子项目"></a>2.2.1 用于简化OSGi开发的子项目</h4><ul>
<li><p><a href="http://felix.apache.org/site/apache-felix-dependency-manager.html" target="_blank" rel="noopener">Dependency Manager</a> </p>
<p>在OSGi基于服务的体系结构中，应用是由一个个组件建立起来的，每个组件分别依赖和发布了一些服务，这样这些服务就形成了一个网络。但是由于其动态性，这个网络的结构总是在不停的变化，所以开发者总是不得不考虑和应对这样的变化，OSGi本身提供了服务的listener和tracker这两个机制来捕捉和监控服务的状态变化，但是对于开发者来说这个太底层了。而这个工具提供给我们了一套JavaAPI来声明式的定义和管理这些依赖。</p>
</li>
<li><p><a href="http://felix.apache.org/site/apache-felix-ipojo.html" target="_blank" rel="noopener">iPOJO</a></p>
<p>这是一个相当大的项目，从这个项目的主页上就可以看出Felix项目在这个子项目上花了很多精力，可以说是在OSGi基础上的一个革新。</p>
<p>iPOJO是一个用于简化OSGi开发的服务组件运行时，它本身支持了所有OSGi的动态性。它基于<a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object" target="_blank" rel="noopener">POJO</a>的概念简化了程序逻辑的开发，任何非功能性的对象属性只在运行的时候被注入进来。它主要有以下几个特点：</p>
<ul>
<li>开发组件的时候只需要定义POJO即可，没有多余的工作</li>
<li>组件模型可扩展，所以很容易根据你的需要来调整</li>
<li>标准的组件模型会管理服务的提供与依赖</li>
<li>iPOJO管理组件实例的生命周期和OSGi环境的动态性，这是前所未有的</li>
<li>为了创建高动态性的应用，iPOJO提供了一个强大的组装系统</li>
<li>iPOJO支持标注、XML和JavaAPI来定义组件</li>
</ul>
<p>如果有机会，我会在一篇单独的文档中详细的介绍iPOJO。</p>
</li>
</ul>
<h4 id="2-2-2-Shell"><a href="#2-2-2-Shell" class="headerlink" title="2.2.2 Shell"></a>2.2.2 Shell</h4><ul>
<li><a href="http://felix.apache.org/site/apache-felix-gogo.html" target="_blank" rel="noopener">Gogo</a> - 用来和OSGi交互的较为常用的shell，除了基本的框架命令，其中还包含grep，cat，echo这类指令，并且可以自定义宏命令。</li>
<li><a href="http://felix.apache.org/site/apache-felix-shell.html" target="_blank" rel="noopener">Shell</a> - 这个子项目只提供了单纯的shell服务API，而没有提供用户界面。</li>
<li><a href="http://felix.apache.org/site/apache-felix-shell-tui.html" target="_blank" rel="noopener">Shell TUI</a> - Apache Felix Shell的文字界面，相比gogo来说更为简单，但是不怎么常用，他的使用依赖于shell bundle。</li>
<li><a href="http://felix.apache.org/site/apache-felix-remote-shell.html" target="_blank" rel="noopener">Remote Shell</a> - Apache Felix Shell的远程文字界面，我们通过这个工具可以在其他终端上远程操作Felix。</li>
</ul>
<h4 id="2-2-3-Maven插件"><a href="#2-2-3-Maven插件" class="headerlink" title="2.2.3 Maven插件"></a>2.2.3 Maven插件</h4><ul>
<li><p><a href="http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html" target="_blank" rel="noopener">Maven Bundle Plugin</a></p>
<p>这个插件用于简化Bundle的构建，可以将一个bundle看做以个Maven工程，其中还包括自动化对OSGi Bundle仓库的管理。它的前身曾经是OBR Plugin和OSGi Plugin这两个插件。</p>
</li>
<li><p><a href="http://felix.apache.org/site/apache-felix-maven-scr-plugin.html" target="_blank" rel="noopener">Maven SCR Plugin</a></p>
<p>这个插件的主要作用是帮助用户生成OSGi中使用Declarative Services, Config Admin和Metatype services这三个功能所必要的信息，这样就简化了用户的操作。</p>
</li>
</ul>
<h4 id="2-2-4-其他"><a href="#2-2-4-其他" class="headerlink" title="2.2.4 其他"></a>2.2.4 其他</h4><ul>
<li><a href="http://felix.apache.org/site/apache-felix-file-install.html" target="_blank" rel="noopener">File Install</a> - 用来管理bundle部署及其目录的一个简单的代理。</li>
<li><a href="http://felix.apache.org/site/apache-felix-osgi-bundle-repository.html" target="_blank" rel="noopener">OSGi Bundle Repository</a> - 帮助我们更好的发现和部署bundle和bundle的依赖。</li>
<li><a href="http://felix.apache.org/site/apache-felix-web-console.html" target="_blank" rel="noopener">Web Console</a> - 基于web的Felix控制台。</li>
</ul>
<h2 id="3-Felix-基本运行环境配置"><a href="#3-Felix-基本运行环境配置" class="headerlink" title="3 Felix 基本运行环境配置"></a>3 Felix 基本运行环境配置</h2><h3 id="3-1-Felix执行环境的下载"><a href="#3-1-Felix执行环境的下载" class="headerlink" title="3.1 Felix执行环境的下载"></a>3.1 Felix执行环境的下载</h3><p>进入下载页面，选择Felix Framework Distribution的下载项：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//felix.apache.org/downloads.cgi?Preferred=https%3A%2F%2Fmirror.bit.edu.cn%2Fapache%2F</span></span><br></pre></td></tr></table></figure>

<p>如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu305.png" width="60%">

<h3 id="3-2-启动Felix"><a href="#3-2-启动Felix" class="headerlink" title="3.2 启动Felix"></a>3.2 启动Felix</h3><p>将下载好的包解压，从命令行进入这个文件夹的根目录，执行如下命令，进入到Felix的命令行：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar bin/felix.jar</span><br></pre></td></tr></table></figure>

<p>如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu306.png" width="60%">

<p>这样我们就进入了Felix的执行环境，可以通过Shell与框架进行一些交互 </p>
<h3 id="3-3-一些简单的命令"><a href="#3-3-一些简单的命令" class="headerlink" title="3.3 一些简单的命令"></a>3.3 一些简单的命令</h3><p>在这个命令行下输入help我们就可以看到大部分的指令，由于数量不少，不在这里一一列出。为了避免命令名字的冲突，这些命令都有自己的名字空间，现有的名字空间有三种：</p>
<ul>
<li>felix - 关于felix框架的核心命令，比如列出所有bundle，安装/卸载bundle等等</li>
<li>gogo - 包含grep，cat，echo这类的指令，并且gogo是个Felix的子项目，他是参照<a href="http://felix.apache.org/site/rfc-147-overview.html" target="_blank" rel="noopener">RFC 147</a>来实现的，这个标准定义了OSGi环境的shell应该是怎么样的。</li>
<li>obr - 关于OSGi Bundle Repository功能的指令</li>
</ul>
<p>如果对任何的命令有所疑问，用help+空格+“命令名称”来查看说明即可。</p>
<p>参考链接： <a href="http://www.osgi.com.cn/article/7289225" target="_blank" rel="noopener">http://www.osgi.com.cn/article/7289225</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>OSGI</category>
        <category>Felix</category>
      </categories>
      <tags>
        <tag>OSGI</tag>
        <tag>Felix</tag>
      </tags>
  </entry>
  <entry>
    <title>OSGI: (一) 简述对OSGI的认识</title>
    <url>/2020/04/13/OSGI-%E4%B8%80-%E7%AE%80%E8%BF%B0%E5%AF%B9OSGI%E7%9A%84%E8%AE%A4%E8%AF%86/</url>
    <content><![CDATA[<h2 id="OSGI：简述对OSGI的认识"><a href="#OSGI：简述对OSGI的认识" class="headerlink" title="OSGI：简述对OSGI的认识"></a>OSGI：简述对OSGI的认识</h2><h2 id="一、OSGI的概念"><a href="#一、OSGI的概念" class="headerlink" title="一、OSGI的概念"></a>一、OSGI的概念</h2><p>OSGI（Open Service Gateway Initiative，直译为“开放服务网关”）实际上是一个由OSGi联盟（OSGi Alliance）发起的以Java为技术平台的动态模块化规范。</p>
<p>OSGi联盟是由Sun Microsystems、IBM、Ericsson等公司于1999年3月成立的一个世界性的开放标准化组织，最初的名称为Connected Alliance。最初的OSGi规范也只是关注于嵌入式领域，前三个版本的OSGi规范主要满足诸如机顶盒、服务网关、手机等应用环境的模块化需求。从第四个版本开始，OSGi将主要关注点转向了Java SE和EE领域，并且在这些领域中获得了很大的发展，成为Java平台事实上的模块化规范。</p>
<p>随着OSGi技术的不断发展，OSGi联盟的成员数量已经由最开始的几个增长到目前超过100个，很多世界著名的IT企业都加入到OSGi的阵营之中，如Adobe、IBM、Oracle、SAP、RedHat和Siemens等。它们推出的许多产品都支持OSGi技术，甚至产品本身就使用了OSGi技术构建，例如IBM的WebSphere、Lotus和JAZZ，Oracle的GlassFish和Weblogic，RedHat的JBoss，Eclipse基金会的Eclipse IDE、Equinox及之下的众多子项目，Apache基金会的Karaf、Aries、Geronimo、Felix及之下的众多子项目等。这些IT巨头的踊跃参与，也从侧面证明了OSGi技术有着非常广阔的市场前景。</p>
<p>今天，OSGi的已经不再是原来Open Service Gateway Initiative的字面意义能涵盖的了，OSGi联盟给出的最新OSGi定义是The Dynamic Module System for Java，即面向Java的动态模块化系统。</p>
<p>OSGI的架构图如下：</p>
<img src="http://photo.wushaopei.com/qiniu304.png" width="60%">

<h2 id="二、OSGI的功能"><a href="#二、OSGI的功能" class="headerlink" title="二、OSGI的功能"></a>二、OSGI的功能</h2><p>以一个简单开的开发场景作说明：假设我们使用SSM框架来开发我们的Web项目，我们做产品设计和开发的时候都是分模块的，我们分模块的目的就是实现模块之间的“解耦”，更进一步的目的是方便对一个项目的控制和管理。我们对一个项目进行模块化分解之后，我们就可以把不同模块交给不同的开发人员来完成开发，然后项目经理把大家完成的模块集中在一起，然后拼装成一个最终的产品。一般我们开发都是这样的基本情况。</p>
<p>在开发过程中，模块之间还要彼此保持联系，比如A模块要从B模块拿到一些数据，而B模块可能要调用C模块中的一些方法(除了公共底层的工具类之外)。</p>
<p>最后，我们要把最终的项目部署到tomcat或者jBoss的服务器中。那么我们启动服务器的时候，能不能关闭项目的某个模块或功能呢？很明显是做不到的，一旦服务器启动，所有模块就要一起启动，都要占用服务器资源，所以关闭不了模块，假设能强制拿掉，就会影响其它的功能。</p>
<p><strong>以上就是我们传统模块式开发的一些局限性。</strong></p>
<p>软件开发一直在追求一个境界，就是模块之间的真正“解耦”、“分离”，这样我们在软件的管理和开发上面就会更加的灵活，甚至包括给客户部署项目的时候都可以做到更加的灵活可控。但是我们以前使用SSM等架构模式进行产品开发的时候我们是达不到这种要求的。</p>
<p>所以OSGI的技术规范应运而生。现在的OSGI技术就可以满足我们之前所说的境界：在不同的模块中做到彻底的分离，而不是逻辑意义上的分离，是物理上的分离，也就是说在运行部署之后都可以在不停止服务器的时候直接把某些模块拿下来，其他模块的功能也不受影响。</p>
<p>现在主流的一些应用服务器，Oracle的weblogic服务器，IBM的WebSphere，JBoss，还有Sun公司的glassfish服务器，都对OSGI提供了强大的支持，都是在OSGI的技术基础上实现的。</p>
<p><strong>简单点说，OSGI被设计专门用来开发可分解为功能模块的复杂的Java应用。</strong> OSGI提供以下优势：</p>
<p>​    1. 可以动态地安装、卸载、启动、停止不同的应用模块，而不需要重启容器。<br>    2. 在同一时刻可以跑多个同一个应用模块的实例。<br>    3. OSGI在SOA领域提供成熟的解决方案，包括嵌入式，移动设备和富客户端应用等。</p>
<p>————————————————<br>转载，原文链接：<a href="https://blog.csdn.net/qq_29229567/article/details/88534277" target="_blank" rel="noopener">https://blog.csdn.net/qq_29229567/article/details/88534277</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>OSGI</category>
      </categories>
      <tags>
        <tag>OSGI</tag>
        <tag>简介</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（十一）引入映射器的方法</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E5%BC%95%E5%85%A5%E6%98%A0%E5%B0%84%E5%99%A8%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（十）databaseIdProvider 数据库厂商标识</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%8D%81%EF%BC%89databaseIdProvider-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%82%E5%95%86%E6%A0%87%E8%AF%86/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（九）environments 配置环境</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B9%9D%EF%BC%89environments-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（八）插件</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%85%AB%EF%BC%89%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（七）ObjectFactory</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%83%EF%BC%89ObjectFactory/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（六）typeHandler 类型处理器-枚举类型</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%85%AD%EF%BC%89typeHandler-%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8-%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（五）typeHandler 类型处理器-自定义</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BA%94%EF%BC%89typeHandler-%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8-%E8%87%AA%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（四）typeHandler 类型处理器-系统定义</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%9B%9B%EF%BC%89typeHandler-%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8-%E7%B3%BB%E7%BB%9F%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（三）别名</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%89%EF%BC%89%E5%88%AB%E5%90%8D/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（二）设置</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BA%8C%EF%BC%89%E8%AE%BE%E7%BD%AE/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>并发编程（十八）J.U.C-AQS-CyclicBarrier</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E5%85%AB%EF%BC%89J-U-C-AQS-CyclicBarrier/</url>
    <content><![CDATA[<h2 id="J-U-C之AQS-CyclicBarrier"><a href="#J-U-C之AQS-CyclicBarrier" class="headerlink" title="J.U.C之AQS-CyclicBarrier"></a>J.U.C之AQS-CyclicBarrier</h2><h3 id="图解-CyclicBarrier"><a href="#图解-CyclicBarrier" class="headerlink" title="图解 CyclicBarrier"></a>图解 CyclicBarrier</h3><img src="http://photo.wushaopei.com/qiniu303.png" width="60%">

<p>CyclicBarrier是一个同步辅助类，它允许一组线程同步等待，直到某一个公共的屏障点，通过它可以实现线程之间的相互等待，每个线程都各自就绪后，才能够继续执行后续的操作。</p>
<p>它和CountDownLatch一样都是通过计数器来实现的。CyclicBarrier可以用于多线程计算数据，最后合并计算结果的应用场景。</p>
<p><strong>比如：</strong></p>
<p>我们用excel保存用户的银行流水，excel的每一页保存用户每一年的银行流水，现在我们要统计用户的日均流水，我们就可以用多线程处理每个页里面的银行流水，都执行完以后得到每一个页里面的日均银行流水，之后CyclicBarrier.action利用多线程计算结果再计算用户的日均银行流水。</p>
<h3 id="CyclicBarrier和CountDownLatch的区别："><a href="#CyclicBarrier和CountDownLatch的区别：" class="headerlink" title="CyclicBarrier和CountDownLatch的区别："></a>CyclicBarrier和CountDownLatch的区别：</h3><p>第一点：CountDownLatch的计数器只能使用一次，CyclicBarrier的计数器可以使用resume方法重置，重复使用；</p>
<p>第二点：CountDownLatch主要实现一个或N个线程需要等待其他线程完成某项操作之后才能去往下执行，它描述的是一个或N个线程等待其他线程的关系；</p>
<p>而CyclicBarrier是实现多个线程之间相互等待，在所有线程都满足条件之后才能去执行后续的操作，它描述的是各个线程内部相互等待的关系。</p>
<h3 id="CyclicBarrier线程安全代码演示："><a href="#CyclicBarrier线程安全代码演示：" class="headerlink" title="CyclicBarrier线程安全代码演示："></a>CyclicBarrier线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//告知当前有多少个线程同时在等待</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">5</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">            <span class="keyword">final</span>  <span class="keyword">int</span> threadNum = i;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            executor.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    race(threadNum);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">race</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125; is ready"</span>,threadNum);</span><br><span class="line">        <span class="comment">//当每一个线程准备就绪后，调用await方法告知CyclicBarrier当前线程OK了，当准备就绪的线程数达到了CyclicBarrier声明的5个线程的数量后，后面的线程就可以开始执行了</span></span><br><span class="line">        barrier.await();</span><br><span class="line">        log.info(<span class="string">"&#123;&#125; continue"</span>,threadNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CyclicBarrier支持传入等待时间，代码演示如下："><a href="#CyclicBarrier支持传入等待时间，代码演示如下：" class="headerlink" title="CyclicBarrier支持传入等待时间，代码演示如下："></a>CyclicBarrier支持传入等待时间，代码演示如下：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">race</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    log.info(<span class="string">"&#123;&#125; is ready"</span>,threadNum);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        barrier.await(<span class="number">2000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.warn(<span class="string">"BrokenBarrierException"</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"&#123;&#125; continue"</span>,threadNum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CyclicBarrier支持线程到达屏障时，优先支持running"><a href="#CyclicBarrier支持线程到达屏障时，优先支持running" class="headerlink" title="CyclicBarrier支持线程到达屏障时，优先支持running"></a>CyclicBarrier支持线程到达屏障时，优先支持running</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//告知当前有多少个线程同时在等待</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">5</span>,()-&gt;&#123;</span><br><span class="line">    log.info(<span class="string">"callback is running "</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">24.350</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">0</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">25.348</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">1</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">26.349</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">2</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">27.350</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">3</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.350</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">4</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.350</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - callback is running </span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.350</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">4</span> <span class="keyword">continue</span></span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.351</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 -</span><br></pre></td></tr></table></figure>

<p>线程中的屏障是 <strong>4 is ready ，</strong>此时所有入队线程已准备就绪，即到达了屏障，在进入执行序列时，会优先执行 <strong>running</strong> ，即匿名指定的线程对象。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
        <tag>Semaphore</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十七）J.U.C-AQS-Semaphore</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89J-U-C-AQS-Semaphore/</url>
    <content><![CDATA[<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>​    <strong>Semaphore</strong>维护了当前访问的个数，通过<strong>同步机制</strong>来控制同时访问个数，<strong>Semaphore</strong>可以保存有限个数的链表。 </p>
<h3 id="Semaphore的使用场景："><a href="#Semaphore的使用场景：" class="headerlink" title="Semaphore的使用场景："></a>Semaphore的使用场景：</h3><blockquote>
<p>常用于仅能提供有限访问的资源，比如项目中使用的数据库，数据库的链接数最大只有20，而项目的并发数可能远远大于20；如果同时对数据库进行操作，就可能出现因为无法取数据库连接数而导致的异常，这个时候就可以通过Semaphore来进行并发访问控制。当Semaphore把并发数控制到一定数量时，就和单线程很相似了。</p>
</blockquote>
<h3 id="Semaphore线程安全代码演示："><a href="#Semaphore线程安全代码演示：" class="headerlink" title="Semaphore线程安全代码演示："></a>Semaphore线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span>  <span class="keyword">int</span> threadCount = <span class="number">20</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; threadCount ; i++ )&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> threadNum = i;</span><br><span class="line">            exec.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();<span class="comment">// 获取一个许可</span></span><br><span class="line">                    test(threadNum);</span><br><span class="line">                    semaphore.release();<span class="comment">// 释放一个许可</span></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"finish"</span>);</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,threadNum);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行打印线程结果："><a href="#执行打印线程结果：" class="headerlink" title="执行打印线程结果："></a><strong>执行打印线程结果：</strong></h3><img src="http://photo.wushaopei.com/qiniu302.png" width="60%">

<p>由图中结果可以知道，代码中<strong>Semaphore</strong>限定了当前同时执行的线程数为3，而在统一时间只有<strong>3个线程被打印，</strong>一秒后又有3个线程被打印，由此可以说明<strong>Semaphore</strong>是可以实现线程安全操作的。 </p>
<h3 id="测试多个许可条件下的Semaphore业务场景："><a href="#测试多个许可条件下的Semaphore业务场景：" class="headerlink" title="测试多个许可条件下的Semaphore业务场景："></a>测试多个许可条件下的Semaphore业务场景：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">semaphore.acquire(<span class="number">3</span>);<span class="comment">// 获取多个许可</span></span><br><span class="line">test(threadNum);</span><br><span class="line">semaphore.release(<span class="number">3</span>);<span class="comment">// 释放多个许可</span></span><br></pre></td></tr></table></figure>

<h3 id="执行打印线程结果：-1"><a href="#执行打印线程结果：-1" class="headerlink" title="执行打印线程结果："></a><strong>执行打印线程结果：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">57.078</span> [main] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - finish</span><br><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">57.078</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">58.084</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">59.084</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">13</span>:<span class="number">00.085</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">13</span>:<span class="number">01.085</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>由执行结果可知，每一秒Semaphore只执行一次线程操作，这是因为同一时间内获取3个许可，又同一时间内释放3个许可，就相当于是在同一时间内只执行一次test(threadNum)线程操作。而同一秒钟内拿到了3个许可，而与原本Semaphore定义的3个可执行线程数一校验，发现在同一秒钟内没有多余的许可可以释放了。这就很接近单线程的执行了。</p>
<h3 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h3><h4 id="场景需求：当前的并发数是3个，超过部分则丢弃："><a href="#场景需求：当前的并发数是3个，超过部分则丢弃：" class="headerlink" title="场景需求：当前的并发数是3个，超过部分则丢弃："></a><strong>场景需求：当前的并发数是3个，超过部分则丢弃：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(semaphore.tryAcquire())&#123; <span class="comment">//尝试获取一个许可</span></span><br><span class="line">    test(threadNum);</span><br><span class="line">    semaphore.release();<span class="comment">//释放一个许可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>当尝试获取一个许可，如果获取不到，就丢弃；获取到，就执行。又由于线程业务处理消耗了一秒，如：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    log.info(<span class="string">"&#123;&#125;"</span>,threadNum);</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，最终可能执行的线程数只有Semaphore最初定义时所并发执行的3个线程。 </p>
<h4 id="场景需求：超时时间内，执行许可："><a href="#场景需求：超时时间内，执行许可：" class="headerlink" title="场景需求：超时时间内，执行许可："></a><strong>场景需求：超时时间内，执行许可：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(semaphore.tryAcquire(<span class="number">5000</span>, TimeUnit.MILLISECONDS))&#123; <span class="comment">//尝试获取一个许可</span></span><br><span class="line">    test(threadNum);</span><br><span class="line">    semaphore.release();<span class="comment">//释放一个许可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当尝试在5秒内获取一个许可，如果超时后依旧获取不到，就丢弃；获取到，就执行。</p>
<p>最终可能执行的超过约定的初始3个线程，但不一定全部线程数都能够被执行。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
        <tag>Semaphore</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十六）J.U.C-AQS-CountDownLatch</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89J-U-C-AQS-CountDownLatch/</url>
    <content><![CDATA[<h2 id="J-U-C之AQS-CountDownLatch"><a href="#J-U-C之AQS-CountDownLatch" class="headerlink" title="J.U.C之AQS-CountDownLatch"></a>J.U.C之AQS-CountDownLatch</h2><h3 id="J-U-C之AQS-CountDownLatch-1"><a href="#J-U-C之AQS-CountDownLatch-1" class="headerlink" title="J.U.C之AQS-CountDownLatch"></a>J.U.C之AQS-CountDownLatch</h3><img src="http://photo.wushaopei.com/qiniu301.png" width="60%">

<p><strong>说明：</strong> </p>
<blockquote>
<p>CountDownLatch是一个同步辅助类，通过它可以完成类似于阻塞当前线程的功能，换句话说一个线程或多个线程一直等待，直到其他线程执行的操作完成。 </p>
</blockquote>
<blockquote>
<p>Latch它使用一个给定的计数器来初始化，该计数器的操作是原子操作，就是同一时间只能有一个线程去操作计数器。调用该类的await()方法的线程会一直处于阻塞状态，直到线程调用countDown（）方法使当前的cnt值变成0，每次countDown时，计数器的值会减一。当计数器的值减到0的时候，所有因调用await()方法而处于等待状态的线程就会往下执行。这个操作只会出现一次，因为cnt值是不能被重置的。</p>
</blockquote>
<h3 id="CountDownLatch线程安全测试代码实例："><a href="#CountDownLatch线程安全测试代码实例：" class="headerlink" title="CountDownLatch线程安全测试代码实例："></a>CountDownLatch线程安全测试代码实例：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span>  <span class="keyword">int</span> threadCount = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(threadCount);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; threadCount ; i++ )&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> threadNum = i;</span><br><span class="line">            exec.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    test(threadNum);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        log.info(<span class="string">"finish"</span>); </span><br><span class="line">exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,threadNum);</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行打印结果："><a href="#执行打印结果：" class="headerlink" title="执行打印结果："></a><strong>执行打印结果：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">47</span>:<span class="number">37.052</span> [pool-<span class="number">1</span>-thread-<span class="number">101</span>] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - <span class="number">100</span></span><br><span class="line">.......</span><br><span class="line"><span class="number">22</span>:<span class="number">47</span>:<span class="number">37.060</span> [pool-<span class="number">1</span>-thread-<span class="number">192</span>] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - <span class="number">191</span></span><br><span class="line"><span class="number">22</span>:<span class="number">47</span>:<span class="number">37.192</span> [main] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - finish</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由打印结果可知，finish是在所有线程执行完后才执行的。</p>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a><strong>分析：</strong></h3><p>这是因为CountDownLatch.countDown()计数器已经降到0了，所以在最后的CountDownLatch.await()校验通过，接着就打印最后面的finish字段</p>
<h3 id="实现CountDownLatch在指定时间内完成："><a href="#实现CountDownLatch在指定时间内完成：" class="headerlink" title="实现CountDownLatch在指定时间内完成："></a>实现CountDownLatch在指定时间内完成：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//让CountDownLatch等待10毫秒</span></span><br><span class="line">countDownLatch.await(<span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>

<h3 id="作用-："><a href="#作用-：" class="headerlink" title="作用 ："></a><strong>作用</strong> ：</h3><p>​    可以给定时间让线程有时间反应过来执行。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十五）J.U.C-AQS-简介</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89J-U-C-AQS-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><h3 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h3><p>​    <strong>AbstractQueuedSynchronizer</strong>简称<strong>AQS</strong>，<strong>AQS</strong>是<strong>JUC</strong>的核心，<strong>AQS</strong>是并发类的重中之重，可以用来构建锁的同步框架。 </p>
<h3 id="AQS底层的数据结构："><a href="#AQS底层的数据结构：" class="headerlink" title="AQS底层的数据结构："></a>AQS底层的数据结构：</h3><img src="http://photo.wushaopei.com/qiniu300.png" width="60%">

<h3 id="AQS的特点："><a href="#AQS的特点：" class="headerlink" title="AQS的特点："></a>AQS的特点：</h3><ul>
<li>使用Node实现FIFO队列，可以用于构建锁或者其它同步装置的基础框架</li>
<li>利用了一个int类型表示状态</li>
<li>使用方法是继承；</li>
<li>子类通过继承并通过实现它的方法管理其状态{ acquire 和 release } 的方法操纵状态；</li>
<li>可以同时实现排它锁和共享锁模式（独占、共享）</li>
</ul>
<h3 id="AQS具体实现的大致思路："><a href="#AQS具体实现的大致思路：" class="headerlink" title="AQS具体实现的大致思路："></a>AQS具体实现的大致思路：</h3><blockquote>
<p>AQS内部维护了一个CAS队列来管理锁，线程会首先尝试获取锁，如果失败就会将当前线程以及等待状态的信息包装成一个节点加入到之前的同步队列Sync queue里。接着会不断循环尝试获取锁，他的条件是当前节点为head的直接后进才会尝试。如果失败就会阻塞自己，知道自己被唤醒，而它持有锁的线程在释放锁的时候会唤醒队列中的后进线程，基于这些基础的设计和思路，jdk提供了许多基于AQS的子类。</p>
</blockquote>
<h3 id="AQS-同步组件"><a href="#AQS-同步组件" class="headerlink" title="AQS 同步组件"></a>AQS 同步组件</h3><ul>
<li>CountDownLatch<ul>
<li>CountDownLatch 是一个闭锁，通过线程计数来保证线程是否需要一直阻塞；</li>
</ul>
</li>
<li>Semaphore<ul>
<li>Semaphore能控制同一时间并发线程的数目</li>
</ul>
</li>
<li>CyclicBarrier</li>
<li>ReentrantLock</li>
<li>Condition</li>
<li>FutureTask</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
      </tags>
  </entry>
  <entry>
    <title>bootstrap 入门（一）简介</title>
    <url>/2020/04/13/bootstrap-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>​    利用 BootstrapCDN 和一个最简模板快速上手 Bootstrap。Bootstrap 是全球最流行的前端框架，用于构建响应式、移动设备优先的 WEB 站点。 </p>
<p>​    简单灵活的用于搭建WEB页面的HTML、CSS、JavaScript的工具集，基于HTML5和CSS3。是一款简洁强大的开发框架，让WEB开发更迅速更简单更简洁 </p>
]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（一）properties 元素</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%80%EF%BC%89properties-%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<h2 id="MyBatis-配置XML-文件的层次结构"><a href="#MyBatis-配置XML-文件的层次结构" class="headerlink" title="MyBatis 配置XML 文件的层次结构"></a>MyBatis 配置XML 文件的层次结构</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>    <span class="comment">&lt;!-- 配置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>/&gt;</span>	   <span class="comment">&lt;!-- 属性 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span>/&gt;</span>        <span class="comment">&lt;!-- 设置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAliases</span>/&gt;</span>	<span class="comment">&lt;!-- 类型命名 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandlers</span>/&gt;</span>	<span class="comment">&lt;!-- 类型处理器 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">objectFactory</span>/&gt;</span>	<span class="comment">&lt;!-- 对象工厂 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>/&gt;</span>		<span class="comment">&lt;!-- 插件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> &gt;</span>   <span class="comment">&lt;!-- 配置环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> &gt;</span>    <span class="comment">&lt;!-- 环境变量 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> /&gt;</span>     <span class="comment">&lt;!-- 事务管理器 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> /&gt;</span>     <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span>      </span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span>       </span><br><span class="line">  <span class="tag">&lt;<span class="name">databaseIdProvider</span>/&gt;</span> 	<span class="comment">&lt;!-- 数据库厂商标识 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span>		<span class="comment">&lt;!-- 映射器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上是全部MyBatis的配置元素。</p>
<h1 id="mybatis的核心配置之properties"><a href="#mybatis的核心配置之properties" class="headerlink" title="mybatis的核心配置之properties"></a><strong>mybatis的核心配置之properties</strong></h1><blockquote>
<p>properties 是一个配置属性的元素，让我们在配置文件的上下文中使用它。</p>
</blockquote>
<h3 id="properties-元素"><a href="#properties-元素" class="headerlink" title="properties 元素"></a>properties 元素</h3><p>properties 是一个配置属性的元素，让我们在配置文件的上下文中使用它</p>
<p>MyBatis 提供 3 中配置方式：</p>
<ul>
<li>property 子元素</li>
<li>properties 配置文件</li>
<li>程序参数传递</li>
</ul>
<h3 id="property-子元素"><a href="#property-子元素" class="headerlink" title="property 子元素"></a>property 子元素</h3><h4 id="property-子元素的配置方法："><a href="#property-子元素的配置方法：" class="headerlink" title="property 子元素的配置方法："></a>property 子元素的配置方法：</h4><p><strong>property 子元素配置：</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">&lt;property name=<span class="string">"driver"</span> value=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;amp;serverTimezone=UTC"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"username"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>

<p><strong>在上下文中使用已经配置好的属性值：</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">&lt;property name=<span class="string">"driver"</span> value=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;amp;serverTimezone=UTC"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"username"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>

<h4 id="properties-配置文件"><a href="#properties-配置文件" class="headerlink" title="properties 配置文件"></a>properties 配置文件</h4><p>更多的时候，我们会使用 properties 配置文件来配置属性值，以方便我们在多个配置文件中重复使用它们，也便于日后的维护和修改。</p>
<p> <strong>properties 文件的使用</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">username=root</span><br><span class="line">password=root</span><br><span class="line">url=jdbc:mysql:<span class="comment">//localhost:3333/mybatis?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone = GMT</span></span><br><span class="line">driver=com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>

<p><strong>配置文件的引入：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"jdbc.properties"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>properties标签在引入外部属性配置文件和内部定义属性的时候。外部会替换掉内部定义的值。</p>
</blockquote>
<h3 id="程序参数传递"><a href="#程序参数传递" class="headerlink" title="程序参数传递"></a>程序参数传递</h3><p>应用场景： 系统是由运维人员去配置的，生产数据库的用户密码对于开发者而言是保密的，而且为了安全，运维人员要求对配置文件中的数据库用户和密码进行加密，这样我们的配置文件中往往配置的是加密过后的数据库信息，而无法通过加密的字符串去连接数据库，这个时候可以通过编码的形式来满足我们遇到的场景。</p>
<p>下面假设 jdbc.properties 文件中的username 和 password 两个属性使用了加密的字符串，这个时候我们需要在生成SqlSessionFactory 之前将它转化为明文，而系统已经提供了解密的方法 decodee(str) ，让我们来看看如何使用代码的方式来完成 SqlSessionFactory 的创建 .</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.testMain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Level;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.util.SqlSessionFactoryUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SqlSessionFactory_Property.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月13日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactory_Property</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">decode</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">		<span class="comment">//解密</span></span><br><span class="line">		<span class="keyword">return</span> str;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span> <span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		InputStream cfgStream = <span class="keyword">null</span>;</span><br><span class="line">		Reader cfgReader = <span class="keyword">null</span>;</span><br><span class="line">		InputStream proStream = <span class="keyword">null</span>;</span><br><span class="line">		Reader proReader = <span class="keyword">null</span>;</span><br><span class="line">		Properties properties = <span class="keyword">null</span>;</span><br><span class="line">		SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line">		SqlSession session = <span class="keyword">null</span>; </span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="comment">// 读入配置文件流</span></span><br><span class="line">			cfgStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line">			cfgReader = <span class="keyword">new</span> InputStreamReader(cfgStream); </span><br><span class="line">			</span><br><span class="line">			<span class="comment">//读入属性文件</span></span><br><span class="line">			proStream = Resources.getResourceAsStream(<span class="string">"jdbc.properties"</span>);</span><br><span class="line">			proReader = <span class="keyword">new</span> InputStreamReader(proStream);</span><br><span class="line">			properties = <span class="keyword">new</span> Properties();</span><br><span class="line">			properties.load(proReader);</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 解密为明文</span></span><br><span class="line">			properties.setProperty(<span class="string">"username"</span>, decode(properties.getProperty(<span class="string">"username"</span>)));			</span><br><span class="line">			properties.setProperty(<span class="string">"password"</span>, decode(properties.getProperty(<span class="string">"password"</span>)));				</span><br><span class="line">					</span><br><span class="line">			</span><br><span class="line">			System.out.println( decode(properties.getProperty(<span class="string">"username"</span>)) );</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			</span><br><span class="line">			Logger.getLogger(SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()).<span class="title">log</span>(<span class="title">null</span>,<span class="title">ex</span>)</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">synchronized</span>(SqlSessionFactory_Property<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">				<span class="comment">// 使用属性来创建SqlSessionFactory</span></span><br><span class="line">				sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(cfgReader, properties);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上述代码，我们完全可以在jdbc.properties 配置密文，满足对系统安全的要求。</p>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>MyBatis 支持的以上三种配置方式可能同时出现，并且属性还会重复配置。这3中方式是存在优先级的，MyBatis 中将按照下面的顺序来加载。</p>
<ol>
<li>在 properties 元素体内指定的属性首先被读取</li>
<li>根据properties 元素中的 resource 属性读取类路径下属性文件，或者根据url属性指定的路径读取属性文件，并覆盖已读取的同名属性</li>
<li>读取作为方法参数传递的属性，并覆盖已读取的同名属性。</li>
</ol>
<p><strong>以上声明的优先级如下：</strong></p>
<blockquote>
<p>如果3种配置同时出现，优先级为第3种 &gt; 第2种 &gt; 第1种，推荐使用第2种，有特殊需求时使用第3种。</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·















]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>properties</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化开发（六）Specification-06-Common Function</title>
    <url>/2020/04/13/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E5%85%AD%EF%BC%89Specification-06-Common-Function/</url>
    <content><![CDATA[<h2 id="06-Common-Function"><a href="#06-Common-Function" class="headerlink" title="06. Common Function"></a>06. Common Function</h2><p>设备将需要所有事件的间隔时间分开，而接口的间隔时间是分开的,报警时的报警报告 报警文字要写清楚。</p>
<h3 id="06-01-Equipment-Monitor-Management"><a href="#06-01-Equipment-Monitor-Management" class="headerlink" title="06.01. Equipment Monitor Management"></a>06.01. Equipment Monitor Management</h3><h4 id="06-01-01-Equipment-Alive"><a href="#06-01-01-Equipment-Alive" class="headerlink" title="06.01.01. Equipment Alive"></a>06.01.01. Equipment Alive</h4><h5 id="06-01-01-01-PLC-MAP"><a href="#06-01-01-01-PLC-MAP" class="headerlink" title="06.01.01.01. PLC MAP"></a>06.01.01.01. PLC MAP</h5><h6 id="06-01-01-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-01-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.01.01.01. Local PLC – Link Relay (B Area)"></a>06.01.01.01.01. Local PLC – Link Relay (B Area)</h6><h5 id="06-01-01-02-Communication-Scenario"><a href="#06-01-01-02-Communication-Scenario" class="headerlink" title="06.01.01.02. Communication Scenario"></a>06.01.01.02. Communication Scenario</h5><h4 id="06-01-02-CIM-Mode"><a href="#06-01-02-CIM-Mode" class="headerlink" title="06.01.02. CIM Mode"></a>06.01.02. CIM Mode</h4><h5 id="06-01-02-01-PLC-MAP"><a href="#06-01-02-01-PLC-MAP" class="headerlink" title="06.01.02.01. PLC MAP"></a>06.01.02.01. PLC MAP</h5><h6 id="06-01-02-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-02-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.02.01.01. Local PLC – Link Relay (B Area)"></a>06.01.02.01.01. Local PLC – Link Relay (B Area)</h6><h5 id="06-01-02-02-Communication-Scenario"><a href="#06-01-02-02-Communication-Scenario" class="headerlink" title="06.01.02.02. Communication Scenario"></a>06.01.02.02. Communication Scenario</h5><h4 id="06-01-03-CIM-Mode-Change-Command"><a href="#06-01-03-CIM-Mode-Change-Command" class="headerlink" title="06.01.03. CIM Mode Change Command"></a>06.01.03. CIM Mode Change Command</h4><h5 id="06-01-03-01-PLC-MAP"><a href="#06-01-03-01-PLC-MAP" class="headerlink" title="06.01.03.01. PLC MAP"></a>06.01.03.01. PLC MAP</h5><h6 id="06-01-03-01-01-Local-PLC-–-Link-Register-W-Area"><a href="#06-01-03-01-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="06.01.03.01.01. Local PLC – Link Register (W Area)"></a>06.01.03.01.01. Local PLC – Link Register (W Area)</h6><h6 id="06-01-03-01-02-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-03-01-02-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.03.01.02. Local PLC – Link Relay (B Area)"></a>06.01.03.01.02. Local PLC – Link Relay (B Area)</h6><h6 id="06-01-03-01-03-Master-PLC-–-Link-Register-W-Area"><a href="#06-01-03-01-03-Master-PLC-–-Link-Register-W-Area" class="headerlink" title="06.01.03.01.03. Master PLC – Link Register (W Area)"></a>06.01.03.01.03. Master PLC – Link Register (W Area)</h6><h6 id="06-01-03-01-04-Master-PLC-–-Link-Relay-B-Area"><a href="#06-01-03-01-04-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.03.01.04. Master PLC – Link Relay (B Area)"></a>06.01.03.01.04. Master PLC – Link Relay (B Area)</h6><h5 id="06-01-03-02-Communication-Scenario"><a href="#06-01-03-02-Communication-Scenario" class="headerlink" title="06.01.03.02. Communication Scenario"></a>06.01.03.02. Communication Scenario</h5><h4 id="06-01-04-CIM-Off-Mode-Operation"><a href="#06-01-04-CIM-Off-Mode-Operation" class="headerlink" title="06.01.04. CIM Off Mode Operation"></a>06.01.04. CIM Off Mode Operation</h4><h4 id="06-01-05-Inline-Mode"><a href="#06-01-05-Inline-Mode" class="headerlink" title="06.01.05. Inline Mode"></a>06.01.05. Inline Mode</h4><h5 id="06-01-05-01-PLC-MAP"><a href="#06-01-05-01-PLC-MAP" class="headerlink" title="06.01.05.01. PLC MAP"></a>06.01.05.01. PLC MAP</h5><h6 id="06-01-05-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-05-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.05.01.01. Local PLC – Link Relay (B Area)"></a>06.01.05.01.01. Local PLC – Link Relay (B Area)</h6><h5 id="06-01-05-02-Communication-Scenario"><a href="#06-01-05-02-Communication-Scenario" class="headerlink" title="06.01.05.02. Communication Scenario"></a>06.01.05.02. Communication Scenario</h5><h4 id="06-01-06-Local-Alarm-Status"><a href="#06-01-06-Local-Alarm-Status" class="headerlink" title="06.01.06. Local Alarm Status"></a>06.01.06. Local Alarm Status</h4><h5 id="06-01-06-01-PLC-MAP"><a href="#06-01-06-01-PLC-MAP" class="headerlink" title="06.01.06.01. PLC MAP"></a>06.01.06.01. PLC MAP</h5><h6 id="06-01-06-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-06-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.06.01.01. Local PLC – Link Relay (B Area)"></a>06.01.06.01.01. Local PLC – Link Relay (B Area)</h6><h5 id="06-01-06-02-Communication-Scenario"><a href="#06-01-06-02-Communication-Scenario" class="headerlink" title="06.01.06.02. Communication Scenario"></a>06.01.06.02. Communication Scenario</h5><h4 id="06-01-07-Equipment-Operation-Mode"><a href="#06-01-07-Equipment-Operation-Mode" class="headerlink" title="06.01.07. Equipment Operation Mode"></a>06.01.07. Equipment Operation Mode</h4><h5 id="06-01-07-01-PLC-MAP"><a href="#06-01-07-01-PLC-MAP" class="headerlink" title="06.01.07.01. PLC MAP"></a>06.01.07.01. PLC MAP</h5><h6 id="06-01-07-01-01-Local-PLC-–-Link-Register-W-Area"><a href="#06-01-07-01-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="06.01.07.01.01. Local PLC – Link Register (W Area)"></a>06.01.07.01.01. Local PLC – Link Register (W Area)</h6><h5 id="06-01-07-02-Communication-Scenario"><a href="#06-01-07-02-Communication-Scenario" class="headerlink" title="06.01.07.02. Communication Scenario"></a>06.01.07.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu298.png" width="80%">











































<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>并发编程（十四）线程安全策略-并发容器及安全共享策略总结</title>
    <url>/2020/04/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E5%9B%9B%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E5%8F%8A%E5%AE%89%E5%85%A8%E5%85%B1%E4%BA%AB%E7%AD%96%E7%95%A5%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h2 id="并发容器及安全共享策略总结"><a href="#并发容器及安全共享策略总结" class="headerlink" title="并发容器及安全共享策略总结"></a>并发容器及安全共享策略总结</h2><blockquote>
<p>ArrayList  - &gt;  CopyOnWriteArrayList</p>
<p>HashSet 、TreeSet - &gt; CopyOnWriteArraySet ConcurrentSkipListSet</p>
<p>HashMap 、 TreeMap - &gt; ConcurrentHashMap ConcurrentSkipListMap</p>
</blockquote>
<h3 id="用CopyOnWriteArrayList-替代ArrayList"><a href="#用CopyOnWriteArrayList-替代ArrayList" class="headerlink" title="用CopyOnWriteArrayList 替代ArrayList"></a>用CopyOnWriteArrayList 替代ArrayList</h3><h4 id="使用原理："><a href="#使用原理：" class="headerlink" title="使用原理："></a><strong>使用原理：</strong></h4><blockquote>
<p>写操作时复制，当有新元素添加到CopyOnWriteArrayList时，会从原有数组里面拷贝一份出来，在新的数组上用写操作，写完之后把原来的数组指向新的数组，CopyOnWriteArrayList的整个add（）操作都是在锁的保护下进行的，主要是为了避免在多线程情况下复制出多个副本出来把数据搞乱，导致最终返回的数据结果不是我们所期待的。</p>
</blockquote>
<h4 id="适用场景："><a href="#适用场景：" class="headerlink" title="适用场景："></a><strong>适用场景：</strong></h4><p><code>CopyOnWriteArrayList适合读多写少的场景。</code></p>
<h4 id="CopyOnWriteArrayList的设计思想："><a href="#CopyOnWriteArrayList的设计思想：" class="headerlink" title="CopyOnWriteArrayList的设计思想："></a><strong>CopyOnWriteArrayList的设计思想：</strong></h4><blockquote>
<p>第一点：读写分离，让读和写分开；</p>
<p>第二点：最终一致性，因为在copy的过程需要一些时间，而最终一致性保证了数据是对的；</p>
<p>第三点：使用时另外开辟空间，通过这种方式解决掉并发冲突。</p>
<p>CopyOnWriteArrayList读操作时是在原数组上读的，不需要加锁；而写操作的时候需要加锁，以避免产生多个副本出来，影响最终的数据结果。</p>
</blockquote>
<h4 id="代码演示验证CopyOnWriteArrayList的写操作线程安全性："><a href="#代码演示验证CopyOnWriteArrayList的写操作线程安全性：" class="headerlink" title="代码演示验证CopyOnWriteArrayList的写操作线程安全性："></a>代码演示验证CopyOnWriteArrayList的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArrayListExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">50</span>:<span class="number">23.972</span> [main] INFO com.mmall.concurrency.CopyOnWriteArrayListExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000，</strong>说明了<strong>CopyOnWriteArrayList</strong>的add操作在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h3 id="HashSet-、TreeSet-gt-CopyOnWriteArraySet-ConcurrentSkipListSet"><a href="#HashSet-、TreeSet-gt-CopyOnWriteArraySet-ConcurrentSkipListSet" class="headerlink" title="HashSet 、TreeSet - &gt; CopyOnWriteArraySet  ConcurrentSkipListSet"></a>HashSet 、TreeSet - &gt; CopyOnWriteArraySet  ConcurrentSkipListSet</h3><h4 id="代码演示验证CopyOnWriteArraySet的写操作线程安全性："><a href="#代码演示验证CopyOnWriteArraySet的写操作线程安全性：" class="headerlink" title="代码演示验证CopyOnWriteArraySet的写操作线程安全性："></a>代码演示验证CopyOnWriteArraySet的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArraySetExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行测试打印结果："><a href="#执行测试打印结果：" class="headerlink" title="执行测试打印结果："></a><strong>执行测试打印结果：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">56</span>:<span class="number">40.047</span> [main] INFO com.mmall.concurrency.example.concurrent.CopyOnWriteArraySetExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000</strong>，说明了<strong>CopyOnWriteArraySet</strong>的add操作在多线程并发环境下<strong>是线程安全</strong>的。 </p>
<h4 id="代码演示验证ConcurrentSkipListSet的写操作线程安全性："><a href="#代码演示验证ConcurrentSkipListSet的写操作线程安全性：" class="headerlink" title="代码演示验证ConcurrentSkipListSet的写操作线程安全性："></a>代码演示验证ConcurrentSkipListSet的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSkipListSetExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> ConcurrentSkipListSet&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行测试打印结果：-1"><a href="#执行测试打印结果：-1" class="headerlink" title="执行测试打印结果："></a><strong>执行测试打印结果：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">58</span>:<span class="number">05.936</span> [main] INFO com.mmall.concurrency.example.concurrent.ConcurrentSkipListSetExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为5000，说明了<strong>ConcurrentSkipListSet</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。</p>
<p>这里的线程安全仅限于做add操作时，如果是做remove操作，还需要其他锁机制保障线程安全。</p>
<h3 id="HashMap-、-TreeMap-gt-ConcurrentHashMap-ConcurrentSkipListMap"><a href="#HashMap-、-TreeMap-gt-ConcurrentHashMap-ConcurrentSkipListMap" class="headerlink" title="HashMap 、 TreeMap - &gt; ConcurrentHashMap ConcurrentSkipListMap"></a>HashMap 、 TreeMap - &gt; ConcurrentHashMap ConcurrentSkipListMap</h3><p><code>对并发要求比较高的时候，建议使用ConcurrentSkipListMap</code></p>
<h4 id="代码演示验证ConcurrentHashMap的写操作线程安全性："><a href="#代码演示验证ConcurrentHashMap的写操作线程安全性：" class="headerlink" title="代码演示验证ConcurrentHashMap的写操作线程安全性："></a>代码演示验证ConcurrentHashMap的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMapExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">04</span>:<span class="number">16.524</span> [main] INFO com.mmall.concurrency.example.concurrent.ConcurrentHashMapExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000</strong>，说明了<strong>ConcurrentHashMap</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h4 id="代码演示验证ConcurrentSkipListMap的写操作线程安全性："><a href="#代码演示验证ConcurrentSkipListMap的写操作线程安全性：" class="headerlink" title="代码演示验证ConcurrentSkipListMap的写操作线程安全性："></a>代码演示验证ConcurrentSkipListMap的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSkipListMapExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> ConcurrentSkipListMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">13.842</span> [main] INFO com.mmall.concurrency.example.concurrent.ConcurrentSkipListMapExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000</strong>，说明了<strong>ConcurrentSkipListMap</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全的</strong>。 </p>
<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><img src="http://photo.wushaopei.com/qiniu291.png" width="60%">

<h3 id="安全共享对象策略-总结："><a href="#安全共享对象策略-总结：" class="headerlink" title="安全共享对象策略 - 总结："></a>安全共享对象策略 - 总结：</h3><ul>
<li><strong>线程限制：</strong> 一个被线程限制的对象，由线程独占，并且只能被占有它的线程修改</li>
<li><strong>共享只读：</strong> 一个共享只读的对象，在没有额外同步的情况下，可以被多个线程并发访问，但是任何线程都不能修改它</li>
<li><strong>线程安全对象：</strong> 一个线程安全的对象或者容器，在内部通过同步机制来保证线程安全，所以其他线程无需额外的同步就可以通过公共接口随意访问它</li>
<li><strong>被守护对象：</strong> 被守护对象只能通过获取特定的锁来访问</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>安全共享策略</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十三）线程安全策略-同步容器</title>
    <url>/2020/04/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8/</url>
    <content><![CDATA[<h2 id="线程安全的同步容器："><a href="#线程安全的同步容器：" class="headerlink" title="线程安全的同步容器："></a><strong>线程安全的同步容器：</strong></h2><blockquote>
<p>ArrayList - &gt; Vecotr , Stack</p>
<p>HashMap - &gt; HashTable (key 、value 不能为 null)</p>
<p>Collections.synchronizedXXX(List、Set、Map)</p>
</blockquote>
<ul>
<li>在多线程环境下，要使用ArrayList时，可以使用Vector、Stack替代</li>
<li>在多线程环境下，要使用HashMap时，可以使用HashTable替代</li>
<li>HashTable底层实现使用synchronized进行修饰，同步锁的存在保证了线程的安全。</li>
</ul>
<h3 id="Vector线程安全测试："><a href="#Vector线程安全测试：" class="headerlink" title="Vector线程安全测试："></a>Vector线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VectorExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;Integer&gt; list = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">35</span>:<span class="number">31.360</span> [main] INFO com.mmall.concurrency.example.syncContainer.VectorExample1 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度为5000，说明了Vector的add操作在多线程并发环境下是线程安全的。 </p>
<p><strong>注意</strong>：即使是线程安全的Vector也可能发生<strong>线程不安全</strong>的情况，如下演示 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VectorExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;Integer&gt; vector = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++ )&#123;</span><br><span class="line">                vector.add(i);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            Thread thread1 = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; vector.size() ; i++)&#123;</span><br><span class="line">                        vector.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            Thread thread2 = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; vector.size() ; i++)&#123;</span><br><span class="line">                        vector.get(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            thread1.start();</span><br><span class="line">            thread2.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu285.png" width="60%">

<p>如图，vector的多线程操作发生了异常，全都集中在执行get()操作时，一直发生数组索引越界的异常问题。</p>
<p><strong>原因分析：</strong>vector 是一个线程同步容器，所有的remove操作都是有synchronized修饰的，get操作也是有synchronized修饰的，如图：</p>
<img src="http://photo.wushaopei.com/qiniu286.png" width="60%">



<img src="http://photo.wushaopei.com/qiniu287.png" width="60%">

<blockquote>
<p>在Vector中由于有synchronized同步锁机制，保证了当前两个线程即thread1 和 thread2 是属于两个独立的同步线程；但是，在实际执行代码的过程中，当thread1执行了remove（）删除操作时，thread2正好也执行到了get()方法，两者由于相对独立且同步，所以当thread1删除了某个索引的值时，thread2依旧会去get()获取那个索引位的值，但这时候对应的值已经被删除了，所以java会抛出索引越界的异常来提示用户，当前所要get()的值是不存在的。</p>
</blockquote>
<h3 id="将HashMap替换成Hashtable实现线程安全："><a href="#将HashMap替换成Hashtable实现线程安全：" class="headerlink" title="将HashMap替换成Hashtable实现线程安全："></a>将HashMap替换成Hashtable实现线程安全：</h3><p><strong>代码演示：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashTableExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">08.814</span> [main] INFO com.mmall.concurrency.example.syncContainer.HashTableExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为5000，说明了<strong>HashTable</strong>的<strong>put</strong>操作在多线程并发环境下是<strong>线程安全</strong>的。</p>
<p>*<em>源码查看： *</em></p>
<img src="http://photo.wushaopei.com/qiniu288.png" width="60%">

<p>由上图可知，<strong>HashTable</strong>的<strong>put</strong>、<strong>remove</strong>等方法的<strong>底层实现</strong>都是使用<strong>synchronized</strong>修饰的，是<strong>线程安全</strong>的。 </p>
<h3 id="synchronizedList测试线程安全："><a href="#synchronizedList测试线程安全：" class="headerlink" title="synchronizedList测试线程安全："></a>synchronizedList测试线程安全：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionsExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = Collections.synchronizedList(Lists.newArrayList());</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">20</span>:<span class="number">59.015</span> [main] INFO com.mmall.concurrency.example.syncContainer.CollectionsExample2 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知<strong>：size的</strong>长度<strong>为5000</strong>，说明了<strong>synchronizedSet</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h3 id="synchronizedSet测试线程安全："><a href="#synchronizedSet测试线程安全：" class="headerlink" title="synchronizedSet测试线程安全："></a>synchronizedSet测试线程安全：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionsExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = Collections.synchronizedSet(Sets.newHashSet());</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">20</span>:<span class="number">59.015</span> [main] INFO com.mmall.concurrency.example.syncContainer.CollectionsExample2 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知<strong>：size的</strong>长度<strong>为5000</strong>，说明了<strong>synchronizedSet</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h3 id="synchronizedMap测试线程安全："><a href="#synchronizedMap测试线程安全：" class="headerlink" title="synchronizedMap测试线程安全："></a>synchronizedMap测试线程安全：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMapExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> HashMap&lt;Integer,Integer&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">         map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">23</span>:<span class="number">13.660</span> [main] INFO com.mmall.concurrency.example.syncContainer.CollectionsExample13 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：<strong>size</strong>的长度为<strong>5000</strong>，说明了<strong>synchronizedMap</strong>的<strong>put操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>线程不安全类</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十二）线程安全策略-线程不安全类与写法</title>
    <url>/2020/04/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E7%B1%BB%E4%B8%8E%E5%86%99%E6%B3%95/</url>
    <content><![CDATA[<h1 id="线程不安全类"><a href="#线程不安全类" class="headerlink" title="线程不安全类"></a>线程不安全类</h1><p><strong>线程不安全的类：</strong>如果一个类的对象同时可以被多个线程访问，如果你不做特殊的同步处理。那么，它就容易表现出线程不安全的现象。</p>
<blockquote>
<p><strong>如：</strong>抛出异常、逻辑处理错误等等。</p>
</blockquote>
<p>这种类就成为<strong>线程不安全</strong>的类。</p>
<h2 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StringBuilder - &gt; StringBuffer</span><br></pre></td></tr></table></figure>

<h3 id="StringBuilder-线程安全代码演示："><a href="#StringBuilder-线程安全代码演示：" class="headerlink" title="StringBuilder 线程安全代码演示："></a><strong>StringBuilder</strong> 线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.commonUnsafe;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> StringExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 12:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringExample1</span> </span>&#123;</span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,stringBuilder.length());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        stringBuilder.append(<span class="string">"1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果线程安全的话，打印结果应该为5000！ </p>
</blockquote>
<p><strong>执行打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">48</span>:<span class="number">15.598</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.StringExample1 - size:<span class="number">4937</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由打印结果可知，<strong>size的值小于5000</strong>，意味着<strong>StringBuilder</strong>是线程<strong>不安全</strong>的类。 </p>
<h3 id="StringBuffer-线程安全代码演示："><a href="#StringBuffer-线程安全代码演示：" class="headerlink" title="StringBuffer 线程安全代码演示："></a><strong>StringBuffer</strong> 线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br></pre></td></tr></table></figure>

<p><strong>执行打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">51</span>:<span class="number">06.859</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.StringExample2 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由打印结果可知，size的值<strong>等于5000</strong>，意味着<strong>StringBuffer</strong>是<strong>线程安全</strong>的类。 </p>
<h3 id="StringBuffer和StringBuilder线程分析："><a href="#StringBuffer和StringBuilder线程分析：" class="headerlink" title="StringBuffer和StringBuilder线程分析："></a>StringBuffer和StringBuilder线程分析：</h3><img src="http://photo.wushaopei.com/qiniu278.png" width="60%">

<p>由截图可知，<strong>StringBuffer</strong>的底层实现方法都添加<strong>synchronized</strong>同步锁，是<strong>线程安全的</strong>。</p>
<img src="http://photo.wushaopei.com/qiniu279.png" width="60%">

<p>而<strong>StringBuilder</strong>底层的方法没有添加<strong>synchronized</strong>同步锁，<strong>存在线程安全</strong>的问题。 </p>
<h3 id="为什么java要同时提供StringBuilder和StringBuffer两个类？"><a href="#为什么java要同时提供StringBuilder和StringBuffer两个类？" class="headerlink" title="为什么java要同时提供StringBuilder和StringBuffer两个类？"></a>为什么java要同时提供<strong>StringBuilder</strong>和<strong>StringBuffer</strong>两个类？</h3><p>之所以java同时提供StringBuilder和StringBuffer两个线程安全和不安全的类，是因为在StringBuffer中，使用synchronized锁机制会导致同时只有一个线程可以操作该对象，对性能和效率有损耗。StringBuffer只有在多线程并发且声明为成员变量时使用就可以保证线程的安全；而在业务层逻辑方法中声明StringBuilder局部变量时，由于存在堆栈封闭的关系，同一时间内只会有一个线程调用该类变量，所以不存在线程安全的问题。</p>
<h2 id="日期转换的类"><a href="#日期转换的类" class="headerlink" title="日期转换的类"></a>日期转换的类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SimpleDateFormat - &gt; JodaTimie</span><br></pre></td></tr></table></figure>



<h3 id="SimpleDateFormat类线程安全测试："><a href="#SimpleDateFormat类线程安全测试：" class="headerlink" title="SimpleDateFormat类线程安全测试："></a>SimpleDateFormat类线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateFormatExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            simpleDateFormat.parse(<span class="string">"20191101"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">"parse exception"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">25</span>:<span class="number">08.453</span> [pool-<span class="number">1</span>-thread-<span class="number">162</span>] ERROR com.mmall.concurrency.example.commonUnsafe.DateFormatExample1 - parse exception</span><br><span class="line">java.lang.NumberFormatException: multiple points</span><br><span class="line">	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:<span class="number">1890</span>)</span><br><span class="line">	at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:<span class="number">110</span>)</span><br><span class="line">	....................</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.update(DateFormatExample1.java:<span class="number">51</span>)</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.lambda$main$<span class="number">0</span>(DateFormatExample1.java:<span class="number">37</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line"><span class="number">14</span>:<span class="number">25</span>:<span class="number">08.446</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] ERROR com.mmall.concurrency.example.commonUnsafe.DateFormatExample1 - parse exception</span><br><span class="line">java.lang.NumberFormatException: For input string: <span class="string">".20192019E"</span></span><br><span class="line">	at java.lang.NumberFormatException.forInputString(NumberFormatException.java:<span class="number">65</span>)</span><br><span class="line">	at java.lang.Long.parseLong(Long.java:<span class="number">578</span>)</span><br><span class="line">	..........</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.update(DateFormatExample1.java:<span class="number">51</span>)</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.lambda$main$<span class="number">0</span>(DateFormatExample1.java:<span class="number">37</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">	............</span><br></pre></td></tr></table></figure>

<p>由执行结果可知，<strong>SimpleDateFormat</strong>在进行并发执行时抛出了大量异常，这说明了<strong>SimpleDateFormat</strong>类的线程是不安全的。<strong>SimpleDateFormat</strong>声明的实例<strong>不能直接以成员变量的形式声明</strong>来被多线程使用。 </p>
<h3 id="正确使用SimpleDateFormat类，应该以局部变量的方式声明该类的实例："><a href="#正确使用SimpleDateFormat类，应该以局部变量的方式声明该类的实例：" class="headerlink" title="正确使用SimpleDateFormat类，应该以局部变量的方式声明该类的实例："></a>正确使用SimpleDateFormat类，应该以<strong>局部变量的方式</strong>声明该类的实例：</h3><p>代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">        simpleDateFormat.parse(<span class="string">"20191101"</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.error(<span class="string">"parse exception"</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果没有抛出异常：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//空行</span></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>注意： **多线程并发使用SimpleDateFormat类时，一定要在方法中以</strong>局部变量的方式声明**该类的实例。从而避免线程安全的问题。 </p>
<h3 id="JodaTimie类线程安全测试："><a href="#JodaTimie类线程安全测试：" class="headerlink" title="JodaTimie类线程安全测试："></a>JodaTimie类线程安全测试：</h3><p><strong>导入依赖：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>代码段：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//声明DateTimeFormatter实例</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> DateTimeFormatter dateTimeFormatter = DateTimeFormat.forPattern(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line"><span class="comment">//获取当前线程次序</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> count = i;</span><br><span class="line"><span class="comment">//传递线程次序</span></span><br><span class="line">update(count);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//update方法中日志输出线程执行结果</span></span><br><span class="line">log.info(<span class="string">"&#123;&#125;, &#123;&#125;"</span>,i,DateTime.parse(<span class="string">"20191101"</span>,dateTimeFormatter).toDate());</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu280.png" width="60%">

<p><strong>由执行结果可知，</strong>虽然DateTimeFormatter 实例结果是乱序输出的，但是执行线程总数是完全符合要求的，所以DateTimeFormatter的线程是安全的。 </p>
<h2 id="集合类"><a href="#集合类" class="headerlink" title="集合类"></a>集合类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ArrayList , HashSet , HashMap 等 Collections</span><br></pre></td></tr></table></figure>

<h3 id="ArrayList线程安全测试："><a href="#ArrayList线程安全测试：" class="headerlink" title="ArrayList线程安全测试："></a>ArrayList线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayListExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">02</span>:<span class="number">53.644</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.ArrayListExample - size:<span class="number">4892</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度不为5000，说明了ArrayList的<strong>add操作</strong>在多线程并发环境下是<strong>线程不安全</strong>的。 </p>
<h3 id="HashSet线程安全测试："><a href="#HashSet线程安全测试：" class="headerlink" title="HashSet线程安全测试："></a>HashSet线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;Integer&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//获取当前线程次序</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> count = i;</span><br><span class="line"><span class="comment">//传递线程次序</span></span><br><span class="line">update(count);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//update方法中日志输出线程执行结果</span></span><br><span class="line">log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">    set.add(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">23.554</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.HashSetExample - size:<span class="number">4864</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度不为5000，说明了<strong>HashSet</strong>的<strong>add操作</strong>在多线程并发环境下也是<strong>线程不安全</strong>的。 </p>
<h3 id="HashMap线程安全测试："><a href="#HashMap线程安全测试：" class="headerlink" title="HashMap线程安全测试："></a>HashMap线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> HashMap&lt;Integer,Integer&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//获取当前线程次序</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> count = i;</span><br><span class="line"><span class="comment">//传递线程次序</span></span><br><span class="line">update(count);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//update方法中日志输出线程执行结果</span></span><br><span class="line">log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">   map.put(i,i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">16</span>:<span class="number">26.117</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.HashMapExample - size:<span class="number">4870</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度<strong>不为5000</strong>，说明了<strong>HashMap</strong>的<strong>add操作</strong>在多线程并发环境下也是<strong>线程不安全</strong>的。 </p>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><blockquote>
<p>先检查再执行： if(condition(a)) { handle(a) ; } </p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>线程不安全类</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化开发（五）Specification-04-Data Communication</title>
    <url>/2020/04/08/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%94%EF%BC%89Specification-04-Data%20Communication/</url>
    <content><![CDATA[<h1 id="04-Data-Communication"><a href="#04-Data-Communication" class="headerlink" title="04. Data Communication"></a>04. Data Communication</h1><p>PLC存储器的数据区域分为两个区域，即 <strong>Local Area</strong>  和 <strong>Master Area</strong> 。<strong>Local Area</strong> 用于从 <strong>Local  PLC</strong>  向 <strong>Master PLC</strong> 发送数据，而 <strong>Master Area</strong> 用于从  <strong>Master PLC</strong> 向 <strong>Local PLC</strong> 传输数据。每个区域的项目根据报告或命令的特征分为几个类型，每个项目类型如下所示。</p>
<ul>
<li>Local Area <ul>
<li>Status :  表示设备、端口、PLC当前状态的项。 </li>
<li>Event :    表示设备生成的事件的项 </li>
<li>Request :  设备请求对BC做任何动作的许可。</li>
<li>Command Reply : 设备响应主PLC的命令 (BC)</li>
</ul>
</li>
<li>Master Area <ul>
<li>Status :  表示BC和主PLC状态的项。</li>
<li>Command : 可以发送到本地PLC的项</li>
<li>Event Reply : 从设备中针对事件进行回复的项。 </li>
<li>Request Reply：根据设备的要求进行回复的项目 </li>
</ul>
</li>
</ul>
<h2 id="04-01-Link-Relay-Link-Register-Relation"><a href="#04-01-Link-Relay-Link-Register-Relation" class="headerlink" title="04.01. Link Relay, Link Register Relation"></a>04.01. Link Relay, Link Register Relation</h2><ul>
<li>当事件发生或某些数据发生变化时，本地PLC必须将数据写入特定的链路寄存器<strong>(W区)</strong>，然后打开相关的本地链路继电器<strong>(B区)</strong>触发事件 </li>
<li>当链路继电器的数据发生变化时，主PLC应读取相关的链路寄存器区域，然后打开自己的链路继电器进行应答，应答对应于本地继电器。 </li>
<li>当主PLC的响应是OK时，本地PLC关闭其链路继电器。 </li>
<li>当本地PLC的链路继电器断开时，主PLC断开与本地PLC的链路继电器相对应的链路继电器 </li>
</ul>
<h2 id="04-02-EQP-Event-Report-Timing-Chart"><a href="#04-02-EQP-Event-Report-Timing-Chart" class="headerlink" title="04.02. EQP Event Report Timing Chart"></a>04.02. EQP Event Report Timing Chart</h2><h3 id="04-02-01-Event-Report-Timing-Chart-Local-to-Master"><a href="#04-02-01-Event-Report-Timing-Chart-Local-to-Master" class="headerlink" title="04.02.01. Event Report Timing Chart (Local to Master)"></a>04.02.01. Event Report Timing Chart (Local to Master)</h3><img src="http://photo.wushaopei.com/qiniu277.png" width="80%">

<p>如图，是机台报到BC 的流程。</p>
<p>第一步，Local 会先写Word Area ，然后Bit on  起来。</p>
<p>第二步，BC 监测到Local 的BIT  on 起来后，会在对应的Word 去读取数据（Data Reading)，读取完数据后会进行处理。处理完成好，会进行 Reply  on 起来回复。</p>
<p>第三步，机台收到回复后，机台的 Event Report 会 off 。BC 收到机台的 off 后，BC的 Event Report Reply 也会 off.</p>
<p>以上就是一个事件的完整流程。</p>
<p>关于CIM MODE ：</p>
<p>CIM MODE 如果是开着的，那么就按照正常流程去走即可；</p>
<p>如果CIM MODE是关掉的，就不会有Local On BIT 和  Master 检测 Bit 变化的那一步，机台的Report 会一直off ，但是数据还是要写入到 Word Area 的。</p>
<p>为什么要这么做？</p>
<p>在机台、机况等比较重要的状态，包括 port 信息等，如果该流程是在CIM MODE  off 的状态下执行的，它实时的更新到Word Area ，在它开启之后，或者BC 重启之后，会重新捞一遍数据。我们会给他更新到最新的状况，而不是说现场发生了什么我们还不知道。</p>
<h3 id="04-02-02-Request-Timing-Chart-Local-to-Master"><a href="#04-02-02-Request-Timing-Chart-Local-to-Master" class="headerlink" title="04.02.02. Request Timing Chart (Local to Master)"></a>04.02.02. Request Timing Chart (Local to Master)</h3><img src="http://photo.wushaopei.com/qiniu292.png" width="80%">

<p>① 将数据输入链路寄存器(W区)后，本地PLC打开链路继电器(B区)。 </p>
<p>② Local PLC加载计时器检查超时。(T1:4秒)-本地PLC在此期间不报告任何使用此链路继电器的其他事件。 </p>
<p>③主PLC读取数据，然后打开链路继电器(B区)。</p>
<p>④ 本地PLC读取主PLC的数据并关闭链路继电器(事件位)，然后继续下一步动作 </p>
<p>⑤主PLC关闭链路继电器(事件应答)，定时器复位后。主PLC在T2时间内扫描本地PLC的链路。如果超时，主PLC处理错误例程(T2超时时间为2秒)</p>
<ul>
<li>EQ厂商提供T1定时器数值设定功能。(默认值= 4秒) </li>
<li>本地PLC在链路寄存器中保存一次设置的报表数据，直到生成新的报表数据。 </li>
</ul>
<p><strong>流程：</strong> </p>
<p>① 机台将数据写入到W区，也就是Data中，然后Bit Area on 起来</p>
<p>② BC 收到机台 on 起来的消息，会先去读 机台的 W区；并进行逻辑运算、数据处理，将处理结果写入BC的 W区（Return Code）,然后Bit 也 on 起来</p>
<p>③ 机台收到BC on 起来的消息，就去读BC的 W Area ，读取完成后就将Bit  off</p>
<p>④ BC 收到 机台 Bit Are off ,也进行 off。</p>
<h3 id="04-02-03-Consecutive-Event-Report-Timing-Chart-Local-to-Master"><a href="#04-02-03-Consecutive-Event-Report-Timing-Chart-Local-to-Master" class="headerlink" title="04.02.03. Consecutive Event Report Timing Chart (Local to Master)"></a>04.02.03. Consecutive Event Report Timing Chart (Local to Master)</h3><img src="http://photo.wushaopei.com/qiniu293.png" width="80%">

<p>​    当本地PLC有多个连续数据要使用一个事件位(如Alarm或Job)报告给主PLC时，上述时序图指定了数据报告事件的过程。</p>
<p>① 如果本地PLC有数据(命名数据A)要报告给主PLC，则在缓冲区中设置数据A </p>
<p>② 如果本地PLC目前没有其他先前的数据报告给主PLC，则移动数据到缓冲区中设置一个连接寄存器区域并报告给主PLC。</p>
<p>③ 如果本地PLC有新的数据(命名数据B)报告给主PLC，本地PLC在缓冲区中设置数据B。如果此时有之前的数据(即数据A)正在报告给master，本地PLC等待，直到数据报告过程结束</p>
<p>④ 主PLC关闭链路继电器(事件应答)后，本地PLC等待0.5秒(T3:0.5秒)，然后本地PLC将数据B移动到链路字区，并报告给主PLC </p>
<ul>
<li>EQ厂商提供T3定时器值设定功能。(默认值= 0.5秒) </li>
</ul>
<h2 id="04-03-BC-Command-Reply-Timing-Chart"><a href="#04-03-BC-Command-Reply-Timing-Chart" class="headerlink" title="04.03. BC Command Reply Timing Chart"></a>04.03. BC Command Reply Timing Chart</h2><h3 id="04-03-01-BC-Command-Timing-Chart-Master-to-Local"><a href="#04-03-01-BC-Command-Timing-Chart-Master-to-Local" class="headerlink" title="04.03.01. BC Command Timing Chart (Master to Local)"></a>04.03.01. BC Command Timing Chart (Master to Local)</h3><p>BC Notice Area is related to Equipment Command Reply Area （BC通知区与设备命令应答区相关）</p>
 <img src="http://photo.wushaopei.com/qiniu294.png" width="80%">

<p>①将数据设置到主PLC的链路寄存器区域后，主PLC再打开链路继电器(命令) </p>
<p>②主PLC加载定时器检查超时。(T1: 4秒) </p>
<p>③本地PLC读取主区域的数据。读取后，本地PLC打开本地PLC的链路继电器(命令应答) </p>
<p>④主PLC在命令应答时关闭链路继电器(命令)。如果在T1超时内本地PLC没有打开应答位，则主PLC处理错误例程 </p>
<p>⑤本地PLC关闭链路继电器(命令应答)，定时器复位后。本地PLC在T2时间内扫描主PLC的链路继电器。如果超时(T2)发生，本地PLC处理错误例程。 </p>
<ul>
<li>EQ厂商提供T2定时器数值设定功能。(默认值= 2秒) </li>
</ul>
<h2 id="04-04-Time-Out-Error"><a href="#04-04-Time-Out-Error" class="headerlink" title="04.04. Time Out Error"></a>04.04. Time Out Error</h2><h3 id="04-04-01-T1-Time-Out-Master-↔-Local"><a href="#04-04-01-T1-Time-Out-Master-↔-Local" class="headerlink" title="04.04.01. T1 Time Out (Master ↔ Local)"></a>04.04.01. T1 Time Out (Master ↔ Local)</h3> <img src="http://photo.wushaopei.com/qiniu295.png" width="80%">

<p>① 将数据输入链路寄存器后，本地或主PLC打开链路继电器(事件或命令位) </p>
<p>② 本地或主PLC加载定时器检查超时。(T1:4秒)如果伙伴的响应不存在，则本地或主PLC超时。 </p>
<p>③ 在定时器复位后，关闭连接继电器(事件或命令位)。 </p>
<h3 id="04-04-02-T2-Time-Out-Master-↔-Local"><a href="#04-04-02-T2-Time-Out-Master-↔-Local" class="headerlink" title="04.04.02. T2 Time Out (Master ↔ Local)"></a>04.04.02. T2 Time Out (Master ↔ Local)</h3> <img src="http://photo.wushaopei.com/qiniu296.png" width="80%">

<p>① 将数据读入链路字后（W区），打开链路中继(命令或事件应答Bit区)</p>
<p>② 加载计时器来检查超时 。(T2:2分钟)。如果伙伴的响应不存在，则本地或主PLC进行超时。 </p>
<p>③ 在定时器复位后，关闭连接继电器(事件或命令应答位) </p>
<h3 id="04-04-03-T3-Delay-Time-Master-↔-Local"><a href="#04-04-03-T3-Delay-Time-Master-↔-Local" class="headerlink" title="04.04.03. T3 Delay Time (Master ↔ Local)"></a>04.04.03. T3 Delay Time (Master ↔ Local)</h3>  <img src="http://photo.wushaopei.com/qiniu297.png" width="80%">

<p>① 主PLC关闭链路继电器(事件应答)后，本地PLC等待0.5秒(T3:0.5秒)，然后本地PLC将数据B移动到链路字区，并报告给主PLC </p>
<ul>
<li>EQ厂商提供T3定时器值设定功能。(默认值= 0.5秒) </li>
</ul>
<h3 id="04-04-04-Tn-Time"><a href="#04-04-04-Tn-Time" class="headerlink" title="04.04.04. Tn Time"></a>04.04.04. Tn Time</h3><ul>
<li><p>Event Report Timing Chart (Local to Master) us Bar</p>
<img src="http://photo.wushaopei.com/qiniu298.png" width="80%">

</li>
</ul>
<p>① 将数据设置到链接寄存器(W区)后。本地PLC开启链路继电器(事件位) </p>
<p>② 当数据写入链接寄存器时。链路继电器(事件报告位)必须延迟0.2秒才能打开。Tn定时器的最大值是1秒。 </p>
<h2 id="04-05-Data-Expression"><a href="#04-05-Data-Expression" class="headerlink" title="04.05. Data Expression"></a>04.05. Data Expression</h2><h3 id="04-05-01-ASCII-Type"><a href="#04-05-01-ASCII-Type" class="headerlink" title="04.05.01. ASCII Type"></a>04.05.01. ASCII Type</h3><ul>
<li>使用8位ASCII码。 </li>
<li>用ASCII类型的空白(H20)值填充空值。 </li>
<li>字内字符间顺序:低字节→高字节顺序 </li>
<li>词序:低词序→高词序 </li>
<li>字符和数字数据格式:标准字符格式 </li>
</ul>
<img src="http://photo.wushaopei.com/qiniu299.png" width="80%">

<p><strong>Example：</strong>   </p>
<ul>
<li>Character data：(Ex.) ‘R’ → H2052 </li>
<li>Character data：(Ex.) ‘I1’ → H3149 (H4931 is an error) </li>
<li>Character data：(Ex.) ‘123’ → H3231 2033 </li>
<li>Character data：(Ex.) ‘2AA00101 ‘ → H4132 3041 3130 3130 2020 2020 </li>
</ul>
<h3 id="04-05-02-Numeric-Type"><a href="#04-05-02-Numeric-Type" class="headerlink" title="04.05.02. Numeric Type"></a>04.05.02. Numeric Type</h3><h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>自动化开发（四）Specification-03-Terms Definition</title>
    <url>/2020/04/07/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E5%9B%9B%EF%BC%89Specification-03-Terms-Definition/</url>
    <content><![CDATA[<h2 id="03-01-Common-（所有）"><a href="#03-01-Common-（所有）" class="headerlink" title="03.01 Common （所有）"></a><strong>03.01 Common （所有）</strong></h2><h3 id="03-01-01-Job"><a href="#03-01-01-Job" class="headerlink" title="03.01.01 Job"></a>03.01.01 Job</h3><p>​    这项工作意味着对玻璃、切割和切屑等材料进行特定的加工。 </p>
<h4 id="理解："><a href="#理解：" class="headerlink" title="理解："></a>理解：</h4><p>​    所有的玻璃就叫做Job，玻璃分很多种，有大版和切割后的glass、cut和chip等等。</p>
<p>在Array未切割前就是<strong>Glass</strong>；到了CF后会进行切割，切割后就是<strong>cut</strong>（一个glass切成四个中等的板），切割成更小的就是<strong>chip</strong>(一个glass切成8片或16片).</p>
<h3 id="03-01-02-Recipe-ID-制成ID"><a href="#03-01-02-Recipe-ID-制成ID" class="headerlink" title="03.01.02 Recipe ID (制成ID)"></a>03.01.02 Recipe ID (制成ID)</h3><p><strong>举例理解：</strong>  比如现在要生产一个55寸的液晶显示器，那么每一个机台需要使用什么样的制成（包含温度、时间，或者烘烤时间、物料的使用等都包含在Recipe中）。制成的设置是在机台里进行设定的。</p>
<p><strong>Recipe ID 的构成</strong>，这个ID称为配方ID(配方ID由。0<del>9, A</del>Z, A~Z(除:I, O, I, O))和特殊符号:” _ “，空格(ASCII=20)。 </p>
<p><strong>Example：</strong>  </p>
<blockquote>
<p>OK of Recipe Number = PPID_Rec_001 </p>
<p>NG of Recipe Number = PPID@Recipe-O01 ← Can’t use -, @, i,O symbol </p>
<p>NG of Recipe Number = PPID□Rec_001 ← Can’t use □ (space) in middle  </p>
<p>NG of Recipe Number = □PPIDRec_001 ← Can’t use □ (space) in front</p>
</blockquote>
<h3 id="03-01-03-PPID"><a href="#03-01-03-PPID" class="headerlink" title="03.01.03. PPID"></a>03.01.03. PPID</h3><p><strong>PPID</strong>由每个本地配方ID的组合组成，最大字符总长度为ASCII 50个字符。PPID和配方ID关系规则是指设备运行场景。 </p>
<p>(例A1B2C3 ~ ~)</p>
<p><strong>通俗点：</strong> PPID 为线上的每个机台的  Recipe ID 的集合。</p>
<p><strong>示例</strong> ： 当前有三个机台，分别为 Recp_001、Recp_002、Recp_003，那么，他的PPID就是这三个Recipe ID 的集合了。</p>
<h2 id="03-02-Job"><a href="#03-02-Job" class="headerlink" title="03.02. Job"></a>03.02. Job</h2><h3 id="03-02-01-Substrate-Type"><a href="#03-02-01-Substrate-Type" class="headerlink" title="03.02.01. Substrate Type"></a>03.02.01. Substrate Type</h3><p>在从事底层的Job中，它包括4种类型:Glass，cut，chip和Casssette 。</p>
<h3 id="03-02-02-Glass-ID"><a href="#03-02-02-Glass-ID" class="headerlink" title="03.02.02. Glass ID"></a>03.02.02. Glass ID</h3><p>每个Glass有一个Glass ID, Glass ID是唯一的，每一片玻璃只能有一个Glass ID, 全场唯一，以后也不会有重复的。</p>
<p>Glass ID 如果切成小板，则会对每个小板标记为01、02这样的标记作为区分。</p>
<img src="http://photo.wushaopei.com/qiniu270.png" width="80%">

<p>如图所示，假设当前Glass ID 为 glass_A，那么对应的每一块小板为glass_A01、glass_A02、glass_A03这样依次序号进行递增。</p>
<h3 id="03-02-03-Cut-ID"><a href="#03-02-03-Cut-ID" class="headerlink" title="03.02.03. Cut ID"></a>03.02.03. Cut ID</h3><p>​    经过第一次切割操作，玻璃变成了一个多芯片。 </p>
<p>​    即，第一次切割操作的ID。</p>
<img src="http://photo.wushaopei.com/qiniu271.png" width="80%">



<h3 id="03-02-04-Chip-ID"><a href="#03-02-04-Chip-ID" class="headerlink" title="03.02.04. Chip ID"></a>03.02.04. Chip ID</h3><p>经过第二次切割操作后，glass 变成更小的一块，称为chip (它也被称为细胞或面板)。它的ID被称为Chip ID (TFT芯片ID最多由20个字符组成;CF芯片ID最多由20个字符组成)。示例请参考线路运行场景 </p>
<img src="http://photo.wushaopei.com/qiniu272.png" width="80%">



<h3 id="重点："><a href="#重点：" class="headerlink" title="重点："></a>重点：</h3><p>现实生产中很少根据Glass ID 去定位问题。一般都是根据Cassette Sequence NO 和Job Sequeence NO 去定位到一片玻璃和它对应的资料。</p>
<p><strong>DB 数据：</strong>  在DB中进行数据存储时也是根据这两个参数进行存储的。</p>
<h3 id="03-02-05-Cassette-Sequence-No"><a href="#03-02-05-Cassette-Sequence-No" class="headerlink" title="03.02.05. Cassette Sequence No"></a>03.02.05. Cassette Sequence No</h3><p>Cassette Sequence No  代表的是 Cassette 的ID 。每上一个新的 Cassette，就会把 Cassette Sequence 进行加一。最小的是0，当第一个 Cassette 上机后变成 1 ，后面的根据上机的Cassette一次增加 1 。Cassette Sequence No 最高会有一个限定的值，比如1000，当到达这个值时，会从0开始计数。</p>
<h3 id="03-02-06-Job-Sequence-No"><a href="#03-02-06-Job-Sequence-No" class="headerlink" title="03.02.06. Job Sequence No"></a>03.02.06. Job Sequence No</h3><p> Job Sequence 的意思是Cassette 的层数，或者说当前是第几层。</p>
<img src="http://photo.wushaopei.com/qiniu273.png" width="80%">

<p>如上图所示，右边的就是Cassette ，该Cassette 分为两个Slot , 从 Slot1 到 Slot2 ,共有56层（插槽） Slot 1 中是 Job Sequence Number 1<del>28， Slot 2 是 Job Sequence Number 29</del>56。</p>
<p><strong>重点：</strong> 根据 Cassette Sequence No 我们可以知道该片Glass 在哪个Cassette中，根据    Job Sequence Number 我们可以知道该片Glass 在 Cassette中的哪个位置。</p>
<p><code>一个slot 层中只能有一片玻璃。</code></p>
<h3 id="03-02-07-Chip-Position-芯片定位"><a href="#03-02-07-Chip-Position-芯片定位" class="headerlink" title="03.02.07. Chip Position(芯片定位)"></a>03.02.07. Chip Position(芯片定位)</h3><p>它主要是指切割前面板在玻璃中的具体位置。在第一次或第二次切割后，人们可以通过这个值知道每个芯片在玻璃中的原始位置 </p>
<img src="http://photo.wushaopei.com/qiniu275.png" width="80%">

<p>如图中所示，TFT 是Array切割的玻璃，而CF是CF切割的玻璃，最终这两块对应玻璃是会合到一起的。在合到一起后再进行切割。</p>
<p>​    切割之前，需要在Cell厂进行画框，并使用框胶等进行固定。一般切割为16块芯片，这是根据Chip Position来确定切割的数量的。</p>
<img src="http://photo.wushaopei.com/qiniu276.png" width="80%">



<h3 id="03-02-08-Job-Type"><a href="#03-02-08-Job-Type" class="headerlink" title="03.02.08. Job Type"></a>03.02.08. Job Type</h3><p> Job Type 是用来区分 cassette 或 glass 的种类。 它由Normal 、Dummy 等组成。通常，glass 是根据其工作类型来分类的。 </p>
<h3 id="03-02-09-Job-Judge"><a href="#03-02-09-Job-Judge" class="headerlink" title="03.02.09. Job Judge"></a>03.02.09. Job Judge</h3><p>它表示对 Job 信息的判断 .  可能的结果包括： OK, NG, Reject, Rework等。 </p>
<h3 id="03-02-10-OXR-Information"><a href="#03-02-10-OXR-Information" class="headerlink" title="03.02.10. OXR Information"></a>03.02.10. OXR Information</h3><p>OXR信息用于识别每个芯片的判断结果，记录在检测设备中。OXR信息有R, L, O (OK)， X (NG)和F (Down Grade)状态。 </p>
<h3 id="03-02-11-Job-Grade"><a href="#03-02-11-Job-Grade" class="headerlink" title="03.02.11. Job Grade"></a>03.02.11. Job Grade</h3><p>​    等级是用来识别每个玻璃的判定结果，记 录在检验设备上。 </p>
<p>​    等级有OK, NG, RP, PC, MD, CD, ID, DR, RW等</p>
<h3 id="03-02-12-Tracking-Data"><a href="#03-02-12-Tracking-Data" class="headerlink" title="03.02.12. Tracking Data"></a>03.02.12. Tracking Data</h3><p>​    跟踪用于记录玻璃工艺流程的数据，在PLC地图中定义该项目。 </p>
<p>示例： 比如，一条线上有多个相同制成的，如当前线上有两台切割机，功能相同的，而当前的glass只需要经过其中一个切割机。在Tracking Data 中，数据是以二进制进行存储的一串数据。</p>
<p>​    当glass经过左边的切割机时，我们可以给它（切割机）定义一个bit ,就在Tracking Data中写 1 ，如果是右边的切割机就写 0 。</p>
<p>​    这整个操作是有机台告诉我们信息，然后我们来作记录。</p>
<h2 id="03-03-Equipment"><a href="#03-03-Equipment" class="headerlink" title="03.03. Equipment"></a>03.03. Equipment</h2><h3 id="03-03-01-Inline-Mode"><a href="#03-03-01-Inline-Mode" class="headerlink" title="03.03.01. Inline Mode"></a>03.03.01. Inline Mode</h3><p>Inline Mode 分上下游两种，一种是upstream Inline ，另一种是 downstream Inline 。如果Inline的信号都是 on 的情况下，才能实现相互的流片操作。该操作主要是设备之间的。</p>
<p>内联模式仅与作业转移相关，仅在上游设备和下游设备之间必要。 </p>
<p>当有多个接口时，所有的接口都切换成内联关闭来报告BC内联。</p>
<p>​    </p>
<p><code>该Mode 会被上报到BC，并由BC进行记录。</code></p>
<h3 id="03-03-02-CIM-Mode"><a href="#03-03-02-CIM-Mode" class="headerlink" title="03.03.02. CIM Mode"></a>03.03.02. CIM Mode</h3><p>CIM模式是指定设备与BC之间的通信关系。一般情况下，在CIM OFF模式下，本地PLC应该忽略主PLC的命令。 </p>
<p>设备变更CIM模式需要用户账号控制;设备中的玻璃不影响CIM模式的改变。当CIM模式关闭时，需要报告警告，直到CIM模式更改为On，然后重置警告。 </p>
<p>在CIM关闭模式下，设备应保持当前的word数据，并不用更新，不需要将事件位更改为on。 </p>
<p>触摸屏需要在主窗体中显示CIM的开/关状态，在任何页面中都要改变disp的状态。</p>
<p>当CIM模式从CIM关到CIM开时，设备从BC开始调整时间 。</p>
<hr>
<p><strong>通俗点：</strong>  </p>
<p>​    <code>CIM Mode 只有两种状态，不是on 就是 off。 CIM Mode 开的时候，机台一定要把数据报给BC；关的时候，机台要把数据写到Word Area , 但是不 on Bit .</code></p>
<p>​    关于CIM MODE 状态切换的方式：共有两种方式</p>
<p>​    第一种方式，机台可以自己切换 on / off，在机台的 Touch panel 上有相应的切换按钮可以进行切换操作。在切换完成之后会报给BC 。</p>
<p>​    另一种方式，BC 的 OPI 上也会下命令给机台来切 CIM ON  或  CIM OFF .</p>
<h3 id="03-03-03-Equipment-Status"><a href="#03-03-03-Equipment-Status" class="headerlink" title="03.03.03. Equipment Status"></a>03.03.03. Equipment Status</h3><p>Equipment Status 显示设备当前的运行状态。它由Setup, Stop, Pause, Idle and Run构成 .</p>
<p><code>机台变化后，会先把数据写到 Word Area , 然后再把 Bit on 起来。</code></p>
<p>​    各个状态之间的切换是有顺序的，不能直接从 Setup 切换到 Run。</p>
<h3 id="03-03-04-Unit-Status"><a href="#03-03-04-Unit-Status" class="headerlink" title="03.03.04. Unit Status"></a>03.03.04. Unit Status</h3><p> Unit Status 显示单元的当前操作状态。 Unit Status 的类型和定义与 Equipment Status 的类型和定义相同。 </p>
<h3 id="03-03-05-Alarm-Status"><a href="#03-03-05-Alarm-Status" class="headerlink" title="03.03.05. Alarm Status"></a>03.03.05. Alarm Status</h3><p>每个Alarm可以在两种状态之一:设置和清除。如果设备发生警报 ，称为Alarm Set， 一旦警报被cleared ， 然后它被称为警报Clear 。</p>
<h3 id="03-03-06-Alarm-ID"><a href="#03-03-06-Alarm-ID" class="headerlink" title="03.03.06. Alarm ID"></a>03.03.06. Alarm ID</h3><p>Alarm 标识符</p>
<h3 id="03-03-07-Alarm-Level"><a href="#03-03-07-Alarm-Level" class="headerlink" title="03.03.07. Alarm Level"></a>03.03.07. Alarm Level</h3><p>它显示了警报的级别。它由 Warming 和 Error 组成 。  </p>
<p>Warming 只是起到提示作用，而 Error 的出现可能导致宕机。</p>
<h3 id="03-03-08-Processing-Time"><a href="#03-03-08-Processing-Time" class="headerlink" title="03.03.08. Processing Time"></a>03.03.08. Processing Time</h3><p>它是设备或单元中一项工作的实际处理时间。它不包括在上游设备和下游设备之间转移所花费的时间。设备包括工艺数据报告中的这一项。 </p>
<p>工艺时间的计算，由设备供应商要求并与CSOT工程师讨论确认。</p>
<h3 id="03-03-09-VCR-No"><a href="#03-03-09-VCR-No" class="headerlink" title="03.03.09. VCR No."></a>03.03.09. VCR No.</h3><p>VCR No用于区分设备中唯一的VCR。如果只有一台录像机，VCR No始终为’ 1 ‘，其他报告依次为’ 2 ‘、’ 3 ‘、’ 4 ‘…等</p>
<p>VCR No. 是用来扫码的，玻璃上有二维码，二维码记录的是 Glass 的Glass ID, 玻璃经过有VCR 的机台的时候，会在玻璃上固定的点位去扫二维码，读到 Glass ID 和 前面机台带下来的数据进行校验。</p>
<p>如果不一样就会报警。</p>
<p>但有些机台可能会有多个VCR ，所以要使用VCR No. 进行标识。</p>
<h3 id="03-03-10-Ionizer-Fan-No"><a href="#03-03-10-Ionizer-Fan-No" class="headerlink" title="03.03.10. Ionizer-Fan No."></a>03.03.10. Ionizer-Fan No.</h3><p>Ionizer-Fan (I-Fan)没有。用于区分设备中唯一的离子风机。如果只有一个I-Fan, I-Fan No总是“1”。，另一份报告按“2”、“3”、“4”顺序排列。</p>
<p>所有配备离子风扇的必须报告到BC的启用/禁用状态。</p>
<h2 id="03-04-Port"><a href="#03-04-Port" class="headerlink" title="03.04. Port"></a>03.04. Port</h2><h3 id="03-04-01-Port-Type"><a href="#03-04-01-Port-Type" class="headerlink" title="03.04.01. Port Type"></a>03.04.01. Port Type</h3><p>它将根据当前装入的磁带的预期操作对端口进行分类端口;在端口上装载的磁带是将作业输入到内联，还是输出作业内联后的作业在该行中完成其进程，或在临时行中缓冲作业。 </p>
<p>有4种类型:Loading Port, Unloading Port, Both Port and Buffer Port 。</p>
<p>（1） 有玻璃的 Cassette只能上 Loading Port、Both Port（通用，无玻璃的Cassette也能用） </p>
<p>（2） Unloading Port 是用来上空 Cassette 收玻璃用的</p>
<p>（3） Buffer Port 是 Port Type 的安全区，主要设置在整条线的中间或者某个重要制成的前面，用来防止重要制成的塞片。</p>
<p>示例：可能某些制成要做很长时间，而导致前面的玻璃停留很长时间甚至流不动。</p>
<h3 id="03-04-02-Port-Mode"><a href="#03-04-02-Port-Mode" class="headerlink" title="03.04.02. Port Mode"></a>03.04.02. Port Mode</h3><p>它是根据已包含或将在端口上的磁带中排序的作业判断对端口进行分类。 </p>
<h3 id="03-04-03-Port-Transfer-Mode"><a href="#03-04-03-Port-Transfer-Mode" class="headerlink" title="03.04.03. Port Transfer Mode"></a>03.04.03. Port Transfer Mode</h3><p>它表明类型的AMHS机器连接端口在传输磁带到/从端口。 </p>
<h3 id="03-04-04-Port-Enable-Mode"><a href="#03-04-04-Port-Enable-Mode" class="headerlink" title="03.04.04. Port Enable Mode"></a>03.04.04. Port Enable Mode</h3><p>它表示端口是否可以使用。如果端口的这种模式被更改为 “禁用” 模式’，设备不处理的磁带上的端口。操作员可以在设备屏幕上更改其值。</p>
<p>这是Port 的开关，关掉 后，会导致Port 不能用。</p>
<h3 id="03-04-05-Port-Status"><a href="#03-04-05-Port-Status" class="headerlink" title="03.04.05. Port Status"></a>03.04.05. Port Status</h3><p>它是用来表示一个端口是否可用来装载Cassette，或者Cassette装载已完成到一个端口，或者一个端口是否可用来卸载Cassette。 </p>
<p>一般搭配 Cassette Status 一起使用。</p>
<h3 id="03-04-06-Port-Grade"><a href="#03-04-06-Port-Grade" class="headerlink" title="03.04.06. Port Grade"></a>03.04.06. Port Grade</h3><p>Port 等级设置结果报告。检查后，出货标准为玻璃放Cassette</p>
<h3 id="03-04-07-Cassette-Status"><a href="#03-04-07-Cassette-Status" class="headerlink" title="03.04.07. Cassette Status"></a>03.04.07. Cassette Status</h3><p>它指示端口上磁带的处理状态。 </p>
<h3 id="03-04-08-Cassette-ID"><a href="#03-04-08-Cassette-ID" class="headerlink" title="03.04.08. Cassette ID"></a>03.04.08. Cassette ID</h3><p>特定的ID被分配给单独的磁带，称为盒式磁带ID。它可以被读取条形码阅读器(BCR)，可由触摸屏上的特殊操作员进行修改。(磁带ID最多包含10个字符，PP BOX ID最多包含10个字符，密盒ID最多包含10个字符。) </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>微信小程序（一）简介</title>
    <url>/2020/04/06/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%88%E4%B8%80%EF%BC%89%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h1 id="微信小程序"><a href="#微信小程序" class="headerlink" title="微信小程序"></a>微信小程序</h1><h2 id="微信小程序简介"><a href="#微信小程序简介" class="headerlink" title="微信小程序简介"></a>微信小程序简介</h2><h3 id="什么是微信小程序"><a href="#什么是微信小程序" class="headerlink" title="什么是微信小程序"></a>什么是微信小程序</h3><p>温馨小程序是一种全新的连接用户与服务的方式，它可以在微信内被便捷的获取和传播，同时具有出色的使用体验。</p>
<p>手机端app的另外一种新的展现形式</p>
<p>无需下载过多占用内存的app，小程序直接打开</p>
<h4 id="小程序必备技术点"><a href="#小程序必备技术点" class="headerlink" title="小程序必备技术点"></a>小程序必备技术点</h4><ul>
<li>HTML </li>
<li>JavaScript</li>
<li>CSS</li>
</ul>
<h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><ul>
<li>基于腾讯庞大的社交群体，可以为原生app导流</li>
<li>创业公司优先推出小程序 ，开发成本低</li>
<li>当作简单的工具使用，需要在app上频繁crud不适用</li>
</ul>
<h2 id="微信小程序的简要注册流程"><a href="#微信小程序的简要注册流程" class="headerlink" title="微信小程序的简要注册流程"></a>微信小程序的简要注册流程</h2><p><strong>前提准备：</strong></p>
<ul>
<li>需要有公众号（未认证个人/认证企业）</li>
<li>需要一个邮箱， 1 v 1</li>
</ul>
<p><strong>完善小程序信息</strong></p>
<ul>
<li>小程序名称、头像、介绍、类型</li>
<li>绑定开发者，管理员默认，团队成员需要绑定</li>
</ul>
<h2 id="小程序工程的构成"><a href="#小程序工程的构成" class="headerlink" title="小程序工程的构成"></a>小程序工程的构成</h2><h4 id="公有目录与私有目录的工程结构了解"><a href="#公有目录与私有目录的工程结构了解" class="headerlink" title="公有目录与私有目录的工程结构了解"></a>公有目录与私有目录的工程结构了解</h4><p><strong>主目录结构</strong></p>
<ul>
<li>app.js - 外部全局主js, 可以当作一个父类</li>
<li>app.json - 全局配置文件</li>
<li>app.wxss - 全局主样式，公用</li>
</ul>
<p><strong>案例：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu269.png" width="80%">

<p><strong>页面目录结构：</strong> 如 items下：</p>
<p> items.js - 私有的js，相当于子类</p>
<p>items.json - 以json对象形式存在的配置</p>
<p>items.wxml - 元素所渲染的页面</p>
<p>items.wxss - 私有样式</p>
<h3 id="手动写属于自己的第一个Demo"><a href="#手动写属于自己的第一个Demo" class="headerlink" title="手动写属于自己的第一个Demo"></a>手动写属于自己的第一个Demo</h3><p><strong>全局json （app.json)</strong></p>
<p>定义了这个app的要加载的内容（显示的页面）的路径，界面表现，网络超时时间，底部tab 等</p>
<p><strong>pages</strong> 属性定义了要加载的页面的路径，第一个默认未首页</p>
<p><strong>window</strong> 字段 小程序所有页面的顶部背景颜色，文字颜色定义在这里的。</p>
<img src="http://photo.wushaopei.com/qiniu222.jpg" width="80%">

<p><strong>底部切换栏： 在底部的首页与具体页面之间的切换操作</strong></p>
<p><strong>tabBar</strong> 字段 tabBar 配置项指定 tab 栏的表现，以及 tab 切换时显示的对应页面</p>
<blockquote>
<p>而text 则代表该栏目的名称</p>
<p>具体操作： 点击底部切换栏的名字，进行跳转：<br>点击首页跳转到首页，点击 慕课网跳转到 imooc 下的 imooctext.wxml 页面</p>
</blockquote>
<p><strong>networkTimeout</strong> 可以设置各种网络请求的超时时间</p>
<p><strong>debug</strong> 可以在开发者工具中开启 debug 模式，在开发者工具的控制台面板，调试信息以 info 的形式给出</p>
<p> <strong>单items</strong> 暂时唯一需要注意的就是page对象，里面有一个data对象，以键值对存放，在页面用template渲染</p>
<img src="http://photo.wushaopei.com/qiniu223.jpg" width="80%">

<p>界面布局名称的设置： </p>
<p>​    将“window” json 配置引入到 app.json 页面中，其中的 navigetionBarTitleText 可用来定义收也面的标题名称 </p>
<p>​    <img src="http://photo.wushaopei.com/qiniu224.jpg" width="80%"></p>
<h3 id="wxss样式文件的使用"><a href="#wxss样式文件的使用" class="headerlink" title="wxss样式文件的使用"></a>wxss样式文件的使用</h3><h4 id="微信小程序的-尺寸单位：-rpx"><a href="#微信小程序的-尺寸单位：-rpx" class="headerlink" title="微信小程序的 尺寸单位： rpx"></a>微信小程序的 尺寸单位： rpx</h4><img src="http://photo.wushaopei.com/qiniu281.jpg" width="80%">



<h4 id="导入外部样式："><a href="#导入外部样式：" class="headerlink" title="导入外部样式："></a>导入外部样式：</h4><p> 使用 @import “out.wxss”; /* 导入外部样式 */</p>
<img src="http://photo.wushaopei.com/qiniu282.jpg" width="80%">



<h4 id="内联样式-通过数据绑定的方式在view-组件标签内进行样式的绑定设置"><a href="#内联样式-通过数据绑定的方式在view-组件标签内进行样式的绑定设置" class="headerlink" title="内联样式 - 通过数据绑定的方式在view 组件标签内进行样式的绑定设置"></a>内联样式 - 通过数据绑定的方式在view 组件标签内进行样式的绑定设置</h4><p><strong>绑定数据：</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="comment">//获取应用实例</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    mytext: <span class="string">'这是一个Demo'</span>,</span><br><span class="line">    color:<span class="string">"red"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>获取数据：</strong> </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!--index.wxml--&gt;</span><br><span class="line">&lt;view <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">  &lt;text <span class="class"><span class="keyword">class</span></span>=<span class="string">"txt-css txt-left"</span>  style=<span class="string">"color:&#123;&#123;color&#125;&#125;；"</span>&gt;&#123;&#123;mytext&#125;&#125;&lt;<span class="regexp">/text&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>view&gt;</span><br></pre></td></tr></table></figure>

<h4 id="小程序的选择器："><a href="#小程序的选择器：" class="headerlink" title="小程序的选择器："></a>小程序的选择器：</h4><img src="http://photo.wushaopei.com/qiniu283.jpg" width="80%">



<h3 id="小程序页面加载"><a href="#小程序页面加载" class="headerlink" title="小程序页面加载"></a>小程序页面加载</h3><p>小程序默认加载 pages 中的第一个目录 ,其他目录需要通过触发才能加载</p>
<img src="http://photo.wushaopei.com/qiniu281.png" width="50%">



<h3 id="小程序-app-的生命周期"><a href="#小程序-app-的生命周期" class="headerlink" title="小程序 app 的生命周期"></a>小程序 app 的生命周期</h3><ul>
<li>onLaunch  第一次初始化会被出发只会被调用一次</li>
<li>onShow  小程序在前台会展现</li>
<li>onHide   前台到后台的展现（e.g 双击home 点进其他程序时）</li>
<li>onError 对错误时做出处理 与 java中gexception 很像</li>
<li>其他：  web开发者可以自行定义（全部都是全局）</li>
</ul>
<p><strong>app.js</strong> </p>
 <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">App(&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 当小程序初始化完成时，会触发 onLaunch（全局只触发一次）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onLaunch: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log("触发onLaunch")</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 当小程序启动，或从后台进入前台显示，会触发 onShow</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onShow: <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log("触发onShow")</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 当小程序从前台进入后台，会触发 onHide</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onHide: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log("触发onHide")</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 当小程序发生脚本错误，或者 api 调用失败时，会触发 onError 并带上错误信息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onError: <span class="function"><span class="keyword">function</span> (<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log("触发onError")</span></span><br><span class="line">  &#125;,</span><br><span class="line">  globalData: <span class="string">'I am global data'</span>,</span><br><span class="line">  courseName: <span class="string">'小程序实战'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="小程序中如何调试-js-文件"><a href="#小程序中如何调试-js-文件" class="headerlink" title="小程序中如何调试 js 文件"></a>小程序中如何调试 js 文件</h3><p><code>debugger // 开始调试</code></p>
<ul>
<li>F8     下一步<br>   F10     下一个断点</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu284.png" width="70%">



<h4 id="点击事件-页面跳转"><a href="#点击事件-页面跳转" class="headerlink" title="点击事件 - - 页面跳转"></a>点击事件 - - 页面跳转</h4><p><strong>test.wxml</strong> </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">id</span>=<span class="string">"txt-left"</span> <span class="attr">class</span>=<span class="string">"txt-css"</span>  <span class="attr">style</span>=<span class="string">"color:&#123;&#123;color&#125;&#125;;"</span>  <span class="attr">bindtap</span>=<span class="string">"clickMe"</span>&gt;</span>&#123;&#123;mytext&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>test.js</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">clickMe: function()&#123;</span><br><span class="line">   wx.redirectTo(&#123;</span><br><span class="line">     url: <span class="string">'../imooctest/imootest'</span>,  <span class="comment">// 跳转路径要使用相对路径</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="comment">// wx.navigateTo(&#123; </span></span><br><span class="line">   <span class="comment">//   url: "../imooctest/imootest"</span></span><br><span class="line">   <span class="comment">// &#125;)</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu284.png" width="70%">

<ul>
<li>wx.navigatoTo   隐藏页面，并没有关闭，出发onHide 事件</li>
<li>wx.redirctTo    卸载页面，关闭了，出发onUnload事件（推荐使用），不会有返回按钮。</li>
</ul>
<blockquote>
<p>如果有 tabBar 栏  navigatoTo, redirectTo 不会执行</p>
</blockquote>
<h3 id="小程序的事件"><a href="#小程序的事件" class="headerlink" title="小程序的事件"></a>小程序的事件</h3><p>自定义- 触发点击事件：</p>
<p>events.wxml </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"tapTest"</span> <span class="attr">data-customData</span>=<span class="string">'我们自定义的数据'</span> <span class="attr">data-sex</span>=<span class="string">"boy"</span> <span class="attr">bindtap</span>=<span class="string">"clickMe"</span>&gt;</span>click me!<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>events.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> common = <span class="built_in">require</span>(<span class="string">'../utils/common.js'</span>)</span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">   </span><br><span class="line">  &#125;,</span><br><span class="line">  clickMe: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">"被点击事件触发.............."</span>)</span><br><span class="line">   <span class="built_in">console</span>.log(e);</span><br><span class="line">   <span class="keyword">var</span> sex = e.currentTarget.dataset.sex;</span><br><span class="line">    <span class="keyword">var</span> customData = e.currentTarget.dataset.customdata;</span><br><span class="line">    <span class="keyword">var</span> id = e.currentTarget.id;</span><br><span class="line">    <span class="built_in">console</span>.log(sex);</span><br><span class="line">    <span class="built_in">console</span>.log(customData);</span><br><span class="line">    <span class="built_in">console</span>.log(id);</span><br><span class="line"></span><br><span class="line">    common.sayHello(<span class="string">"lee"</span>);</span><br><span class="line">    common.sayGoodbye(<span class="string">"imooc"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu285.jpg" width="70%">



<h3 id="小程序抽离公用方法进行模块化"><a href="#小程序抽离公用方法进行模块化" class="headerlink" title="小程序抽离公用方法进行模块化"></a>小程序抽离公用方法进行模块化</h3><p><strong>小程序模块化：</strong></p>
<p>​    （1） 抽离通用方法作为通用函数</p>
<p>​    （2）构建 utils-common 类</p>
<p><strong>定义公共 js 模块：</strong></p>
<p>①创建 utils 目录，并在该目录下创建common.js 作为公共资源，<br>②在需要调用 common.js 资源的 js （如 events.js）中的page对象上层使用 var common = require(‘ ../utils/common.js’) 对公共资源进行引入<br><strong>注意：</strong>  节点资源的引入只能使用相对路径，不支持绝对路径</p>
<img src="http://photo.wushaopei.com/qiniu286.jpg" width="70%">

<p>引入到Page后，直接使用 common.sayHello(“lee”),也就是 js 页面名.方法名( “参数” )的方式进行调用</p>
<img src="http://photo.wushaopei.com/qiniu287.jpg" width="70%">

<p><strong>暴露接口服务：</strong> </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.接口别名 = 真实名</span><br><span class="line">exports.接口别名 = 真实名</span><br></pre></td></tr></table></figure>



<h3 id="视图层-细说数据绑定"><a href="#视图层-细说数据绑定" class="headerlink" title="视图层 - 细说数据绑定"></a>视图层 - 细说数据绑定</h3><ul>
<li>JQuery dom 操作  $选择器</li>
<li>微信小程序是通过数据绑定   vue/react</li>
<li>*.js 中通过  data 对象与 *.wxml 的元素绑定   -&gt; Mustache 表达式语法</li>
</ul>
<p><strong>数据绑定示例：</strong></p>
<p>dataBind.wxml</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"myid - &#123;&#123;testid&#125;&#125;"</span>&gt;</span>&#123;&#123;msg&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>dataBind.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 页面的初始数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  data: &#123;</span><br><span class="line">      msg:<span class="string">"这是一个msg"</span>,</span><br><span class="line">      testid: <span class="number">1001</span>,</span><br><span class="line">      flag:<span class="literal">true</span>,</span><br><span class="line">      unflag:<span class="literal">false</span>,</span><br><span class="line">      a:<span class="number">1</span>,</span><br><span class="line">      b:<span class="number">4</span>,</span><br><span class="line">      c:<span class="number">5</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu289.png" width="30%">

<img src="http://photo.wushaopei.com/qiniu290.png" width="70%">

]]></content>
  </entry>
  <entry>
    <title>mybatis 入门（六）实例</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E5%85%AD%EF%BC%89%E5%AE%9E%E4%BE%8B/</url>
    <content><![CDATA[<p>这里做一个实例，它可以使我们熟悉MyBatis 主要组件的用法。我们需要满足MyBatis各个组件的生命周期。首先需要生成SqlSessionFactory单例，然后让它生成SqlSession，进而拿到映射器来完成我们的业务逻辑。</p>
<p>​    确定文件所需要放置的路径，以便在上下文中读取配置文件。</p>
<img src="http://photo.wushaopei.com/qiniu274.png" width="40%">

<p>各个实例文件的作用，如表所示：</p>
<table>
<thead>
<tr>
<th align="center">文件</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">User.java</td>
<td align="center">POJO类，符合javaBean的规范</td>
</tr>
<tr>
<td align="center">UserMapper.java</td>
<td align="center">映射器</td>
</tr>
<tr>
<td align="center">UserMapper.xml</td>
<td align="center">映射器配置文件</td>
</tr>
<tr>
<td align="center">SqlSessionFactoryUtil.java</td>
<td align="center">构建SqlSessionFactory,并创建SqlSession</td>
</tr>
<tr>
<td align="center">testMain.java</td>
<td align="center">运行MyBatis入门程序的入口，包含main方法</td>
</tr>
<tr>
<td align="center">log4j.properties</td>
<td align="center">配置log4j的属性文件</td>
</tr>
<tr>
<td align="center">mybatis-config.xml</td>
<td align="center">MyBatis的配置文件</td>
</tr>
</tbody></table>
<p>首先配置log4j 的配置文件，具体代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># Global logging configuration</span><br><span class="line">log4j.rootLogger=DEBUG, stdout</span><br><span class="line"># Console output...</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%<span class="number">5</span>p [%t] - %m%n</span><br></pre></td></tr></table></figure>

<p>其次，构建SessionFactory，这里主要配置MyBatis 的数据库连接、事务管理等等。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8<span class="symbol">&amp;amp;</span>serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/webcode/cn/mapper/UserMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最后，构建SqlSessionFactory，并且给出创建SqlSession的方法，这里我们利用配置文件 mybatis-config.xml 完成 SqlSessionFactory的构建。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Level;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SqlSessionFactoryUtil.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月7日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryUtil</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// SqlSessionFactory对象</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 类线程锁</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class CLASS_LOCK = SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 私有化构造参数 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtil</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构建SqlSessionFactory </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">initSqlSessionFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">		String resource = <span class="string">"mybatis-config.xml"</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">		&#125;<span class="keyword">catch</span> (IOException ex)&#123;</span><br><span class="line">			Logger.getLogger(SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()).<span class="title">log</span>(<span class="title">Level</span>.<span class="title">SEVERE</span>,<span class="title">null</span>,<span class="title">ex</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">synchronized</span>(CLASS_LOCK)&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 打开 SqlSession </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title">openSqlSession</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">			initSqlSessionFactory();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如生命周期中的描述一样，我们希望SqlSessionFactory 对于一个数据库而言只有一个实例，所以我们希望它是单例的。</p>
<p><strong>SqlSessionFactory 单例的实现：</strong> </p>
<p>​    主要通过方法initSqlSessionFactory实现。首先，将构造方法私有化，避免使用者通过构造器多次创建对象。然后对类SqlSessionFactoryUtil进行加锁，避免多线程环境中可能存在的多次初始化对象的问题。</p>
<p>​    给出一个公共的静态方法对外开放，让其返回唯一单例。当多线程环境下，initSqlSessionFactory方法会因为添加了线程锁而避免类对象被多次初始化。</p>
<p>定义一个POJO类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> User.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月5日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String lastName;</span><br><span class="line">	<span class="keyword">private</span> Integer sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写映射器文件，如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">  PUBLIC <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line">  <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  		namespace名称空间</span><br><span class="line">  		取值一般有两种情况：</span><br><span class="line">  			一种情况是：使用javaBean的全类名</span><br><span class="line">  			二种情况是：使用Mapper接口的全类名</span><br><span class="line">   --&gt;</span><br><span class="line"> &lt;mapper namespace=<span class="string">"com.webcode.cn.mapper.UserMapper"</span>&gt; </span><br><span class="line"> &lt;!--   &lt;mapper namespace=<span class="string">"com.webcode.cn.entity.User"</span>&gt;	--&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  	select标签用来配置一个select语句</span><br><span class="line">  		id 用来配置一个唯一的标识</span><br><span class="line">  		resultType 是查询完之后一条记录对应转换成为的javaBean对象</span><br><span class="line">  		#&#123;id&#125;是点位符</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;select id=<span class="string">"selectUserById"</span> resultType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">    	select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line">  &lt;!-- 查询全部的User对象 --&gt;</span><br><span class="line">  &lt;select id=<span class="string">"queryUsers"</span> resultType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">  		select id,last_name lastName,sex from t_user</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;!--   parameterType 参数类型（可选） --&gt;</span><br><span class="line">  &lt;insert id=<span class="string">"saveUser"</span> parameterType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">  		<span class="function">insert into <span class="title">t_user</span><span class="params">(`last_name`,`sex`)</span> <span class="title">values</span><span class="params">(#&#123;lastName&#125;,#&#123;sex&#125;)</span></span></span><br><span class="line"><span class="function">  &lt;/insert&gt;</span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">  &lt;!--   根据id删除一个用户 --&gt;</span></span><br><span class="line"><span class="function">  &lt;delete id</span>=<span class="string">"deleteUserById"</span> parameterType=<span class="string">"int"</span>&gt;</span><br><span class="line">  		delete from t_user where id = #&#123;id&#125;</span><br><span class="line">  &lt;/delete&gt;</span><br><span class="line">  </span><br><span class="line">   &lt;update id=<span class="string">"updateUser"</span> parameterType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">  		update t_user set last_name = #&#123;lastName&#125;,sex = #&#123;sex&#125; where id = #&#123;id&#125;</span><br><span class="line">  &lt;/update&gt;</span><br><span class="line">  </span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<p>这里定义了五条SQL，它们的作用有五个。</p>
<ul>
<li>根据Id查询用户</li>
<li>查询所有的用户</li>
<li>插入用户</li>
<li>删除用户</li>
<li>根据用户ID修改用户</li>
</ul>
<p>定义一个Mapper接口，接口的方法名和XML映射文件的id保持一致，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserMapper.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月5日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUsers</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">saveUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们根据提供的方法和映射器，根据映射规则使用SQL进行对User的CRUD操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.testMain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.util.SqlSessionFactoryUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> testMain.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月7日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span> <span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">			UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			User user = <span class="keyword">new</span> User();</span><br><span class="line">			user.setLastName(<span class="string">"tom"</span>);</span><br><span class="line">			user.setSex(<span class="number">1</span>);</span><br><span class="line">			userMapper.saveUser(user);</span><br><span class="line">			userMapper.deleteUserById(<span class="number">1</span>);</span><br><span class="line">			userMapper.updateUser(<span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"jetty"</span>,<span class="number">1</span>));</span><br><span class="line">			sqlSession.commit();			</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			System.err.println(ex.getMessage());</span><br><span class="line">			sqlSession.rollback();</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSession.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用Java Application的形式启动运行testMain.java,打印结果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Logging initialized using <span class="string">'class org.apache.ibatis.logging.log4j.Log4jImpl'</span> adapter.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection <span class="number">1449263511</span>.</span><br><span class="line">DEBUG [main] - Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_user</span><span class="params">(`last_name`,`sex`)</span> <span class="title">values</span><span class="params">(?,?)</span> </span></span><br><span class="line"><span class="function">DEBUG [main] - </span>==&gt; Parameters: tom(String), <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">1</span></span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: delete from t_user where id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">0</span></span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: update t_user set last_name = ?,sex = ? where id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: jetty(String), <span class="number">1</span>(Integer), <span class="number">2</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">1</span></span><br><span class="line">DEBUG [main] - Committing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - Returned connection <span class="number">1449263511</span> to pool.</span><br></pre></td></tr></table></figure>

<p>这里Log4j为我们打印出来Mybatis的运行轨迹，以及最为重要的运行的SQL和参数。我们可以根据这些信息对发生异常的情况进行分析排错。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（五）生命周期</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%94%EF%BC%89%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
    <content><![CDATA[<h2 id="声明周期"><a href="#声明周期" class="headerlink" title="声明周期"></a>声明周期</h2><p>理解我们之前讨论过的不同作用域和生命周期类别是至关重要的，因为错误的使用会导致非常严重的并发问题。 </p>
<img src="http://photo.wushaopei.com/qiniu265.png" width="80%">

<p>​         <strong>对象生命周期和依赖注入框架</strong>       </p>
<p>​         依赖注入框架可以创建线程安全的、基于事务的 SqlSession 和映射器，并将它们直接注入到你的 bean 中，因此可以直接忽略它们的生命周期。如果对如何通过依赖注入框架使用 MyBatis 感兴趣，可以研究一下 MyBatis-Spring 或 MyBatis-Guice 两个子项目。</p>
<p>​    </p>
<h3 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h3><p>​    SqlSessionFactoryBuilder 是利用XML或者Java编码获得资源来构建SqlSessionFactory的，通过它可以构建多个SqlSessionFactory。它的作用就是一个构建器，这个类可以被实例化、使用和丢弃，一旦创建了 SqlSessionFactory，就不再需要它了。</p>
<p>​    这时我门就应该毫不犹豫的<strong>废弃它，将它回收</strong>。</p>
<p> 因此 SqlSessionFactoryBuilder 实例的最佳作用域是方法作用域（也就是<strong>局部方法变量</strong>）。 你可以重用 SqlSessionFactoryBuilder 来创建多个 SqlSessionFactory 实例，但最好还是不要一直保留着它，以保证所有的 XML 解析资源可以被释放给更重要的事情。 </p>
<h3 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h3><p>​    SqlSessionFactory 的作用是创建SqlSession，而SqlSession就是一个绘画，相当于JDBC中的Connection对象。每次应用程序需要访问数据库，我们就要通过SqlSessionFactory 创建Session，所以SqlSessionFactory 一旦被创建就应该在应用的运行期间一直存在，没有任何理由丢弃它或重新创建另一个实例。 使用 SqlSessionFactory 的最佳实践是在应用运行期间不要重复创建多次，多次重建 SqlSessionFactory 被视为一种代码“坏习惯”。因此 SqlSessionFactory 的最佳作用域是应用作用域（类变量）。 有很多方法可以做到，最简单的就是使用单例模式或者静态单例模式。 </p>
<h3 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h3><p>每个线程都应该有它自己的 SqlSession 实例。SqlSession 的实例不是线程安全的，因此是不能被共享的，所以它的最佳的作用域是请求或方法作用域。 绝对不能将 SqlSession 实例的引用放在一个类的静态域，甚至一个类的实例变量也不行。 也绝不能将 SqlSession 实例的引用放在任何类型的托管作用域中，比如 Servlet 框架中的 HttpSession。 如果你现在正在使用一种 Web 框架，考虑将 SqlSession 放在一个和 HTTP 请求相似的作用域中。 换句话说，每次收到 HTTP 请求，就可以打开一个 SqlSession，返回一个响应后，就关闭它。 这个关闭操作很重要，为了确保每次都能执行关闭操作，你应该把这个关闭操作放到 finally 块中。 下面的示例就是一个确保 SqlSession 关闭的标准模式： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> (SqlSession session = sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  <span class="comment">// 你的应用逻辑代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在所有代码中都遵循这种使用模式，可以保证所有数据库资源都能被正确地关闭。 </p>
<h3 id="映射器实例-（Mapper）"><a href="#映射器实例-（Mapper）" class="headerlink" title="映射器实例 （Mapper）"></a>映射器实例 （Mapper）</h3><p>映射器（Mapper) 是一些绑定映射语句的接口。映射器接口的实例是从 SqlSession 中获得的。虽然从技术层面上来讲，任何映射器实例的最大作用域与请求它们的 SqlSession 相同。但方法作用域才是映射器实例的最合适的作用域。 也就是说，映射器实例应该在调用它们的方法中被获取，使用完毕之后即可丢弃。 映射器实例并不需要被显式地关闭。尽管在整个请求作用域保留映射器实例不会有什么问题，但是你很快会发现，在这个作用域上管理太多像 SqlSession 的资源会让你忙不过来。 因此，最好将映射器放在方法作用域内。就像下面的例子一样： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">try (SqlSession session &#x3D; sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  BlogMapper mapper &#x3D; session.getMapper(BlogMapper.class);</span><br><span class="line">  &#x2F;&#x2F; 你的应用逻辑代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>  Mapper是一个接口，而没有任何实现类，它的作用是发送SQL，然后返回我们需要的结果，或者执行SQL从而修改数据库的数据，因此它应该在一个SqlSession事务方法之内，是一个方法级别的东西。</p>
<p><strong>MyBatis组件的生命周期示意图：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu268.png" width="80%"> 



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（四）Mybatis 的基本构成-映射器</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E5%9B%9B%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E6%98%A0%E5%B0%84%E5%99%A8/</url>
    <content><![CDATA[<h2 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h2><h3 id="构成："><a href="#构成：" class="headerlink" title="构成："></a>构成：</h3><p>映射器是由Java接口和XML文件（或注解）共同组成的，它的作用如下。</p>
<ul>
<li>定义参数类型</li>
<li>描述缓存</li>
<li>描述SQL语句</li>
<li>定义查询结果和POJO的映射关系</li>
</ul>
<h3 id="两种实现方式"><a href="#两种实现方式" class="headerlink" title="两种实现方式"></a>两种实现方式</h3><ul>
<li>一种是通过XML文件方式实现；</li>
<li>另一种就是通过代码方式实现。</li>
</ul>
<p>第一种，XML配置实现的方式， 这里需要在mytais-config.xml文件中进行描述一个XML文件的具体路径，它是用来生成Mapper的。</p>
<p>而第二种通过注解实现的方式，在Configuration里面注册Mapper接口（需要添加相应的Java注解）。当然它也是MyBatis的河西内容，同时也是最为复杂的。</p>
<p>推荐： 在项目开发中，比较推荐使用XML文件配置方式。</p>
<p>原因：</p>
<ul>
<li>Java 注解方式受限较大，功能相对少，而Mapper中内容比较多，功能相对强大一些，使用上也比较灵活。</li>
<li>Mapper中适合编写复杂，条件较多的SQL，并且有助于进行动态SQL的使用，提高可读性和代码的复用率，降低维护和编码成本</li>
</ul>
<h4 id="XML-文件配置方式实现Mapper"><a href="#XML-文件配置方式实现Mapper" class="headerlink" title="XML 文件配置方式实现Mapper"></a>XML 文件配置方式实现Mapper</h4><p>使用XML文件配置是Mybatis实现Mapper的首选方式。其构成主要包括一个Java接口和一个XML文件构成。</p>
<p>第一步：给出Java 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.mapper;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserMapper.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月5日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们定义了一个接口，它由一个方法selectUserById,通过用户ID 找到用户对象</p>
<p>第二部，给出一个映射XML文件</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">  PUBLIC <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line">  <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  		namespace名称空间</span><br><span class="line">  		取值一般有两种情况：</span><br><span class="line">  			一种情况是：使用javaBean的全类名</span><br><span class="line">  			二种情况是：使用Mapper接口的全类名</span><br><span class="line">   --&gt;</span><br><span class="line">&lt;!-- &lt;mapper namespace=<span class="string">"com.webcode.cn.mapper.UserMapper"</span>&gt; --&gt;</span><br><span class="line">	&lt;mapper namespace=<span class="string">"com.webcode.cn.entity.User"</span>&gt;	</span><br><span class="line">  &lt;!-- </span><br><span class="line">  	select标签用来配置一个select语句</span><br><span class="line">  		id 用来配置一个唯一的标识</span><br><span class="line">  		resultType 是查询完之后一条记录对应转换成为的javaBean对象</span><br><span class="line">  		#&#123;id&#125;是点位符</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;select id=<span class="string">"selectUserById"</span> resultType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">    	select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<p>关于XML文件：</p>
<ul>
<li>针对该XML文件，需要现在Mybatis的配置文件 mybatis-config.xml中进行配置，这样MyBatis会读取这个配置文件，生成映射器。</li>
<li>定义了一个命名空间为com.webcode.cn.entity.User的SQL Mapper，这个名称空间必须和我们定义的接口权限定名一致</li>
<li>其中的Select方法定义了一个查询SQL，id为selectUserById，与前面的接口方法一致对应。resultType 定义了我们需要返回的数据类型，这里为User，该User是之前定义好的JavaBean实体类。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String lastName;</span><br><span class="line">	<span class="keyword">private</span> Integer sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的SQL是：</p>
<p><code>select id,last_name lastName,sex from t_user where id = #{id}</code></p>
<p><code>#{id}</code> 为这条SQL的参数。而SQL列的列名和POJO的属性名称保持一致。那么MyBatis就会把这条语句查询的结果自动映射到我们需要的POJO属性上，这就是自动映射。我们可以用SqlSession来获取这个Mapper,代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//			selectOne方法用来执行select查询语句，并返回一个对象</span></span><br><span class="line">			<span class="comment">// 获取映射器Mapper</span></span><br><span class="line">			UserMapper userMapper = openSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;			</span><br><span class="line">			User user = userMapper.selectUserById(<span class="number">1</span>);</span><br><span class="line">			System.out.println( user );</span><br></pre></td></tr></table></figure>

<p>这样就完成了MyBatis的一次完整查询。</p>
<h4 id="Java注解方式实现Mapper"><a href="#Java注解方式实现Mapper" class="headerlink" title="Java注解方式实现Mapper"></a>Java注解方式实现Mapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="meta">@Select</span>(value=<span class="string">"select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span></span><br><span class="line"><span class="string">"</span>)  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这里使用@Select注解，注入了和XML一样的select元素，这样MyBatis就会读取这条SQL，并将参数传递进SQL。然后进行自动映射操作，从而得到我们需要的User对象。</p>
<p>注意： 这种方式虽然相对简单，但是在使用多表关联、查询、级联等情况下会使SQL显得很复杂，不利于阅读和维护。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select u.id as userid,u.username,r.id as roleid,r.role_name </span><br><span class="line">from user u left join user_role ur on u.id &#x3D; ur.user_id </span><br><span class="line">left join role r on ur.role_id &#x3D; r.id</span><br><span class="line">where 1&#x3D;1</span><br><span class="line">and u.username like concat(&#39;%&#39;,#&#123;username&#125;,&#39;%&#39;)</span><br><span class="line">and r.role_name like concat(&#39;%&#39;,#&#123;roleNme&#125;,&#39;%&#39;)</span><br></pre></td></tr></table></figure>

<p>如果还需要在以上的SQL中进行 动态SQL的特性判断功能，那么整条SQL就会显得很复杂和难以阅读（if、trim、foreach等）。</p>
<h3 id="重点：映射原理"><a href="#重点：映射原理" class="headerlink" title="重点：映射原理"></a><strong>重点</strong>：映射原理</h3><p><strong>提问</strong>： Java接口不是实现类，一个没有实现类的接口是怎么运行的？</p>
<p><strong>答案</strong>： 这里运用到了Java语言的动态代理机制。</p>
<p>​    <font color=red>我们会在MyBatis上下文中描述这个接口，而MyBatis会为这个接口生成代理类对象，代理对象会根据 ” 接口全路径 + 方法名“ 去匹配，找到对应的XML文件（或注解）去完成它所需要的任务，返回我们需要的结果。</font></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（三）Mybatis 的基本构成-创建SqlSession</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%89%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E5%88%9B%E5%BB%BASqlSession/</url>
    <content><![CDATA[<h2 id="创建SqlSession"><a href="#创建SqlSession" class="headerlink" title="创建SqlSession"></a>创建SqlSession</h2><p>SqlSession是一个接口类，它类似于你们公司前台的美女客服，它扮演着门面的作用，而真正干活的是Executor接口，你可以认为它是公司的工程师。假设我是客户找你们公司干活，我只需要告诉前台的美女客服（SqlSession）我要什么信息（参数），要做什么东西，过段时间，她会将结果给我。在这个过程中，作为用户的我所关心的是：</p>
<p>​    （1）要给美女客服（SqlSession)什么信息（功能和参数）</p>
<p>​    （2）美女客服会返回什么结果（Result)</p>
<p>​    而我并不关心工程师（Executor）是怎么为我工作的，只要前台告诉工程师（Executor)工程师就知道如何为我工作，这个步骤对我而言是个黑箱操作。</p>
<p>​    在MyBatis中，SqlSession的具体实现类有两个，分别是DefaultSqlSession和SqlSessionManager。当我们构建好SqlSessionFactory，然后生成SqlSession。</p>
<p>​    注意一点： 前面提到过，SqlSession接口类似于一个JDBC中的Connection接口对象，我们需要保证每次用完正常关闭它，所以正确的做法是每次都把关闭SqlSession接口的代码写在finally语句中从而保证SqlSession的关闭，从而将连接资源进行释放，交还给数据库。<code>数据库的资源是有限的，频繁的建立连接而不进行释放资源，会因为最终资源匮乏而导致系统的瘫痪，从而引发更大的问题。</code></p>
<p>​    </p>
<img src="http://photo.wushaopei.com/qiniu267.png" width="80%">

<h3 id="SqlSession-代码示例"><a href="#SqlSession-代码示例" class="headerlink" title="SqlSession 代码示例"></a>SqlSession 代码示例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">		<span class="comment">// 定义 SqlSession</span></span><br><span class="line">		SqlSession sqlsession = <span class="keyword">null</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;			</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 定义SqlSession</span></span><br><span class="line">			sqlsession = sqlSessionFactory.openSession();</span><br><span class="line"><span class="comment">//			selectOne方法用来执行select查询语句，并返回一个对象</span></span><br><span class="line">			<span class="comment">// some code ...</span></span><br><span class="line">			User user = sqlsession.selectOne(<span class="string">"com.webcode.cn.entity.User.selectUserById"</span>, <span class="number">1</span>);</span><br><span class="line">			System.out.println( user );</span><br><span class="line">			sqlsession.commit();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			sqlsession.rollback();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 在finally 语句中确保资源被顺利关闭</span></span><br><span class="line">			sqlsession.close();<span class="comment">//释放资源</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这样SqlSession就被我们创建出来了，在finally语句中我们保证了它的合理关闭，让连接资源归还给数据库连接池，以便后续使用。</p>
<h3 id="SqlSession的用途："><a href="#SqlSession的用途：" class="headerlink" title="SqlSession的用途："></a>SqlSession的用途：</h3><p>（1）获取映射器，让映射器通过命名空间和方法名称找到对应的SQL，发送给数据库执行后返回结果。 这里主要是配置 namespace 为  <code>*Mapper</code> （如 UserMapper ）的时候。</p>
<p>（2）直接通过命名信息去执行SQL返回结果，这是iBatis版本留下的方式。在SqlSession层我们可以通过update、insert、select、delete等方法，带上SQL的id来操作在XML中配置好的SQL，从而完成我们的工作；与此同时它也支持事务，通过commit、rollback方法提交或者回滚事务。这里主要是配置 namespace 为 JavaBean时使用。</p>
<p><strong>声明：</strong>后面会针对这两种用途进行分析比较。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（二）Mybatis 的基本构成-构建SqlSessionFactory</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%8C%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E6%9E%84%E5%BB%BASqlSessionFactory/</url>
    <content><![CDATA[<h1 id="MyBatis-的基本构成"><a href="#MyBatis-的基本构成" class="headerlink" title="MyBatis 的基本构成"></a>MyBatis 的基本构成</h1><p>认识MyBatis，从它的表面想象，即基本构成进行了解。</p>
<h2 id="关于MyBatis的核心组件："><a href="#关于MyBatis的核心组件：" class="headerlink" title="关于MyBatis的核心组件："></a>关于MyBatis的核心组件：</h2><p><strong>SqlSessionFactoryBuilder(构造器)：</strong> 它会根据配置信息或者代码来生成SqlSessionfactory（工厂接口）。</p>
<p><strong>SqlSessionFactory：</strong> 依靠工厂来生成SqlSession(会话)。</p>
<p><strong>SqlSession：</strong> 是一个既可以发送SQL去执行并返回结果，也可以获取Mapper的接口。</p>
<p>*<em>SQL Mapper： *</em> 它是MyBatis新设计的组件，它是由一个Java接口和XML文件（或注解）构成的，需要给出对应的SQL和映射规则。它负责发送SQL去执行，并返回结果。</p>
<img src="http://photo.wushaopei.com/qiniu265.png" width="80%">

<p>上图是MyBatis核心构建之间的关联图。</p>
<h2 id="构建SqlSessionFactory"><a href="#构建SqlSessionFactory" class="headerlink" title="构建SqlSessionFactory"></a>构建SqlSessionFactory</h2><h3 id="概述介绍"><a href="#概述介绍" class="headerlink" title="概述介绍"></a>概述介绍</h3><p>每个MyBatis 的应用都是以SqlSessionFactoy 的实例为中心的。通过SqlSessionFactoryBuilder可以获得SqlSessionFactory。</p>
<img src="http://photo.wushaopei.com/qiniu266.png" width="80%">

<p>必须注意的一点是，SqlSessionFactory是一个工厂接口二不是现实类，它的任务是创建SqlSession.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an &#123;<span class="doctag">@link</span> SqlSession&#125; out of a connection or a DataSource *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlSessionFactory</span> </span>&#123;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(<span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(Connection connection)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(TransactionIsolationLevel level)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType, <span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType, Connection connection)</span></span>;</span><br><span class="line">  <span class="function">Configuration <span class="title">getConfiguration</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=red>SqlSession类似是一个JDBC的Connection对象呢。</font></p>
<p>MyBatis提供 了<strong>两种模式去创建SqlSessionFactory</strong>：</p>
<pre><code>*  一种是XML配置的方式，这是笔者推荐的方式；

*  另一种是代码实现的方式。</code></pre><p>能够使用配置文件的时候，我们要尽量使用配置文件。</p>
<p>有<strong>以下两点好处：</strong></p>
<ul>
<li>避免硬编码；</li>
<li>方便后期配置人员进行修改、维护，避免重复编译代码</li>
</ul>
<h3 id="SqlSessionFactory的两个实现类"><a href="#SqlSessionFactory的两个实现类" class="headerlink" title="SqlSessionFactory的两个实现类"></a>SqlSessionFactory的两个实现类</h3><p>MyBatis中提供了两个SqlSessionFactory的实现类，DefaultSqlSession 和 SqlSessionManager。目前使用的是DefaultSqlSessionFactory.</p>
<p><strong>主要关系图如下：</strong></p>
<img src="http://photo.wushaopei.com/qiniu267.png" width="80%">



<h3 id="Configuration-类"><a href="#Configuration-类" class="headerlink" title="Configuration 类"></a>Configuration 类</h3><p>Configuration类全限定名为org.apache.ibatis.session.Configuration，它在MyBatis中将以一个Configuration类对象的形式存在，而 <code>这个对象将存在于整个MyBatis应用的生命期中</code>，以便重复读取和使用。</p>
<p><strong>注意：</strong> ①我们解析配置的XML文件都保存在Configuration类对象中；</p>
<p>​        ②Configuration类对象存在于内存中</p>
<h2 id="SqlSessionFactory的两种实现方式"><a href="#SqlSessionFactory的两种实现方式" class="headerlink" title="SqlSessionFactory的两种实现方式"></a>SqlSessionFactory的两种实现方式</h2><h3 id="使用XML方式构建"><a href="#使用XML方式构建" class="headerlink" title="使用XML方式构建"></a>使用XML方式构建</h3><p>这里我们配置一个建议的XML，包含获取数据库连接实例的数据源（DataSource)、决定事务范围和控制方式的事务管理器（TransactionManager)和映射器（SQL  Mapper)。XML配置文件的内容后面会详细探讨，这里先给出一个简单的示例：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">  PUBLIC <span class="string">"-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="line">  <span class="string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;environments <span class="keyword">default</span>=<span class="string">"development"</span>&gt;</span><br><span class="line">    &lt;environment id=<span class="string">"development"</span>&gt;</span><br><span class="line">      &lt;transactionManager type=<span class="string">"JDBC"</span>/&gt;</span><br><span class="line">      &lt;dataSource type=<span class="string">"POOLED"</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">"driver"</span> value=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;amp;serverTimezone=UTC"</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">"username"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">      &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">  &lt;/environments&gt;</span><br><span class="line">  &lt;mappers&gt;</span><br><span class="line">    &lt;mapper resource=<span class="string">"com/webcode/cn/mapper/UserMapper.xml"</span>/&gt;</span><br><span class="line">  &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>对上面的配置做一下说明：</p>
<p>这里配置了一个别名user，它代表com.webcode.cn.entity.User,这样我们就可以在MyBatis上下文中引用它了。</p>
<ul>
<li>我们配置了环境内容，它默认使用<strong>id</strong>是development的环境配置，包含以下两方面的内容：</li>
</ul>
<p>（1）采用JDBC的事务管理模式</p>
<p>（2）数据库的连接信息</p>
<ul>
<li>配置映射器</li>
</ul>
<p>这里在创建SqlSessionFactory时引入了一个XML，它的作用是提供SQL和SQL对POJO的映射规则定义，它包含了映射器里面的信息。MyBatis将解析这个XML，来为我们生成映射器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取指定的资源</span></span><br><span class="line">InputStream is = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line"><span class="comment">// 通过sqlSessionFactoryBuilder创建SqlSessionFactory</span></span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</span><br></pre></td></tr></table></figure>

<p>这里我们创建了一个XML文件输入流，用SqlSessionFactoryBuilder读取XML的信息来创建SqlSessionFactory的对象。</p>
<p>MyBatis的解析程序会将 mybatis-config.xml文件配置的信息解析到Configuration类对象里面，然后利用SqlSessionFactoryBuilder读取这个对象为我们创建SqlSessionFactory</p>
<p><code>详见代码： TestSqlSessionFactory.java</code></p>
<h3 id="使用代码方式构建"><a href="#使用代码方式构建" class="headerlink" title="使用代码方式构建"></a>使用代码方式构建</h3><p>前面说过，除了使用XML配置的方式创建代码外，也可以使用Java编码来实现，不过并不推荐这个方式，因为修改环境的时候，我们不得不重新编译代码，这样不利于维护。</p>
<p>​    不过，在这里我们为了比较两者的区别与实用性，会对该构建方式进行一个示例实现与分析。</p>
<p>与XML配置构建方式相同的地方在于，MyBatis依旧为我们提供好要使用的对象的类和方法，我们只需要在合适的地方对它进行调用即可。</p>
<p>​    首先，需要构建Configuration类对象。然后，往对象里面注册我们构建SqlSessionFactory所需要的信息即可。</p>
<p>​    具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取指定的资源</span></span><br><span class="line">		PooledDataSource dataSource = <span class="keyword">new</span> PooledDataSource();</span><br><span class="line">		dataSource.setDriver(<span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">		dataSource.setUrl(<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;serverTimezone=UTC"</span>);</span><br><span class="line">		dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">		dataSource.setPassword(<span class="string">"root"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//创建数据库事务方式</span></span><br><span class="line">		TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">		<span class="comment">// 创建数据库运行环境</span></span><br><span class="line">		Environment environment = <span class="keyword">new</span> Environment(<span class="string">"development"</span>, transactionFactory, dataSource);</span><br><span class="line">		<span class="comment">// 构建Configuration对象</span></span><br><span class="line">		Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line">		<span class="comment">// 加入一个映射器</span></span><br><span class="line">		configuration.addMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br><span class="line">		System.out.println( sqlSessionFactory );</span><br><span class="line">		<span class="comment">// 相当于 以前的Connection对象，每次用来都用关闭</span></span><br><span class="line">		SqlSession openSession = sqlSessionFactory.openSession();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//			selectOne方法用来执行select查询语句，并返回一个对象</span></span><br><span class="line">			<span class="comment">// 放名称空间+id</span></span><br><span class="line">			UserMapper userMapper = openSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;				<span class="comment">// </span></span><br><span class="line">			User user = userMapper.selectUserById(<span class="number">1</span>);</span><br><span class="line">			System.out.println( user );</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			openSession.close();<span class="comment">//释放资源</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>具体分析一下上述代码都做了些什么：</p>
<ul>
<li>初始化了一个数据库连接池</li>
<li>定义了JDBC的数据库事务管理方式</li>
<li>用数据库连接池和事务管理方式创建了一个数据库运行环境，并命名为 development</li>
<li>创建了一个Configuration类对象，并把数据库运行环境注册给它</li>
<li>注册了一个user的别名</li>
<li>加入一个映射器</li>
<li>用SqlSessionFactoryBuilder通过Configuration 对象创建SqlSessionFactory</li>
</ul>
<p>由以上分析可以看出，用代码方式实现和用XML方式只是换了个方法实现而已，其本质并无不同。其中采用代码方式一般是在需要加入自己特性的时候才会用到。</p>
<p>这里唯一需要注意的一点是，通过XML配置实现和代码实现的映射器是不同的，前者使用的是JavaBean，而后者使用UserMapper.java 。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十一）线程安全策略-线程封闭</title>
    <url>/2020/04/03/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E7%BA%BF%E7%A8%8B%E5%B0%81%E9%97%AD/</url>
    <content><![CDATA[<h2 id="线程封闭"><a href="#线程封闭" class="headerlink" title="线程封闭"></a>线程封闭</h2><p><strong>目的：</strong><code>避免并发，除了设置不可变对象，还有线程封闭。</code></p>
<h3 id="什么是线程封闭"><a href="#什么是线程封闭" class="headerlink" title="什么是线程封闭"></a>什么是线程封闭</h3><p><strong>所谓线程封闭</strong>，就是把对象锁定到一个线程里，只有这个线程可以看到对象，那么，这个对象就算不是线程安全的，也不会出现线程安全的问题了。因为它只能在一个线程内访问。 </p>
<h3 id="线程封闭共有三种："><a href="#线程封闭共有三种：" class="headerlink" title="线程封闭共有三种："></a>线程封闭共有三种：</h3><h4 id="第一种线程封闭："><a href="#第一种线程封闭：" class="headerlink" title="第一种线程封闭："></a><strong>第一种线程封闭：</strong></h4><blockquote>
<p> <strong>Ad-hoc 线程封闭 ： 程序控制实现，最糟糕，忽略</strong> </p>
</blockquote>
<h4 id="第二种线程封闭："><a href="#第二种线程封闭：" class="headerlink" title="第二种线程封闭："></a><strong>第二种线程封闭：</strong></h4><blockquote>
<p>  <strong>堆栈封闭：局部变量，无并发问题</strong></p>
</blockquote>
<p>多个线程访问一个方法的时候，局部变量都会被拷贝一份到线程的栈中，所以<strong>局部变量</strong>是不会被多个线程所共享的，因此也就不会出现并发问题。</p>
<p><strong>全局的变量</strong>容易出现并发问题。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在一个方法内定义局部变量来完成各种操作，就是属于堆栈封闭的范畴。</span><br></pre></td></tr></table></figure>

<h4 id="第三种线程封闭："><a href="#第三种线程封闭：" class="headerlink" title="第三种线程封闭："></a><strong>第三种线程封闭：</strong></h4><p> <strong>ThreadLocal</strong>线程封闭：特别好的封闭方法</p>
<p><strong>原因：</strong></p>
<blockquote>
<p> <strong>ThreadLocal</strong>内部维护了一个<strong>map</strong>，<strong>map</strong>的<strong>key</strong>是每一个线程的名称，而<strong>map</strong>的值就是我们要封闭的对象，每个<strong>map</strong>中的对象都对应了一个线程中的值，也就是<strong>ThreadLocal</strong>利用<strong>map</strong>实现了线程封闭。 </p>
</blockquote>
<h3 id="ThreadLocal线程封闭——代码演示："><a href="#ThreadLocal线程封闭——代码演示：" class="headerlink" title="ThreadLocal线程封闭——代码演示："></a>ThreadLocal线程封闭——代码演示：</h3><h4 id="RequestHolder"><a href="#RequestHolder" class="headerlink" title="RequestHolder"></a>RequestHolder</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.threadLocal;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> RequestHolder</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 11:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestHolder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; requestHolder = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//在接口未实际处理之前，在filter中将值添加到ThreadLocal中，等到url被调用处理时，再从ThreadLocal中取出相应的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        requestHolder.set(id);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">getId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> requestHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//在接口真正处理完之后进行处理</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>&#123;</span><br><span class="line">        requestHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Fitler-："><a href="#Fitler-：" class="headerlink" title="Fitler ："></a><strong>Fitler ：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.example.threadLocal.RequestHolder;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> HttpFilter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 11:18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">        RequestHolder.add(Thread.currentThread().getId());</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="HttpFilter-java"><a href="#HttpFilter-java" class="headerlink" title="HttpFilter.java"></a>HttpFilter.java</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">    log.info(<span class="string">"do filter,&#123;&#125; - &#123;&#125;"</span>,Thread.currentThread().getId(),request.getServletPath());</span><br><span class="line">    RequestHolder.add(Thread.currentThread().getId());</span><br><span class="line">    filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置Filter-将HttpFilter添加到容器"><a href="#配置Filter-将HttpFilter添加到容器" class="headerlink" title="配置Filter,将HttpFilter添加到容器"></a>配置Filter,将HttpFilter添加到容器</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencyApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(ConcurrencyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">httpFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">      FilterRegistrationBean&lt;Filter&gt; registrationBean = <span class="keyword">new</span> FilterRegistrationBean&lt;&gt;();</span><br><span class="line">      registrationBean.setFilter(<span class="keyword">new</span> HttpFilter());</span><br><span class="line">      registrationBean.addUrlPatterns(<span class="string">"/threadLocal/*"</span>);</span><br><span class="line">      <span class="keyword">return</span> registrationBean;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Handler适配器实现接口实现前后的拦截、过滤操作："><a href="#Handler适配器实现接口实现前后的拦截、过滤操作：" class="headerlink" title="Handler适配器实现接口实现前后的拦截、过滤操作："></a><strong>Handler适配器实现接口实现前后的拦截、过滤操作：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.example.threadLocal.RequestHolder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> HttpInterceptor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 11:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"preHandle"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//接口执行完成后删除ThreadLocal线程变量</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RequestHolder.remove();</span><br><span class="line">        log.info(<span class="string">"afterCompletion"</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在启动器中将HttpInterceptor-的Bean配置到容器中："><a href="#在启动器中将HttpInterceptor-的Bean配置到容器中：" class="headerlink" title="在启动器中将HttpInterceptor 的Bean配置到容器中："></a>在启动器中将HttpInterceptor 的Bean配置到容器中：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencyApplication</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span></span>&#123;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">   registry.addInterceptor(<span class="keyword">new</span> HttpInterceptor()).addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">创建ThreadLocal测试接口：</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/threadLocal"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RequestHolder.getId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>启动并执行测试接口：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.757</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] o.s.web.servlet.DispatcherServlet        : Initializing Servlet <span class="string">'dispatcherServlet'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.763</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] o.s.web.servlet.DispatcherServlet        : Completed initialization in <span class="number">6</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.769</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] com.mmall.concurrency.HttpFilter         : <span class="keyword">do</span> filter,<span class="number">30</span> , /threadLocal/test</span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.779</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] com.mmall.concurrency.HttpInterceptor    : preHandle</span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.852</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] com.mmall.concurrency.HttpInterceptor    : afterCompletio</span><br></pre></td></tr></table></figure>

<p>由执行结果可知，使用<strong>ThreadLocal</strong>实现了线程封闭，以为着<strong>ThreadLocal</strong>是线程安全的。 </p>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><h4 id="实现流程："><a href="#实现流程：" class="headerlink" title="实现流程："></a><strong>实现流程：</strong></h4><blockquote>
<p>当请求进来的时候，通过Filter将线程ID存储到了ThreadLocal里面，当接口被处理调用的时候，就可以从ThreadLocal里去取出线程ID，当接口处理完后，再通过HttpInterception适配器中的afterCompletion方法将线程ID给移除掉。 </p>
</blockquote>
<h4 id="分析：-1"><a href="#分析：-1" class="headerlink" title="分析："></a><strong>分析：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">这里在使用ThreadLocal的时候，定义了三个方法，分别是从ThreaadLocal里面放数据、移除数据、获取数据，放数据一般是通过Filter来放数据，先拦截住接口，在拦截器里面把数据放进去，数据处理完之后在Interceptor里面将数据移除出去，避免内存泄露。</span><br></pre></td></tr></table></figure>

<h4 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a><strong>扩展：</strong></h4><p><strong>线程封闭技术的常见应用：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">数据库连接对应JDBC的Connection对象，Connection对象在实现时并没有对线程安全做太多的处理，在相应的JDBC规范里也没有要求Connection对象一定是线程安全的，实际上在服务器应用程序中线程从连接池获取了一个Connection对象，使用完之后再将对象返回给连接池，由于大多数请求都是采用单线程同步的方式处理的，在Connection对象返回之前，连接池不会将它分配给其他线程，因此这种管理模式在请求时隐含的将对象封闭在线程里面。我们使用Connnection对象虽然本身不是线程安全的，但是通过线程封闭也做到了线程安全。</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>synchronized</tag>
        <tag>不可变对象</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十）线程安全策略-不可变对象</title>
    <url>/2020/04/03/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1/</url>
    <content><![CDATA[<h2 id="不可变对象"><a href="#不可变对象" class="headerlink" title="不可变对象"></a>不可变对象</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">有一种安全的发布对象，即不可变对象。</span><br></pre></td></tr></table></figure>

<h3 id="不可变对象的存在条件"><a href="#不可变对象的存在条件" class="headerlink" title="不可变对象的存在条件"></a>不可变对象的存在条件</h3><blockquote>
<p> ① 对象创建以后其状态就不能修改</p>
<p> ② 对象所有域都是final类型</p>
<p> ③ 对象是正确创建的（在对象创建期间，this引用没有逸出）</p>
</blockquote>
<h3 id="关键字-final"><a href="#关键字-final" class="headerlink" title="关键字 - final"></a>关键字 - final</h3><h4 id="final-的作用"><a href="#final-的作用" class="headerlink" title="final 的作用"></a>final 的作用</h4><blockquote>
<p><strong>final</strong> 关键字可以用来修饰：<strong>类、方法、变量</strong> </p>
</blockquote>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">修饰类：不能被继承，final类中的成员方法都会被隐式的指定为final方法</span><br><span class="line"></span><br><span class="line">修饰方法：1、锁定方法不被继承类修改；2、效率</span><br><span class="line"></span><br><span class="line">	 注意：一个类的private方法会被隐式的指定为final方法</span><br><span class="line"></span><br><span class="line">修饰变量：基本数据类型变量、引用类型变量</span><br></pre></td></tr></table></figure>

<p><strong>被final修饰的数值不能再被修改；被final修饰的引用类型不能再指向另一个对象。</strong></p>
<p>重点：fianl修饰数据类型变量和引用类型变量的区别</p>
<h4 id="fianl的使用代码演示："><a href="#fianl的使用代码演示：" class="headerlink" title="fianl的使用代码演示："></a>fianl的使用代码演示：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">immutableExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String b = <span class="string">"2"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = Maps.newHashMap();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">        map.put(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">        map.put(<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        a = 2;</span></span><br><span class="line"><span class="comment">//        b = "3";</span></span><br><span class="line"><span class="comment">//        map = Maps.newHashMap();</span></span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,map.get(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> a )</span></span>&#123;</span><br><span class="line"><span class="comment">//        a = 1;</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">13</span>:<span class="number">54.256</span> [main] INFO com.mmall.concurrency.example.immutable.immutableExample1 - <span class="number">3</span></span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu265.png" width="80%">

<p><strong>分析：</strong>由图中可知，被final修饰的变量无法被重新赋值，被final修饰的map引用类型变量也不能指向新的内存引用。 </p>
<p>又由代码执行结果可知，被final修饰的引用数据类型如map的值是可以改变的。 </p>
<h3 id="常见不可变对象"><a href="#常见不可变对象" class="headerlink" title="常见不可变对象"></a>常见不可变对象</h3><pre><code>&gt;      **Collections.unmodifiableXXX : Collection 、List、Set、Map ..,**
&gt;
&gt;       **Guava : ImmutableXXX : Collection 、List、Set、Map....**</code></pre><p><strong>注意：</strong> </p>
<blockquote>
<p>使用Collections的unmodifiableXXX生成的引用变量就不能再被修改了；</p>
<p>使用Guava的ImmutableXXX生成的引用变量就不能再被修改了；</p>
</blockquote>
<h4 id="Collections-unmodifiableXXX"><a href="#Collections-unmodifiableXXX" class="headerlink" title="Collections.unmodifiableXXX :"></a><strong>Collections.unmodifiableXXX :</strong></h4><h5 id="代码演示："><a href="#代码演示：" class="headerlink" title="代码演示："></a><strong>代码演示：</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">immutableExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = Maps.newHashMap();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">        map.put(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">        map.put(<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line">        map = Collections.unmodifiableMap(map);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,map.get(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsupportedOperationException</span><br><span class="line">	at java.util.Collections$UnmodifiableMap.put(Collections.java:<span class="number">1457</span>)</span><br><span class="line">	at com.mmall.concurrency.example.immutable.immutableExample2.main(immutableExample2.java:<span class="number">31</span>)</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>由执行结果可知，被Collections.unmodifiableMap()修改过的map不能再被重新赋值，虽然声明时没有报错，但是编译运行时却抛出了异常。 </p>
<h5 id="从源码对原因进行分析："><a href="#从源码对原因进行分析：" class="headerlink" title="从源码对原因进行分析："></a>从源码对原因进行分析：</h5><p><strong>unmodifiableMap</strong>调用了<strong>UnmodifiableMap</strong>方法； </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; <span class="function">Map&lt;K,V&gt; <span class="title">unmodifiableMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UnmodifiableMap&lt;&gt;(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<strong>UnmodifiableMap</strong>方法中，进行了序列化已经使用final对传入参数m进行修饰： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1034234728574286014L</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;? extends K, ? extends V&gt; m;</span><br></pre></td></tr></table></figure>

<p>相当于將原本的map使用另一个map进行替代，并将所有的更新方法在操作时进行异常的抛出，相关源码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceAll</span><span class="params">(BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; function)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line">.............</span><br></pre></td></tr></table></figure>

<p>当第一次声明值时，会对引用变量的长度和数据进行副本备份，如果有第二次修改时，会进行校验，发现传入参数和底层取出的值不同时，抛出异常。 </p>
<h4 id="ImmutableXXX代码演示："><a href="#ImmutableXXX代码演示：" class="headerlink" title="ImmutableXXX代码演示："></a>ImmutableXXX代码演示：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">immutableExample3</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableList list = ImmutableList.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableSet set = ImmutableSet.copyOf(list);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableMap&lt;Integer,Integer&gt; map = ImmutableMap.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableMap&lt;Integer,Integer&gt; map2 = ImmutableMap.&lt;Integer,Integer&gt;builder().put(<span class="number">1</span>,<span class="number">2</span>).put(<span class="number">3</span>,<span class="number">4</span>).put(<span class="number">5</span>,<span class="number">6</span>).build();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        list.add(4);</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//        map.put(1,4);</span></span><br><span class="line">        System.out.println(map.get(<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ImmutableList</strong> 重新赋值测试结果： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsupportedOperationException</span><br><span class="line">	at com.google.common.collect.ImmutableCollection.add(ImmutableCollection.java:<span class="number">221</span>)</span><br><span class="line">	at com.mmall.concurrency.example.immutable.immutableExample3.main(immutableExample3.java:<span class="number">33</span>)</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>ImmutableMap</strong>重新赋值测试结果： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsupportedOperationException</span><br><span class="line">	at com.google.common.collect.ImmutableMap.put(ImmutableMap.java:<span class="number">495</span>)</span><br><span class="line">	at com.mmall.concurrency.example.immutable.immutableExample3.main(immutableExample3.java:<span class="number">35</span>)</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>查询<strong>ImmutableMap</strong>的value值： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，<strong>ImmutableXXX</strong>声明的对象为不可变对象，是线程安全的，同时不影响值的获取。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>synchronized</tag>
        <tag>不可变对象</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（九）线程安全性-有序性与总结</title>
    <url>/2020/04/03/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B9%9D%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E6%9C%89%E5%BA%8F%E6%80%A7%E4%B8%8E%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><p>​    <strong>定义：</strong> Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性； </p>
<p>​    <strong>实现方式</strong>： volatile 、synchronized、Lock </p>
<h3 id="有序性-happens-before原则"><a href="#有序性-happens-before原则" class="headerlink" title="有序性 - happens - before原则"></a>有序性 - happens - before原则</h3><blockquote>
<p><strong>程序次序规则</strong>：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作</p>
<p><strong>锁定规则</strong>： 一个unlOCK操作先行发生于后面对同一个锁的lock操作</p>
<p><strong>volatile变量规则：</strong> 对一个变量的写操作先行发生于后面对这个变量的读操作</p>
<p><strong>传递规则</strong>：如果操作A线性发生于操作B，而操作B又先行发生于操作C，则可以得出操作A先行发生于操作C</p>
<p><strong>线程启动规则：</strong> Thread对象的start()方法先行于发生于此线程的每一个动作</p>
<p><strong>线程中断规则：</strong>对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生</p>
<p><strong>线程终结规则</strong>：线程中所有的操作都先行发生于线程的终止检测，我们可以通过Thread.join()方法    结束 、 Thread.isAlive()的返回值手段检测到线程已经终止执行</p>
<p><strong>对象终结规则：</strong>一个对象的初始化完成先行发生于它的finalize()方法的开始</p>
</blockquote>
<h3 id="小结-："><a href="#小结-：" class="headerlink" title="小结 ："></a>小结 ：</h3><blockquote>
<p> <strong>原子性 ：</strong> Atomic包、CAS算法、synchronized、Lock</p>
<p> <strong>可见性</strong>：synchronized 、volatile</p>
<p> <strong>有序性：</strong>happens-before</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>内存可见性</tag>
        <tag>synchronized</tag>
        <tag>有序性</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（一）开发环境准备</title>
    <url>/2020/04/01/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/</url>
    <content><![CDATA[<h2 id="开发环境准备"><a href="#开发环境准备" class="headerlink" title="开发环境准备"></a>开发环境准备</h2><h3 id="下载MyBatis"><a href="#下载MyBatis" class="headerlink" title="下载MyBatis"></a>下载MyBatis</h3><p>最简单的方式是直接访问 MyBatis 托管在Github的官网，从上面下载MyBatis，地址如下：</p>
<p><code>https://github.com/mybatis/mybatis-3/releases</code></p>
<p>该官网可以下载到配置启动MyBatis所需要的Jar包和源码包</p>
<p>使用Mybatis项目可以参考 <a href="https://mybatis.org/mybatis-3/zh/index.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/index.html</a></p>
<img src="http://photo.wushaopei.com/qiniu261.png" width="60%">

<p>使用Mybatis-Spring项目可以参考<a href="http://mybatis.org/spring/zh/index.html" target="_blank" rel="noopener">http://mybatis.org/spring/zh/index.html</a></p>
<img src="http://photo.wushaopei.com/qiniu262.png" width="60%">

<h3 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h3><img src="http://photo.wushaopei.com/qiniu263.png" width="60%">

<p>上图中是MyBatis开发环境所要配置的一些jar包。</p>
<p>​    这里的jar文件分为两类，mybatis打头的jar包是MyBatis本身需要的jar包，另一类如log大头的是在lib文件夹里的。</p>
<p>​    在开发MyBatis项目的过程中只需要在Eclipse项目的lib目录中引入MyBatis的jar即可。如下图：</p>
<img src="http://photo.wushaopei.com/qiniu264.png" width="60%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
        <category>知识树</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（五）什么时候用MyBatis</title>
    <url>/2020/04/01/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%94%EF%BC%89%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8MyBatis/</url>
    <content><![CDATA[<p>​    通过前面对JDBC、Hibernate和MyBatis的介绍，我们有了一些认识。</p>
<p>​    JDBC的方式在目前的企业级开发中是极少用到，因为要提供的代码太多，开发过程太繁琐而冗余，以及容易出错，并不推荐这一种方式；适用于直接使用JDBC的业务场景也是极少的。</p>
<p>​    Hibernate作为较流行的Java ORM框架，它的全自动映射使得编程更简易也方便，只需要我们提供映射规则，就可以通过IDE生成，不需要手动去编写SQL，这对于开发者的SQL编写能力要求不高，相对的减少了工作量，效率上要优于MyBatis。同时，Hibernate也提供了缓存、日志、级联映射等功能。但Hibernate的缺陷也极其明显，多表关联复杂SQL，数据系统权限限制，根据条件变化的SQL，存储过程等场景的使用相对于Hibernate来说会显得力有不逮，并且无法通过SQL进行效率上的增删改查上的优化。所以注定了Hibernate只适用于在场景不太复杂，性能要求不苛刻，数据模型规范严格的情况下使用。</p>
<p>​    反观，Mybatis 由于半自动化映射的关系，其更加具有灵活性，作为一个可以动态生成映射关系的框架，MyBatis会是一个更好的选择。其底层对JDBC进行了封装，拥有动态列、动态表名、并支持存储过程，同样具有 缓存、日志、级联映射的强大的功能。</p>
<p>​    Mybatis的缺点是映射规则需要开发者自己进行创建并提供，以及要根据具体的业务需求编写SQL语句，所以，其开发量要远大于Hibernate.</p>
<p>​    虽然说，在实际开发中，我们是需要根据项目的具体业务场景去选择对应的框架来对DAO进行管理操作。但是，由于Mybatis 的各方面性能的优越性，以及后来出现的Mybatis-Plush，现在MyBatis体系在企业开发中的占比越来越高，仅其动态列、动态表名所能够实现的动态SQL语句就能在开发过程中对同一个DAO进行复用而减少在DAO持久层的编码量，提高开发效率。所以，目前MyBatis在新立项的开发项目中将是一个更好的选择。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
        <tag>场景</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化开发（三）Specification-02.Communication Structure</title>
    <url>/2020/03/31/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%89%EF%BC%89Specification-02-Communication-Structure/</url>
    <content><![CDATA[<h2 id="Communication-Structure-通讯结构"><a href="#Communication-Structure-通讯结构" class="headerlink" title="Communication Structure - 通讯结构"></a>Communication Structure - 通讯结构</h2><h3 id="T6BC架构概述"><a href="#T6BC架构概述" class="headerlink" title="T6BC架构概述"></a>T6BC架构概述</h3><h3 id="Data-Communication"><a href="#Data-Communication" class="headerlink" title="Data Communication"></a>Data Communication</h3><p>设备通过CC-Link IE的链路信号与上下游设备进行连接</p>
<p>链接区域。链路信号仅用于控制作业转移。工作数据通过CCLink IE传输。设备通过三菱公司的CC-Link IE网络与BC公司连接，发送/接收CIM数据</p>
<p><code>BC与设备通信的基础是三菱PLC。</code></p>
<img src="http://photo.wushaopei.com/qiniu259.png" width="80%">

<p>​                            图02内联通信结构 </p>
<p>​    如图所示，<strong>最上层</strong> 是MES，在该架构中所有的数据都需要回复到MES那边的。MES 与 BC 之间是通过Tib/RV 去实现数据传输的。</p>
<p>​    <strong>中间层</strong>的BC，也就L1是使用板卡。 </p>
<p>​    <strong>在下层</strong> 的PLC网络中，存在着一个主站，BC（L1）默认是作为PLC网络中的L1存在的。</p>
<p>​    每一个具体的设备（机台）可以看作是一个PLC，PLC是从L2开始进行连接和起始计算的，在一个PLC网络中，抛去作为主站的BC（L1）之后，可能存在数量不等的多台PLC机台，具体有几个PLC机台要根据每条线自身的具体情况而定。</p>
<p>​    <strong>最底层</strong> 是机台的示意图，其顺序根据PLC的L{num}从左往右递增而呈现从左往右看的规则。</p>
<p>​    对应PLC（L2）的机台是loader(装载板卡) ，而对应最右边的PLC(Ln)则是unLoader。</p>
<h4 id="Loader与unLoader"><a href="#Loader与unLoader" class="headerlink" title="Loader与unLoader"></a>Loader与unLoader</h4><p>Loader与unLoader一般通过连接Stock或者其他搬运的设备（robot等）来将Cassette或者Glass搬上或搬下机台。</p>
<h4 id="机台间的通讯"><a href="#机台间的通讯" class="headerlink" title="机台间的通讯"></a>机台间的通讯</h4><p>每一台机台之间通过光纤进行连接和数据交互，数据使用cclink IE导入到BC。</p>
<h3 id="Inline-CC-Link-IE-Concept"><a href="#Inline-CC-Link-IE-Concept" class="headerlink" title="Inline CC-Link IE Concept"></a>Inline CC-Link IE Concept</h3><h4 id="主机台与子机台"><a href="#主机台与子机台" class="headerlink" title="主机台与子机台"></a>主机台与子机台</h4><img src="http://photo.wushaopei.com/qiniu260.png" width="80%">

<p>每个机台都会划分出一个或一个以上的unit，每个unit可以理解为是子机台。每个子机台与PLC网络不会产生直接关系，每个子机台只对自己的主机台负责，这从另一个层面上可以理解为每个主机台与子机台之间构成了以主机台为主导的子机台网络。</p>
<p>每个unit子机台都会把所处理的数据提交给主机台，并由主机台直接或经过处理后再与PLC网络、BC进行交互。</p>
<p>  <code>EQP需要监控CCLINK IE光纤网络连接状态。如果EQP检测到任何错误发生，EQP需要火灾报警</code></p>
]]></content>
  </entry>
  <entry>
    <title>mybatis 简介（四）Mybatis</title>
    <url>/2020/03/30/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E5%9B%9B%EF%BC%89Mybatis/</url>
    <content><![CDATA[<p>​    针对Hibernate的不足，Mybatis应运而生，它是一个<strong>半自动映射</strong>的框架。</p>
<p>​    之所以称它为<strong>半自动框架</strong>，是因为它需要手动匹配提供POJO、SQL和映射关系，而全表映射的Hibernate 只需要提供POJO和映射关系便可。</p>
<p>​    Mybatis 是Apach 开源的项目Ibatis在迁移到Google code后更名的一个持久层框架。目前由Github进行维护。</p>
<p>​    关于IBatis一词的由来，可以拆解为“internet” 和 “abatis” ，该框架基于Java实现的 持久层框架。</p>
<p>​    后面全部使用Mybatis进行表述。</p>
<p>​    Mybatis提供的持久层框架包括SQL Maps和 DAO（Data Access Objects）。它能更好的解决Hibernate遇到的问题。</p>
<p>​    相较于Hibernate，Mybatis除了需要我们提供基本的映射文件外，还需要我们提供SQL语句。</p>
<p>简单来说，Mybatis 需要我们提供的映射文件包括如下三部分：</p>
<ul>
<li>SQL </li>
<li>映射规则</li>
<li>POJO</li>
</ul>
<p>Mybatis 相较于Hibernate ，其优势比较明显的体现在SQL的编写、优化上。</p>
<p>​    由于在Mybatis 中需要自己编写SQL，同样的Mybatis也提供了配置动态SQL的功能。这就解决了Hibernate中的表明根据时间变化，不同的条件下列名不一样的问题。</p>
<p>​    简而言之，Mybatis适用于对数据模型要求不高的场景，而Hibernate对数据模型的要求很高，相对而言，也比较刻板和缺乏灵活性。</p>
<p><strong>Mybatis 的优势：</strong></p>
<ul>
<li><p>可以对SQL进行优化</p>
</li>
<li><p>可以通过配置决定SQL的映射规则</p>
</li>
<li><p>支持存储过程</p>
<pre><code>&lt;img src=&quot;http://photo.wushaopei.com/qiniu258.png&quot; width=&quot;80%&quot;&gt;</code></pre></li>
</ul>
<p><strong>Mybatis的连接配置</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">      	<span class="comment">&lt;!-- 数据库的四个连接属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/atguigu/pojo/UserMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>MyBatis 映射文件配置</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">  PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Mapper 3.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">  &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  		namespace名称空间</span><br><span class="line">  		取值一般有两种情况：</span><br><span class="line">  			一种情况是：使用javaBean的全类名</span><br><span class="line">  			二种情况是：使用Mapper接口的全类名</span><br><span class="line">   --&gt;</span><br><span class="line">&lt;mapper namespace&#x3D;&quot;com.webcode.pojo.User&quot;&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  	select标签用来配置一个select语句</span><br><span class="line">  		id 用来配置一个唯一的标识</span><br><span class="line">  		resultType 是查询完之后一条记录对应转换成为的javaBean对象</span><br><span class="line">  		#&#123;id&#125;是点位符</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;select id&#x3D;&quot;queryUserById&quot; resultType&#x3D;&quot;com.webcode.pojo.User&quot;&gt;</span><br><span class="line">    	select id,last_name lastName,sex from t_user where id &#x3D; #&#123;id&#125;</span><br><span class="line">  &lt;&#x2F;select&gt;</span><br><span class="line">&lt;&#x2F;mapper&gt;</span><br></pre></td></tr></table></figure>

<p>在这里我们给出了SQL，并没有给出映射规则。如果要使用到映射规则，需要保证SQL列名和POJO的属性名保持一直，这样能够和Mybatis的自动配置规则匹配上并自动进行调用。因此，这一步的操作其实是可以省略掉的。</p>
<p><strong>Mybatis DAO层代码</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public interface UserMapper &#123;</span><br><span class="line"></span><br><span class="line">	public User queryUserById(Integer id);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyBatis想要正常使用，还需要创建 SqlSessionFactory,</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSqlSessionFactory</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拿到SqlSessionFactory 之后我们就可以实现代码功能了.</p>
<p><strong>Mybatis实现对SQL的查询操作</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">queryUserById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">		SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> session.selectOne(<span class="string">"com.webcode.pojo.User.queryUserById"</span>, id);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			session.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（八）线程安全性-内存可见性-synchronized、volatile</title>
    <url>/2020/03/28/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%85%AB%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E5%86%85%E5%AD%98%E5%8F%AF%E8%A7%81%E6%80%A7-synchronized%E3%80%81volatile/</url>
    <content><![CDATA[<p>说明： <strong>多线程的内存可见性涉及到多线程间的数据争用，也涉及到了多线程间的数据可见性</strong> </p>
<h2 id="共享变量在线程间的可见性"><a href="#共享变量在线程间的可见性" class="headerlink" title="共享变量在线程间的可见性"></a>共享变量在线程间的可见性</h2><h3 id="内存可见性介绍："><a href="#内存可见性介绍：" class="headerlink" title="内存可见性介绍："></a>内存可见性介绍：</h3><p><strong>可见性：</strong> 一个线程对共享变量值的修改，能够及时地被其他线程看到。</p>
<p><strong>共享变量：</strong>如果一个变量在多个线程的工作内存中都存在副本，那么这个变量就是这几个线程的共享变量。</p>
<h3 id="Java内存模型（JMM）"><a href="#Java内存模型（JMM）" class="headerlink" title="Java内存模型（JMM）"></a>Java内存模型（JMM）</h3><p><strong>Java内存模型（Java Memory Model）</strong>描述了Java程序中各种变量（线程共享变量）的访问规则，以及在JVM中将变量存储到内存和从内存中读取出变量这样的底层细节。 </p>
<h4 id="在内存模型中："><a href="#在内存模型中：" class="headerlink" title="在内存模型中："></a><strong>在内存模型中：</strong></h4><blockquote>
<p>所有的变量都存储在主内存中；</p>
<p>每个线程都有自己独立的工作内存，里面保存该线程使用到的变量的副本（主内存中该变量的一份拷贝）</p>
</blockquote>
<h4 id="内存模型图："><a href="#内存模型图：" class="headerlink" title="内存模型图："></a><strong>内存模型图：</strong></h4><img src="http://photo.wushaopei.com/qiniu244.png" width="80%">

<h4 id="JMM线程操作内存的两条基本的规定："><a href="#JMM线程操作内存的两条基本的规定：" class="headerlink" title="JMM线程操作内存的两条基本的规定："></a><strong>JMM线程操作内存的两条基本的规定：</strong></h4><blockquote>
<p>第一条关于线程与主内存：线程对共享变量的所有操作都必须在自己的工作内存中进行，不能直接从主内存中读写</p>
<p>第二条关于线程间工作内存：不同线程之间无法直接访问其他线程工作内存中的变量，线程间变量值的传递需要经过主内存来完成。</p>
</blockquote>
<h3 id="共享变量可见性实现的原理："><a href="#共享变量可见性实现的原理：" class="headerlink" title="共享变量可见性实现的原理："></a>共享变量可见性实现的原理：</h3><p>线程1对共享变量的修改要想被线程2及时看到，必须要经过如下<strong>2个步骤</strong>：</p>
<ul>
<li>把工作内存1中更新过的共享变量刷新到主内存中</li>
<li>把住内存中最新的共享变量的值更新到工作内存2中</li>
</ul>
<h4 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a><strong>流程图：</strong></h4><img src="http://photo.wushaopei.com/qiniu245.png" width="80%">



<h2 id="synchronized实现可见性"><a href="#synchronized实现可见性" class="headerlink" title="synchronized实现可见性"></a>synchronized实现可见性</h2><p>由前面可以知道，要<strong>实现共享变量的可见性，必须保证两点</strong>：</p>
<ul>
<li>线程修改后的共享变量值能够及时从工作内存刷新到主内存中；</li>
<li>其他线程能够及时把共享变量的最新值从住内存更新到自己的工作内存中</li>
</ul>
<h3 id="可见性的实现方式"><a href="#可见性的实现方式" class="headerlink" title="可见性的实现方式"></a>可见性的实现方式</h3><p><strong>【1】Java</strong>语言层面支持的<strong>可见性实现方式</strong>： </p>
<blockquote>
<ul>
<li><strong>synchronized</strong></li>
<li><strong>volatile</strong></li>
</ul>
</blockquote>
<p><strong>【2】synchronized能够实现</strong>的 两个功能<strong>：</strong> </p>
<blockquote>
<ul>
<li>原子性（同步）</li>
<li>可见性</li>
</ul>
</blockquote>
<p><strong>【3】JMM关于synchronized 的两条规定：</strong> </p>
<blockquote>
<ul>
<li>线程解锁前，必须把共享变量的最新值刷新到主内存中；</li>
<li>线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新读取最新的值（<strong>注意：加锁与解锁需要的是同一把锁）</strong></li>
</ul>
</blockquote>
<p><strong>线程解锁前对共享变量的修改在下次加锁时对其他线程可见</strong> </p>
<p><strong>【4】线程执行互斥代码的过程：</strong> </p>
<blockquote>
<ol>
<li>获得互斥锁</li>
<li>清空工作内存</li>
<li>从主内存拷贝变量的最新副本到工作内存</li>
<li>执行代码</li>
<li>将更改后的共享变量的值刷新到主内存</li>
<li>释放互斥锁</li>
</ol>
</blockquote>
<p>【5】<strong>指令重排序的概念以及类型</strong> </p>
<p><strong>重排序：代码书写的顺序与实际执行的顺序不同，指令重排序是编译器或处理器为了提高程序性能而做的优化</strong></p>
<blockquote>
<ol>
<li>编译器优化的重排序（编译器优化）</li>
<li>指令集并行重排序（处理器优化）</li>
<li>内存系统的重排序（处理器优化）</li>
</ol>
</blockquote>
<p>示例：<strong>指令重排序 可能 造成的结果</strong></p>
<p>​         <img src="http://photo.wushaopei.com/qiniu246.png" width="80%"></p>
<p>【6】   <strong>as-if-serial</strong> </p>
<p><strong>as-if-serial：无论如何重排序，程序执行的结果应该与代码顺序执行的结果一致（Java编译器、运行时和处理器都会保证Java在单线程下遵循</strong>   <strong>as-if-serial 语义）</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> num1 = <span class="number">1</span>;           <span class="comment">//第1行代码</span></span><br><span class="line"><span class="keyword">int</span> num2 = <span class="number">2</span>;           <span class="comment">//第2行代码</span></span><br><span class="line"><span class="keyword">int</span> sum = num1 + num2 ; <span class="comment">//第3行代码</span></span><br></pre></td></tr></table></figure>

<p><strong>单线程： 第1、2行的顺序可以重排，但第3行不能</strong></p>
<p><strong>重排序不会给单线程带来内存可见性问题</strong></p>
<p><strong>多线程中程序交错执行时，重排序可能会造成内存可见性问题</strong></p>
<h3 id="synchronized实现可见性代码"><a href="#synchronized实现可见性代码" class="headerlink" title="synchronized实现可见性代码"></a><strong>synchronized实现可见性代码</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> mkw.demo.syn;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedDemo</span> </span>&#123;</span><br><span class="line">	<span class="comment">//共享变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ready = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">1</span>;   </span><br><span class="line">    <span class="comment">//写操作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	ready = <span class="keyword">true</span>;	      				 <span class="comment">//1.1				</span></span><br><span class="line">    	number = <span class="number">2</span>;		                    <span class="comment">//1.2			    </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读操作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span></span>&#123;			   	 </span><br><span class="line">    	<span class="keyword">if</span>(ready)&#123;						     <span class="comment">//2.1</span></span><br><span class="line">    		result = number*<span class="number">3</span>;	 	<span class="comment">//2.2</span></span><br><span class="line">    	&#125;   	</span><br><span class="line">    	System.out.println(<span class="string">"result的值为："</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//内部线程类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//根据构造方法中传入的flag参数，确定线程执行读操作还是写操作</span></span><br><span class="line">    	<span class="keyword">private</span> <span class="keyword">boolean</span> flag;</span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="title">ReadWriteThread</span><span class="params">(<span class="keyword">boolean</span> flag)</span></span>&#123;</span><br><span class="line">    		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">    	&#125;</span><br><span class="line">        <span class="meta">@Override</span>                                                                    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span>(flag)&#123;</span><br><span class="line">        		<span class="comment">//构造方法中传入true，执行写操作</span></span><br><span class="line">        		write();</span><br><span class="line">        	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        		<span class="comment">//构造方法中传入false，执行读操作</span></span><br><span class="line">        		read();</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line">    	SynchronizedDemo synDemo = <span class="keyword">new</span> SynchronizedDemo();</span><br><span class="line">    	<span class="comment">//启动线程执行写操作</span></span><br><span class="line">    	synDemo .<span class="keyword">new</span> ReadWriteThread(<span class="keyword">true</span>).start();</span><br><span class="line">    	<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="comment">//启动线程执行读操作</span></span><br><span class="line">    	synDemo.<span class="keyword">new</span> ReadWriteThread(<span class="keyword">false</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="synchronized实现可见性分析："><a href="#synchronized实现可见性分析：" class="headerlink" title="synchronized实现可见性分析："></a>synchronized实现可见性分析：</h3><p>【1】<strong>没有进行重排序</strong> </p>
<p>执行结果:result的值为3 </p>
<p>​         <img src="http://photo.wushaopei.com/qiniu247.png" width="80%"></p>
<p>【2】<strong>进行重排序</strong></p>
<p>​    执行结果:result的值为0</p>
<p>​         <img src="http://photo.wushaopei.com/qiniu248.png" width="80%"></p>
<p>【3】<strong>分析：导致共享变量在线程间不可见的原因</strong></p>
<blockquote>
<ol>
<li>线程的交叉执行</li>
<li>重排序结合线程交叉执行</li>
<li>共享变量更新后的值没有在工作内存与主内存间及时更新</li>
</ol>
</blockquote>
<p>【4】 安全代码： </p>
<p>​         <img src="http://photo.wushaopei.com/qiniu249.png" width="80%"></p>
<p>【5】synchronized 实现内存可见性的解决方案：</p>
<blockquote>
<ol>
<li>添加了synchronized 的地方相当于加了一把锁，被添加锁的地方，在一定时间内只能当前线程释放锁，其他线程才有机会进入其中执行代码；</li>
<li>synchronized  使得 同步的情况下，共享变量在被第二次调用前便被同步到了主内存，实现了共享变量的即时更新</li>
</ol>
</blockquote>
<p>​         <img src="http://photo.wushaopei.com/qiniu250.png" width="80%"></p>
<p><strong>重点：</strong> 为啥synchronized原子性可以避免线程交叉执行：因为synchronized加锁在对象上，执行read方法的线程1获得了对象锁，那线程2不能获得对象锁也就不能执行write方法，因为要执行write方法需要获得锁。但是线程1可以继续执行write方法，因为write方法和read方法可以使用同一把锁，synchronized锁可以重入</p>
<h3 id="synchronized实现可见性结果分析："><a href="#synchronized实现可见性结果分析：" class="headerlink" title="synchronized实现可见性结果分析："></a>synchronized实现可见性结果分析：</h3><p>此处<strong>执行结果为6</strong>的情况进行分析：  </p>
<ol>
<li>synchronized完美保证共享变量的可见性  </li>
<li>但是不加此关键字，并不意味着就不能实现可见性 </li>
</ol>
<p>​         <img src="http://photo.wushaopei.com/qiniu251.png" width="80%"></p>
<p>【1】为何不加synchronized也会执行可见性，主内存及时更新被获取最新值”？</p>
<p>原因有很多个</p>
<p>①即使没有加synchronized，也可能是可见的，在大多数情况都是可见的，因为编译器优化了，会揣摩程序的意图，程序运行很多次，只会有很少的情况不可见。</p>
<p>②因为当时定义说加synchronized一定会可见性，而不加也没说一定不会，只是有可能不会，因为现在Java做了一些优化：尽量实现可见性；但是不能保证每次都成功，只是成功概率比较大99%，但还是有1%的情况会失败。所以处于安全考虑，尽量加synchronized关键字100%成功。</p>
<p>【2】有时候依然不存在线程交叉情况，但还是会先执行第二个线程，因为第一个线程把CPU让位出来，所以为了避免这种情况，可以在第一个线程后附上代码：sleep(1000);1秒之后才有机会执行线程2。</p>
<p>【3】synchronized+sleep();黄金搭档。</p>
<h2 id="volatile实现可见性"><a href="#volatile实现可见性" class="headerlink" title="volatile实现可见性"></a>volatile实现可见性</h2><h3 id="volatile能够保证可见性"><a href="#volatile能够保证可见性" class="headerlink" title="volatile能够保证可见性"></a>volatile能够保证可见性</h3><h4 id="volatile关键字："><a href="#volatile关键字：" class="headerlink" title="volatile关键字："></a><strong>volatile关键字：</strong></h4><blockquote>
<ul>
<li>能够保证volatile变量的可见性</li>
<li>不能保证volatile变量复合操作的原子性</li>
</ul>
</blockquote>
<h4 id="volatile-如何实现内存可见性："><a href="#volatile-如何实现内存可见性：" class="headerlink" title="volatile 如何实现内存可见性："></a><strong>volatile 如何实现内存可见性：</strong></h4><p>深入来说：通过加入内存屏障和禁止重排序优化来实现的。</p>
<ul>
<li>对volatile变量执行写操作时，会在写操作后加入一条store屏障指令</li>
<li>对volatile变量执行读操作时，会在读操作前后加入一条load屏障指令</li>
</ul>
<h4 id="执行引擎对-volatile-的操作："><a href="#执行引擎对-volatile-的操作：" class="headerlink" title="执行引擎对 volatile 的操作："></a><strong>执行引擎对 volatile 的操作：</strong></h4><blockquote>
<p>通俗地讲：volatile变量在每次被线程访问时，都强迫从主内存中重读该变量的值，而当该变量发生变化时，又会强迫线程将最新的值刷新到主内存。这样任何时刻，不同的线程总能看到该变量的最新值。 </p>
</blockquote>
<h4 id="线程-读、-写-volatile-变量的过程"><a href="#线程-读、-写-volatile-变量的过程" class="headerlink" title="线程 读、 写 volatile 变量的过程"></a><strong>线程 读、 写 volatile 变量的过程</strong></h4><p>【1】线程写volatile变量的过程： </p>
<blockquote>
<ol>
<li>改变线程工作的内存中volatile变量副本的值</li>
<li>将改变后的副本的值从工作内存刷新到主内存</li>
</ol>
</blockquote>
<p>【2】线程读volatile变量的过程： </p>
<blockquote>
<ol>
<li>从主内存中读取volatile变量的最新值到线程的工作内存中</li>
<li>从工作内存中读取volatile变量的副本</li>
</ol>
</blockquote>
<h4 id="volatile不能保证volatile变量复合操作的原子性："><a href="#volatile不能保证volatile变量复合操作的原子性：" class="headerlink" title="volatile不能保证volatile变量复合操作的原子性："></a><strong>volatile不能保证volatile变量复合操作的原子性：</strong></h4><p>​         <img src="http://photo.wushaopei.com/qiniu252.png" width="80%"></p>
<h4 id="代码案例："><a href="#代码案例：" class="headerlink" title="代码案例："></a>代码案例：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileDemo</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.number;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">100</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		lock.lock();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.number++;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">final</span> VolatileDemo volDemo = <span class="keyword">new</span> VolatileDemo();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">500</span> ; i++)&#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">				</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					volDemo.increase();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;).start();</span><br><span class="line">		&#125;		</span><br><span class="line">		<span class="comment">//如果还有子线程在运行，主线程就让出CPU资源，</span></span><br><span class="line">		<span class="comment">//直到所有的子线程都运行完了，主线程再继续往下执行</span></span><br><span class="line">		<span class="keyword">while</span>(Thread.activeCount() &gt; <span class="number">1</span>)&#123;</span><br><span class="line">			Thread.yield();</span><br><span class="line">		&#125;		</span><br><span class="line">		System.out.println(<span class="string">"number : "</span> + volDemo.getNumber());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//如果还有子线程在运行，主线程就让出CPU资源</span></span><br><span class="line"><span class="comment">//直到所有的子线程都运行完了，主线程再继续往下执行</span></span><br><span class="line"><span class="keyword">while</span>(Thread.activeCount()&gt;<span class="number">1</span>)&#123;</span><br><span class="line">        Thread.yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>理论来讲，最后的值应该是500，但是因为num++;不是原子操作，且volatile关键字又没有原子性，所以偶尔会出现&lt;500的情况。 </p>
<h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>num++不是原子操作，原子操作意为（所谓原子操作是指不会被线程调度机制打断的操作；这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch  –百科），volatile能保证可见性，但是在多线程调度时 num++ 被拆分为  </p>
<blockquote>
<p>1）从主存中读取num值；</p>
<p> 2) i = num + 1;</p>
<p> 3) 写回i 到主存的num</p>
</blockquote>
<h4 id="基于-number-5-的分析："><a href="#基于-number-5-的分析：" class="headerlink" title="基于 number = 5 的分析："></a><strong>基于 number = 5 的分析：</strong></h4><blockquote>
<p>1、线程A读取到的number 为 5；</p>
<p>2、线程B读取到的number 为 5；</p>
<p>3、线程B 执行加1 操作， number ++</p>
<p>4、线程B写入最新的 number 为 3 中的  5+ 1 = 6;</p>
<p>5、线程A 执行加 1 操作没有向主内存读取共享变量，故 依旧是 由 原始变量  number = 5 开始 加 1 操作，即 此时 number  = 5+ 1 ；</p>
<p>6、线程 A 写入最新的 number  值 ，此时内存中的 只是 将 线程B 的 6 改成了 线程 A 的6 ，实际上只是同值的 覆盖，而非 递增</p>
</blockquote>
<h4 id="安全性解决方案："><a href="#安全性解决方案：" class="headerlink" title="安全性解决方案："></a><strong>安全性解决方案：</strong></h4><p>保证number自增操作的原子性：</p>
<blockquote>
<ul>
<li>使用synchronized关键字</li>
<li>使用ReentrantLock（java.until.concurrent.locks包下）</li>
<li>使用AtomicInteger (vava.util.concurrent.atomic包下)</li>
</ul>
</blockquote>
<h3 id="保证-number-变量在线程中的原子性"><a href="#保证-number-变量在线程中的原子性" class="headerlink" title="保证 number 变量在线程中的原子性"></a>保证 number 变量在线程中的原子性</h3><h4 id="【1】用synchronized-保证-number-变量在线程中的原子性"><a href="#【1】用synchronized-保证-number-变量在线程中的原子性" class="headerlink" title="【1】用synchronized 保证 number 变量在线程中的原子性"></a>【1】用synchronized 保证 number 变量在线程中的原子性</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Thread.sleep(<span class="number">100</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">this</span>.number++;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【2】用ReentrantLock-实现number-变量在线程中的原子性"><a href="#【2】用ReentrantLock-实现number-变量在线程中的原子性" class="headerlink" title="【2】用ReentrantLock 实现number 变量在线程中的原子性"></a>【2】用ReentrantLock 实现number 变量在线程中的原子性</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Thread.sleep(<span class="number">100</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">	lock.lock();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.number++;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		lock.unlock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="volatile适用场合"><a href="#volatile适用场合" class="headerlink" title="volatile适用场合"></a>volatile适用场合</h3><p><strong>要在多线程中安全的使用volatile变量，必须同时满足：</strong></p>
<p>a）对变量的写入操作不依赖其当前值</p>
<blockquote>
<p>   不满足：number++、count=count*5等</p>
<p>​    满足：boolean变量、记录温度变化的变量等</p>
</blockquote>
<p>b）该变量没有包含在具有其他变量的不变式中 </p>
<blockquote>
<p>不满足：不变式low&lt;up </p>
</blockquote>
<h3 id="synchronized和volatile比较"><a href="#synchronized和volatile比较" class="headerlink" title="synchronized和volatile比较"></a>synchronized和volatile比较</h3><blockquote>
<p>a）volatile不需要加锁，比synchronized更轻便，不会阻塞线程</p>
<p>b）从内存可见性的角度来讲，volatile的读相当于加锁，volatile的写相当于解锁</p>
<p>c）synchronized既能保证可见性，又能保证原子性，而volatile只能保证可见性，无法保证原子性</p>
</blockquote>
<h4 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h4><p>【1】对于64位(long、double)变量的读写可能不是原子操作:<br>.Java内存模型允许JVM将没有被volatile修饰的64位数据类型的读写操作划分为两次32位的读写操作来进行</p>
<p>导致问题:有可能会出现读取到”半个变量”的情况<br>解决方法:加volatile关键字</p>
<p>【2】问:即使没有保证可见性的措施,很多时候共享变量依然能够在主内存和工作内存见得到及时的更新?</p>
<p>答:一般只有在短时间内高并发的情况下才会出现变量得不到及时更新的情况,因为CPU在执行时会很快的刷新缓存,所以一般情况下很难看到这种问题.</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>内存可见性</tag>
        <tag>synchronized</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（七）线程安全性-原子性-synchronized</title>
    <url>/2020/03/27/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%83%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E5%8E%9F%E5%AD%90%E6%80%A7-synchronized/</url>
    <content><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Java中<strong>原子性</strong>的实现是 <strong>加锁</strong>；而<strong>加锁的方式</strong>有两种：<strong>synchronized 、Lock</strong> </p>
<p><strong>区别：</strong> </p>
<blockquote>
<p><strong>synchronized</strong> : 依赖JVM</p>
<p><strong>Lock :</strong> 依赖特殊的CPU指令，代码实现，ReentrantLock</p>
</blockquote>
<h2 id="原子性-synchronized"><a href="#原子性-synchronized" class="headerlink" title="原子性 - synchronized"></a>原子性 - synchronized</h2><h3 id="synchronized-的使用："><a href="#synchronized-的使用：" class="headerlink" title="synchronized  的使用："></a>synchronized  的使用：</h3><blockquote>
<ul>
<li>修饰代码块： 大括号括起来的代码，作用于调用的对象</li>
<li>修饰方法：整个方法，作用于调用的对象</li>
<li>修饰静态方法：整个静态方法，作用于所有对象</li>
<li>修饰类：括号括起来的部分，作用于所有对象</li>
</ul>
</blockquote>
<p><strong>同步操作：</strong>  </p>
<blockquote>
<p>  修饰代码块也叫同步代码块</p>
<p>  修饰方法也叫同步方法</p>
</blockquote>
<h3 id="synchronized关键字代码演示："><a href="#synchronized关键字代码演示：" class="headerlink" title="synchronized关键字代码演示："></a>synchronized关键字代码演示：</h3><h4 id="同一对象的两个线程调用同步代码块："><a href="#同一对象的两个线程调用同步代码块：" class="headerlink" title="同一对象的两个线程调用同步代码块："></a>同一对象的两个线程调用同步代码块：</h4><h5 id="执行test1-同步方法"><a href="#执行test1-同步方法" class="headerlink" title="执行test1()同步方法"></a><strong>执行test1()同步方法</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.sync;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SynchronizedExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 14:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个代码块</span></span><br><span class="line">    <span class="comment">//作用的对象是调用的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">                log.info(<span class="string">"test1 - &#123;&#125;"</span>,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            log.info(<span class="string">"test - &#123;&#125;"</span>,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SynchronizedExample1 example1 = <span class="keyword">new</span> SynchronizedExample1();</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//在不使用线程池的情况下，本身就是同步执行，synchronized修饰意义不大，</span></span><br><span class="line">        <span class="comment">//使用线程池后，存在两条线程，同时执行代码，在没有synchronized修饰时是并发异步的执行，交替穿插打印结果</span></span><br><span class="line">        <span class="comment">//使用synchronized修饰后，由于锁定的是当前对象example1，所以只有第一个线程执行完，第二个线程才会执行</span></span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example1.test2();</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example1.test2();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行test1（）同步方法，结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.164</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 由结果可知，先执行完线程1的test1-0到test1-9，再执行线程2的test0到test9</p>
</blockquote>
<h5 id="执行test2-同步方法"><a href="#执行test2-同步方法" class="headerlink" title="执行test2()同步方法"></a><strong>执行test2()同步方法</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example1.test2();</span><br><span class="line">&#125;);</span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example1.test2();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>运行test2()方法,打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.003</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">2</span></span><br></pre></td></tr></table></figure>



<h4 id="不同对象调用同步代码块："><a href="#不同对象调用同步代码块：" class="headerlink" title="不同对象调用同步代码块："></a><strong>不同对象调用同步代码块：</strong></h4><h5 id="执行test1-同步方法，"><a href="#执行test1-同步方法，" class="headerlink" title="执行test1()同步方法，"></a><strong>执行test1()同步方法，</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            log.info(<span class="string">"test1 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SynchronizedExample1 example1 = <span class="keyword">new</span> SynchronizedExample1();</span><br><span class="line">    SynchronizedExample1 example2 = <span class="keyword">new</span> SynchronizedExample1();</span><br><span class="line">    ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">   </span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">        example1.test1(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    executorService.execute(()-&gt;&#123;</span><br><span class="line">        example2.test1(<span class="number">2</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.315</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.315</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">9</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 由结果可知，两个不同的对象调用同步代码块时，它们的结果是互相不影响的。</p>
</blockquote>
<h5 id="执行test2-同步方法，"><a href="#执行test2-同步方法，" class="headerlink" title="执行test2()同步方法，"></a><strong>执行test2()同步方法，</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//修饰一个方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">        log.info(<span class="string">"test2 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example1.test2(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example2.test2(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.704</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.704</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">9</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>有结果可知，两个不同的对象调用同步方法时，它们的结果是互相不影响的。 </p>
</blockquote>
<h3 id="静态同步方法、静态同步代码块："><a href="#静态同步方法、静态同步代码块：" class="headerlink" title="静态同步方法、静态同步代码块："></a><strong>静态同步方法、静态同步代码块：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.sync;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SynchronizedExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 14:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个代码块</span></span><br><span class="line">    <span class="comment">//作用的对象是调用的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">         <span class="keyword">synchronized</span>  (SynchronizedExample2<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">                log.info(<span class="string">"test1 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个静态方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            log.info(<span class="string">"test2 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SynchronizedExample2 example1 = <span class="keyword">new</span> SynchronizedExample2();</span><br><span class="line">        SynchronizedExample2 example2 = <span class="keyword">new</span> SynchronizedExample2();</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example1.test2(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example2.test2(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>静态同步代码块测试结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.930</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">9</span></span><br></pre></td></tr></table></figure>

<p><strong>静态同步方法测试结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.042</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">9</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="对并发执行增加操作线程使用synchronized修饰："><a href="#对并发执行增加操作线程使用synchronized修饰：" class="headerlink" title="对并发执行增加操作线程使用synchronized修饰："></a>对并发执行增加操作线程使用synchronized修饰：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountExample3</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//同步方法锁 --- synchronized</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">49</span>:<span class="number">18.636</span> [main] INFO com.mmall.concurrency.example.count.CountExample3 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>由执行结果可知，count符合执行的要求，说明当前程序是线程安全的 </p>
</blockquote>
<h3 id="原子性-对比"><a href="#原子性-对比" class="headerlink" title="原子性  - 对比"></a>原子性  - 对比</h3><blockquote>
<p><strong>synchronized</strong> : 不可中断锁，适合竞争不激烈，可读性好</p>
</blockquote>
<blockquote>
<p><strong>Lock</strong> : 可中断锁，多样化同步，竞争激烈时能维持常态</p>
</blockquote>
<blockquote>
<p><strong>Atomic</strong> ： 竞争激烈时能维持常态，比Lock性能好；只能同步一个值</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>synchronized</tag>
        <tag>原子性</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（六）线程安全性-原子性-atomic</title>
    <url>/2020/03/27/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%85%AD%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E5%8E%9F%E5%AD%90%E6%80%A7-atomic/</url>
    <content><![CDATA[<h2 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>​    <strong>当某个线程访问某个类时，不管运行时环境采用何种调度方式或者这些锦城南将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类是线程安全的</strong>。 </p>
<h3 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h3><blockquote>
<p> <strong>原子性</strong>：提供了互斥访问，同一时刻只能有一个线程来对它进行操作</p>
<p> <strong>可见性</strong>：一个线程对主内存的修改可以及时的被其他线程观察到</p>
<p> <strong>有序性</strong>：一个线程观察其他线程中的指令执行顺序，由于指令 重排序的存在，该观察结果一般杂乱无序</p>
</blockquote>
<h2 id="原子性-Atomic包"><a href="#原子性-Atomic包" class="headerlink" title="原子性-Atomic包"></a>原子性-Atomic包</h2><p><strong>Atomic包下的类可以 实现线程并发的原子性，主要的类有：</strong> </p>
<p><strong>① AtomicXXX : CAS 、Unsafe.compareAndSwapInt</strong></p>
<p><strong>② AtomicLong、LongAdder</strong></p>
<p><strong>③ AtomicReference、AtomicIntegerFieldUpdater、AtomicStampReference</strong></p>
<h3 id="AtomicXXX-案例实测"><a href="#AtomicXXX-案例实测" class="headerlink" title="AtomicXXX 案例实测"></a><strong>AtomicXXX</strong> 案例实测</h3><p>使用Atomic确保线程并发的原子性，代码演示： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.count;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.NoThreadSafe;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> CountExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 17:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count.get());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">17:14:59.658 [main] INFO com.mmall.concurrency.example.count.CountExample2 - count:5000</span><br><span class="line"> </span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>由结果可知，无论执行多少次，count都是5000的值，说明了Atomic可以确保线程的安全性。</p>
<p><font color=red>原理解析：</font></p>
<p>这里对add（）方法所做的修改，即将count++改为count.incrementAndGet()是保证线程安全的主要原因！</p>
<p>从<strong>源码</strong>进行分析：</p>
<p>点击计入incrementAndGet( )类中：<br><img src="http://photo.wushaopei.com/qiniu238.png" width="80%"></p>
<p>由源码可知，incrementAndGet()方法里使用了一个叫unsafe的类，该类实现了一个getAndAddInt()的方法， </p>
<img src="http://photo.wushaopei.com/qiniu239.png" width="80%">

<p>进入getAndAddInt方法进一步分析： </p>
<img src="http://photo.wushaopei.com/qiniu240.png" width="80%">

<p>由源码可知，getAndAddInt方法内部调用了do-while循环结构，在while循环条件中，调用了compareAndSwapInt()方法，这是一个重点，进一步查看该方法： </p>
<img src="http://photo.wushaopei.com/qiniu241.png" width="80%">

<p>​    由图中源码可知，该方法被native所修饰，这是代表是java底层的方法，而不是通过java去实现的。</p>
<p>分析getAndAddInt()方法源码：</p>
<img src="http://photo.wushaopei.com/qiniu242.png" width="80%">

<p>​    这里传过来的var1对象值相当于案例中的 count 值，其中的var2 值则是当前的值。</p>
<p>compareAndSwapInt()方法的作用是，在count值时，var2=2和var5=2的值相同时，将他的值更新为后面的var5+var4的值。这里的var5是从底层取的。</p>
<p><strong>安全原则示例</strong>： 当var2=2，var4=4,进入do作用域中，调用this.getIntVolatile()方法进行修改，然后进入while循环，此时会对var2和var5进行判断，var2是上一次修改后被返回的校验字段，而var5则是对应保存在底层的校验字段，单线程执行时，每一次var5都会在执行compareAndSwapInt()方法后进行变更，即每一次var4+var5都会++；</p>
<p><strong>重点：</strong> 当程序并发请求，当前线程执行var2=2时,有其他线程抢夺CPU执行权执行了一次<code>compareAndSwapInt()</code> 方法后，当前线程再获得锁进入执行  <code>compareAndSwapInt()</code> 方法后var5发生改变，被替换为 <code>var4+var5(2+1=3)</code> 的值，var2=2和var5=3(此时底层取的是3)是不同的值，校验不通过。此时var2的值会重新从 count中取值，当var2取值为3后，再与var5=3进行比较，比较通过后，再对var4+var5进行执行，结果为3+1=4 ; 逻辑依次循环判断，不断对底层值进行覆盖，从而保证执行线程的安全。</p>
<h3 id="AtomicLong、LongAdder-案例实测"><a href="#AtomicLong、LongAdder-案例实测" class="headerlink" title="AtomicLong、LongAdder 案例实测"></a><strong>AtomicLong、LongAdder</strong> 案例实测</h3><h4 id="AtomicLong代码实例："><a href="#AtomicLong代码实例：" class="headerlink" title="AtomicLong代码实例："></a><strong>AtomicLong代码实例：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AtomicLong count = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">30</span>:<span class="number">44.260</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample2 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="LongAdder代码实例："><a href="#LongAdder代码实例：" class="headerlink" title="LongAdder代码实例："></a>LongAdder代码实例：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.LongAdder;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample3</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LongAdder count = <span class="keyword">new</span> LongAdder();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count.increment();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">32</span>:<span class="number">09.818</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample3 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>知识点：</strong> </p>
<blockquote>
<p>对于普通类型的long、double变量，JVM允许将64位的读操作或写操作拆成两个32位的操作。 </p>
</blockquote>
<h4 id="LongAdder的实现是基于什么思想？"><a href="#LongAdder的实现是基于什么思想？" class="headerlink" title="LongAdder的实现是基于什么思想？"></a><strong>LongAdder的实现是基于什么思想？</strong></h4><p>LongAdder的核心是将核心数据分离；比如LongAdder内部的value分离成为一个数组，每个线程访问时通过hash等算法映射到其中一个数字进行计数，而最终的计数结果则为这个数组的求和累加，其中热点单元的数据会被分离为多个单元的shell，每个shell独自维护内部的值，当前对象的值由所有shell累计而成。这样的话，热点就进行了有效的分离并提高了并行度，这样一来LongAdder相当于在AtomicLong的基础上将单点的更新压力分散到各个节点上，在低并发的时候通过对base的值进行更新可以很好的保障和Atomic的性能基本一致，而在高并发的时候则通过分散提高了性能。</p>
<p>注意：实际在处理并发更新统计时，优先使用LongAdder。并发要求低时使用AtomicLong，效率高。</p>
<h3 id="AtomicReference代码实例"><a href="#AtomicReference代码实例" class="headerlink" title="AtomicReference代码实例"></a>AtomicReference代码实例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample4</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> AtomicReference&lt;Integer&gt; count = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        count.compareAndSet(<span class="number">0</span>,<span class="number">2</span>); <span class="comment">// 2</span></span><br><span class="line">        count.compareAndSet(<span class="number">0</span>,<span class="number">1</span>); <span class="comment">// no</span></span><br><span class="line">        count.compareAndSet(<span class="number">1</span>,<span class="number">3</span>); <span class="comment">// no</span></span><br><span class="line">        count.compareAndSet(<span class="number">2</span>,<span class="number">4</span>); <span class="comment">// 4</span></span><br><span class="line">        count.compareAndSet(<span class="number">3</span>,<span class="number">5</span>); <span class="comment">// no</span></span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count.get());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">55</span>:<span class="number">53.811</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample4 - count:<span class="number">4</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="AtomicIntegerFieldUpdater代码实例"><a href="#AtomicIntegerFieldUpdater代码实例" class="headerlink" title="AtomicIntegerFieldUpdater代码实例"></a><strong>AtomicIntegerFieldUpdater</strong>代码实例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample5</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">100</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicExample5 example5 = <span class="keyword">new</span> AtomicExample5();</span><br><span class="line"> </span><br><span class="line">    private static AtomicIntegerFieldUpdater&lt;AtomicExample5&gt; updater = AtomicIntegerFieldUpdater.newUpdater(AtomicExample5.class,"count");</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (updater.compareAndSet(example5,<span class="number">100</span>,<span class="number">120</span>))&#123;</span><br><span class="line">            log.info(<span class="string">"update success 1, &#123;&#125;"</span>,example5.getCount());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (updater.compareAndSet(example5,<span class="number">100</span>,<span class="number">120</span>))&#123;</span><br><span class="line">            log.info(<span class="string">"update success 2, &#123;&#125;"</span>,example5.getCount());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">"update failed,&#123;&#125;"</span>,example5.getCount());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">11:02:48.170 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update success 1, 120</span><br><span class="line">11:02:48.177 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update failed,120</span><br><span class="line"> </span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p><strong>分析执行结果：</strong> </p>
<blockquote>
<p>AtomicIntegerFieldUpdater的核心是根据原子性去更新某个类的实例，当前案例修改的是AtomicExample5 类的example5 的某一个字段 count;这里要求count 必须被volatile进行修饰；执行第一个compareAndSet方法时，compareAndSet方法中是将第二个变量100修改为第三个变量120,此时example5通过getCount()更新成了120；再执行第二个compareAndSet方法时，example5与100校验不相同，不执行当前compareAndSet方法，所以没有日志打印，流程进入到else中，打印 “update failed ，120 ”。</p>
</blockquote>
<h3 id="AtomicStampReference：CAS的ABA问题"><a href="#AtomicStampReference：CAS的ABA问题" class="headerlink" title="AtomicStampReference：CAS的ABA问题"></a>AtomicStampReference：CAS的ABA问题</h3><p><strong>关于ABA问题：</strong> </p>
<blockquote>
<p>ABA问题是指在CAS操作的时候，其他线程将变量的值A改成了B，但是又改回了A，本线程使用期望值A与当前变量进行比较的时候，发现A变量没有变，于是CAS就将A值进行了交换操作，这个时候，其实该值已经被其他线程改变过，这与设计思想是不符合的。</p>
<p>因此，ABA问题的解决思路是：每次变量更新的时候，把变量的版本号加一，那么之前那个A改成B，再改成A，就会变成A变成1版本，改成B变成2版本，再改回A变成3版本，这个时候只要变量被某一个线程修改过，该变量对应的版本号就会发生过递增变化。从而解决了ABA问题。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line">import com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line">import lombok.Getter;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line">import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"> </span><br><span class="line">&#x2F;**</span><br><span class="line"> * @ClassName AtomicExample1</span><br><span class="line"> * @Description TODO</span><br><span class="line"> * @Author wushaopei</span><br><span class="line"> * @Date 2019&#x2F;10&#x2F;31 10:23</span><br><span class="line"> * @Version 1.0</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class AtomicExample6 &#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F;请求总数</span><br><span class="line">    public static int clientTotal &#x3D; 5000;</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal &#x3D; 200;</span><br><span class="line"> </span><br><span class="line">    public static AtomicBoolean isHappened &#x3D; new AtomicBoolean(false);</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        ExecutorService executorService &#x3D; Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore &#x3D; new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch &#x3D; new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i &#x3D; 0 ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    test();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;catch (Exception e)&#123;</span><br><span class="line">                    log.error(&quot;exception&quot;,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;isHappened:&#123;&#125;&quot;,isHappened.get());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private static void test()&#123;</span><br><span class="line">        if (isHappened.compareAndSet(false,true))&#123;</span><br><span class="line">            log.info(&quot;execute&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">25</span>:<span class="number">55.399</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - execute</span><br><span class="line"><span class="number">11</span>:<span class="number">25</span>:<span class="number">55.429</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - isHappened:<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>结果分析：<strong>为什么声明了5000次线程，却只执行了一次？</strong> </p>
<blockquote>
<p>因为AtomicBoolean的compareAndSet具有原子性，它可以保证从false变成true只有一次，之后的4999次在compareAndSet的判断当前值为true后，不会再执行变成true的操作。 </p>
</blockquote>
<p><strong>使用场景</strong>： 让某一段代码只执行一次，而不会发生重复。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>原子性</tag>
        <tag>atomic</tag>
      </tags>
  </entry>
  <entry>
    <title>EasyUI笔记（四）控件的引入与事件的发生</title>
    <url>/2020/03/25/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E6%8E%A7%E4%BB%B6%E7%9A%84%E5%BC%95%E5%85%A5%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="控件的引入"><a href="#控件的引入" class="headerlink" title="控件的引入"></a>控件的引入</h1><h2 id="引入布局"><a href="#引入布局" class="headerlink" title="引入布局"></a>引入布局</h2><h3 id="在页面中引用资源"><a href="#在页面中引用资源" class="headerlink" title="在页面中引用资源"></a>在页面中引用资源</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;主界面&lt;/title&gt;</span><br><span class="line">    &lt;script type="text/javascript" src="/easyui/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type="text/javascript" src="/easyui/jquery.easyui.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type="text/javascript" src="/easyui/easyloader.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"/easyui/themes/icon.css"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span>  href=<span class="string">"/easyui/themes/default/easyui.css"</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br></pre></td></tr></table></figure>

<h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;body <span class="class"><span class="keyword">class</span></span>=<span class="string">"easyui-layout"</span>&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'north',title:'头部',split:true"</span> style=<span class="string">"height:100px;"</span>&gt;</span><br><span class="line">            &lt;h1&gt; 顶部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'south',title:'底部',split:true"</span> style=<span class="string">"height:100px;"</span>&gt;</span><br><span class="line">            &lt;h1&gt;底部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'west',title:'左部',split:true"</span> style=<span class="string">"width:200px;"</span>&gt;</span><br><span class="line">            &lt;h1&gt;左部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'center',title:'中部'"</span>  &gt;</span><br><span class="line">            &lt;h1&gt;中部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<h3 id="页面布局效果"><a href="#页面布局效果" class="headerlink" title="页面布局效果"></a>页面布局效果</h3><p><strong>index .html</strong></p>
<ol>
<li>****主界面分为三部分：top，left，right</li>
<li>Left部分有个树形菜单</li>
<li>right部分显示左侧菜单点击后的详细页面。</li>
</ol>
<img src="http://photo.wushaopei.com/qiniu235.png" width="70%">

<h2 id="手风琴控件引入"><a href="#手风琴控件引入" class="headerlink" title="手风琴控件引入"></a>手风琴控件引入</h2><h3 id="手风琴列表"><a href="#手风琴列表" class="headerlink" title="手风琴列表"></a>手风琴列表</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-options</span>=<span class="string">"region:'west',title:'左部',split:true"</span> <span class="attr">style</span>=<span class="string">"width:200px;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"easyui-accordion"</span> <span class="attr">style</span>=<span class="string">"overflow:auto;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"About"</span> <span class="attr">data-option</span>=<span class="string">"iconCls:'icon-ok'"</span> <span class="attr">style</span>=<span class="string">"voerflow:auto;padding:10px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>商品属性管理<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"Help"</span> <span class="attr">data-option</span>=<span class="string">"iconCls:'icon-help'"</span> <span class="attr">style</span>=<span class="string">"padding:10px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>SPU管理<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"TreeMenu"</span> <span class="attr">data-option</span>=<span class="string">"iconCls:'icon-search'"</span> <span class="attr">style</span>=<span class="string">"padding:10px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>仓库接口管理<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里将手风琴控件放置到 左边栏的div 标签内，每添加一个菜单项，只需要在 class=”easyui-accordion”的div标签作用域内添加新的 div 标签即可。</p>
<img src="http://photo.wushaopei.com/qiniu236.png" width="50%">

<h3 id="左侧-菜单项添加子菜单"><a href="#左侧-菜单项添加子菜单" class="headerlink" title="左侧-菜单项添加子菜单"></a>左侧-菜单项添加子菜单</h3><img src="http://photo.wushaopei.com/qiniu237.png" width="40%">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">style</span>=<span class="string">"text-decoration:none;"</span>&gt;</span>平台属性管理<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;p align="center"&gt;&lt;a href="#" style="text-decoration:none;"&gt;平台属性管理&lt;/a&gt;&lt;/p&gt; --&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这里添加子菜单，其实就是在下拉的菜单列表中添加多个单行的 无序列表，该无序列表的每个<code>&lt;li &gt;&lt; /li&gt;</code> 标签独占一行。</p>
<p>因此，除了使用<code>&lt;ul&gt;</code> 标签外，也可以使用如<code>&lt;p&gt;</code>标签，这里使用<code>&lt;p&gt;&lt;/p&gt;</code> 标签.</p>
<h2 id="选项卡控件引入"><a href="#选项卡控件引入" class="headerlink" title="选项卡控件引入"></a>选项卡控件引入</h2><h3 id="中部-增加tab组件"><a href="#中部-增加tab组件" class="headerlink" title="中部-增加tab组件"></a>中部-增加tab组件</h3><h4 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h4><img src="http://photo.wushaopei.com/qiniu253.png" width="70%">

<p>关于选项卡控件的引入规则：这里通过点击 “平台属性管理” 这一个<code>&lt;li&gt;</code>  标签来实现页面中部的选项卡控件的展现。</p>
<h4 id="添加选项卡控件："><a href="#添加选项卡控件：" class="headerlink" title="添加选项卡控件："></a>添加选项卡控件：</h4><img src="http://photo.wushaopei.com/qiniu254.png" width="60%">

<p>控件的引入可以从 demo 中去取到对应的代码。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"tt"</span> <span class="attr">class</span>=<span class="string">"easyui-tabs"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将该<code>&lt;div&gt;</code> 标签添加到 布局中部的 <code>&lt;div&gt;</code> 中。</p>
<h4 id="添加后代码位置："><a href="#添加后代码位置：" class="headerlink" title="添加后代码位置："></a>添加后代码位置：</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-options</span>=<span class="string">"region:'center',title:'中部'"</span>  &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"tt"</span> <span class="attr">class</span>=<span class="string">"easyui-tabs"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="事件的发生"><a href="#事件的发生" class="headerlink" title="事件的发生"></a>事件的发生</h1><h2 id="生成新页面"><a href="#生成新页面" class="headerlink" title="生成新页面"></a>生成新页面</h2><p>这里考虑一点，当点击左部手风琴内菜单项“商品属性管理”时要在中部弹出一个新的页面。如下图：</p>
<img src="http://photo.wushaopei.com/qiniu255.png" width="70%">

<p><strong>实现方法：</strong> 通过点击事件进行页面的添加</p>
<h3 id="函数事件"><a href="#函数事件" class="headerlink" title="函数事件"></a>函数事件</h3><h4 id="点击菜单增加右边的标签"><a href="#点击菜单增加右边的标签" class="headerlink" title="点击菜单增加右边的标签"></a>点击菜单增加右边的标签</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"基本信息管理"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:add_tab('商品属性管理','attrListPage')"</span> <span class="attr">style</span>=<span class="string">"text-decoration:none;"</span>&gt;</span>商品属性管理<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>给要点击的那一个菜单项添加一个事件， 使用 <code>&lt;a&gt;</code> 标签配合 href 调用 js 语言添加新页面。</p>
<p><strong>注意：</strong>  如果要想填充到指定的<code>&lt;div&gt;</code>位置，需要获取该 <code>&lt;div&gt;</code> 标签的 id ，并使用 easyui 提供的属性进行填充，详情可以参考EasyUI提供的API文档，相关截图如下：</p>
<img src="http://photo.wushaopei.com/qiniu256.png" width="60%">

<h4 id="function-事件"><a href="#function-事件" class="headerlink" title="function 事件"></a>function 事件</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">add_tab</span><span class="params">(title,url)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">        alert(<span class="string">"调用后台的"</span>+url+<span class="string">"方法，返回一个页面，填充到"</span>);</span></span><br><span class="line">        </span><br><span class="line"><span class="javascript">        $(<span class="string">'#tt'</span>).tabs(<span class="string">'add'</span>,&#123;    </span></span><br><span class="line">            title:title,    </span><br><span class="line">            href: url,</span><br><span class="line"><span class="actionscript">            closable:<span class="literal">true</span>,    </span></span><br><span class="line">            tools:[&#123;    </span><br><span class="line"><span class="actionscript">                iconCls:<span class="string">'icon-mini-refresh'</span>,    </span></span><br><span class="line"><span class="actionscript">                handler:<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;    </span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'refresh'</span>);    </span></span><br><span class="line">                &#125;    </span><br><span class="line">            &#125;]    </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里通过 add_tab（title,url）向后台进行请求，并返回一个 页面进行填充到中部，这里可以看成添加到 <code>&lt;div&gt;</code> 中。</p>
<h4 id="添加结果："><a href="#添加结果：" class="headerlink" title="添加结果："></a>添加结果：</h4><img src="http://photo.wushaopei.com/qiniu257.png" width="70%">

<h4 id="页面重复添加的校验"><a href="#页面重复添加的校验" class="headerlink" title="页面重复添加的校验"></a>页面重复添加的校验</h4><p>​    避免多次点击“商品属性管理”而导致多次添加对应的页面到中部区域。</p>
<p>解决方法：EasyUI自身就提供了这么一个功能。</p>
<p>EasyUI 的API中提供了两个方法适用于这个方面，一个是select，另一个是exists；select可以用于定位到指定的面板，而exists则可以用于判断指定的面板是否存在。</p>
<h5 id="具体代码如下："><a href="#具体代码如下：" class="headerlink" title="具体代码如下："></a>具体代码如下：</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> b =$(<span class="string">'#tt'</span>).tabs(<span class="string">'exists'</span>,title); <span class="comment">// 判断传入的面板（页面）是否存在</span></span><br><span class="line"><span class="keyword">if</span>(!b)&#123;	        	<span class="comment">// 默认不存在的情况下进行添加</span></span><br><span class="line">     	$(<span class="string">'#tt'</span>).tabs(<span class="string">'add'</span>,&#123;    </span><br><span class="line">          title:title,    </span><br><span class="line">          href: url,</span><br><span class="line">          closable:<span class="literal">true</span>,    </span><br><span class="line">          tools:[&#123;    </span><br><span class="line">              iconCls:<span class="string">'icon-mini-refresh'</span>,    </span><br><span class="line">              handler:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;    </span><br><span class="line">                  alert(<span class="string">'refresh'</span>);    </span><br><span class="line">              &#125;    </span><br><span class="line">          &#125;]    </span><br><span class="line">      &#125;);  </span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;     <span class="comment">// 如果存在的话就定位到该页面（面板）</span></span><br><span class="line">     	$(<span class="string">'#tt'</span>).tabs(<span class="string">'select'</span>,title);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>自动化开发（二）BC代码讲解</title>
    <url>/2020/03/24/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89BC%E4%BB%A3%E7%A0%81%E8%AE%B2%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="代码结构包目录图："><a href="#代码结构包目录图：" class="headerlink" title="代码结构包目录图："></a>代码结构包目录图：</h2><img src="http://photo.wushaopei.com/qiniu217.png" width="80%">

<h2 id="代码分块："><a href="#代码分块：" class="headerlink" title="代码分块："></a>代码分块：</h2><ol>
<li>api - bundle </li>
<li>bc-common   </li>
<li>bc-model-bundle</li>
<li>service 层： bc-service- * - *   （包括bc-jobdata-service-bundle）</li>
</ol>
<p>​        bc-service 开头的是整个BC的逻辑层代码</p>
<ol start="5">
<li><p>bc-simulator-bundle  （修改simulator 用的）</p>
</li>
<li><p>jar 层</p>
<p>包含四个模块的功能：</p>
<pre><code>bc-workflow-bundle

secsgem

plcconnector

rvconnector</code></pre></li>
<li><p>日志层  </p>
<p>osgi-logger-common</p>
<p>osgi-loglistener</p>
</li>
<li><p>数据转换层</p>
<p>oee-datatransmitter-bundle</p>
<p>mes-datatransmitter-bundle</p>
<p>eq-datatransmitter-bundle</p>
<p>edc-datatransmitter-bundle</p>
</li>
</ol>
<p>​        secs-datatransmitter-bundle</p>
<p>​    fdc-datatransmitter-bundle</p>
<img src="http://photo.wushaopei.com/qiniu221.png" width="80%">

<p>   这一层的功能模块只做数据转换处理，转换完成后；数据会先经过bc-workflow-bundle，之后再转到bc-service- * -bundle 这一层，最终会在service层中根据 bc-model-bundle 中给定的模型将数据进行包装处理成bean形式的数据后存储起来（主要在bc-service-line-bundle中处理）。</p>
<ol start="9">
<li><p>view 层 （客户端）</p>
<p>client-common-bundle</p>
<p>client-service-bundle</p>
</li>
</ol>
<p>在客户端主要是通过http协议对请求进行解析，在项目中内嵌了 jetty 容器，所以项目不需要打包放到tomcat中，客户端的页面资源则需要放置到 tomcat 的webapp目录下才能访问。</p>
<h2 id="api-bundle"><a href="#api-bundle" class="headerlink" title="api - bundle"></a>api - bundle</h2><h3 id="基本原则："><a href="#基本原则：" class="headerlink" title="基本原则："></a><strong>基本原则：</strong></h3><ol>
<li><h4 id="Port的获取"><a href="#Port的获取" class="headerlink" title="Port的获取"></a><strong>Port的获取</strong></h4></li>
</ol>
<p>一条线上可能有多个设备，每个设备上有unit，每个unit或设备上有job。如果要找PORT，就直接找PortDAO。</p>
<p>Port通过属性和EQP关联起来，****</p>
<ol start="2">
<li><h4 id="捞取数据"><a href="#捞取数据" class="headerlink" title="捞取数据"></a><strong>捞取数据</strong></h4></li>
</ol>
<p>有一部分数据是从DB捞的，有一部分是从实时运行中捞的数据；从DB上捞的数据也就是我们做的BC工具里面的数据，我们都是放在 Data 中的。</p>
<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p> 凡是以BC * 开头的参数都是可以从Data中获取数据的，例如： BcPort、BcEquiment、BcUnit等。</p>
<p>这些数据都是在DB里面捞的，这些数据都是在我们 set Off 之前，key 的数据库里面的数据。</p>
<h4 id="应用："><a href="#应用：" class="headerlink" title="应用："></a>应用：</h4><p>如果要查找Port的一些属性，比如： Port属于哪个设备、哪条线，都可以通过 getData 去取里面的属性就可以了。</p>
<img src="http://photo.wushaopei.com/qiniu218.png" width="80%">

<h3 id="数据实体对应关系"><a href="#数据实体对应关系" class="headerlink" title="数据实体对应关系"></a>数据实体对应关系</h3><p><strong>DB对应实体：</strong>  </p>
<p>BcPort、BcEquiment 等Bc开头的实体都对应数据库的表，主要放在 com.glorysoft.bc.db.entity包</p>
<p><strong>逻辑层对应实体：</strong><br>放置在com.glorysoft.bc.entity包下</p>
<h3 id="接口的两种类型："><a href="#接口的两种类型：" class="headerlink" title="接口的两种类型："></a>接口的两种类型：</h3><ol>
<li>外部系统调用BC逻辑的接口；</li>
<li>BC逻辑处理完了给外部发送消息的接口</li>
</ol>
<h4 id="BC调用外部的接口包有："><a href="#BC调用外部的接口包有：" class="headerlink" title="BC调用外部的接口包有："></a>BC调用外部的接口包有：</h4><p>​    com.glorysoft.bc.api.client</p>
<p>​    com.glorysoft.bc.api.connection</p>
<p>​    com.glorysoft.bc.api.dao</p>
<p>​    com.glorysoft.bc.api.eqtransmitter</p>
<p>​    com.glorysoft.bc.api.host </p>
<h4 id="外部调用BC接口的包："><a href="#外部调用BC接口的包：" class="headerlink" title="外部调用BC接口的包："></a>外部调用BC接口的包：</h4><p>​    com.glorysoft.bc.api.line</p>
<p>​    com.glorysoft.bc.api.linespecial</p>
<p>​    com.glorysoft.bc.api.linksignal</p>
<p>​    com.glorysoft.bc.api.machine</p>
<p>​    com.glorysoft.bc.api.material</p>
<p>​    com.glorysoft.bc.api.mes</p>
<p>​    com.glorysoft.bc.api.mesevent</p>
<p>​    com.glorysoft.bc.api.port</p>
<p>​    com.glorysoft.bc.api.service</p>
<h2 id="bc-model-bundle"><a href="#bc-model-bundle" class="headerlink" title="bc-model-bundle"></a>bc-model-bundle</h2><p>前面我们知道了，API对实体的定义方式以及接口的开放类型。但那些主要还是为了给bc-model类做准备。</p>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><h4 id="EQP"><a href="#EQP" class="headerlink" title="EQP"></a>EQP</h4><hr>
<p>比如我们在API中只定义了一个EQP的对象，那么在 model 启动之后，如果这条线配了四个设备，那么在model中就会有四个EQP的实体；这些实体存在于 model 中的Dao中；如下图：</p>
<img src="http://photo.wushaopei.com/qiniu219.png" width="80%">

<p>在EquipmentDaoImpl 类中，存在一个 Map&lt;String,Equipment&gt;的集合类。如果一条线中存在有四个设备，那么这个 equipmentmap 中就有四个Equipment 。</p>
<h5 id="更多的接口开放："><a href="#更多的接口开放：" class="headerlink" title="更多的接口开放："></a>更多的接口开放：</h5><p>除了map 这一个用于存放 EQP的集合容器外，该接口类中还开放了多个给外部调用的接口，比如load（） 、getEquipmentByNo()等；</p>
<img src="http://photo.wushaopei.com/qiniu220.png" width="80%">



<h4 id="JOB"><a href="#JOB" class="headerlink" title="JOB"></a>JOB</h4><hr>
<p>在捞取数据时，不一定就要去DB中取，也可能仅仅是从Redis中去获取。</p>
<p>以下是 JobDaoImpl(Job对外开放的接口)的读数据的接口reload（）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动是读取Job Data From File</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018年1月18日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Job&gt; <span class="title">reload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Map&lt;String, Job&gt; map = <span class="keyword">new</span> HashMap&lt;String, Job&gt;();</span><br><span class="line">	Set&lt;String&gt; keys = RedisHelper.getKeys(redisPrefix + <span class="string">"*"</span>);</span><br><span class="line">	<span class="keyword">if</span> (keys != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">				<span class="keyword">byte</span>[] a = RedisHelper.get(key.getBytes());</span><br><span class="line">				<span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">					Job job = (Job) SerializeUtils.deSerialize(a);</span><br><span class="line">					<span class="keyword">if</span> (job != <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="keyword">if</span>(<span class="keyword">this</span>.serverName.equals(job.getLineId()) || job.isCrossLine())</span><br><span class="line">						&#123;</span><br><span class="line">							String jobNo = job.getCassetteSeqNo() + <span class="string">"_"</span> + job.getJobSeqNo();</span><br><span class="line">							map.put(jobNo, job);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="comment">// 2017-4-5 序列化失败则直接从Redis中删除</span></span><br><span class="line">						RedisHelper.del(key);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">			BCLogService.traceError(LogTag.Exception, BundleNameDefine.BC_MODEL_NAME, <span class="string">"JobDaoImpl-reload"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>当所有的卡夹都全部被取出后，checkout结束后就会抛一个状态出来，这个时候我们就会把内存里面的数据包括Redis里面的数据全部删掉，该删除操作会调用JobDaoImpl中的deleteJob（） 接口。</p>
<p><strong>内存问题-指南</strong> </p>
<p>如果程序存在内存的问题，要查看是否有glass的数据没有及时清除、残留而导致的。</p>
<h3 id="Dao的封装"><a href="#Dao的封装" class="headerlink" title="Dao的封装"></a>Dao的封装</h3><img src="http://photo.wushaopei.com/qiniu222.png" width="80%">

<p>如图所示，所有对外提供的Dao接口类都在LineModelServiceImpl类中进行了整合，可以直接通过LineModelServiceImpl类获取所要调用的对外接口。</p>
<h3 id="增量数据"><a href="#增量数据" class="headerlink" title="增量数据"></a>增量数据</h3><p>如果针对某一个实体要增加属性，只需要直接对相应的实体进行修改就行了。这里以Equipment为例，假如我们要给EQP添加一个状态 status ，可以直接在 Equipment.java中直接添加</p>
<img src="http://photo.wushaopei.com/qiniu223.png" width="80%">

<p>在pojo中添加后，就不需要对 model 层进行修改了。</p>
<h2 id="bc-service-bundle"><a href="#bc-service-bundle" class="headerlink" title="bc-service- * - bundle"></a>bc-service- * - bundle</h2><h3 id="bc-service-machine-bundle"><a href="#bc-service-machine-bundle" class="headerlink" title="bc-service-machine-bundle"></a>bc-service-machine-bundle</h3><h4 id="对OSGI的实现"><a href="#对OSGI的实现" class="headerlink" title="对OSGI的实现"></a>对OSGI的实现</h4><p>业务层中每个bundle必须实现一个OSGI提供的接口 - BundleActivator ,并实现该类的方法。</p>
<img src="http://photo.wushaopei.com/qiniu224.png" width="80%">

<p>重写的方法为 start() 和 stop() 这两个方法，其中的 getContext() 和 getExecutor () 两个方法是用于获取上下文和配置所用的。</p>
<h4 id="start-BundleContext-context"><a href="#start-BundleContext-context" class="headerlink" title="start(BundleContext context)"></a>start(BundleContext context)</h4><img src="http://photo.wushaopei.com/qiniu225.png" width="80%">

<p>在包启动过程中，会启动 bundleContext = context，同时获取上下文的数据。</p>
<h5 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h5><img src="http://photo.wushaopei.com/qiniu227.png" width="80%">

<p>在 <strong>bc-service- * -bundle</strong> 中声明了服务之后，如 AlarmServiceImpl等之后如果不进行注册，就无法被外界访问到。这一步很重要，这里通过 registerService（） 方法将服务注册到OSGI，从而实现了接口的对外开放。</p>
<h5 id="服务监听"><a href="#服务监听" class="headerlink" title="服务监听"></a>服务监听</h5><img src="http://photo.wushaopei.com/qiniu228.png" width="80%">

<p>这里主要是对服务进行监听，其监听机制是动态添加服务，即 addService（）进行添加服务，每次启动都会将服务添加到 ServiceHolder中去。</p>
<h5 id="服务的调用"><a href="#服务的调用" class="headerlink" title="服务的调用"></a>服务的调用</h5><p>在其他的逻辑层代码中，只需要通过 ServiceHolder就可以调用到对应的服务了。</p>
<h4 id="stop-BundleContext-context"><a href="#stop-BundleContext-context" class="headerlink" title="stop(BundleContext context)"></a>stop(BundleContext context)</h4><img src="http://photo.wushaopei.com/qiniu226.png" width="80%">

<p>在关闭的时候会调用类中的    alarmService.unregister(); 方法。</p>
<p><strong>以上两者可以理解为，启动时对资源进行获取和占用，关闭时需要对资源进行释放。</strong></p>
<h3 id="bc-service-recipe-bundle"><a href="#bc-service-recipe-bundle" class="headerlink" title="bc-service-recipe-bundle"></a>bc-service-recipe-bundle</h3><h4 id="涉及的业务逻辑有："><a href="#涉及的业务逻辑有：" class="headerlink" title="涉及的业务逻辑有："></a>涉及的业务逻辑有：</h4><ol>
<li>有三层timeout;</li>
<li>有三层recipe检查、MES检查、BC检查</li>
<li>以及多个方向： 如MES到BC，BC到设备，最后设备回回来，设备回回来还要和MES请求，mes再回给设备。</li>
</ol>
<h2 id="datatransmitter-bundle"><a href="#datatransmitter-bundle" class="headerlink" title="*-datatransmitter-bundle"></a>*-datatransmitter-bundle</h2><h3 id="edc-datatransmitter-bundle"><a href="#edc-datatransmitter-bundle" class="headerlink" title="edc-datatransmitter-bundle"></a>edc-datatransmitter-bundle</h3><p>当前模块主要做数据转换操作，①把model层数据转成 secs 消息或plc的消息；②把plc或secs收过来的消息转成model数据</p>
<h3 id="plc-datatransmitter-bundle"><a href="#plc-datatransmitter-bundle" class="headerlink" title="plc-datatransmitter-bundle"></a>plc-datatransmitter-bundle</h3><h4 id="消息入口"><a href="#消息入口" class="headerlink" title="消息入口"></a>消息入口</h4><p>在PLC数据处理模块中，有一个重要的类-PLCMessageDispatcher，该类实现了PLCEventDispatcher接口。在PLC模块中定义的消息处理的handler类都必须在这个类中进行注册或者说添加到handler的管理之中。具体如下：</p>
<img src="http://photo.wushaopei.com/qiniu229.png" width="80%">

<p>所有被添加到PLCMessageDispatcher中的handler都会在启动后被自动注册到中央控制器里。</p>
<img src="http://photo.wushaopei.com/qiniu230.png" width="80%">

<h4 id="数据转化"><a href="#数据转化" class="headerlink" title="数据转化"></a>数据转化</h4><h5 id="PLCMessage转为Model数据（从设备到BC的数据转换）："><a href="#PLCMessage转为Model数据（从设备到BC的数据转换）：" class="headerlink" title="PLCMessage转为Model数据（从设备到BC的数据转换）："></a>PLCMessage转为Model数据（从设备到BC的数据转换）：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunModeChangeReportBlockHandler</span> <span class="keyword">extends</span> <span class="title">MessageHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ITEM_RUNMODE = <span class="string">"RunMode"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RunModeChangeReportBlockHandler</span><span class="params">(Object sender)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(sender);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(PLCMessage msg)</span> </span>&#123;</span><br><span class="line">        TraceData trace = <span class="keyword">this</span>.getTraceData(msg);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			trace.setFlowTriggerCondi(<span class="string">"RunModeReport"</span>);</span><br><span class="line">			trace.setTrxName(<span class="string">"RunModeChangeReportBlock"</span>);</span><br><span class="line">			Equipment equipment = <span class="keyword">new</span> Equipment();</span><br><span class="line">			String value = msg.getItemValue(ITEM_RUNMODE);</span><br><span class="line">			EnumData mode = <span class="keyword">this</span>.convert2EnumData(msg, ITEM_RUNMODE, value); </span><br><span class="line">			equipment.setRunMode(mode);</span><br><span class="line">			ClientCommand clientCommand = <span class="keyword">new</span> ClientCommand();</span><br><span class="line">            trace.setcCmd(clientCommand);  </span><br><span class="line">			List&lt;Unit&gt; unitList = <span class="keyword">new</span> ArrayList&lt;Unit&gt;();</span><br><span class="line">			ServiceHolder.getBCService().process(trace, equipment, unitList);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            BCLogService.traceError(LogTag.Exception, BundleNameDefine.EQ_BUNDLE_NAME, trace.toBasicLogString(LogDirection.EQP_BCS),</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以RunModeChangeReportBlockHandler为例，需要将java传过来的实体 PLCMessage 转为对应的Model实体。</p>
<p>在这里，数据的一部分转化要先转换为TraceData已提供给执行过程中进行跟踪交互所使用。</p>
<p>然后再根据 Equitment 的实体转为相应的实体数据，这一步在不同的handler中要根据具体的handler 的业务和数据参数的具体情况来确定。</p>
<p><strong>当前handler的数据转换</strong>在这个handler中，先将msg转为EQP实体，并获取到 ITEM_RUNMODE ,通过trace中获取data数据来完成 EQP实体的数据封装和转换。</p>
<h5 id="从BC向设备发数据的转换"><a href="#从BC向设备发数据的转换" class="headerlink" title="从BC向设备发数据的转换"></a>从BC向设备发数据的转换</h5><p>比如我们BC如果要给设备发一个CIMMessage数据，那么我们需要做什么操作呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CIMMessageCommandSvrImpl</span> <span class="keyword">implements</span> <span class="title">CIMMessageCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String cimblockName = <span class="string">"CIMMessageSetCommandBlock"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String cimItemMessageID = <span class="string">"CIMMessageID"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String cimItemMessage = <span class="string">"CIMMessage"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CleanCIMMessageBlock = <span class="string">"CIMMessageClearCommandBlock"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cimMessageSetCommand</span><span class="params">(TraceData trace, CIMMessage message, String[] eqps)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"> 			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; eqps.length; i++) &#123;</span><br><span class="line">				PLCMessage msg = <span class="keyword">new</span> PLCMessage();</span><br><span class="line">				msg.setEQPName(eqps[i]);</span><br><span class="line">				msg.setName(cimblockName);</span><br><span class="line">				<span class="keyword">int</span> msgId = message.getMessageId();</span><br><span class="line">				<span class="keyword">if</span> (msgId == <span class="number">0</span>) &#123;</span><br><span class="line">				    msgId = ServiceHolder.getLineModeService().getCimMessageDao().generateCimMessageId();</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				msg.setItem(cimItemMessageID, String.valueOf(msgId));</span><br><span class="line">				msg.setItem(cimItemMessage, message.getMessageText());</span><br><span class="line">				msg.setItem(<span class="string">"TouchPanelNo"</span>, String.valueOf(message.getTouchPanelNo()));</span><br><span class="line">				</span><br><span class="line">				ConnectionManager.getConnContext().sendMessage(trace, msg);</span><br><span class="line">			&#125;</span><br><span class="line">			message.setMessageStatus(<span class="string">"SET"</span>);</span><br><span class="line">			trace.setWorkflowTraceData(<span class="number">1</span>, message);</span><br><span class="line">			trace.setWorkflowTraceData(<span class="number">2</span>, eqps);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		    BCLogService.traceError(LogTag.Exception, BundleNameDefine.EQ_BUNDLE_NAME, trace.toBasicLogString(LogDirection.BCS_EQP), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>此时，我们的初始数据是以Model 实体的形式存在，如果要发送数据给设备，需要将数据转换为相应的PLCMessage类型的数据。</p>
<p><strong>具体的方式如下：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PLCMessage msg &#x3D; new PLCMessage();</span><br><span class="line">		msg.setEQPName(eqps[i]);</span><br><span class="line">		msg.setName(cimblockName);</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>在进行数据的转换完成后，再调用相应的sendMessage（）方法将数据发送即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ConnectionManager.getConnContext().sendMessage(trace, msg);</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>以上两种数据的转换方式适用于所有的 datatransmitter 数据转换层 模块。</p>
<h2 id="db-service-bundle"><a href="#db-service-bundle" class="headerlink" title="db-service-bundle"></a>db-service-bundle</h2><p>持久层，这里主要是根据DB的列与实体类进行映射。在底层使用了一个插件来实现映射关系，不需要手动进行修改。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上是插件的依赖驱动部分，位于db模块的 pom.xml中。</p>
<p>该模块中不需要进行太多的手动代码修改或增删，其 mapper.xml文件都是根据插件自动逆向工程生成的。</p>
<h2 id="client-service-bundle"><a href="#client-service-bundle" class="headerlink" title="client-service-bundle"></a>client-service-bundle</h2><p>在 client-service-bundle 这个模块中，它也需要对 Workflow 以及 model进行监听。</p>
<img src="http://photo.wushaopei.com/qiniu231.png" width="80%">

<h4 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Add httpservice servlet</span></span><br><span class="line">servletServerThread = <span class="keyword">new</span> ServletServerThread();</span><br><span class="line"><span class="comment">// servletServerThread.setResourceConfig(jerseyConfig);</span></span><br><span class="line">httpServer = <span class="keyword">new</span> Thread(servletServerThread);</span><br><span class="line">httpServer.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add websocket servlet</span></span><br><span class="line">Thread webSocketServer = <span class="keyword">new</span> Thread(<span class="keyword">new</span> WebSocketServletThread());</span><br><span class="line">webSocketServer.start();</span><br></pre></td></tr></table></figure>

<p>这里需要启动 httpservice \ websocket </p>
<h5 id="httpServer配置"><a href="#httpServer配置" class="headerlink" title="httpServer配置"></a>httpServer配置</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletServerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>  Server httpServer;</span><br><span class="line">	<span class="keyword">private</span>  ResourceConfig resourceConfig;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> hostPort = <span class="number">8081</span>;</span><br><span class="line">    ……</span><br></pre></td></tr></table></figure>

<p>这里的HttpService 的端口号是写死的。</p>
<h5 id="webSocket配置"><a href="#webSocket配置" class="headerlink" title="webSocket配置"></a>webSocket配置</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketServletThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> hostPort = <span class="number">8085</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Server wsserver;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>这里的WebSocket 的端口号也是写死的。</p>
<h2 id="重点：启动器-felix"><a href="#重点：启动器-felix" class="headerlink" title="重点：启动器 - felix"></a>重点：启动器 - felix</h2><p>启动类的模块是 felixlaunch</p>
<h3 id="启动规则："><a href="#启动规则：" class="headerlink" title="启动规则："></a>启动规则：</h3><p> 该项目是基于OSGI平台搭建的，其启动也必须基于OSGI平台来实现，具体的启动步骤为：</p>
<p>​    1. 启动OSGI平台；</p>
<p>​    2. 由OSGI平台加载项目的bundle；</p>
<h4 id="启动的主要对象："><a href="#启动的主要对象：" class="headerlink" title="启动的主要对象："></a>启动的主要对象：</h4><img src="http://photo.wushaopei.com/qiniu232.png" width="80%">

<h4 id="启动流程："><a href="#启动流程：" class="headerlink" title="启动流程："></a>启动流程：</h4><p>默认先加载 conf 目录下的 config.propertiees 配置文件，主要加载的内容为下图中所示的</p>
<p>felix.auto.start.1 开始的所有file文件的jar包</p>
<img src="http://photo.wushaopei.com/qiniu233.png" width="80%">

<p>并且根据配置文件默认加载指定目录下的bundle，如下图所示：</p>
<img src="http://photo.wushaopei.com/qiniu234.png" width="80%">

<h5 id="jar启动顺序："><a href="#jar启动顺序：" class="headerlink" title="jar启动顺序："></a>jar启动顺序：</h5><p>​    先启动model 层，再启动service层，再启动数据转换层。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="DB层配置"><a href="#DB层配置" class="headerlink" title="DB层配置"></a>DB层配置</h4><p>这里包括DB和Redis 的配置文件，即 mybatis-config.xml 、redis.properties 两个配置文件。</p>
<h4 id="线启动配置"><a href="#线启动配置" class="headerlink" title="线启动配置"></a>线启动配置</h4><p>该配置文件为startup.properties ，需要修改的主要为 serverName ，即要启动的那条线的线名。</p>
<h3 id="Workflows"><a href="#Workflows" class="headerlink" title="Workflows"></a>Workflows</h3><h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>自动化开发（一）BC架构讲解</title>
    <url>/2020/03/24/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89BC%E6%9E%B6%E6%9E%84%E8%AE%B2%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="BC项目架构图"><a href="#BC项目架构图" class="headerlink" title="BC项目架构图"></a>BC项目架构图</h2><img src="http://photo.wushaopei.com/qiniu215.png" width="100%">

<h2 id="整个BC项目的架构层次分别为："><a href="#整个BC项目的架构层次分别为：" class="headerlink" title="整个BC项目的架构层次分别为："></a>整个BC项目的架构层次分别为：</h2><ul>
<li>前端      (BC Client(WEB)  、 BC Monitor(WEB))</li>
<li>服务        ( OSGI Bundles服务)</li>
<li>Workflow   (WorkflowRuntime，整体包括 Workflow API and Interchange Formats)</li>
<li>接口层     (BC Server ，从Redis DB中加载产线Run货数据与 Host/EQP端交互、分发)</li>
<li>数据源  (分为Redis DB 、Postgresql DB)</li>
<li>硬件      (下游设备： 包含但不限于 HSMS 、EIP、Cclink板卡、设备PLC)</li>
</ul>
<h2 id="数据发布流程："><a href="#数据发布流程：" class="headerlink" title="数据发布流程："></a>数据发布流程：</h2><h3 id="数据的入口："><a href="#数据的入口：" class="headerlink" title="数据的入口："></a>数据的入口：</h3><p>数据从<strong>WEB</strong>层进入后，首先进入到的是<strong>Workflow</strong> </p>
<h4 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h4><ol>
<li>怎么和workflow串起来？</li>
<li>怎么定位到workflow的？</li>
</ol>
<h4 id="Workflow-的主要功能："><a href="#Workflow-的主要功能：" class="headerlink" title="Workflow 的主要功能："></a>Workflow 的主要功能：</h4><pre><code>`将各个逻辑给串起来`,Workflow 将各个服务的接口给串连起来。</code></pre><h3 id="数据的处理："><a href="#数据的处理：" class="headerlink" title="数据的处理："></a>数据的处理：</h3><p>数据从上层发布到下层，都是通过接口实现的。然后再经由接口的实现类方法将数据写入到底层的DB(Redis或Postgre)中去。</p>
<h3 id="前后端关系："><a href="#前后端关系：" class="headerlink" title="前后端关系："></a>前后端关系：</h3><p>前后端是分离开的，后端在没有使用前端的情况下是可以独立运行的。</p>
<h2 id="交互结构："><a href="#交互结构：" class="headerlink" title="交互结构："></a>交互结构：</h2><img src="http://photo.wushaopei.com/qiniu216.png" width="100%">

<p><strong>上游</strong>： MES Simulator</p>
<p><strong>中间层</strong>： BC </p>
<p><strong>下游</strong>： PLC Simulator  </p>
<p>​             HSMS Simulator</p>
<p><strong>模拟器：</strong>  测试环境与开发环境中，MES 和PLC 都使用模拟器（Simulator）。</p>
<p><strong>模拟规则：</strong> </p>
<p>PLC 将数据写入到Redis数据库中，BC到Redis数据库中去取数据，从而实现对PLC硬件的模拟。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>mybatis 简介（三）Hibernate</title>
    <url>/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%89%EF%BC%89Hibernate/</url>
    <content><![CDATA[<h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>​    基于JDBC在企业级开发过程中频繁建立连接等对资源与性能无法兼顾的弊端。</p>
<p>​    基于这个需求，互联网企业Sun公司推出了一个ORM模型框架——Hibernate 。</p>
<h2 id="Hiberate"><a href="#Hiberate" class="headerlink" title="Hiberate"></a>Hiberate</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Hibernate 是建立在若干POJO通过XML映射文件（或注解）提供的规则映射到数据库表上的。换句话说，我们可以通过POJO直接操作数据库的数据。它提供的是一种全表映射的模型。</p>
<h3 id="回顾一下JDBC写程序的历程"><a href="#回顾一下JDBC写程序的历程" class="headerlink" title="回顾一下JDBC写程序的历程"></a>回顾一下JDBC写程序的历程</h3><ol>
<li><strong>在DAO层操作XML，将数据封装到XML文件上，读写XML文件数据实现CRUD</strong></li>
<li><strong>在DAO层使用原生JDBC连接数据库，实现CRUD</strong></li>
<li><strong>再调用JDBC的Connection\Statement\ResultSet等对象实现对DB的操作和事务管理</strong></li>
</ol>
<h3 id="Hibernate-开发流程示意图"><a href="#Hibernate-开发流程示意图" class="headerlink" title="Hibernate 开发流程示意图"></a>Hibernate 开发流程示意图</h3><img src="http://photo.wushaopei.com/qiniu243.png" width="80%">

<p>相对而言，Hibernate对JDBC 的封装程度还是比较高的，我们已经不需要编写SQL语言，只要使用HQL语言就可以了。</p>
<h3 id="Hibernate-的优缺点"><a href="#Hibernate-的优缺点" class="headerlink" title="Hibernate 的优缺点"></a>Hibernate 的优缺点</h3><ol>
<li><p>hibernate在配置好关系后，可直接对对象进行操作，让使用会话对象的方法实现对数据库的crud操作，而mybatis则需要手动编写sql语句，这样一对比，hibernate的开发速度要优于mybatis,但同时问题也出现了，在面对一些高级查询时，hibernate则是显得有些力不从心了，hibernate的sql语句是写死的，有时候一些字段我们并不需要查询或者修改，但是他封装的是全部，虽然我们可以手动设置字段，但是却破坏了hibernate的简洁性。而mybatis则可以自己手动编写sql进行优化，且有动态sql的功能，可以优化sql. </p>
</li>
<li><p>hibernate有自己的缓存机制，mybatis则没有，而现在大多数都是使用第三方缓存，所以这个优点已被抹去。</p>
</li>
<li><p>hibernate相对来说是重量级的，入门门槛高，而mybatis则是轻量级封装jdbc,可以现学现用。</p>
</li>
</ol>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（二）ORM 模型</title>
    <url>/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%8C%EF%BC%89ORM-%E6%A8%A1%E5%9E%8B-1/</url>
    <content><![CDATA[<p>​    由于JDBC存在的缺陷，在实际工作中我们很少使用JDBC进行编程，于是提出了对 象关系映射(0可ect Relational Mapping,简称 0RM,或者 O/RM,或者 0/R mapping)。那 什么是ORM模型呢？ </p>
<p>​    简单地说，ORM模型就是数据库的表和简单Java对象(Plain Ordinary Java Object, 简称POJO)的映射关系模型，它主要解决数据库数据和POJO对象的相互映射。我们通过 这层映射关系就可以简单迅速地把数据库表的数据转化为POJO,以便程序员更加容易理解 和应用Java程序，如下图所示。</p>
<img src="http://photo.wushaopei.com/qiniu214.png" width="80%">

<p>有了 ORM模型，在大部分情况下，程序员只需要了解 java 应用而无需对数据库相关 知识深入了解，便可以写出通俗易懂的程序。此外，ORM模型提供了统一的规则使得数据 库的数据通过配置便可轻易映射到POJO上。</p>
<p>其好处有以下几点：</p>
<table>
<thead>
<tr>
<th>优点</th>
<th>体现</th>
</tr>
</thead>
<tbody><tr>
<td>易用性</td>
<td>使用ORM做数据库的开发可以有效的减少重复SQL语句的概率，写出来的模型也更加直观、清晰。</td>
</tr>
<tr>
<td>性能损耗小</td>
<td>ORM转换成底层数据库操作指令确实会有一些开销。但从实际的情况来看，这种性能损耗很少（不足5%），只要不是对性能有严苛的要求，综合考虑开发效率、代码的阅读性，带来的好处要远远大于性能损耗，而且项目越大作用越明显。</td>
</tr>
<tr>
<td>设计灵活</td>
<td>可以轻松的写出复杂的查询。</td>
</tr>
<tr>
<td>可移植性</td>
<td>mybatis封装了底层的数据库实现，支持多个关系数据库引擎，包括流行的MySQL、PostgreSQL和SQServer。可以非常轻松的切换数据库。</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（五）并发模拟-工具</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%94%EF%BC%89%E5%B9%B6%E5%8F%91%E6%A8%A1%E6%8B%9F-%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<h2 id="并发模拟——工具"><a href="#并发模拟——工具" class="headerlink" title="并发模拟——工具"></a>并发模拟——工具</h2><h3 id="常用工具："><a href="#常用工具：" class="headerlink" title="常用工具："></a>常用工具：</h3><p>  <strong>Postman</strong> : Http请求模拟工具</p>
<p>  <strong>Apache Bench</strong> （<strong>AB</strong>） ： Apache附带的工具，测试网站性能</p>
<p>  <strong>JMeter</strong> : Apache 组织开发的压力测试工具</p>
<blockquote>
<p><strong>代码</strong>： Semaphore 、CountDownLatch等</p>
</blockquote>
<h3 id="并发模拟——POSTMAN"><a href="#并发模拟——POSTMAN" class="headerlink" title="并发模拟——POSTMAN"></a>并发模拟——POSTMAN</h3><img src="http://photo.wushaopei.com/qiniu190.png" width="80%">

<h4 id="创建测试接口："><a href="#创建测试接口：" class="headerlink" title="创建测试接口："></a><strong>创建测试接口：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> TestController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 15:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="新建测试用用户组："><a href="#新建测试用用户组：" class="headerlink" title="新建测试用用户组："></a>新建测试用用户组：</h4><p><strong>使用POSTMAN模拟并发：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu191.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu192.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu193.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu194.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu195.png" width="80%">

<h4 id="执行Run-Concurrency按钮："><a href="#执行Run-Concurrency按钮：" class="headerlink" title="执行Run Concurrency按钮："></a><strong>执行Run Concurrency按钮：</strong></h4><img src="http://photo.wushaopei.com/qiniu196.png" width="80%">



<h3 id="使用专业并发模拟测试工具——Apache-Bench-AB"><a href="#使用专业并发模拟测试工具——Apache-Bench-AB" class="headerlink" title="使用专业并发模拟测试工具——Apache Bench(AB)"></a>使用专业并发模拟测试工具——Apache Bench(AB)</h3><img src="http://photo.wushaopei.com/qiniu197.png" width="80%">

<p><strong>使用ab命令指定每秒的请求数和间隔时间以及请求接口地址</strong> </p>
<img src="http://photo.wushaopei.com/qiniu198.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu199.png" width="80%">

<h3 id="压测工具JMeter"><a href="#压测工具JMeter" class="headerlink" title="压测工具JMeter:"></a>压测工具JMeter:</h3><img src="http://photo.wushaopei.com/qiniu200.png" width="80%">

<p><strong>jmeter</strong>文件目录下文件概览： </p>
<img src="http://photo.wushaopei.com/qiniu201.png" width="80%">

<p><strong>启动方式：</strong> </p>
<blockquote>
<p>linux环境使用<strong>jmeter.sh</strong>启动脚本测试</p>
<p>Windows环境使用<strong>jmeter.bat</strong>启动脚本测试</p>
</blockquote>
<p><strong>使用界面：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu202.png" width="80%">

<p><strong>Ramp-Up Period</strong> 代表虚拟用户增长时长，可理解为一段时间内多个用户登录的总时间范围，如8点15到9点这段时间是打卡上班的时间，也就是45分钟*60秒=2700秒 </p>
<p><strong>添加HTTP请求：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu203.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu204.png" width="70%">

<p><strong>添加监听窗口-图形结果和察看结果树</strong> </p>
<img src="http://photo.wushaopei.com/qiniu205.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu206.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu207.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu208.png" width="70%">

<p><strong>点击绿色三角按钮启动HTTP请求</strong> </p>
<img src="http://photo.wushaopei.com/qiniu209.png" width="70%">

<p><strong>请求响应结果查看：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu210.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu211.png" width="70%">



<h2 id="并发模拟-代码"><a href="#并发模拟-代码" class="headerlink" title="并发模拟-代码"></a>并发模拟-代码</h2><h3 id="CountDownLatch-计数器向下减的闭锁"><a href="#CountDownLatch-计数器向下减的闭锁" class="headerlink" title="CountDownLatch (计数器向下减的闭锁)"></a>CountDownLatch (计数器向下减的闭锁)</h3><img src="http://photo.wushaopei.com/qiniu212.png" width="70%">

<p>案例解析该类的使用： 假设计数器值 cnt = 3, 线程A在调用了await()方法之后，当前线程就进入了等待状态awaiting；之后在其他进程中每次执行countDown()方法（如T1）之后计数器 cnt 就会减一，然后当前线程继续执行；之后的T2、T3一次执行完成，当计数器 cnt 变成 0之后，线程A才会继续执行。</p>
<p><strong>说明： CountDownLatch这个类可以阻塞线程，并在满足某种特定条件下去执行。</strong></p>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><img src="http://photo.wushaopei.com/qiniu213.png" width="70%">

<p>假如一条公路上只有两条车道，那么同时只有两辆车可以通过同一个点；当两辆车中的其中一辆车让开以后，其他的等待的车就可以继续通过了。</p>
<p><strong>说明： Semaphore可以阻塞进程，并且可以控制同一时间请求的并发量</strong></p>
<blockquote>
<p><strong>CountDownLatch 和 Semaphore 通常会和线程池一起使用</strong></p>
</blockquote>
<h3 id="并发模拟"><a href="#并发模拟" class="headerlink" title="并发模拟"></a>并发模拟</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ConcurrencyTest</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 16:50</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span> <span class="comment">//该标识表示当前线程及线程池的并发处理使用方式不正确，建议不要这么写</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencyTest</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<p>第一次</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">16:58:27.063 [main] INFO com.mmall.concurrency.ConcurrencyTest - count:4944</span><br><span class="line"> </span><br><span class="line">Process finished <span class="keyword">with</span> <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>第二次： </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">16:59:48.185 [main] INFO com.mmall.concurrency.ConcurrencyTest - count:4938</span><br><span class="line"> </span><br><span class="line">Process finished <span class="keyword">with</span> <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：程序执行结果数量少于5000，并且每次都不同。所以这是不确定的结果，<strong>存在线程安全的问题。</strong> </p>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a><strong>小结：</strong></h3><p>  <strong>Postman</strong> : Http请求模拟工具</p>
<p>  <strong>Apache Bench(AB)</strong>：Apache附带的工具，测试网站性能</p>
<p>  <strong>JMeter</strong> ： Apache组织开发的压力测试工具</p>
<p>  <strong>代码</strong>： Semaphore、CountDownLatch等</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发模拟</tag>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（四）并发案例-环境搭建</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%9B%9B%EF%BC%89%E5%B9%B6%E5%8F%91%E6%A1%88%E4%BE%8B-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h2 id="案例环境初始化"><a href="#案例环境初始化" class="headerlink" title="案例环境初始化"></a>案例环境初始化</h2><h3 id="环境搭建与准备"><a href="#环境搭建与准备" class="headerlink" title="环境搭建与准备"></a>环境搭建与准备</h3><p>Spring Boot 项目，<a href="https://start.spring.io/" target="_blank" rel="noopener">https://start.spring.io/</a></p>
<p>Git 管理代码，<a href="https://github.com/wushaopei/concurrency" target="_blank" rel="noopener">https://github.com/wushaopei/concurrency</a></p>
<p>码云：<a href="https://gitee.com/wushaopei/concurrency" target="_blank" rel="noopener">https://gitee.com/wushaopei/concurrency</a></p>
<img src="http://photo.wushaopei.com/qiniu187.png" width="70%">

<p><strong>点击Generate -Ctrl + 将项目下载到本地，并解压。</strong></p>
<p>使用git bash 将码云仓库下载到本地：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://gitee.com/wushaopei/concurrency.git</span><br></pre></td></tr></table></figure>

<p>将concurrency.zip压缩包解压后的src、mvnw.cmd、mvnw、pom.xml文件复制到git仓库目录concurrency下， </p>
<img src="http://photo.wushaopei.com/qiniu188.png" width="70%">

<p>配置依赖驱动，加载项目 </p>
<img src="http://photo.wushaopei.com/qiniu189.png" width="70%">



<h2 id="案例准备工作"><a href="#案例准备工作" class="headerlink" title="案例准备工作"></a>案例准备工作</h2><h3 id="自定义注解ThreadSafe-java类，用于标识线程安全的类："><a href="#自定义注解ThreadSafe-java类，用于标识线程安全的类：" class="headerlink" title="自定义注解ThreadSafe.java类，用于标识线程安全的类："></a>自定义注解ThreadSafe.java类，用于标识线程安全的类：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ThreadSafe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 14:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 用来标记线程安全的类或写法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ThreadSafe &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义注解NoThreadSafe-java类，用于标识线程不安全的类："><a href="#自定义注解NoThreadSafe-java类，用于标识线程不安全的类：" class="headerlink" title="自定义注解NoThreadSafe.java类，用于标识线程不安全的类："></a>自定义注解NoThreadSafe.java类，用于标识线程不安全的类：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> NoThreadSafe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 14:44</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 用来标记线程不安全的类或写法</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NoThreadSafe &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用来标记-不推荐-的类或者写法"><a href="#用来标记-不推荐-的类或者写法" class="headerlink" title="用来标记 不推荐 的类或者写法"></a>用来标记 不推荐 的类或者写法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用来标记 不推荐 的类或者写法</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NoRecommend &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Recommend-java-用来标记-推荐-的类或者写法"><a href="#Recommend-java-用来标记-推荐-的类或者写法" class="headerlink" title="Recommend.java 用来标记 推荐 的类或者写法"></a>Recommend.java 用来标记 推荐 的类或者写法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用来标记 推荐 的类或者写法</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Recommend &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发案例</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（三）并发基础-Java内存模型</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<h2 id="JAVA内存模型"><a href="#JAVA内存模型" class="headerlink" title="JAVA内存模型"></a>JAVA内存模型</h2><h3 id="Java内存模型（Java-Memory-Model-JMM）"><a href="#Java内存模型（Java-Memory-Model-JMM）" class="headerlink" title="Java内存模型（Java Memory Model,JMM）"></a>Java内存模型（Java Memory Model,JMM）</h3><img src="http://photo.wushaopei.com/qiniu183.png" width="70%">

<p><strong>Java内存模型规范</strong>：规定了一个线程如何和何时可以看到由其他线程修改过后的共享变量的值，以及在必须时如何同步的访问共享变量。</p>
<p><strong>Java内存模型</strong>：Java里的堆是一个运行时数据区，堆是由垃圾回收来负责的，堆的优势是可以动态的分配内存大小，生成期也不必告诉编译器。因为它是在运行时动态分配内存的。Java收集器会自动搜索这些不再使用的数据。</p>
<p>其<strong>缺点</strong>是，由于是在运行时动态分配内存，因此它的存取速度相对慢一些.</p>
<p><strong>Java的栈(stack)，</strong>优势是存取数据的速度要比堆快，仅次于计算机里的寄存器，栈的数据是可以共享的；</p>
<p><strong>缺点</strong>是存在栈中的数据大小与生存期必须是确定的，缺乏一些灵活性，栈中主要存放一些基本类型的变量，比如int、short、float、double、char和对象句柄</p>
<p>Java内存模型要求调用栈和本地变量存放在线程栈上，而Thread stack对象则存放在堆上。</p>
<p>一个本地变量有可能指向一个<strong>对象的引用</strong>，这种情况下，引用这个本地变量是存放在这个线程栈上，但是对象本身是存放在堆上的；一个对象，它可能包含方法(methodOne()、method Two()),</p>
<h3 id="Java内存模型抽象结构图"><a href="#Java内存模型抽象结构图" class="headerlink" title="Java内存模型抽象结构图"></a>Java内存模型抽象结构图</h3><img src="http://photo.wushaopei.com/qiniu184.png" width="70%">

<p>线程A在操作共享变量时，是从主存中复制共享变量的副本到本地内存中，进行逻辑修改后，再将副本同步到主存中；并发环境下，线程A将副本修改后要同步到主存中时，线程B可能刚好将主存的共享变量同步到本地内存B中进行逻辑修改。而这是很不安全的。因为线程B所操作的共享变量相对线程A来说是已经过期的值，这会导致后续的一系列运算都是基于错误的基础上执行的。</p>
<p><strong>解决思路</strong>： 对线程A和线程B进行加锁，在主存共享变量进行副本复制后就不再允许其他线程操作，即实现线程的同步操作。从而解决并发线程的读写安全问题。</p>
<h3 id="Java内存模型-同步八种操作"><a href="#Java内存模型-同步八种操作" class="headerlink" title="Java内存模型 - 同步八种操作"></a>Java内存模型 - 同步八种操作</h3><table>
<thead>
<tr>
<th><strong>lock （锁定）</strong></th>
<th>作用域主内存的变量</th>
<th>把一个变量标识为一条线程独占状态</th>
</tr>
</thead>
<tbody><tr>
<td><strong>unlock （解锁）</strong></td>
<td><strong>作用于主内存的变量</strong></td>
<td><strong>把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定</strong></td>
</tr>
<tr>
<td><strong>read（读取）</strong></td>
<td><strong>作用域主内存的变量，</strong></td>
<td><strong>把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用</strong></td>
</tr>
<tr>
<td><strong>load（载入）</strong></td>
<td><strong>作用于工作内存的变量</strong></td>
<td><strong>它把read操作从主内存中得到的变量值放入工作内存的变量副本中</strong></td>
</tr>
<tr>
<td><strong>use （使用）</strong></td>
<td><strong>作用域工作内存的变量</strong></td>
<td><strong>把工作内中的一个变量值传递给执行引擎</strong></td>
</tr>
<tr>
<td><strong>assign（赋值）</strong></td>
<td><strong>作用于工作内存的变量</strong></td>
<td><strong>把一个从执行引擎接收到的值赋值给工作内存的变量</strong></td>
</tr>
<tr>
<td><strong>store （存储）</strong></td>
<td><strong>作用于工作内存的变量</strong></td>
<td><strong>把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作</strong></td>
</tr>
<tr>
<td><strong>write（写入）</strong></td>
<td><strong>作用于主内存的变量</strong></td>
<td><strong>把store操作从工作内存中一个变量的值传送到主内存的变量中</strong></td>
</tr>
</tbody></table>
<h3 id="Java内存模型-同步规则"><a href="#Java内存模型-同步规则" class="headerlink" title="Java内存模型 - 同步规则"></a>Java内存模型 - 同步规则</h3><ol>
<li><p>如果要把一个变量从主内存中复制到工作内存，就需要按顺序地执行read和load操作，如果把变量从工作内存中同步回主内存中，就要按顺序地执行store和write操作。但Java内存模型值要求上述操作必须按顺序执行，而没有保证必须是连续执行；</p>
</li>
<li><p>不允许read和load、store和write操作之一单独出现；</p>
</li>
<li><p>不允许一个线程丢弃它的最近assign的操作，即变量在工作内存中改变了之后必须同步到主内存中；</p>
</li>
<li><p>不允许一个线程无原因地（没有发生过任何assign操作）把数据从工作内存同步回主内存中；</p>
</li>
<li><p>一个新的变量只能在主内存中诞生，不允许在工作内存中直接使用一个未被初始化（load或assign的）变量。即就是对一个变量实施use和store操作之前，必须先执行过了assign和load操作；</p>
</li>
<li><p>一个变量在同一时刻只允许一条线程对其进行lock操纵，但lock操作可以被同一条线程重复执行富哦次，多次执行lock后，只有执行相同次数的unlock操作，变量才会被解锁。lock和unlock必须成对出现；</p>
</li>
<li><p>如果对一个变量执行lock操作，将会清空工作内存中此变量的值，在执行引擎使用这个变量前需要重新执行load或assign操作初始化变量的值；</p>
</li>
<li><p>如果一个变量事先没有被lock操作锁定，则不允许对它执行unlock操作；也不允许去unlock一个被其他线程锁定的变量；</p>
<p>对一个变量执行unlock操作之前，必须先把次变量同步到主内存中（执行store和write操作）</p>
</li>
</ol>
<h3 id="Java内存模型-执行流程图："><a href="#Java内存模型-执行流程图：" class="headerlink" title="Java内存模型 - 执行流程图："></a>Java内存模型 - 执行流程图：</h3><img src="http://photo.wushaopei.com/qiniu185.png" width="70%">



<h2 id="并发的优势与风险"><a href="#并发的优势与风险" class="headerlink" title="并发的优势与风险"></a>并发的优势与风险</h2><img src="http://photo.wushaopei.com/qiniu186.png" width="70%">

<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a><strong>小结：</strong></h3><blockquote>
<ol>
<li>CPU多级缓存：缓存一致性、乱序执行优化</li>
<li>Java内存模型： JMM规定、抽象结构、同步八种操作及规则</li>
<li>Java并发的优势与风险</li>
</ol>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二）并发基础-CPU多级缓存机制</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80-CPU%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h2 id="CPU多级缓存-缓存一致性"><a href="#CPU多级缓存-缓存一致性" class="headerlink" title="CPU多级缓存-缓存一致性"></a>CPU多级缓存-缓存一致性</h2><h3 id="CPU多级缓存"><a href="#CPU多级缓存" class="headerlink" title="CPU多级缓存"></a>CPU多级缓存</h3><img src="http://photo.wushaopei.com/qiniu178.png" width="60%">

<p>​    上图展示的是CPU高级缓存的配置，数据的读取和存储都经过高速缓存，CPU核心与高速缓存之间有一条特殊的快速通道；在这个简化的图中，主存和缓存都连接在系统总线上，这条总线同时还用于其他组件的通信。 </p>
<img src="http://photo.wushaopei.com/qiniu179.png" width="60%">

<p>​    高速缓存出现后不久，系统变得更加复杂，高速缓存和主存之间的速度差异被拉大，直到加入L1d（又叫一级缓存）的缓存，新加入的这一个缓存比高速缓存更大，但是更慢，由于加大一级缓存的做法从经济上是行不通的。所以有了二级缓存。甚至，现在有些系统有了三级缓存。 </p>
<h3 id="CPU-cache"><a href="#CPU-cache" class="headerlink" title="CPU cache:"></a>CPU cache:</h3><h4 id="为什么需要CPU-cache？"><a href="#为什么需要CPU-cache？" class="headerlink" title="为什么需要CPU cache？"></a>为什么需要CPU cache？</h4><p>​    CPU的频率太快了，快到主存跟不上，这样在处理器时钟周期内，CPU常常需要等待主存，浪费资源。所以cache的出现，是为了缓解CPU和内存之间速度的不匹配问题（结构： CPU -&gt; cache - &gt;memory ）. </p>
<h4 id="CPU-cache-有什么意义？"><a href="#CPU-cache-有什么意义？" class="headerlink" title="CPU cache 有什么意义？"></a>CPU cache 有什么意义？</h4><blockquote>
<p> 1）时间局部性： 如果某个数据被访问，那么在不久的将来它很可能被再次访问；</p>
<p> 2）空间局部性： 如果某个数据被访问，那么与它相邻的数据很快也可能被访问；</p>
</blockquote>
<h3 id="CPU多级缓存-缓存一致性（MESI）"><a href="#CPU多级缓存-缓存一致性（MESI）" class="headerlink" title="CPU多级缓存 - 缓存一致性（MESI）"></a>CPU多级缓存 - 缓存一致性（MESI）</h3><p><strong>用于保证多个CPU cache之间缓存共享数据的一致</strong> </p>
<img src="http://photo.wushaopei.com/qiniu180.png" width="60%">

<p>*<em>M *</em> 代表 <code>modify</code>  ,表示被修改；指的是该缓存行只被缓存在该CPU的缓存中，并且是被修改过的，因此，它与主存中的数据是不一致的，该缓存中的内存需要在未来的某个时间点写回主存；这个时间点我们是允许其他CPU读取主存中相应的内存之间的值，当这里的值被写回主存之后，该缓存行的状态会变成E的状态；</p>
<p><strong>E</strong> 代表 <code>Exclusive</code>  ,表示独享状态；该状态下的缓存行只被缓存在该CPU的缓存中，它是未被修改过的，是与主存中的数据一直的，这个状态可以在任意时刻，当有其他读取该内存时，变成共享状态，即S;    同样，当CPU修改该缓存行时，该缓存行状态可以被修改为M 的状态。</p>
<p><strong>S</strong> 代表  <code>share</code>，代表共享的意思；该状态意味着该缓存行可能被多个CPU进行缓存，并且各个缓存数据和主存数据是一致的，当有一个CPU修改该缓存行时，其他CPU所有的缓存行是可以被作废的，变成I 的状态；</p>
<p><strong>I</strong> 代表 <code>invalid</code>，表示无效的；代表该缓存行是无效的，有其他CPU修改了该缓存行。</p>
<p><strong>四种操作：</strong></p>
<p><strong>local read</strong> 代表读本地缓存中的数据</p>
<p><strong>local write</strong> 代表将数据写到本地缓存中</p>
<p><strong>remote read</strong>   代表将内存中的数据读取过来，</p>
<p><strong>remote write</strong> 代表将数据写回到主存中</p>
<p><strong>状态转换示意图：</strong></p>
<img src="http://photo.wushaopei.com/qiniu181.png" width="60%">



<h2 id="CPU多级缓存-乱序执行优化"><a href="#CPU多级缓存-乱序执行优化" class="headerlink" title="CPU多级缓存 - 乱序执行优化"></a>CPU多级缓存 - 乱序执行优化</h2><h3 id="意义："><a href="#意义：" class="headerlink" title="意义："></a>意义：</h3><p>​    <code>处理器为提高运算速度而做出违背代码原有顺序的优化</code></p>
<img src="http://photo.wushaopei.com/qiniu182.png" width="60%">

<p><strong>a :</strong> 数据写入顺序，先写入a=10，再写入b=200,最后计算a*b的值</p>
<p><strong>b :</strong> 乱序执行的执行顺序：先执行b=200,再执行a=10，单核情况下不做任何影响。</p>
<blockquote>
<p> <font color=red>多核心</font>的情况下，可能由于乱序而导致各个核所写入数据的最终计算结果与预想的结果不一致。 </p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
        <tag>CPU多级缓存</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（一）概念引入与并发场景</title>
    <url>/2020/03/23/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89%E6%A6%82%E5%BF%B5%E5%BC%95%E5%85%A5%E4%B8%8E%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF/</url>
    <content><![CDATA[<h3 id="涉及的基础知识与核心知识："><a href="#涉及的基础知识与核心知识：" class="headerlink" title="涉及的基础知识与核心知识："></a>涉及的基础知识与核心知识：</h3><img src="http://photo.wushaopei.com/qiniu176.png" width="60%">



<h3 id="并发及并发的线程安全处理"><a href="#并发及并发的线程安全处理" class="headerlink" title="并发及并发的线程安全处理"></a>并发及并发的线程安全处理</h3><img src="http://photo.wushaopei.com/qiniu177.png" width="60%">



<h3 id="并发编程的基本概念"><a href="#并发编程的基本概念" class="headerlink" title="并发编程的基本概念"></a>并发编程的基本概念</h3><p> <strong>并发</strong>： 同时拥有两个或者多个线程，如果程序在单核处理器上运行，多个线程将交替地换入或换出内存，这些线程是同时 “ 存在” 的 ，每个线程都处于执行过程中的某个状态，如果运行在多核处理器上，此时，程序中的每个线程都将分配到一个处理器核上，因此可以同时运行。</p>
<p><strong>高并发：</strong> 并发（High Concurrency） 是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计保证系统能够同时并行处理很多请求。</p>
<p><strong>并发与高并发的区别：</strong></p>
<p> <strong>并发：</strong>  多个线程操作相同的资源，保证线程安全，合理使用资源</p>
<p>  <strong>高并发：</strong> 服务能同时处理很多请求，提高程序性能</p>
<h3 id="简单的并发业务场景"><a href="#简单的并发业务场景" class="headerlink" title="简单的并发业务场景"></a>简单的并发业务场景</h3><h4 id="实现一个计数功能"><a href="#实现一个计数功能" class="headerlink" title="实现一个计数功能"></a>实现一个计数功能</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.count;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.NotThreadSafe;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 创建可缓存线程池</span></span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="comment">// 使用countDownLatch计数管理并发请求数</span></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">00</span>:<span class="number">37.322</span> [main] INFO com.mmall.concurrency.example.count.CountExample1 - count:<span class="number">4994</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>将线程修改为1时，count为5000:</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 同时并发执行的线程数</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><strong>结果如下：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">02</span>:<span class="number">37.170</span> [main] INFO com.mmall.concurrency.example.count.CountExample1 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><font color=red>注意：</font>这里可以引发出一个问题，当我们在编写程序时，在本地进行测试时，只有一个进程，并且基本处于单线程环境下，而当项目部署上线后，项目登录、使用的用户绝不止一个用户，此时，会存在并发的情况，即同一服务进程下，多个用户的客户端操作线程进行请求服务器，此时，就可能由于服务器的响应问题等导致对部分客户端的请求响应中断、丢包等问题。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>原码，反码，补码的深入理解与原理</title>
    <url>/2020/03/23/%E5%8E%9F%E7%A0%81%EF%BC%8C%E5%8F%8D%E7%A0%81%EF%BC%8C%E8%A1%A5%E7%A0%81%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%B8%8E%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="计算机符号构成"><a href="#计算机符号构成" class="headerlink" title="计算机符号构成"></a>计算机符号构成</h2><p>​    计算机中的有符号数有三种表示方法，即<a href="https://baike.baidu.com/item/%E5%8E%9F%E7%A0%81/1097586" target="_blank" rel="noopener">原码</a>、<a href="https://baike.baidu.com/item/%E5%8F%8D%E7%A0%81/769985" target="_blank" rel="noopener">反码</a>和补码。三种表示方法均有符号位和数值位两部分，符号位都是用0表示“正”，用1表示“负”，而数值位，三种表示方法各不相同 。</p>
<p>​    在<a href="https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA/140338" target="_blank" rel="noopener">计算机</a>系统中，数值一律用补码来表示和存储。原因在于，使用补码，可以将符号位和数值域统一处理；同时，加法和减法也可以统一处理  。 </p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>​    <strong>原码</strong>就是符号位加上真值的绝对值， 即用第一位表示符号， 其余位表示值。  </p>
<p>​    <strong>反码</strong>的表示方法是:<strong>正数的反码</strong>是其本身；<strong>负数的反码</strong>是在其原码的基础上， 符号位不变，其余各个位取反。  </p>
<p>​    <strong>补码</strong>的表示方法是:<strong>正数的补码</strong>就是其<strong>本身</strong>；<strong>负数的补码</strong>是在其原码的基础上， 符号位不变， 其余各位<strong>取反， 最后+1</strong>。 (即在反码的基础上+1) </p>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><table>
<thead>
<tr>
<th>十进制数</th>
<th>原码</th>
<th>反码</th>
<th>补码</th>
</tr>
</thead>
<tbody><tr>
<td>85</td>
<td><code>0101 0101</code></td>
<td><code>0101 0101</code></td>
<td><code>0101 0101</code></td>
</tr>
<tr>
<td>-85</td>
<td><code>1101 0101</code></td>
<td><code>1010 1010</code></td>
<td><code>1010 1011</code></td>
</tr>
<tr>
<td>9</td>
<td><code>0000 1001</code></td>
<td><code>0000 1001</code></td>
<td><code>0000 1001</code></td>
</tr>
<tr>
<td>-9</td>
<td><code>1000 1001</code></td>
<td><code>1111 0110</code></td>
<td><code>1111 0111</code></td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>原码</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(四)GC垃圾回收</title>
    <url>/2020/03/22/JVM%EF%BC%88%E5%9B%9B%EF%BC%89GC%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
    <content><![CDATA[<h2 id="GC是什么"><a href="#GC是什么" class="headerlink" title="GC是什么"></a><strong>GC是什么</strong></h2><p> <strong>定义： 分代收集算法</strong></p>
<ul>
<li>次数上频繁收集Young区</li>
<li>次数上较少收集Old区</li>
<li>基本不动Perm区</li>
</ul>
<h2 id="GC算法总体概述"><a href="#GC算法总体概述" class="headerlink" title="GC算法总体概述"></a><strong>GC算法总体概述</strong></h2><img src="http://photo.wushaopei.com/qiniu169.png" width="80%">

<p>​    JVM在进行GC时，并非每次都对上面三个内存区域一起回收的，大部分时候回收的都是指新生代。</p>
<p>​    因此GC按照回收的区域又分了两种类型，一种是普通GC（minor GC），一种是全局GC（major GC or Full GC）</p>
<p><font color=blue>Minor GC和Full GC的区别</font></p>
<p>​    <font color=blue>普通GC（minor GC）</font>：只针对新生代区域的GC,指发生在新生代的垃圾收集动作，因为大多数Java对象存活率都不高，所以Minor GC非常频繁，一般回收速度也比较快。</p>
<p>​    <font color=blue>全局GC（major GC or Full GC）</font>：指发生在老年代的垃圾收集动作，出现了Major GC，经常会伴随至少一次的Minor GC（但并不是绝对的）。Major GC的速度一般要比Minor GC慢上10倍以上</p>
<h2 id="四种算法"><a href="#四种算法" class="headerlink" title="四种算法"></a><strong>四种算法</strong></h2><h3 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h3><img src="http://photo.wushaopei.com/qiniu170.png" width="80%">

<h4 id="Code演示："><a href="#Code演示：" class="headerlink" title="Code演示："></a><strong>Code</strong>演示：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.jvm;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**<span class="doctag">@Description</span>:-verbose:gc*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefCountGC</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">byte</span>[] bigSize = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>];<span class="comment">//这个成员属性唯一的作用就是占用一点内存</span></span><br><span class="line">  Object instance = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    RefCountGC objectA = <span class="keyword">new</span> RefCountGC();</span><br><span class="line">    RefCountGC objectB = <span class="keyword">new</span> RefCountGC();</span><br><span class="line">    objectA.instance = objectB;</span><br><span class="line">    objectB.instance = objectA;</span><br><span class="line">    objectA = <span class="keyword">null</span>;</span><br><span class="line">    objectB = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    System.gc();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复制算法-Copying"><a href="#复制算法-Copying" class="headerlink" title="复制算法(Copying)"></a>复制算法(Copying)</h3><h4 id="定义："><a href="#定义：" class="headerlink" title="定义："></a><strong>定义</strong>：</h4><p>​    年轻代中使用的是Minor GC，这种GC算法采用的是复制算法(Copying) </p>
<h4 id="原理："><a href="#原理：" class="headerlink" title="原理："></a><strong>原理</strong>：</h4><img src="http://photo.wushaopei.com/qiniu171.png" width="80%">

<p>​    Minor GC会把Eden中的所有活的对象都移到Survivor区域中，如果Survivor区中放不下，那么剩下的活的对象就被移到Old  generation中，<font color=red>也即一旦收集后，Eden是就变成空的了。</font></p>
<p>​    当对象在 Eden ( 包括一个 Survivor 区域，这里假设是 from 区域 ) 出生后，在经过一次 Minor GC 后，如果对象还存活，并且能够被另外一块 Survivor 区域所容纳( 上面已经假设为 from 区域，这里应为 to 区域，即 to 区域有足够的内存空间来存储 Eden 和 from 区域中存活的对象 )，则使用<font color=red>复制算法</font>将这些仍然还存活的对象复制到另外一块 Survivor 区域 ( 即 to 区域 ) 中，然后清理所使用过的 Eden 以及 Survivor 区域 ( 即 from 区域 )，并且将这些对象的年龄设置为1，以后对象在 Survivor 区每熬过一次 Minor GC，就将对象的年龄 + 1，当对象的年龄达到某个值时 ( 默认是 15 岁，通过-XX:MaxTenuringThreshold 来设定参数)，这些对象就会成为老年代。</p>
<p><code>-XX:MaxTenuringThreshold</code> — 设置对象在新生代中存活的次数</p>
<h4 id="动态演示："><a href="#动态演示：" class="headerlink" title="动态演示："></a><strong>动态演示：</strong></h4><p>​     在GC开始的时候，对象只会存在于Eden区和名为“From”的Survivor区，Survivor区“To”是空的。紧接着进行GC，Eden区中所有存活的对象都会被复制到“To”，而在“From”区中，仍存活的对象会根据他们的年龄值来决定去向。年龄达到一定值(年龄阈值，可以通过-XX:MaxTenuringThreshold来设置)的对象会被移动到年老代中，没有达到阈值的对象会被复制到“To”区域。<font color=red>经过这次GC后，Eden区和From区已经被清空。这个时候，“From”和“To”会交换他们的角色，也就是新的“To”就是上次GC前的“From”，新的“From”就是上次GC前的“To”。</font>不管怎样，都会保证名为To的Survivor区域是空的。Minor GC会一直重复这样的过程，直到“To”区被填满，“To”区被填满之后，会将所有对象移动到年老代中。<br><img src="http://photo.wushaopei.com/qiniu172.png" width="80%"></p>
<p>​    因为Eden区对象一般存活率较低，一般的，使用两块10%的内存作为空闲和活动区间，而另外80%的内存，则是用来给新建对象分配内存的。一旦发生GC，将10%的from活动区间与另外80%中存活的eden对象转移到10%的to空闲区间，接下来，将之前90%的内存全部释放，以此类推。 </p>
<h4 id="动态："><a href="#动态：" class="headerlink" title="动态："></a><strong>动态：</strong></h4><img src="http://photo.wushaopei.com/qiniu173.gif" width="80%">

<h4 id="劣势："><a href="#劣势：" class="headerlink" title="劣势："></a>劣势：</h4><p><code>复制算法它的缺点也是相当明显的。</code></p>
<ol>
<li>它浪费了一半的内存，这太要命了。</li>
<li>如果对象的存活率很高，我们可以极端一点，假设是100%存活，那么我们需要将所有对象都复制一遍，并将所有引用地址重置一遍。复制这一工作所花费的时间，在对象存活率达到一定程度时，将会变的不可忽视。 所以从以上描述不难看出，复制算法要想使用，<font color=blue>最起码对象的存活率要非常低才行</font>，而且最重要的是，我们必须要克服50%内存的浪费。</li>
</ol>
<h3 id="标记清除-Mark-Sweep"><a href="#标记清除-Mark-Sweep" class="headerlink" title="标记清除(Mark-Sweep)"></a>标记清除(Mark-Sweep)</h3><h4 id="定义：-1"><a href="#定义：-1" class="headerlink" title="定义："></a>定义：</h4><p>​    老年代一般是由标记清除或者是标记清除与标记整理的混合实现 </p>
<h4 id="原理：-1"><a href="#原理：-1" class="headerlink" title="原理："></a>原理：</h4><img src="http://photo.wushaopei.com/qiniu173.png" width="80%">

<p>​    当堆中的有效内存空间（available memory）被耗尽的时候，就会停止整个程序（也被称为stop the world），然后进行两项工作，第一项则是标记，第二项则是清除。</p>
<p> <strong>标记</strong>：从引用根节点开始标记所有被引用的对象。标记的过程其实就是遍历所有的GC Roots，然后将所有GC Roots可达的对象      标记为存活的对象。<br> <strong>清除：</strong>遍历整个堆，把未标记的对象清除。<br> <font color=red><strong>缺点：</strong>此算法需要暂停整个应用，会产生内存碎片</font></p>
<p>​    用通俗的话解释一下标记/清除算法，就是当程序运行期间，若可以使用的内存被耗尽的时候，GC线程就会被触发并将程序暂停，随后将依旧存活的对象标记一遍，最终再将堆中所有没被标记的对象全部清除掉，接下来便让程序恢复运行。</p>
<h4 id="动态演示"><a href="#动态演示" class="headerlink" title="动态演示"></a>动态演示</h4><p><strong>动图：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu174.gif" width="80%">

<ul>
<li>回收时,对需要存活的对象进行标记</li>
<li>回收不是绿色的对象</li>
</ul>
<h4 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h4><ol>
<li>首先，它的缺点就是效率比较低（递归与全堆对象遍历），而且在进行GC的时候，需要停止应用程序，这会导致用户体验非常差劲</li>
<li>其次，主要的缺点则是这种方式清理出来的空闲内存是不连续的，这点不难理解，我们的死亡对象都是随即的出现在内存的各个角落的，现在把它们清除之后，内存的布局自然会乱七八糟。而为了应付这一点，JVM就不得不维持一个内存的空闲列表，这又是一种开销。而且在分配数组对象的时候，寻找连续的内存空间会不太好找。</li>
</ol>
<img src="http://photo.wushaopei.com/qiniu174.png" width="80%">

<h3 id="标记压缩-Mark-Compact"><a href="#标记压缩-Mark-Compact" class="headerlink" title="标记压缩(Mark-Compact)"></a>标记压缩(Mark-Compact)</h3><h4 id="定义：-2"><a href="#定义：-2" class="headerlink" title="定义："></a>定义：</h4><p>​    <strong>老年代</strong>一般是由标记清除或者是标记清除与标记整理的混合实现 </p>
<h4 id="原理：-2"><a href="#原理：-2" class="headerlink" title="原理："></a>原理：</h4><img src="http://photo.wushaopei.com/qiniu175.png" width="80%">

<p>​    在整理压缩阶段，不再对标记的对像做回收，而是通过所有存活对像都向一端移动，然后直接清除边界以外的内存。<br>可以看到，标记的存活对象将会被整理，按照内存地址依次排列，而未被标记的内存会被清理掉。如此一来，当我们需要给新对象分配内存时，JVM只需要持有一个内存的起始地址即可，这比维护一个空闲列表显然少了许多开销。</p>
<p>​    标记/整理算法不仅可以弥补标记/清除算法当中，内存区域分散的缺点，也消除了复制算法当中，内存减半的高额代价</p>
<h4 id="劣势-1"><a href="#劣势-1" class="headerlink" title="劣势"></a>劣势</h4><p>​    <strong>标记/整理</strong>算法唯一的缺点就是效率也不高，不仅要标记所有存活对象，还要整理所有存活对象的引用地址。从效率上来说，<strong>标记/整理</strong>算法要低于复制算法。</p>
<h3 id="标记清除压缩-Mark-Sweep-Compact"><a href="#标记清除压缩-Mark-Sweep-Compact" class="headerlink" title="标记清除压缩(Mark-Sweep-Compact)"></a>标记清除压缩(Mark-Sweep-Compact)</h3><h4 id="原理：-3"><a href="#原理：-3" class="headerlink" title="原理："></a>原理：</h4><pre><code> 1. Mark-Sweep 和 Mark-Compact的结合
2. 和Mark-Sweep一致，当进行多次GC后才Compact.</code></pre><h4 id="目的："><a href="#目的：" class="headerlink" title="目的："></a>目的：</h4><p>​    减少移动对象的成本</p>
<h4 id="动态演示：-1"><a href="#动态演示：-1" class="headerlink" title="动态演示："></a>动态演示：</h4><img src="http://photo.wushaopei.com/qiniu175.gif" width="80%">



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p><strong>内存效率：</strong>    复制算法 &gt; 标记清除算法 &gt; 标记整理算法（<font color=red>此处的效率只是简单的对比时间复杂度，实际情况不一定如此</font>）。<br>内存整齐度：复制算法 = 标记整理算法 &gt; 标记清除算法。<br>内存利用率：标记整理算法 = 标记清除算法 &gt; 复制算法。</p>
<p>可以看出，效率上来说，复制算法是当之无愧的老大，但是却浪费了太多内存，而为了尽量兼顾上面所提到的三个指标，标记/整理算法相对来说更平滑一些，但效率上依然不尽如人意，它比复制算法多了一个标记的阶段，又比标记/清除多了一个整理内存的过程</p>
<h2 id="难道就没有一种最优算法吗？-猜猜看，下面还有"><a href="#难道就没有一种最优算法吗？-猜猜看，下面还有" class="headerlink" title="难道就没有一种最优算法吗？ 猜猜看，下面还有"></a><strong>难道就没有一种最优算法吗？ 猜猜看，下面还有</strong></h2><p>回答：无，没有最好的算法，只有最合适的算法。==========&gt;<font color=red>分代收集算法</font>。</p>
<p><font color=red>年轻代(Young Gen)  </font></p>
<p><font color=red>年轻代特点是区域相对老年代较小，对像存活率低。</font></p>
<p>这种情况复制算法的回收整理，速度是最快的。复制算法的效率只和当前存活对像大小有关，因而很适用于年轻代的回收。而复制算法内存利用率不高的问题，通过hotspot中的两个survivor的设计得到缓解。</p>
<p><font color=red>老年代(Tenure Gen)</font></p>
<p><font color=red>老年代的特点是区域较大，对像存活率高。</font></p>
<p>这种情况，存在大量存活率高的对像，复制算法明显变得不合适。一般是由标记清除或者是标记清除与标记整理的混合实现。</p>
<p><font color=red>Mark阶段的开销与存活对像的数量成正比</font>，这点上说来，对于老年代，标记清除或者标记整理有一些不符，但可以通过多核/线程利用，对并发、并行的形式提标记效率。</p>
<p><font color=red>Sweep阶段的开销与所管理区域的大小形正相关</font>，但Sweep“就地处决”的特点，回收的过程没有对像的移动。使其相对其它有对像移动步骤的回收算法，仍然是效率最好的。但是需要解决内存碎片问题。</p>
<p><font color=red>Compact阶段的开销与存活对像的数据成开比</font>，如上一条所描述，对于大量对像的移动是很大开销的，做为老年代的第一选择并不合适。</p>
<p>基于上面的考虑，<font color=red>老年代一般是由标记清除或者是标记清除与标记整理的混合实现。</font>以hotspot中的CMS回收器为例，CMS是基于Mark-Sweep实现的，对于对像的回收效率很高，而对于碎片问题，CMS采用基于Mark-Compact算法的Serial Old回收器做为补偿措施：当内存回收不佳（碎片导致的Concurrent Mode Failure时），将采用Serial Old执行Full GC以达到对老年代内存的整理。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>Heap堆</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>Heap堆</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(三)堆参数微调优入门</title>
    <url>/2020/03/22/JVM%EF%BC%88%E4%B8%89%EF%BC%89%E5%A0%86%E5%8F%82%E6%95%B0%E5%BE%AE%E8%B0%83%E4%BC%98%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h3 id="调优的本质："><a href="#调优的本质：" class="headerlink" title="调优的本质："></a><strong>调优的本质：</strong></h3><p>​     其本质：是对<strong>JVM</strong>垃圾的收集(<strong>Java Garbage Collection</strong> ) 。</p>
<p>这里均以<strong>JDK1.8+HotSpot</strong>为例 </p>
<h3 id="Java-7"><a href="#Java-7" class="headerlink" title="Java 7"></a><strong>Java 7</strong></h3><img src="http://photo.wushaopei.com/qiniu164.png" width="80%">

<h3 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a><strong>Java 8</strong></h3><img src="http://photo.wushaopei.com/qiniu165.png" width="80%">

<h3 id="堆内存调优简介01"><a href="#堆内存调优简介01" class="headerlink" title="堆内存调优简介01"></a><strong>堆内存调优简介01</strong></h3><table>
<thead>
<tr>
<th>-Xms</th>
<th>设置初始分配大小，默认为物理内存的“1/64”</th>
</tr>
</thead>
<tbody><tr>
<td>-Xmx</td>
<td>最大分配内存，默认为物理内存的“1/4”</td>
</tr>
<tr>
<td>-XX:+PrintGCDetails</td>
<td>输出详细的GC处理日志</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">   	<span class="keyword">long</span> maxMemory = Runtime.getRuntime().maxMemory();<span class="comment">//返回Java虚拟机试图使用的最大内存量</span></span><br><span class="line">   	<span class="keyword">long</span> totalMemory = Runtime.getRuntime().totalMemory();<span class="comment">//返回Java虚拟机中的内存总量</span></span><br><span class="line">   	System.out.println(<span class="string">"MAX_MEMORY = "</span>+ maxMemory + <span class="string">"（字节）、"</span> + (maxMemory / (<span class="keyword">double</span>)<span class="number">1024</span> / <span class="number">1024</span>)+<span class="string">"MB"</span>);</span><br><span class="line">   	System.out.println(<span class="string">"TOTAL_MEMORY = "</span>+ totalMemory + <span class="string">"（字节）、"</span> + (totalMemory / (<span class="keyword">double</span>)<span class="number">1024</span> / <span class="number">1024</span>)+<span class="string">"MB"</span>);</span><br><span class="line">   	</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="堆内存调优简介02"><a href="#堆内存调优简介02" class="headerlink" title="堆内存调优简介02"></a><strong>堆内存调优简介02</strong></h3><p>发现默认的情况下分配的内存是总内存的“1/4” 、 而初始化的内存为“1/ 64” </p>
<blockquote>
<p>MAX_MEMORY = 2731016192（字节）、2604.5MB<br>TOTAL_MEMORY = 185073664（字节）、176.5MB</p>
</blockquote>
<p>VM 参数：<code>-Xms1024m -Xmx1024m -XX:+PrintGCDetails</code></p>
<img src="http://photo.wushaopei.com/qiniu166.png" width="80%">

<h3 id="堆内存调优简介03"><a href="#堆内存调优简介03" class="headerlink" title="堆内存调优简介03"></a><strong>堆内存调优简介03</strong></h3><p>此图为java7，演示为8 </p>
<img src="http://photo.wushaopei.com/qiniu167.png" width="80%">

<h3 id="堆内存调优简介04"><a href="#堆内存调优简介04" class="headerlink" title="堆内存调优简介04"></a><strong>堆内存调优简介04</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String str = <span class="string">"www.wushaopei.com"</span>;</span><br><span class="line">  	<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">  		str += str + <span class="keyword">new</span> Random().nextInt(<span class="number">88888888</span>) + <span class="keyword">new</span> Random().nextInt(<span class="number">99999999</span>);</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>VM参数： -Xms8m -Xmx8m -XX:+PrintGCDetails</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu168.png" width="80%">



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>Heap堆</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>Heap堆</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(二)堆体系结构概述</title>
    <url>/2020/03/22/JVM%EF%BC%88%E4%BA%8C%EF%BC%89%E5%A0%86%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<hr>
<img src="http://photo.wushaopei.com/qiniu152.png" width="80%">

<hr>
<h3 id="Heap堆-Java7之前"><a href="#Heap堆-Java7之前" class="headerlink" title="Heap堆(Java7之前)"></a>Heap堆(Java7之前)</h3><p>​    一个JVM实例只存在一个堆内存，堆内存的大小是可以调节的。类加载器读取了类文件后，需要把类、方法、常变量放到堆内存中，保存所有引用类型的真实信息，以方便执行器执行。              </p>
<p>​    <strong>堆内存逻辑上分为三部分：新生+养老+永久</strong> </p>
<img src="http://photo.wushaopei.com/qiniu159.png" width="80%">

<h4 id="新生区"><a href="#新生区" class="headerlink" title="新生区"></a>新生区</h4><p>​    新生区是类的诞生、成长、消亡的区域，一个类在这里产生，应用，最后被垃圾回收器收集，结束生命。新生区又分为两部分： 伊甸区（Eden space）和幸存者区（Survivor pace） ，所有的类都是在伊甸区被new出来的。幸存区有两个： 0区（Survivor 0 space）和1区（Survivor 1 space）。当伊甸园的空间用完时，程序又需要创建对象，JVM的垃圾回收器将对伊甸园区进行垃圾回收(Minor GC)，将伊甸园区中的不再被其他对象所引用的对象进行销毁。然后将伊甸园中的剩余对象移动到幸存 0区。若幸存 0区也满了，再对该区进行垃圾回收，然后移动到 1 区。那如果1 区也满了呢？再移动到养老区。若养老区也满了，那么这个时候将产生MajorGC（FullGC），进行养老区的内存清理。若养老区执行了Full GC之后发现依然无法进行对象的保存，就会产生OOM异常“OutOfMemoryError”。</p>
<p><font color=red>如果出现java.lang.OutOfMemoryError: Java heap space异常，说明Java虚拟机的堆内存不够。原因有二：</font></p>
<p>（1）<font color=red>Java虚拟机的堆内存设置不够，可以通过参数-Xms、-Xmx来调整。</font></p>
<p>（2）<font color=red>代码中创建了大量大对象，并且长时间不能被垃圾收集器收集（存在被引用）。</font><br><img src="http://photo.wushaopei.com/qiniu160.png" width="80%"></p>
<img src="http://photo.wushaopei.com/qiniu161.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu162.png" width="80%">

<h4 id="永久区"><a href="#永久区" class="headerlink" title="永久区"></a>永久区</h4><pre><code>永久存储区是一个常驻内存区域，用于存放JDK自身所携带的 Class,Interface 的元数据，也就是说它存储的是运行环境必须的类信息，被装载进此区域的数据是不会被垃圾回收器回收掉的，关闭 JVM 才会释放此区域所占用的内存。</code></pre><p>​    如果出现   <code>java.lang.OutOfMemoryError: PermGen space</code>，说明是Java虚拟机对永久代Perm内存设置不够。一般出现这种情况，都是程序启动需要加载大量的第三方jar包。例如：在一个Tomcat下部署了太多的应用。或者大量动态反射生成的类不断被加载，最终导致Perm区被占满。</p>
<table>
<thead>
<tr>
<th>Jdk1.6及之前：</th>
<th>有永久代, 常量池1.6在方法区</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Jdk1.7：</strong></td>
<td><strong>有永久代，但已经逐步“去永久代”，常量池1.7在堆</strong></td>
</tr>
<tr>
<td><strong>Jdk1.8及之后：</strong></td>
<td><strong>无永久代，常量池1.8在元空间</strong></td>
</tr>
</tbody></table>
<h4 id="了解三区结构后方可了解-JVM垃圾收集"><a href="#了解三区结构后方可了解-JVM垃圾收集" class="headerlink" title="了解三区结构后方可了解-JVM垃圾收集"></a>了解三区结构后方可了解-JVM垃圾收集</h4><p>​    实际而言，方法区（Method Area）和堆一样，是各个线程共享的内存区域，它用于存储虚拟机加载的：类信息+普通常量+静态常量+编译器编译后的代码等等，虽然JVM规范将方法区描述为堆的一个逻辑部分，但它却还有一个别名叫做Non-Heap(非堆)，目的就是要和堆分开。</p>
<p>​    对于HotSpot虚拟机，很多开发者习惯将方法区称之为“永久代(Parmanent Gen)” ，但严格本质上说两者不同，或者说使用永久代来实现方法区而已，永久代是方法区(相当于是一个接口interface)的一个实现，<font color=blue>jdk1.7的版本中，已经将原本放在永久代的字符串常量池移走</font>。</p>
<img src="http://photo.wushaopei.com/qiniu163.png" width="80%">


<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>GC</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>内存回收机制</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM（一）体系结构概述</title>
    <url>/2020/03/21/JVM%EF%BC%88%E4%B8%80%EF%BC%89%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h2 id="JVM-与系统、硬件"><a href="#JVM-与系统、硬件" class="headerlink" title="JVM 与系统、硬件"></a><strong>JVM 与系统、硬件</strong></h2><img src="http://photo.wushaopei.com/qiniu151.png" width="80%">

<p><strong>JVM</strong>是运行在操作系统之上的，它与硬件没有直接的交互 </p>
<h2 id="JVM-体系结构概览"><a href="#JVM-体系结构概览" class="headerlink" title="JVM 体系结构概览"></a><strong>JVM 体系结构概览</strong></h2><img src="http://photo.wushaopei.com/qiniu152.png" width="80%">



<h2 id="类装载器ClassLoader-执行原理"><a href="#类装载器ClassLoader-执行原理" class="headerlink" title="类装载器ClassLoader 执行原理"></a>类装载器ClassLoader 执行原理</h2><p>​    负责加载<strong>class</strong>文件，class文件在文件开头有特定的文件标示，并且<strong>ClassLoader</strong>只负责<strong>class</strong>文件的加载，至于它是否可以运行，则由<strong>Execution Engine</strong>决定 </p>
<img src="http://photo.wushaopei.com/qiniu153.png" width="80%">



<h2 id="类装载器ClassLoader装载流程（双亲委派）"><a href="#类装载器ClassLoader装载流程（双亲委派）" class="headerlink" title="类装载器ClassLoader装载流程（双亲委派）"></a><strong>类装载器ClassLoader装载流程（双亲委派）</strong></h2><img src="http://photo.wushaopei.com/qiniu154.png" width="80%">

<table>
<thead>
<tr>
<th>虚拟机自带的加载器</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>启动类加载器（Bootstrap）</strong></td>
<td>C++</td>
</tr>
<tr>
<td><strong>扩展类加载器（Extension）</strong></td>
<td>Java</td>
</tr>
<tr>
<td><strong>应用程序类加载器（AppClassLoader）</strong>                                                                     <code>应用程序类加载器 也叫系统类加载器，加载当前应用的classpath的所有类</code></td>
<td>Java</td>
</tr>
<tr>
<td><strong>用户自定义加载器</strong>                                                                                    <code>Java.lang.ClassLoader的子类，用户可以定制类的加载方式</code></td>
<td></td>
</tr>
</tbody></table>
<p>注：<strong>Execution Engine</strong>执行引擎负责解释命令，提交操作系统执行。</p>
<img src="http://photo.wushaopei.com/qiniu155.png" width="80%">



<h2 id="Native-Interface本地接口"><a href="#Native-Interface本地接口" class="headerlink" title="Native Interface本地接口"></a><strong>Native Interface本地接口</strong></h2><p>​    本地接口的作用是融合不同的编程语言为 Java 所用，它的初衷是融合 C/C++程序，Java 诞生的时候是 C/C++横行的时候，要想立足，必须有调用 C/C++程序，于是就在内存中专门开辟了一块区域处理标记为native的代码，它的<strong>具体做法是 Native Method Stack中登记 native方法，在Execution Engine 执行时加载native libraies。</strong></p>
<p>​    目前<strong>该方法</strong>使用的越来越少了，除非是与硬件有关的<strong>应用</strong>，比如<strong>通过Java程序驱动打印机或者Java系统管理生产设备</strong>，在企业级应用中已经比较少见。因为现在的异构领域间的通信很发达，比如可以使用 Socket通信，也可以使用Web Service等等，不多做介绍。</p>
<h2 id="Native-Method-Stack（本地方法栈）"><a href="#Native-Method-Stack（本地方法栈）" class="headerlink" title="Native Method Stack（本地方法栈）"></a><strong>Native Method Stack（本地方法栈）</strong></h2><p>​    它的具体做法是Native Method Stack中登记native方法，在Execution Engine 执行时加载本地方法库。 </p>
<h2 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a><strong>PC寄存器</strong></h2><p>​    每个线程都有一个程序计数器，是线程私有的,就是一个指针，指向方法区中的方法字节码<font color=red>（用来存储指向下一条指令的地址,也即将要执行的指令代码）</font> ，由执行引擎读取下一条指令，是一个非常小的内存空间，几乎可以忽略不记。</p>
<p>​    这块内存区域很小，<font color=red>它是当前线程所执行的字节码的行号指示器</font>，字节码解释器通过改变这个计数器的值来选取下一条需要执行的字节码指令。</p>
<p>​    如果执行的是一个Native方法，那这个计数器是空的。</p>
<p>​    用以完成分支、循环、跳转、异常处理、线程恢复等基础功能。不会发生内存溢出(OutOfMemory=OOM)错误</p>
<h2 id="Method-Area-方法区"><a href="#Method-Area-方法区" class="headerlink" title="Method Area 方法区"></a><strong>Method Area 方法区</strong></h2><p>​    方法区是被所有线程共享，所有字段和方法字节码，以及一些特殊方法如构造函数，接口代码也在此定义。简单说，所有定义的方法的信息都保存在该区域，<font color=red>此区属于共享区间</font>。<br><font color=blue>静态变量+常量+类信息(构造方法/接口定义)+运行时常量池存在方法区中</font></p>
<p><font color=blue>But 实例变量存在堆内存中,和方法区无关</font></p>
<h2 id="Stack-栈"><a href="#Stack-栈" class="headerlink" title="Stack 栈"></a><strong>Stack 栈</strong></h2><p>​    <strong>栈</strong>也叫<strong>栈内存</strong>，主管Java程序的运行，是在线程创建时创建，它的生命期是跟随线程的生命期，线程结束栈内存也就释放，<font color=blue>对于栈来说不存在垃圾回收问题</font>，只要线程一结束该栈就Over，生命周期和线程一致，是线程私有的。8种<font color=red>基本类型的变量+对象的引用变量+实例方法都是在函数的栈内存中分配</font>。 </p>
<h3 id="栈存储什么？"><a href="#栈存储什么？" class="headerlink" title="栈存储什么？"></a>栈存储什么？</h3><p><strong>栈帧中主要保存3 类数据：</strong></p>
<ul>
<li>本地变量（Local Variables）:输入参数和输出参数以及方法内的变量；</li>
<li>栈操作（Operand Stack）:记录出栈、入栈的操作；</li>
<li>栈帧数据（Frame Data）:包括类文件、方法等等。</li>
</ul>
<h3 id="栈运行原理"><a href="#栈运行原理" class="headerlink" title="栈运行原理"></a>栈运行原理</h3><p>栈中的数据都是以<strong>栈帧</strong>（Stack Frame）的格式存在，栈帧是一个内存区块，是一个数据集，是一个有关方法(Method)和运行期数据的数据集，当一个方法A被调用时就产生了一个栈帧 F1，并被压入到栈中，<br>A方法又调用了 B方法，于是产生栈帧 F2 也被压入栈，<br>B方法又调用了 C方法，于是产生栈帧 F3 也被压入栈，<br>……<br>执行完毕后，先弹出F3栈帧，再弹出F2栈帧，再弹出F1栈帧……</p>
<p>遵循“先进后出”/“后进先出”原则。</p>
<p><font color=red>每个方法执行的同时都会创建一个栈帧，用于存储局部变量表、操作数栈、动态链接、方法出口等信息</font>，每一个方法从调用直至执行完毕的过程，就对应着一个栈帧在虚拟机中入栈到出栈的过程。<font color=red>栈的大小和具体JVM的实现有关，通常在256K~756K之间</font>。</p>
<img src="http://photo.wushaopei.com/qiniu156.png" width="80%">

<p>图示在一个栈中有两个栈帧：</p>
<ul>
<li>栈帧 2是最先被调用的方法，先入栈，</li>
<li>然后方法 2 又调用了方法1，栈帧 1处于栈顶的位置，</li>
<li>栈帧 2 处于栈底，执行完毕后，依次弹出栈帧 1和栈帧 2，</li>
<li>线程结束，栈释放。</li>
</ul>
<p>每执行一个方法都会产生一个栈帧，保存到栈(后进先出)的<font color=red>顶部，顶部栈就是当前的方法，该方法执行完毕 后会自动将此栈帧出栈</font>。</p>
<img src="http://photo.wushaopei.com/qiniu157.png" width="80%">



<h3 id="栈-堆-方法区的交互关系"><a href="#栈-堆-方法区的交互关系" class="headerlink" title="栈+堆+方法区的交互关系"></a><strong>栈+堆+方法区的交互关系</strong></h3><img src="http://photo.wushaopei.com/qiniu158.png" width="80%">

<p><strong>HotSpot</strong>是使用<font color=red><strong>指针的方式</strong>来访问对象</font>：<br>         Java堆中会存放访问类元数据的地址，reference存储的就直接是对象的地址</p>
<h3 id="三种JVM："><a href="#三种JVM：" class="headerlink" title="三种JVM："></a>三种JVM：</h3><ul>
<li>Sun公司的HotSpot</li>
<li>BEA公司的JRockit</li>
<li>IBM公司的J9 VM</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>GC</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>内存回收机制</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot 2.0 新特性-浅析</title>
    <url>/2020/03/20/SpringBoot-2-0-%E6%96%B0%E7%89%B9%E6%80%A7-%E6%B5%85%E6%9E%90/</url>
    <content><![CDATA[<h2 id="Spring-Boot-概述"><a href="#Spring-Boot-概述" class="headerlink" title="Spring Boot 概述"></a>Spring Boot 概述</h2><h3 id="Spring-Boot-的角色"><a href="#Spring-Boot-的角色" class="headerlink" title="Spring Boot 的角色"></a>Spring Boot 的角色</h3><blockquote>
<p>底层：Spring Frameword是 JAVAEE 的框架</p>
<p>中层：Spring Boot 是快速构建Spring框架的应用</p>
<p>顶层：Spring Cloud 是JAVAEE 的分布式</p>
</blockquote>
<h3 id="Spring-Boot-2-0新特性"><a href="#Spring-Boot-2-0新特性" class="headerlink" title="Spring Boot 2.0新特性"></a>Spring Boot 2.0新特性</h3><h4 id="SpringBoot2-0新特性："><a href="#SpringBoot2-0新特性：" class="headerlink" title="SpringBoot2.0新特性："></a><strong>SpringBoot2.0新特性：</strong></h4><ul>
<li>编程语言必须依赖于java 8++(&gt;jdk1.8)，Kotlin</li>
<li>底层框架：spring Framework 5.0X(必须依赖于java1.8)</li>
<li>全新特性：Web Flux(全新编程模型，对SpringMVC的补充)</li>
</ul>
<h4 id="为什么选择Web-Flux？"><a href="#为什么选择Web-Flux？" class="headerlink" title="为什么选择Web Flux？"></a><strong>为什么选择Web Flux？</strong></h4><ul>
<li>函数编程：Java8 Lambda</li>
<li>响应编程：Reactive Streams</li>
<li>异步编程：Servlet3.1 或 Asyc NIO</li>
</ul>
<h2 id="Spring-Boot-项目"><a href="#Spring-Boot-项目" class="headerlink" title="Spring Boot 项目"></a>Spring Boot 项目</h2><h3 id="Spring-Boot-环境准备"><a href="#Spring-Boot-环境准备" class="headerlink" title="Spring Boot 环境准备"></a>Spring Boot 环境准备</h3><ul>
<li>装配 JDK （<a href="https://java.oracle.com/）" target="_blank" rel="noopener">https://java.oracle.com/）</a></li>
<li>装配Maven （<a href="http://maven.apache.org）" target="_blank" rel="noopener">http://maven.apache.org）</a></li>
<li>装配IDEA （<a href="http://www.jetbrains.com/idea/）" target="_blank" rel="noopener">http://www.jetbrains.com/idea/）</a></li>
</ul>
<h4 id="具体操作："><a href="#具体操作：" class="headerlink" title="具体操作："></a><strong>具体操作：</strong></h4><ul>
<li>JDK：JDK1.8</li>
<li>Maven：配置仓库地址，配置下载镜像</li>
</ul>
<p><strong>配置文件路径</strong>: <code>..\apache-maven-3.5.4-bin\apache-maven-3.5.4\conf\settings.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>E:/softwareData/.m2/repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="maven配置环境变量"><a href="#maven配置环境变量" class="headerlink" title="maven配置环境变量"></a><strong>maven配置环境变量</strong></h4><blockquote>
<p><strong>M2_HOME</strong>   maven安装地址</p>
<p>PATH 后加上  <strong>;%M2_HOME\bin</strong></p>
</blockquote>
<ul>
<li>IDEA：<a href="http://www.jetbrains.com/idea" target="_blank" rel="noopener">http://www.jetbrains.com/idea</a> </li>
</ul>
<p><code>download community version（社区版）</code></p>
<h3 id="Spring-Boot应用（一）"><a href="#Spring-Boot应用（一）" class="headerlink" title="Spring Boot应用（一）"></a>Spring Boot应用（一）</h3><h4 id="简单应用："><a href="#简单应用：" class="headerlink" title="简单应用："></a>简单应用：</h4><ul>
<li>编写REST程序</li>
<li>运行Spring Boot 应用</li>
<li>使用HTTP请求工具：PostMan</li>
</ul>
<h4 id="场景说明："><a href="#场景说明：" class="headerlink" title="场景说明："></a>场景说明：</h4><ul>
<li>定义用户模型，包括属性：用户ID和名称</li>
<li>客户端发送POST请求，创建用户（Web MVC）</li>
<li>客户端发送GET请求，获取所有用户（Web Flux）</li>
</ul>
<h4 id="应用创建："><a href="#应用创建：" class="headerlink" title="应用创建："></a>应用创建：</h4><h5 id="创建springboot工程-first-app-demo："><a href="#创建springboot工程-first-app-demo：" class="headerlink" title="创建springboot工程 first-app-demo："></a><strong>创建springboot工程 first-app-demo：</strong></h5><img src="http://photo.wushaopei.com/qiniu142.png" width="80%">

<h5 id="配置依赖："><a href="#配置依赖：" class="headerlink" title="配置依赖："></a>配置依赖：</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- lombok 简化 java 代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="创建用户模型-User类，并声明-id、-name-两个变量"><a href="#创建用户模型-User类，并声明-id、-name-两个变量" class="headerlink" title="创建用户模型 User类，并声明 id、 name 两个变量"></a><strong>创建用户模型 User类，并声明 id、 name 两个变量</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用了Lombok优化了代码，不需要手动创建set/get方法 </p>
<h5 id="创建UserRepository-用户仓库类，用来存储用户的信息"><a href="#创建UserRepository-用户仓库类，用来存储用户的信息" class="headerlink" title="创建UserRepository 用户仓库类，用来存储用户的信息**"></a>创建UserRepository 用户仓库类，用来存储用户的信息**</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*  &#123;@link User&#125; &#123;@link Repository&#125;</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *  采用内存型的存储方式 -&gt;Map</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;Integer,User&gt; repository = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, User&gt;() &#123;&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> AtomicInteger idGenera = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *  保存用户对象</span></span><br><span class="line"><span class="comment">    *  @param user &#123;@link User&#125; 对象</span></span><br><span class="line"><span class="comment">    *  @return  如果保存成功，返回&lt;code&gt; true&lt;/code&gt;</span></span><br><span class="line"><span class="comment">    *           否则，返回&lt;code&gt;false&lt;/code&gt;</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span> <span class="params">(User user)</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ID 从 1 开始</span></span><br><span class="line">        Integer id = idGenera.incrementAndGet();</span><br><span class="line"> </span><br><span class="line">        user.setId(id);</span><br><span class="line">        <span class="keyword">return</span>  repository.put(id,user) == <span class="keyword">null</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建用户接口类-UserController-java"><a href="#创建用户接口类-UserController-java" class="headerlink" title="创建用户接口类 UserController.java"></a><strong>创建用户接口类 UserController.java</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/6 9:55</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserController</span><span class="params">(UserRepository userRepository)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="注意："><a href="#注意：" class="headerlink" title="注意："></a><strong>注意：</strong></h5><p>构造器形式的注入方式的好处：</p>
<blockquote>
<ol>
<li>不能修改。</li>
<li>可以更早的进行初始化，相对于字段性的注入方式会好一点。</li>
<li>但实际开发中，为了节约时间，还是会用字段形式的注入方式</li>
<li>参数由spring框架传递，@Autowired可以写也可以不写</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserRepository userRepository;</span><br></pre></td></tr></table></figure>

<h5 id="创建新增用户接口："><a href="#创建新增用户接口：" class="headerlink" title="创建新增用户接口："></a>创建新增用户接口：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/person/save"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">save</span> <span class="params">(@RequestParam String name)</span></span>&#123;</span><br><span class="line">       User user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">       user.setName(name);</span><br><span class="line">       <span class="keyword">if</span>(userRepository.save(user))&#123;</span><br><span class="line">           System.out.println(<span class="string">"用户对象： % 保存成功 ! \n"</span> + user);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span>  user;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h5><p>请求接口地址：</p>
<blockquote>
<p>localhost:8080/person/save?name=李清照</p>
</blockquote>
<blockquote>
<p>请求方式： <strong>POST 请求</strong></p>
</blockquote>
<h5 id="POSTMAN测试响应结果："><a href="#POSTMAN测试响应结果：" class="headerlink" title="POSTMAN测试响应结果："></a><strong>POSTMAN测试响应结果：</strong></h5><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"李清照"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>控制台打印：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu143.png" width="80%">  



<h2 id="构建方式、多模块和运行方式"><a href="#构建方式、多模块和运行方式" class="headerlink" title="构建方式、多模块和运行方式"></a>构建方式、多模块和运行方式</h2><h3 id="Spring-Boot-构建应用-命令行方式"><a href="#Spring-Boot-构建应用-命令行方式" class="headerlink" title="Spring Boot  构建应用-命令行方式"></a>Spring Boot  构建应用-命令行方式</h3><p><strong>spring-boot-starter-web的话@Configuration路由无法生效</strong> </p>
<p>（1）flux内嵌Netty容器，适用于</p>
<pre><code>@Configuration</code></pre><p>（2）web内嵌tomcat容器，适用于@RestController</p>
<p>（3）通过Maven的方式构建Spring Boot项目</p>
<pre><code>mvn archetype:generate -DinteractiveMode=false

-DgroupId=com.imooc  -DartifactId=first-app-by-maven

-Dversion=1.0.0-SNAPSHOT</code></pre><h3 id="Spring-Boot-多模块"><a href="#Spring-Boot-多模块" class="headerlink" title="Spring Boot 多模块"></a>Spring Boot 多模块</h3><blockquote>
<p>调整主（父）工程类型（<packaging>）</p>
<p>  创建子模块工程（<module>）</p>
<p>   模型层：model</p>
<p>   持久层：persistence</p>
<p>   表示层：web</p>
<p>子模块依赖管理（<dependencyManagement>）</p>
</blockquote>
<h4 id="将-first-app-demo-中的pom-xml-的打包-由-jar改成-pom"><a href="#将-first-app-demo-中的pom-xml-的打包-由-jar改成-pom" class="headerlink" title="将  first-app-demo 中的pom.xml 的打包 由 jar改成 pom"></a><strong>将  first-app-demo 中的pom.xml 的打包 由 jar改成 pom</strong></h4><img src="http://photo.wushaopei.com/qiniu144.png" width="80%">  



<h4 id="右击工程名，-创建一个-artifactId-为-web-的Maven-工程"><a href="#右击工程名，-创建一个-artifactId-为-web-的Maven-工程" class="headerlink" title="*右击工程名， 创建一个 artifactId 为 web 的Maven 工程 *"></a>*<em>右击工程名， 创建一个 artifactId 为 web 的Maven 工程 *</em></h4><img src="http://photo.wushaopei.com/qiniu145.png" width="80%">  



<h4 id="将原-first-app-demo-工程下java目录下的-com-包-拖到-web-工程的-java-包下，并删除原工程中的-src-目录"><a href="#将原-first-app-demo-工程下java目录下的-com-包-拖到-web-工程的-java-包下，并删除原工程中的-src-目录" class="headerlink" title="将原 first-app-demo 工程下java目录下的 com 包 拖到 web 工程的 java 包下，并删除原工程中的 src 目录"></a><strong>将原 first-app-demo 工程下java目录下的 com 包 拖到 web 工程的 java 包下，并删除原工程中的 src 目录</strong></h4><img src="http://photo.wushaopei.com/qiniu146.png" width="70%">  



<h4 id="右击工程名，-创建一个-artifactId-为-persistence-的Maven-工程，并在java-目录下创建一个-路径为"><a href="#右击工程名，-创建一个-artifactId-为-persistence-的Maven-工程，并在java-目录下创建一个-路径为" class="headerlink" title="右击工程名， 创建一个 artifactId 为 persistence  的Maven 工程，并在java 目录下创建一个 路径为"></a>右击工程名， 创建一个 artifactId 为 persistence  的Maven 工程，并在java 目录下创建一个 路径为</h4><blockquote>
<p>com.example.demo.model 的包，将web中的 User 模型类 剪切到 model工程 的 com.example.demo.model 包下</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu147.png" width="80%">



<h4 id="persistence-中的User-找不到对应的包报错"><a href="#persistence-中的User-找不到对应的包报错" class="headerlink" title="persistence 中的User 找不到对应的包报错"></a>persistence 中的User 找不到对应的包报错</h4><p>解决方法： 修正 多模块之间的 依赖关系，将 User 所在的 model 依赖添加到persistence 的pom.xml 中，同时将 persistence  的 依赖添加到 web 的pom.xml中 </p>
<img src="http://photo.wushaopei.com/qiniu148.png" width="80%">



<h3 id="Spring-Boot-项目打包"><a href="#Spring-Boot-项目打包" class="headerlink" title="Spring Boot 项目打包"></a>Spring Boot 项目打包</h3><h4 id="打包方式："><a href="#打包方式：" class="headerlink" title="打包方式："></a><strong>打包方式：</strong></h4><blockquote>
<p>  构建 JAR 包</p>
<p>  构建 WAR 包</p>
<p>  指定 Main-Class</p>
</blockquote>
<h4 id="右击工程名-“copy-path”-获取工程路径，到-cmd-exe-命令行中进入该目录下，输入"><a href="#右击工程名-“copy-path”-获取工程路径，到-cmd-exe-命令行中进入该目录下，输入" class="headerlink" title="右击工程名  “copy path” 获取工程路径，到 cmd.exe 命令行中进入该目录下，输入"></a><strong>右击工程名  “copy path” 获取工程路径，到 cmd.exe 命令行中进入该目录下，输入</strong></h4><p><code>mvn -Dmaven.test.skip -U clean package</code></p>
<h5 id="命令执行打包操作，"><a href="#命令执行打包操作，" class="headerlink" title="命令执行打包操作，"></a>命令执行打包操作，</h5><p>此时执行过程会发生报错，因为 在进行多模块拆分后，需要重新为工程指定 main.class ，也就是 springboot 的启动器入口的位置的明确。这是由于在拆分过后，在父工程下找不到main.class 。</p>
<h5 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h5><p>将父工程的pom.xml 中的 <build></build>依赖驱动剪切到 web 子模块中 ，然后再到修改后的web子模块的 pom.xml 中的   <build></build> 中的<plugin></plugin>添加一个 <configuration/>,并为其配置一个<mainClass/>，将 springboot入口启动器的 Reference 路径复制并放入到 <mainClass>中，然后执行打包就可以了。</p>
<p><strong>注意：</strong> 不要把<build/>放在父工程的pom.xml 下进行打包，那样会有很多错误要进行修正，而且由于主启动器迁移到 了web 中，在父工程下 添加<build/>意义不大<img src="http://photo.wushaopei.com/qiniu149.png" width="80%"></p>
<h4 id="在-cmd-命令行中启动-jar-包-或者-war-包-的方式："><a href="#在-cmd-命令行中启动-jar-包-或者-war-包-的方式：" class="headerlink" title="在 cmd 命令行中启动 jar 包 或者 war 包 的方式："></a><strong>在 cmd 命令行中启动 jar 包 或者 war 包 的方式：</strong></h4><blockquote>
<p>java -jar web-0.0.1-SNAPSHOT.jar</p>
<p>或者</p>
<p>java -jar web-0.0.1-SNAPSHOT.war</p>
</blockquote>
<p><strong>注意：</strong> 要在 当前工程打成 war 包，需要在 web 的mian 目录下创建 “webapp” 和  “WEB-INF”两个目录，并在 “WEB-INF” 目录下创建 一个 web.xml 文件 </p>
<img src="http://photo.wushaopei.com/qiniu150.png" width="80%">



<h3 id="Spring-Boot-运行模式"><a href="#Spring-Boot-运行模式" class="headerlink" title="Spring Boot 运行模式"></a>Spring Boot 运行模式</h3><h4 id="Springboot项目的3种运行模式："><a href="#Springboot项目的3种运行模式：" class="headerlink" title="Springboot项目的3种运行模式："></a>Springboot项目的3种运行模式：</h4><p><strong>idea</strong>方式，<strong>jar/war</strong>方式，<strong>maven</strong>插件方式</p>
<ol>
<li>如果是在开发过程中，会使用idea方式</li>
<li>如果是在线上的服务器上，会使用jar/war方式，作为启动脚本</li>
<li>如果开发环境是Linux环境，会使用maven插件方式。</li>
</ol>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">mvn</span> <span class="string">spring-boot:run</span></span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot功能篇</category>
      </categories>
  </entry>
  <entry>
    <title>解析 XML文件</title>
    <url>/2020/03/20/%E8%A7%A3%E6%9E%90-XML%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<img src="http://photo.wushaopei.com/qiniu138.png" width="100%">

<h2 id="java解析和生成xml"><a href="#java解析和生成xml" class="headerlink" title="java解析和生成xml"></a>java解析和生成xml</h2><h3 id="初次邂逅xml"><a href="#初次邂逅xml" class="headerlink" title="初次邂逅xml"></a>初次邂逅xml</h3><p> <strong>xml：</strong>可扩展<a href="https://baike.baidu.com/item/%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80" target="_blank" rel="noopener">标记语言</a>，<a href="https://baike.baidu.com/item/%E6%A0%87%E5%87%86%E9%80%9A%E7%94%A8%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/6805073" target="_blank" rel="noopener">标准通用标记语言</a>的子集，是一种用于标记电子文件使其具有结构性的<a href="https://baike.baidu.com/item/%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/5964436" target="_blank" rel="noopener">标记语言</a>。</p>
<p> <strong>表现：</strong>以 .xml 为文件扩展名的文件</p>
<p> <strong>存储：</strong>树形结构 </p>
<p><code>XML是一种类似于HTML的标记语言，XML是用来描述数据的，XML的标记不是在XML中预定义的，你必须定义自己的标记，XML使用文档类型定义(DTD)或者模式(Schema)来描述数据，XML使用DTD或者Schema后就是自描述的语言</code></p>
<h3 id="XML和HTML"><a href="#XML和HTML" class="headerlink" title="XML和HTML"></a><strong>XML和HTML</strong></h3><p><strong>XML扩展性比HTML强</strong> </p>
<blockquote>
<p>XML（Extensible Markup Languages）是扩展标记语言的英语缩写，他可以创建个性化的标记语言，可以称之为元语言。XML的标记语言可以自定义，这样可以提供更多的数据操作，而不像HTML一样，只能局限于按一定的格式在终端显示出来。HTML的功能只有浏览器放入显示和打印，仅仅适合静态网页的要求。</p>
</blockquote>
<p><strong>XML的语法比HTML严格</strong> </p>
<blockquote>
<p>由于XML的扩展性强，它需要稳定的基础规则来支持扩展。它的严格规则为：</p>
<p>①起始和结束的标签相匹配</p>
<p>②嵌套标签不能相互嵌套</p>
<p>③区分大小写</p>
</blockquote>
<p>相对应XML的严格规则，HTML语言并没有规定标签的绝对位置，也不区分大小写，而这些全部由浏览器来完成识别和更正。 </p>
<p><strong>XML与HTML互补</strong> </p>
<blockquote>
<p>XML可以获得应用之间的相应信息，提供终端的多项处理要求，也能被其他的解析器和工具所使用，在现阶段，XML可以转化成相应的HTML，来适应当前浏览器的需求。 </p>
</blockquote>
<h3 id="xml文件结构图："><a href="#xml文件结构图：" class="headerlink" title="xml文件结构图："></a><strong>xml文件结构图：</strong></h3><img src="http://photo.wushaopei.com/qiniu139.png" width="100%">



<h3 id="为什么用使用XML"><a href="#为什么用使用XML" class="headerlink" title="为什么用使用XML"></a><strong>为什么用使用XML</strong></h3><blockquote>
<p>思考1：不同应用程序之间的通信      </p>
<p>思考2：不同平台间的通信      </p>
<p>思考3：不同平台间的数据共享 </p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu140.png" width="100%">

<p><strong>场景： e.g. MSN中存储用户的聊天记录</strong></p>
<ol>
<li>xml文件是一个倒着的树状结构。 </li>
<li>xml文件中，节点名称区分大小写。<??>里面放的是版本信息，编码。 </li>
<li>xml文件作用： </li>
</ol>
<blockquote>
<ul>
<li>不同应用程序之间通信、传输信息(订票程序和支付程序)</li>
<li>不同系统间的通信(例：Windows系统和IOS系统)</li>
<li>不同平台间的数据共享(手机端和PC端)</li>
</ul>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu141.png" width="100%">

<blockquote>
<p>不同APP之间的通信，不同的平台间的通信，不同平台间的数据共享。XML文件主要用于存储以及传输信息。 通过xml文件存储小型数据。 即使用相同的xml文件将不同的应用或服务联系起来。 </p>
</blockquote>
<p><strong>xml 文件：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">invoiceOrderStore</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InvoiceOrder</span> <span class="attr">id</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">invoiceOrder</span>&gt;</span>001<span class="tag">&lt;/<span class="name">invoiceOrder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyName</span>&gt;</span>冰与火之歌1<span class="tag">&lt;/<span class="name">companyName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">taxNumber</span>&gt;</span>冰与火之歌1<span class="tag">&lt;/<span class="name">taxNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountBank</span>&gt;</span>冰与火之歌1<span class="tag">&lt;/<span class="name">accountBank</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyAddress</span>&gt;</span>乔治马丁1<span class="tag">&lt;/<span class="name">companyAddress</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bankNumber</span>&gt;</span>20141<span class="tag">&lt;/<span class="name">bankNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyTelephone</span>&gt;</span>891<span class="tag">&lt;/<span class="name">companyTelephone</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountName</span>&gt;</span>891<span class="tag">&lt;/<span class="name">accountName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">InvoiceOrder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InvoiceOrder</span> <span class="attr">id</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">invoiceOrder</span>&gt;</span>002<span class="tag">&lt;/<span class="name">invoiceOrder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyName</span>&gt;</span>冰与火之歌2<span class="tag">&lt;/<span class="name">companyName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">taxNumber</span>&gt;</span>冰与火之歌2<span class="tag">&lt;/<span class="name">taxNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountBank</span>&gt;</span>冰与火之歌2<span class="tag">&lt;/<span class="name">accountBank</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyAddress</span>&gt;</span>乔治马丁2<span class="tag">&lt;/<span class="name">companyAddress</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bankNumber</span>&gt;</span>20142<span class="tag">&lt;/<span class="name">bankNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyTelephone</span>&gt;</span>892<span class="tag">&lt;/<span class="name">companyTelephone</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountName</span>&gt;</span>892<span class="tag">&lt;/<span class="name">accountName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">InvoiceOrder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InvoiceOrder</span> <span class="attr">id</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">invoiceOrder</span>&gt;</span>003<span class="tag">&lt;/<span class="name">invoiceOrder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyName</span>&gt;</span>冰与火之歌3<span class="tag">&lt;/<span class="name">companyName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">taxNumber</span>&gt;</span>冰与火之歌3<span class="tag">&lt;/<span class="name">taxNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountBank</span>&gt;</span>冰与火之歌3<span class="tag">&lt;/<span class="name">accountBank</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyAddress</span>&gt;</span>乔治马丁3<span class="tag">&lt;/<span class="name">companyAddress</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bankNumber</span>&gt;</span>20143<span class="tag">&lt;/<span class="name">bankNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyTelephone</span>&gt;</span>893<span class="tag">&lt;/<span class="name">companyTelephone</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountName</span>&gt;</span>893<span class="tag">&lt;/<span class="name">accountName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">InvoiceOrder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">invoiceOrderStore</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="解析XML的几种方式："><a href="#解析XML的几种方式：" class="headerlink" title="解析XML的几种方式："></a>解析XML的几种方式：</h2><h3 id="在Java程序中如何获取xml文件的内容"><a href="#在Java程序中如何获取xml文件的内容" class="headerlink" title="在Java程序中如何获取xml文件的内容"></a>在Java程序中如何获取xml文件的内容</h3><blockquote>
<p>在Java程序中读取xml文件的过程也称为—-解析xml文件 </p>
</blockquote>
<h3 id="解析的目的："><a href="#解析的目的：" class="headerlink" title="解析的目的："></a><strong>解析的目的：</strong></h3><blockquote>
<p> 获取节点名、节点值、属性名、属性值 </p>
</blockquote>
<h3 id="四种解析方式"><a href="#四种解析方式" class="headerlink" title="四种解析方式"></a>四种解析方式</h3><blockquote>
<p><strong>DOM</strong>  ,  <strong>SAX</strong> ,  (前两者Java官方提供的)</p>
<p><strong>DOM4J</strong>  ,  <strong>JDOM</strong>（后两者其它组织提供的）</p>
</blockquote>
<h3 id="实体Bean"><a href="#实体Bean" class="headerlink" title="实体Bean"></a>实体Bean</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvoiceOrder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Integer id ;</span><br><span class="line">    <span class="keyword">private</span> String invoiceOrder;</span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line">    <span class="keyword">private</span> String taxNumber;</span><br><span class="line">    <span class="keyword">private</span> String accountBank;</span><br><span class="line">    <span class="keyword">private</span> String companyAddress;</span><br><span class="line">    <span class="keyword">private</span> String bankNumber;</span><br><span class="line">    <span class="keyword">private</span> String companyTelephone;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="基于DOM解析器转化XML文档并解析："><a href="#基于DOM解析器转化XML文档并解析：" class="headerlink" title="基于DOM解析器转化XML文档并解析："></a>基于DOM解析器转化XML文档并解析：</h2><p><strong>说明：</strong> </p>
<p>​    <strong>DOM解析器</strong>把<strong>XML</strong>文档转化为一个包含其内容的树，并可以对树进行遍历。用<strong>DOM</strong>解析模型的优点是编程容易，开发人员只需要调用建树的指令，然后利用<strong>navigation</strong> <strong>APIs</strong>访问所需的树节点来完成任务。可以很容易的添加和修改树中的元素。然而由于使用<strong>DOM</strong>解析器的时候需要处理整个<strong>XML</strong>文档，所以对性能和内存的要求比较高，尤其是遇到很大的<strong>XML</strong>文件的时候。由于它的遍历能力，<strong>DOM</strong>解析器常用于<strong>XML</strong>文档需要频繁的改变的服务中。</p>
<p><strong>常见的节点类型：</strong> </p>
<table>
<thead>
<tr>
<th>节点类型</th>
<th>NodeType</th>
<th>Named Constant</th>
<th>nodeName的返回值</th>
<th>nodeValue的返回值</th>
</tr>
</thead>
<tbody><tr>
<td>Element</td>
<td>1</td>
<td>ELEMENT_NODE</td>
<td>element name</td>
<td>null</td>
</tr>
<tr>
<td>Attr</td>
<td>2</td>
<td>ATTRIBUTE_NODE</td>
<td>属性名称</td>
<td>属性值</td>
</tr>
<tr>
<td>Text</td>
<td>3</td>
<td>TEXT_NODE</td>
<td>#text</td>
<td>节点内容</td>
</tr>
</tbody></table>
<p><strong>案例代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.*;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>  用DOM方式读取xml文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> shaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 10:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadxmlByDom</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;InvoiceOrder&gt; invoiceOrderss = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; contents = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getDoXml</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 定义工厂API 使应用程序能够从XML文档获取生成DOM对象树的解析器</span></span><br><span class="line">        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">        <span class="comment">// 获取此类的实例之后，将可以从各种输入源解析XML</span></span><br><span class="line">        DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">        <span class="comment">// builder.parse(this.getClass().getResourceAsStream("/" + fileName));</span></span><br><span class="line">        <span class="comment">// Document接口表示整个HTML或XML文档，从概念上讲，它是文档树的根，并提供对文档数据的基本访问</span></span><br><span class="line">        Document document = builder.parse(<span class="keyword">this</span>.getClass().getResourceAsStream(</span><br><span class="line">                <span class="string">"/"</span> + fileName));</span><br><span class="line">        <span class="comment">// 获取根节点</span></span><br><span class="line">        Element root = document.getDocumentElement();</span><br><span class="line">        System.out.println(root.getNodeName());</span><br><span class="line"> </span><br><span class="line">        invoiceOrderss = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//读取database节点NodeList接口提供对节点的有序集合的抽象</span></span><br><span class="line">        NodeList nodeList = root.getElementsByTagName(<span class="string">"InvoiceOrder"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) &#123;</span><br><span class="line"> </span><br><span class="line">            InvoiceOrder invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 获取一个节点</span></span><br><span class="line">            Node node = nodeList.item(i);</span><br><span class="line">            <span class="comment">// 获取该节点所有属性</span></span><br><span class="line">            NamedNodeMap attributes = node.getAttributes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; attributes.getLength(); j++) &#123;</span><br><span class="line">                Node attribute = attributes.item(j);</span><br><span class="line">                System.out.println(attribute.getNodeName() + <span class="string">":"</span></span><br><span class="line">                        + attribute.getNodeValue());</span><br><span class="line">                invoiceOrder.setId(Integer.parseInt(attribute.getNodeValue()));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//获取所有子节点数据</span></span><br><span class="line">            NodeList childNodes = node.getChildNodes();</span><br><span class="line">            System.out.println(childNodes.getLength());</span><br><span class="line">           contents = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;childNodes.getLength();j+=<span class="number">2</span>)&#123;</span><br><span class="line">                Node item = childNodes.item(j);</span><br><span class="line">                String content = item.getFirstChild().getTextContent();</span><br><span class="line">                contents.add(content);</span><br><span class="line"><span class="comment">//                System.out.println(content);</span></span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span>(contents.size()&gt;=<span class="number">8</span>)&#123;</span><br><span class="line"> </span><br><span class="line">                invoiceOrder.setInvoiceOrder(contents.get(<span class="number">0</span>));</span><br><span class="line">                invoiceOrder.setCompanyName(contents.get(<span class="number">1</span>));</span><br><span class="line">                invoiceOrder.setTaxNumber(contents.get(<span class="number">2</span>));</span><br><span class="line">                invoiceOrder.setAccountBank(contents.get(<span class="number">3</span>));</span><br><span class="line">                invoiceOrder.setCompanyAddress(contents.get(<span class="number">4</span>));</span><br><span class="line">                invoiceOrder.setBankNumber(contents.get(<span class="number">5</span>));</span><br><span class="line">                invoiceOrder.setCompanyTelephone(contents.get(<span class="number">6</span>));</span><br><span class="line">                invoiceOrder.setAccountName(contents.get(<span class="number">7</span>));</span><br><span class="line">                invoiceOrderss.add(invoiceOrder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invoiceOrderss;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;InvoiceOrder&gt; doXml = <span class="keyword">new</span> ReadxmlByDom().getDoXml(<span class="string">"invoiceOrder.xml"</span>);</span><br><span class="line">            <span class="keyword">for</span> (InvoiceOrder invoiceOrder : doXml) &#123;</span><br><span class="line">                System.out.println(invoiceOrder.toString());</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中"><a href="#使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中" class="headerlink" title="使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中"></a>使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中</h2><h3 id="使用SAX方式解析XML"><a href="#使用SAX方式解析XML" class="headerlink" title="使用SAX方式解析XML"></a>使用SAX方式解析XML</h3><p><strong>说明：</strong> </p>
<blockquote>
<p>AX解析器采用了基于事件的模型，它在解析XML文档的时候可以触发一系列的事件，当发现给定的tag的时候，它可以激活一个回调方法，告诉该方法制定的标签已经找到。SAX对内存的要求通常会比较低，因为它让开发人员自己来决定所要处理的tag.特别是当开发人员只需要处理文档中所包含的部分数据时，SAX这种扩展能力得到了更好的体现。但用SAX解析器的时候编码工作会比较困难，而且很难同时访问同一个文档中的多处不同数据。</p>
</blockquote>
<p><strong>SAX解析原理：</strong> </p>
<p><code>通过自己创建的Handler处理类，去逐个分析遇到的每一个节点，从外层到里层</code></p>
<p><strong>startElement   endElement</strong> :</p>
<blockquote>
<p>1.通过SAXParserFactory的静态newInstance()方法获取SAXParserFactory实例factory<br>2.通过SAXParserFactory实例的newSAXParser（）方法返回SAXParser实例parser<br>3.创建一个类继承DefaultHandler，重写其中的一些方法进行业务处理并创建这个类的实例handler</p>
</blockquote>
<p><strong>SAX解析XML文件的结点属性：</strong> </p>
<blockquote>
<p>重写startElement(String uri, String localName, String qName,Attributes attributes)方法，</p>
<p>获取属性名 : attributes.getValue(index);</p>
<p>获取属性值 ：attributes.getValue(index);</p>
</blockquote>
<p><strong>AX解析XML的速度比DOM的块</strong>.</p>
<p>SAX的解析XML的解析器，需要<strong>重写startElement(</strong>)开始解析的方法and endElemaent()方法 结束解析的方法and characters()方法<br><strong>重写charaters()</strong>方法时，String(byte[] bytes,int offset,int length)的构造方法进行数组的传递 再去除解析时多余空格</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!value.trim().equals(<span class="string">""</span>))&#123;</span><br><span class="line"> </span><br><span class="line">  System.out.println(value);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>案例代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 用SAX解析xml文件时需要的handler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> shaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 14:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SAXParseHandler</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> List&lt;InvoiceOrder&gt; list;         <span class="comment">//存放解析到的invoiceOrder数组</span></span><br><span class="line">    <span class="keyword">private</span> InvoiceOrder invoiceOrder;               <span class="comment">//存放当前解析的invoiceOrder</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String content = <span class="keyword">null</span>;   <span class="comment">//存放当前节点值</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Integer count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始解析xml文档时调用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.startDocument();</span><br><span class="line">        System.out.println(<span class="string">"开始解析xml文件"</span>);</span><br><span class="line">        list = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档解析完成后调用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.endDocument();</span><br><span class="line">        System.out.println(<span class="string">"xml文件解析完毕"</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始解析节点时调用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.startElement(uri, localName, qName, attributes);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//当节点名为invoiceOrder时,获取invoiceOrder的属性id</span></span><br><span class="line">        <span class="keyword">if</span>(qName.equals(<span class="string">"InvoiceOrder"</span>))&#123;</span><br><span class="line">            invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line">            String id = attributes.getValue(<span class="string">"id"</span>);<span class="comment">//System.out.println("id值为"+id);</span></span><br><span class="line">            invoiceOrder.setId(Integer.parseInt(id));</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//xml解析张数</span></span><br><span class="line">            count ++ ;</span><br><span class="line">            System.out.println( count + <span class="string">"--- 次"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *节点解析完毕时调用此方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *<span class="doctag">@param</span> qName 节点名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.endElement(uri, localName, qName);</span><br><span class="line">        <span class="keyword">if</span>(qName.equals(<span class="string">"invoiceOrder"</span>))&#123;</span><br><span class="line">            invoiceOrder.setInvoiceOrder(content);</span><br><span class="line">            System.out.println(<span class="string">"发票单号"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"companyName"</span>))&#123;</span><br><span class="line">            invoiceOrder.setCompanyName(content);</span><br><span class="line">              System.out.println(<span class="string">"公司名"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"taxNumber"</span>))&#123;</span><br><span class="line">            invoiceOrder.setTaxNumber(content);</span><br><span class="line">              System.out.println(<span class="string">"金额"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"accountBank"</span>))&#123;</span><br><span class="line">            invoiceOrder.setAccountBank(content);</span><br><span class="line">              System.out.println(<span class="string">"开户行"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"companyAddress"</span>))&#123;</span><br><span class="line">            invoiceOrder.setCompanyAddress(content);</span><br><span class="line">              System.out.println(<span class="string">"公司地址"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"bankNumber"</span>))&#123;</span><br><span class="line">            invoiceOrder.setBankNumber(content);</span><br><span class="line">              System.out.println(<span class="string">"账号"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"companyTelephone"</span>))&#123;</span><br><span class="line">            invoiceOrder.setCompanyTelephone(content);</span><br><span class="line">              System.out.println(<span class="string">"公司电话"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"accountName"</span>))&#123;</span><br><span class="line">            invoiceOrder.setAccountName(content);</span><br><span class="line">              System.out.println(<span class="string">"账户类型"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"invoiceOrder"</span>))&#123;         <span class="comment">//当结束当前invoiceOrder解析时,将该invoiceOrder添加到数组后置为空，方便下一次invoiceOrder赋值</span></span><br><span class="line">            list.add(invoiceOrder);</span><br><span class="line">            invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此方法用来获取节点的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span>[] ch, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.characters(ch, start, length);</span><br><span class="line"> </span><br><span class="line">        content = <span class="keyword">new</span> String(ch, start, length);</span><br><span class="line">        <span class="comment">//收集不为空白的节点值</span></span><br><span class="line"><span class="comment">//      if(!content.trim().equals(""))&#123;</span></span><br><span class="line"><span class="comment">//          System.out.println("节点值为："+content);</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">()</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParser;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>  SAX方式解析XML</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 14:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadXmlBySAX</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> SAXParserFactory sParserFactory = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> SAXParser parser = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SAXParserFactory sParserFactory = SAXParserFactory.newInstance();</span><br><span class="line">        SAXParser parser = sParserFactory.newSAXParser();</span><br><span class="line"> </span><br><span class="line">        SAXParseHandler handler = <span class="keyword">new</span> SAXParseHandler();</span><br><span class="line">        parser.parse(fileName, handler);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> handler.getInvoiceOrders();</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            invoiceOrders = <span class="keyword">new</span> ReadXmlBySAX().getInvoiceOrders(<span class="string">"src/main/resources/invoiceOrder.xml"</span>);</span><br><span class="line">            <span class="keyword">for</span>(InvoiceOrder invoiceOrder: invoiceOrders)&#123;</span><br><span class="line">                System.out.println(invoiceOrder);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="将解析的内容及xml结构形式保存至Java对象中"><a href="#将解析的内容及xml结构形式保存至Java对象中" class="headerlink" title="将解析的内容及xml结构形式保存至Java对象中"></a>将解析的内容及xml结构形式保存至Java对象中</h3><p><strong>SAX解析：</strong>  </p>
<blockquote>
<p>1、获取一个SAXParserFactory的实例:SAXParserFactory factory = SAXParserFactory.newInstance();</p>
<p>2、通过factory获取SAXParser实例：SAXParser parser = factory.newSAXParser();</p>
<p>3、创建SAXParserHandler对象：SAXParserHandler handler = new SAXParserHandler();</p>
<p>4、将xml文件和解析方式handler加载到SAXParser实例：parser.parse(“books.xml”,handler);</p>
</blockquote>
<p>​    解析的时候，是     <code>startElement-characters-endElement ， characters</code>解析完一个属性，就到  <code>endElement</code>，然后又解析一个属性又到  <code>endElement</code>,最后解析完全部属性，到  <code>endElement</code>又到  <code>startElement</code>开始下一个节点。</p>
<p>​    <code>ArrayList</code> 保存对象 <code>ArrayList&lt;Book&gt; BookList=new ArrayList&lt;Book&gt;();</code></p>
<p>​    <code>BookList.add（book）;book=null;</code> 后继续遍历</p>
<p>​    <code>public void startElement(String uri, String localName, String qName,Attributes attributes) throws SAXException// qName</code>是String类型节点名称；attributes是Attributes类型的实例，属性的意思；</p>
<h2 id="用JDOM方式读取xml文件"><a href="#用JDOM方式读取xml文件" class="headerlink" title="用JDOM方式读取xml文件"></a>用JDOM方式读取xml文件</h2><h3 id="说明："><a href="#说明：" class="headerlink" title="说明："></a><strong>说明：</strong></h3><p>​    JDOM仅使用具体类而不使用接口。API大量使用了Collections类；JDOM自身不包含解析器。它通常使用SAX2解析器来解析和验证输入XML文档（尽管它还可以将以前构造的DOM表示作为输入）。它包含一些转换器以将JDOM表示输出成SAX2事件流、DOM模型或XML文本文档。JDOM是在Apache许可证变体下发布的开放源码。</p>
<h3 id="JDOM解析文件步骤"><a href="#JDOM解析文件步骤" class="headerlink" title="JDOM解析文件步骤"></a><strong>JDOM解析文件步骤</strong></h3><p>准备：导入jar包<br>    1.创建一个SAXBuilder对象<br>              <code>SAXBuilder saxbuilder=newSAXBuilder();</code></p>
<p>​    2.创建输入流，将xml文件加载到输入流中<br>            <code>Inputstream in=new FileInputstream(&quot;xxx.xml&quot;);</code></p>
<p>​    3.通过SAXBuilder的Build方法将输入流加载到saxb中获取dom对象<br>            <code>Document doc = saxbuilder.build(in);</code></p>
<p>​    4.通过document对象获取xml文件的根结点<br>           <code>Element rootElement =doc.getRootElement();</code></p>
<p>​    5.获取根结点下的子节点的List集合</p>
<h3 id="案例代码："><a href="#案例代码：" class="headerlink" title="案例代码："></a><strong>案例代码：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Attribute;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Document;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Element;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.JDOMException;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.input.SAXBuilder;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 用JDOM方式读取xml文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 15:14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadXMLByJDom</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> List&lt;InvoiceOrder&gt; invoiceOrders = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> InvoiceOrder invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        SAXBuilder saxBuilder = <span class="keyword">new</span> SAXBuilder();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document document = saxBuilder.build(<span class="keyword">new</span> FileInputStream(fileName));</span><br><span class="line">            <span class="comment">//获取根节点bookstore</span></span><br><span class="line">            Element rootElement = document.getRootElement();</span><br><span class="line">            <span class="comment">//获取根节点的子节点，返回子节点的数组</span></span><br><span class="line">            List&lt;Element&gt; bookList = rootElement.getChildren();</span><br><span class="line">            invoiceOrders = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Element bookElement : bookList) &#123;</span><br><span class="line">                invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line">                <span class="comment">//获取bookElement的属性</span></span><br><span class="line">                List&lt;Attribute&gt; bookAttributes = bookElement.getAttributes();</span><br><span class="line">                <span class="keyword">for</span> (Attribute attribute : bookAttributes) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (attribute.getName().equals(<span class="string">"id"</span>)) &#123;</span><br><span class="line">                        String id = attribute.getValue(); <span class="comment">//System.out.println(id);</span></span><br><span class="line">                        invoiceOrder.setId(Integer.parseInt(id));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//获取bookElement的子节点</span></span><br><span class="line">                List&lt;Element&gt; children = bookElement.getChildren();</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">for</span> (Element child : children) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (child.getName().equals(<span class="string">"invoiceOrder"</span>)) &#123;</span><br><span class="line">                        String invoiceOrderid = child.getValue();</span><br><span class="line">                        invoiceOrder.setInvoiceOrder(invoiceOrderid);</span><br><span class="line"><span class="comment">//                        System.out.println("发票单号"+"---"+invoiceOrderid);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"companyName"</span>)) &#123;</span><br><span class="line">                        String companyName = child.getValue();</span><br><span class="line">                        invoiceOrder.setCompanyName(companyName);</span><br><span class="line"><span class="comment">//                        System.out.println("公司名"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"taxNumber"</span>)) &#123;</span><br><span class="line">                        String taxNumber = child.getValue();</span><br><span class="line">                        invoiceOrder.setTaxNumber(taxNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("金额"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"accountBank"</span>)) &#123;</span><br><span class="line">                        String accountBank = child.getValue();</span><br><span class="line">                        invoiceOrder.setAccountBank(accountBank);</span><br><span class="line"><span class="comment">//                        System.out.println("开户行"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"companyAddress"</span>)) &#123;</span><br><span class="line">                        String companyAddress = child.getValue();</span><br><span class="line">                        invoiceOrder.setCompanyAddress(companyAddress);</span><br><span class="line"><span class="comment">//                        System.out.println("公司地址"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"bankNumber"</span>)) &#123;</span><br><span class="line">                        String bankNumber = child.getValue();</span><br><span class="line">                        invoiceOrder.setBankNumber(bankNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("账号"+"---"+bankNumber);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"companyTelephone"</span>)) &#123;</span><br><span class="line">                        String companyTelephone = child.getValue();</span><br><span class="line">                        invoiceOrder.setCompanyTelephone(companyTelephone);</span><br><span class="line"><span class="comment">//                        System.out.println("公司电话"+"---"+companyTelephone);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"accountName"</span>)) &#123;</span><br><span class="line">                        String accountName = child.getValue();</span><br><span class="line">                        invoiceOrder.setAccountName(accountName);</span><br><span class="line"><span class="comment">//                        System.out.println("账户类型"+"---"+accountName);</span></span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                invoiceOrders.add(invoiceOrder);</span><br><span class="line">                invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JDOMException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> invoiceOrders;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">           String fileName = <span class="string">"src/main/resources/invoiceOrder.xml"</span>;</span><br><span class="line">        List&lt;InvoiceOrder&gt; invoiceOrders= <span class="keyword">new</span> ReadXMLByJDom().getInvoiceOrders(fileName);</span><br><span class="line">        <span class="keyword">for</span>(InvoiceOrder invoiceOrder : invoiceOrders)&#123;</span><br><span class="line">            System.out.println(invoiceOrder);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="用DOM4J方法读取xml文件"><a href="#用DOM4J方法读取xml文件" class="headerlink" title="用DOM4J方法读取xml文件"></a>用DOM4J方法读取xml文件</h3><h4 id="说明：-1"><a href="#说明：-1" class="headerlink" title="说明："></a><strong>说明：</strong></h4><p>​    DOM4J使用接口和抽象基本类方法。DOM4J大量使用了API中的Collections类，但是在许多情况下，它还提供一些替代方法以允许更好的性能或更直接的编码方法。直接好处是，虽然DOM4J付出了更复杂 的API的代价，但是它提供了比JDOM大得多的灵活性。 DOM4J性能最好，连Sun的JAXM也在用DOM4J.目前许多开源项目中大量采用DOM4J， 例如大名鼎鼎的Hibernate也用DOM4J来读取XML配置文件。</p>
<p><strong>案例代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Attribute;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Element;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 用DOM4J方法读取xml文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 15:34</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadXMLByDom4j</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> List&lt;InvoiceOrder&gt; invoiceOrders = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> InvoiceOrder invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document document = reader.read(file);</span><br><span class="line">            Element bookstore = document.getRootElement();</span><br><span class="line">            Iterator storeit = bookstore.elementIterator();</span><br><span class="line"> </span><br><span class="line">            invoiceOrders = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line">            <span class="keyword">while</span> (storeit.hasNext()) &#123;</span><br><span class="line"> </span><br><span class="line">                invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line">                Element bookElement = (Element) storeit.next();</span><br><span class="line">                <span class="comment">//遍历bookElement的属性</span></span><br><span class="line">                List&lt;Attribute&gt; attributes = bookElement.attributes();</span><br><span class="line">                <span class="keyword">for</span> (Attribute attribute : attributes) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (attribute.getName().equals(<span class="string">"id"</span>)) &#123;</span><br><span class="line">                        String id = attribute.getValue();<span class="comment">//System.out.println(id);</span></span><br><span class="line">                        invoiceOrder.setId(Integer.parseInt(id));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                Iterator bookit = bookElement.elementIterator();</span><br><span class="line">                <span class="keyword">while</span> (bookit.hasNext()) &#123;</span><br><span class="line">                    Element child = (Element) bookit.next();</span><br><span class="line"><span class="comment">//                    String nodeName = child.getName();</span></span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">if</span>(child.getName().equals(<span class="string">"invoiceOrder"</span>))&#123;</span><br><span class="line">                        String invoiceOrderid = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setInvoiceOrder(invoiceOrderid);</span><br><span class="line"><span class="comment">//                        System.out.println("发票单号"+"---"+invoiceOrderid);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"companyName"</span>))&#123;</span><br><span class="line">                        String companyName = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setCompanyName(companyName);</span><br><span class="line"><span class="comment">//                        System.out.println("公司名"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"taxNumber"</span>))&#123;</span><br><span class="line">                        String taxNumber = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setTaxNumber(taxNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("金额"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"accountBank"</span>))&#123;</span><br><span class="line">                        String accountBank = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setAccountBank(accountBank);</span><br><span class="line"><span class="comment">//                        System.out.println("开户行"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"companyAddress"</span>))&#123;</span><br><span class="line">                        String companyAddress = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setCompanyAddress(companyAddress);</span><br><span class="line"><span class="comment">//                        System.out.println("公司地址"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"bankNumber"</span>))&#123;</span><br><span class="line">                        String bankNumber = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setBankNumber(bankNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("账号"+"---"+bankNumber);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"companyTelephone"</span>))&#123;</span><br><span class="line">                        String companyTelephone = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setCompanyTelephone(companyTelephone);</span><br><span class="line"><span class="comment">//                        System.out.println("公司电话"+"---"+companyTelephone);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"accountName"</span>))&#123;</span><br><span class="line">                        String accountName = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setAccountName(accountName);</span><br><span class="line"><span class="comment">//                        System.out.println("账户类型"+"---"+accountName);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                invoiceOrders.add(invoiceOrder);</span><br><span class="line">                invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> invoiceOrders;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">          File file = <span class="keyword">new</span> File(<span class="string">"src/main/resources/invoiceOrder.xml"</span>);</span><br><span class="line">        List&lt;InvoiceOrder&gt; invoiceOrders = <span class="keyword">new</span> ReadXMLByDom4j().getInvoiceOrders(file);</span><br><span class="line">        <span class="keyword">for</span> (InvoiceOrder invoiceOrder : invoiceOrders) &#123;</span><br><span class="line">            System.out.println(invoiceOrder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>JavaWeb</category>
      </categories>
  </entry>
  <entry>
    <title>计算机网络（三）TCP三次握手和四次挥手</title>
    <url>/2020/03/19/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/</url>
    <content><![CDATA[<h2 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h2><p>所谓三次握手（Three-Way Handshake）即建立TCP连接，就是指建立一个TCP连接时，需要客户端和服务端总共发送3个包以确认连接的建立。整个流程如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu136.png" width="100%">

<ol>
<li>第一次握手：Client将标志位SYN置为1，随机产生一个值seq=J，并将该数据包发送给Server，Client进入SYN_SENT状态，等待Server确认。</li>
<li>第二次握手：Server收到数据包后由标志位SYN=1知道Client请求建立连接，Server将标志位SYN和ACK都置为1，ack=J+1，随机产生一个值seq=K，并将该数据包发送给Client以确认连接请求，Server进入SYN_RCVD状态。</li>
<li>第三次握手：Client收到确认后，检查ack是否为J+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1，并将该数据包发送给Server，Server检查ack是否为K+1，ACK是否为1，如果正确则连接建立成功，Client和Server进入ESTABLISHED状态，完成三次握手，随后Client与Server之间可以开始传输数据了。</li>
</ol>
<h3 id="为什么需要三次握手，而不是二次握手？"><a href="#为什么需要三次握手，而不是二次握手？" class="headerlink" title="为什么需要三次握手，而不是二次握手？"></a>为什么需要三次握手，而不是二次握手？</h3><p>主要是为了防止两次握手情况下已失效的连接请求报文段突然又传送到服务端,而产生的错误。举例如下:</p>
<p>Client向Server发出TCP连接请求,第一个连接请求报文在网络的某个节点长时间滞留,Client超时后认为报文丢失,于是再重传一次连接请求,Server收到后建立连接。数据传输完毕后双方断开连接。而此时,前一个滞留在网络中的连接请求到达了服务端Server,而Server认为Client又发来连接请求,若采用的是“两次握手”,则这种情况下Server认为传输连接已经建立,并一直等待Client传输数据,而Client此时并无连接请求,因此不予理睬,这样就造成了Server的资源白白浪费了;但此时若是使用“三次握手”,则Server向Client返回确认报文段,由于是一个失效的请求,因此Client不予理睬,建立连接失败。第三次握手的作用:防止已失效的连接请求报文段突然又传送到了服务器。</p>
<h3 id="第三次握手失败后怎么处理？"><a href="#第三次握手失败后怎么处理？" class="headerlink" title="第三次握手失败后怎么处理？"></a>第三次握手失败后怎么处理？</h3><p>如果此时ACK在网络中丢失，那么Server端该TCP连接的状态为SYN_RECV，并且依次等待3秒、6秒、12秒后重新发送SYN+ACK包，以便Client重新发送ACK包，以便Client重新发送ACK包。</p>
<p>Server重发SYN+ACK包的次数，可以通过设置/proc/sys/net/ipv4/tcp_synack_retries修改，默认值为5。</p>
<p>如果重发指定次数后，仍然未收到ACK应答，那么一段时间后，Server自动关闭这个连接。但是Client认为这个连接已经建立，如果Client端向Server写数据，Server端将以RST包响应，方能感知到Server的错误。</p>
<h2 id="TCP四次挥手-Client或Server均可主动发起挥手动作"><a href="#TCP四次挥手-Client或Server均可主动发起挥手动作" class="headerlink" title="TCP四次挥手(Client或Server均可主动发起挥手动作)"></a>TCP四次挥手(Client或Server均可主动发起挥手动作)</h2><p>所谓四次挥手（Four-Way Wavehand）即终止TCP连接，就是指断开一个TCP连接时，需要客户端和服务端总共发送4个包以确认连接的断开。整个流程如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu137.png" width="100%">

<ol>
<li>第一次挥手：Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。</li>
<li>第二次挥手：Server收到FIN后，发送一个ACK给Client，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），Server进入CLOSE_WAIT状态。</li>
<li>第三次挥手：Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。</li>
<li>第四次挥手：Client收到FIN后，Client进入TIME_WAIT状态，接着发送一个ACK给Server，确认序号为收到序号+1，Server进入CLOSED状态，完成四次挥手。</li>
</ol>
<h3 id="为什么连接的时候是三次握手，关闭的时候却是四次握手？"><a href="#为什么连接的时候是三次握手，关闭的时候却是四次握手？" class="headerlink" title="为什么连接的时候是三次握手，关闭的时候却是四次握手？"></a>为什么连接的时候是三次握手，关闭的时候却是四次握手？</h3><p>Server在LISTEN状态下，收到建立连接请求的SYN报文后，可以直接把ACK和SYN放在一个报文里发送给Client。而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，己方也未必全部数据都发送给对方了，所以己方可以立即close，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送。 </p>
<h3 id="为什么TIME-WAIT状态需要经过2MSL-最大报文段生存时间-才能返回到CLOSE状态？"><a href="#为什么TIME-WAIT状态需要经过2MSL-最大报文段生存时间-才能返回到CLOSE状态？" class="headerlink" title="为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？"></a>为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？</h3><ol>
<li>Client的最后一个ACK报文在传输的时候丢失，Server并没有接收到这个报文。这个时候，Server就会超时重传这个FIN消息，然后Client就会重新返回最后一个ACK报文，等待两个时间周期，完成关闭。如果不等待这两个时间周期，Server重传的那条消息就不会收到。Server就因为接收不到Client的信息而无法正常关闭。</li>
<li>防止“已失效的连接请求报文段”出现在本连接中。在发送完最后一个ACK报文段后,再经过2MSL,就可以使本连接持续的时间内所产生的所有报文段,都从网络中消失。这样就可以使下一个新的连接中不会出现这种就得连接请求报文段。</li>
</ol>
<p><strong>声明：</strong>本文转载自： <a href="https://www.cnblogs.com/wupeixuan/p/8639469.html" target="_blank" rel="noopener">https://www.cnblogs.com/wupeixuan/p/8639469.html</a> </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（十二）历史流程操作</title>
    <url>/2020/03/19/Activity-%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E5%8E%86%E5%8F%B2%E6%B5%81%E7%A8%8B%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>历史流程的操作，其本质上就是查询历史流程实例表act_hi_procinst:</p>
<p>该表中的 ID_ 和流程实例Id始终是一样的。所以Activiti没有提供获取流程实例id的接口；</p>
<p> 因为直接getId()获取的值和流程实例Id是一样的；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询历史流程实例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getHistoryProcessInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">       HistoricProcessInstance hpi= processEngine.getHistoryService() <span class="comment">// 历史任务Service</span></span><br><span class="line">           .createHistoricProcessInstanceQuery() <span class="comment">// 创建历史流程实例查询</span></span><br><span class="line">           .processInstanceId(<span class="string">"57501"</span>) <span class="comment">// 指定流程实例ID</span></span><br><span class="line">           .singleResult();</span><br><span class="line">       System.out.println(<span class="string">"流程实例ID:"</span>+hpi.getId());</span><br><span class="line">       System.out.println(<span class="string">"创建时间："</span>+hpi.getStartTime());</span><br><span class="line">       System.out.println(<span class="string">"结束时间："</span>+hpi.getEndTime());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">流程实例ID</span>:<span class="string">57501</span></span><br><span class="line"><span class="meta">创建时间：Thu</span> <span class="string">Mar 19 21:37:02 CST 2020</span></span><br><span class="line"><span class="meta">结束时间：Thu</span> <span class="string">Mar 19 21:42:17 CST 2020</span></span><br></pre></td></tr></table></figure>



<p><strong>历史流程任务查询act_hi_taskinst表：</strong></p>
<p><code>不管是已经完结的任务还是正在执行的任务，都会记录下这个表里。</code></p>
<p><code>Activiti给我们提供了一个接口finished；加了之后就是查询已经完结的任务；</code></p>
<p><code>同理还有一个接口unfinished 顾名思义，就是查询未完结的任务；当然这两个都不加，</code></p>
<p><code>就是把所有任务都查询出来；</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 历史任务查询</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">historyTaskList</span><span class="params">()</span></span>&#123;</span><br><span class="line">       List&lt;HistoricTaskInstance&gt; list=processEngine.getHistoryService() <span class="comment">// 历史任务Service</span></span><br><span class="line">               .createHistoricTaskInstanceQuery() <span class="comment">// 创建历史任务实例查询</span></span><br><span class="line">               .taskAssignee(<span class="string">"白夜行"</span>) <span class="comment">// 指定办理人</span></span><br><span class="line">               .finished() <span class="comment">// 查询已经完成的任务  </span></span><br><span class="line">               .list();</span><br><span class="line">       <span class="keyword">for</span>(HistoricTaskInstance hti:list)&#123;</span><br><span class="line">           System.out.println(<span class="string">"任务ID:"</span>+hti.getId());</span><br><span class="line">           System.out.println(<span class="string">"流程实例ID:"</span>+hti.getProcessInstanceId());</span><br><span class="line">           System.out.println(<span class="string">"班里人："</span>+hti.getAssignee());</span><br><span class="line">           System.out.println(<span class="string">"创建时间："</span>+hti.getCreateTime());</span><br><span class="line">           System.out.println(<span class="string">"结束时间："</span>+hti.getEndTime());</span><br><span class="line">           System.out.println(<span class="string">"==========================="</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">任务ID:57504</span><br><span class="line">流程实例ID:57501</span><br><span class="line">班里人：白夜行</span><br><span class="line">创建时间：Thu Mar 19 21:37:02 CST 2020</span><br><span class="line">结束时间：Thu Mar 19 21:42:17 CST 2020</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">任务ID:62504</span><br><span class="line">流程实例ID:62501</span><br><span class="line">班里人：白夜行</span><br><span class="line">创建时间：Thu Mar 19 21:41:19 CST 2020</span><br><span class="line">结束时间：Thu Mar 19 21:42:17 CST 2020</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（十一）删除Key相同的流程</title>
    <url>/2020/03/18/Activity-%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E5%88%A0%E9%99%A4Key%E7%9B%B8%E5%90%8C%E7%9A%84%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<p> 一个流程定义不需要的，包括所有版本，这时候在用户界面上一个一个删除太麻烦；</p>
<p> 有时候有这样的需求，一下子把所有Key相同的流程定义批量删除；</p>
<p> 实现步骤是：</p>
<p> 1、根据Key查询所有的流程定义</p>
<p> 2、遍历集合，取得每个流程的部署ID</p>
<p> 3、根据流程部署ID即可删除所有的流程定义</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除所有Key相同的流程定义</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteByKey</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; pdList=processEngine.getRepositoryService()  <span class="comment">// 获取service类</span></span><br><span class="line">            .createProcessDefinitionQuery() <span class="comment">// 创建流程定义查询</span></span><br><span class="line">            .processDefinitionKey(<span class="string">"myProcess"</span>) <span class="comment">// 根据Key查询</span></span><br><span class="line">            .list();</span><br><span class="line">    <span class="keyword">for</span>(ProcessDefinition pd:pdList)&#123;  <span class="comment">// 遍历集合 获取流程定义的每个部署Id，根据这个id来删除所有流程定义</span></span><br><span class="line">        processEngine.getRepositoryService()</span><br><span class="line">        .deleteDeployment(pd.getDeploymentId(), <span class="keyword">true</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（十）修改流程定义</title>
    <url>/2020/03/18/Activity-%EF%BC%88%E5%8D%81%EF%BC%89%E4%BF%AE%E6%94%B9%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[<p>流程定义按本质来说是不能修改的；假如一个流程定义的流程实例在活动运行中。</p>
<p>假如可以修改，本来要流转到A这个节点，因为流程定义修改了，流转到B这个节点。</p>
<p>就不符合当时这个流程实例的初衷了；</p>
<p>所以在开发中，不能修改流程定义，而是通过增加版本号的方式。来实现“修改”的；</p>
<p>什么是版本号呢?<br><img src="http://photo.wushaopei.com/qiniu132.png" width="60%"></p>
<p> 在设计流程图的时候，这里的Id 对应到数据库里的就是那个Key值  只要Id相同。就算是同一个流程定义；</p>
<p> 比如这个流程发布多次，Id一样，到数据库表那边 Key作为版本属性 值会增加；</p>
<img src="http://photo.wushaopei.com/qiniu133.png" width="60%">

<p> 启动流程实例的时候，是用Key来启动。这样启动的时候就是用的最新版本的流程定义来启动流程实例。</p>
<img src="http://photo.wushaopei.com/qiniu135.png" width="60%">

<p> 接着说说这个流程ID是怎样组成的：</p>
<img src="http://photo.wushaopei.com/qiniu134.png" width="60%">

<p> 这个Id值组成的话是  key值:版本号:流程部署ID。</p>
<p> 最后传说中的修改就是在发布一次流程定义，因为它在数据库中就原本就存在该流程，</p>
<p> 所以在发布一次它就会在版本号这个字段增加。在到做流程操作的时候之须取最新的版本号即可。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（九）查看流程图片</title>
    <url>/2020/03/14/Activity-%EF%BC%88%E4%B9%9D%EF%BC%89%E6%9F%A5%E7%9C%8B%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%89%87/</url>
    <content><![CDATA[<p>在开发中可能需要查看某个流程的流程图片。</p>
<p>对应操作的数据库表是act_ge_bytearray的Bytes_字段：</p>
<img src="http://photo.wushaopei.com/qiniu131.png" width="60%">

<p>Activiti提供了操作接口，可以查询返回一个资源文件输入流，</p>
<p>然后就可以得到这张流程图片保存到本地服务器，然后图片多在自己的服务器上，</p>
<p>你想干什么多行。</p>
<p>先在pom.xml中添加IO的Jar架包：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后就是代码实现： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过流程部署ID获取流程图图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getImageById</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"><span class="comment">//        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery()</span></span><br><span class="line"><span class="comment">//        		.processDefinitionId("myProcess.png")</span></span><br><span class="line"><span class="comment">//        		.singleResult();</span></span><br><span class="line">        InputStream inputStream=processEngine.getRepositoryService()</span><br><span class="line">            .getResourceAsStream(<span class="string">"40001"</span>, <span class="string">"myProcess.png"</span>); <span class="comment">// 根据流程部署ID和资源名称获取输入流</span></span><br><span class="line">        FileUtils.copyInputStreamToFile(inputStream, <span class="keyword">new</span> File(<span class="string">"F:/myProcess.png"</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>实际开发的时候，一般会把图片存到项目路径下，然后名字的话，可以根据当前日期年月日时分秒来命名，</p>
<p>然后得到路径后，在新的页面，或者是模态窗口里显示图片；</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（八）流程定义删除</title>
    <url>/2020/03/14/Activity-%EF%BC%88%E5%85%AB%EF%BC%89%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E5%88%A0%E9%99%A4/</url>
    <content><![CDATA[<p>在开发中肯定会有一些流程不需要了，要删除，Activiti中也是存在删除操作的，</p>
<p>通过流程定义部署ID来执行删除流程定义。</p>
<p>不说那么多直接上代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除流程定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    processEngine.getRepositoryService()</span><br><span class="line">        .deleteDeployment(<span class="string">"12501"</span>); <span class="comment">// 流程部署ID</span></span><br><span class="line">    System.out.println(<span class="string">"刪除流程定义！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是有一种情况下比如： 这个流程定义的流程实例在运行中，尚未结束。</p>
<p>这时候如果你执行删除肯定会报错的。（这个就不用我多讲了吧，表与表之间的主外键关系）</p>
<p>当然在某种情况下必须要删除就要使用级联删除：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除流程定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    processEngine.getRepositoryService()</span><br><span class="line">        .deleteDeployment(<span class="string">"12501"</span>); <span class="comment">// 流程部署ID</span></span><br><span class="line">    System.out.println(<span class="string">"刪除流程定义！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式在属于在任何情况下多能直接删除流程定义，在实际开发中一般都是使用这种方式。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（七）流程定义查询</title>
    <url>/2020/03/14/Activity-%EF%BC%88%E4%B8%83%EF%BC%89%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E6%9F%A5%E8%AF%A2/</url>
    <content><![CDATA[<p>流程定义查询本质上就是通过<code>Activiti</code>框架提供的API对<code>act_re_procdef</code>表进行查询操作。 </p>
<img src="http://photo.wushaopei.com/qiniu130.png" width="90%">

<p>通过Activiti提供的API 把act_re_procdef表的所有列的数据全部查询出来，</p>
<p>在开发系统的时候管理员、用户可以通过用户界面来维护这些数据。</p>
<p>Activiti提供非常丰富的API，可以做SQL查询、对某些字段查询、模糊查询、分页查询和排序等。</p>
<h3 id="流程定义参数列表："><a href="#流程定义参数列表：" class="headerlink" title="流程定义参数列表："></a>流程定义参数列表：</h3><table>
<thead>
<tr>
<th>id</th>
<th>仅返回具有给定id的模型。</th>
</tr>
</thead>
<tbody><tr>
<td>category</td>
<td>只返回给定类别的模型。</td>
</tr>
<tr>
<td>categoryLike</td>
<td>仅返回类别类似于给定值的模型。使用<code>%</code>字符作为通配符。</td>
</tr>
<tr>
<td>categoryNotEquals</td>
<td>仅返回没有给定类别的模型。</td>
</tr>
<tr>
<td>name</td>
<td>仅返回具有给定名称的模型。</td>
</tr>
<tr>
<td>nameLike</td>
<td>仅返回名称类似于给定值的模型。使用<code>%</code>字符作为通配符。</td>
</tr>
<tr>
<td>key</td>
<td>仅返回具有给定密钥的模型</td>
</tr>
<tr>
<td>deploymentId</td>
<td>仅返回在给定部署中部署的模型。</td>
</tr>
<tr>
<td>version</td>
<td>只返回给定版本的模型。</td>
</tr>
<tr>
<td>latestVersion</td>
<td>如果为<code>true</code>，则仅返回最新版本的模型。最好与结合使用<code>key</code>。如果<code>false</code>以值形式传递，则将其忽略并返回所有版本。</td>
</tr>
<tr>
<td>deployed</td>
<td>如果为<code>true</code>，则仅返回已部署的模型。如果为<code>false</code>，则仅返回未部署的模型（deploymentId为null）。</td>
</tr>
<tr>
<td>tenantId</td>
<td>仅返回具有给定tenantId的模型。</td>
</tr>
<tr>
<td>tenantIdLike</td>
<td>仅返回具有给定值的tenantId的模型。</td>
</tr>
<tr>
<td>withoutTenantId</td>
<td>如果为<code>true</code>，则仅返回未设置tenantId的模型。如果为<code>false</code>，<code>withoutTenantId</code>则忽略该参数。</td>
</tr>
<tr>
<td>sort</td>
<td>要排序的属性，与<em>order</em>一起使用。</td>
</tr>
</tbody></table>
<h3 id="查询流程定义-返回流程定义集合"><a href="#查询流程定义-返回流程定义集合" class="headerlink" title="查询流程定义 返回流程定义集合"></a>查询流程定义 返回流程定义集合</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询流程定义 返回流程定义集合 ---对应act_re_procdef</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; pdList=processEngine.getRepositoryService() <span class="comment">// 获取service类</span></span><br><span class="line">        .createProcessDefinitionQuery() <span class="comment">// 创建流程定义查询</span></span><br><span class="line">        .processDefinitionKey(<span class="string">"myProcess"</span>) <span class="comment">// 通过key查询</span></span><br><span class="line">        .list(); <span class="comment">// 返回一个集合</span></span><br><span class="line">    <span class="keyword">for</span>(ProcessDefinition pd:pdList)&#123;</span><br><span class="line">    	System.out.println(<span class="string">"流程定义ID:"</span>+pd.getId());<span class="comment">//流程定义的key+版本+随机生成数</span></span><br><span class="line">        System.out.println(<span class="string">"流程定义名称:"</span>+pd.getName());<span class="comment">//对应HelloWorld.bpmn文件中的name属性值</span></span><br><span class="line">        System.out.println(<span class="string">"流程定义的key:"</span>+pd.getKey());<span class="comment">//对应HelloWorld.bpmn文件中的id属性值</span></span><br><span class="line">        System.out.println(<span class="string">"流程定义的版本:"</span>+pd.getVersion());<span class="comment">//当流程定义的key值相同的情况下，版本升级，默认从1开始</span></span><br><span class="line">        System.out.println(<span class="string">"资源名称bpmn文件:"</span>+pd.getResourceName());</span><br><span class="line">        System.out.println(<span class="string">"资源名称png文件:"</span>+pd.getDiagramResourceName());</span><br><span class="line">        System.out.println(<span class="string">"部署对象ID:"</span>+pd.getDeploymentId());</span><br><span class="line">        System.out.println(<span class="string">"################################"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行输入如下：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">流程定义ID:myProcess:<span class="number">10</span>:<span class="number">50004</span></span><br><span class="line">流程定义名称:My process</span><br><span class="line">流程定义的key:myProcess</span><br><span class="line">流程定义的版本:<span class="number">10</span></span><br><span class="line">资源名称bpmn文件:diagrams/MyProcess.bpmn</span><br><span class="line">资源名称png文件:diagrams/MyProcess.myProcess.png</span><br><span class="line">部署对象ID:<span class="number">50001</span></span><br><span class="line">################################</span><br><span class="line">流程定义ID:myProcess:<span class="number">1</span>:<span class="number">22504</span></span><br><span class="line">流程定义名称:My process</span><br><span class="line">流程定义的key:myProcess</span><br><span class="line">流程定义的版本:<span class="number">1</span></span><br><span class="line">资源名称bpmn文件:diagrams/MyProcess.bpmn</span><br><span class="line">资源名称png文件:diagrams/MyProcess.myProcess.png</span><br><span class="line">部署对象ID:<span class="number">22501</span></span><br><span class="line">################################</span><br><span class="line">……省略其他的</span><br></pre></td></tr></table></figure>



<p>也可以根据某个流程定义ID来查询流程定义信息，返回单个结果（说通俗点就是根据ID查询）： </p>
<h3 id="通过ID查询当个流程定义"><a href="#通过ID查询当个流程定义" class="headerlink" title="通过ID查询当个流程定义"></a>通过ID查询当个流程定义</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过ID查询当个流程定义</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getById</span><span class="params">()</span></span>&#123;</span><br><span class="line">   ProcessDefinition pd=processEngine.getRepositoryService() <span class="comment">// 获取service类</span></span><br><span class="line">            .createProcessDefinitionQuery() <span class="comment">// 创建流程定义查询</span></span><br><span class="line">            .processDefinitionId(<span class="string">"myProcess:10:50004"</span>) <span class="comment">// 通过id查询</span></span><br><span class="line">            .singleResult(); <span class="comment">// 查询返回当个结果</span></span><br><span class="line">	   System.out.println(<span class="string">"流程定义ID:"</span>+pd.getId());<span class="comment">//流程定义的key+版本+随机生成数</span></span><br><span class="line">       System.out.println(<span class="string">"流程定义名称:"</span>+pd.getName());<span class="comment">//对应HelloWorld.bpmn文件中的name属性值</span></span><br><span class="line">       System.out.println(<span class="string">"流程定义的key:"</span>+pd.getKey());<span class="comment">//对应HelloWorld.bpmn文件中的id属性值</span></span><br><span class="line">       System.out.println(<span class="string">"流程定义的版本:"</span>+pd.getVersion());<span class="comment">//当流程定义的key值相同的情况下，版本升级，默认从1开始</span></span><br><span class="line">       System.out.println(<span class="string">"资源名称bpmn文件:"</span>+pd.getResourceName());</span><br><span class="line">       System.out.println(<span class="string">"资源名称png文件:"</span>+pd.getDiagramResourceName());</span><br><span class="line">       System.out.println(<span class="string">"部署对象ID:"</span>+pd.getDeploymentId());</span><br><span class="line">       System.out.println(<span class="string">"################################"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行结果如下：</strong>  </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">流程定义ID:myProcess:<span class="number">10</span>:<span class="number">50004</span></span><br><span class="line">流程定义名称:My process</span><br><span class="line">流程定义的key:myProcess</span><br><span class="line">流程定义的版本:<span class="number">10</span></span><br><span class="line">资源名称bpmn文件:diagrams/MyProcess.bpmn</span><br><span class="line">资源名称png文件:diagrams/MyProcess.myProcess.png</span><br><span class="line">部署对象ID:<span class="number">50001</span></span><br><span class="line">################################</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu124.png" width="60%">

<p>可以模糊查询，根据某些字段查询，以及分页查询等等。</p>
<p>整体来说这些操作API的使用就跟Hibernate框架的使用差不多，它内部多封装好了你只需要调用即可。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>EasyUI笔记（三）案例:后台管理页面-框架与需求确立</title>
    <url>/2020/03/14/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89%E6%A1%88%E4%BE%8B-%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2-%E6%A1%86%E6%9E%B6%E4%B8%8E%E9%9C%80%E6%B1%82%E7%A1%AE%E7%AB%8B/</url>
    <content><![CDATA[<h3 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h3><p><code>模拟实现一个电商项目中子模块后台管理模块的增删改查。</code></p>
<p>粗粒度：</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>细功能</th>
</tr>
</thead>
<tbody><tr>
<td>后台管理模块</td>
<td>对商品菜单的增删改查</td>
</tr>
</tbody></table>
<p>细粒度</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>细功能</th>
</tr>
</thead>
<tbody><tr>
<td>查</td>
<td>列表分三级，一级查一级</td>
</tr>
<tr>
<td>增</td>
<td>商品有spu、sku属性，都需要进行相应的添加，做两级添加操作</td>
</tr>
<tr>
<td>改</td>
<td>初步实现对商品的信息进行修改，其次实现对三级分类属性的修改</td>
</tr>
<tr>
<td>删</td>
<td>具体商品信息可以删除，三级分类菜单的次一级菜单为空也可以</td>
</tr>
</tbody></table>
<h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a><strong>技术选型</strong></h3><p>前端：</p>
<p>​    使用Freemarkr，分模块，每个模块add、update、delete、分页都是单独页面。</p>
<p>​    后端：</p>
<p>​        基础框架：SpringBoot、Mybatis 、SpringMVC、Log4j、Lombok、Swagger</p>
<p>​        数据库：MySQL</p>
<p>前后端交互：</p>
<p>​    Json</p>
<img src="http://photo.wushaopei.com/qiniu129.png" width="60%">

<h3 id="实现逻辑："><a href="#实现逻辑：" class="headerlink" title="实现逻辑："></a>实现逻辑：</h3><p>围绕EasyUI的 <strong>控件、属性</strong>以及动态获取数据的<strong>事件、方法</strong>来进行。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>EasyUI笔记（二）--EasyUI下载及引入项目、示例</title>
    <url>/2020/03/14/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89-EasyUI%E4%B8%8B%E8%BD%BD%E5%8F%8A%E5%BC%95%E5%85%A5%E9%A1%B9%E7%9B%AE%E3%80%81%E7%A4%BA%E4%BE%8B/</url>
    <content><![CDATA[<h3 id="EasyUI下载"><a href="#EasyUI下载" class="headerlink" title="EasyUI下载"></a>EasyUI下载</h3><hr>
<p>　EasyUI官方下载地址：<a href="http://www.jeasyui.com/download/index.php，目前最新的版本是：jQuery" target="_blank" rel="noopener">http://www.jeasyui.com/download/index.php，目前最新的版本是：jQuery</a> EasyUI 1.6.1 </p>
<img src="http://photo.wushaopei.com/qiniu125.png" width="60%">

<p>下载完成之后，将压缩包进行解压后，得到一个【jquery-easyui-1.6.1】文件夹，里面有如下图所示的文件： </p>
<img src="http://photo.wushaopei.com/qiniu126.png" width="60%">



<h3 id="EasyUI引入项目及范例："><a href="#EasyUI引入项目及范例：" class="headerlink" title="EasyUI引入项目及范例："></a>EasyUI引入项目及范例：</h3><hr>
<h4 id="引入相关js和css样式文件："><a href="#引入相关js和css样式文件：" class="headerlink" title="引入相关js和css样式文件："></a>引入相关js和css样式文件：</h4><p>要想在页面中使用EasyUI，那么首先要做的就是在页面中引入必要js和css样式文件，以在jsp文件中使用EasyUI为例，文件引入的顺序如下所示 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入JQuery --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/jquery.easyui.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI的中文国际化js，让EasyUI支持中文 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/locale/easyui-lang-zh_CN.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI的样式文件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/themes/default/easyui.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI的图标样式文件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/themes/icon.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>　在jsp文件中引用了这些文件之后，就可以使用EasyUI了。 </p>
<h4 id="EasyUI使用范例"><a href="#EasyUI使用范例" class="headerlink" title="EasyUI使用范例"></a>EasyUI使用范例</h4><p>将jquery-easyui-1.9.1加入到SpringBoot工程中，将jquery-easyui-1.9.1文件夹中一些不必要的文件删掉，只保留必要的就可以了，如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu127.png" width="60%">

<p>　新创建一个01.html页面，在01.jsp页面中使用EasyUI，代码如下： </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"jquery-1.11.3.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入JQuery --&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/easyui/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI --&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/easyui/jquery.easyui.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI的中文国际化js，让EasyUI支持中文 --&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/easyui/locale/easyui-lang-zh_CN.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI的样式文件--&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/easyui/themes/default/easyui.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI的图标样式文件--&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/easyui/themes/icon.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">      $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">//console.info($('#dd2'));</span></span></span><br><span class="line">          /*使用JavaScript动态创建EasyUI的Dialog的步骤：</span><br><span class="line">          1、定义一个div，并给div指定一个id</span><br><span class="line">          2、使用Jquery选择器选中该div，然后调用dialog()方法就可以创建EasyUI的Dialog</span><br><span class="line">          */</span><br><span class="line"><span class="javascript">          $(<span class="string">'#dd2'</span>).dialog();<span class="comment">//使用默认的参数创建EasyUI的Dialog</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">//使用自定义参数创建EasyUI的Dialog</span></span></span><br><span class="line"><span class="javascript">          $(<span class="string">'#dd3'</span>).dialog(&#123;</span></span><br><span class="line"><span class="actionscript">              title: <span class="string">'使用JavaScript创建的Dialog'</span>,</span></span><br><span class="line">              width: 400,</span><br><span class="line">              height: 200,</span><br><span class="line"><span class="actionscript">              closed: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">              cache: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">              modal: <span class="literal">true</span></span></span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"easyui-dialog"</span> <span class="attr">id</span>=<span class="string">"dd1"</span> <span class="attr">title</span>=<span class="string">"EasyUI Dialog"</span> <span class="attr">style</span>=<span class="string">"width: 500px;height: 300px;"</span>&gt;</span></span><br><span class="line">        Hello World!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"dd2"</span>&gt;</span>Dialog Content<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"dd3"</span>&gt;</span>Dialog Content<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>accordion.html 运行结果如下：</p>
<img src="http://photo.wushaopei.com/qiniu129.png" width="60%">

<p>这里的两种EasyUI 的Dialog展现UI正是 <a href="">EasyUI笔记（一）EasyUI入门</a>中提到的声明UI组件的两种方法的实现。</p>
<p>以上便是关于EasyUI的简单入门，接下来将使用EasyUI做一个稍微复杂点的后台管理页面。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（六）实现热部署</title>
    <url>/2020/03/14/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E5%85%AD%EF%BC%89%E5%AE%9E%E7%8E%B0%E7%83%AD%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h3 id="devtools的原理"><a href="#devtools的原理" class="headerlink" title="devtools的原理"></a>devtools的原理</h3><hr>
<p>​     深层原理是使用了两个ClassLoader，一个Classloader加载那些不会改变的类（第三方Jar包），另一个ClassLoader加载会更改的类，称为restart  ClassLoader,这样在有代码更改的时候，原来的restart ClassLoader 被丢弃，重新创建一个restart  ClassLoader，由于需要加载的类相比较少，所以实现了较快的重启时间。</p>
<h4 id="使用需要添加以下的配置："><a href="#使用需要添加以下的配置：" class="headerlink" title="使用需要添加以下的配置："></a>使用需要添加以下的配置：</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> 必须设置以下内容：</p>
<p>​     <strong>eclipse –&gt; Project –&gt; Build Automatically 要选中，不选中的话不起作用。</strong></p>
<p> <strong>说明：</strong></p>
<p>（1） devtools可以实现页面热部署（即页面修改后会立即生效，这个可以直接在application.properties文件中配置spring.thymeleaf.cache=false来实现），<br> 实现类文件热部署（类文件修改后不会立即生效），实现对属性文件的热部署。<br> 即devtools会监听classpath下的文件变动，并且会立即重启应用（发生在保存时机），注意：因为其采用的虚拟机机制，该项重启是很快的<br> （2）配置了后在修改java文件后也就支持了热启动，不过这种方式是属于项目重启（速度比较快的项目重启），会清空session中的值，也就是如果有用户登陆的话，项目重启后需要重新登陆。</p>
<p> 默认情况下，<code>/META-INF/maven，/META-INF/resources，/resources，/static，/templates，</code></p>
<p><code>/public</code>这些文件夹下的文件修改不会使应用重启，但是会重新加载（devtools内嵌了一个LiveReload  server，当资源发生改变时，浏览器刷新）。</p>
<h4 id="devtools的配置"><a href="#devtools的配置" class="headerlink" title="devtools的配置"></a><strong>devtools的配置</strong></h4><p> 在application.properties中配置spring.devtools.restart.enabled=false，此时restart类加载器还会初始化，但不会监视文件更新。<br> 在SprintApplication.run之前调用System.setProperty(“spring.devtools.restart.enabled”, “false”);可以完全关闭重启支持，配置内容：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#热部署生效</span></span><br><span class="line"><span class="meta">spring.devtools.restart.enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="comment">#设置重启的目录</span></span><br><span class="line"><span class="comment">#spring.devtools.restart.additional-paths: src/main/java</span></span><br><span class="line"><span class="comment">#classpath目录下的WEB-INF文件夹内容修改不重启</span></span><br><span class="line"><span class="meta">spring.devtools.restart.exclude</span>: <span class="string">WEB-INF/**</span></span><br></pre></td></tr></table></figure>

<p> 测试</p>
<ul>
<li>修改类–&gt;保存：应用会重启</li>
<li>修改配置文件–&gt;保存：应用会重启</li>
<li>修改页面–&gt;保存：应用不会重启，但会重新加载，页面会刷新（原理是将spring.thymeleaf.cache设为false，参考:Spring Boot配置模板引擎）</li>
</ul>
<p>转载自： <a href="https://blog.csdn.net/liben0429/article/details/79011775" target="_blank" rel="noopener">https://blog.csdn.net/liben0429/article/details/79011775</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>EasyUI笔记（一）EasyUI入门</title>
    <url>/2020/03/14/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89-EasyUI%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h3 id="EasyUI-入门概述"><a href="#EasyUI-入门概述" class="headerlink" title="EasyUI 入门概述"></a>EasyUI 入门概述</h3><p>​    <strong>easyui</strong>为Web开发人员提供了易于使用的组件，它构建在流行的<strong>jquery</strong>核心和<strong>html5</strong>之上。这些使您能够轻松的做出符合<strong>html5</strong>标准的<strong>web</strong>应用程序。</p>
<p>​    </p>
<h3 id="声明UI组件有两种方法："><a href="#声明UI组件有两种方法：" class="headerlink" title="声明UI组件有两种方法："></a>声明UI组件有两种方法：</h3><h4 id="直接在HTML中声明组件"><a href="#直接在HTML中声明组件" class="headerlink" title="直接在HTML中声明组件"></a>直接在HTML中声明组件</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"easyui-dialog"</span> style=<span class="string">"width:400px;height:200px"</span></span><br><span class="line">    data-options=<span class="string">"</span></span><br><span class="line"><span class="string">        title:'My Dialog',</span></span><br><span class="line"><span class="string">        iconCls:'icon-ok',</span></span><br><span class="line"><span class="string">        onOpen:function()&#123;&#125;"</span>&gt;</span><br><span class="line">    dialog content.</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h4 id="编写JavaScript代码来创建组件"><a href="#编写JavaScript代码来创建组件" class="headerlink" title="编写JavaScript代码来创建组件"></a>编写JavaScript代码来创建组件</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;input id=<span class="string">"cc"</span> style=<span class="string">"width:200px"</span> /&gt;</span><br><span class="line"></span><br><span class="line">$(<span class="string">'#cc'</span>).combobox(&#123;</span><br><span class="line">	url: ...,</span><br><span class="line">	required: <span class="keyword">true</span>,</span><br><span class="line">	valueField: <span class="string">'id'</span>,</span><br><span class="line">	textField: <span class="string">'text'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h3><p>遵循： <code>控件 - 属性 - 方法 - 事件</code></p>
<h4 id="控件："><a href="#控件：" class="headerlink" title="控件："></a>控件：</h4><p>​    所有的属性都定义在jQuery.fn.<strong>{plugin}</strong>.defaults里面。例如，对话框属性定义在jQuery.fn.<strong>dialog</strong>.defaults里面。</p>
<h4 id="属性："><a href="#属性：" class="headerlink" title="属性："></a>属性：</h4><p>​    所有的事件（回调函数）也都定义在jQuery.fn.<strong>{plugin}</strong>.defaults里面。</p>
<h4 id="事件："><a href="#事件：" class="headerlink" title="事件："></a>事件：</h4><p>​    所有的事件（回调函数）也都定义在jQuery.fn.<strong>{plugin}</strong>.defaults里面。</p>
<h4 id="方法："><a href="#方法：" class="headerlink" title="方法："></a>方法：</h4><p>​    调用方法的语法：$(‘selector’).plugin(‘method’, parameter); </p>
<p><strong>解释：</strong>  </p>
<ul>
<li>selector 是jQery对象选择器。</li>
<li>plugin 是插件的名称。</li>
<li>method 是相应插件现有的方法。</li>
<li>parameter  是参数对象，可以是一个对象、字符串等。</li>
</ul>
<p>所有方法都定义在jQuery.fn.<strong>{plugin}</strong>.methods。每个方法都有2个参数：jq和param。第一个参数’jq’是必须的，这是指的jQuery对象。第二个参数’param’是指传入方法的实际参数。例如，为dialog组件扩展一个方法名为’mymove’，代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">$.extend($.fn.dialog.methods, &#123;    </span><br><span class="line">    mymove: function(jq, newposition)&#123;    </span><br><span class="line">        return jq.each(function()&#123;    </span><br><span class="line">            $(this).dialog('move', newposition);    </span><br><span class="line">        &#125;);    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>现在你可以调用’mymove’方法将对话框移动到指定位置：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">$('#dd').dialog('mymove', &#123;    </span><br><span class="line">    left: 200,    </span><br><span class="line">    top: 100    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>重写一个对象的时候为什么要同时重写hashcode()和equals（）方法</title>
    <url>/2020/03/13/%E9%87%8D%E5%86%99%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%90%8C%E6%97%B6%E9%87%8D%E5%86%99hashcode-%E5%92%8Cequals%EF%BC%88%EF%BC%89%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>​    在新创建的类不重写<strong>hashCode()</strong>和<strong>equals()</strong> 方法时，默认使用 <strong>java</strong> 提供的 <strong>java.lang.Object</strong> 下的 <strong>hashCode</strong>()和<strong>equals</strong>() 方法。 </p>
<blockquote>
<p>注意：Object 的public boolean equals(Object obj)方法主要是对非空对象的引用地址的判断相同才返回true，而非对象本身的字符串内容或数值是否相同。 </p>
</blockquote>
<p>​    简而言之，当且仅当 值A 和 值B 都是引用自同一个对象时，此方法才会返回true;</p>
<p>​    所以，当我们重写一个对象，重写了equals（）方法后，通常必须重写 hashCode（）方法，以维护 hashCode 方法的常规协定，该协定声明了相等对象必须具有相等的哈希码。</p>
<blockquote>
<p>说白了，就是equals 返回true的两个值，在hashCode（） 中结果也必然是true。 </p>
</blockquote>
<p>例子：**</p>
<p>​    (1)当<strong>obj1.equals(obj2)</strong>为<strong>true</strong>时，<strong>obj1.hashCode() == obj2.hashCode()</strong>必须为<strong>true</strong><br>    (2)当<strong>obj1.hashCode() == obj2.hashCode()</strong>为<strong>false</strong>时，<strong>obj1.equals(obj2)</strong>必须为<strong>false</strong></p>
<p>这里引出一个问题，<strong>为什么要重写equals（）方法</strong>呢？难道原生的不能用吗？</p>
<p>​    答案: 是<strong>必须重写</strong>，从前面的注意事项中可以知道，如果不重写<strong>equals</strong> 方法，那么比较的将是对象的引用是否<strong>指向同一块内存地址</strong>，而我们<strong>重写的目的</strong>是为了能够比较<strong>两个对象的value值</strong>是否相等。</p>
<p>​    在高级类的<strong>八个包装类</strong>与<strong>引用类型的String类型</strong>（该类对euqals和hashcode方法进行了重写）中都 是使用重写后的 <strong>equals</strong> 方法来比较对象的，<strong>默认比较的是值</strong>，在比较其它自定义对象时都是<strong>比较的引用地址。</strong></p>
<p>​    后面会对<strong>equals</strong> 和 <strong>hashcode</strong> 的关系进行关联解释。</p>
<p>​    <strong>hashcode</strong>是用于<strong>散列数据的快速存取</strong>，如利用<code>HashSet/HashMap/Hashtable</code>类来存储数据时，都是根据存储对象的<code>hashcode</code>值来进行判断是否相同的。</p>
<p>​    那么，如果我们值重  写<code>equals</code> ，而不重写 <code>hashcode</code> 会怎么样？</p>
<p>​    如果我们对一个对象重写了   <code>equals</code> 方法，意味着只要对象的成员变量值都相等那么 <code>equals</code> 就返回true ,但在不重写 <code>hashcode</code> 方法的情况下，当我们重新 <strong>new</strong> 了一个新对象。<br>此时，当原对象<strong>.equals</strong>（新对象）等于<strong>true</strong>时，两者的 <strong>hashcode</strong> 却是不一样的，由此会产生了理解的不一致，也违反了<strong>equals</strong> 与 <strong>hashcode</strong>的约定规则。</p>
<p><strong>不重写导致的结果案例：</strong></p>
<p>​    在不重写<strong>hashcode</strong>的情况下，如果 <code>hashset</code>存储两个引用不同但值相同的对象，此时hashcode返回false，认为后者与前者不重复，则会重新 newNode() 创建一个新节点将重复的值添加到集合中，意味着不可重复的单列集合中出现了两个值一样的对象，导致混淆。（假设没有重写）</p>
<p>所以，需要重写 hashcode()方法。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JavaSE</category>
      </categories>
  </entry>
  <entry>
    <title>集合扩容机制(二)Collection-Map</title>
    <url>/2020/03/13/%E9%9B%86%E5%90%88%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6(%E4%BA%8C)Collection-Map/</url>
    <content><![CDATA[<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><hr>
<p>获取Map集合容量大小的方法： </p>
<p><strong>思路</strong>：利用反射获取<strong>hashmap</strong>里的<strong>threshold</strong>（扩容上限）除以 负载因子 就得到容器大小了。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getHashMapCapacity</span><span class="params">(HashMap&lt;?,?&gt; hashMap)</span> </span>&#123;</span><br><span class="line">		Class&lt;HashMap&gt; hashMapClass = HashMap<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// threshold是hashmap对象里的一个私有变量，若hashmap的size超过该数值，则扩容。这是通过反射获取该值</span></span><br><span class="line">			Field field = hashMapClass.getDeclaredField(<span class="string">"threshold"</span>);</span><br><span class="line">			<span class="comment">//setAccessible设置为true可以开启对似有变量的访问</span></span><br><span class="line">			field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">int</span> threshold = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> ((<span class="keyword">int</span>) field.get(hashMap) != threshold) &#123;</span><br><span class="line">				threshold = (<span class="keyword">int</span>) field.get(hashMap);</span><br><span class="line">				<span class="comment">// 默认的负载因子是0.75,也就是说实际容量是/0.75</span></span><br><span class="line">				<span class="keyword">double</span> v = (<span class="keyword">int</span>) field.get(hashMap) / <span class="number">0.75</span>;</span><br><span class="line"><span class="comment">//				System.out.println((int) field.get(hashMap) / 0.75);</span></span><br><span class="line">				System.out.println(<span class="string">"扩张容量： "</span> + threshold + <span class="string">" 实际容量： "</span>+ (<span class="keyword">int</span>)v);</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">return</span> threshold;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HashMap-的扩容机制："><a href="#HashMap-的扩容机制：" class="headerlink" title="HashMap 的扩容机制："></a><strong>HashMap 的扩容机制：</strong></h3><hr>
<p><strong>在HashMap 中，与容量有关的构造器有三个：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<h4 id="这里先对-public-HashMap-）做单元测试，并进行分析"><a href="#这里先对-public-HashMap-）做单元测试，并进行分析" class="headerlink" title="这里先对  public HashMap( ）做单元测试，并进行分析"></a><strong>这里先对  public HashMap( ）做单元测试，并进行分析</strong></h4><hr>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mapCapacity</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里添加是个元素</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">		map.put(String.valueOf(i),i);</span><br><span class="line">	&#125;</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line">	<span class="comment">// 这里添加2个元素</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">11</span>; i &lt; <span class="number">13</span>; i++)&#123;</span><br><span class="line">		map.put(String.valueOf(i),i);</span><br><span class="line">	&#125;</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里添加30个元素</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">31</span>; i &lt; <span class="number">60</span>; i++)&#123;</span><br><span class="line">		map.put(String.valueOf(i),i);</span><br><span class="line">	&#125;</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>单元测试结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DemoApplicationTests      : Started DemoApplicationTests in <span class="number">3.717</span> seconds (JVM running <span class="keyword">for</span> <span class="number">4.477</span>)</span><br><span class="line">   已占用容量<span class="number">0</span></span><br><span class="line">扩张容量： <span class="number">12</span> 实际容量： <span class="number">16</span>    已占用容量<span class="number">11</span></span><br><span class="line">扩张容量： <span class="number">24</span> 实际容量： <span class="number">32</span>    已占用容量<span class="number">13</span></span><br><span class="line">扩张容量： <span class="number">48</span> 实际容量： <span class="number">64</span>    已占用容量<span class="number">42</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">29</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">05.433</span>  INFO <span class="number">29660</span> --- [       Thread-<span class="number">2</span>] o.s.w.c.s.GenericWebApplicationContext   : Closing org.springframework.web.context.support.GenericWebApplicationContext<span class="meta">@ffaa</span>6af: startup date [Wed Jan <span class="number">29</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">02</span> CST <span class="number">2020</span>]; root of context hierarchy</span><br></pre></td></tr></table></figure>

<p>​    在这里先对单元测试结果进行<strong>分析</strong>：</p>
<p>​    首先我们先看一下，单元测试中，创建了一个默认无参的HashMap，此时第一次打印 集合实例的 容量值，得到的结果是 “已占用容量 0”，这里对代码进行分析：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">            <span class="keyword">if</span> ((<span class="keyword">int</span>) field.get(hashMap) != threshold) &#123;</span><br><span class="line">				threshold = (<span class="keyword">int</span>) field.get(hashMap);</span><br><span class="line">				<span class="comment">// 默认的负载因子是0.75,也就是说实际容量是/0.75</span></span><br><span class="line">				<span class="keyword">double</span> v = (<span class="keyword">int</span>) field.get(hashMap) / <span class="number">0.75</span>;</span><br><span class="line"><span class="comment">//				System.out.println((int) field.get(hashMap) / 0.75);</span></span><br><span class="line">				System.out.println(<span class="string">"扩张容量： "</span> + threshold + <span class="string">" 实际容量： "</span>+ (<span class="keyword">int</span>)v);</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>

<p>​    这里是通过反射获取 <strong>HashMap</strong> 字节码对象从而得到运行时的构造器或方法实例及相应的属性的值， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Field field = hashMapClass.getDeclaredField(<span class="string">"threshold"</span>);</span><br></pre></td></tr></table></figure>

<p>​    以上的一条代码便是获取 <strong>“threshold ”</strong> 私有属性的方法，这里看一看该变量在 <strong>HashMap</strong>   中的含义： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The next size value at which to resize (capacity * load factor).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">   */</span> </span><br><span class="line">  <span class="comment">// (The javadoc description is true upon serialization.   (序列化时，javadoc描述为真。</span></span><br><span class="line">  <span class="comment">// Additionally, if the table array has not been allocated, this  此外，如果还没有分配表数组，则执行此操作</span></span><br><span class="line">  <span class="comment">// field holds the initial array capacity, or zero signifying  字段持有初始数组容量，或表示为零</span></span><br><span class="line">  <span class="comment">// DEFAULT_INITIAL_CAPACITY.)  DEFAULT_INITIAL_CAPACITY)。</span></span><br><span class="line">  <span class="keyword">int</span> threshold;</span><br></pre></td></tr></table></figure>

<p>​    由注释我们可以知道，当前字段在 HashMap 用于存储 <strong>key</strong> 字段元素的长度，当初始化一个无参构造时，在没有对其进行分配元素的情况下，该字段是不会被分配值的，默认值表示值为 <strong>0</strong> 或 为<strong>初始化</strong>长度   <strong>DEFAULT_INITIAL_CAPACITY 。</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The default initial capacity - MUST be a power of two.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br></pre></td></tr></table></figure>

<p>以上是HashMap中的源码部分对 默认初始容量的定义： 默认长度为 16 。</p>
<p>以上是为了说明一个问题，在默认定义HashMap 集合容量且没有添加元素到容器中的情况下， 其容量值 可能是0 ，也可能是初始容量16.</p>
<p><strong>第一条打印结果分析完毕。</strong></p>
<p><strong>以下对HashMap 的 扩容机制进行一番分析，这里会基于单元测试后面的三条打印结果进行分析：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">扩张容量： 12 实际容量： 16    已占用容量11</span><br><span class="line">扩张容量： 24 实际容量： 32    已占用容量13</span><br><span class="line">扩张容量： 48 实际容量： 64    已占用容量42</span><br></pre></td></tr></table></figure>

<p>从打印的结果，我们可以看到，第一次打印结果中，集合的实际容量为  <strong>16</strong> ，而根据 <strong>HashMap</strong> 的加载因子来计算，当添加的元素达到长度 <strong>0.75</strong> 时会进行一次扩容。这里从<strong>源码方面</strong>进行分析： </p>
<h4 id="此处要搞清楚为什么加载因子是0-75？"><a href="#此处要搞清楚为什么加载因子是0-75？" class="headerlink" title="此处要搞清楚为什么加载因子是0.75？"></a><strong>此处要搞清楚为什么加载因子是0.75？</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Constructs an empty &lt;tt&gt;HashMap&lt;/tt&gt; with the default initial capacity</span></span><br><span class="line"><span class="comment">    * (16) and the default load factor (0.75).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在以上源码中，空参构造中，不会对容量大小进行自定义声明，而是使用默认值 <strong>16</strong> ，方法中的成员变量 <strong>this.loadFactor</strong> 代表当前集合的加载因子，即满足一定条件进行容量扩张。其中的 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DEFAULT_LOAD_FACTOR 在源码中的位置：</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The load factor used when none specified in constructor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure>

<p>这里解决了<strong>加载因子为什么是 0.75</strong> 的问题，不过，在<strong>HashMap</strong>提供的构造器中，<strong>加载因子也是可以自定义</strong>的，就在这里给分析一下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs an empty &lt;tt&gt;HashMap&lt;/tt&gt; with the specified initial</span></span><br><span class="line"><span class="comment">     * capacity and load factor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  initialCapacity the initial capacity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  loadFactor      the load factor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity is negative</span></span><br><span class="line"><span class="comment">     *         or the load factor is nonpositive</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                               initialCapacity);</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">            initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                               loadFactor);</span><br><span class="line">        <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">        <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>有上述源码可以知道， map的容量与加载因子可以同时被自定义声明，在<strong>构造函数</strong>中会对<strong>容量</strong>的<strong>合法性</strong>进行校验.</p>
<h4 id="在这里我们提出一个问题：HashMap中容量的最大值是什么？"><a href="#在这里我们提出一个问题：HashMap中容量的最大值是什么？" class="headerlink" title="在这里我们提出一个问题：HashMap中容量的最大值是什么？"></a><strong>在这里我们提出一个问题：HashMap中容量的最大值是什么？</strong></h4><p>我们看看源码中的这一句， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">initialCapacity = MAXIMUM_CAPACITY;</span><br></pre></td></tr></table></figure>

<p>当容量大于<strong>HashMap</strong> 定义的私有变量 <strong>MAXIMUM_CAPACITY</strong> 时， </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">将  MAXIMUM_CAPACITY  赋值给  initialCapacity</span><br></pre></td></tr></table></figure>

<p>在HashMap 中对 <strong>MAXIMUM_CAPACITY</strong> 的值定义的大小是： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The maximum capacity, used if a higher value is implicitly specified</span></span><br><span class="line"><span class="comment"> * by either of the constructors with arguments.</span></span><br><span class="line"><span class="comment"> * MUST be a power of two &lt;= 1&lt;&lt;30.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br></pre></td></tr></table></figure>

<p>从这里可以知道，<strong>hashmap</strong>的最大容量是 <strong>2的30次方。</strong> </p>
<h4 id="Hashmap-的-扩容机制"><a href="#Hashmap-的-扩容机制" class="headerlink" title="Hashmap 的 扩容机制"></a><strong>Hashmap 的 扩容机制</strong></h4><p>在 HashMap 在扩容的过程中有几个问题要注意：</p>
<ol>
<li><strong>key 值不可重复与 value 值不可重复的问题？</strong></li>
<li><strong>容量长度的扩容机制？</strong></li>
</ol>
<p>在这里就不对第一个问题进行过多赘述，可以参考 笔者的另一篇博文，</p>
<p><strong>从源码看： hashset如何保证值不会被重复的</strong>  在该博文中对key值和value值不可重复做了详尽的分析。</p>
<p>添加元素到HashMap 集合中，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">      <span class="comment">// 这里添加是个元素</span></span><br><span class="line">  	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">	map.put(String.valueOf(i),i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入 <strong>put ()</strong>方法中，进行新元素的添加： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Associates the specified value with the specified key in this map.</span></span><br><span class="line"><span class="comment"> * If the map previously contained a mapping for the key, the old</span></span><br><span class="line"><span class="comment"> * value is replaced.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value value to be associated with the specified key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span></span><br><span class="line"><span class="comment"> *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment"> *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span></span><br><span class="line"><span class="comment"> *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述源码中，会对传入的<strong>key</strong> 进行值重复的校验，具体使用 <strong>key</strong> 进行<strong>hash</strong>运算获取在 当前 集合中的 <strong>hash</strong> 值，如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>put</strong>  方法中，对元素 <code>key-value</code> 添加到集合容器的操作是在 <code>putVal（）</code> 方法中实现的，并且在该方法中调用 <code>resize</code> () 方法对集合容量长度进行扩容。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implements Map.put and related methods</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hash hash for key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value the value to put</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> onlyIfAbsent if true, don't change existing value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> evict if false, the table is in creation mode.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> previous value, or null if none</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<strong>DEBUG分析</strong>查看 putVal方法中的 参数，当前 map 集合的长度为 8 ，有八个key ，每个 key 对应一个value </p>
<img src="http://photo.wushaopei.com/qiniu122.png" width="60%">

<p>根据源码我们可以知道，hashmap的底层是由数组和链表构成的，如上图中，<code>Node&lt;K，V&gt;[] ta</code> 代表当前map集合的底层结构，该结构由一个<code>Node</code> （链表）类型的数组构成。每个新添加的 <code>key-value</code> 会以一个  <code>Node&lt;K，V&gt;</code> 的链表节点的形式被添加到 集合 tab 中 。</p>
<p>在添加元素的时候会调用 <code>resize（）</code>方法，并在<code>resize（）</code> 方法中将新的集合数据存储到 <code>table</code> 私有变量中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The table, initialized on first use, and resized as</span></span><br><span class="line"><span class="comment"> * necessary. When allocated, length is always a power of two.</span></span><br><span class="line"><span class="comment"> * (We also tolerate length zero in some operations to allow</span></span><br><span class="line"><span class="comment"> * bootstrapping mechanics that are currently not needed.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br></pre></td></tr></table></figure>

<p>以下是<strong>resize（）</strong> 的代码： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes or doubles table size.  If null, allocates in</span></span><br><span class="line"><span class="comment">     * accord with initial capacity target held in field threshold.</span></span><br><span class="line"><span class="comment">     * Otherwise, because we are using power-of-two expansion, the</span></span><br><span class="line"><span class="comment">     * elements from each bin must either stay at same index, or move</span></span><br><span class="line"><span class="comment">     * with a power of two offset in the new table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the table</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">        <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">        <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">        <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                threshold = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span> oldTab;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                     oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">                newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">            newCap = oldThr;</span><br><span class="line">        <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">            newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">            newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">            newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                      (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">        &#125;</span><br><span class="line">        threshold = newThr;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">            Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">        table = newTab;</span><br><span class="line">        <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e;</span><br><span class="line">                <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                        newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                        ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                    <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                        Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                        Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                        Node&lt;K,V&gt; next;</span><br><span class="line">                        <span class="keyword">do</span> &#123;</span><br><span class="line">                            next = e.next;</span><br><span class="line">                            <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                    loHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = e;</span><br><span class="line">                                loTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                    hiHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = e;</span><br><span class="line">                                hiTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                            newTab[j] = loHead;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                            newTab[j + oldCap] = hiHead;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newTab;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在以上源码中，关于扩容部分的代码是： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">               oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">          newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br></pre></td></tr></table></figure>

<p><strong>HashMap</strong> 中对当前的容量值使用左位移的方式， <strong>oldCap &lt;&lt; 1</strong> ，将<strong>集合容量扩张</strong>为当前的<strong>2</strong> 的<strong>N次幂。此时，我们可以知道HashMap</strong> 的扩容是新容量为当前的  2的N次方.</p>
<h4 id="HashMap-集合进行扩容的时机是？"><a href="#HashMap-集合进行扩容的时机是？" class="headerlink" title="HashMap 集合进行扩容的时机是？"></a><strong>HashMap 集合进行扩容的时机是？</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">    newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">              (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>前提：</strong> 当前集合集合的链表数组中必须有值的情况下，才会触发扩容机制。</p>
<p>当前的集合元素长度达到了 当前给定集合的容量的<code>0.75</code>倍时，该链表数组进行自增左位移，默认为<code>2的N次幂</code>。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>容器-集合</category>
      </categories>
  </entry>
  <entry>
    <title>集合扩容机制(一)Collection-List</title>
    <url>/2020/03/13/%E9%9B%86%E5%90%88%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6(%E4%B8%80)Collection-List/</url>
    <content><![CDATA[<p>​    Java 中提供了很多的集合类，包括，collection的子接口list、set，以及map等。由于它们的底层构成不同，以及数据的构造为单列、多列、可重复、不可重复，导致其扩容机制也不尽相同。 </p>
<h1 id="List"><a href="#List" class="headerlink" title="List"></a>List</h1><h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a><strong>ArrayList</strong></h2><p>案例： 获取ArrayList 容量大小的方法： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getArrayListCapacity</span><span class="params">(ArrayList&lt;?&gt; arrayList)</span> </span>&#123;</span><br><span class="line">	Class&lt;ArrayList&gt; arrayListClass = ArrayList<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Field field = arrayListClass.getDeclaredField(<span class="string">"elementData"</span>);</span><br><span class="line">		field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">		Object[] objects = (Object[])field.get(arrayList);</span><br><span class="line">		<span class="keyword">return</span> objects.length;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ArrayList以数组的形式存储。ArrayList中与容量有关的构造器有两个，<strong>代码如下：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs an empty list with an initial capacity of ten.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由以上代码可知，ArrayList 的容量扩容包含有 ArrayList(int initialCapacity) ，另一个则是 ArrayList() ；</p>
<p>第一个构造器在初始创建时以形参将容量大小进行定义，由外部自定义；第二个构造器没有传入参数，使用默认初始化的容量大小；<strong>详细解析如下：</strong></p>
<p><strong>第一个有参构造器：自定长度在后面，这里先看无参有默认容量长度的构造器怎么实现的扩容？</strong></p>
<p><strong>第二个无参构造器：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs an empty list with an initial capacity of ten.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代码测试：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">catapicity</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	objects.add(<span class="string">"a"</span>);</span><br><span class="line">	objects.add(<span class="string">"b"</span>);</span><br><span class="line">	objects.add(<span class="string">"c"</span>);</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 增加一个值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">9</span> ; i ++ )&#123;</span><br><span class="line">		objects.add(i);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line">	<span class="comment">// 增加一个值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10</span> ; i &lt;<span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">		objects.add(i);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line">	<span class="comment">// 增加一个值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">15</span> ; i &lt; <span class="number">20</span> ; i ++ )&#123;</span><br><span class="line">		objects.add(i);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line"></span><br><span class="line">	objects.add(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在上述单元测试中，创建了一个无参构造的ArrayList 集合，并对其进行元素的添加，以满足对元素添加过程中容量大小的扩张规则。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">长度:  <span class="number">3</span> 容量： <span class="number">10</span></span><br><span class="line">长度:  <span class="number">12</span> 容量： <span class="number">15</span></span><br><span class="line">长度:  <span class="number">17</span> 容量： <span class="number">22</span></span><br><span class="line">长度:  <span class="number">22</span> 容量： <span class="number">22</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">29</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">35.260</span>  INFO <span class="number">28488</span> --- [       Thread-<span class="number">2</span>] o.s.w.c.s</span><br></pre></td></tr></table></figure>

<p><strong>上述是单元测试结果，在这里做一番分析：</strong></p>
<p>在以上的代码中，默认使用ArrayList的初始化容量长度，在ArrayList中，默认初始化容量是 10 ,</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Default initial capacity.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>从测试结果可以看到，当元素的长度为3时，其容量为默认的值 10 ； 当添加的元素超过初始容量后，即 12 &gt; 10  时，集合进行了自动扩容，添加每一个元素都会调用  ensureCapacityInternal(int minCapacity)  方法，在该方法中比较长度是否达到当前容量的边缘，将比较的结果 覆盖原来的 minCapacity 参数，该值用于保存当前的容器元素长度；如单元测试中，当元素个数超过默认的 值 10 时，会调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);</span><br></pre></td></tr></table></figure>

<p>方法，并接着调用  <code>ensureExplicitCapacity(minCapacity);</code>方法，该方法会对当前集合长度与最大容量值进行比较，并调用 <code>grow(minCapacity)</code> 方法进行位移扩容： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现ArrayList 集合扩容的代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Increases the capacity to ensure that it can hold at least the</span></span><br><span class="line"><span class="comment">  * number of elements specified by the minimum capacity argument.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> minCapacity the desired minimum capacity</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// overflow-conscious code</span></span><br><span class="line">     <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">     <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">     <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">         newCapacity = minCapacity;</span><br><span class="line">     <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">         newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">     <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">     elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在集合长度超过初始值或当前最大值时，在   <strong>grow(int minCapacity)</strong> 方法中，进行了扩容，该扩容如代码所示， 声明当前集合的最大容量为 <strong>oldCapacity</strong> ， 新增的长度为 <strong>oldCapacity</strong> 右位移一位数，当容量为 10 时，二进制为  “<strong>8020</strong>” &gt;&gt; 1 右移后为 “<strong>0401</strong>” ，十进制值为 <strong>5</strong> ，此时将 <strong>oldCapacity</strong> + 位移后的值 即   <strong>10 + 5 = 15</strong> 。 </p>
<p>此时完成扩容，<strong>newCapacity  = 15</strong> 就是 ArrayList 扩容后的最新容量大小。</p>
<p>根据扩容规则可知，容量的递增可预计为  <strong>0 、10、15、22、33、49</strong>，以此类推。</p>
<p>注意： <strong>这里对新的容量 newCapacity 和 当前元素长度进行比较，如果元素添加的比较多，超过当次位移扩容的容量大小，则会 直接使用  hugeCapacity 方法进行扩容，</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">      <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">          Integer.MAX_VALUE :</span><br><span class="line">          MAX_ARRAY_SIZE;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>第一个有参构造器：</strong> </p>
<p><strong>单元测试：</strong></p>
<p><strong>① 当声明的容量小于默认初始值10 时，会在超过初始容量10 后进行扩容，</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">catapicity</span><span class="params">()</span></span>&#123;</span><br><span class="line">		ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">		objects.add(<span class="string">"a"</span>);</span><br><span class="line">		objects.add(<span class="string">"b"</span>);</span><br><span class="line">		objects.add(<span class="string">"c"</span>);</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">2</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">3</span>; i &lt;<span class="number">5</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">6</span> ; i &lt; <span class="number">10</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">长度:  <span class="number">3</span> 容量： <span class="number">5</span></span><br><span class="line">长度:  <span class="number">5</span> 容量： <span class="number">5</span></span><br><span class="line">长度:  <span class="number">7</span> 容量： <span class="number">7</span></span><br><span class="line">长度:  <span class="number">11</span> 容量： <span class="number">15</span></span><br><span class="line">长度:  <span class="number">15</span> 容量： <span class="number">15</span></span><br><span class="line">长度:  <span class="number">19</span> 容量： <span class="number">22</span></span><br></pre></td></tr></table></figure>

<p><strong>②超过初始化容量的元素增加：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">catapicity</span><span class="params">()</span></span>&#123;</span><br><span class="line">		ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">13</span>);</span><br><span class="line"><span class="comment">//		objects.add("a");</span></span><br><span class="line"><span class="comment">//		objects.add("b");</span></span><br><span class="line"><span class="comment">//		objects.add("c");</span></span><br><span class="line"><span class="comment">//		System.out.println("长度:  "+objects.size() + " 容量： " + getArrayListCapacity(objects));</span></span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">3</span>; i &lt;<span class="number">5</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">6</span> ; i &lt; <span class="number">10</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">长度:  15 容量： 19</span><br><span class="line">长度:  17 容量： 19</span><br><span class="line">长度:  21 容量： 28</span><br><span class="line">长度:  25 容量： 28</span><br><span class="line">长度:  29 容量： 42</span><br></pre></td></tr></table></figure>

<p>超过初试容量后，<strong>第一次扩容</strong>会直接使用当前集合长度作为 <strong>oldCapacity</strong> 进行扩容</p>
<h2 id="2、LinkedList"><a href="#2、LinkedList" class="headerlink" title="2、LinkedList"></a><strong>2、LinkedList</strong></h2><p>链表结构，且是是双向链表， 不涉及扩容的问题。</p>
<h2 id="3、Vector"><a href="#3、Vector" class="headerlink" title="3、Vector"></a><strong>3、Vector</strong></h2><p>Vector与ArrayList一样，是存储在数组结构中。  与扩容机制相关的构造器有三个,分别是</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Vector(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> capacityIncrement)，</span><br><span class="line">Vector(<span class="keyword">int</span> initialCapacity)</span><br><span class="line">Vector()</span><br></pre></td></tr></table></figure>

<p>  其实这后两个最终都是调用了第一个构造器，不过是使用了不同的默认参数，initialCapacity是初始容量，默认是10，capacityIncrement 是每次扩容时候的递增数量，如果该数值不等于0则每次扩容的时候是原来的二倍，如果该数值大于0，则每次增长的数量等于该数值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> newCapacity = oldCapacity + ((capacityIncrement &gt; <span class="number">0</span>) ?</span><br><span class="line">                                 capacityIncrement : oldCapacity);</span><br><span class="line">）。</span><br></pre></td></tr></table></figure>

<p><strong>比如：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Vector&lt;String&gt; v = <span class="keyword">new</span> Vector&lt;String&gt;(); <span class="comment">// 10 20 ,40 80 ，160，320 的速度递增</span></span><br><span class="line"></span><br><span class="line">Vector&lt;String&gt; v2 = <span class="keyword">new</span> Vector&lt;&gt;(<span class="number">5</span>,<span class="number">3</span>);<span class="comment">// 5 8 11 14 17 ，20，23 的速度递增。</span></span><br></pre></td></tr></table></figure>

<p>他的加载因子也是10</p>
<h2 id="4、Stack"><a href="#4、Stack" class="headerlink" title="4、Stack"></a><strong>4、Stack</strong></h2><p>  继承于Vector，所以他的扩容机制等同于Vector的默认情况，也就是2倍速度扩容，加载因子为1</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>容器-集合</category>
      </categories>
      <tags>
        <tag>集合 扩容机制 List</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot原理（二）自动配置原理</title>
    <url>/2020/03/13/SpringBoot%E5%8E%9F%E7%90%86%EF%BC%88%E4%BA%8C%EF%BC%89%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="Spring-Boot-的自动配置原理"><a href="#Spring-Boot-的自动配置原理" class="headerlink" title="Spring Boot 的自动配置原理"></a><strong>Spring Boot</strong> 的自动配置原理</h2><p>本节主要分析Spring Boot 的自动配置原理，主要通过源码进行分析。首先引入一段代码，来开始我们的<strong>原理解析步骤：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述是主启动类的代码，我们从中可以看到在类名前面添加了一个注解<strong>@SpringBootApplication</strong>；在前面的<strong>SpringBoot</strong> 的自启动配置一文中，我们可以得知，在主启动类中，<strong>main</strong>方法中的 <strong>SpringApplication.run(DemoApplication.class,args)；</strong>是对主启动类进行初始化并启动<strong>IOC</strong>容器进行配置bean的管理。</p>
<p>在这里，我们可以发现，<strong>SpringBoot</strong> 中比 <strong>Spring</strong> 要优秀的一点 <strong>自动配置</strong> 的特性并没有表现在main方法中，从代码中，我们可以看出，也许 <strong>@SpringBootApplication</strong> 这一个注解会与<strong>SpringBoot</strong> 的自动配置有关，本文将从这方面下手，根据源码进行分析。</p>
<p>使用过<strong>Spring Boot</strong> 的我们都知道，<strong>SpringBoot</strong> 中有一个全局配置文件： application.properties 或 <strong>application.yml</strong>。</p>
<p>我们在项目开发过程中对程序配置的 端口、数据库等属性都可以在这个文件中进行配置，最常见的配置有： server.port 、logging.level.* 等等，然而我们实际用到的往往只是很少的一部分，那么这些属性是否有据可依呢？答案是肯定的，这些属性都可以在官方文档中查找到：</p>
<p><a href="https://docs.spring.io/spring-boot/docs/2.1.0.RELEASE/reference/htmlsingle/#common-application-properties" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/2.1.0.RELEASE/reference/htmlsingle/#common-application-properties</a></p>
<p>在<strong>Appendix A. Common application properties</strong>小节下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># ===================================================================</span><br><span class="line"># COMMON SPRING BOOT PROPERTIES</span><br><span class="line">#</span><br><span class="line"># This sample file is provided as a guideline. Do NOT copy it in its</span><br><span class="line"># entirety to your own application.               ^^^</span><br><span class="line"># ===================================================================</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"># ----------------------------------------</span><br><span class="line"># CORE PROPERTIES</span><br><span class="line"># ----------------------------------------</span><br><span class="line">debug=false # Enable debug logs.</span><br><span class="line">trace=false # Enable trace logs.</span><br><span class="line"> </span><br><span class="line"># LOGGING</span><br><span class="line">logging.config= # Location of the logging configuration file. For instance, `classpath:logback.xml` for Logback.</span><br><span class="line">logging.exception-conversion-word=%wEx # Conversion word used when logging exceptions.</span><br><span class="line">logging.file= # Log file name (for instance, `myapp.log`). Names can be an exact location or relative to the current directory.</span><br><span class="line">logging.file.max-history=0 # Maximum of archive log files to keep. Only supported with the default logback setup.</span><br><span class="line">logging.file.max-size=10MB # Maximum log file size. Only supported with the default logback setup.</span><br><span class="line">logging.group.*= # Log groups to quickly change multiple loggers at the same time. For instance, `logging.level.db=org.hibernate,org.springframework.jdbc`.</span><br><span class="line">logging.level.*= # Log levels severity mapping. For instance, `logging.level.org.springframework=DEBUG`.</span><br><span class="line">logging.path= # Location of the log file. For instance, `/var/log`.</span><br><span class="line">logging.pattern.console= # Appender pattern for output to the console. Supported only with the default Logback setup.</span><br><span class="line">logging.pattern.dateformat=yyyy-MM-dd HH:mm:ss.SSS # Appender pattern for log date format. Supported only with the default Logback setup.</span><br><span class="line">logging.pattern.file= # Appender pattern for output to a file. Supported only with the default Logback setup.</span><br><span class="line">logging.pattern.level=%5p # Appender pattern for log level. Supported only with the default Logback setup.</span><br><span class="line">logging.register-shutdown-hook=false # Register a shutdown hook for the logging system when it is initialized.</span><br><span class="line"> </span><br><span class="line"># AOP</span><br><span class="line">spring.aop.auto=true # Add @EnableAspectJAutoProxy.</span><br><span class="line">spring.aop.proxy-target-class=true # Whether subclass-based (CGLIB) proxies are to be created (true), as opposed to standard Java interface-based proxies (false).</span><br></pre></td></tr></table></figure>

<p>我们对自动配置大胆做个猜测，在<strong>Spring Boot</strong> 中有个机制，它将通过<strong>pom</strong>.<strong>xml</strong> 依赖加载到的诸如 <strong>mybatis</strong>、<strong>mysql</strong>、<strong>activemq</strong>等的jar 包创建对应的 <strong>bean</strong>，然后将bean放到容器中，并通过在 <strong>application.properties</strong> 或 <strong>application.yml</strong> 文件中进行配置属性参数映射到对应的 <strong>bean</strong> 中的属性上，从而实现如mysql 的<font color=red>数据库链接地址、密码、用户名</font>的配置等操作。</p>
<p>那么，在这里我们针对猜测的自动配置过程提出三个关键性问题，分别是：</p>
<ol>
<li>SpringBoot 中怎么将引入的依赖包的类<font color=red>创建bean</bean>并加入到容器中的？</li>
<li>springboot 中怎么获取到配置文件 application.properties 或application.yml 中的属性参数？</li>
<li>springboot 怎么将获取到的配置文件参数映射到bean中的属性上？</li>
</ol>
<h3 id="配置加载依赖并创建bean加入到容器中："><a href="#配置加载依赖并创建bean加入到容器中：" class="headerlink" title="配置加载依赖并创建bean加入到容器中："></a><strong>配置加载依赖并创建bean加入到容器中：</strong></h3><h4 id="引入-jar"><a href="#引入-jar" class="headerlink" title="引入 jar"></a>引入 jar</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">    <span class="comment">&lt;!--mybatis 开发包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--springboot web模块支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--druid 的数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th align="right"><strong>spring-boot-starter-web</strong></th>
<th align="left">包自动帮我们引入了web模块开发需要的相关jar包，</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>mybatis-spring-boot-starter</strong></td>
<td align="left">帮我们引入了dao开发相关的jar包。</td>
</tr>
<tr>
<td align="right"><strong>spring-boot-starter-xxx</strong></td>
<td align="left">是官方提供的starter，xxx-spring-boot-starter是第三方提供的starter。</td>
</tr>
</tbody></table>
<p><strong>如下图中：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu113.png" width="60%">

<p>从以下的截图可以看出在这个mybatis-spring-boot-starter 中，并没有任何源码，只有一个pom文件，它的作用就是帮我们引入了相关jar包。 </p>
<img src="http://photo.wushaopei.com/qiniu114.png" width="60%">

<p>在这里我们看一下SpringBoot 中数据源的配置方案： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">     driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">     url: jdbc:mysql:<span class="comment">//localhost:3333/aiicp-gxzx?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;autoReconnect=true&amp;serverTimezone=UTC</span></span><br><span class="line">     username: root</span><br><span class="line">     password: root</span><br><span class="line">     type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">     dbcp2:</span><br><span class="line">       min-idle: <span class="number">5</span></span><br><span class="line">       initial-size: <span class="number">5</span></span><br><span class="line">       max-total: <span class="number">5</span></span><br><span class="line">       max-wait-millis: <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p>在这里，<strong>starter</strong>机制帮我们完成了项目起步所需要的相关jar包。我们知道，传统的<strong>spring</strong>应用中需要在 <strong>application.xml</strong> 中配置很多<strong>bean</strong>的，比如 <strong>dataSource</strong> 的配置，<strong>transactionManager</strong>的配置…… <strong>springboot</strong>是如何帮我们完成这些<strong>bean</strong>的配置的呢？</p>
<blockquote>
<p> —— 自动配置</p>
</blockquote>
<h4 id="基于java代码的bean的配置"><a href="#基于java代码的bean的配置" class="headerlink" title="基于java代码的bean的配置"></a>基于java代码的bean的配置</h4><p>​    以mybatis为例，引入的mybatis 包不只有一个pom.xml文件， 还有一个关键性的包：mybatis-spring-boot-autoconfigure这个包 </p>
<img src="http://photo.wushaopei.com/qiniu115.png" width="60%">

<p>从mybatis-spring-boot-autoconfigure包下的文件名我们可以知道<strong>MybatisAutoConfiguration</strong>类是<strong>自动配置</strong>的核心文件;我们进入该文件看看， </p>
<img src="http://photo.wushaopei.com/qiniu116.png" width="60%">

<p>从截图中我们可以看到，类名和方法名前分别添加了<strong>@Configuration 、@Bean两个注解，了解Spring的都知道，这两个注解一起使用就可以创建一个基于java代码的配置类，可以用来替代相应的xml配置文件。</strong></p>
<p><strong>@Configuration注解的类可以看作是能生产让Spring IoC容器管理的Bean实例的工厂。</strong></p>
<p><strong>@Bean注解告诉Spring，一个带有@Bean的注解方法将返回一个对象，该对象应该被注册到spring容器中。</strong></p>
<h5 id="传统的基于xml的bean配置方法如下："><a href="#传统的基于xml的bean配置方法如下：" class="headerlink" title="传统的基于xml的bean配置方法如下："></a>传统的基于xml的bean配置方法如下：</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"car"</span> <span class="attr">class</span>=<span class="string">"com.mmall.Car"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"wheel"</span> <span class="attr">ref</span> = <span class="string">"wheel"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"wheel"</span> <span class="attr">class</span>=<span class="string">"com.mmall.Wheel"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="相当于用基于java代码的配置方式："><a href="#相当于用基于java代码的配置方式：" class="headerlink" title="相当于用基于java代码的配置方式："></a>相当于用基于java代码的配置方式：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Conf</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">car</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        Car car = <span class="keyword">new</span> Car();  </span><br><span class="line">        car.setWheel(wheel());  </span><br><span class="line">        <span class="keyword">return</span> car;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="meta">@Bean</span>   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Wheel <span class="title">wheel</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Wheel();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此，我们可以知道，上面的 <strong>MybatisAutoConfiguration</strong>这个类，自动帮我们生成了<strong>SqlSessionFactory</strong> 这些 <strong>Mybatis</strong> 的重要实例并叫个<strong>spring</strong>容器管理，从而完成<strong>bean</strong>的自动注册。 </p>
<h4 id="springboot-特有的常见条件依赖注解："><a href="#springboot-特有的常见条件依赖注解：" class="headerlink" title="springboot 特有的常见条件依赖注解："></a><strong>springboot</strong> 特有的常见条件依赖注解：</h4><table>
<thead>
<tr>
<th>@ConditionalOnBean</th>
<th>仅在当前上下文中存在某个bean时，才会实例化这个Bean</th>
</tr>
</thead>
<tbody><tr>
<td>@ConditionalOnClass</td>
<td>某个class位于类路径上，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnExpression</td>
<td>当表达式为true的时候，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnMissingBean</td>
<td>仅在当前上下文中不存在某个bean时，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnMissingClass</td>
<td>某个class在类路径上不存在的时候，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnNotWebApplication</td>
<td>不是web应用时才会实例化这个Bean</td>
</tr>
<tr>
<td>@AutoConfigureAfter</td>
<td>在某个bean完成自动配置后实例化这个bean</td>
</tr>
<tr>
<td>@AutoConfigureBefore</td>
<td>在某个bean完成自动配置前实例化这个bean</td>
</tr>
</tbody></table>
<p>​    到这里，我们知道了，要想完成Mybatis的自动配置，需要在类路径中存在 <code>SqlSessionFactory.class、SqlSessionFactoryBean.class</code> 这两个类，同时也需要有DataSource这个bean存在且已经自动注册到容器中。</p>
<p>​    根据 <em><code>MybatisAutoConfiguration</code></em> 的名称我们可以得知，在<code>Springboot</code> 中，引入自动配置的DataSource的包的名称应该是 <code>DataSourceAutoConfiguration</code>;</p>
<p>​    通过查看该包所在目录我们知道这个包又属于spring-boot-autoconfigure-2.0.4.RELEASE.jar这个包，自动配置这个包帮们引入了<code>jdbc、kafka、logging、mongo**、**quartz</code>等包。很多包需要我们引入相应jar后自动配置才生效。 </p>
<img src="http://photo.wushaopei.com/qiniu117.png" width="60%">

<h3 id="获取到配置文件-application-properties-或application-yml-中的参数"><a href="#获取到配置文件-application-properties-或application-yml-中的参数" class="headerlink" title="获取到配置文件 application.properties 或application.yml 中的参数"></a><strong>获取到配置文件 application.properties 或application.yml 中的参数</strong></h3><h4 id="Bean-参数的获取"><a href="#Bean-参数的获取" class="headerlink" title="Bean 参数的获取"></a><strong>Bean 参数的获取</strong></h4><p>在这里，我们要解决的是怎么从 <code>.properties或yml</code>文件中获取参数，让<code>springboot</code>知道配置文件中有哪些参数？</p>
<p>在<code>DataSourceAutoConfiguration</code>类里面，我们注意到使用了<code>EnableConfigurationProperties</code>这个注解。在该注解中引入了 <code>DataSourceProperties.class</code> 这个字节码文件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123;DataSource<span class="class">.<span class="keyword">class</span>, <span class="title">EmbeddedDatabaseType</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(</span>&#123;DataSourceProperties<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(</span>&#123;DataSourcePoolMetadataProvidersConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">DataSourceInitializationConfiguration</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">DataSourceAutoConfiguration</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击进入查看，DataSourceProperties中封装了数据源的各个属性，且使用了注解ConfigurationProperties指定了配置文件的前缀。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(</span><br><span class="line">    prefix = <span class="string">"spring.datasource"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProperties</span> <span class="keyword">implements</span> <span class="title">BeanClassLoaderAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> generateUniqueName;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends DataSource&gt; type;</span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String jndiName;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@EnableConfigurationProperties与@ConfigurationProperties这两个注解有什么用呢？我们先看一个例子： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo_started;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanClassLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> PropertiesBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/1/31 20:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"spring.datasource"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">//省略getter、setter...</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PropertiesBean&#123;"</span> +</span><br><span class="line">                <span class="string">"url='"</span> + url + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo_started;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SpringbootMybatisDemoApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/1/31 20:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.example"</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootMybatisDemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//SpringApplication.run(SpringbootMybatisDemoApplication.class, args);</span></span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(SpringbootMybatisDemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        <span class="comment">//获取yml配置转换后的bean</span></span><br><span class="line">        System.out.println(<span class="string">"----------------------"</span>+context.getBean(PropertiesBean<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行结果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu118.png" width="60%">

<p>从运行结果可以看出<code>@ConfigurationProperties与@EnableConfigurationPropertie</code>的作用就是：</p>
<p><code>@ConfigurationProperties</code>注解的作用是把yml或者properties配置文件转化为bean。</p>
<p><code>@EnableConfigurationProperties</code>注解的作用是使<code>@ConfigurationProperties</code>注解生效。如果只配置<code>@ConfigurationProperties</code>注解，在spring容器中是获取不到<code>yml或者properties</code>配置文件转化的bean的。</p>
<p>通过这种方式，把<code>yml或者properties</code>配置参数转化为bean，这些bean又是如何被发现与加载的？</p>
<h4 id="发现bean-并进行加载"><a href="#发现bean-并进行加载" class="headerlink" title="发现bean 并进行加载"></a><strong>发现bean 并进行加载</strong></h4><p>到了这里，我们解决了两个问题，知道了通过pom.xml加载到程序中的jar包是怎么被Springboot进行自动配置，也知道了Springboot中是怎么读取并使用 .properties或 .yml 文件的参数的。接下来我们需要将两者进行关联，参数Bean是怎么被发现，并加载到容器中与自动配置的bean进行关联映射的？</p>
<h4 id="Bean的发现"><a href="#Bean的发现" class="headerlink" title="Bean的发现"></a>Bean的发现</h4><p>从前面<strong>Springboot</strong>的自启动机制中可以知道，<strong>Springboot</strong> 默认扫描启动类所在的包下的主类与子类的所有组件，但并没有包括依赖包中的类，那么依赖包中的<strong>bean</strong>是如何被发现和加载的？ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在前面说过，<strong>SpringBoot</strong> 的自动配置是由<strong>@SpringBootApplication</strong>这个注解起得作用，具体的实现原理我们点进去看一下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringBootConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.TypeExcludeFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.FilterType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan.Filter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AliasFor;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(</span><br><span class="line">    excludeFilters = &#123;<span class="meta">@Filter</span>(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;TypeExcludeFilter<span class="class">.<span class="keyword">class</span>&#125;</span></span><br><span class="line"><span class="class">), @<span class="title">Filter</span>(</span></span><br><span class="line"><span class="class">    <span class="title">type</span> </span>= FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;AutoConfigurationExcludeFilter<span class="class">.<span class="keyword">class</span>&#125;</span></span><br><span class="line"><span class="class">)&#125;</span></span><br><span class="line"><span class="class">)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">SpringBootApplication</span> </span>&#123;</span><br><span class="line"> ........   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在SpringBootApplication注解类中，实际上重要的只有三个Annotation：</p>
<blockquote>
<p>@Configuration（@SpringBootConfiguration里面还是应用了@Configuration）</p>
<p>@EnableAutoConfiguration</p>
<p>@ComponentScan</p>
</blockquote>
<table>
<thead>
<tr>
<th>@Configuration</th>
<th>作用上面我们已经知道了，被注解的类将成为一个bean配置类。</th>
</tr>
</thead>
<tbody><tr>
<td>@ComponentScan</td>
<td>的作用就是自动扫描并加载符合条件的组件，比如@Component和@Repository等，最终将这些bean定义加载到spring容器中。</td>
</tr>
<tr>
<td>@Repository等，</td>
<td>最终将这些bean定义加载到spring容器中。</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>这个注解的功能很重要，借助@Import的支持，收集和注册依赖包中相关的bean定义。</td>
</tr>
</tbody></table>
<p>这里进入到 <code>@EnableAutoConfiguration</code> 注解中看看： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;AutoConfigurationImportSelector<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableAutoConfiguration</span> </span>&#123;</span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = <span class="string">"spring.boot.enableautoconfiguration"</span>;</span><br><span class="line"> </span><br><span class="line">    Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"> </span><br><span class="line">    String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上源码，<code>@EnableAutoConfiguration</code>注解引入了<code>@AutoConfigurationPackage</code>和<code>@Import</code>这两个注解。<code>@AutoConfigurationPackage</code>的作用就是自动配置的包，<code>@Import</code>导入需要自动配置的组件。 </p>
<p>进入@<strong>AutoConfigurationPackage</strong>，发现也是引入了@<strong>Import</strong>注解 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;Registrar<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">AutoConfigurationPackage</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点进去 @<strong>Import</strong> 引用的 <strong>Registrar.class</strong> 的<strong>Registrar</strong>类去看看： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Order</span>(-<span class="number">2147483648</span>)</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Registrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">DeterminableImports</span> </span>&#123;</span><br><span class="line">        Registrar() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">            AutoConfigurationPackages.register(registry, (<span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata)).getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上述源码我们可以解决一个小困惑，如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata)).getPackageName()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>AutoConfigurationPackages翻译成人话，就是 自动配置的包。PackageImport()方法代表配置的原数据</p>
</blockquote>
<p>​    这两句代码的作用是用来加载启动类所在的包下的主类与子类的所有组件注册到<strong>spring</strong> 容器，这就是前文所说的<strong>springboot</strong>默认扫描启动类所在的包下的主类与子类的所有组件。</p>
<p>​    这里进入<strong>AutoConfigurationPackages</strong> 包去看看，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AnnotationMetadata</span> <span class="keyword">extends</span> <span class="title">ClassMetadata</span>, <span class="title">AnnotatedTypeMetadata</span> </span>&#123;</span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">getAnnotationTypes</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">getMetaAnnotationTypes</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasAnnotation</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasMetaAnnotation</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasAnnotatedMethods</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Set&lt;MethodMetadata&gt; <span class="title">getAnnotatedMethods</span><span class="params">(String var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单介绍一下，AnnotationMetadata 有两种重要的实现方案，一种基于 Java 反射，另一种基于 ASM 框架。</p>
<p>两种实现方案适用于不同场景。StandardAnnotationMetadata基于 Java 反射，需要加载类文件。而 AnnotationMetadataReadingVisitor 基于 ASM 框架无需提前加载类，所以适用于 Spring 应用扫描指定范围内模式注解时使用。</p>
<p>下面是metadata 的相关接口和类的关系图：</p>
<img src="http://photo.wushaopei.com/qiniu119.png" width="60%">

<p>获取并返回包名，PackageImport </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageImport</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String packageName;</span><br><span class="line"> </span><br><span class="line">        PackageImport(AnnotationMetadata metadata) &#123;</span><br><span class="line">            <span class="keyword">this</span>.packageName = ClassUtils.getPackageName(metadata.getClassName());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.packageName.hashCode();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> obj != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.getClass() == obj.getClass() ? <span class="keyword">this</span>.packageName.equals(((AutoConfigurationPackages.PackageImport)obj).packageName) : <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPackageName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.packageName;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Package Import "</span> + <span class="keyword">this</span>.packageName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>根据元数据中返回的类名获取其所在的包目录，将该包目录返回给容器，用于自定义扫描包或默认配置扫描。 </p>
<p>回到原来的问题上，搜集并注册到spring 容器的那些bean来自哪里？</p>
<p>​    进入<code>@EnableAutoConfiguration</code>注解的<code>EnableAutoConfigurationImportSelector</code> 类中去看看，该类继承了A<code>utoConfigurationImportSelector</code> 类，进入该类进行看下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableAutoConfigurationImportSelector</span> <span class="keyword">extends</span> <span class="title">AutoConfigurationImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnableAutoConfigurationImportSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">        return this.getClass().equals(EnableAutoConfigurationImportSelector.class) ? ((Boolean)this.getEnvironment().getProperty("spring.boot.enableautoconfiguration", Boolean.class, true)).booleanValue() : true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">EnvironmentAware</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] NO_IMPORTS = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(AutoConfigurationImportSelector<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    ...............</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoConfigurationImportSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">                AnnotationAttributes attributes = <span class="keyword">this</span>.getAttributes(annotationMetadata);</span><br><span class="line">                List&lt;String&gt; configurations = <span class="keyword">this</span>.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">                configurations = <span class="keyword">this</span>.removeDuplicates(configurations);</span><br><span class="line">                configurations = <span class="keyword">this</span>.sort(configurations, autoConfigurationMetadata);</span><br><span class="line">                Set&lt;String&gt; exclusions = <span class="keyword">this</span>.getExclusions(annotationMetadata, attributes);</span><br><span class="line">                <span class="keyword">this</span>.checkExcludedClasses(configurations, exclusions);</span><br><span class="line">                configurations.removeAll(exclusions);</span><br><span class="line">                configurations = <span class="keyword">this</span>.filter(configurations, autoConfigurationMetadata);</span><br><span class="line">                <span class="keyword">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">                <span class="keyword">return</span> (String[])configurations.toArray(<span class="keyword">new</span> String[configurations.size()]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">..............</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AnnotationAttributes <span class="title">getAttributes</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">        String name = <span class="keyword">this</span>.getAnnotationClass().getName();</span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(name, <span class="keyword">true</span>));</span><br><span class="line">        Assert.notNull(attributes, <span class="string">"No auto-configuration attributes found. Is "</span> + metadata.getClassName() + <span class="string">" annotated with "</span> + ClassUtils.getShortName(name) + <span class="string">"?"</span>);</span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getAnnotationClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> EnableAutoConfiguration<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(<span class="keyword">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="keyword">this</span>.getBeanClassLoader());</span><br><span class="line">        Assert.notEmpty(configurations, <span class="string">"No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct."</span>);</span><br><span class="line">        <span class="keyword">return</span> configurations;</span><br><span class="line">    &#125;</span><br><span class="line">.........</span><br></pre></td></tr></table></figure>

<p>​        在 <code>selectImports</code> 方法中，<code>SpringFactoriesLoader.loadFactoryNames</code> 方法扫描所有具有<code>META-INF/spring.factories</code>的jar包。spring-boot-autoconfigure-x.x.x.x.jar里就有一个这样的spring.factories文件。</p>
<p>​    注意：在启动 动<code>loadFactoryNames（）</code>方法前，<code>SpringFactoriesLoader.loadFactoryNames</code>方法调用<code>loadSpringFactories</code>方法从所有的jar包中读取<code>META-INF/spring.factories</code>文件信息。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">loadFactories</span><span class="params">(Class&lt;T&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(factoryClass, <span class="string">"'factoryClass' must not be null"</span>);</span><br><span class="line">        ClassLoader classLoaderToUse = classLoader;</span><br><span class="line">        <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            classLoaderToUse = SpringFactoriesLoader<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        List&lt;String&gt; factoryNames = loadFactoryNames(factoryClass, classLoaderToUse);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"Loaded ["</span> + factoryClass.getName() + <span class="string">"] names: "</span> + factoryNames);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        List&lt;T&gt; result = <span class="keyword">new</span> ArrayList(factoryNames.size());</span><br><span class="line">        Iterator var5 = factoryNames.iterator();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">            String factoryName = (String)var5.next();</span><br><span class="line">            result.add(instantiateFactory(factoryName, factoryClass, classLoaderToUse));</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        AnnotationAwareOrderComparator.sort(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>loadFactories</strong>会将加载到的<strong>jar</strong>中的类加载并保存，以提供<strong>loadFactoryNames</strong>中进行配置添加到执行序列 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        String factoryClassName = factoryClass.getName();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Enumeration&lt;URL&gt; urls = classLoader != <span class="keyword">null</span> ? classLoader.getResources(<span class="string">"META-INF/spring.factories"</span>) : ClassLoader.getSystemResources(<span class="string">"META-INF/spring.factories"</span>);</span><br><span class="line">            ArrayList result = <span class="keyword">new</span> ArrayList();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">while</span>(urls.hasMoreElements()) &#123;</span><br><span class="line">                URL url = (URL)urls.nextElement();</span><br><span class="line">                Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(url));</span><br><span class="line">                String factoryClassNames = properties.getProperty(factoryClassName);</span><br><span class="line">                result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var8) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load ["</span> + factoryClass.getName() + <span class="string">"] factories from location ["</span> + <span class="string">"META-INF/spring.factories"</span> + <span class="string">"]"</span>, var8);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>spring.factories</code>文件也是一组一组的<code>key=value</code>的形式，其中一个<code>key</code>是<code>EnableAutoConfiguration</code>类的全类名，而它的<code>value</code>是一个<code>xxxxAutoConfiguration</code>的类名的列表，这些类名以逗号分隔，如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu120.png" width="90%">

<p>​     这个      <code>@EnableAutoConfiguration</code>注解通过<code>@SpringBootApplication</code>被间接的标记在了Spring Boot的启动类上。在 <code>SpringApplication.run(...)</code>的内部就会执行<code>selectImports()</code>方法，找到所有JavaConfig自动配置类的全限定名对应的class，然后将所有自动配置类加载到Spring容器中。</p>
<p>​    其中有一个key为   <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>的值定义了需要自动配置的bean，通过读取这个配置获取一组 <code>@Configuration</code>类。</p>
<p>​    注意：每个xxxAutoConfiguration都是一个基于java的bean配置类。实际上，这些<code>xxxAutoConfiguratio</code>不是所有都会被加载，会根据  <code>xxxAutoConfiguration</code>上的<code>@ConditionalOnClass</code>等条件判断是否加载。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">instantiateFactory</span><span class="params">(String instanceClassName, Class&lt;T&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; instanceClass = ClassUtils.forName(instanceClassName, classLoader);</span><br><span class="line">            <span class="keyword">if</span> (!factoryClass.isAssignableFrom(instanceClass)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Class ["</span> + instanceClassName + <span class="string">"] is not assignable to ["</span> + factoryClass.getName() + <span class="string">"]"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Constructor&lt;?&gt; constructor = instanceClass.getDeclaredConstructor();</span><br><span class="line">                ReflectionUtils.makeAccessible(constructor);</span><br><span class="line">                <span class="keyword">return</span> constructor.newInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to instantiate factory class: "</span> + factoryClass.getName(), var5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p> 如上代码段，通过反射机制将<strong>spring.factories</strong>中<strong>@Configuration</strong>类实例化为对应的<strong>java</strong>实列。到此我们已经知道怎么发现要自动配置的<strong>bean</strong>了，最后一步就是怎么样将这些<strong>bean</strong>加载到<strong>spring</strong>容器。 </p>
<h4 id="bean的加载"><a href="#bean的加载" class="headerlink" title="bean的加载"></a>bean的加载</h4><p>如果要让一个普通类交给Spring容器管理，通常有以下方法：</p>
<ol>
<li>使用 @Configuration与@Bean 注解</li>
<li>使用@Controller @Service @Repository @Component 注解标注该类，然后启用@ComponentScan自动扫描</li>
<li>使用@Import 方法</li>
</ol>
<p><strong>springboot</strong>中使用了<strong>@Import</strong> 方法</p>
<p><strong>@EnableAutoConfiguration</strong>注解中使用<code>@Import({AutoConfigurationImportSelector.class})</code>注解，<strong>AutoConfigurationImportSelector</strong>实现了<strong>DeferredImportSelector</strong>接口，</p>
<p><strong>DeferredImportSelector</strong>接口继承了<strong>ImportSelector</strong>接口，<strong>ImportSelector</strong>接口只有一个<strong>selectImports</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span></span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">            AnnotationAttributes attributes = <span class="keyword">this</span>.getAttributes(annotationMetadata);</span><br><span class="line">            List configurations = <span class="keyword">this</span>.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">            configurations = <span class="keyword">this</span>.removeDuplicates(configurations);</span><br><span class="line">            Set exclusions = <span class="keyword">this</span>.getExclusions(annotationMetadata, attributes);</span><br><span class="line">            <span class="keyword">this</span>.checkExcludedClasses(configurations, exclusions);</span><br><span class="line">            configurations.removeAll(exclusions);</span><br><span class="line">            configurations = <span class="keyword">this</span>.filter(configurations, autoConfigurationMetadata);</span><br><span class="line">            <span class="keyword">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">            <span class="keyword">return</span> StringUtils.toStringArray(configurations);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeferredImportSelector</span> <span class="keyword">extends</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> Class&lt;? extends DeferredImportSelector.Group&gt; getImportGroup() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Group</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    String[] selectImports(AnnotationMetadata var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 我们先通过一个简单例子看看<strong>@Import</strong>注解是如何将<strong>bean</strong>导入到<strong>spring</strong>容器的。 </p>
<h5 id="新建一个bean"><a href="#新建一个bean" class="headerlink" title="新建一个bean"></a>新建一个bean</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSelecter</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"com.mmall.demo.model.User"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建一个UserSelecter类继承ImportSelector接口并实现selectImports方法"><a href="#创建一个UserSelecter类继承ImportSelector接口并实现selectImports方法" class="headerlink" title="创建一个UserSelecter类继承ImportSelector接口并实现selectImports方法"></a>创建一个<strong>UserSelecter</strong>类继承<strong>ImportSelector</strong>接口并实现<strong>selectImports</strong>方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSelecter</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"com.mmall.demo.model.User"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建ImportConfig类，使用-Configuration、-Import-ItpscSelector-class-注解。"><a href="#创建ImportConfig类，使用-Configuration、-Import-ItpscSelector-class-注解。" class="headerlink" title="创建ImportConfig类，使用@Configuration、@Import(ItpscSelector.class)注解。"></a>创建ImportConfig类，使用@Configuration、@Import(ItpscSelector.class)注解。</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(UserSelecter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ImportConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="从容器获取bean"><a href="#从容器获取bean" class="headerlink" title="从容器获取bean"></a>从容器获取bean</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectImport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext(ImportConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String[] beanDefinitionNames = ctx.getBeanDefinitionNames();</span><br><span class="line">		<span class="keyword">for</span> (String name : beanDefinitionNames) &#123;</span><br><span class="line">			System.out.println(name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">59.283</span>  INFO <span class="number">17128</span> --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@<span class="number">6240651f</span>: startup date [Sat Feb <span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">59</span> CST <span class="number">2020</span>]; root of context hierarchy</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">importConfig</span><br><span class="line">com.mmall.demo.model.User</span><br><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">59.309</span>  INFO <span class="number">17128</span> --- [       Thread-<span class="number">2</span>] o.s.w.c.s.GenericWebApplicationContext   : Closing org.springframework.web.context.support.GenericWebApplicationContext@<span class="number">53</span>ce1329: startup date [Sat Feb <span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">55</span> CST <span class="number">2020</span>]; root of context hierarchy</span><br></pre></td></tr></table></figure>

<p>从结果可以看出：<strong>selectImports</strong>方法返回一组<strong>bean</strong>，<strong>@EnableAutoConfiguration</strong>注解借助<strong>@Import</strong>注解将这组<strong>bean</strong>注入到<strong>spring</strong>容器中，<strong>springboot</strong>正式通过这种机制来完成<strong>bean</strong>的注入的。 </p>
<p><strong>总结：</strong> </p>
<blockquote>
<p>Spring Boot启动的时候会通过@EnableAutoConfiguration注解找到META-INF/spring.factories配置文件中的所有自动配置类，并对其进行加载，而这些自动配置类都是以AutoConfiguration结尾来命名的，它实际上就是一个JavaConfig形式的Spring容器配置类，它能通过以Properties结尾命名的类中取得在全局配置文件中配置的属性如：server.port，而XxxxProperties类是通过@ConfigurationProperties注解与全局配置文件中对应的属性进行绑定的。</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu121.png" width="90%">

<p>图片来自于王福强老师的博客：<a href="https://afoo.me/posts/2015-07-09-how-spring-boot-works.html" target="_blank" rel="noopener">https://afoo.me/posts/2015-07-09-how-spring-boot-works.html</a>  </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot原理篇</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（六）流程定义部署ZIP方式</title>
    <url>/2020/03/13/Activity-%EF%BC%88%E5%85%AD%EF%BC%89%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E9%83%A8%E7%BD%B2ZIP%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<p>通过Classpath的方式加载资源文件来部署流程定义，这种方式始终有局限性，只能适合小项目固定流程写死的。</p>
<p>实际项目的话，需要使用动态导入流程定义文件，可以通过bpmn和png文件打包成zip压缩包，</p>
<p>然后用户界面直接导入到系统，然后在解析部署流程定义，Activiti插件是支持这种方式的。</p>
<p>把bpmn流程文件和png流程图文件打成zip压缩包，</p>
<p>放到diagrams文件下（ 在真实的项目中是通过文件上传实现的）：</p>
<img src="http://photo.wushaopei.com/qiniu112.png" width="60%">

<p>创建一个新的测试类ActivitHelloWorldZIPTest 其中新建一个deployWithZip()方法用zip方式来实现： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 部署流程定义使用zip方式</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deployWithZip</span><span class="params">()</span></span>&#123;</span><br><span class="line">      InputStream inputStream=<span class="keyword">this</span>.getClass()  <span class="comment">// 获取当前class对象</span></span><br><span class="line">                          .getClassLoader()   <span class="comment">// 获取类加载器</span></span><br><span class="line">                          .getResourceAsStream(<span class="string">"diagrams/MyProcess.zip"</span>); <span class="comment">// 获取指定文件资源流</span></span><br><span class="line">      ZipInputStream zipInputStream=<span class="keyword">new</span> ZipInputStream(inputStream); <span class="comment">// 实例化zip输入流对象</span></span><br><span class="line">      <span class="comment">// 获取部署对象</span></span><br><span class="line">      Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">                   .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">                   .name(<span class="string">"HelloWorld流程2"</span>)  <span class="comment">// 流程名称</span></span><br><span class="line">                   .addZipInputStream(zipInputStream)  <span class="comment">// 添加zip是输入流</span></span><br><span class="line">                   .deploy(); <span class="comment">// 部署</span></span><br><span class="line">      System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">      System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">09:37:20.775 [main] DEBUG org.activiti.engine.impl.interceptor.LogInterceptor - --- DeployCmd finished --------------------------------------------------------</span><br><span class="line">09:37:20.775 [main] DEBUG org.activiti.engine.impl.interceptor.LogInterceptor - </span><br><span class="line"></span><br><span class="line">流程部署ID:2501</span><br><span class="line">流程部署Name:HelloWorld流程2</span><br></pre></td></tr></table></figure>

<p>已经成功部署流程定义了。</p>
<p>查询定义流程 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询定义流程</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findProcessDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//流程定义和部署相关的service</span></span><br><span class="line">		RepositoryService repositoryService = processEngine.getRepositoryService();</span><br><span class="line">		<span class="comment">//创建一个流程定义的查询</span></span><br><span class="line">		ProcessDefinitionQuery createProcessDefinitionQuery = repositoryService.createProcessDefinitionQuery();</span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.deploymentId(deploymentId)使用对象部署id查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionId(processDefinitionId);使用流程定义的id查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionKey(processDefinitionKey);使用流程定义的key查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionNameLike(processDefinitionNameLike);使用流程定义的名称模糊查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionKey(processDefinitionKey).list();返回一个集合</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionId(processDefinitionId).singleResult();返回唯一结果集</span></span><br><span class="line">		ProcessDefinitionQuery desc = createProcessDefinitionQuery.orderByProcessDefinitionVersion().desc();</span><br><span class="line">		List&lt;ProcessDefinition&gt; list = desc.list();</span><br><span class="line">		<span class="keyword">if</span>(list!=<span class="keyword">null</span>&amp;&amp;list.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">for</span>(ProcessDefinition ProcessDefinition:list)&#123;</span><br><span class="line">				System.out.println(<span class="string">"流程定义id"</span>+ProcessDefinition.getId());</span><br><span class="line">				System.out.println(<span class="string">"流程定义名称"</span>+ProcessDefinition.getName());</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>删除定义流程 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteProcessDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 不带级联删除</span></span><br><span class="line"><span class="comment">		 *  只能删除没有启动的流程 ，流程启动无法删除</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line"><span class="comment">//		processEngine.getRepositoryService().deleteDeployment("1");</span></span><br><span class="line">		<span class="comment">//可以删除任何流程 ，Id 取自 act_ge_bytearry 表的DEPLOYMENT_ID</span></span><br><span class="line">		processEngine.getRepositoryService().deleteDeployment(<span class="string">"2501"</span>,<span class="keyword">true</span>); </span><br><span class="line">		System.out.println(<span class="string">"ok"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>之后仔细观察Activiti25张表中的一些数据变化：</p>
<ol>
<li>act_re_deployment 流程定义部署表</li>
<li>act_re_procdef 流程定义表</li>
<li>act_ge_bytearry 资源文件表</li>
<li>act_ge_property 属性表</li>
</ol>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>Java8-Lambda指南（二）Lambda 表达式</title>
    <url>/2020/03/12/Java8-Lambda%E6%8C%87%E5%8D%97%EF%BC%88%E4%BA%8C%EF%BC%89Lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="Lambda-expressions"><a href="#Lambda-expressions" class="headerlink" title="Lambda expressions"></a>Lambda expressions</h2><p>让我们从一个简单的例子开始，先了解下在以前的Java版本中，是 如何对字符串列表进行排序的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; names = Arrays.asList(<span class="string">"peter"</span>, <span class="string">"anna"</span>, <span class="string">"mike"</span>, <span class="string">"xenia"</span>);</span><br><span class="line"></span><br><span class="line">Collections.sort(names, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String a, String b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b.compareTo(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通用的静态方法 <strong>Collections.sort</strong> 可以接收一个列表和一个比较器，以便对给定列表中的元素进行排序。您经常发现自己创建了匿名比较器，并将它们传递给sort方法。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collections.sort(names, (String a, String b) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> b.compareTo(a);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如你所见，代码更短，更容易阅读。但它变得更短: </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collections.sort(names, (String a, String b) -&gt; b.compareTo(a));</span><br></pre></td></tr></table></figure>

<p>在只针对一个方法主体时，可以跳过大括号{}和return关键字 。此时可以看到它变得更短了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">names.sort((a, b) -&gt; b.compareTo(a));</span><br></pre></td></tr></table></figure>

<p>List现在有一个排序方法。 java编译器也知道参数类型，所以您也可以跳过它们。让我们更深入地研究lambda表达式如何在外部使用。 </p>
<p><strong>问题： 作为匿名方法的 new Comparator 怎么被省去的？</strong></p>
<p>​             <strong>(String a, String b) -&gt; b.compareTo(a) 中的 “- &gt; ”代表什么？</strong></p>
<p>原文链接： <a href="https://github.com/winterbe/java8-tutorial" target="_blank" rel="noopener">Modern Java - A Guide to Java 8 </a> </p>
<p>翻译： <a href="http://wushaopei.com/" target="_blank" rel="noopener">http://wushaopei.com/</a> - <a href="http://wushaopei.com/" target="_blank" rel="noopener">吴少培</a></p>
<p>译文链接： <a href="http://www.wushaopei/8554.html" target="_blank" rel="noopener">http://www.wushaopei/8554.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>java 8 新特性</category>
      </categories>
  </entry>
  <entry>
    <title>Java8:Lambda指南（一）接口的默认方法</title>
    <url>/2020/03/12/Java8-Lambda%E6%8C%87%E5%8D%97%EF%BC%88%E4%B8%80%EF%BC%89%E6%8E%A5%E5%8F%A3%E7%9A%84%E9%BB%98%E8%AE%A4%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>Java 8允许我们利用<strong>default关键字向接口添加非抽象方法实现</strong>。这个特性也称为<strong>虚拟扩展方法</strong>（ <a href="http://stackoverflow.com/a/24102730" target="_blank" rel="noopener">virtual extension methods</a>）。 </p>
<p>这是我们的第一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Formula</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">double</span> <span class="title">sqrt</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Math.sqrt(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了抽象方法计算外，接口公式还定义了默认方法sqrt。 具体类只需实现抽象方法计算。 默认方法sqrt可以开箱即用。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Formula formula = <span class="keyword">new</span> Formula() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sqrt(a * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">formula.calculate(<span class="number">100</span>);     <span class="comment">// 100.0</span></span><br><span class="line">formula.sqrt(<span class="number">16</span>);           <span class="comment">// 4.0</span></span><br></pre></td></tr></table></figure>

<p>该公式被实现为一个匿名object。它的代码是相当冗长的：这样简单的一个 sqrt(a * 100)计算需要 6行代码。我们将会在下一节看到，在Java 8中有一种更好的实现单个方法对象的方法。 </p>
<p>原文链接： <a href="https://github.com/winterbe/java8-tutorial" target="_blank" rel="noopener">Modern Java - A Guide to Java 8 </a> </p>
<p>翻译： <a href="http://wushaopei.com/" target="_blank" rel="noopener">http://wushaopei.com/</a> - <a href="http://wushaopei.com/" target="_blank" rel="noopener">吴少培</a></p>
<p>译文链接： <a href="http://www.wushaopei/8554.html" target="_blank" rel="noopener">http://www.wushaopei/8554.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>java 8 新特性</category>
      </categories>
  </entry>
  <entry>
    <title>mybatis-知识树目录</title>
    <url>/2020/03/12/mybatis-%E7%9F%A5%E8%AF%86%E6%A0%91%E7%9B%AE%E5%BD%95/</url>
    <content><![CDATA[<p>[TOC]</p>
<h2 id="MyBatis简介"><a href="#MyBatis简介" class="headerlink" title="MyBatis简介"></a>MyBatis简介</h2><h3 id="传统的JDBC编程"><a href="#传统的JDBC编程" class="headerlink" title="传统的JDBC编程"></a><a href="http://wushaopei.com/2020/03/12/mybatis%20%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%80%EF%BC%89%E4%BC%A0%E7%BB%9F%E7%9A%84JDBC%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%8D%E8%B6%B3/" target="_blank" rel="noopener">传统的JDBC编程</a></h3><h3 id="ORM模型"><a href="#ORM模型" class="headerlink" title="ORM模型"></a><a href="https://blog.wushaopei.com/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%8C%EF%BC%89ORM-%E6%A8%A1%E5%9E%8B-1/">ORM模型</a></h3><h3 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a><a href="https://blog.wushaopei.com/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%89%EF%BC%89Hibernate/">Hibernate</a></h3><h3 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a><a href="https://blog.wushaopei.com/2020/03/30/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E5%9B%9B%EF%BC%89Mybatis/">MyBatis</a></h3><h3 id="什么时候用MyBatis"><a href="#什么时候用MyBatis" class="headerlink" title="什么时候用MyBatis"></a><a href="https://blog.wushaopei.com/2020/04/01/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%94%EF%BC%89%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8MyBatis/">什么时候用MyBatis</a></h3><h2 id="MyBatis-入门"><a href="#MyBatis-入门" class="headerlink" title="MyBatis 入门"></a>MyBatis 入门</h2><h3 id="开发环境准备"><a href="#开发环境准备" class="headerlink" title="开发环境准备"></a><a href="https://blog.wushaopei.com/2020/04/01/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/">开发环境准备</a></h3><h4 id="下载MyBatis"><a href="#下载MyBatis" class="headerlink" title="下载MyBatis"></a>下载MyBatis</h4><h4 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h4><h3 id="MyBatis的基本构成"><a href="#MyBatis的基本构成" class="headerlink" title="MyBatis的基本构成"></a>MyBatis的基本构成</h3><h4 id="构建SqlSessionFactory"><a href="#构建SqlSessionFactory" class="headerlink" title="构建SqlSessionFactory"></a>构建SqlSessionFactory</h4><h4 id="创建SqlSession"><a href="#创建SqlSession" class="headerlink" title="创建SqlSession"></a>创建SqlSession</h4><h4 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h4><h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><h4 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h4><h4 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h4><h4 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h4><h4 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h4><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h3><h4 id="property子元素"><a href="#property子元素" class="headerlink" title="property子元素"></a>property子元素</h4><h4 id="properties配置文件"><a href="#properties配置文件" class="headerlink" title="properties配置文件"></a>properties配置文件</h4><h4 id="程序参数传递"><a href="#程序参数传递" class="headerlink" title="程序参数传递"></a>程序参数传递</h4><h4 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h4><h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><h3 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h3><h4 id="系统定义别名"><a href="#系统定义别名" class="headerlink" title="系统定义别名"></a>系统定义别名</h4><h4 id="自定义别名"><a href="#自定义别名" class="headerlink" title="自定义别名"></a>自定义别名</h4><h3 id="typeHandler类型处理器"><a href="#typeHandler类型处理器" class="headerlink" title="typeHandler类型处理器"></a>typeHandler类型处理器</h3><h4 id="系统定义的typeHandler"><a href="#系统定义的typeHandler" class="headerlink" title="系统定义的typeHandler"></a>系统定义的typeHandler</h4><h4 id="自定义typeHandler"><a href="#自定义typeHandler" class="headerlink" title="自定义typeHandler"></a>自定义typeHandler</h4><h4 id="枚举类型typeHandler"><a href="#枚举类型typeHandler" class="headerlink" title="枚举类型typeHandler"></a>枚举类型typeHandler</h4><h3 id="ObjectFactory"><a href="#ObjectFactory" class="headerlink" title="ObjectFactory"></a>ObjectFactory</h3><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><h3 id="environments-配置环境"><a href="#environments-配置环境" class="headerlink" title="environments 配置环境"></a>environments 配置环境</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><h4 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h4><h4 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h4><h3 id="databaseIdProvider数据库厂商标识"><a href="#databaseIdProvider数据库厂商标识" class="headerlink" title="databaseIdProvider数据库厂商标识"></a>databaseIdProvider数据库厂商标识</h3><h4 id="使用系统默认规则"><a href="#使用系统默认规则" class="headerlink" title="使用系统默认规则"></a>使用系统默认规则</h4><h4 id="不使用系统默认规则"><a href="#不使用系统默认规则" class="headerlink" title="不使用系统默认规则"></a>不使用系统默认规则</h4><h3 id="引入映射器的方法"><a href="#引入映射器的方法" class="headerlink" title="引入映射器的方法"></a>引入映射器的方法</h3><h2 id="映射器-1"><a href="#映射器-1" class="headerlink" title="映射器"></a>映射器</h2><h3 id="映射器的主要元素"><a href="#映射器的主要元素" class="headerlink" title="映射器的主要元素"></a>映射器的主要元素</h3><h3 id="select-元素"><a href="#select-元素" class="headerlink" title="select 元素"></a>select 元素</h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><h4 id="简易数据类型的例子"><a href="#简易数据类型的例子" class="headerlink" title="简易数据类型的例子"></a>简易数据类型的例子</h4><h4 id="自动映射"><a href="#自动映射" class="headerlink" title="自动映射"></a>自动映射</h4><h4 id="传递多个参数"><a href="#传递多个参数" class="headerlink" title="传递多个参数"></a>传递多个参数</h4><h4 id="使用resultMap映射结果集"><a href="#使用resultMap映射结果集" class="headerlink" title="使用resultMap映射结果集"></a>使用resultMap映射结果集</h4><h3 id="insert元素"><a href="#insert元素" class="headerlink" title="insert元素"></a>insert元素</h3><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><h4 id="主键回填和自定义"><a href="#主键回填和自定义" class="headerlink" title="主键回填和自定义"></a>主键回填和自定义</h4><h3 id="update元素和-delete元素"><a href="#update元素和-delete元素" class="headerlink" title="update元素和 delete元素"></a>update元素和 delete元素</h3><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><h4 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h4><h4 id="存储过程支持"><a href="#存储过程支持" class="headerlink" title="存储过程支持"></a>存储过程支持</h4><h4 id="特殊字符串替换和处理"><a href="#特殊字符串替换和处理" class="headerlink" title="特殊字符串替换和处理"></a>特殊字符串替换和处理</h4><h3 id="sql元素"><a href="#sql元素" class="headerlink" title="sql元素"></a>sql元素</h3><h3 id="resultMap结果映射集"><a href="#resultMap结果映射集" class="headerlink" title="resultMap结果映射集"></a>resultMap结果映射集</h3><h4 id="resultMap元素的构成"><a href="#resultMap元素的构成" class="headerlink" title="resultMap元素的构成"></a>resultMap元素的构成</h4><h4 id="使用map存储结果集"><a href="#使用map存储结果集" class="headerlink" title="使用map存储结果集"></a>使用map存储结果集</h4><h4 id="使用POJO存储结果集"><a href="#使用POJO存储结果集" class="headerlink" title="使用POJO存储结果集"></a>使用POJO存储结果集</h4><h4 id="级联"><a href="#级联" class="headerlink" title="级联"></a>级联</h4><h3 id="缓存cache"><a href="#缓存cache" class="headerlink" title="缓存cache"></a>缓存cache</h3><h4 id="系统缓存（一级缓存和二级缓存）"><a href="#系统缓存（一级缓存和二级缓存）" class="headerlink" title="系统缓存（一级缓存和二级缓存）"></a>系统缓存（一级缓存和二级缓存）</h4><h4 id="自定义缓存"><a href="#自定义缓存" class="headerlink" title="自定义缓存"></a>自定义缓存</h4>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>mybatis</tag>
        <tag>知识树</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（一）传统的JDBC编程的不足</title>
    <url>/2020/03/12/mybatis%20%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%80%EF%BC%89%E4%BC%A0%E7%BB%9F%E7%9A%84JDBC%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%8D%E8%B6%B3/</url>
    <content><![CDATA[<h3 id="JDBC的作用"><a href="#JDBC的作用" class="headerlink" title="JDBC的作用"></a>JDBC的作用</h3><p>Java程序都是通过JDBC连接数据库的，这样我们才能实现通过SQL对数据库编程。JDBC是SUN公司提出的一系列规范，并交由下游的数据库厂商去通过定义好的接口规范实现具体的数据库数据操作。</p>
<p>具体实现如下：</p>
<img src="http://photo.wushaopei.com/qiniu90.png" width="60%">

<h3 id="JDBC的不足"><a href="#JDBC的不足" class="headerlink" title="JDBC的不足"></a>JDBC的不足</h3><p>传统的JDBC功能虽然让我们能够连接数据库并实现对数据的操作，但也在一定程度上对我们的开发效率产生了影响。或者说，这是基于JDBC本身调用规则的一种缺陷。</p>
<p>关于以上说到的缺陷，我们通过代码来进行体现，这里通过JDBC实现对数据库的连接，并进行查询数据的操作。具体的数据库配置参数都放在了 <code>sqlDriver.properties</code>文件中</p>
<h4 id="创建jdbc连接，并封装为方法"><a href="#创建jdbc连接，并封装为方法" class="headerlink" title="创建jdbc连接，并封装为方法"></a><strong>创建jdbc连接，并封装为方法</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*	 * 获取数据库的连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 数据库的连接</span></span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			is = JDBCUtils.class.getClassLoader().getResourceAsStream("sqlDriver.properties");</span><br><span class="line">			Properties ps = <span class="keyword">new</span> Properties();</span><br><span class="line">			ps.load(is);</span><br><span class="line">			String user = ps.getProperty(<span class="string">"user"</span>);</span><br><span class="line">			String password = ps.getProperty(<span class="string">"password"</span>);</span><br><span class="line">			String driverClass = ps.getProperty(<span class="string">"driverClass"</span>);</span><br><span class="line">			String url = ps.getProperty(<span class="string">"url"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 创建Driver对象</span></span><br><span class="line">			Class clazz = Class.forName(driverClass);</span><br><span class="line">			Object obj = clazz.newInstance();</span><br><span class="line">			Driver driver = (Driver) obj;</span><br><span class="line">			<span class="comment">// 注册驱动</span></span><br><span class="line">			DriverManager.registerDriver(driver);</span><br><span class="line">			connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					is.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> connection;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在操作完成后要进行连接的关闭"><a href="#在操作完成后要进行连接的关闭" class="headerlink" title="在操作完成后要进行连接的关闭"></a><strong>在操作完成后要进行连接的关闭</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			connection.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ps.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps, ResultSet rs)</span> </span>&#123;</span><br><span class="line">	close(connection,ps);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(rs != <span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			rs.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询一条数据"><a href="#查询一条数据" class="headerlink" title="查询一条数据"></a>查询一条数据</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 查询一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Customer <span class="title">getCustomerById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"select * from customers where id = ?"</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		ps.setInt(<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery(); <span class="comment">// 查找的结果都已经放到ResultSet中了</span></span><br><span class="line"> </span><br><span class="line">		Customer customer = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 5.取数据</span></span><br><span class="line">		<span class="keyword">if</span> (rs.next()) &#123; <span class="comment">// 如果有数据就返回true,否则返回false</span></span><br><span class="line">			<span class="comment">// 获取列上值的第一种方式</span></span><br><span class="line">			<span class="comment">// int id = rs.getInt(1); //根据列的索引获取对应的列上的值</span></span><br><span class="line">			<span class="comment">// String name = rs.getString(2);</span></span><br><span class="line">			<span class="comment">// String email = rs.getString(3);</span></span><br><span class="line">			<span class="comment">// Date date = rs.getDate(4);</span></span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 获取列上值的第二种方式</span></span><br><span class="line">			<span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">			String name = rs.getString(<span class="string">"name"</span>);</span><br><span class="line">			String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">			Date birth = rs.getDate(<span class="string">"birth"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 考虑将数据进行封装</span></span><br><span class="line">			customer = <span class="keyword">new</span> Customer(id, name, email, birth);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 输出获取到的内容</span></span><br><span class="line">			System.out.println(id + <span class="string">" "</span> + name + <span class="string">" "</span> + email + <span class="string">" "</span> + birth);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 6.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		<span class="keyword">return</span> customer;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中我们可以可能出整个过程大致分为以下几步：</p>
<ul>
<li>使用JDBC编程需要连接数据库，注册驱动和数据库信息</li>
<li>操作Connection，打开PreparedStatement对象</li>
<li>通过PreparedStatement执行SQL，返回结果到ResultSet对象</li>
<li>使用ResultSet读取数据，然后通过代码转化为具体的POJO对象</li>
<li>关闭数据库相关资源</li>
</ul>
<h4 id="弊端"><a href="#弊端" class="headerlink" title="弊端"></a>弊端</h4><p>从以上分析中，我们可以看出，使用传统的JDBC会导致以下几个问题：</p>
<p>（1）工作量会很大，每次执行CRUD操作都需要线连接，然后处理JDBC底层事务，处理数据类型。然后还要操作Connection、PreparedStatement和ResultSet对象去获取数据，并在执行完后关闭它们</p>
<p>（2) 需要对JDBC编程可能产生的异常进行捕捉处理并正确关闭资源</p>
<p>如以上两个原因，会导致在使用JDBC开发编程的过程中多出了许多重复而无太大意义的工作量。有鉴于这一点，ORM框架应运而生，并且ORM框架也更加的轻量和高效。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
        <category>知识树</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity-（五）HelloWorld实现</title>
    <url>/2020/03/11/Activity-%EF%BC%88%E4%BA%94%EF%BC%89HelloWorld%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h3 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h3><p>做一个最简单的HellWorld流程用代码的方式实现并且走完流程。 </p>
<h3 id="以下是涉及到的比较重要的八张表"><a href="#以下是涉及到的比较重要的八张表" class="headerlink" title="以下是涉及到的比较重要的八张表"></a>以下是涉及到的比较重要的八张表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_re_deployment;   <span class="comment">-- 一 流程部署表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_ge_bytearray;    <span class="comment">-- 二 流程二进制表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_re_procdef;      <span class="comment">-- 三 流程定义表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_ru_execution;    <span class="comment">-- 四 流程正在运行表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_hi_procinst;     <span class="comment">-- 五 流程实例历史表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_ru_task;         <span class="comment">-- 六 流程当前任务表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_hi_taskinst;     <span class="comment">-- 七 流程历史任务表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_hi_actinst;      <span class="comment">-- 八 流程历史活动节点表</span></span><br></pre></td></tr></table></figure>

<h3 id="相关步骤如下："><a href="#相关步骤如下：" class="headerlink" title="相关步骤如下："></a>相关步骤如下：</h3><blockquote>
<p>1.首先是需要部署流程定义。</p>
<p>2.启动流程实例。</p>
<p>3.查看流程任务以及完成流程任务。</p>
</blockquote>
<h3 id="先决工作，成员变量定义"><a href="#先决工作，成员变量定义" class="headerlink" title="先决工作，成员变量定义"></a>先决工作，成员变量定义</h3><ol>
<li>获取流程实例引擎<strong>ProcessEngines</strong>；</li>
<li>获取<strong>RepositoryService</strong>;</li>
<li>获取<strong>RuntimeService</strong>;</li>
<li>获取<strong>TaskService</strong>;</li>
<li>获取<strong>HistoryService</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取默认的流程引擎实例 会自动读取activiti.cfg.xml文件 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个成员变量</span></span><br><span class="line">   RepositoryService repositoryService;</span><br><span class="line">   </span><br><span class="line">   RuntimeService runtimeService;</span><br><span class="line">   </span><br><span class="line">   TaskService taskService;</span><br><span class="line">   </span><br><span class="line">   HistoryService historyService;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取流程引擎</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Before</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">       repositoryService = processEngine.getRepositoryService();</span><br><span class="line">       runtimeService = processEngine.getRuntimeService();</span><br><span class="line">       taskService = processEngine.getTaskService();</span><br><span class="line">       historyService = processEngine.getHistoryService();</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="部署流程定义图："><a href="#部署流程定义图：" class="headerlink" title="部署流程定义图："></a>部署流程定义图：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 部署流程定义</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="comment">// 获取部署对象</span></span><br><span class="line">	    Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">	                 .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">	                 .addClasspathResource(<span class="string">"diagrams/MyProcess.bpmn"</span>)  <span class="comment">// 加载资源文件</span></span><br><span class="line"><span class="comment">//	                 .addClasspathResource("diagrams/helloWorld.png")   // 加载资源文件</span></span><br><span class="line"><span class="comment">//	                 .name("HelloWorld流程")  // 流程名称</span></span><br><span class="line">	                 .deploy(); <span class="comment">// 部署</span></span><br><span class="line">	    System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">	    System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">流程部署ID:17501</span><br><span class="line">流程部署Name:null</span><br></pre></td></tr></table></figure>



<h3 id="接着启动流程实例，这样一个流程才开始："><a href="#接着启动流程实例，这样一个流程才开始：" class="headerlink" title="接着启动流程实例，这样一个流程才开始："></a>接着启动流程实例，这样一个流程才开始：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 启动流程</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"myProcess"</span>);</span><br><span class="line">       String processInstanceId = processInstance.getId();</span><br><span class="line">       String activityId = processInstance.getActivityId();</span><br><span class="line">       String definitionId = processInstance.getProcessDefinitionId();</span><br><span class="line">       </span><br><span class="line">       System.out.println(<span class="string">"流程实例ID："</span>+processInstanceId);</span><br><span class="line">       System.out.println(<span class="string">"正在活动的节点ID："</span>+activityId);</span><br><span class="line">       System.out.println(<span class="string">"流程定义ID："</span>+definitionId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">流程实例ID：20001</span><br><span class="line">正在活动的节点ID：usertask1</span><br><span class="line">流程定义ID：myProcess:2:17504</span><br></pre></td></tr></table></figure>



<h3 id="查询正在运行的实例："><a href="#查询正在运行的实例：" class="headerlink" title="查询正在运行的实例："></a>查询正在运行的实例：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询正在运行的实例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryExecution</span><span class="params">()</span></span>&#123;</span><br><span class="line">       List&lt;Execution&gt; executionList = runtimeService.createExecutionQuery()  <span class="comment">//创建正在执行的流程查询对象</span></span><br><span class="line">                     .processDefinitionKey(<span class="string">"myProcess"</span>)   <span class="comment">//根据流程定义的key查询</span></span><br><span class="line">                     .orderByProcessInstanceId()  <span class="comment">//根据流程实例id排序</span></span><br><span class="line">                     .desc()  <span class="comment">//倒序</span></span><br><span class="line">                     .list();  <span class="comment">//查询出集合</span></span><br><span class="line">       <span class="keyword">for</span>(Execution execution: executionList)&#123;</span><br><span class="line">           System.out.println(<span class="string">"正在执行的流程对象的id: "</span>+execution.getId());</span><br><span class="line">           System.out.println(<span class="string">"所属流程实例的id:"</span>+execution.getProcessInstanceId());</span><br><span class="line">           System.out.println(<span class="string">"正在活动的节点的id: "</span>+execution.getActivityId());</span><br><span class="line">           System.out.println(<span class="string">"任务名称: "</span>+execution.getName());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正在执行的流程对象的id: 20001</span><br><span class="line">所属流程实例的id:20001</span><br><span class="line">正在活动的节点的id: usertask1</span><br><span class="line">任务名称: null</span><br></pre></td></tr></table></figure>



<h3 id="查看一下白夜行这个用户的任务信息："><a href="#查看一下白夜行这个用户的任务信息：" class="headerlink" title="查看一下白夜行这个用户的任务信息："></a>查看一下白夜行这个用户的任务信息：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据办理人查询任务</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryTaskByAssignee</span><span class="params">()</span></span>&#123;</span><br><span class="line">       String assignee = <span class="string">"白夜行"</span>;    <span class="comment">// assignee 要与流程图上的 Assignee 相同才会被查询到，否则就不返回该任务对象</span></span><br><span class="line">       <span class="comment">// 查询并且返回任务即可</span></span><br><span class="line">       List&lt;Task&gt; taskList = taskService.createTaskQuery()  <span class="comment">// 任务相关Service // 创建任务查询</span></span><br><span class="line">                                    .processDefinitionKey(<span class="string">"myProcess"</span>)</span><br><span class="line">                                    .taskAssignee(assignee)<span class="comment">// 指定某个人</span></span><br><span class="line">                                    .orderByTaskCreateTime()</span><br><span class="line">                                    .desc()</span><br><span class="line">                                    .list();</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">for</span>(Task task: taskList)&#123;</span><br><span class="line">        System.out.println(<span class="string">"任务ID:"</span>+task.getId());</span><br><span class="line">        System.out.println(<span class="string">"任务名称："</span>+task.getName());</span><br><span class="line">        System.out.println(<span class="string">"任务创建时间："</span>+task.getCreateTime());</span><br><span class="line">        System.out.println(<span class="string">"任务委派人："</span>+task.getAssignee());</span><br><span class="line">        System.out.println(<span class="string">"流程实例ID:"</span>+task.getProcessInstanceId());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">任务ID:20004</span><br><span class="line">任务名称：myprocess</span><br><span class="line">任务创建时间：Thu Mar 12 10:02:57 CST 2020</span><br><span class="line">任务委派人：白夜行</span><br><span class="line">流程实例ID:20001</span><br></pre></td></tr></table></figure>

<h3 id="查询当前流程实例状态"><a href="#查询当前流程实例状态" class="headerlink" title="查询当前流程实例状态"></a>查询当前流程实例状态</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询当前流程实例状态</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryProInstanceStateByProInstanceId</span><span class="params">()</span></span>&#123;</span><br><span class="line">       ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(<span class="string">"12501"</span>).singleResult();</span><br><span class="line">       <span class="keyword">if</span>(processInstance == <span class="keyword">null</span>)&#123;</span><br><span class="line">           System.out.println(<span class="string">"当前流程已经完成"</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           System.out.println(<span class="string">"当前流程实例ID："</span>+processInstance.getId());</span><br><span class="line">           System.out.println(<span class="string">"当前流程所处的位置："</span>+processInstance.getActivityId());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">当前流程实例ID：20001</span><br><span class="line">当前流程所处的位置：usertask1</span><br></pre></td></tr></table></figure>

<h3 id="最后完成HelloWorld节点任务，把流程走完："><a href="#最后完成HelloWorld节点任务，把流程走完：" class="headerlink" title="最后完成HelloWorld节点任务，把流程走完："></a>最后完成HelloWorld节点任务，把流程走完：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	TaskQuery query = taskService.createTaskQuery();			<span class="comment">//创建任务查询对象</span></span><br><span class="line">	List&lt;Task&gt; list = query.processDefinitionKey(<span class="string">"myProcess"</span>)	<span class="comment">//指定流程定义</span></span><br><span class="line">						   .taskAssignee(<span class="string">"白夜行"</span>)				<span class="comment">//指定委托人</span></span><br><span class="line">						   .list();								<span class="comment">//执行查询</span></span><br><span class="line">	<span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">		System.out.println(task);</span><br><span class="line">		<span class="comment">//taskService某些框架下需要使用@Autowired注解装配</span></span><br><span class="line">		taskService.complete(task.getId());						<span class="comment">//完成任务，使任务进入下一步</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询流程实例历史"><a href="#查询流程实例历史" class="headerlink" title="查询流程实例历史"></a>查询流程实例历史</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询流程实例历史</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryHistory</span><span class="params">()</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//1.创建流程实例的历史查询对象，historyService使用@Autowired注解注入</span></span><br><span class="line">	HistoricProcessInstanceQuery query = historyService.createHistoricProcessInstanceQuery();</span><br><span class="line">	HistoricProcessInstance instance = </span><br><span class="line">			query</span><br><span class="line">				.processInstanceId(<span class="string">"12501"</span>)	<span class="comment">//流程实例的id</span></span><br><span class="line">				.finished()					<span class="comment">//调用这个方法后未完成的流程实例会返回null</span></span><br><span class="line">				.singleResult();</span><br><span class="line">	System.out.println(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这里引出一个概念，流程定义和流程实例的关系，可以把这两种关系理解成是类和对象的关系。 </p>
<p>​    流程定义是一个模板，而流程实例就是通过模板演变出来的具体的可用的东西。</p>
<p>首先当运行：deploy()部署流程定义方法，在数据库中流程定义表会发生一些变化新增了一条数据，</p>
<p><strong>act_re_deployment</strong>流程定义部署表：</p>
<img src="http://photo.wushaopei.com/qiniu106.png" width="60%">

<p>然后<strong>act_re_prodef</strong>流程定义表也会有一条数据插入： </p>
<img src="http://photo.wushaopei.com/qiniu107.png" width="60%">

<p>以及在<strong>act_ge_bytearray</strong>表中用来存储资源信息： </p>
<img src="http://photo.wushaopei.com/qiniu108.png" width="60%">

<p>接着来运行<strong>start()</strong>启动流程实例：</p>
<p><strong>act_ru_task</strong>运行时流程任务表新增了一条数据：</p>
<img src="http://photo.wushaopei.com/qiniu109.png" width="60%">

<p><strong>act_ru_execution</strong> 运行时流程执行表： </p>
<img src="http://photo.wushaopei.com/qiniu111.png" width="60%">

<p><strong>act_ru_identitulink</strong>是用于执行主体相关信息表： </p>
<img src="http://photo.wushaopei.com/qiniu110.png" width="60%">

<p>可以查看刚刚”<strong>白夜行</strong>”这个用户的任务：</p>
<p>运行findTask()查看用户任务，控制台输出如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">任务ID:<span class="number">20004</span></span><br><span class="line">任务名称：myprocess</span><br><span class="line">任务创建时间：Thu Mar <span class="number">12</span> <span class="number">10</span>:<span class="number">02</span>:<span class="number">57</span> CST <span class="number">2020</span></span><br><span class="line">任务委派人：白夜行</span><br><span class="line">流程实例ID:<span class="number">20001</span></span><br></pre></td></tr></table></figure>

<p><strong>completeTask()</strong>方法完成任务：</p>
<p>然后数据库中<strong>ru</strong>开头的运行时候所有表的数据都没了，因为现在流程结束，不需要这些数据了。</p>
<p>在hi开头的表里，会新增不少数据，这些数据主要是用来归档查询用的，也就是历史数据。</p>
<p><strong>act_hi_taskinst</strong> 历史流程实例任务表加了一条任务数据；</p>
<p><strong>act_hi_procinst</strong> 历史流程实例实例表加了一条流程实例相关信息的数据（包括开始时间，结束时间等等信息）；</p>
<p><strong>act_hi_identitylink</strong> 历史流程实例参数者的表加了一条数据；</p>
<p><strong>act_hi_actinst</strong> 历史活动节点表加了三条流程活动节点信息的数据（每个流程实例具体的执行活动节点的信息）；</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>jdbc(四)ResultSet</title>
    <url>/2020/03/10/jdbc(%E5%9B%9B)ResultSet/</url>
    <content><![CDATA[<h2 id="ResultSet"><a href="#ResultSet" class="headerlink" title="ResultSet"></a><strong>ResultSet</strong></h2><h3 id="ResultSet-的作用："><a href="#ResultSet-的作用：" class="headerlink" title="ResultSet 的作用："></a><strong>ResultSet 的作用：</strong></h3><ul>
<li>通过调用 PreparedStatement 对象的 excuteQuery() 方法创建该对象</li>
<li>ResultSet 对象以逻辑表格的形式封装了执行数据库操作的结果集，ResultSet 接口由数据库厂商实现</li>
<li>ResultSet 对象维护了一个指向当前数据行的游标，初始的时候，游标在第一行之前，可以通过 ResultSet 对象的 next() 方法移动到下一行</li>
</ul>
<h3 id="ResultSet-接口的常用方法："><a href="#ResultSet-接口的常用方法：" class="headerlink" title="ResultSet 接口的常用方法："></a><strong>ResultSet 接口的常用方法：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">getString</span><span class="params">( )</span></span></span><br></pre></td></tr></table></figure>

<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a><strong>案例</strong></h3><p><strong>（1）</strong> </p>
<img src="http://photo.wushaopei.com/qiniu94.png" width="60%">

<p><strong>（2）</strong> </p>
<img src="http://photo.wushaopei.com/qiniu95.png" width="60%">

<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a><strong>说明</strong></h3><ol>
<li>查询需要调用Prepared Statement 的 executeQuery() 方法，查询结果是一个 ResultSet 对象 </li>
<li>关于 ResultSet：代表结果集 </li>
</ol>
<blockquote>
<ul>
<li>ResultSet: 结果集. 封装了使用 JDBC 进行查询的结果.</li>
<li>调用 PreparedStatement 对象的 executeQuery() 可以得到结果集.</li>
<li>ResultSet 返回的实际上就是一张数据表. 有一个指针指向数据表的第一条记录的前面.</li>
</ul>
</blockquote>
<ol start="3">
<li><p>可以调用 next() 方法检测下一行是否有效. 若有效该方法返回 true, 且指针下移. 相当于Iterator 对象的 hasNext() 和 next() 方法的结合体 </p>
</li>
<li><p>当指针指向一行时, 可以通过调用 getXxx(int index) 或 getXxx(int columnName) 获取每一列的值. </p>
<blockquote>
<p>   例如: getInt(1), getString(“name”) </p>
</blockquote>
</li>
<li><p>ResultSet 当然也需要进行关闭. </p>
</li>
</ol>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>resultSet</tag>
      </tags>
  </entry>
  <entry>
    <title>jdbc(二)获取数据库连接的五种方式</title>
    <url>/2020/03/10/jdbc(%E4%BA%8C)%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%9A%84%20%E4%BA%94%20%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="获取数据库连接"><a href="#获取数据库连接" class="headerlink" title="获取数据库连接"></a>获取数据库连接</h2><h3 id="连接参数与协议"><a href="#连接参数与协议" class="headerlink" title="连接参数与协议"></a>连接参数与协议</h3><p>（1）可以调用 DriverManager 类的 getConnection() 方法建立到数据库的连接</p>
<p>（2）User,password可以用“属性名=属性值”方式告诉数据库；</p>
<p>（3）JDBC URL 用于标识一个被注册的驱动程序，驱动程序管理器通过这个 URL 选择正确的驱动程序，从而建立到数据库的连接。</p>
<p>（4）JDBC URL的标准由三部分组成，各部分间用冒号分隔。</p>
<ul>
<li><span style="color:red;">jdbc:子协议:子名称</span></li>
<li>协议：JDBC URL中的协议总是jdbc</li>
<li>子协议：子协议用于标识一个数据库驱动程序</li>
<li>子名称：一种标识数据库的方法。子名称可以依不同的子协议而变化，用子名称的目的是为了定位数据库提供足够的信息。包含主机名(对应服务端的ip地址)，端口号，数据库名</li>
</ul>
<h3 id="几种常用数据库的JDBC-URL"><a href="#几种常用数据库的JDBC-URL" class="headerlink" title="几种常用数据库的JDBC URL"></a>几种常用数据库的JDBC URL</h3><img src="http://photo.wushaopei.com/qiniu92.png" width="60%">

<ul>
<li><p>对于Oracle 数据库连接，采用如下形式：</p>
<p><span style="color:red;">jdbc:oracle:thin:@localhost:1521:webcode</span></p>
</li>
<li><p>对于SQLServer数据库连接，采用如下形式：</p>
<p> <span style="color:red;">jdbc:microsoft:sqlserver//localhost:1433;DatabaseName=sid</span></p>
</li>
<li><p>对于MYSQL 数据库连接，采用如下形式：</p>
<p> <span style="color:red;">jdbc:mysql://localhost:3306/webcode</span></p>
</li>
</ul>
<h3 id="JDBC连接数据库的5种方式"><a href="#JDBC连接数据库的5种方式" class="headerlink" title="JDBC连接数据库的5种方式"></a>JDBC连接数据库的5种方式</h3><p><strong>注意：</strong></p>
<ol>
<li>安装数据库 - 服务必须开启</li>
<li>需要导入数据库的驱动</li>
</ol>
<p>连接数据库的<strong>五种方式</strong>： </p>
<p><strong>代码：</strong> </p>
<h4 id="方式1-："><a href="#方式1-：" class="headerlink" title="方式1 ："></a><strong>方式1 ：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 数据库的连接：</span></span><br><span class="line"><span class="comment"> * 1.必须保证数据库是安装好的，服务是启动的</span></span><br><span class="line"><span class="comment"> * 2.必须将驱动添加到项目中</span></span><br><span class="line"><span class="comment"> * 3.必须保证数据库的账号和密码是对的</span></span><br><span class="line"><span class="comment"> * 4.必须保证数据库的版本和驱动的一样。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式一  ：通过多态的方式获取连接驱动</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	<span class="comment">//多态 ： 左边是接口的类型，右边是接口的实现</span></span><br><span class="line">	Driver driver = <span class="keyword">new</span> com.mysql.jdbc.Driver();</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	<span class="comment">//设置数据库的账号和密码</span></span><br><span class="line">	Properties info = <span class="keyword">new</span> Properties();</span><br><span class="line">	info.setProperty(<span class="string">"user"</span>, <span class="string">"root"</span>);</span><br><span class="line">	info.setProperty(<span class="string">"password"</span>, <span class="string">"root"</span>);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connect = driver.connect(url, info);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式2-：通过反射获取对象"><a href="#方式2-：通过反射获取对象" class="headerlink" title="方式2   ：通过反射获取对象"></a><strong>方式2   ：</strong>通过反射获取对象</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式二：通过反射获取对象</span></span><br><span class="line"><span class="comment"> * 体会面向接口的编程思想</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	Class clazz = Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">	Object obj = clazz.newInstance();</span><br><span class="line">	<span class="comment">//多态 ： 左边是接口的类型，右边是接口的实现</span></span><br><span class="line">	Driver driver = (Driver) obj;</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	<span class="comment">//设置数据库的账号和密码</span></span><br><span class="line">	Properties info = <span class="keyword">new</span> Properties();</span><br><span class="line">	info.setProperty(<span class="string">"user"</span>, <span class="string">"root"</span>);</span><br><span class="line">	info.setProperty(<span class="string">"password"</span>, <span class="string">"root"</span>);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connect = driver.connect(url, info);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式3-：-通过DriverMananger获取数据库的连接"><a href="#方式3-：-通过DriverMananger获取数据库的连接" class="headerlink" title="方式3 ： 通过DriverMananger获取数据库的连接"></a><strong>方式3 ： 通过DriverMananger获取数据库的连接</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式三：通过DriverMananger获取数据库的连接</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 使用DriverMananger有两个操作</span></span><br><span class="line"><span class="comment"> * 1.注册驱动</span></span><br><span class="line"><span class="comment"> * 2.获取连接</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	Class clazz = Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">	Object obj = clazz.newInstance();</span><br><span class="line">	<span class="comment">//多态 ： 左边是接口的类型，右边是接口的实现</span></span><br><span class="line">	Driver driver = (Driver) obj;</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	String user = <span class="string">"root"</span>;</span><br><span class="line">	String password = <span class="string">"root"</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * mysql可以不用注册，其它的数据库必须进行注册</span></span><br><span class="line"><span class="comment">	 * 这一步不要省。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">//注册驱动</span></span><br><span class="line">	DriverManager.registerDriver(driver);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式4-：-mysql驱动默认会进行驱动的注册"><a href="#方式4-：-mysql驱动默认会进行驱动的注册" class="headerlink" title="方式4 ： mysql驱动默认会进行驱动的注册"></a><strong>方式4 ： mysql驱动默认会进行驱动的注册</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式四：mysql驱动默认会进行驱动的注册</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	String user = <span class="string">"root"</span>;</span><br><span class="line">	String password = <span class="string">"root"</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * mysql可以不用注册，其它的数据库必须进行注册</span></span><br><span class="line"><span class="comment">	 * 这一步不要省。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class clazz = Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式5-：-使用配置文件获取数据库的连接"><a href="#方式5-：-使用配置文件获取数据库的连接" class="headerlink" title="方式5 ： 使用配置文件获取数据库的连接"></a><strong>方式5 ： 使用配置文件获取数据库的连接</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 方式五：使用配置文件获取数据库的连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		<span class="comment">//读取配置文件中的内容</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * 实际上是从bin目录下读取的配置文件</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		InputStream is = <span class="keyword">this</span>.getClass().getClassLoader()</span><br><span class="line">				.getResourceAsStream(<span class="string">"sqlDriver.properties"</span>);</span><br><span class="line">		Properties ps = <span class="keyword">new</span> Properties();</span><br><span class="line">		ps.load(is);</span><br><span class="line">		String user = ps.getProperty(<span class="string">"user"</span>);</span><br><span class="line">		String password = ps.getProperty(<span class="string">"password"</span>);</span><br><span class="line">		String driverClass = ps.getProperty(<span class="string">"driverClass"</span>);</span><br><span class="line">		String url = ps.getProperty(<span class="string">"url"</span>);</span><br><span class="line">		is.close();</span><br><span class="line">		</span><br><span class="line"><span class="comment">//		创建Driver对象</span></span><br><span class="line">		Class clazz = Class.forName(driverClass);</span><br><span class="line">		Object obj = clazz.newInstance();</span><br><span class="line">		Driver driver = (Driver) obj;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//注册驱动</span></span><br><span class="line">		DriverManager.registerDriver(driver);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//数据库的连接</span></span><br><span class="line">		Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">		</span><br><span class="line">		System.out.println(connection);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>数据库连接</tag>
      </tags>
  </entry>
  <entry>
    <title>jdbc(五)普通增删改查、通用增删改查</title>
    <url>/2020/03/10/jdbc(%E4%BA%94)%E6%99%AE%E9%80%9A%E5%A2%9E%E5%88%A0%E6%94%B9%E3%80%81%E9%80%9A%E7%94%A8%E5%A2%9E%E5%88%A0%E6%94%B9/</url>
    <content><![CDATA[<h3 id="普通的增删查改"><a href="#普通的增删查改" class="headerlink" title="普通的增删查改"></a>普通的增删查改</h3><h4 id="创建一个类customer"><a href="#创建一个类customer" class="headerlink" title="创建一个类customer"></a>创建一个类customer</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String email;</span><br><span class="line">	<span class="keyword">private</span> Date birth;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(<span class="keyword">int</span> id, String name, String email, Date birth)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">		<span class="keyword">this</span>.email = email;</span><br><span class="line">		<span class="keyword">this</span>.birth = birth;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建jdbc连接，并封装为方法"><a href="#创建jdbc连接，并封装为方法" class="headerlink" title="创建jdbc连接，并封装为方法"></a><strong>创建jdbc连接，并封装为方法</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*	 * 获取数据库的连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 数据库的连接</span></span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			is = JDBCUtils.class.getClassLoader().getResourceAsStream("sqlDriver.properties");</span><br><span class="line">			Properties ps = <span class="keyword">new</span> Properties();</span><br><span class="line">			ps.load(is);</span><br><span class="line">			String user = ps.getProperty(<span class="string">"user"</span>);</span><br><span class="line">			String password = ps.getProperty(<span class="string">"password"</span>);</span><br><span class="line">			String driverClass = ps.getProperty(<span class="string">"driverClass"</span>);</span><br><span class="line">			String url = ps.getProperty(<span class="string">"url"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 创建Driver对象</span></span><br><span class="line">			Class clazz = Class.forName(driverClass);</span><br><span class="line">			Object obj = clazz.newInstance();</span><br><span class="line">			Driver driver = (Driver) obj;</span><br><span class="line">			<span class="comment">// 注册驱动</span></span><br><span class="line">			DriverManager.registerDriver(driver);</span><br><span class="line">			connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					is.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> connection;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在操作完成后要进行连接的关闭"><a href="#在操作完成后要进行连接的关闭" class="headerlink" title="在操作完成后要进行连接的关闭"></a><strong>在操作完成后要进行连接的关闭</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			connection.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ps.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps, ResultSet rs)</span> </span>&#123;</span><br><span class="line">	close(connection,ps);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(rs != <span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			rs.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="增删查改操作"><a href="#增删查改操作" class="headerlink" title="增删查改操作"></a><strong>增删查改操作</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 对数据库的  增 ，删，改，查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRUDTest</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 从数据库中查找一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> </span><br><span class="line">		Customer customer = getCustomerById();</span><br><span class="line">		System.out.println(customer);</span><br><span class="line">		</span><br><span class="line">		List&lt;Customer&gt; customers = getCustomers();</span><br><span class="line">		<span class="keyword">for</span> (Customer customer2 : customers) &#123;</span><br><span class="line">			System.out.println(customer2);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 查询多条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Customer&gt; <span class="title">getCustomers</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"select * from customers"</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 2.预编译  -- 如果没有占位符可以不填充数据</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery(); <span class="comment">// 查找的结果都已经放到ResultSet中了</span></span><br><span class="line"> </span><br><span class="line">		List&lt;Customer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">while</span>(rs.next())&#123;</span><br><span class="line">			<span class="comment">//获取数据</span></span><br><span class="line">			<span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">			String name = rs.getString(<span class="string">"name"</span>);</span><br><span class="line">			String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">			Date birth = rs.getDate(<span class="string">"birth"</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//将每条数据放入集合中</span></span><br><span class="line">			list.add(<span class="keyword">new</span> Customer(id, name, email, birth));</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 6.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 查询一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Customer <span class="title">getCustomerById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"select * from customers where id = ?"</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		ps.setInt(<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery(); <span class="comment">// 查找的结果都已经放到ResultSet中了</span></span><br><span class="line"> </span><br><span class="line">		Customer customer = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 5.取数据</span></span><br><span class="line">		<span class="keyword">if</span> (rs.next()) &#123; <span class="comment">// 如果有数据就返回true,否则返回false</span></span><br><span class="line">			<span class="comment">// 获取列上值的第一种方式</span></span><br><span class="line">			<span class="comment">// int id = rs.getInt(1); //根据列的索引获取对应的列上的值</span></span><br><span class="line">			<span class="comment">// String name = rs.getString(2);</span></span><br><span class="line">			<span class="comment">// String email = rs.getString(3);</span></span><br><span class="line">			<span class="comment">// Date date = rs.getDate(4);</span></span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 获取列上值的第二种方式</span></span><br><span class="line">			<span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">			String name = rs.getString(<span class="string">"name"</span>);</span><br><span class="line">			String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">			Date birth = rs.getDate(<span class="string">"birth"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 考虑将数据进行封装</span></span><br><span class="line">			customer = <span class="keyword">new</span> Customer(id, name, email, birth);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 输出获取到的内容</span></span><br><span class="line">			System.out.println(id + <span class="string">" "</span> + name + <span class="string">" "</span> + email + <span class="string">" "</span> + birth);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 6.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		<span class="keyword">return</span> customer;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 向数据库中插入一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 1 ： 连接数据库</span></span><br><span class="line">			connection = JDBCUtils.getConnection();</span><br><span class="line">			<span class="comment">// sql语句</span></span><br><span class="line">			String sql = <span class="string">"INSERT INTO customers(NAME,email,birth) "</span> + <span class="string">"VALUES(?,?,?);"</span>;</span><br><span class="line">			<span class="comment">// 2.预编译</span></span><br><span class="line">			ps = connection.prepareStatement(sql);</span><br><span class="line">			<span class="comment">// 3.设置内容</span></span><br><span class="line">			ps.setString(<span class="number">1</span>, <span class="string">"强哥"</span>); <span class="comment">// 第一个参数：第几个问号 第二个参数：内容</span></span><br><span class="line">			ps.setString(<span class="number">2</span>, <span class="string">"qiangge@qq.com"</span>);</span><br><span class="line">			<span class="comment">// 获取一个sql下的Date</span></span><br><span class="line">			Date date = <span class="keyword">new</span> Date(<span class="keyword">new</span> java.util.Date().getTime());</span><br><span class="line">			ps.setDate(<span class="number">3</span>, date);</span><br><span class="line">			<span class="comment">// 4.执行sql语句</span></span><br><span class="line">			ps.execute(); <span class="comment">// 如果是查询语句返回true</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 5.关闭资源</span></span><br><span class="line">			JDBCUtils.close(connection, ps);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 删除一条件数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1. 获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"DELETE FROM customers WHERE id = ?"</span>;</span><br><span class="line">		<span class="comment">// 2. 预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		ps.setInt(<span class="number">1</span>, <span class="number">19</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		<span class="keyword">int</span> executeUpdate = ps.executeUpdate();</span><br><span class="line">		System.out.println(executeUpdate + <span class="string">"条受到影响"</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 5.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 修改一条件数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> </span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">			String sql = <span class="string">"UPDATE customers SET NAME = ? WHERE id = ?"</span>;</span><br><span class="line">			ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">			ps.setString(<span class="number">1</span>, <span class="string">"成哥"</span>);</span><br><span class="line">			ps.setInt(<span class="number">2</span>, <span class="number">18</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">int</span> executeUpdate = ps.executeUpdate();</span><br><span class="line">			System.out.println(executeUpdate + <span class="string">"条数据受到影响"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			JDBCUtils.close(connection, ps);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通用增删查改"><a href="#通用增删查改" class="headerlink" title="通用增删查改"></a><strong>通用增删查改</strong></h3><h4 id="创建类-User-java"><a href="#创建类-User-java" class="headerlink" title="创建类 User.java"></a><strong>创建类 User.java</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String address;</span><br><span class="line">	<span class="keyword">private</span> String phone;</span><br></pre></td></tr></table></figure>

<p><strong>创建通用连接方案 - 通用增删改</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 通用的增删改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">UID</span><span class="params">(String sql,Object ...objects)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 1. 获取数据库的连接</span></span><br><span class="line">	Connection connection = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 2. 预编译</span></span><br><span class="line">	PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 4.执行sql语句</span></span><br><span class="line">	<span class="keyword">int</span> executeUpdate = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		connection = JDBCUtils.getConnection();</span><br><span class="line">		ps = connection.prepareStatement(sql);</span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objects.length; i++) &#123; <span class="comment">// i 表示索引</span></span><br><span class="line">			ps.setObject(i + <span class="number">1</span>, objects[i]); <span class="comment">// i + 1表示的是第几个占位符</span></span><br><span class="line">		&#125;</span><br><span class="line">		executeUpdate = ps.executeUpdate();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">		<span class="comment">// 5.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> executeUpdate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试代码："><a href="#测试代码：" class="headerlink" title="测试代码："></a><strong>测试代码：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 测试通用的增删改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span></span>&#123;</span><br><span class="line">	String sql = <span class="string">"INSERT INTO customers(NAME,email,birth) VALUES(?,?,?)"</span>;</span><br><span class="line">	Date date = <span class="keyword">new</span> java.sql.Date(<span class="keyword">new</span> java.util.Date().getTime());</span><br><span class="line">	<span class="keyword">int</span> uid = JDBCUtils.UID(sql, <span class="string">"强哥"</span>,<span class="string">"qiangge@qq.com"</span>,date);</span><br><span class="line">	System.out.println(uid + <span class="string">"条数据受到影响"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通用查找（一条或多条）"><a href="#通用查找（一条或多条）" class="headerlink" title="通用查找（一条或多条）"></a><strong>通用查找（一条或多条）</strong></h4><h5 id="只查一条数据："><a href="#只查一条数据：" class="headerlink" title="只查一条数据："></a><strong>只查一条数据：</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 通用的查找 （只有一条数据）</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * Class&lt;T&gt; clazz : 运行时类的对象</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getObject</span><span class="params">(Class&lt;T&gt; clazz,String sql,Object ...objects)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3.填充数据</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">			ps.setObject(i + <span class="number">1</span>, objects[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery();</span><br><span class="line">		</span><br><span class="line">		ResultSetMetaData md = rs.getMetaData(); <span class="comment">//获取元数据。</span></span><br><span class="line">		<span class="comment">//获取列的数量</span></span><br><span class="line">		<span class="keyword">int</span> columnCount = md.getColumnCount();</span><br><span class="line">		<span class="comment">//创建对象</span></span><br><span class="line">		T t = clazz.newInstance();</span><br><span class="line">		<span class="keyword">while</span>(rs.next())&#123; <span class="comment">//遍历每一条数据</span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * 第一个问题 ： 如何获取到表的列数</span></span><br><span class="line"><span class="comment">			 * 第二个问题 ： 需要知道类中的属性</span></span><br><span class="line"><span class="comment">			 * 第三个问题 ： 对象中属性的名字怎么来</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">				<span class="comment">//获取某列的列名（如果有别名获取的是别名）</span></span><br><span class="line">				String columnLabel = md.getColumnLabel(i + <span class="number">1</span>); </span><br><span class="line">				 <span class="comment">//通过列名获取列中的数据。</span></span><br><span class="line">				Object value = rs.getObject(columnLabel);</span><br><span class="line"> </span><br><span class="line">				<span class="comment">//封装</span></span><br><span class="line">				<span class="comment">//通过反射 - 给对象中的属性进行赋值</span></span><br><span class="line">				<span class="comment">//将表中的列名当作类中的属性名。如果列名和属性名不一样，可以通过别名的方式（别名 = 属性名）</span></span><br><span class="line">				<span class="comment">//通过列名就获取到了类中的对应的属性</span></span><br><span class="line">				Field declaredField = clazz.getDeclaredField(columnLabel);</span><br><span class="line">				declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * 第一个参数 ： 是给哪个对象进行赋值</span></span><br><span class="line"><span class="comment">				 * 第二个参数 ： 属性值</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				declaredField.set(t, value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> t;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查多条数据："><a href="#查多条数据：" class="headerlink" title="查多条数据："></a><strong>查多条数据：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 通用的查找 （返回多条数据）</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getObjects</span><span class="params">(Class&lt;T&gt; clazz,String sql,Object ...objects)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3.填充数据</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">			ps.setObject(i + <span class="number">1</span>, objects[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery();</span><br><span class="line">		</span><br><span class="line">		ResultSetMetaData md = rs.getMetaData(); <span class="comment">//获取元数据。</span></span><br><span class="line">		<span class="comment">//获取列的数量</span></span><br><span class="line">		<span class="keyword">int</span> columnCount = md.getColumnCount();</span><br><span class="line">		<span class="comment">//创建一个集合</span></span><br><span class="line">		List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span>(rs.next())&#123; <span class="comment">//遍历每一条数据</span></span><br><span class="line">			<span class="comment">//创建对象</span></span><br><span class="line">			T t = clazz.newInstance();</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * 第一个问题 ： 如何获取到表的列数</span></span><br><span class="line"><span class="comment">			 * 第二个问题 ： 需要知道类中的属性</span></span><br><span class="line"><span class="comment">			 * 第三个问题 ： 对象中属性的名字怎么来</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">				<span class="comment">//获取某列的列名（如果有别名获取的是别名）</span></span><br><span class="line">				String columnLabel = md.getColumnLabel(i + <span class="number">1</span>); </span><br><span class="line">				 <span class="comment">//通过列名获取列中的数据。</span></span><br><span class="line">				Object value = rs.getObject(columnLabel);</span><br><span class="line"> </span><br><span class="line">				<span class="comment">//封装</span></span><br><span class="line">				<span class="comment">//通过反射 - 给对象中的属性进行赋值</span></span><br><span class="line">				<span class="comment">//将表中的列名当作类中的属性名。如果列名和属性名不一样，可以通过别名的方式（别名 = 属性名）</span></span><br><span class="line">				<span class="comment">//通过列名就获取到了类中的对应的属性</span></span><br><span class="line">				Field declaredField = clazz.getDeclaredField(columnLabel);</span><br><span class="line">				declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * 第一个参数 ： 是给哪个对象进行赋值</span></span><br><span class="line"><span class="comment">				 * 第二个参数 ： 属性值</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				declaredField.set(t, value);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//将对象放入到集合中</span></span><br><span class="line">			list.add(t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试代码：-1"><a href="#测试代码：-1" class="headerlink" title="测试代码："></a><strong>测试代码：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">       String sql = <span class="string">"select id,name,email,birth from customers where id = ?"</span>;</span><br><span class="line">Customer customer = getObject(Customer<span class="class">.<span class="keyword">class</span>, <span class="title">sql</span>, 5)</span>;</span><br><span class="line">System.out.println(customer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sql = <span class="string">"select * from users where id = ?"</span>;</span><br><span class="line">User object = getObject(User<span class="class">.<span class="keyword">class</span>, <span class="title">sql</span>, 1)</span>;</span><br><span class="line">System.out.println(object);</span><br><span class="line"></span><br><span class="line">sql = <span class="string">"select * from users"</span>;</span><br><span class="line">List&lt;User&gt; users = getObjects(User<span class="class">.<span class="keyword">class</span>, <span class="title">sql</span>)</span>;</span><br><span class="line"><span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">	System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>jdbc增删改查</tag>
      </tags>
  </entry>
  <entry>
    <title>jdbc(三)预编译-Statement、PreparedStatement</title>
    <url>/2020/03/10/jdbc(%E4%B8%89)%E9%A2%84%E7%BC%96%E8%AF%91-Statement%E3%80%81PreparedStatement/</url>
    <content><![CDATA[<h2 id="预编译：statement-与-PreparedStatement"><a href="#预编译：statement-与-PreparedStatement" class="headerlink" title="预编译：statement 与 PreparedStatement"></a>预编译：statement 与 PreparedStatement</h2><h3 id="sql提供访问的接口："><a href="#sql提供访问的接口：" class="headerlink" title="sql提供访问的接口："></a><strong>sql提供访问的接口：</strong></h3><ul>
<li>数据库连接被用于向数据库服务器发送命令和 SQL 语句，在连接建立后，需要对数据库进行访问，执行 sql 语句</li>
<li>在 java.sql 包中有 3 个接口分别定义了对数据库的调用的不同方式：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">|-----   Statement</span><br><span class="line"> </span><br><span class="line">       |------PreparedStatement</span><br><span class="line"> </span><br><span class="line">              |------CallableStatement</span><br></pre></td></tr></table></figure>

<p>使用<span style="color:red;">statement</span>进行预编译可能会导致SQL注入的发生 </p>
<img src="http://photo.wushaopei.com/qiniu92.png" width="60%">

<h3 id="SQL-注入攻击"><a href="#SQL-注入攻击" class="headerlink" title="SQL 注入攻击"></a><strong>SQL 注入攻击</strong></h3><ul>
<li>SQL 注入是利用某些系统没有对用户输入的数据进行充分的检查，而在用户输入数据中注入非法的 SQL 语句段或命令(如：SELECT user, password FROM user_table WHERE user=’a’ OR 1 = ‘ AND password = ‘ OR ‘1’ = ‘1’) ，从而利用系统的 SQL 引擎完成恶意行为的做法</li>
<li>对于 Java 而言，要防范 SQL 注入，只要用 PreparedStatement(从Statement扩展而来) 取代 Statement 就可以了</li>
</ul>
<h3 id="PreparedStatement"><a href="#PreparedStatement" class="headerlink" title="PreparedStatement"></a><strong>PreparedStatement</strong></h3><ul>
<li>可以通过调用 Connection 对象的 preparedStatement() 方法获取 PreparedStatement 对象</li>
<li>PreparedStatement 接口是 Statement 的子接口，它表示一条预编译过的 SQL 语句</li>
<li>PreparedStatement 对象所代表的 SQL 语句中的参数用问号(?)来表示，调用 PreparedStatement 对象的 setXxx() 方法来设置这些参数. setXxx() 方法有两个参数，第一个参数是要设置的 SQL 语句中的参数的索引(从 1 开始)，第二个是设置的 SQL 语句中的参数的值</li>
</ul>
<h3 id="PreparedStatement-vs-Statement"><a href="#PreparedStatement-vs-Statement" class="headerlink" title="PreparedStatement vs Statement"></a><strong>PreparedStatement vs Statement</strong></h3><ul>
<li>代码的可读性和可维护性.</li>
<li>PreparedStatement 能最大可能提高性能：</li>
</ul>
<blockquote>
<ol>
<li>DBServer会对预编译语句提供性能优化。因为预编译语句有可能被重复调用，所以语句在被DBServer的编译器编译后的执行代码被缓存下来，那么下次调用时只要是相同的预编译语句就不需要编译，只要将参数直接传入编译过的语句执行代码中就会得到执行。</li>
<li>在statement语句中,即使是相同操作但因为数据内容不一样,所以整个语句本身不能匹配,没有缓存语句的意义.事实是没有数据库会对普通语句编译后的执行代码缓存.这样每执行一次都要对传入的语句编译一次.  </li>
<li>(语法检查，语义检查，翻译成二进制命令，缓存)</li>
</ol>
</blockquote>
<ul>
<li>PreparedStatement 可以防止 SQL 注入防止 SQL 注入 </li>
</ul>
<h3 id="数据类型转换表"><a href="#数据类型转换表" class="headerlink" title="数据类型转换表"></a><strong>数据类型转换表</strong></h3><table>
<thead>
<tr>
<th>java类型</th>
<th>SQL类型</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>BIT</td>
</tr>
<tr>
<td>byte</td>
<td>TINYINT</td>
</tr>
<tr>
<td>short</td>
<td>SMALLINT</td>
</tr>
<tr>
<td>int</td>
<td>INTEGER</td>
</tr>
<tr>
<td>long</td>
<td>BIGINT</td>
</tr>
<tr>
<td>String</td>
<td>CHAR,VARCHAR,LONGVARCHAR</td>
</tr>
<tr>
<td>byte array</td>
<td>BINARY , VAR  BINARY</td>
</tr>
<tr>
<td>java.sql.Date</td>
<td>DATE</td>
</tr>
<tr>
<td>java.sql.Time</td>
<td>TIME</td>
</tr>
<tr>
<td>java.sql.Timestamp</td>
<td>TIMESTAMP</td>
</tr>
</tbody></table>
<h3 id="连接数据库、操作表的步骤："><a href="#连接数据库、操作表的步骤：" class="headerlink" title="连接数据库、操作表的步骤："></a><strong>连接数据库、操作表的步骤：</strong></h3><img src="http://photo.wushaopei.com/qiniu93.png" width="60%">

<p><strong>注意：</strong></p>
<ul>
<li>释放ResultSet, Statement,Connection。</li>
<li>数据库连接（Connection）是非常稀有的资源，用完后必须马上释放，如果Connection不能及时正确的关闭将导致系统宕机。Connection的使用原则是<span style="color:red;">尽量晚创建，尽量早的释放。</span></li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>数据库连接</tag>
      </tags>
  </entry>
  <entry>
    <title>jdbc(一)概述</title>
    <url>/2020/03/10/jdbc(%E4%B8%80)%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h3 id="1、JDBC-的概述"><a href="#1、JDBC-的概述" class="headerlink" title="1、JDBC 的概述"></a>1、JDBC 的概述</h3><p><strong>1.1 jdbc 是什么</strong> </p>
<p><strong>JDBC(Java Database Connectivity)</strong>是一个独立于特定数据库管理系统、通用的SQL数据库存取和操作的公共接口（一组<strong>API</strong>），定义了用来访问数据库的标准<strong>Java</strong>类库，（<strong>java.sql,javax.sql</strong>）使用这个类库可以以一种标准的方法、方便地访问数据库资源</p>
<ul>
<li><strong>JDBC</strong>为访问不同的数据库提供了一种统一的途径，为开发者屏蔽了一些细节问题。</li>
<li><strong>JDBC</strong>的目标是使Java程序员使用<strong>JDBC</strong>可以连接任何提供了<strong>JDBC</strong>驱动程序的数据库系统，这样就使得程序员无需对特定的数据库系统的特点有过多的了解，从而大大简化和加快了开发过程。</li>
</ul>
<p><strong>1.2 jdbc 与 数据库的连接方式：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu89.png" width="60%">

<p><strong>规范化的jdbc</strong> 连接数据库方式： </p>
<img src="http://photo.wushaopei.com/qiniu90.png" width="60%">

<p><strong>1.3 JDBC 体系结构</strong></p>
<p>JDBC接口（API）包括两个层次：</p>
<ul>
<li><strong>面向应用的API</strong>：Java API，抽象接口，供应用程序开发人员使用（连接数据库，执行SQL语句，获得结果）。</li>
<li><strong>面向数据库的API：</strong>Java Driver API，供开发商开发数据库驱动程序用。</li>
</ul>
<p><strong>JDBC是sun公司提供一套用于数据库操作的接口，java程序员只需要面向这套接 口编程即可。</strong>不同的数据库厂商，需要针对这套接口，提供不同实现。不同的实现的集合，即为不同数据库的驱动。这种方式是<strong>面向接口编程</strong>。</p>
<p><strong>1.4 JDBC API</strong></p>
<p><strong>JDBC API</strong> 是一系列的接口，它使得应用程序能够进行数据库联接，执行<strong>SQL</strong>语句，并且得到返回结果。</p>
<img src="http://photo.wushaopei.com/qiniu91.png" width="60%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
  </entry>
  <entry>
    <title>最新idea2020注册码永久激活(激活到2100年)</title>
    <url>/2020/03/10/%E6%9C%80%E6%96%B0idea2020%E6%B3%A8%E5%86%8C%E7%A0%81%E6%B0%B8%E4%B9%85%E6%BF%80%E6%B4%BB-%E6%BF%80%E6%B4%BB%E5%88%B02100%E5%B9%B4/</url>
    <content><![CDATA[<p>这篇文章主要介绍了idea2020注册码永久激活（激活到2100年）,文中给大家提到了2020年最新JetBrains授权服务器-IntelliJ IDEA激活，需要的朋友可以参考下 </p>
<p><strong>2020年最新JetBrains授权服务器-IntelliJ IDEA激活</strong></p>
<p>2020年最近可激活JetBrains授权服务器地址</p>
<p>1：<a href="https://idea.ouyanglol.com/" target="_blank" rel="noopener">https://idea.ouyanglol.com/</a></p>
<p>2：<a href="http://101.132.235.155:1017/" target="_blank" rel="noopener">http://101.132.235.155:1017/</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>激活码</category>
      </categories>
      <tags>
        <tag>IDEA</tag>
      </tags>
  </entry>
  <entry>
    <title>Java对象的值传递问题：传值还是传引用？</title>
    <url>/2020/03/10/Java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%80%BC%E4%BC%A0%E9%80%92%E9%97%AE%E9%A2%98%EF%BC%9A%E4%BC%A0%E5%80%BC%E8%BF%98%E6%98%AF%E4%BC%A0%E5%BC%95%E7%94%A8%EF%BC%9F/</url>
    <content><![CDATA[<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>​    在使用<strong>Java</strong>语言进行开发过程中，涉及到<strong>局部变量</strong>与<strong>方法内部作用域</strong>的<strong>数据交换与解析</strong>的过程，而这一过程，一般都是通过<strong>方法形参</strong>的方式进行<strong>java</strong>对象的传递。</p>
<blockquote>
<p> 这里引出一个问题，<strong>当对象作为参数传递时，究竟传的是对象的值，还是对象的引用呢？–_–</strong></p>
</blockquote>
<p>这是一个保守争议的话题。</p>
<p>​    假设，传的是值，那么函数接收的只是一个<strong>副本</strong>，由于<strong>作用域</strong>的存在，函数对象形参的操作，并不会对实参产生影响；若传的是<strong>引用</strong>，那么此时<strong>对形参</strong>的操作则会影响到实参。</p>
<p>​    在这里引用一句代码来举例分析：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object obj = <span class="keyword">new</span> Object();</span><br></pre></td></tr></table></figure>

<p>这句代码的意思是：创建一个Object对象，并在堆内存开辟一个空间（new），同时创建一个名为obj 的引用，让这个引用指向这个对象，如下图所示：</p>
<img src="http://photo.wushaopei.com/qiniu83.png" width="60%">

<p>在上面我们创建了一个对象以及其引用，下面我们通过例子来从代码层面进行分析。</p>
<h3 id="基本数据类型作为参数传递："><a href="#基本数据类型作为参数传递：" class="headerlink" title="基本数据类型作为参数传递："></a>基本数据类型作为参数传递：</h3><p>例1:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> test.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年3月10日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        System.out.println(<span class="string">"before change, i = "</span>+i);</span><br><span class="line">        change(i);</span><br><span class="line">        System.out.println(<span class="string">"after change, i = "</span>+i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        i = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子中使用基本数据类型的 <strong>int</strong> 作为形参传递，执行结果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before change, i = <span class="number">1</span></span><br><span class="line">after change, i = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>从 int 类型作为形参的例子的执行结果可知，<strong>当基本数据类型（Boolean，byte，char，String，int，Long，float，double）作为参数传递时，传递的是实参值的副本，即传的是值，无论在函数中怎么操作这个副本，实参的值是不会被改变的</strong>。 </p>
<hr>
<h3 id="对象作为参数传递："><a href="#对象作为参数传递：" class="headerlink" title="对象作为参数传递："></a>对象作为参数传递：</h3><p>例2： 我们使用 StringBuffer对象作为参数传递到<strong>change</strong>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">"Hello "</span>);</span><br><span class="line">        System.out.println(<span class="string">"before change, sb is "</span>+sb.toString());</span><br><span class="line">        change(sb);</span><br><span class="line">        System.out.println(<span class="string">"after change, sb is "</span>+sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(StringBuffer stringBuffer)</span></span>&#123;</span><br><span class="line">        stringBuffer.append(<span class="string">"world !"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>程序的<strong>运行结果</strong>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before change, sb is Hello </span><br><span class="line">after change, sb is Hello world !</span><br></pre></td></tr></table></figure>

<p>从输出结果中我们可以发现，sb所指向的对象的值被改变了，那么是否我们可以推论出，在Java中，当对象作为参数传递时，传递的是该对象的引用呢？我们再来看下面这个例子：  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">"Hello "</span>);</span><br><span class="line">        System.out.println(<span class="string">"before change, sb is "</span>+sb.toString());</span><br><span class="line">        change(sb);</span><br><span class="line">        System.out.println(<span class="string">"after change, sb is "</span>+sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(StringBuffer stringBuffer)</span></span>&#123;</span><br><span class="line">        stringBuffer = <span class="keyword">new</span> StringBuffer(<span class="string">"Hi "</span>);</span><br><span class="line">        stringBuffer.append(<span class="string">"world !"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果上面的推论是正确的，即Java中对象作为参数传递，实际传递的是该对象的引用，那么在调用change函数之后，原对象的值应该是会改变的，变为“Hi world ！”，但是，当我们运行程序后，结果却是如下所示：  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before change, sb is Hello </span><br><span class="line">after change, sb is Hello</span><br></pre></td></tr></table></figure>

<p>​    原对象的值并没有被改变，这与上面的推论相矛盾！为什么在Java中，当对象作为参数传递时，有的时候实参被改变了，而有的时候实参并未被改变呢？下面让我们来分析一下其中的原因：  　　从文章的开头我们知道，当执行<strong>StringBuffer sb = new StringBuffer(“Hello “)</strong>时，我们创建了一个指向新建对象“<strong>new StringBuffer(“Hello “)”</strong>的引用“<strong>sb</strong>”，如下图所示：  </p>
<img src="http://photo.wushaopei.com/qiniu84.png" width="60%">

<p>在例2中，当我们调用change函数后，实际上，形参stringBuffer也指向了实参sb所指向的对象，即： </p>
<img src="http://photo.wushaopei.com/qiniu85.png" width="60%">

<p>那么当我们执行<strong>stringBuffer.append(“world !”)</strong>后，便通过对象的引用“stringBuffer”修改了对象的值，使之变成了<strong>“Hello world ！”</strong>，即：  </p>
<img src="http://photo.wushaopei.com/qiniu86.png" width="60%">

<p>但是，在例3中的change函数中，我们又新建了一个对象<strong>“new StringBuffer(“Hi  “)”</strong>（这实际上在内存中开辟了一块在原对象地址之外的新区域），这让形参stringBuffer实际指向了这个新建的对象，并将新对象的值设置为<strong>“Hi world ！”</strong>，例三中stringBuffer的值已经被改变为了Hi  world，但是因为值没有被<strong>return</strong>返回赋值给sb对象，所以sb对象并没有被改变，所以输出的任然是hello，即： </p>
<img src="http://photo.wushaopei.com/qiniu87.png" width="60%">

<p>那么我们就不难理解，为何在执行完change函数之后，实参的值仍为“Hello”了。 </p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>　　<strong>综上所述，我们可以得出结论：在Java中，当对象作为参数传递时，实际上传递的是一份“引用的拷贝”。 （实际传递的是对象的引用）</strong></p>
<p><strong>转载自：<a href="https://blog.csdn.net/xiangwanpeng/article/details/52454479" target="_blank" rel="noopener">https://blog.csdn.net/xiangwanpeng/article/details/52454479</a></strong></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JavaSE</category>
      </categories>
      <tags>
        <tag>值传递</tag>
        <tag>引用</tag>
        <tag>值</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络（二）当你在浏览器地址栏输入一个URL后回车，将会发生的事情？</title>
    <url>/2020/03/09/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89-%E5%BD%93%E4%BD%A0%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9C%B0%E5%9D%80%E6%A0%8F%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAURL%E5%90%8E%E5%9B%9E%E8%BD%A6%EF%BC%8C%E5%B0%86%E4%BC%9A%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85%EF%BC%9F/</url>
    <content><![CDATA[<p>​    当我们在浏览器的地址栏输入<a href="https://www.cnblogs.com/，然后回车，回车到看到页面到底发生了什么呢？" target="_blank" rel="noopener">https://www.cnblogs.com/，然后回车，回车到看到页面到底发生了什么呢？</a></p>
<p>​    <strong>域名解析 –&gt; 发起TCP的3次握手 –&gt; 建立TCP连接后发起http请求 –&gt;  服务器响应http请求，浏览器得到html代码 –&gt; 浏览器解析html代码，并请求html代码中的资源（如js、css、图片等）  –&gt; 浏览器对页面进行渲染呈现给用户</strong></p>
<h2 id="一、域名解析"><a href="#一、域名解析" class="headerlink" title="一、域名解析"></a>一、域名解析</h2><p>​    首先Chrome浏览器会解析<a href="https://www.cnblogs.com/这个域名对应的IP地址。怎么解析到对应的IP地址？" target="_blank" rel="noopener">https://www.cnblogs.com/这个域名对应的IP地址。怎么解析到对应的IP地址？</a></p>
<ol>
<li><p>Chrome浏览器会首先搜索浏览器的DNS缓存（缓存时间比较短，TTL默认是1000，且只能容纳1000条缓存），看自身的缓存中是否有<a href="https://www.cnblogs.com/对应的条目，而且没有过期，如果有且没有过期则解析到此结束。" target="_blank" rel="noopener">https://www.cnblogs.com/对应的条目，而且没有过期，如果有且没有过期则解析到此结束。</a></p>
<p>注：我们怎么查看浏览器的DNS缓存？可以使用 chrome://net-internals/#dns 来进行查看</p>
</li>
<li><p>如果浏览器自身的缓存里面没有找到对应的条目，那么Chrome会搜索操作系统的DNS缓存,如果找到且没有过期则停止搜索解析到此结束。</p>
<p>注：怎么查看操作系统的DNS缓存，以Windows系统为例，可以在命令行下使用 ipconfig /displaydns 来进行查看</p>
</li>
<li><p>如果在Windows系统的DNS缓存也没有找到，那么尝试读取hosts文件（位于C:\Windows\System32\drivers\etc），看看这里面有没有该域名对应的IP地址，如果有则解析成功。</p>
</li>
<li><p>如果在hosts文件中也没有找到对应的条目，浏览器就会发起一个DNS的系统调用，就会向本地配置的首选DNS服务器（一般是电信运营商提供的，也可以使用像Google提供的DNS服务器）发起域名解析请求（通过的是UDP协议向DNS的53端口发起请求，这个请求是<strong>递归的请求</strong>，也就是运营商的DNS服务器必须得提供给我们该域名的IP地址），运营商的DNS服务器首先查找自身的缓存，找到对应的条目，且没有过期，则解析成功。如果没有找到对应的条目，则有运营商的DNS代我们的浏览器发起<strong>迭代DNS解析请求</strong>，它首先是会找根域的DNS的IP地址（这个DNS服务器都内置13台根域的DNS的IP地址），找打根域的DNS地址，就会向其发起请求（请问<a href="https://www.cnblogs.com/这个域名的IP地址是多少啊？），根域发现这是一个顶级域com域的一个域名，于是就告诉运营商的DNS我不知道这个域名的IP地址，但是我知道com域的IP地址，你去找它去，于是运营商的DNS就得到了com域的IP地址，又向com域的IP地址发起了请求（请问https://www.cnblogs.com/这个域名的IP地址是多少?）,com域这台服务器告诉运营商的DNS我不知道https://www.cnblogs.com/这个域名的IP地址，但是我知道https://www.cnblogs.com/这个域的DNS地址，你去找它去，于是运营商的DNS又向https://www.cnblogs.com/这个域名的DNS地址（这个一般就是由域名注册商提供的，像万网，新网等）发起请求（请问https://www.cnblogs.com/这个域名的IP地址是多少？），这个时候cnblogs.com域的DNS服务器一查，果真在我这里，于是就把找到的结果发送给运营商的DNS服务器，这个时候运营商的DNS服务器就拿到了https://www.cnblogs.com/这个域名对应的IP地址，并返回给Windows系统内核，内核又把结果返回给浏览器，终于浏览器拿到了https://www.cnblogs.com/对应的IP地址，该进行一步的动作了。" target="_blank" rel="noopener">https://www.cnblogs.com/这个域名的IP地址是多少啊？），根域发现这是一个顶级域com域的一个域名，于是就告诉运营商的DNS我不知道这个域名的IP地址，但是我知道com域的IP地址，你去找它去，于是运营商的DNS就得到了com域的IP地址，又向com域的IP地址发起了请求（请问https://www.cnblogs.com/这个域名的IP地址是多少?）,com域这台服务器告诉运营商的DNS我不知道https://www.cnblogs.com/这个域名的IP地址，但是我知道https://www.cnblogs.com/这个域的DNS地址，你去找它去，于是运营商的DNS又向https://www.cnblogs.com/这个域名的DNS地址（这个一般就是由域名注册商提供的，像万网，新网等）发起请求（请问https://www.cnblogs.com/这个域名的IP地址是多少？），这个时候cnblogs.com域的DNS服务器一查，果真在我这里，于是就把找到的结果发送给运营商的DNS服务器，这个时候运营商的DNS服务器就拿到了https://www.cnblogs.com/这个域名对应的IP地址，并返回给Windows系统内核，内核又把结果返回给浏览器，终于浏览器拿到了https://www.cnblogs.com/对应的IP地址，该进行一步的动作了。</a> </p>
<p>DNS递归解析图如下所示： </p>
</li>
</ol>
<img src="http://photo.wushaopei.com/qiniu96.png" width="60%">

<p>​    DNS迭代解析图如下所示： </p>
<img src="http://photo.wushaopei.com/qiniu97.png" width="60%">

<p>注：一般情况下是不会进行以下步骤的，如果经过以上的4个步骤，还没有解析成功，那么会进行如下步骤：</p>
<ol>
<li>操作系统就会查找NetBIOS name  Cache（NetBIOS名称缓存，就存在客户端电脑中的），那这个缓存有什么东西呢？凡是最近一段时间内和我成功通讯的计算机的计算机名和Ip地址，就都会存在这个缓存里面。什么情况下该步能解析成功呢？就是该名称正好是几分钟前和我成功通信过，那么这一步就可以成功解析。</li>
<li>如果第5步也没有成功，那会查询WINS 服务器（是NETBIOS名称和IP地址对应的服务器）</li>
<li>如果第6步也没有查询成功，那么客户端就要进行广播查找</li>
<li>如果第7步也没有成功，那么客户端就读取LMHOSTS文件（和HOSTS文件同一个目录下，写法也一样）</li>
</ol>
<p>如果第八步还没有解析成功，那么这次解析失败，那就无法跟目标计算机进行通信。只要这八步中有一步可以解析成功，那就可以成功和目标计算机进行通信。</p>
<h2 id="二、发起TCP的3次握手"><a href="#二、发起TCP的3次握手" class="headerlink" title="二、发起TCP的3次握手"></a>二、发起TCP的3次握手</h2><p>拿到域名对应的IP地址之后，User-Agent（一般是指浏览器）会以一个随机端口（1024 &lt; 端口 &lt;  65535）向服务器的WEB程序（常用的有tomcat,nginx等）80端口发起TCP的连接请求。这个连接请求（原始的http请求经过TCP/IP4层模型的层层封包）到达服务器端后（这中间通过各种路由设备，局域网内除外），进入到网卡，然后是进入到内核的TCP/IP协议栈（用于识别该连接请求，解封包，一层一层的剥开），还有可能要经过Netfilter防火墙（属于内核的模块）的过滤，最终到达WEB程序，最终建立了TCP/IP的连接。如下图：</p>
<img src="http://photo.wushaopei.com/qiniu98.png" width="60%">

<p>注：<a href="http://www.cnblogs.com/wupeixuan/p/8639469.html" target="_blank" rel="noopener">TCP三次握手详解</a> </p>
<h2 id="三、建立TCP连接后发起http请求"><a href="#三、建立TCP连接后发起http请求" class="headerlink" title="三、建立TCP连接后发起http请求"></a>三、建立TCP连接后发起http请求</h2><p>​    HTTP请求报文的方法是get方式，如果浏览器存储了该域名下的Cookies，那么会把Cookies放入HTTP请求头里发给服务器。</p>
<p>下面是Chrome发起的http请求报文头部信息:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: www.cnblogs.com</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">62.0</span><span class="number">.3202</span><span class="number">.75</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,image/apng,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Referer: http://www.cnblogs.com/wupeixuan/</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br></pre></td></tr></table></figure>

<h2 id="四、服务器端响应http请求，浏览器得到html代码"><a href="#四、服务器端响应http请求，浏览器得到html代码" class="headerlink" title="四、服务器端响应http请求，浏览器得到html代码"></a>四、服务器端响应http请求，浏览器得到html代码</h2><p>​    服务器端WEB程序接收到http请求以后，就开始处理该请求，处理之后就返回给浏览器html文件。</p>
<p>用Chrome浏览器看到的响应头信息：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Date: Sun, <span class="number">08</span> Apr <span class="number">2018</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">00</span> GMT</span><br><span class="line">Content-Type: text/html; charset=utf-<span class="number">8</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Cache-Control: <span class="keyword">public</span>, max-age=<span class="number">29</span></span><br><span class="line">Expires: Sun, <span class="number">08</span> Apr <span class="number">2018</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">29</span> GMT</span><br><span class="line">Last-Modified: Sun, <span class="number">08</span> Apr <span class="number">2018</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">59</span> GMT</span><br><span class="line">X-UA-Compatible: IE=<span class="number">10</span></span><br><span class="line">Content-Encoding: gzip</span><br></pre></td></tr></table></figure>

<h2 id="五、浏览器解析html代码，并请求html代码中的资源"><a href="#五、浏览器解析html代码，并请求html代码中的资源" class="headerlink" title="五、浏览器解析html代码，并请求html代码中的资源"></a>五、浏览器解析html代码，并请求html代码中的资源</h2><p>​    浏览器拿到index.html文件后，就开始解析其中的html代码，遇到js/css/image等静态资源时，就向服务器端去请求下载（会使用多线程下载，每个浏览器的线程数不一样），这个时候就用上keep-alive特性了，建立一次HTTP连接，可以请求多个资源，下载资源的顺序就是按照代码里的顺序，但是由于每个资源大小不一样，而浏览器又多线程请求请求资源，所以从下图看出，这里显示的顺序并不一定是代码里面的顺序。</p>
<p>​    浏览器在请求静态资源时（在未过期的情况下），向服务器端发起一个http请求（询问自从上一次修改时间到现在有没有对资源进行修改），如果服务器端返回304状态码（告诉浏览器服务器端没有修改），那么浏览器会直接读取本地的该资源的缓存文件。</p>
<img src="http://photo.wushaopei.com/qiniu99.png" width="60%">

<h2 id="六、浏览器对页面进行渲染呈现给用户"><a href="#六、浏览器对页面进行渲染呈现给用户" class="headerlink" title="六、浏览器对页面进行渲染呈现给用户"></a>六、浏览器对页面进行渲染呈现给用户</h2><p>最后，Chrome浏览器利用自己内部的工作机制，把请求到的静态资源和html代码进行渲染，渲染之后呈现给用户。</p>
<p><strong>注：</strong> <strong>本文转载自</strong> <a href="https://www.cnblogs.com/wupeixuan/p/8747918.html" target="_blank" rel="noopener">https://www.cnblogs.com/wupeixuan/p/8747918.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity（四）流程设计工具创建流程图</title>
    <url>/2020/03/09/Activity-%EF%BC%88%E5%9B%9B%EF%BC%89%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1%E5%B7%A5%E5%85%B7%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%9B%BE/</url>
    <content><![CDATA[<h3 id="1、引言"><a href="#1、引言" class="headerlink" title="1、引言"></a>1、引言</h3><p>在前面我们知道了怎么创建流程控制引擎，而<strong>Activiti</strong> 的正常使用还需要进行部署流程，而这就有一个很重要的前提。那就是创建相应的流程图，并让其能被 <strong>service</strong> 所调用从而实现流程的执行。</p>
<h3 id="2、流程图创建工具"><a href="#2、流程图创建工具" class="headerlink" title="2、流程图创建工具"></a>2、流程图创建工具</h3><h4 id="2-1-简述第一种创建方式"><a href="#2-1-简述第一种创建方式" class="headerlink" title="2.1 简述第一种创建方式"></a>2.1 简述第一种创建方式</h4><p><code>在这里说明一点，流程图的创建可以使用两种方式，第一种是XML版本的，案例如下：</code></p>
<img src="http://photo.wushaopei.com/qiniu64.png" width="60%">

<p>我们看到的是一个<a href="https://www.activiti.org/5.x/userguide/#bpmnNoneStartEvent" target="_blank" rel="noopener">无开始事件</a>（左侧的圆圈），后面是两个<a href="https://www.activiti.org/5.x/userguide/#bpmnUserTask" target="_blank" rel="noopener">用户任务</a>：<em>“写每月财务报告”</em>和 <em>“验证每月财务报告”</em>，以一个<a href="https://www.activiti.org/5.x/userguide/#bpmnNoneEndEvent" target="_blank" rel="noopener">无结束事件</a>（右侧带有粗边框的圆圈）结束。 </p>
<ul>
<li>在这里，<strong>start task</strong> 告诉我们什么<em>入口点</em>的过程。</li>
<li>在 <strong>user task</strong> 声明是我们的过程的人工任务的表示。请注意，第一个任务分配给<em>会计</em>组，而第二个任务分配给<em>管理</em>组。有关如何将用户和组分配给用户任务的更多信息，请参见<a href="https://www.activiti.org/5.x/userguide/#bpmnUserTaskAssignment" target="_blank" rel="noopener">用户任务分配部分</a>。</li>
<li>当到达 <strong>end task</strong> 时，该过程结束。</li>
<li>这些元素通过<a href="https://www.activiti.org/5.x/userguide/#bpmnSequenceFlow" target="_blank" rel="noopener">顺序流</a>相互连接。这些顺序流具有<code>source</code>和<code>target</code>，用于定义顺序流的<em>方向</em>。</li>
</ul>
<p>其对应的xml 版本的配置如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;definitions</span> <span class="string">id="definitions"</span></span><br><span class="line">  <span class="attr">targetNamespace</span>=<span class="string">"http://activiti.org/bpmn20"</span></span><br><span class="line">  <span class="attr">xmlns</span>:<span class="string">activiti="http://activiti.org/bpmn"</span></span><br><span class="line">  <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">&lt;process</span> <span class="string">id="financialReport" name="Monthly financial report reminder process"&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;startEvent</span> <span class="string">id="theStart" /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;sequenceFlow</span> <span class="string">id='flow1' sourceRef='theStart' targetRef='writeReportTask' /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;userTask</span> <span class="string">id="writeReportTask" name="Write monthly financial report" &gt;</span></span><br><span class="line">	    <span class="attr">&lt;documentation&gt;</span></span><br><span class="line">	      <span class="attr">Write</span> <span class="string">monthly financial report for publication to shareholders.</span></span><br><span class="line">	    <span class="attr">&lt;/documentation&gt;</span></span><br><span class="line">	    <span class="attr">&lt;potentialOwner&gt;</span></span><br><span class="line">	      <span class="attr">&lt;resourceAssignmentExpression&gt;</span></span><br><span class="line">	        <span class="attr">&lt;formalExpression&gt;accountancy&lt;/formalExpression&gt;</span></span><br><span class="line">	      <span class="attr">&lt;/resourceAssignmentExpression&gt;</span></span><br><span class="line">	    <span class="attr">&lt;/potentialOwner&gt;</span></span><br><span class="line">	  <span class="attr">&lt;/userTask&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;sequenceFlow</span> <span class="string">id='flow2' sourceRef='writeReportTask' targetRef='verifyReportTask' /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;userTask</span> <span class="string">id="verifyReportTask" name="Verify monthly financial report" &gt;</span></span><br><span class="line">	    <span class="attr">&lt;documentation&gt;</span></span><br><span class="line">	      <span class="attr">Verify</span> <span class="string">monthly financial report composed by the accountancy department.</span></span><br><span class="line">	      <span class="attr">This</span> <span class="string">financial report is going to be sent to all the company shareholders.</span></span><br><span class="line">	    <span class="attr">&lt;/documentation&gt;</span></span><br><span class="line">	    <span class="attr">&lt;potentialOwner&gt;</span></span><br><span class="line">	      <span class="attr">&lt;resourceAssignmentExpression&gt;</span></span><br><span class="line">	        <span class="attr">&lt;formalExpression&gt;management&lt;/formalExpression&gt;</span></span><br><span class="line">	      <span class="attr">&lt;/resourceAssignmentExpression&gt;</span></span><br><span class="line">	    <span class="attr">&lt;/potentialOwner&gt;</span></span><br><span class="line">	  <span class="attr">&lt;/userTask&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;sequenceFlow</span> <span class="string">id='flow3' sourceRef='verifyReportTask' targetRef='theEnd' /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;endEvent</span> <span class="string">id="theEnd" /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">&lt;/process&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;/definitions&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-视图模式创建流程图"><a href="#2-2-视图模式创建流程图" class="headerlink" title="2.2 视图模式创建流程图"></a>2.2 视图模式创建流程图</h4><img src="http://photo.wushaopei.com/qiniu65.png" width="60%">

<p><strong>这里我们创建一个简单的流程图作为示范入门。</strong></p>
<p>开发流程 首先要做的，就是要设计好流程图；一个项目可能会包括多个流程图；所以在<strong>src/test/resources</strong>源文件夹下新建一个包<strong>diagrams</strong>，以后所有的流程图文件(bpmn文件和生成的png文件)都放在这个包下； </p>
<img src="http://photo.wushaopei.com/qiniu66.png" width="60%">

<p>然后在<strong>diagrams</strong>上右击，<strong>New - &gt; Other</strong> ：创建一个新的流程实例图 </p>
<img src="http://photo.wushaopei.com/qiniu67.png" width="60%">

<p>选择 <strong>Activiti</strong>下的 <strong>Activiti Diagram</strong> 要开始开发一个<strong>Activiti</strong>流程图表： </p>
<img src="http://photo.wushaopei.com/qiniu68.png" width="60%">

<p>这里 中间区域，是用来绘制流程图标的。右侧是绘制流程图标的工具箱，下面的Properties是属性视图，目前看到的是整个helloWorld流程图的属性： </p>
<img src="http://photo.wushaopei.com/qiniu69.png" width="60%">

<p>然后来画流程图，任何流程，都必须有一个开始事件节点和结束事件节点： </p>
<img src="http://photo.wushaopei.com/qiniu70.png" width="60%">

<p> 在右侧的工具箱里会看到有个<strong>StartEvent</strong> 和<strong>EndEvent</strong>。先点下  然后拖到中间的绘图区域就<strong>OK</strong>了；</p>
<p> 当然每个节点的属性都可以看到，而且可以设置，可以点击选中一个节点，然后在属性视图上看到所以值；</p>
<img src="http://photo.wushaopei.com/qiniu71.png" width="60%">

<p> 会看到这里插件都给设置了初识属性值，可以改  ，也可以不改，都行；</p>
<p> 之后在搞一个用户任务节点（开发最常用的节点），拖一个到中间绘图区域</p>
<img src="http://photo.wushaopei.com/qiniu72.png" width="60%">

<p> 这里的任务节点，必须要有一个人去处理这个任务，而且在实际开发中，根据实际业务，给这个用户任务节点取个名字，</p>
<p> 当然这里是初识，所以就搞个<strong>myprocess</strong>名字，然后分配给“<strong>小龙</strong>”这个人；</p>
<img src="http://photo.wushaopei.com/qiniu73.png" width="60%">

<p>这样就完成了最简单的流程图设计。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>hexo搭建个人博客（一）博客框架搭建</title>
    <url>/2020/03/09/hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%EF%BC%88%E4%B8%80%EF%BC%89%E5%8D%9A%E5%AE%A2%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p><strong>前言</strong>：作为一个技术宅，怎么能够没有自己的个人Blog呢，自己搭建博客，一来可以用来作为学习的记录，二来将来面试的时候抛出自己满满的博客，那可是加分项呀，三来最次也可以用来装装X嘛</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">实验环境:win10</span><br><span class="line">前期准备：安装好git和node.js（自行百度下载git和nedo.js）</span><br></pre></td></tr></table></figure>

<hr>
<p>好，话不多说，开始动手</p>
<p>终端中输入 node -v 和git 分别出现以下界面，则安装正确（我使用的终端是cmder完整版，可以在win下使用linux的命令）</p>
<img src="http://photo.wushaopei.com/qiniu100.png" width="60%">

<p>上面这张图显示的是我安装node的版本 </p>
<img src="http://photo.wushaopei.com/qiniu101.png" width="80%">

<hr>
<p>上面的步骤完成之后，接下来就可以开始安装hexo了</p>
<p>首先介绍下npm，这是一个包管理器，接下来的安装都和这个命令有关，但由于众所周知的原因，国内速度很慢，所以我们进行一个镜像源更改，改到淘宝的源，利用npm安装一个cnpm包管理器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g cnpm --registry&#x3D;https:&#x2F;&#x2F;registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<p>替换成功之后cnpm就安装完成了，接下来开始正式安装hexo，用以下命令安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<p>hexo安装完成之后可以使用  hexo - v 命令验证下是否安装成功，成功的话就能够得到以下这个界面 </p>
<p><img src="https://img2018.cnblogs.com/blog/1502090/201905/1502090-20190526232835559-905739455.png" alt="img"></p>
<hr>
<p>接下来，选择一个盘新建一个文件夹，取名为blog(如果你和我一样是使用cmder的话，直接可以用mkdir命令)</p>
<p>然后终端进入这个blog文件夹，运行以下命令初始化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure>

<p>完成之后会在blog文件夹下生成一些文件，到这一步，hexo的初始化就已经完成了</p>
<img src="http://photo.wushaopei.com/qiniu103.png" width="80%">

<p> 安装依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install</span><br></pre></td></tr></table></figure>

<p> 这时候我们启动hexo博客，运行以下命令，然后在你的浏览器中输入 localhost:4000</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">这个命令默认的是使用4000端口，如果没有错误的话，你可以使用 localhost:4000 在你的浏览器中预览你的博客</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">但是有些人的电脑4000端口可能被占用什么的，这个时候　你可以使用以下命令</span><br><span class="line">hexo  s -p 5555　　&#x2F;&#x2F;指定5555端口</span><br></pre></td></tr></table></figure>

<p>此时hexo的基本布置完成了</p>
<hr>
<p>接下来要做的就是把博客部署到github上去</p>
<p>首先你要有个github账号，注册账号省略</p>
<p>然后你要创建一个仓库，仓库名字严格要求为 ： 你的用户名.github.io      </p>
<p>接下来打开的你的blog文件夹，推荐使用sublime，编辑 _config.yml 文件 </p>
<img src="http://photo.wushaopei.com/qiniu104.png" width="80%">

<p> 配置如上图所示，repo 配置为你的github仓库的地址 ，下图中的地址 </p>
<img src="http://photo.wushaopei.com/qiniu105.png" width="80%">

<p>保存更改，打开终端，进入blog文件夹路径，把博客部署到远端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo d</span><br></pre></td></tr></table></figure>



<p>这个时候可能报错，如：（xxxxx为你的github  ID）</p>
<h2 id="fatal-unable-to-access-‘https-github-com-xxxxxx-xxxxxx-github-io-git"><a href="#fatal-unable-to-access-‘https-github-com-xxxxxx-xxxxxx-github-io-git" class="headerlink" title="fatal: unable to access ‘https://github.com/xxxxxx/xxxxxx.github.io.git"></a>fatal: unable to access ‘<a href="https://github.com/xxxxxx/xxxxxx.github.io.git" target="_blank" rel="noopener">https://github.com/xxxxxx/xxxxxx.github.io.git</a></h2><p>这是因为git没有配置好原因，你可以把上面的 repo 的库地址配置为  </p>
<h2 id="https-用户名：密码-github-com-xxxxxx-xxxxxx-github-io-git"><a href="#https-用户名：密码-github-com-xxxxxx-xxxxxx-github-io-git" class="headerlink" title="https://用户名：密码@github.com/xxxxxx/xxxxxx.github.io.git"></a>https://用户名：密码@github.com/xxxxxx/xxxxxx.github.io.git</h2><p>完成之后刷新你的github仓库，就会发现仓库不是空的了。</p>
<p>然后在浏览器中输入     你的用户名.github.io   就能够访问你的博客了</p>
<hr>
<p>  总结：到此，个人博客就搭建完成了，不过此时的主题是hexo默认的主题，后续可以自己查找资料换主题</p>
<p><strong>注：转载自</strong>：<a href="https://www.cnblogs.com/hztjiayou/p/10928410.html" target="_blank" rel="noopener">https://www.cnblogs.com/hztjiayou/p/10928410.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>个人博客搭建</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络（一）-深入理解NIO</title>
    <url>/2020/03/09/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3NIO/</url>
    <content><![CDATA[<p><strong>目录概览</strong>：</p>
<ul>
<li>​    NIO 网络编程模型</li>
<li>​    NIO 网络编程详解</li>
<li>​    NIO 网络编程实战</li>
<li>​    NIO 网络编程缺陷</li>
</ul>
<h2 id="一、NIO网络编程模型"><a href="#一、NIO网络编程模型" class="headerlink" title="一、NIO网络编程模型"></a>一、NIO网络编程模型</h2><h3 id="1、编程模型定义"><a href="#1、编程模型定义" class="headerlink" title="1、编程模型定义"></a>1、编程模型定义</h3><p><strong>NIO :</strong>  又叫<strong>Non-blocking I/O</strong>或<strong>New I/O</strong>;全新的输入输出标准库；</p>
<p>​            做为原始<strong>I/O</strong>的补充，为了高性能和高并发的场景使用。</p>
<p><strong>模型：</strong>对事物共性的抽象；</p>
<p><strong>编程模型：</strong>对编程共性的抽象；</p>
<h3 id="2、BIO网络模型"><a href="#2、BIO网络模型" class="headerlink" title="2、BIO网络模型"></a>2、BIO网络模型</h3><img src="http://photo.wushaopei.com/qiniu74.png" width="60%">

<ul>
<li>服务端启动，开始建立监听客户端的连接请求；</li>
<li>客户端启动，向服务器端发起建立连接请求；</li>
<li>服务器在收到客户端的请求后，将会创建一个新的线程；</li>
<li>服务端新创建的线程会与客户端建立socket连接，用于响应客户端的请求，通知客户端连接建立成功，你随时可以给我发送数据。</li>
<li>服务器端处理完客户端的请求之后，就会处于等待状态，等待客户端再次发起请求</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu75.png" width="60%">

<p>服务端为每一个客户端建一个线程，一旦客户端请求过多，服务端线程数量也会增多，服务端压力增大。 </p>
<h3 id="3、BIO网络模型缺点"><a href="#3、BIO网络模型缺点" class="headerlink" title="3、BIO网络模型缺点"></a>3、BIO网络模型缺点</h3><ul>
<li><strong>阻塞式I/O模型</strong>，会导致服务器端的业务线程会因阻塞IO的问题一直阻塞等待客户端发起请求，如果客户端不发起请求，服务端的业务线程会一直存在，就会耗费大量系统资源</li>
<li><strong>弹性伸缩能力差</strong>：服务器端的线程数与客户端的个数呈1比1的关系</li>
<li><strong>多线程耗资源</strong> ： 每一个线程都会对CPU的调度资源进行占用，一旦占用而不释放，则会导致资源的紧缺、甚至系统服务的异常宕机</li>
</ul>
<h3 id="4、NIO网络模型猜想"><a href="#4、NIO网络模型猜想" class="headerlink" title="4、NIO网络模型猜想"></a>4、NIO网络模型猜想</h3><p><strong>基于非阻塞 I/O ， 设计应对高并发场景编程模型</strong> </p>
<img src="http://photo.wushaopei.com/qiniu76.png" width="60%">

<p>图解分析：<strong>NIO架构中，客户端的个数与服务器端的线程数呈M:1的关系</strong> </p>
<h3 id="5、NIO-网络模型"><a href="#5、NIO-网络模型" class="headerlink" title="5、NIO 网络模型"></a>5、NIO 网络模型</h3><img src="http://photo.wushaopei.com/qiniu77.png" width="60%">

<p><strong>第一步</strong>：注册连接并提供服务：Selector 中初始化注册并建立连接事件，提供给Client建立连接的服务；client通过Selector连接与AcceptorHandler 发送创建客户端的连接，并又AcceptorHandler方法返回响应结果；同时该AcceptorHandler方法向Selector中注册可读事件（Client连接客户端成功后）</p>
<p><strong>第二步</strong>：提供服务：client 发送请求，Selector中对注册状态及客户端可读性验证，正常情况下，已通过第一步，所以直接连接到处理器进行读写操作，根据需求执行业务逻辑，并响应给客户；</p>
<p><strong>第三步</strong> ：客户端连接可读，在向client响应客户端请求后，注册连接可读事件到Selector 中，所注册的是具体执行业务的Handler</p>
<h3 id="6、NIO网络模型优化"><a href="#6、NIO网络模型优化" class="headerlink" title="6、NIO网络模型优化"></a>6、NIO网络模型优化</h3><ol>
<li><strong>非阻塞IO模型</strong>，服务器端提供一个单线程的selector来统一管理所有客户端接入的连接，并负责监听每个连接所关心的事件</li>
<li><strong>弹性伸缩能力加强</strong>，服务器端一个线程处理所有客户端的连接请求，客户端的个数与服务器端的线程数呈M比1的关系</li>
<li><strong>单线程节省资源</strong>,避免了线程的频繁创建和销毁，同时也避免了多个线程之间上下文的切换，提高了执行效率</li>
</ol>
<h2 id="二、NIO网络编程详解"><a href="#二、NIO网络编程详解" class="headerlink" title="二、NIO网络编程详解"></a>二、NIO网络编程详解</h2><p><strong>NIO核心</strong></p>
<ul>
<li><strong>Channel：通道</strong></li>
<li><strong>Buffer ： 缓冲区</strong></li>
<li><strong>Selector : 选择器 或 多路复用器</strong></li>
</ul>
<h3 id="1、NIO核心类之Channel"><a href="#1、NIO核心类之Channel" class="headerlink" title="1、NIO核心类之Channel"></a>1、NIO核心类之Channel</h3><blockquote>
<p><strong>Channel</strong> 具有<strong>双向性、非阻塞性、操作唯一性。</strong></p>
</blockquote>
<p>channel是信息传输的通道，是jdk NIO中对输入输出方法的另一种抽象，类比IO中的流，与流不同之处在于，channel具有双向性，而流是单向传输的，一个流必须是InputStream或OutputStream的子类，而通道可以用于读写或二者同时进行。channel可以工作在非阻塞模式下，构成NIO的基础。在NIO中，操作channel的唯一方式是使用buffer，通过buffer操作channel，实现数据块的传输。</p>
<p><strong>channel的实现：</strong> </p>
<blockquote>
<ol>
<li>文件类：FileChannel，用于对文件的读写</li>
<li>UDP类：DatagramChannel， 用于UDP的数据读写</li>
<li>TCP类：ServerSocketChannel/SocketChannel，用于TCP的数据读写</li>
</ol>
</blockquote>
<p><strong>Socket的使用：</strong> </p>
<p><strong>服务端：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 监听窗口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">8000</span>);</span><br><span class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="comment">// 2. 接受请求、建立链接</span></span><br><span class="line">			Socket socket = serverSocket.accept();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 3.数据交换</span></span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> BIOServerHandler(socket)).start();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 *  4. 关闭资源</span></span><br><span class="line"><span class="comment">		 * */</span></span><br><span class="line">		serverSocket.close();</span><br></pre></td></tr></table></figure>

<p><strong>客户端：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  1.建立链接</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>,<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  获取输入输出流</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">InputStream inputStream = socket.getInputStream();</span><br><span class="line">OutputStream outputStream = socket.getOutputStream();</span><br></pre></td></tr></table></figure>

<p><strong>Channel的使用：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段1: 服务器端通过服务端socket创建channel</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段2: 服务器端通绑定端口</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">serverSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8000</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段3: 服务器端监听客户端链接，建立socketChannel链接</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">SocketChannel socketChannel = serverSocketChannel.accept(<span class="string">"127.0.0.1"</span>,<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段4: 客户端链接远程主机及端口</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">SocketChannel socketChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">""</span>))</span><br></pre></td></tr></table></figure>

<h3 id="2、NIO核心类之Buffer"><a href="#2、NIO核心类之Buffer" class="headerlink" title="2、NIO核心类之Buffer"></a>2、NIO核心类之Buffer</h3><p><strong>Buffer</strong>：缓冲区，它提供唯一与channel进行交互的方式，作用是读写channel中的数据。Buffer从本质上说是一块内存区域，它是一块可以写入数据，读取数据的内存。</p>
<p><strong>Buffer的属性</strong></p>
<blockquote>
<p><strong>Capacity</strong>：分配的buffer容量，一旦写入的最大字节数超过这个容量，需要将其清空之后，才能继续往里面写数据</p>
<p><strong>Position</strong>：当前操作的位置，初始值为0，最大值：容量值-1</p>
<p><strong>Limit</strong>：上限，写模式下等于Capacity，读模式下等于最多能读取的数据</p>
<p><strong>Mark</strong>：标记，记录mark的位置，调用reset方法时position会回到mark的位置</p>
</blockquote>
<p><strong>Buffer的使用：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 初始化长度为10的byte类型 buffer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ByteBuffer.allocate(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu78.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 向byteBuffer中写入三个字节</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.put(<span class="string">"abc"</span>.getBytes(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu79.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将byteBuffer从写模式切换成读模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.flip():</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu80.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将b先调用get方法读取下一个字节</span></span><br><span class="line"><span class="comment"> * 再调用reset方法将position重置到mark位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.get():</span><br><span class="line">byteBuffer.reset();</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu81.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 调用clear方法，将所有属性重置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.clear();</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu82.png" width="60%">

<h3 id="3、NIO核心类之Selector"><a href="#3、NIO核心类之Selector" class="headerlink" title="3、NIO核心类之Selector"></a>3、NIO核心类之Selector</h3><p><strong>Selector 选择器/多路复用器</strong></p>
<p><strong>作用</strong>：I/O就绪选择</p>
<p><strong>地位</strong>：NIO网络编程的基础</p>
<p><strong>SelectionKey 选择键</strong></p>
<blockquote>
<p>四种就绪状态常量：<strong>连接就绪、接受就绪、读就绪、写就绪</strong></p>
</blockquote>
<p><strong>Selector的使用：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 代码片段1:创建 Selector </span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"> Selector  selector =  Selector.open();</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 代码片段2：将channel注册到selector上，监听读取就绪事件</span></span><br><span class="line"><span class="comment"> * */</span> </span><br><span class="line"> SelectionKey selectionKey = channel.register(SelectionKey.OP_READ);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * 代码片段3：阻塞等待channel有就绪事件发生</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line"> <span class="keyword">int</span> selectNum = selector.select();</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * 代码片段4：获取发生就绪事件的channel集合</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line"> Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br></pre></td></tr></table></figure>



<p><strong>最重要的应该就是代码片段3：</strong> 在这一步对就绪事件进行监听，如果一直不通过，就一直阻塞等待，直到有就绪事件发生，并注册通过检测有效，方才放行 </p>
<h3 id="4、NIO编程实现步骤"><a href="#4、NIO编程实现步骤" class="headerlink" title="4、NIO编程实现步骤"></a>4、NIO编程实现步骤</h3><blockquote>
<p>第一步：创建Selector</p>
<p>第二步：创建ServerSocketChannel，并绑定监听端口</p>
<p>第三步：将Channel设置为非阻塞模式</p>
<p>第四步：将Channel注册到Selector上，监听连接事件</p>
<p>第五步：循环调用Selector的select方法，检测就绪情况</p>
<p>第六步：调用selectedKeys方法获取就绪channel集合</p>
<p>第七步：判断就绪事件种类，调用业务处理方法</p>
<p>第八步：根据业务需要决定是否再次注册监听事件，重复执行第三步操作</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity-（三）创建流程引擎ProcessEngine</title>
    <url>/2020/03/08/Activity-%EF%BC%88%E4%B8%89%EF%BC%89%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8EProcessEngine/</url>
    <content><![CDATA[<h3 id="1、创建并设置Maven-项目"><a href="#1、创建并设置Maven-项目" class="headerlink" title="1、创建并设置Maven 项目"></a>1、创建并设置Maven 项目</h3><p>创建一个<code>$quickStartJavaProjectName</code>具有以下Maven依赖项的Java项目“ plush-activiti”（以后称为）： </p>
<p>文件：$ mvnProject / pom.xml </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- druid --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.12&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- mysql --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.30&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- lombok --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.16.12&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- logback --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;logback-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.8&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.8&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.7.22&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.activiti&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;activiti-engine&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.22.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;pluginManagement&gt;&lt;!-- <span class="function">lock down plugins versions to avoid using Maven <span class="title">defaults</span> <span class="params">(may be moved to parent pom)</span> --&gt;</span></span><br><span class="line"><span class="function">            &lt;plugins&gt;</span></span><br><span class="line"><span class="function">                &lt;plugin&gt;</span></span><br><span class="line"><span class="function">                    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span></span><br><span class="line"><span class="function">                    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span></span><br><span class="line"><span class="function">                    &lt;configuration&gt;</span></span><br><span class="line"><span class="function">                        &lt;source&gt;1.8&lt;/source&gt;</span></span><br><span class="line"><span class="function">                        &lt;target&gt;1.8&lt;/target&gt;</span></span><br><span class="line"><span class="function">                    &lt;/configuration&gt;</span></span><br><span class="line"><span class="function">                &lt;/plugin&gt;</span></span><br><span class="line"><span class="function">            &lt;/plugins&gt;</span></span><br><span class="line"><span class="function">        &lt;/pluginManagement&gt;</span></span><br><span class="line"><span class="function">    &lt;/build&gt;</span></span><br></pre></td></tr></table></figure>

<p>请注意以下依赖性：</p>
<ul>
<li>Activiti（org.activiti）– Activiti的BPM引擎</li>
<li>数据库（mysql）– mysql数据库</li>
<li>日志记录（org.slf4j）– Java的简单日志记录外观</li>
</ul>
<p>当引用构建目录时，假定您的maven项目的标准Maven构建路径： </p>
<table>
<thead>
<tr>
<th>路径</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>$mvnProject</code>/ src / main / java</td>
<td>Java源目录</td>
</tr>
<tr>
<td><code>$mvnProject</code>/ src / main / resources</td>
<td>资源目录</td>
</tr>
<tr>
<td><code>$mvnProject</code>/ src / test / java</td>
<td>Java测试目录</td>
</tr>
<tr>
<td><code>$mvnProject</code>/ src / test / resources</td>
<td>资源测试目录</td>
</tr>
</tbody></table>
<p>您应该能够构建空白项目。在继续之前，请确保总体状态为“ BUILD SUCCESS”。 </p>
<hr>
<p>命令：mvn编译 </p>
<p>基本路径：$ mvnProject </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO]                                                                         </span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Building $quickStartJavaProjectName 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ plush-activiti ---</span><br><span class="line">[WARNING] Using platform encoding (UTF-8 actually) to copy filtered resources, i.e. build is platform dependent!</span><br><span class="line">[INFO] Copying 0 resource</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.5.1:compile (default-compile) @ HelloProcess2 ---</span><br><span class="line">[INFO] Nothing to compile - all classes are up to date</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 0.592s</span><br><span class="line">[INFO] Finished at: Sun Nov 27 05:09:59 EST 2020</span><br><span class="line">[INFO] Final Memory: 10M&#x2F;309M</span><br><span class="line">[INFO] -----------------------------</span><br></pre></td></tr></table></figure>

<p>*<em>笔记： *</em></p>
<ul>
<li>您的输出可能看起来有所不同。最值得注意的是，maven可能需要检索项目依赖项。</li>
</ul>
<hr>
<h3 id="2、添加log4j-日志文件"><a href="#2、添加log4j-日志文件" class="headerlink" title="2、添加log4j 日志文件"></a>2、添加log4j 日志文件</h3><p><strong>两种配置内容（效果一致）：</strong></p>
<p>文件：$ mvnProject / src / main / resources / log4j.properties </p>
<p>第一种：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">log4j.rootLogger</span>=<span class="string">DEBUG, ACT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.ACT</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.ACT.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.ACT.layout.ConversionPattern</span>= <span class="string">%d&#123;hh:mm:ss,SSS&#125; [%t] %-5p %c %x - %m%n</span></span><br></pre></td></tr></table></figure>

<p>第二种：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml</span> <span class="string">version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;configuration</span> <span class="string">scan="true" scanPeriod="60 seconds"&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;appender</span> <span class="string">name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;</span></span><br><span class="line">        <span class="attr">&lt;encoder&gt;</span></span><br><span class="line">            <span class="meta">&lt;pattern&gt;%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125; [%thread] %-5level %logger - %msg%n&lt;/pattern&gt;</span></span><br><span class="line">        <span class="attr">&lt;/encoder&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;!--&lt;appender</span> <span class="string">name="permission" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;file&gt;$&#123;catalina.home&#125;/logs/permission.log&lt;/file&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;rollingPolicy</span> <span class="string">class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;FileNamePattern&gt;$&#123;catalina.home&#125;/logs/permission.%d&#123;yyyy-MM-dd&#125;.log.gz&lt;/FileNamePattern&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/rollingPolicy&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;layout</span> <span class="string">class="ch.qos.logback.classic.PatternLayout"&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;pattern&gt;%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125; [%thread] %-5level %logger - %msg%n&lt;/pattern&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/layout&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/appender&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!----&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;logger</span> <span class="string">name="xxx" level="INFO"&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;appender-ref</span> <span class="string">ref="permission"/&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/logger&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;!--</span> <span class="string">TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR --&gt;</span></span><br><span class="line">    <span class="meta">&lt;root</span> <span class="string">level="INFO"&gt;</span></span><br><span class="line">        <span class="meta">&lt;appender-ref</span> <span class="string">ref="STDOUT"/&gt;</span></span><br><span class="line">    <span class="attr">&lt;/root&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;/configuration&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3、创建流程引起对象"><a href="#3、创建流程引起对象" class="headerlink" title="3、创建流程引起对象"></a>3、创建流程引起对象</h3><p><code>用空白的main创建一个新的Java类。</code></p>
<hr>
<p><code>文件：$ mvnProject / src / main / java / com / webcode/ activiti_create.java</code></p>
<p><strong>3.1</strong> 添加到主入口点的是流程引擎的创建。如下所示添加到<strong>activiti_create</strong>.java中： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; &#123;</span><br><span class="line">    <span class="comment">// 创建流程引擎配置信息对象</span></span><br><span class="line">    ProcessEngineConfiguration pec = ProcessEngineConfiguration</span><br><span class="line">            .createStandaloneProcessEngineConfiguration();</span><br><span class="line">    <span class="comment">// 设置数据库的类型</span></span><br><span class="line">    pec.setDatabaseType(<span class="string">"mysql"</span>);</span><br><span class="line">    <span class="comment">// 设置创建数据库的方式</span></span><br><span class="line">    pec.setDatabaseSchemaUpdate(<span class="string">"true"</span>);</span><br><span class="line">    <span class="comment">// 设置数据库驱动</span></span><br><span class="line">    pec.setJdbcDriver(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">    <span class="comment">// 设置jdbcURL</span></span><br><span class="line">    pec.setJdbcUrl(<span class="string">"jdbc:mysql://49.234.197.103:3306/activiti-explorer?useUnicode=true&amp;characterEncoding=UTF-8"</span>);</span><br><span class="line">    <span class="comment">// 设置用户名</span></span><br><span class="line">    pec.setJdbcUsername(<span class="string">"root"</span>);</span><br><span class="line">    <span class="comment">// 设置密码</span></span><br><span class="line">    pec.setJdbcPassword(<span class="string">"wushaopei"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建流程引擎对象</span></span><br><span class="line">    ProcessEngine pe = pec.buildProcessEngine(); <span class="comment">// 调用访方法才会创建数据表</span></span><br><span class="line">    </span><br><span class="line">    String pName = pe.getName();</span><br><span class="line">    String ver = ProcessEngine.VERSION;</span><br><span class="line">    System.out.println(<span class="string">"ProcessEngine ["</span> + pName + <span class="string">"] Version: ["</span> + ver + <span class="string">"]"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用close方法时，才会删除</span></span><br><span class="line">    pe.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.2</strong> 也可以通过 引入<strong>Activiti</strong>配置文件<strong>activiti.cfg.xml</strong> 的方式来创建流程引擎实例；</p>
<p>创建<strong>activiti.cfg.xml</strong>配置：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml</span> <span class="string">version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;beans</span> <span class="string">xmlns="http://www.springframework.org/schema/beans"</span></span><br><span class="line">       <span class="attr">xmlns</span>:<span class="string">xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       <span class="attr">xsi</span>:<span class="string">schemaLocation="http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="meta">&lt;bean</span> <span class="string">id="processEngineConfiguration" class="org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcUrl" value="jdbc:mysql://49.234.197.103:3306/activiti-explorer" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcDriver" value="com.mysql.jdbc.Driver" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcUsername" value="root" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcPassword" value="wushaopei" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="databaseSchemaUpdate" value="true" /&gt;</span></span><br><span class="line">  <span class="attr">&lt;/bean&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">&lt;/beans&gt;</span></span><br></pre></td></tr></table></figure>

<p>流程引擎创建实例代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用xml配置 简化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;&#123;</span><br><span class="line">    <span class="comment">// 引擎配置</span></span><br><span class="line">    ProcessEngineConfiguration pec=ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(<span class="string">"activiti.cfg.xml"</span>);</span><br><span class="line">    <span class="comment">// 获取流程引擎对象</span></span><br><span class="line">    ProcessEngine processEngine=pec.buildProcessEngine();</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">       String pName = processEngine.getName();</span><br><span class="line">       String ver = ProcessEngine.VERSION;</span><br><span class="line">       System.out.println(<span class="string">"ProcessEngine ["</span> + pName + <span class="string">"] Version: ["</span> + ver + <span class="string">"]"</span>);</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>使用xml配置会简化很多东西，而且在正规情况下的项目都是使用这种读取.XMl配置文件的方式。 </p>
<img src="http://photo.wushaopei.com/qiniu63.png" width="60%">

<p>之前生成Activiti25张表是使用Java类生成的，但是在实际的开发中是使用activiti.cfg.xml配置文件生成。</p>
<p>官方文档参考地址：<a href="http://activiti.org/userguide/index.html#configuration" target="_blank" rel="noopener">http://activiti.org/userguide/index.html#configuration</a> （英文看不懂可以用谷歌浏览器翻译功能）</p>
<h3 id="4、打包配置"><a href="#4、打包配置" class="headerlink" title="4、打包配置"></a>4、打包配置</h3><p><code>文件：$ mvnProject / pom.xml</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">...</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">...</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">...</span><br><span class="line">      &lt;!-- Maven Assembly Plugin --&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.4.1&lt;/version&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">          &lt;!-- get all project dependencies --&gt;</span><br><span class="line">          &lt;descriptorRefs&gt;</span><br><span class="line">            &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">          &lt;/descriptorRefs&gt;</span><br><span class="line">          &lt;!-- MainClass in mainfest make a executable jar --&gt;</span><br><span class="line">          &lt;archive&gt;</span><br><span class="line">            &lt;manifest&gt;</span><br><span class="line">              &lt;mainClass&gt;com.example.OnboardingRequest&lt;/mainClass&gt;</span><br><span class="line">            &lt;/manifest&gt;</span><br><span class="line">          &lt;/archive&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">            &lt;!-- bind to the packaging phase --&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">...</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">...</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>通过运行“ <strong>mvn package</strong>”来打包代码。 </p>
<p>启动 .jar 包命令：  </p>
<blockquote>
<p><strong>命令：java -jar target / ActivitiDeveloperQuickStart-0.0.1-SNAPSHOT-jar-with-dependencies.jar</strong></p>
<p><strong>-要么-</strong></p>
<p><strong>java -jar target / $ quickStartJavaProjectName-0.0.1-SNAPSHOT-jar-with-dependencies.jar</strong></p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（五）项目打包</title>
    <url>/2020/03/08/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%BA%94%EF%BC%89%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E3%80%81%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="1、Spring-Boot-项目打包"><a href="#1、Spring-Boot-项目打包" class="headerlink" title="1、Spring Boot 项目打包"></a>1、Spring Boot 项目打包</h3><p><strong>打包方式：</strong> </p>
<blockquote>
<p>构建 JAR 包</p>
<p>构建 WAR 包</p>
<p>指定 Main-Class</p>
</blockquote>
<p><strong>（1）右击工程名  “copy path” 获取工程路径，到 cmd.exe 命令行中进入该目录下，输入</strong> </p>
  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mvn -Dmaven.test.skip -U clean <span class="keyword">package</span></span><br></pre></td></tr></table></figure>

<p>命令执行打包操作，</p>
<p>此时执行过程会发生报错，因为 在进行多模块拆分后，需要重新为工程指定 main.class ，也就是 springboot 的启动器入口的位置的明确。这是由于在拆分过后，在父工程下找不到main.class 。</p>
<p>解决方法：</p>
<p>将父工程的pom.xml 中的 <build></build>依赖驱动剪切到 web 子模块中 ，然后再到修改后的web子模块的 pom.xml 中的   <build></build> 中的<plugin></plugin>添加一个 <configuration/>,并为其配置一个<mainClass/>，将 springboot入口启动器的 Reference 路径复制并放入到 <mainClass>中，然后执行打包就可以了。</p>
<p>注意： 不要把<build/>放在父工程的pom.xml 下进行打包，那样会有很多错误要进行修正，而且由于主启动器迁移到 了web 中，在父工程下 添加<build/>意义不大</p>
<img src="http://photo.wushaopei.com/qiniu61.png" width="60%">

<p><strong>（2）在 cmd 命令行中启动 jar 包 或者 war 包 的方式：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar web-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.jar</span><br><span class="line">或者</span><br><span class="line">java -jar web-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.war</span><br></pre></td></tr></table></figure>

<p>注意： 要在 当前工程打成 war 包，需要在 web 的mian 目录下创建 “webapp” 和  “WEB-INF”两个目录，并在 “WEB-INF” 目录下创建 一个 web.xml 文件 </p>
<img src="http://photo.wushaopei.com/qiniu62.png" width="60%">

<h3 id="2、Spring-Boot-运行模式"><a href="#2、Spring-Boot-运行模式" class="headerlink" title="2、Spring Boot 运行模式"></a>2、Spring Boot 运行模式</h3><p><strong>Springboot</strong>项目的3种运行模式：</p>
<p><strong>idea</strong>方式，<strong>jar</strong>/<strong>war</strong>方式，<strong>maven</strong>插件方式</p>
<blockquote>
<p>（1）如果是在开发过程中，会使用<strong>idea</strong>方式</p>
<p>（2）如果是在线上的服务器上，会使用<strong>jar/war</strong>方式，作为启动脚本</p>
<p>（3）如果开发环境是Linux环境，会使用<strong>maven</strong>插件方式。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot框架（一）整合ApacheShiro权限管理框架</title>
    <url>/2020/03/08/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%B8%83%EF%BC%89%E6%95%B4%E5%90%88ApacheShiro%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6/</url>
    <content><![CDATA[<h3 id="1、Spring-Security-权限管理框架介绍"><a href="#1、Spring-Security-权限管理框架介绍" class="headerlink" title="1、Spring Security 权限管理框架介绍"></a>1、Spring Security 权限管理框架介绍</h3><p><strong>简介</strong>： Spring Security 提供了基于javaEE的企业应有个你软件全面的安全服务。这里特别强调支持使用SPring框架构件的项目，Spring框架是企业软件开发javaEE方案的领导者。 </p>
<blockquote>
<p>Spring Security 的两个目标： <strong>“认证”</strong> 与<strong>“授权”</strong>。 </p>
</blockquote>
<ul>
<li>“<strong>认证</strong>”，是建立一个他声明的主题的过程（一个“主体”一般是指用户，设备或一些可以在你的应用程序中执行动作的其他系统）。</li>
<li>“<strong>授权</strong>” 指确定一个主体是否允许在你的应用程序执行一个动作的过程。为了抵达需要授权的店，主体的身份已经有认证过程建立。这个概念是通用的而不只在Spring Security中。</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu49d.png" width="60%">

<p>​    在SpringSecurity 中，请求进入后会被拦截器拦截到，并交由认证管理器首先处理；这是在身份验证层，Spring Security  的支持多种认证模式。包括 Basic、Digest、X.509、LDAP、Form（基于表单的认证） 等多种HTTP 认证。 </p>
<p><strong>浅析：</strong></p>
<blockquote>
<p><strong>Basic 认证</strong>：在HTTP1.0提出的认证方法，针对特定的用户和资源，需要提供特定的密码认证后方可访问，其中密码是使用明文传输的；一个请求到来时，浏览器弹出对话框，让用户输入用户名和密码，并用BASE 64 进行编码进行传输，服务器接受并解析这些信息，并认证通过，才会允许继续访问。</p>
</blockquote>
<blockquote>
<p><strong>Digest认证</strong>： 解决Basic 认证的安全问题，当访问时，浏览器依旧弹出对话框，让用户输入用户名和密码，浏览器会对用户名、密码、HTTP请求方法、被请求资源的URI进行组合后进行MD5运算，然后把计算得到的摘要信息发送给服务器；服务器获取报文头部相关认证信息后获取到 username ,同时获取到密码，同样对用户名、密码、HTTP请求方法、被请求资源的URI进行组合后和 response 进行比较，如果相同，才算认证通过。</p>
</blockquote>
<h3 id="2、Spring-Security-常用权限拦截器："><a href="#2、Spring-Security-常用权限拦截器：" class="headerlink" title="2、Spring Security 常用权限拦截器："></a>2、Spring Security 常用权限拦截器：</h3><img src="http://photo.wushaopei.com/qiniu50.png" width="60%">

<p>主要功能性拦截器有 11 个， FilterChainProxy 对拦截器进行过滤操作并代理执行！ </p>
<h3 id="3、Spring-Security-项目-Demo"><a href="#3、Spring-Security-项目-Demo" class="headerlink" title="3、Spring Security 项目 Demo"></a>3、Spring Security 项目 Demo</h3><p>（1）环境搭建及使用 </p>
<blockquote>
<ol>
<li>基于Spring Boot + Spring Security 环境</li>
<li>常用 Case 实现</li>
</ol>
</blockquote>
<p>（2）创建SpringBoot 工程 </p>
<img src="http://photo.wushaopei.com/qiniu51.png" width="60%">

<p>（3）整合SpringSecurity 依赖 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">       <span class="comment">&lt;!--springsecurity 主要依赖--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（4）主启动类配置： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span>          <span class="comment">//返回响应体为json</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span>  <span class="comment">//扫描Bean注入到容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Bootstrap<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>) <span class="comment">// 测试接口</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">home</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>) <span class="comment">//测试接口</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（5）配置 Servlet 初始化 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ServletInitializer 告诉程序，项目启动时从 Bootstrap 开始</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/19 10:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletInitializer</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(Bootstrap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（6）启动SpringBoot 项目- - run 主启动类： </p>
<blockquote>
<p>启动SpringBoot 项目进行接口访问时，弹出登录界面，说明SpringSecurity生效了 </p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu52.png" width="60%">

<h3 id="4、SpringSecurity拦截配置："><a href="#4、SpringSecurity拦截配置：" class="headerlink" title="4、SpringSecurity拦截配置："></a>4、SpringSecurity拦截配置：</h3><p><strong>注意</strong>：在 3  的基础上，对工程进一步配置： </p>
<p>（1）创建 SpringSecurityConfig 类管理 拦截配置： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>     <span class="comment">// 将Bean 放到容器中管理</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">// 用于将Security 生成 Bean </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 接口请求拦截</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()  <span class="comment">//安全请求策略</span></span><br><span class="line">                .antMatchers(<span class="string">"/"</span>).permitAll() <span class="comment">//可放行请求配置</span></span><br><span class="line">                .anyRequest().authenticated()    <span class="comment">//其他请求进行拦截</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout().permitAll()  <span class="comment">// 注销任意访问</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin();</span><br><span class="line">        http.cors().disable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *  前端拦截</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(WebSecurity web)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 忽视 js 、css 、 images 后缀访问</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">"/js/**"</span>,<span class="string">"/css/**"</span>,<span class="string">"/images/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该 <strong>SpringSecurityConfig</strong> 继承 <strong>WebSecurityConfigurerAdapter</strong> 类，并重写 <strong>configure(HttpSecurity http)</strong>和 <strong>configure（WebSecurity web）</strong>两个方法，分别针对 接口请求 和 静态页面 资源进行拦截。</p>
<blockquote>
<p><strong>接口请求</strong>： ip:port/  的请求一律通过，主要进入到 Bootstrap 中的 RequestMapping(“/”)接口中；并对 “/”后带有标识地址的请求进行拦截认证； </p>
</blockquote>
<blockquote>
<p><strong>静态资源</strong>： 此处对静态 js 、css、images 三者进行放行。 </p>
</blockquote>
<p>效果截图： </p>
<blockquote>
<p>配置 SpringSecurity 后，默认可以通过 “/” 的接口请求； 而当进行 如“/hello”接口请求时会被拦截进行验证 </p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu53.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu54.png" width="60%">

<h3 id="5、基于SpringSecurity-权限管理-Case-实操"><a href="#5、基于SpringSecurity-权限管理-Case-实操" class="headerlink" title="5、基于SpringSecurity 权限管理 Case 实操"></a>5、基于SpringSecurity 权限管理 Case 实操</h3><p><strong>权限管理 Case 的需求有两个要求：</strong> </p>
<blockquote>
<ol>
<li><strong>第一点</strong> ：只要能登录即可；</li>
<li><strong>第二点</strong>：有指定的角色，每个角色有指定的权限.</li>
</ol>
</blockquote>
<p>（1）只要能登录即可，功能体现： </p>
<p>在SpringSecurityConfig.java中配置用户信息： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*  告诉程序，系统中有个用户 用户名为 admin ,密码为 admin  角色为 ADMIN</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">"admin"</span>).password(<span class="string">"admin"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意 ：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在springboot使用spring security 做权限管理 ，使用内存用户验证，会返回无响应报错：</span><br><span class="line">java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id &quot;null&quot;</span><br></pre></td></tr></table></figure>

<p><strong>解决方法：</strong> </p>
<blockquote>
<p>这是因为Spring boot 2.0.3引用的security 依赖是 spring security 5.X版本，此版本需要提供一个PasswordEncorder的实例，否则后台汇报错误：</p>
<p>java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id “null”<br>并且页面毫无响应。<br>因此，需要创建PasswordEncorder的实现类。</p>
</blockquote>
<p>创建PasswordEncorder 实体类后可通过<strong>两种方式</strong>完成明文验证通过：</p>
<p><strong>第一种</strong>：直接在配置好的 PasswordEncorder 类上添加 @Component 装配 MyPasswordEncoder 为Bean 注入到容器即可；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> charSequence.toString();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence charSequence, String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.equals(charSequence.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后继续使用 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  *  告诉程序，系统中有个用户 用户名为 admin ,密码为 admin  角色为 ADMIN</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">//可以设置内存指定的登录的账号密码,指定角色</span></span><br><span class="line">      <span class="comment">//不加.passwordEncoder(new MyPasswordEncoder())或者注入该类的Bean</span></span><br><span class="line">      <span class="comment">//就不是以明文的方式进行匹配，会报错</span></span><br><span class="line">      auth.inMemoryAuthentication().withUser(<span class="string">"admin"</span>).password(<span class="string">"admin"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>进行 密码明文登录，可以成功 </p>
<img src="http://photo.wushaopei.com/qiniu55.png" width="60%">

<p><strong>第二种</strong>：在auth.inMemoryAuthentication()后面使用<em>.passwordEncoder(new MyPasswordEncoder())**对登录信息进行包装后提交即可；这样也可以成功</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这样，页面提交时候，密码以明文的方式进行匹配。</span></span><br><span class="line">auth.inMemoryAuthentication().passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder()).withUser(<span class="string">"wsp"</span>).password(<span class="string">"wsp"</span>).roles(<span class="string">"ADMIN"</span>);</span><br></pre></td></tr></table></figure>

<p><strong>推荐</strong>： 最好是使用第一种 装载成 Bean 后注入容器，对于开发效率更高，也更便捷。</p>
<p>（2）有指定的角色，每个角色有指定的权限，功能体现：</p>
<p>① 创建接口 role1() 并对其添加 @PreAuthorize(<strong>“hasRole(‘ROLE_ADMIN’)”</strong>)  以进行角色拦截</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_ADMIN')"</span>) <span class="comment">// 角色拦截校验注解</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/roleAuth"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">role1</span><span class="params">()</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">return</span> <span class="string">"roleAuth"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>（2）角色拦截 - -</strong> 功能解析： </p>
<p> @PreAuthorize(<strong>“hasRole(‘ROLE_ADMIN’)”</strong>) 注解说明： </p>
<img src="http://photo.wushaopei.com/qiniu56.png" width="60%">

<p>②并在 SpringSecurityConfig.java 中创建新用户，以提供测试： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//可以设置内存指定的登录的账号密码,指定角色</span></span><br><span class="line">        <span class="comment">//不加.passwordEncoder(new MyPasswordEncoder())</span></span><br><span class="line">        <span class="comment">//就不是以明文的方式进行匹配，会报错</span></span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">"admin"</span>).password(<span class="string">"admin"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">"demo"</span>).password(<span class="string">"demo"</span>).roles(<span class="string">"DEMO"</span>);</span><br><span class="line">        .passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder())。</span><br><span class="line">        <span class="comment">//这样，页面提交时候，密码以明文的方式进行匹配。</span></span><br><span class="line">        auth.inMemoryAuthentication().passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder()).withUser(<span class="string">"wsp"</span>).password(<span class="string">"wsp"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>③ 创建好接口后，进行登录尝试，发现，使用 用户为 demo ，角色 为 DEMO 依旧可以通过该接口 </p>
<img src="http://photo.wushaopei.com/qiniu57.png" width="60%">

<p>问题解析：</p>
<p>这是因为还需要再添加一个@EnableGlobalMethodSecurity(prePostEnabled = <strong>true</strong>) 注解到 启动器上，以让 @PreAuthorize(<strong>“hasRole(‘ROLE_ADMIN’)”</strong>) 这个注解生效，完整 启动类代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Bootstrap<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">home</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_ADMIN')"</span>)</span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/roleAuth"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">role1</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"roleAuth"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>添加注解后</strong>：</p>
<p><strong>使用 demo 进行登录：</strong></p>
<img src="http://photo.wushaopei.com/qiniu58.png" width="60%">

<p><strong>使用admin进行登录：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu59.png" width="60%">

<p><strong>（3）数据库管理实现</strong>： </p>
<blockquote>
<p> 通过数据库获取用户信息进行登录认证 </p>
</blockquote>
<p>创建 MyUserService.java类，并装载 Bean 到 容器中，在SpringSecurityConfig.java 中进行配置： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringSecurityConfig.java 中 configure(AuthenticationManagerBuilder auth)方法修改为通过注入MyUserService 的Bean实现数据库查询 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyUserService myUserService;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">           auth.userDetailsService(myUserService); <span class="comment">// 通过注入 MyUserService 的方式实现数据库查询用户信息的登录认证</span></span><br><span class="line"> </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>密码的自定义验证：</strong> </p>
<blockquote>
<p>创建 MyPasswordEncoder 类，实现 PasswordEncoder 接口类；重写 encode（CharSequence obj和 matches（CharSequence obj,String str） 方法： </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String SALT = <span class="string">"wenmin"</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> MD5Util.MD5Encode(charSequence.toString(),SALT);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> MD5Util.isPasswordValid(encodedPassword,rawPassword.toString(),SALT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>说明：</strong>第一个是加密的方法，第二个是匹配密码，具体操作是加密方法加密后与原始密码在匹配方法中进行匹配</p>
<p>底层逻辑解析：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">passwordEncoder. isPasswordValid(userDetails.getPassword(), presentedPassword, salt) 这个实现是在接口PasswordEncoder的实现类MessageDigestPasswordEncoder中实现的。 </span><br><span class="line"> </span><br><span class="line">MessageDigestPasswordEncoder类： </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPasswordValid</span><span class="params">(String encPass, String rawPass, Object salt)</span> </span>&#123; </span><br><span class="line">        String pass1 = <span class="string">""</span> + encPass; </span><br><span class="line">        String pass2 = encodePassword(rawPass, salt); </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> pass1.equals(pass2); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">其中 encodePassword(rawPass, salt)方法如下： </span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">encodePassword</span><span class="params">(String rawPass, Object salt)</span> </span>&#123; </span><br><span class="line">        String saltedPass = mergePasswordAndSalt(rawPass, salt, <span class="keyword">false</span>); </span><br><span class="line"> </span><br><span class="line">        MessageDigest messageDigest = getMessageDigest(); </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">byte</span>[] digest; </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123; </span><br><span class="line">            digest = messageDigest.digest(saltedPass.getBytes(<span class="string">"UTF-8"</span>)); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123; </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"UTF-8 not supported!"</span>); </span><br><span class="line">        &#125; </span><br><span class="line"> </span><br><span class="line">        <span class="comment">// "stretch" the encoded value if configured to do so </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; iterations; i++) &#123; </span><br><span class="line">            digest = messageDigest.digest(digest); </span><br><span class="line">        &#125; </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (getEncodeHashAsBase64()) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(Base64.encode(digest)); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(Hex.encode(digest)); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">使用的是MD5加密方法。</span><br></pre></td></tr></table></figure>

<p><strong>引入自定义的登录信息验证器</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">auth.userDetailsService(myUserService).passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder());</span><br></pre></td></tr></table></figure>

<p>相关注解说明： </p>
<table>
<thead>
<tr>
<th>@PreAuthorize(“hasRole(‘ROLE_ADMIN’)”)</th>
<th>方法调用前进行权限检查</th>
</tr>
</thead>
<tbody><tr>
<td><strong>@PostAuthorize(“hasRole(‘’)”)</strong></td>
<td>方法调用后进行权限检查</td>
</tr>
<tr>
<td><strong>@PreFilter(“”)</strong></td>
<td>方法调用前针对集合类参数或返回值进行过滤</td>
</tr>
<tr>
<td><strong>@PostFilter(“”)</strong></td>
<td>方法调用后针对集合类参数或返回值进行过滤</td>
</tr>
</tbody></table>
<h3 id="6、Spring-Security-的优缺点"><a href="#6、Spring-Security-的优缺点" class="headerlink" title="6、Spring Security 的优缺点"></a>6、Spring Security 的优缺点</h3><p><strong>优点：</strong></p>
<blockquote>
<p>提供了一套安全框架，而且这个框架是可以用的；</p>
<p>提供了很多用户认证的功能，实现相关接口即可，节约大量开发工作；</p>
<p>基于spring，易于集成到 spring 项目中，且封装了许多方法。</p>
</blockquote>
<p><strong>缺点：</strong></p>
<blockquote>
<p>配置文件多，角色被“编码”到配置文件盒源文件中，RBAC 不明显；</p>
<p>对于系统中用户、角色、权限之间的关系，没有可操作的界面；</p>
<p>大数据量情况下，几乎不可用。 </p>
</blockquote>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/Spring-boot-Security" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot功能（一）集成JavaMail实现邮箱认证</title>
    <url>/2020/03/08/SpringBoot%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%80%EF%BC%89%E9%9B%86%E6%88%90JavaMail%E5%AE%9E%E7%8E%B0%E9%82%AE%E7%AE%B1%E8%AE%A4%E8%AF%81/</url>
    <content><![CDATA[<h2 id="一、JavaMail"><a href="#一、JavaMail" class="headerlink" title="一、JavaMail"></a>一、JavaMail</h2><h3 id="1、什么是JavaMail？"><a href="#1、什么是JavaMail？" class="headerlink" title="1、什么是JavaMail？"></a>1、什么是JavaMail？</h3><p><strong>JavaMail</strong> ，顾名思义，提供给开发者处理 电子邮件相关的编程接口。它是<strong>Sun</strong>发布的用来处理<strong>email</strong>的<strong>API</strong>。它可以方便的执行一些常用的邮件传输。我们可以基于<strong>JavaMaiil</strong>开发出类似于 <strong>Microsoft Outlook</strong>的应用程序。 </p>
<h3 id="2、关于要使用JavaMail的原因？"><a href="#2、关于要使用JavaMail的原因？" class="headerlink" title="2、关于要使用JavaMail的原因？"></a>2、关于要使用JavaMail的原因？</h3><p>基于现在WEB开发中对JavaMail的需求，<strong>例如：</strong> </p>
<blockquote>
<p>(1) 用户注册后，网站发送一封激活邮件验证；</p>
</blockquote>
<blockquote>
<p>(2) 用户过生日，系统发送生日祝福邮件；</p>
</blockquote>
<blockquote>
<p>(3) 将最新活动和优惠以邮件的形式告知会员等等……..</p>
</blockquote>
<p>以上的需求都需要通过编程语言实现发送邮件功能，而JavaMail便能满足这一需求。 </p>
<h3 id="3、电子邮箱及邮件服务器"><a href="#3、电子邮箱及邮件服务器" class="headerlink" title="3、电子邮箱及邮件服务器"></a>3、电子邮箱及邮件服务器</h3><p>什么是<strong>电子邮箱</strong>？ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">电子邮箱（E-mail 地址） 需要在邮件服务器上进行申请，确切的说，电子邮箱其实就是用户在邮件服务器上申请的一个账户，用户在邮件服务器上申请了一个账号后，邮件服务器就会为这个账号分配一定的空间，用户从而可以使用这个账号以及空间，发送电子邮件和保存别人发送过来的电子邮件。</span><br></pre></td></tr></table></figure>

<p>什么是<strong>邮箱服务器</strong>？ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">服务器指的是一台电脑安装了一个服务器软件，那么这台电脑就可以称为是WEB服务器，那么同样的一台电脑安装了邮件服务器软件，那么这台电脑称为是邮件服务器。</span><br></pre></td></tr></table></figure>

<p>基于互联网的<strong>电子邮件</strong>功能： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要在Internet上提供电子邮件功能，必须有专门的电子邮件服务器，例如目前网络上提供邮件服务的厂商：新浪、搜狐、网易等等他们都有自己的邮件服务器。</span><br></pre></td></tr></table></figure>

<h3 id="4、邮件收发协议"><a href="#4、邮件收发协议" class="headerlink" title="4、邮件收发协议"></a>4、邮件收发协议</h3><p>（1）SMTP协议（发送邮件）</p>
<p> <strong>简单邮件传输协议 (Simple Mail Transfer Protocol, SMTP)</strong> 是在<a href="https://baike.baidu.com/item/Internet" target="_blank" rel="noopener">Internet</a>传输<a href="https://baike.baidu.com/item/email" target="_blank" rel="noopener">email</a>的<a href="https://baike.baidu.com/item/%E4%BA%8B%E5%AE%9E%E6%A0%87%E5%87%86" target="_blank" rel="noopener">事实标准</a>。（百度百科）</p>
<blockquote>
<p><strong>SMTP</strong>是一个相对简单的基于文本的<strong>协议</strong>。在其之上指定了一条消息的一个或多个接收者（在大多数情况下被确认是存在的），然后<strong>消息文本</strong>会被传输。可以很简单地通过<strong>telnet</strong>程序来测试一个<strong>SMTP服务器</strong>。SMTP使用TCP端口25。要为一个给定的域名决定一个SMTP服务器，需要使用<strong>MX (Mail eXchange) DNS</strong>。（百度百科）</p>
</blockquote>
<p>用户脸上邮件服务器后，要想给它发送一封电子邮件，需要遵循一定的通讯规则，SMTP协议就是用于定义这种规则的。因此，通常我们也把处理用户SMTP请求（邮件发送请求）的邮件服务器称之为SMTP服务器。 </p>
<p>（2）POP3协议（接收邮件）  </p>
<p><strong>POP3</strong>，全名为“Post Office Protocol - Version 3”，即“<a href="https://baike.baidu.com/item/%E9%82%AE%E5%B1%80%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">邮局协议</a>版本3”。是<a href="https://baike.baidu.com/item/TCP%2FIP" target="_blank" rel="noopener">TCP/IP</a>协议族中的一员，由<a href="https://baike.baidu.com/item/RFC" target="_blank" rel="noopener">RFC</a>1939 定义。本协议主要用于支持使用客户端远程管理在<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8/100571" target="_blank" rel="noopener">服务器</a>上的电子邮件。提供了<a href="https://baike.baidu.com/item/SSL" target="_blank" rel="noopener">SSL</a>加密的POP3协议被称为POP3S。（百度百科） </p>
<blockquote>
<p><strong>POP</strong> 协议支持“离线”邮件处理。其具体过程是：<strong>邮件发送到服务器上</strong>，电子邮件客户端调用邮件客户机程序以<strong>连接服务器</strong>，并下载所有未阅读的<strong>电子邮件</strong>。这种<strong>离线访问模式</strong>是一种存储转发服务，将邮件从邮件服务器端送到个人终端机器上，一般是PC机或 MAC。一旦邮件发送到 PC 机或MAC上，邮件服务器上的邮件将会被删除。但目前的<strong>POP3</strong>邮件服务器大都可以“只下载邮件，服务器端并不删除”，也就是改进的<strong>POP3协议</strong>。（百度百科）</p>
</blockquote>
<p>同样，用户若<strong>想从邮件服务器管理的电子邮件中接受一封电子邮件的话，他连上邮件服务器后，也需要遵循一定的通讯格式</strong>，POP3协议用于定义这种通讯格式。 </p>
<p>（3）邮件收发过程的介绍： </p>
<img src="http://photo.wushaopei.com/qiniu47.png" width="70%">

<blockquote>
<p><strong>邮件的发送、接受，在客户端软件中，由SMTP服务器进行发送操作，接受是由POP3服务器进行接收。</strong></p>
<p>1、 邮件发送协议-SMTP，默认端口号25</p>
<p>​       用于把用户邮件从一个服务器转到下一个服务器</p>
<p>2、 邮件接收协议-POP3，默认端口号110</p>
<p>​       用于支持使用客户端远程管理在服务器上的电子邮件</p>
</blockquote>
<h2 id="二、邮件发送代码实现"><a href="#二、邮件发送代码实现" class="headerlink" title="二、邮件发送代码实现"></a>二、邮件发送代码实现</h2><h3 id="1、环境搭建"><a href="#1、环境搭建" class="headerlink" title="1、环境搭建"></a>1、环境搭建</h3><p>（1）创建数据库和表 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;NewTable&#96; (</span><br><span class="line">&#96;uid&#96;  int(11) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">&#96;username&#96;  varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;password&#96;  varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;nickname&#96;  varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;email&#96;  varchar(30) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;state&#96;  int(11) NULL DEFAULT NULL ,</span><br><span class="line">&#96;code&#96;  varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">PRIMARY KEY (&#96;uid&#96;)</span><br><span class="line">)</span><br><span class="line">ENGINE&#x3D;InnoDB</span><br><span class="line">DEFAULT CHARACTER SET&#x3D;utf8 COLLATE&#x3D;utf8_general_ci</span><br><span class="line">AUTO_INCREMENT&#x3D;22</span><br><span class="line">ROW_FORMAT&#x3D;DYNAMIC</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>（2）创建一个springboot工程，创建相应的包，并配置相应的pom.xml依赖 </p>
<img src="http://photo.wushaopei.com/qiniu48.png" width="60%">

<p>  (3) pom.xml </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--&lt;version&gt;5.1.41&lt;/version&gt; --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- lombok 简化 java 代码 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--郵箱發送--&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（4）创建User类并配置application.yml </p>
<p><strong>User类：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span>  Integer uid;</span><br><span class="line">    <span class="keyword">private</span>  String username;</span><br><span class="line">    <span class="keyword">private</span>  String password;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Integer state;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>application.yml</strong> </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">80</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://localhost:3333/regist_web?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;autoReconnect=true&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">root</span></span><br><span class="line">    <span class="meta">driver-class-name</span>:  <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">mybatis</span>:<span class="string"></span></span><br><span class="line">  <span class="meta">mapper-locations</span>: <span class="string">classpath*:/mybatis/mappers/*Mapper.xml</span></span><br><span class="line">  <span class="meta">type-aliases-package</span>: <span class="string">com.entities</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#邮件配置(发件人）</span></span><br><span class="line"><span class="attr">email</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">host</span>: <span class="string">smtp.163.com</span></span><br><span class="line">  <span class="attr">username</span>: <span class="string">1***9746***@163.com</span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">1***9746**</span></span><br><span class="line">  <span class="attr">senderName</span>: <span class="string">1***9746***@163.com</span></span><br></pre></td></tr></table></figure>

<p>（5）设计注册页面 </p>
<p><strong>index.html</strong> </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"jquery-1.11.3.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户注册的页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/get/getParam/user"</span> <span class="attr">method</span>=<span class="string">"get"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"600"</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>昵称<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"nickname"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>邮箱<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"email"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"2"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注册"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（6）Handler ：创建接口，接收form 表单数据并进行封装，并经过dao 层 添加到对应的数据库表中 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping</span> (<span class="string">"/get/getParam/user"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getParam</span><span class="params">(@RequestParam(<span class="string">"username"</span>)</span>String  username,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"password"</span>)</span>String  password,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"nickname"</span>)</span>String  nickname,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"email"</span>)</span>String  email,</span></span><br><span class="line"><span class="function">                           HttpServletRequest request</span></span><br><span class="line"><span class="function">                           )  </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            request.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>(username.equals(<span class="string">""</span>) &amp;&amp; password.equals(<span class="string">""</span>) &amp;&amp; nickname.equals(<span class="string">""</span>) &amp;&amp; email.equals(<span class="string">""</span>))&#123;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">return</span>  <span class="string">"请不要留空"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">//封装数据</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUsername(username);</span><br><span class="line">        user.setPassword(password);</span><br><span class="line">        user.setNickname(nickname);</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        user.setState(<span class="number">0</span>);<span class="comment">// 0 ： 未激活 1： 已经激活</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//使用 UUID 随机生成激活码</span></span><br><span class="line">        String code = UUIDUtils.getUUID()+ UUIDUtils.getUUID();</span><br><span class="line">        user.setCode(code);</span><br><span class="line"> </span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//调用业务层处理数据</span></span><br><span class="line">        userService.addUser(user);</span><br><span class="line"> </span><br><span class="line">        map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">        map.put(<span class="string">"message"</span>, <span class="string">"發送成功"</span>);</span><br><span class="line">        <span class="comment">//页面跳转</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">            map.put(<span class="string">"state"</span>,<span class="string">"1"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"發送失敗"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span>  <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>（7）创建一个UUIDUtils 工具类，使用UUID随机生成激活码 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UUIDUtils  生成随机字符串工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/8 13:52</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UUIDUtils</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">"-"</span>,<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（8）创建邮箱参数实体EmailConfig.java和发送邮件工具类MailUtils.java</p>
<p><strong>EmailConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.utils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> EmailConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 10:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"email"</span>, ignoreUnknownFields = <span class="keyword">false</span>)</span><br><span class="line"><span class="comment">//@PropertySource("classpath:/application.yml")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String senderName;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSenderName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSenderName</span><span class="params">(String senderName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.senderName = senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"EmailConfig&#123;"</span> +</span><br><span class="line">                <span class="string">"host='"</span> + host + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", senderName='"</span> + senderName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MailUtils.java</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.utils;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mysql.cj.Session;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.JavaMailSenderImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.MimeMessageHelper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.mail.MessagingException;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MailUtils</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/8 14:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailUtils</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailConfig emailConfig;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MailUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送邮件的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> to :给谁发邮件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> code : 邮件的激活码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> subject ： 主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> text  : 内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">sendMail</span><span class="params">(String toEmail, String code,<span class="keyword">final</span> String subject,<span class="keyword">final</span> String text)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//1、创建邮件对象</span></span><br><span class="line">            JavaMailSenderImpl javaMailSender = <span class="keyword">new</span> JavaMailSenderImpl();</span><br><span class="line">            <span class="comment">//2、发邮件人邮箱</span></span><br><span class="line">            javaMailSender.setUsername(emailConfig.getUsername());</span><br><span class="line">            <span class="comment">//3、发邮件人邮箱密码（默认使用客户端的授权码）</span></span><br><span class="line">            javaMailSender.setPassword(emailConfig.getPassword());</span><br><span class="line">            <span class="comment">//4、设置邮件服务器主机名  SMTP服务器地址</span></span><br><span class="line">            javaMailSender.setHost(emailConfig.getHost());</span><br><span class="line">            <span class="comment">//5、SMTP服务器: 默认端口</span></span><br><span class="line">            javaMailSender.setPort(<span class="number">25</span>);</span><br><span class="line">            <span class="comment">//6、//发送邮件协议名称</span></span><br><span class="line">            javaMailSender.setProtocol(<span class="string">"smtp"</span>);</span><br><span class="line">            <span class="comment">//7、编码格式</span></span><br><span class="line">            javaMailSender.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//8、创建连接对象，连接到邮箱服务器</span></span><br><span class="line">            Properties mailProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">            <span class="comment">//发送服务器需要身份验证,要采用指定用户名密码的方式去认证</span></span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.auth"</span>, <span class="keyword">true</span>);</span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.starttls.enable"</span>, <span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//9、添加连接对象到邮件对象中</span></span><br><span class="line">            javaMailSender.setJavaMailProperties(mailProperties);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//10、创建</span></span><br><span class="line">            <span class="comment">//可以发送几封邮件:可以这里 for循环多次</span></span><br><span class="line">                MimeMessage mimeMessage = getMimeMessage(toEmail,subject,text, javaMailSender);</span><br><span class="line">                <span class="comment">//11、发送邮件</span></span><br><span class="line">                javaMailSender.send(mimeMessage);</span><br><span class="line">                logger.info(<span class="string">"发送 第"</span>+ count + <span class="string">"封邮件"</span> );</span><br><span class="line">                count ++;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            logger.info(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送异常"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//声明一个Message对象(代表一封邮件),从session中创建</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MimeMessage <span class="title">getMimeMessage</span><span class="params">(String toEmail,String subject,String text, JavaMailSenderImpl javaMailSender)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        MimeMessage mimeMessage = javaMailSender.createMimeMessage();</span><br><span class="line"> </span><br><span class="line">        MimeMessageHelper mimeMessageHelper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage, <span class="keyword">true</span>, <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">//发件人</span></span><br><span class="line">        mimeMessageHelper.setFrom(emailConfig.getSenderName());</span><br><span class="line">        <span class="comment">//收件人  : 可以发送给多个收件人，该方法有一个重载的 数组形参</span></span><br><span class="line">        mimeMessageHelper.setTo(toEmail);</span><br><span class="line"><span class="comment">//        mimeMessage.setContent();</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//邮件主题</span></span><br><span class="line">        mimeMessageHelper.setSubject(subject);</span><br><span class="line">        <span class="comment">//邮件内容</span></span><br><span class="line">        mimeMessageHelper.setText(text, <span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> mimeMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（9）在（5）中的接口接收注册参数并写入数据库后，进行激活邮件的发送 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//调用业务层处理数据</span></span><br><span class="line">userService.addUser(user);</span><br></pre></td></tr></table></figure>

<p><strong>UserServiceimpl.java</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将数据存入到数据库</span></span><br><span class="line">	Integer integer = userMapper.addUser(user);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//发送一封激活邮件</span></span><br><span class="line">	mailUtils.sendMail(<span class="string">"18620307785@163.com"</span>,user.getCode(),<span class="string">"来自邮箱测试接口邮件"</span>,<span class="string">"&lt;h1&gt;来自wto网站激活邮件，激活请点击以下链接：&lt;/h1&gt;&lt;h3&gt;&lt;a href='http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"'&gt;http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"&lt;/a&gt;&lt;/h3&gt;"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> integer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整 业务层代码：</p>
<p><strong>UserService.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;User&gt; <span class="title">getAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Integer <span class="title">addUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">User <span class="title">findByCode</span><span class="params">(String code)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>UserServiceImpl.java</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MailUtils mailUtils;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> userMapper.selectAll();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">//将数据存入到数据库</span></span><br><span class="line">		Integer integer = userMapper.addUser(user);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">//发送一封激活邮件</span></span><br><span class="line">		mailUtils.sendMail(<span class="string">"18620307785@163.com"</span>,user.getCode(),<span class="string">"来自邮箱测试接口邮件"</span>,<span class="string">"&lt;h1&gt;来自wto网站激活邮件，激活请点击以下链接：&lt;/h1&gt;&lt;h3&gt;&lt;a href='http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"'&gt;http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"&lt;/a&gt;&lt;/h3&gt;"</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> integer;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">findByCode</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> userMapper.findByCode(code);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		userMapper.updateUser(user);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（10）UserMapper.java 和 UserMapper.xml </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function">List&lt;User&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Integer <span class="title">addUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function">User <span class="title">findByCode</span><span class="params">(@Param(<span class="string">"code"</span>)</span> String code)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">	select *</span><br><span class="line">	from</span><br><span class="line">	user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"addUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.entities.User"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">keyProperty</span>=<span class="string">"id"</span> &gt;</span></span><br><span class="line">	INSERT INTO user (</span><br><span class="line">		username,</span><br><span class="line">		password,</span><br><span class="line">		nickname,</span><br><span class="line">		email,</span><br><span class="line">		state,</span><br><span class="line">		code</span><br><span class="line">	)</span><br><span class="line">	VALUES</span><br><span class="line">		(</span><br><span class="line">			#&#123;username&#125;,</span><br><span class="line">			#&#123;password&#125;,</span><br><span class="line">			#&#123;nickname&#125;,</span><br><span class="line">			#&#123;email&#125;,</span><br><span class="line">			#&#123;state&#125;,</span><br><span class="line">			#&#123;code&#125;</span><br><span class="line">		)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByCode"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">resultType</span>=<span class="string">"com.entities.User"</span>&gt;</span></span><br><span class="line">	SELECT</span><br><span class="line">		*</span><br><span class="line">	FROM</span><br><span class="line">		user u</span><br><span class="line">	WHERE</span><br><span class="line">		u. CODE = #&#123;code&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.entities.User"</span>&gt;</span></span><br><span class="line">	UPDATE user</span><br><span class="line">	<span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"set"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null"</span>&gt;</span></span><br><span class="line">			username=#&#123;username&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span></span><br><span class="line">			password=#&#123;password&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickname != null"</span>&gt;</span></span><br><span class="line">			nickname=#&#123;nickname&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"email!=null"</span>&gt;</span></span><br><span class="line">			email=#&#123;email&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">			state=#&#123;state&#125;,</span><br><span class="line">			code=#&#123;code&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">	WHERE uid=#&#123;uid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（11）创建用户激活接口： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 用户激活的 接口</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/regist_web/activateServlet"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">activateServlet</span><span class="params">(@RequestParam(<span class="string">"code"</span>)</span>String  code,</span></span><br><span class="line"><span class="function">                           HttpServletRequest request,HttpServletResponse response)  </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            User user = userService.findByCode(code);</span><br><span class="line">            <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">//已经查询到，修改用户的状态</span></span><br><span class="line">                user.setState(<span class="number">1</span>);<span class="comment">//已经激活</span></span><br><span class="line">                user.setCode(<span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">//激活后修改用户的激活码及状态</span></span><br><span class="line">                userService.updateUser(user);</span><br><span class="line">                map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">                map.put(<span class="string">"message"</span>, <span class="string">"您的激活码已激活!请去登录"</span>);</span><br><span class="line"> </span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//根据激活码没有查询到该用户</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">                map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">                map.put(<span class="string">"message"</span>, <span class="string">"您的激活码有误!请重新激活"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            map.put(<span class="string">"state"</span>,<span class="string">"1"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"發送失敗"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结：</strong> </p>
<blockquote>
<p>发送激活邮件正文，正文内容使用 html 的语法进行修饰，用户邮箱POP3接受到邮件后会自动根据标签及样式进行解析。</p>
<p>激活邮件的原理：</p>
<p>发送邮件给用户，用户根据接收到的邮件的连接点击并跳转到对应的controller请求接口执行code验证码查询到用户，并根据当前激活码的作用对用户执行激活账户、业务等操作！！！</p>
</blockquote>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-JSP-email" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot功能篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot功能（二）定制 starter 启动器</title>
    <url>/2020/03/08/SpringBoot%E5%8A%9F%E8%83%BD%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AE%9A%E5%88%B6%20starter%20%E5%90%AF%E5%8A%A8%E5%99%A8/</url>
    <content><![CDATA[<p>在实际项目开发中，我们常常会用到各种各样的 starter，这些starter 有的是有 springboot官方提供并已经整合一些基本功能的，如：<strong>spring-boot-starter，</strong>也有一些是由 第三方将框架与<strong>springboot</strong>进行定制整合后提供给我们进行快捷高效开发的，如：<strong>MyBatis-Spring-Boot-Starter。</strong></p>
<p>在日常开发中，由于项目的要求以及高效开发、部署等，我们可以对springboot进行私有定制，生成自己需要的启动器，再引入到实际项目中，提高开发的效率。</p>
<p>举例： 我们在<strong>springboot</strong> 中使用 <strong>redis</strong> 的 <strong>java</strong>控件<strong>jedis</strong> 时，需要 进行创建  <strong>Jedis</strong> 的实例并传入相应参数如  <strong>ip</strong> 、<strong>port</strong> 等，在使用<strong>springboot</strong>后，可以进行定制化<strong>starter</strong>，将<strong>Jedis</strong> 用<strong>ip</strong>、<strong>port</strong> 进行实例化，并将 <strong>Bean</strong> 注入容器由 <strong>SpringBoot</strong> 进行管理，制成启动器。</p>
<p>在需要使用到 <strong>redis</strong> 功能的工程项目中引入该启动器，这样就能够提高开发的效率。</p>
<p>正规的<strong>starter</strong>是一个独立的工程，然后在<strong>maven</strong>中新仓库注册发布，其他开发人员就可以使用你的<strong>starter</strong>了。</p>
<p>以下实现一个针对 <strong>redis</strong> 的 定制器 <strong>starter</strong>。 </p>
<h3 id="一、新建一个maven项目spring-boot-starter-redis-（启动器）"><a href="#一、新建一个maven项目spring-boot-starter-redis-（启动器）" class="headerlink" title="一、新建一个maven项目spring-boot-starter-redis （启动器）"></a>一、新建一个maven项目spring-boot-starter-redis （启动器）</h3><p>引入如下依赖： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!--自动配置依赖--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="二、在此项目中编写-RedisProperties-class-，用以从-application-properties-中读取-redis-的配置信息"><a href="#二、在此项目中编写-RedisProperties-class-，用以从-application-properties-中读取-redis-的配置信息" class="headerlink" title="二、在此项目中编写 RedisProperties.class ，用以从 application.properties 中读取 redis 的配置信息"></a>二、在此项目中编写 RedisProperties.class ，用以从 application.properties 中读取 redis 的配置信息</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.properties;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> JedisProperties</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/2/2 18:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"jedis"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三、在此项目中编写RedisAutoConfiguration-class，用以将-Jedis-的bean-装载进-spring-容器中"><a href="#三、在此项目中编写RedisAutoConfiguration-class，用以将-Jedis-的bean-装载进-spring-容器中" class="headerlink" title="三、在此项目中编写RedisAutoConfiguration.class，用以将 Jedis 的bean 装载进 spring 容器中"></a>三、在此项目中编写RedisAutoConfiguration.class，用以将 Jedis 的bean 装载进 spring 容器中</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.autoConfigure;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.demo.properties.RedisProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> JedisAutoConfigure</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/2/2 18:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Jedis<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(</span>&#123;RedisProperties<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(</span>&#123;RedisProperties<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Jedis <span class="title">Jedis</span><span class="params">(RedisProperties redisProperties)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//spring会自动将RedisProperties这个bean注入进来，</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Jedis(redisProperties.getHost(),redisProperties.getPort(),<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为大家解释一下这些注解的含义</p>
<table>
<thead>
<tr>
<th>@SpringBootConfiguration：</th>
<th>代表这是一个配置类</th>
</tr>
</thead>
<tbody><tr>
<td>@EnableConfigurationProperties (RedisProperties.class)：</td>
<td>将RedisProperties加载到spring容器中。参考Spring-Boot之@Enable*注解的工作原理</td>
</tr>
<tr>
<td>@ConditionalOnClass(Jedis.class)：</td>
<td>当项目引用了Jedis的jar时，才加载此配置类。参考Spring-Boot autoconfigure之Condition</td>
</tr>
</tbody></table>
<h3 id="四、在此项目中resource目录下新建-application-properties-文件"><a href="#四、在此项目中resource目录下新建-application-properties-文件" class="headerlink" title="四、在此项目中resource目录下新建 application.properties 文件"></a>四、在此项目中resource目录下新建 application.properties 文件</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">redis.host=127.0.0.1</span><br><span class="line">redis.port=6379</span><br></pre></td></tr></table></figure>

<h3 id="五、Bean-注入方式："><a href="#五、Bean-注入方式：" class="headerlink" title="五、Bean 注入方式："></a>五、Bean 注入方式：</h3><h4 id="第一种：自动注入，创建-依赖配置-spring-factories"><a href="#第一种：自动注入，创建-依赖配置-spring-factories" class="headerlink" title="第一种：自动注入，创建 依赖配置 spring.factories"></a>第一种：自动注入，创建 依赖配置 spring.factories</h4><p>在resource 目录下新建 META-INF 目录，并在该目录下创建 spring.factories 文件，在文件添加以下数据：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration =com.example.demo.autoConfigure.RedisAutoConfiguration</span><br></pre></td></tr></table></figure>

<p>当前数据用于将加载生成的Bean 交给当前启动器所在的容器进行管理，并在被引入到具体的工程项目时被项目中的容器所扫描到而调用。 </p>
<h4 id="第二种：手动注入，创建EnableRedis类"><a href="#第二种：手动注入，创建EnableRedis类" class="headerlink" title="第二种：手动注入，创建EnableRedis类"></a>第二种：手动注入，创建<strong>EnableRedis</strong>类</h4><p>根据<strong>@Import</strong>注解 的作用进行切面配置，手动添加到 工程项目启动类 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(RedisAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableRedis</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用方式：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableRedis</span><span class="comment">//关键的一步</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlogApplication</span> </span>&#123;</span><br><span class="line">......    </span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="六、新建Blog-工程项目，引入-spring-boot-starter-redis-依赖"><a href="#六、新建Blog-工程项目，引入-spring-boot-starter-redis-依赖" class="headerlink" title="六、新建Blog 工程项目，引入 spring-boot-starter-redis 依赖"></a>六、新建Blog 工程项目，引入 spring-boot-starter-redis 依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="七、在Blog项目中，编写启动类BlogApplication"><a href="#七、在Blog项目中，编写启动类BlogApplication" class="headerlink" title="七、在Blog项目中，编写启动类BlogApplication"></a>七、在Blog项目中，编写启动类BlogApplication</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> BlogApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/2/2 23:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlogApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(BlogApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        Jedis jedis = context.getBean(Jedis<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(jedis);</span><br><span class="line">        <span class="comment">//如果成功连接上了redis，jedis.ping()会返回一个pong</span></span><br><span class="line">        System.out.println(jedis.ping());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="八、启动redis"><a href="#八、启动redis" class="headerlink" title="八、启动redis"></a>八、启动redis</h3><p><strong>启动虚拟机或云服务器的redis</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@wsp &#x2F;]# redis-server &#x2F;etc&#x2F;redis.conf </span><br><span class="line">[root@wsp &#x2F;]# redis-cli</span><br></pre></td></tr></table></figure>

<p>先启动 <strong>Spring-boot-starter-redis</strong> 启动器 ，再启动具体的项目工程 <strong>spring-boot-starter-apps</strong> </p>
<img src="http://photo.wushaopei.com/qiniu60.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/springboot-starter" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot功能篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（六）集成timer 定时任务</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E5%85%AD%EF%BC%89%E9%9B%86%E6%88%90timer-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="1、创建具体要执行的任务类"><a href="#1、创建具体要执行的任务类" class="headerlink" title="1、创建具体要执行的任务类"></a>1、创建具体要执行的任务类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.timer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.TimerTask;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MyTimeTask</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 15:55</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTimeTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(MyTimeTask<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTimeTask</span><span class="params">(String inputName)</span></span>&#123;</span><br><span class="line">        name = inputName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//打印当前name 的内容</span></span><br><span class="line">        System.out.println(<span class="string">"Current exec name is "</span> + name);</span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">"111"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>run（）</strong>方法中是要执行的任务代码，定时器启动时会执行 <strong>run()</strong> 方法中的业务逻辑 ; </p>
<h3 id="2、创建-timer-的-实例工作类"><a href="#2、创建-timer-的-实例工作类" class="headerlink" title="2、创建 timer 的 实例工作类"></a>2、创建 timer 的 实例工作类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.timer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.Trigger;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.sql.Time;</span><br><span class="line"><span class="keyword">import</span> java.util.Timer;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MyTimer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 15:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTimer</span> </span>&#123;</span><br><span class="line"><span class="comment">//    public static void main(String[] args) &#123;</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuartzTrigger1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.创建一个timer实例</span></span><br><span class="line">        Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line">        <span class="comment">//2.创建一个MyTimerTask实例</span></span><br><span class="line">        MyTimeTask myTimeTask = <span class="keyword">new</span> MyTimeTask(<span class="string">"No.1"</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//3.通过timer定时定频率调用myTimerTask的业务逻辑</span></span><br><span class="line">        <span class="comment">// 即 第一次执行是在当前时间的两秒之后，之后每隔一秒钟执行一次\</span></span><br><span class="line">        timer.schedule(myTimeTask,<span class="number">2000L</span>,<span class="number">1000L</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加<strong>@Configuration</strong>  注解，自动注入实例对象，并由<strong>springboot</strong> 启动 定时器，执行任务。</p>
<p>注意： 使用<strong>springboot</strong> 时保证包扫描路径是正确的；</p>
<p><strong>执行效果：</strong></p>
<img src="http://photo.wushaopei.com/qiniu46.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-timer" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（五）集成Lombok 插件</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%BA%94%EF%BC%89%E9%9B%86%E6%88%90Lombok-%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="应用原因："><a href="#应用原因：" class="headerlink" title="应用原因："></a>应用原因：</h3><p><code>为了减少代码量，为当前项目添加 **lombok** 来优雅编码</code></p>
<h3 id="Lombok-插件安装："><a href="#Lombok-插件安装：" class="headerlink" title="Lombok 插件安装："></a>Lombok 插件安装：</h3><h4 id="a-添加依赖"><a href="#a-添加依赖" class="headerlink" title="a . 添加依赖:"></a><strong>a . 添加依赖:</strong></h4><p>在 pom.xml 文件中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span></span><br><span class="line">     </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="b-安装-Lombok-插件"><a href="#b-安装-Lombok-插件" class="headerlink" title="b . 安装 Lombok 插件"></a>b . 安装 Lombok 插件</h4><p><strong>Eclipse:</strong></p>
<pre><code>下载地址：https://projectlombok.org/download
　　将下载的lombok.jar文件，放到eclipse安装路径，该jar包也就是lombok插件的jar文件了
　　打开eclipse.ini文件，添加如下内容：
　　　　-javaagent:lombok.jar
　　　　-Xbootclasspath/a:lombok.jar
 　　　　重启eclipse</code></pre><p><strong>IDEA:</strong></p>
<pre><code>可以在线安装lombok的插件
settings -&gt; plugins -&gt; 在搜索框输入lombok -&gt;  安装</code></pre><p>sts安装Lombok：</p>
<p><a href="https://blog.csdn.net/zhaoxiaohua125/article/details/80211684" target="_blank" rel="noopener">https://blog.csdn.net/zhaoxiaohua125/article/details/80211684</a></p>
<p>Lombok常用注解及原理：</p>
<table>
<thead>
<tr>
<th>@Data</th>
<th>注解在类上</th>
<th>包含了@ToString，@EqualsAndHashCode，@Getter / @Setter和@RequiredArgsConstructor的功能，提供类所有属性的 getter 和 setter 方法，此外还提供了equals、canEqual、hashCode、toString 方法</th>
</tr>
</thead>
<tbody><tr>
<td><strong>@Setter</strong></td>
<td>注解在属性上</td>
<td>为属性提供 setter 方法</td>
</tr>
<tr>
<td><strong>@Getter</strong></td>
<td>注解在属性上</td>
<td>为属性提供 getter 方法</td>
</tr>
<tr>
<td><strong>@ToString</strong></td>
<td>注解在类上</td>
<td>生成toString()方法，默认情况下，它会按顺序（以逗号分隔）打印你的类名称以及每个字段。                 可以这样设置不包含哪些字段<strong>@ToString(exclude = “id”) / @ToString(exclude = {“id”,”name”})</strong>如果继承的有父类的话，可以设置callSuper 让其调用父类的toString()方法，例如：@ToString(callSuper = true)</td>
</tr>
<tr>
<td>@<strong>EqualsAndHashCode</strong></td>
<td>注解在类上</td>
<td>生成hashCode()和equals()方法，默认情况下，它将使用所有非静态，非transient字段。但可以通过在可选的exclude参数中来排除更多字段。或者，通过在parameter参数中命名它们来准确指定希望使用哪些字段。</td>
</tr>
<tr>
<td>@<strong>NonNull</strong></td>
<td>注解在属性上</td>
<td>标识属性是不能为空，为空则抛出异常。</td>
</tr>
<tr>
<td>@<strong>Slf4j</strong></td>
<td>注解在类上</td>
<td>根据用户实际使用的日志框架生成log日志对象。</td>
</tr>
<tr>
<td>@<strong>Log4j</strong></td>
<td>注解在类上</td>
<td>为类提供一个 属性名为log 的 log4j 日志对象</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（四）集成@Scheduled 定时任务</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E5%9B%9B%EF%BC%89%E9%9B%86%E6%88%90-Scheduled-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="1、在SpringBoot-项目中使用-Scheduled注解执行定时任务："><a href="#1、在SpringBoot-项目中使用-Scheduled注解执行定时任务：" class="headerlink" title="1、在SpringBoot 项目中使用@Scheduled注解执行定时任务："></a>1、在SpringBoot 项目中使用<strong>@Scheduled</strong>注解执行定时任务：</h3><p>配置pom.xml 依赖：</p>
<p>一般情况下，SpringBoot 的 相关依赖，如：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>是有包含对应  <strong>@Scheduled 定时注解启动所需要的jar包的，如下：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br></pre></td></tr></table></figure>

<h3 id="2、创建定时类"><a href="#2、创建定时类" class="headerlink" title="2、创建定时类"></a>2、创建定时类</h3><p>（1）@Component ： 将当前类实例化注入到容器中</p>
<p>（2）定时器的生效要素：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Scheduled</span>(cron=<span class="string">"0/5 * *  * * ? "</span>)   <span class="comment">//每5秒执行一次</span></span><br></pre></td></tr></table></figure>

<p>在程序启动时，定时器会开始计时，并根据设定时间执行设置好的任务内容,<strong>线程的执行是以单线程进行</strong>； </p>
<p>（3）创建以下定时类 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartz;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.common.SystemLogHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> HandleTimeQuartz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 20:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandleTimeQuartz</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 系统日志</span></span><br><span class="line">    <span class="comment">//private static SystemLogHandler systemLogger = SystemLogHandler</span></span><br><span class="line">   <span class="comment">//         .getLogger(HandleTimeQuartz.class);</span></span><br><span class="line"> </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(InvoiceController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Scheduled</span>(cron=<span class="string">"0/5 * *  * * ? "</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userStatusJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">"进入测试"</span>);</span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 程序入口处添加注解 </p>
<img src="http://photo.wushaopei.com/qiniu44.png" width="60%">

<p>直接启动后会自动执行：效果如下： </p>
<img src="http://photo.wushaopei.com/qiniu45.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-scheduled" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（三）集成Quartz 定时任务</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%B8%89%EF%BC%89%E9%9B%86%E6%88%90Quartz-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><ul>
<li>将首页所展示的数据存入redis中并且每隔一小时更新一次数据。 </li>
<li>自动结账 ，票务系统或结算系统进行定时拉取票务或消费数据</li>
<li>定时加载POI生成 word、 excel 、PDF等，预先提交申请，定时器定时获取请求信息并后台加载到本地</li>
</ul>
<h3 id="1、在-pom-xml-中-添加-Quartz-所需要-的-依赖"><a href="#1、在-pom-xml-中-添加-Quartz-所需要-的-依赖" class="headerlink" title="1、在 pom.xml 中 添加 Quartz 所需要 的 依赖"></a>1、在 pom.xml 中 添加 Quartz 所需要 的 依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">       <span class="comment">&lt;!--定时器 quartz--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> </p>
<p><code>quartz 只能基于 springboot 的 parent 2.0 以上 版本 才能使用过，低于2.0 的版本无法加载到 quartz 的pom依赖包</code></p>
<h3 id="2、创建要执行的任务类："><a href="#2、创建要执行的任务类：" class="headerlink" title="2、创建要执行的任务类："></a>2、创建要执行的任务类：</h3><p> TestTask1  与  TestTask2 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartzHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> TestTask1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 12:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTask1</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        System.out.println(<span class="string">"TestQuartz01----"</span> + sdf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartzHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> TestTask2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 12:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTask2</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        System.out.println(<span class="string">"TestQuartz02----"</span> + sdf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、定时器（执行类）："><a href="#3、定时器（执行类）：" class="headerlink" title="3、定时器（执行类）："></a>3、定时器（执行类）：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartzHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> QuartzConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 12:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(QuartzConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//    testTask1使用的固定间隔方式，testTask2使用的是cron表达式方式。</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">testQuartz1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        return JobBuilder.newJob(TestTask1.class).withIdentity("testTask1").storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">testQuartzTrigger1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//5秒执行一次</span></span><br><span class="line">        SimpleScheduleBuilder scheduleBuilder = SimpleScheduleBuilder.simpleSchedule()</span><br><span class="line">                .withIntervalInSeconds(<span class="number">5</span>)</span><br><span class="line">                .repeatForever();</span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(testQuartz1())</span><br><span class="line">                .withIdentity(<span class="string">"testTask1"</span>)</span><br><span class="line">                .withSchedule(scheduleBuilder)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">testQuartz2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        return JobBuilder.newJob(TestTask2.class).withIdentity("testTask2").storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">testQuartzTrigger2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//cron方式，每隔5秒执行一次</span></span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(testQuartz2())</span><br><span class="line">                .withIdentity(<span class="string">"testTask2"</span>)</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">"*/5 * * * * ?"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu43.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-quartz" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot原理（一）自启动原理</title>
    <url>/2020/03/07/SpringBoot%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89%E8%87%AA%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a><strong>引言</strong></h3><p>​    不论在工作中，亦或是求职面试，Spring Boot 已经成为我们必知必会的技能项。除了比较老旧的政府项目或金融项目依旧使用如 SSM 或 SSH 做单体框架开发项目外，如今的各行各业基于项目的快速开发与发布、迭代更新，都在逐渐替换使用 Spring Boot 框架，而逐步摒弃配置沉重和效率低下的 Spring 启动框架。</p>
<p>​    使用一门新的技术，立足于对它足够了解的基础上，能够让你更加得心应手的去进行应用、开发。SpringBoot 的精髓 “自动配置原理” 不仅仅是在面试过程中才用的上；在工作中如果能深入理解Spring Boot 的自动配置原理，我们就可以根据自己的需求自定义一个 started 满足开发的需求，让开发更加便捷与高效。</p>
<p>​    Spring Boot的出现，得益于“习惯优于配置”的理念，没有繁琐的配置、难以集成的内容（大多数流行第三方技术都被集成），这是基于Spring 4.x提供的按条件配置Bean的能力。</p>
<p><strong>本篇博文主要针对三个方面进行分析、讲解；这三个方面分别是：</strong></p>
<blockquote>
<h5 id="Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？"><a href="#Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？" class="headerlink" title="Spring Boot 与 Spring 的差别与优点？以及与Spring MVC 的关系？"></a>Spring Boot 与 Spring 的差别与优点？以及与Spring MVC 的关系？</h5><p>Spring Boot 主启动类的启动机制<br>Spring Boot 的自动配置原理是怎么实现的？<br>根据自动配置原理自定义一个 个性的 started ？</p>
</blockquote>
<h3 id="1、Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？"><a href="#1、Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？" class="headerlink" title="1、Spring Boot 与 Spring 的差别与优点？以及与Spring MVC 的关系？"></a>1、<strong>Spring Boot</strong> 与 <strong>Spring</strong> 的差别与优点？以及与Spring MVC 的关系？</h3><h4 id="1-1-Spring-Boot-和-Spring-MVC-的关系？"><a href="#1-1-Spring-Boot-和-Spring-MVC-的关系？" class="headerlink" title="1.1 Spring Boot 和 Spring MVC 的关系？"></a>1.1 Spring Boot 和 Spring MVC 的关系？</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Spring MVC 是基于Spring 的MVC框架；</span><br><span class="line"></span><br><span class="line">而Spring Boot 是基于Spring 配置的开发工具框架，使用注解更加简洁和适应快速开发。</span><br></pre></td></tr></table></figure>

<h4 id="1-2-Spring-Boot-的优势"><a href="#1-2-Spring-Boot-的优势" class="headerlink" title="1.2 Spring Boot 的优势"></a>1.2 Spring Boot 的优势</h4><p><strong>简单来说：</strong>Spring boot 简化了使用 Spring 的难度，简省了繁重的配置，提供了各种启动器，开发者能快速上手。</p>
<p><strong>（1）编码更简单</strong></p>
<pre><code>Spring 框架由于超重量级的 XML，annotation 配置，使得系统变得很笨重，难以维护
SpringBoot 采用约点大于配置的方法，直接引入依赖，即可实现代码的开发</code></pre><p><strong>（2）配置更简单</strong></p>
<img src="http://photo.wushaopei.com/qiniu29.png" width="60%">

<p><strong>Xml</strong>文件使用<strong>javaConfig</strong>代替，<strong>XML</strong>中<strong>bean</strong>的创建，使用@<strong>bean</strong>代替后可以直接注入。</p>
<p>配置文件变少很多，只保留 <strong>application</strong>.<strong>yml</strong></p>
<p><strong>（3）部署更简单</strong> </p>
<img src="http://photo.wushaopei.com/qiniu30.png" width="60%">

<p><strong>（4）监控更简单</strong> </p>
<blockquote>
<ul>
<li>Spring-boot-start-actuator:</li>
<li>可以查看属性配置</li>
<li>线程工作状态</li>
<li>环境变量</li>
<li>JVM性能监控</li>
</ul>
</blockquote>
<h3 id="2、Spring-Boot-主启动类的启动机制"><a href="#2、Spring-Boot-主启动类的启动机制" class="headerlink" title="2、Spring Boot 主启动类的启动机制"></a>2、<strong>Spring Boot</strong> 主启动类的启动机制</h3><p><strong>关于程序的入口问题：</strong></p>
<p>在使用<strong>SSM</strong>或<strong>SSH</strong>以及原生的<strong>Servlet</strong> 作为架构的项目中，项目的入口都不是 <strong>main</strong> 方法，<strong>main</strong> 方法更多的是作为 <strong>HelloWorld</strong> 练习或 测试时使用。其程序的入口基本都是<strong>handler</strong> 中对外暴露的每个接口：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;listarea&quot;,method &#x3D; RequestMethod.GET)</span><br><span class="line">  private Map&lt;String,Object&gt; listArea()&#123;</span><br><span class="line">      HashMap&lt;String, Object&gt; modelMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">      List&lt;Area&gt; list &#x3D; areaService.getAreaList();</span><br><span class="line">      modelMap.put(&quot;areaList&quot;,list);</span><br><span class="line">      ArrayList arrayList &#x3D; new ArrayList();</span><br><span class="line">      return  modelMap;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>外部通过对接口地址的调用，从而实现交互获取数据、进行页面渲染和展示。</p>
<p>但是，在使用了 <strong>Spring Boot</strong> 后， <strong>Main</strong> 方法又成为了程序的入口；</p>
<p>使用过<strong>springBoot</strong>进行项目打包和部署启动的都知道， <strong>SpringBoot</strong> 打包成 <strong>jar</strong> 包后，可以不需要部署到<strong>Tomcat</strong> 上而直接用命令启动，<strong>如下</strong>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar xxx.jar</span><br></pre></td></tr></table></figure>

<p>这是因为<strong>Spring Boot</strong> 的<strong>jar</strong> 在启动时，程序经过 主启动类中的<strong>main</strong> 方法进行启动的；<strong>主启动</strong>类代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里为项目创建一个接口，并分别在接口和主启动类<strong>main</strong>方法上打断点， </p>
<img src="http://photo.wushaopei.com/qiniu31.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu32.png" width="60%">

<p>在<strong>Spring Boot</strong> 项目中每次调用接口前都会先启动 主启动类，这里对主启动类的 <strong>main</strong> 方法入口进行分析；</p>
<p>在上图中，主启动类启动后会进入<strong>main</strong> 方法中，并在方法中由 <strong>SpringApplication</strong> 调用 <strong>run （）</strong>方法，方法中形参传入当前类的 <strong>class</strong> 对象以及<strong>main</strong> 方法的 <strong>args</strong>  参数。</p>
<p>下一步进入 <strong>run()</strong> 方法中，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Object source, String... args)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> run(<span class="keyword">new</span> Object[]&#123;source&#125;, args);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu33.png" width="60%">

<p>由截图可知，传入的<strong>class</strong> 对象被用来创建 <strong>SpringApplication</strong>实例对象，并由生成的实例调用 <strong>run （args）</strong> 方法做启动操作，方法形参为 <strong>args</strong> 参数。</p>
<p><strong>①创建 SpringApplication 实例，进行初始化对象：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> SpringApplication ( Object... sources)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(Object... sources)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">this</span>.bannerMode = Mode.CONSOLE;</span><br><span class="line">      <span class="keyword">this</span>.logStartupInfo = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.addCommandLineProperties = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.headless = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.registerShutdownHook = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.additionalProfiles = <span class="keyword">new</span> HashSet();</span><br><span class="line">      <span class="keyword">this</span>.initialize(sources);   <span class="comment">// 初始化启动类</span></span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在 该构造函数的 方法体中，对当前类进行了初始化， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Object[] sources)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">if</span> (sources != <span class="keyword">null</span> &amp;&amp; sources.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">this</span>.sources.addAll(Arrays.asList(sources));   <span class="comment">// 添加启动类 DemoApplication.class 到 set 集合中，以备后用</span></span><br><span class="line">         </span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">this</span>.webEnvironment = <span class="keyword">this</span>.deduceWebEnvironment();  <span class="comment">// 重点：检测当前是否为 web 环境      </span></span><br><span class="line">                                                     <span class="keyword">this</span>.setInitializers(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">  </span><br><span class="line">     <span class="keyword">this</span>.setListeners(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationListener<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">this</span>.mainApplicationClass = <span class="keyword">this</span>.deduceMainApplicationClass();</span><br><span class="line">    </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu34.png" width="60%">

<p>上图中的 webEnvironment 用于检测当前环境是否为 web 环境，如果是，则返回true.</p>
<p>具体如何判断当前环境是否为 web 环境，后面再做分析.</p>
<p><strong>获取初始化器：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu35.png" width="60%">

<p>在确定是否为web环境后，会根据 <strong>ApplicationContextInitializer</strong>.<strong>class</strong> 获取<strong>工厂实例参数</strong>从而<strong>设置初始化器的参数</strong>；</p>
<p>随后 用<strong>setListeners</strong> 设置监听器</p>
<img src="http://photo.wushaopei.com/qiniu36.png" width="60%">

<p>判断并获取主启动类的类型，通过获取jvm运行时的栈（StackTraceElement[]）中的多个加载的类，判断类中方法是否符合  <strong>main</strong> 方法 的类即为当前启动类，</p>
<img src="http://photo.wushaopei.com/qiniu37.png" width="60%">

<p>   到这里，<strong>SpringApplication</strong> 的初始化过程就执行完毕了；此时的<strong>SpringApplication</strong> 实例的启动需要调用<strong>run()</strong> 方法来实现，下一节进行分析；</p>
<p>以下是初始化过程的重要环节的关系图：    </p>
<img src="http://photo.wushaopei.com/qiniu38.png" width="60%">

<p>判断当前环境是否为 web 环境： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.webEnvironment = <span class="keyword">this</span>.deduceWebEnvironment();  <span class="comment">// 重点：检测当前是否为 web 环境</span></span><br></pre></td></tr></table></figure>

<p>我们进入 deduceWebEnvironment（）方法去看一看， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deduceWebEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    String[] var1 = WEB_ENVIRONMENT_CLASSES;</span><br><span class="line">    <span class="keyword">int</span> var2 = var1.length;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> var3 = <span class="number">0</span>; var3 &lt; var2; ++var3) &#123;</span><br><span class="line">        </span><br><span class="line">        String className = var1[var3];</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, (ClassLoader)<span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由源码可知， deduceWebEnvironment 中对 私有变量 <strong>WEB_ENVIRONMENT_CLASSES</strong>进行了循环，继续查看它所代表的是什么？ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] WEB_ENVIRONMENT_CLASSES = <span class="keyword">new</span> String[]&#123;<span class="string">"javax.servlet.Servlet"</span>, <span class="string">"org.springframework.web.context.ConfigurableWebApplicationContext"</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>该私有变量数组有两个参数构成，第一个参数是 “javax.servlet.Servlet”，第二个参数是  “ConfigurableWebApplicationContext”，这里对“ConfigurableWebApplicationContext”进行分析： </p>
<img src="http://photo.wushaopei.com/qiniu39.png" width="60%">

<p>进入ConfigurableWebApplicationContext类中，我们看到该类继承自 WebApplicationContext 和 ConfigurableApplicationContext两个类，再往下看：</p>
<img src="http://photo.wushaopei.com/qiniu40.png" width="60%">

<p>我们看到 WebApplicationContext 继承自 ApplicationContext 类，而我们知道 ApplicationContext 是可以用来创建IOC 容器的对象的，如： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicatioonContext context = <span class="keyword">new</span> ClasspathXmlApplicationContext();</span><br></pre></td></tr></table></figure>

<p>该ApplicationContext类是所有IOC 容器对象的顶级接口</p>
<p>阶段小结：<strong>ConfigurableWebApplicationContext</strong> 是 <strong>web</strong> 环境下可以配置的IOC 容器。</p>
<p>那么拿到该类的全类名有什么用呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ClassUtils.isPresent(className, (ClassLoader)<span class="keyword">null</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPresent</span><span class="params">(String className, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        forName(className, classLoader);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 deduceWebEnvironment 方法中调用了 isPresent 方法，而在isPresent方法中有调用 forName ,将全类名 className 作为形参传入 forName中，此处的 classLoader 是null值。</p>
<p>这里进入 ClassUtils的forName（）方法中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String name, ClassLoader classLoader) <span class="keyword">throws</span> ClassNotFoundException, LinkageError &#123;</span><br><span class="line">    </span><br><span class="line">        Assert.notNull(name, <span class="string">"Name must not be null"</span>);</span><br><span class="line">    </span><br><span class="line">        Class&lt;?&gt; clazz = resolvePrimitiveClassName(name);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            clazz = (Class)commonClassCache.get(name);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Class elementClass;</span><br><span class="line">            String elementName;</span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(<span class="string">"[]"</span>)) &#123;</span><br><span class="line">                elementName = name.substring(<span class="number">0</span>, name.length() - <span class="string">"[]"</span>.length());</span><br><span class="line">                elementClass = forName(elementName, classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(elementClass, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">"[L"</span>) &amp;&amp; name.endsWith(<span class="string">";"</span>)) &#123;</span><br><span class="line">                elementName = name.substring(<span class="string">"[L"</span>.length(), name.length() - <span class="number">1</span>);</span><br><span class="line">                elementClass = forName(elementName, classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(elementClass, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">"["</span>)) &#123;</span><br><span class="line">                elementName = name.substring(<span class="string">"["</span>.length());</span><br><span class="line">                elementClass = forName(elementName, classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(elementClass, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ClassLoader clToUse = classLoader;</span><br><span class="line">                <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clToUse = getDefaultClassLoader();</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> clToUse != <span class="keyword">null</span> ? clToUse.loadClass(name) : Class.forName(name);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var9) &#123;</span><br><span class="line">                    <span class="keyword">int</span> lastDotIndex = name.lastIndexOf(<span class="number">46</span>);</span><br><span class="line">                    <span class="keyword">if</span> (lastDotIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                        String innerClassName = name.substring(<span class="number">0</span>, lastDotIndex) + <span class="string">'$'</span> + name.substring(lastDotIndex + <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> clToUse != <span class="keyword">null</span> ? clToUse.loadClass(innerClassName) : Class.forName(innerClassName);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ClassNotFoundException var8) &#123;</span><br><span class="line">                            ;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">throw</span> var9;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中的   Class&lt;?&gt; clazz = resolvePrimitiveClassName(name); 根据全类名获取class 字节码文件对象；在获取到的class 对象不为null 的情况下，clazz = (Class)commonClassCache.get(name); 获取常用类缓存中是否也存在该class对象；</p>
<p>如果两次获取的 clazz 都不为null是存在的，那么就直接返回：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br></pre></td></tr></table></figure>

<p>由此我们可以知道,<strong>isPresent</strong>()方法的作用，是为了查看当前环境中有没有指定的工程项目的类。</p>
<p>从这里，我们可以做出总结，<strong>deduceWebEnvironment</strong> () 方法中通过判断 “<strong>WEB_ENVIRONMENT_CLASSES</strong>”数组中声明的两个类能否在当前环境中找到，如果能，说明当前环境为web 环境。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] WEB_ENVIRONMENT_CLASSES = <span class="keyword">new</span> String[]&#123;<span class="string">"javax.servlet.Servlet"</span>, <span class="string">"org.springframework.web.context.ConfigurableWebApplicationContext"</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>② <strong>SpringApplication</strong>实例的启动过程：</p>
<p>在获取到SpringApplication的实例并初始化完成后，其启动使用<strong>run()</strong> 方法实现，</p>
<img src="http://photo.wushaopei.com/qiniu41.png" width="80%">

<p>进入 run(args）方法中， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">        FailureAnalyzers analyzers = <span class="keyword">null</span>;   <span class="comment">// 失败分析器</span></span><br><span class="line">        <span class="keyword">this</span>.configureHeadlessProperty();    <span class="comment">// 读取property 文件</span></span><br><span class="line">        SpringApplicationRunListeners listeners = <span class="keyword">this</span>.getRunListeners(args); <span class="comment">// 加载监听器</span></span><br><span class="line">        listeners.starting();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);       <span class="comment">// 应用参数</span></span><br><span class="line">            ConfigurableEnvironment environment = <span class="keyword">this</span>.prepareEnvironment(listeners, applicationArguments);                   <span class="comment">// 配置文件参数（有默认值，可读取自定义配置文件），用于配置当前环境</span></span><br><span class="line">            Banner printedBanner = <span class="keyword">this</span>.printBanner(environment);   <span class="comment">// banner的自定义机制</span></span><br><span class="line">            context = <span class="keyword">this</span>.createApplicationContext();              <span class="comment">// 创建可配置的 IOC 容器</span></span><br><span class="line">            <span class="keyword">new</span> FailureAnalyzers(context);                          <span class="comment">// 传入配置好的 IOC 容器 创建失败分析器对象</span></span><br><span class="line">            <span class="keyword">this</span>.prepareContext(context, environment, listeners, applicationArguments, printedBanner);                              <span class="comment">// 传入失败分析器，环境参数、监听器、banner 配置等进行刷新</span></span><br><span class="line">            <span class="keyword">this</span>.refreshContext(context);                          <span class="comment">// 根据ioc 刷新上下文容器，并打印日志 ，此时TOMCAT / JETTY 容器会被启动</span></span><br><span class="line">            <span class="keyword">this</span>.afterRefresh(context, applicationArguments);      <span class="comment">// 映射 dispatcherServlet 等</span></span><br><span class="line">            listeners.finished(context, (Throwable)<span class="keyword">null</span>);          <span class="comment">// 监听IOC容器上下文</span></span><br><span class="line">            stopWatch.stop();                                       <span class="comment">// 计时结束</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">                (<span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)).logStarted(<span class="keyword">this</span>.getApplicationLog(), stopWatch);</span><br><span class="line">            &#125; <span class="comment">// 停止打印日志</span></span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> context;        <span class="comment">// 返回启动成功的结果，以及返回启动消耗的时间</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handleRunFailure(context, listeners, (FailureAnalyzers)analyzers, var9);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var9);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里先从  stopWatch 开始说，在run（） 方法中，一开始创建了 StopWatch的对象实例，并调用 start() 进行启动， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">stopWatch.start();</span><br><span class="line">    </span><br><span class="line">。。。。</span><br><span class="line">stopWatch.stop();</span><br></pre></td></tr></table></figure>

<p>这里的 stopWatch 是一个观察用的表，springboot项目启动后返回的启动花费了多少秒、分的时间就是由 stopWatch() 来提供的。 </p>
<img src="http://photo.wushaopei.com/qiniu42.png" width="80%">

<p>总结： 在public ConfigurableApplicationContext run(String… args)方法中，最终返回的是自定义配置的IOC容器。</p>
<p>到这里，SpringBoot 的主启动类 Main 方法的初始化和启动过程就结束了。</p>
<p>③ 包扫描；</p>
<p>我们知道 Spring 中IOC通过 依赖注入和控制反转将被调用者Bean的创建交给<strong>Spring</strong> 代理生成，并注入到IOC容器中；而在<strong>SpringBoot</strong>中， 接口的调用必须基于<strong>SpringBoot</strong> 主启动类的同级包或子包范围内；</p>
<p>规范化的开发中需要指定好 <strong>Handler</strong> 和 <strong>dao</strong> 层的包位置，分别指定的包扫描方式为：</p>
<p><strong>控制器与业务层 :</strong></p>
<p><strong>自动扫描：</strong>  主要针对 <strong>@Controller、@Service</strong> 标注的类，该类所在包必须为主启动类所在包的子包；</p>
<p><strong>手动指定扫描：</strong>在主启动类上使用<strong>@CompomentScan(“com.mmall.handler”)</strong> 注解</p>
<p><strong>持久层：</strong> </p>
<p>方式一：使用@MapperScan</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@MapperScan(&quot;com.mmall.demo.dao&quot;)标记在主启动类上</span><br></pre></td></tr></table></figure>

<p>方式二： 使用@Mapper </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpMapper</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">     ......................</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot原理篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（二）集成SMTP发送邮件</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%BA%8C%EF%BC%89%E9%9B%86%E6%88%90SMTP%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><blockquote>
<p>可发送邮箱链接进行用户注册认证等</p>
</blockquote>
<h3 id="1、添加SMTP-及-MAIL-的-pom-xml-依赖"><a href="#1、添加SMTP-及-MAIL-的-pom-xml-依赖" class="headerlink" title="1、添加SMTP 及 MAIL 的 pom.xml 依赖"></a>1、添加SMTP 及 MAIL 的 pom.xml 依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">      <span class="comment">&lt;!--郵箱發送--&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>  依赖添加后会要求刷新 springBootConguration 的配置信息，可执行也可不理睬</p>
<p><strong>具体操作如下：</strong></p>
<img src="http://photo.wushaopei.com/qiniu22.png" width="80%">

<h3 id="2、配置yml邮箱参数"><a href="#2、配置yml邮箱参数" class="headerlink" title="2、配置yml邮箱参数"></a>2、配置yml邮箱参数</h3><h4 id="2-1-在-application-dev-yml中配置对应的邮箱参数"><a href="#2-1-在-application-dev-yml中配置对应的邮箱参数" class="headerlink" title="2.1 在 application-dev.yml中配置对应的邮箱参数"></a>2.1 在 application-dev.yml中配置对应的邮箱参数</h4><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#邮件配置</span></span><br><span class="line"><span class="attr">email</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">host</span>: <span class="string">smtp.163.com</span></span><br><span class="line">  <span class="attr">username</span>: <span class="string">1598974689@163.com</span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">1598974689wsp</span></span><br><span class="line">  <span class="attr">senderName</span>: <span class="string">1598974689@163.com</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#发送提醒邮件的接收方</span></span><br><span class="line"><span class="attr">sendToMail</span>: <span class="string">1862030785@foxmail.com</span></span><br><span class="line"><span class="attr">sendToPeopleName</span>: <span class="string">wen</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的-SMTP-设置，"><a href="#2-2-由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的-SMTP-设置，" class="headerlink" title="2.2 由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的 SMTP 设置，"></a>2.2 由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的 SMTP 设置，</h4><img src="http://photo.wushaopei.com/qiniu23.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu24.png" width="80%">

<blockquote>
<p>打勾选中要设置的服务项，通过校验短信息设置授权码，使用授权码代替  邮箱密码 实现邮件的发送，流程很简单的。 </p>
</blockquote>
<h3 id="3、相关工具类和-实体类的创建"><a href="#3、相关工具类和-实体类的创建" class="headerlink" title="3、相关工具类和 实体类的创建"></a>3、相关工具类和 实体类的创建</h3><h4 id="3-1-邮箱-参数-config"><a href="#3-1-邮箱-参数-config" class="headerlink" title="3.1 邮箱 参数 config"></a>3.1 邮箱 参数 config</h4><img src="http://photo.wushaopei.com/qiniu25.png" width="80%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.model.common;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> EmailConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 10:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"email"</span>, ignoreUnknownFields = <span class="keyword">false</span>)</span><br><span class="line"><span class="comment">//@PropertySource("classpath:/application.yml")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String senderName;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSenderName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSenderName</span><span class="params">(String senderName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.senderName = senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"EmailConfig&#123;"</span> +</span><br><span class="line">                <span class="string">"host='"</span> + host + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", senderName='"</span> + senderName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-Email-发送实现工具类"><a href="#3-2-Email-发送实现工具类" class="headerlink" title="3.2  Email 发送实现工具类"></a>3.2  Email 发送实现工具类</h4><img src="http://photo.wushaopei.com/qiniu26.png" width="50%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.utils.Email;</span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.common.EmailConfig;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.JavaMailSenderImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.MimeMessageHelper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.mail.MessagingException;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MailSenderFacade</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 10:22</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSenderFacade</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailConfig emailConfig;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MailSenderFacade<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMailHtml</span><span class="params">(<span class="keyword">final</span> String toEmail,<span class="keyword">final</span> String subject,<span class="keyword">final</span> String text)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            JavaMailSenderImpl javaMailSender = <span class="keyword">new</span> JavaMailSenderImpl();</span><br><span class="line">            javaMailSender.setUsername(emailConfig.getUsername());</span><br><span class="line">            javaMailSender.setPassword(emailConfig.getPassword());</span><br><span class="line">            javaMailSender.setHost(emailConfig.getHost());</span><br><span class="line">            javaMailSender.setPort(<span class="number">25</span>);</span><br><span class="line">            javaMailSender.setProtocol(<span class="string">"smtp"</span>);</span><br><span class="line">            javaMailSender.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">            Properties mailProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.auth"</span>, <span class="keyword">true</span>);</span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.starttls.enable"</span>, <span class="keyword">true</span>);</span><br><span class="line">            javaMailSender.setJavaMailProperties(mailProperties);</span><br><span class="line">            MimeMessage mimeMessage = getMimeMessage(toEmail,subject,text, javaMailSender);</span><br><span class="line">            javaMailSender.send(mimeMessage);</span><br><span class="line">            logger.info(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送异常"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> MimeMessage <span class="title">getMimeMessage</span><span class="params">(String toEmail,String subject,String text, JavaMailSenderImpl javaMailSender)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line">        MimeMessage mimeMessage = javaMailSender.createMimeMessage();</span><br><span class="line">        MimeMessageHelper mimeMessageHelper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage, <span class="keyword">true</span>, <span class="string">"UTF-8"</span>);</span><br><span class="line">        mimeMessageHelper.setFrom(emailConfig.getSenderName());</span><br><span class="line">        mimeMessageHelper.setTo(toEmail);</span><br><span class="line">        mimeMessageHelper.setSubject(subject);</span><br><span class="line">        mimeMessageHelper.setText(text, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> mimeMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、测试SMTP功能发送一个邮件试试"><a href="#4、测试SMTP功能发送一个邮件试试" class="headerlink" title="4、测试SMTP功能发送一个邮件试试"></a>4、测试SMTP功能发送一个邮件试试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/please/emailTest"</span>, method = RequestMethod.GET)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getEmailTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           Map&lt;String,Object&gt; map = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">           mailSenderFacade.sendMailHtml(<span class="string">"18620307785@163.com"</span>, <span class="string">"来自邮箱测试接口邮件"</span>, <span class="string">"来自邮箱测试接口邮件"</span>);</span><br><span class="line">           map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">           map.put(<span class="string">"message"</span>, <span class="string">"导出成功"</span>);</span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           map.put(<span class="string">"state"</span>,<span class="string">"1"</span>);</span><br><span class="line">           map.put(<span class="string">"message"</span>, <span class="string">"导出失敗"</span>);</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> map;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>发送成功：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu27.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu28.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-smtp" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（一）集成swagger-ui</title>
    <url>/2020/03/06/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%B8%80%EF%BC%89%E9%9B%86%E6%88%90swagger-ui/</url>
    <content><![CDATA[<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a><strong>前言：</strong></h3><p><strong>使用swagger-ui 的原因之一，也是最重要的原因。</strong></p>
<ul>
<li>SwaggerHub充当我们的API开发人员门户，产品所有者，Test QA分析人员，开发人员和架构师可以在其中进行API设计和开发并进行协作。 </li>
<li>SwaggerHub充当协作的集中主机，使该过程非常高效，直观和无缝。 </li>
<li>SwaggerHub旨在为组织和团队提供最佳的体验，以维护和扩展从设计到部署的API开发。  </li>
<li>SwaggerHub的自动生成的API文档使内部和外部用户易于使用您的API。 </li>
</ul>
<p><strong>官网链接地址</strong>：<a href="https://swagger.io/tools/swaggerhub/" target="_blank" rel="noopener">https://swagger.io/tools/swaggerhub/</a> </p>
<h3 id="1、工程创建"><a href="#1、工程创建" class="headerlink" title="1、工程创建"></a>1、工程创建</h3><blockquote>
<p> 创建一个maven 管理的springboot 工程，这里不做赘述</p>
</blockquote>
<h3 id="2、添加依赖"><a href="#2、添加依赖" class="headerlink" title="2、添加依赖"></a>2、添加依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">       <span class="comment">&lt;!--SpringBoot整合Swagger-ui--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger-ui --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3、设置配置类"><a href="#3、设置配置类" class="headerlink" title="3、设置配置类"></a>3、设置配置类</h3><img src="http://photo.wushaopei.com/qiniu17.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.config;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Contact;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SwaggerConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/22 16:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 启动时加载类</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 启用Swagger API文档</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">api</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">// 自行修改为自己的包路径</span></span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.example.poiutis.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">"报表管理"</span>)</span><br><span class="line">                .description(<span class="string">"报表管理中心 API 1.0 操作文档"</span>)</span><br><span class="line">                <span class="comment">//服务条款网址</span></span><br><span class="line">                .termsOfServiceUrl(<span class="string">"https://blog.csdn.net/weixin_42405670"</span>)</span><br><span class="line">                .version(<span class="string">"1.0"</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> Contact(<span class="string">"鮀城小帅"</span>, <span class="string">"https://blog.csdn.net/weixin_42405670"</span>, <span class="string">"15989746839@163.com"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<blockquote>
<p>启动类加上注解<strong>@EnableSwagger</strong></p>
</blockquote>
<p>启动该注解使得用在<strong>controller</strong>中的<strong>swagger</strong>注解生效，覆盖的范围下的所有<strong>controller</strong></p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu18.png" width="80%">

<h3 id="4、Controller-类配置"><a href="#4、Controller-类配置" class="headerlink" title="4、Controller 类配置"></a>4、Controller 类配置</h3><p><strong>@Api的使用</strong> </p>
<p><strong>API</strong>作用在<strong>Controller</strong>,作为swagger文档资源,该注解将一个<strong>controller</strong>标注为一个<strong>Swagger</strong>资源(API). 在默认情况下，<strong>Swagger</strong>-<strong>Core</strong> 只会扫描解析具有 @Api 注解的类，而会自动忽略其他类别资源（<strong>JAX-RS endpoints、Servlets</strong> 等）的注解。</p>
<p><strong>@ApiOperation</strong> 的使用</p>
<p><strong>ApiOperation</strong> 定义在方法上，描述方法名、方法解释、返回信息、标记等信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发票管理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> issuser</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"发票"</span>,description = <span class="string">"发票操作 API"</span>, position = <span class="number">100</span>, protocols = <span class="string">"http"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/webcode"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvoiceController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(InvoiceController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    invoiceOrderService InvoiceOrderService;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@ApiOperation</span>(value = <span class="string">"导出操作日志到xls文件"</span>, notes = <span class="string">"需要登录"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/exporInvoiceOrderXls"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">exporInvoiceOrderXls</span><span class="params">( HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        @RequestParam(value=<span class="string">"invoiceOrders"</span>)</span>@<span class="title">ApiParam</span><span class="params">(value=<span class="string">"invoiceOrders"</span>)</span> List&lt;String&gt;  invoiceOrders) </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">        response.setContentType(<span class="string">"octets/stream"</span>);</span><br><span class="line"> </span><br><span class="line">        Map&lt;String, Object&gt; map2 = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        map2.put(<span class="string">"sheetTitle"</span>, <span class="string">"消费记录"</span>);</span><br><span class="line">        map2.put(<span class="string">"header"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"订单号"</span>, <span class="string">"商店名称"</span>, <span class="string">"发票批次"</span>, <span class="string">"账户名称"</span>, <span class="string">"商店地址"</span>, <span class="string">"刷卡账号"</span>,<span class="string">"商店电话"</span>,<span class="string">"信用卡开户行名称"</span>&#125;);</span><br><span class="line">        map2.put(<span class="string">"fields"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"invoiceOrder"</span>, <span class="string">"companyName"</span>, <span class="string">"taxNumber"</span>, <span class="string">"accountBank"</span>, <span class="string">"companyAddress"</span>,<span class="string">"bankNumber"</span>,<span class="string">"companyTelephone"</span>,<span class="string">"accountName"</span>&#125;);</span><br><span class="line"> </span><br><span class="line">        List&lt;InvoiceOrder&gt; invoiceOrderss = InvoiceOrderService.queryInvoiceLists(invoiceOrders,<span class="number">0</span>,<span class="number">9999</span>);</span><br><span class="line">        map2.put(<span class="string">"data"</span>,invoiceOrderss);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(map2);</span><br><span class="line"> </span><br><span class="line">        String title = <span class="string">"日常消费刷卡发票记录"</span>;</span><br><span class="line"> </span><br><span class="line">        Map&lt;String, <span class="keyword">short</span>[]&gt; mergedRegion = <span class="keyword">new</span> HashMap&lt;String, <span class="keyword">short</span>[]&gt;();</span><br><span class="line">        mergedRegion.put(<span class="string">"通用标题名称合并"</span>, <span class="keyword">new</span> <span class="keyword">short</span>[] &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>&#125;);</span><br><span class="line"> </span><br><span class="line">        ExportExcel&lt;InvoiceOrder&gt; ex = <span class="keyword">new</span> ExportExcel&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 声明一个工作薄</span></span><br><span class="line">        HSSFWorkbook workbook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">        <span class="comment">// 生成一个标题样式</span></span><br><span class="line">        HSSFCellStyle headerStyle = ex.cellStyle(workbook);</span><br><span class="line">        <span class="comment">// 生成一个内容样式</span></span><br><span class="line">        HSSFCellStyle textStyle = ex.cellStyle(workbook);</span><br><span class="line">        <span class="comment">// 生成标题字体</span></span><br><span class="line">        ex.setFont(workbook, headerStyle, (<span class="keyword">short</span>) <span class="number">10</span>, HSSFFont.BOLDWEIGHT_NORMAL);</span><br><span class="line">        <span class="comment">// 生成内容字体</span></span><br><span class="line">        ex.setFont(workbook, textStyle, HSSFFont.BOLDWEIGHT_NORMAL);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            OutputStream out = response.getOutputStream();</span><br><span class="line">            <span class="comment">// 导出文件名称添加当前时间</span></span><br><span class="line">            String date = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">            <span class="comment">//防止乱码</span></span><br><span class="line"><span class="comment">//            response.addHeader("Access-Control-Expose-Headers", "Content-Type,Content-Disposition");</span></span><br><span class="line"><span class="comment">//            response.addHeader("Content-Disposition",</span></span><br><span class="line"><span class="comment">//                    "attachment;filename=" + URLEncoder.encode(title, "GBK") + date</span></span><br><span class="line"><span class="comment">//                            + ".xls");</span></span><br><span class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment; filename="</span> + <span class="keyword">new</span> String((title+<span class="string">".xls"</span>).getBytes(<span class="string">"GB2312"</span>),<span class="string">"ISO8859-1"</span>));</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            list.forEach(m -&gt; &#123;</span><br><span class="line">                ExcelModel excelModel = <span class="keyword">new</span> ExcelModel();</span><br><span class="line">                excelModel.setWorkbook(workbook);</span><br><span class="line">                excelModel.setTitle(title);</span><br><span class="line">                excelModel.setFields((String[]) m.get(<span class="string">"fields"</span>));</span><br><span class="line">                excelModel.setHeader((String[]) m.get(<span class="string">"header"</span>));</span><br><span class="line">                excelModel.setHeaderRow(<span class="number">2</span>);</span><br><span class="line">                excelModel.setMergedRegion(mergedRegion);</span><br><span class="line">                excelModel.setHeaderStyle(headerStyle);</span><br><span class="line">                excelModel.setTextStyle(textStyle);</span><br><span class="line">                excelModel.setTitles((String) m.get(<span class="string">"sheetTitle"</span>));</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 生成一页表格</span></span><br><span class="line">                HSSFSheet sheet = workbook.createSheet((String) m.get(<span class="string">"sheetTitle"</span>));</span><br><span class="line">                excelModel.setSheet(sheet);</span><br><span class="line">                ex.exportExcel(excelModel, (Collection&lt;InvoiceOrder&gt;) m.get(<span class="string">"data"</span>));</span><br><span class="line">            &#125;);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                workbook.write(out);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"导出成功"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            map.put(<span class="string">"state"</span>, <span class="string">"1"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性名称</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>url 的路径值</td>
</tr>
<tr>
<td>tags</td>
<td>如果设置这个值，value 的值会被覆盖</td>
</tr>
<tr>
<td>description</td>
<td>对 API 资源的描述</td>
</tr>
<tr>
<td>produces</td>
<td>For example, “application/json, application/xml”</td>
</tr>
<tr>
<td>consumes</td>
<td>For example, “application/json, application/xml”</td>
</tr>
<tr>
<td>protocols</td>
<td>Possible values: http, https, ws, wss</td>
</tr>
<tr>
<td>authorizations</td>
<td>高级特性认证时配置</td>
</tr>
<tr>
<td>hidden</td>
<td>配置为 true 将在文档中隐藏</td>
</tr>
<tr>
<td>response</td>
<td>返回的对象</td>
</tr>
<tr>
<td>responseContainer</td>
<td>这些对象是有效的 “List”, “Set” or “Map”，其他无效</td>
</tr>
<tr>
<td>httpMethod</td>
<td>“GET”、”HEAD”、”POST”、”PUT”、”DELETE”、”OPTIONS” and “PATCH”</td>
</tr>
<tr>
<td>code</td>
<td>http 的状态码 默认 200</td>
</tr>
<tr>
<td>extensions</td>
<td>扩展属性</td>
</tr>
</tbody></table>
<p><strong>@ApiImplicitParams</strong> 和 <strong>@ApiImplicitParam</strong> 的使用</p>
<p><strong>@ApiImplicitParams</strong> 用于描述方法的返回信息，和 <strong>@ApiImplicitParam</strong> 注解配合使用；<strong>@ApiImplicitParam</strong> 用来描述具体某一个参数的信息，包括参数的名称、类型、限制等信息。</p>
<hr>
<h3 id="5、启动项目，进入API列表，localhost-swagger-ui-html"><a href="#5、启动项目，进入API列表，localhost-swagger-ui-html" class="headerlink" title="5、启动项目，进入API列表，localhost/swagger-ui.html#"></a>5、启动项目，进入API列表，localhost/swagger-ui.html#</h3><img src="http://photo.wushaopei.com/qiniu19.png" width="80%">

<p>完整<strong>springBoot</strong> 整合 <strong>Swagger</strong> 代码 <strong>GitHub</strong> 链接地址：</p>
<p><strong>注意问题：</strong></p>
<p>出现以下问题时，要检查<strong>SwaggerConfig</strong> 中配置的路径是否正确；</p>
<img src="http://photo.wushaopei.com/qiniu20.png" width="80%">

<p>即：</p>
<img src="http://photo.wushaopei.com/qiniu21.png" width="80%">

<h3 id="6、Swagger常用注解"><a href="#6、Swagger常用注解" class="headerlink" title="6、Swagger常用注解"></a>6、Swagger常用注解</h3><table>
<thead>
<tr>
<th>作用范围</th>
<th>API</th>
<th>使用位置</th>
</tr>
</thead>
<tbody><tr>
<td>协议集描述</td>
<td>@Api</td>
<td>用于 Controller 类上</td>
</tr>
<tr>
<td>协议描述</td>
<td>@ApiOperation</td>
<td>用在 Controller 的方法上</td>
</tr>
<tr>
<td>非对象参数集</td>
<td>@ApiImplicitParams</td>
<td>用在 Controller 的方法上</td>
</tr>
<tr>
<td>非对象参数描述</td>
<td>@ApiImplicitParam</td>
<td>用在 @ApiImplicitParams 的方法里边</td>
</tr>
<tr>
<td>响应集</td>
<td>@ApiResponses</td>
<td>用在 Controller 的方法上</td>
</tr>
<tr>
<td>响应信息参数</td>
<td>@ApiResponse</td>
<td>用在 @ApiResponses 里边</td>
</tr>
<tr>
<td>描述返回对象的意义</td>
<td>@ApiModel</td>
<td>用在返回对象类上</td>
</tr>
<tr>
<td>对象属性</td>
<td>@ApiModelProperty</td>
<td>用在出入参数对象的字段上</td>
</tr>
</tbody></table>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/springBoot-swaggerui" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（四）整合 mybatis</title>
    <url>/2020/03/06/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E5%9B%9B%EF%BC%89%E6%95%B4%E5%90%88-mybatis/</url>
    <content><![CDATA[<h4 id="1、增加持久化层"><a href="#1、增加持久化层" class="headerlink" title="1、增加持久化层"></a>1、增加持久化层</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2、实体类及表的创建"><a href="#2、实体类及表的创建" class="headerlink" title="2、实体类及表的创建"></a>2、实体类及表的创建</h3><p>实体类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Emp</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Integer empId;</span><br><span class="line">	<span class="keyword">private</span> String empName;</span><br><span class="line">	<span class="keyword">private</span> Integer empAge;</span><br><span class="line">    …… </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`table_emp`</span> (</span><br><span class="line"><span class="string">`emp_id`</span>  <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT ,</span><br><span class="line"><span class="string">`emp_name`</span>  <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="literal">NULL</span> ,</span><br><span class="line"><span class="string">`emp_age`</span>  <span class="built_in">int</span> <span class="literal">NULL</span> ,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`emp_id`</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="3、Mapper-及配置文件"><a href="#3、Mapper-及配置文件" class="headerlink" title="3、Mapper 及配置文件"></a>3、Mapper 及配置文件</h3><p>*mapper.java </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpMapper</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;Emp&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*mapper.xml </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.webcode.springboot.mappers.EmpMapper"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.springboot.bean.Emp"</span>&gt;</span></span><br><span class="line">		select emp_id empId, emp_name empName, emp_age empAge</span><br><span class="line">		from table_emp</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4、Service-业务接口及实现"><a href="#4、Service-业务接口及实现" class="headerlink" title="4、Service 业务接口及实现"></a>4、Service 业务接口及实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;Emp&gt; <span class="title">getAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmpServiceImpl</span> <span class="keyword">implements</span> <span class="title">EmpService</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> empMapper.selectAll();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、handler-接口调用"><a href="#5、handler-接口调用" class="headerlink" title="5、handler 接口调用"></a>5、handler 接口调用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> EmpService empService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/getAll"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> empService.getAll();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、application-yml-配置"><a href="#6、application-yml-配置" class="headerlink" title="6、application.yml 配置"></a>6、application.yml 配置</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">mydb</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://127.0.0.1:3306/sb_db</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">root</span></span><br><span class="line">    <span class="meta">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">mybatis</span>:<span class="string"></span></span><br><span class="line">  <span class="meta">mapper-locations</span>: <span class="string">classpath*:/mybatis/*Mapper.xml</span></span><br><span class="line"><span class="comment">    # spring boot集成mybatis的方式打印sql </span></span><br><span class="line">  <span class="attr">configuration</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">log-impl</span>: <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"><span class="comment">   # 开启日志</span></span><br><span class="line"><span class="attr">logging</span>: <span class="string"></span></span><br><span class="line">  <span class="attr">level</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">com.eth.wallet.mapper</span>: <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h3 id="7、在主启动类上使用注解扫描Mapper"><a href="#7、在主启动类上使用注解扫描Mapper" class="headerlink" title="7、在主启动类上使用注解扫描Mapper"></a>7、在主启动类上使用注解扫描Mapper</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.webcode.springboot.mappers"</span>)</span><br></pre></td></tr></table></figure>

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/SpringBoot_mybatis" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（三）包扫描与启动过程</title>
    <url>/2020/03/06/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%B8%89%EF%BC%89%E5%8C%85%E6%89%AB%E6%8F%8F%E4%B8%8E%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="一-SpringBoot-的版本与启动过程"><a href="#一-SpringBoot-的版本与启动过程" class="headerlink" title="一. SpringBoot 的版本与启动过程"></a>一. SpringBoot 的版本与启动过程</h3><h5 id="1-SpringBoot都是jar工程"><a href="#1-SpringBoot都是jar工程" class="headerlink" title="1.SpringBoot都是jar工程"></a>1.SpringBoot都是jar工程</h5><img src="http://photo.wushaopei.com/qiniu13.png" width="80%">

<h5 id="2-SpringBoot-版本问题"><a href="#2-SpringBoot-版本问题" class="headerlink" title="2.SpringBoot 版本问题"></a>2.SpringBoot 版本问题</h5><blockquote>
<p>大版本1：内置的Spring是大版本4</p>
<p>​      1.5.8</p>
<p>​      1.5.12</p>
<p>大版本2：内置的Spring是大版本5</p>
</blockquote>
<h5 id="3-SpringBoot启动过程观察"><a href="#3-SpringBoot启动过程观察" class="headerlink" title="3.SpringBoot启动过程观察"></a>3.SpringBoot启动过程观察</h5><h5 id=""><a href="#" class="headerlink" title=""></a><img src="http://photo.wushaopei.com/qiniu14.png" alt=""></h5><p><strong>① 核心机制：</strong></p>
<img src="http://photo.wushaopei.com/qiniu15.png" width="80%">

<p><strong>② 重要注解</strong></p>
<table>
<thead>
<tr>
<th>注解名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>@SpringBootApplication</td>
<td>声明一个SpringBoot程序，并使@SpringBootConfiguration@EnableAutoConfiguration@ComponentScan等注解生效</td>
</tr>
<tr>
<td>@SpringBootConfiguration</td>
<td>相当于@Configuration注解的重新定义</td>
</tr>
<tr>
<td>@Configuration</td>
<td>声明一个Spring配置类</td>
</tr>
<tr>
<td>@Bean</td>
<td>在@Configuration注解标记的类中将标记了@Bean的方法返回值对象加入IOC容器，可以对应XML配置文件中的bean标签来理解</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>启用自动配置</td>
</tr>
<tr>
<td>@AutoConfigurationPackage</td>
<td>当前包下包含需要自动扫描的类</td>
</tr>
<tr>
<td>@ComponentScan</td>
<td>指定要扫描的包</td>
</tr>
</tbody></table>
<h3 id="二-扫描包的问题"><a href="#二-扫描包的问题" class="headerlink" title="二. 扫描包的问题"></a>二. 扫描包的问题</h3><h5 id="1-自动扫描"><a href="#1-自动扫描" class="headerlink" title="1.自动扫描"></a>1.<strong>自动扫描</strong></h5><pre><code>需要被扫描的类（@Controller、@Service）所在的包是主启动类所在包的子类。 </code></pre><img src="http://photo.wushaopei.com/qiniu16.png" width="80%">

<h5 id="2-手动指定扫描的包"><a href="#2-手动指定扫描的包" class="headerlink" title="2.手动指定扫描的包"></a>2.手动指定扫描的包</h5><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">在主启动类上使用@ComponeneScan（“com.webcode.spring2boot.handler”）注解</span><br></pre></td></tr></table></figure>

<h5 id="3、-Configuration-注解"><a href="#3、-Configuration-注解" class="headerlink" title="3、@Configuration 注解"></a>3、@Configuration 注解</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;bean id="message" class="com.webcode.springboot.entities.Message"/&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Lenovo</span></span><br><span class="line"><span class="comment"> * 当前这个类必须能够被扫描到</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span><span class="comment">//这个方法返回的对象会被加入到IOC容器中</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Message <span class="title">getMessageBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Message();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4、扫描Mapper接口的两种方式"><a href="#4、扫描Mapper接口的两种方式" class="headerlink" title="4、扫描Mapper接口的两种方式"></a>4、扫描Mapper接口的两种方式</h5><ul>
<li>方式一： 使用 @MapperScan </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.webcode.springboot.mappers"</span>)标记在主启动类上</span><br></pre></td></tr></table></figure>

<ul>
<li><p>方式二：使用@Mapper </p>
<p>标记在Mapper接口上 </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpMapper</span></span>&#123;</span><br><span class="line"></span><br><span class="line">     ......................</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5、为Mybatis配置实体类包"><a href="#5、为Mybatis配置实体类包" class="headerlink" title="5、为Mybatis配置实体类包"></a>5、为Mybatis配置实体类包</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath*:/mybatis/mappers/*Mapper.xml</span><br><span class="line">  type-aliases-package: com.atguigu.springboot.entities</span><br></pre></td></tr></table></figure>

<h3 id="三、SpringBoot环境下配置文件"><a href="#三、SpringBoot环境下配置文件" class="headerlink" title="三、SpringBoot环境下配置文件"></a>三、SpringBoot环境下配置文件</h3><h5 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h5><blockquote>
<p>SpringBoot环境下常用的配置文件有两种，一种是properties 属性文件，一种是yml文件。二者各有特点，语法也有很大区别，但是最终效果基本一致。 </p>
</blockquote>
<h5 id="2、Properties-文件使用"><a href="#2、Properties-文件使用" class="headerlink" title="2、Properties 文件使用"></a>2、Properties 文件使用</h5><p><strong>文件名： application.properties</strong></p>
<p>语法格式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxx.xxx.xxx&#x3D;xxx</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">server.port = 8181  //用于指定handler访问的端口号</span><br></pre></td></tr></table></figure>

<h5 id="3、yml文件的使用"><a href="#3、yml文件的使用" class="headerlink" title="3、yml文件的使用"></a>3、yml文件的使用</h5><p>3.1 yml简介 </p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">yml是YAML（YAML Ain't Markup Language）语言的文件，以数据为中心，比json、xml等更适合做配置文件。</span><br></pre></td></tr></table></figure>

<p>3.2 yml 语法</p>
<blockquote>
<ul>
<li>使用缩进表示层级关系</li>
<li>缩进时不允许使用Tab键，只允许使用空格</li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li>
<li>大小写敏感</li>
</ul>
</blockquote>
<p>3.3 YAML 支持的三种数据结构 </p>
<blockquote>
<ul>
<li><strong>对象： 键值对的集合</strong></li>
<li><strong>数值：一组按次序排列的值</strong></li>
<li><strong>字面量：单个的、不可再分的值</strong></li>
</ul>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">apple</span></span><br><span class="line">        <span class="attr">//微服务的名字</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">8181</span></span><br><span class="line">    <span class="meta">context-path</span>: <span class="string">/banana</span></span><br></pre></td></tr></table></figure>

<p>用于指定<strong>handler</strong>访问的路径 </p>
<h3 id="四、主启动类"><a href="#四、主启动类" class="headerlink" title="四、主启动类"></a>四、主启动类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.webcode.springBoot"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootHelloWorld</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		SpringApplication.run(SpringBootHelloWorld<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>application.properties </li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8081   #指定访问的端口</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application.yml </li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span> :<span class="string"></span></span><br><span class="line">    <span class="attr">name</span> : <span class="string">applie</span></span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（二）helloworld</title>
    <url>/2020/03/05/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%BA%8C%EF%BC%89helloworld/</url>
    <content><![CDATA[<p><strong>操作步骤：</strong></p>
<h4 id="第一种创建SpringBoot的方案："><a href="#第一种创建SpringBoot的方案：" class="headerlink" title="第一种创建SpringBoot的方案："></a><strong>第一种创建SpringBoot的方案：</strong></h4><p><strong>1、</strong>创建Maven工程  </p>
<p><img src="http://photo.wushaopei.com/qiniu01.png" alt=""></p>
<p><img src="http://photo.wushaopei.com/qiniu02.png" alt=""></p>
<p><strong>2、</strong>加入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 继承SpringBoot官方指定的父工程 --&gt;</span>	</span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 加入Web开发所需要的场景启动器 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 指定groupId和artifactId即可，版本已在父工程中定义 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>3、</strong>创建主动启动类</p>
<p><img src="http://photo.wushaopei.com/qiniu03.png" alt=""></p>
<p><strong>4、</strong>创建HelloHandler </p>
<p><img src="http://photo.wushaopei.com/qiniu04.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"Hello SpringBoot!"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5、</strong>启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">运行主启动类中的main方法启动SpringBoot程序。</span><br></pre></td></tr></table></figure>

<p><strong>6、</strong>通过网页访问handler方法 </p>
<p><img src="http://photo.wushaopei.com/qiniu05.png" alt=""></p>
<p><strong>扩展：</strong> 关于包扫描的问题 </p>
<blockquote>
<p>SpringBoot中主启动类会自动扫描该类所在包的子包，相当于xml配置文件中的&lt;mvc:context scan=”包扫描路径”/&gt; </p>
</blockquote>
<p><img src="http://photo.wushaopei.com/qiniu06.png" alt=""></p>
<p><strong>注意：</strong> 要进行扫描的包必须处于主启动类的子包中。 </p>
<blockquote>
<ul>
<li><blockquote>
<p>手动扫描包</p>
<p>使用注解进行包</p>
</blockquote>
</li>
</ul>
</blockquote>
<p><img src="http://photo.wushaopei.com/qiniu07.png" alt=""></p>
<p><strong>访问结果：</strong> </p>
<p><img src="http://photo.wushaopei.com/qiniu08.png" alt=""></p>
<h4 id="第二种创建SpringBoot的方案"><a href="#第二种创建SpringBoot的方案" class="headerlink" title="第二种创建SpringBoot的方案"></a>第二种创建SpringBoot的方案</h4><p><strong>1、</strong>通过 Spring 插件创建 SpringBoot工程</p>
<p>限制： 每次创建工程都必须联网：必须借助Spring 插件</p>
<p><img src="http://photo.wushaopei.com/qiniu09.png" alt=""></p>
<p><img src="http://photo.wushaopei.com/qiniu10.png" alt=""></p>
<blockquote>
<p><strong>效果</strong> ：自动生成主启动器和application.properties，以及测试类</p>
</blockquote>
<p><img src="http://photo.wushaopei.com/qiniu12.png" alt=""></p>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/SpringBoot_helloworld" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（一） SpringBoot概述与微服务理念</title>
    <url>/2020/03/05/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%B8%80%EF%BC%89-SpringBoot%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E5%BF%B5/</url>
    <content><![CDATA[<h4 id="1、前言：-分布式架构及微服务理念"><a href="#1、前言：-分布式架构及微服务理念" class="headerlink" title="1、前言： 分布式架构及微服务理念"></a>1、前言： 分布式架构及微服务理念</h4><h5 id="SOA理念-思想）"><a href="#SOA理念-思想）" class="headerlink" title="SOA理念(思想）"></a>SOA理念(思想）</h5><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">SOA :即 Service Oriented Architecture，面向服务架构</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>主张：</strong> </p>
<p>​    把项目中的各个模块从单一架构中拆分出来，封装成一个一个可以远程调用的服务，从而实现分布式架构。</p>
<pre><code>开发具体的每一个服务时，使用一个interface定义这个服务的功能，这就是我们常说的暴露接口。</code></pre><p>​     当我们实现了interface,将接口暴露到了网络上，可以进行远程调用了，就可以说这个服务开发完成了，这就是我们常说的“写接口”。</p>
<hr>
<p><strong>SOA精髓：</strong><code>通过提供服务和对服务的调用实现分布式架构。</code></p>
<hr>
<h5 id="micro-service-微服务理念"><a href="#micro-service-微服务理念" class="headerlink" title="micro service 微服务理念"></a>micro service 微服务理念</h5><img src="https://img-blog.csdnimg.cn/2019042117295770.png" width="80%" >

<img src="https://img-blog.csdnimg.cn/20190421173021813.png" width="80%" >



<img src="https://img-blog.csdnimg.cn/20190421173049381.png" width="80%" >

<blockquote>
<p>这是对微服务理念的一整套具体实现 </p>
</blockquote>
<blockquote>
<p>SpringBoot在微观上开发具体的一个一个微服务。 </p>
</blockquote>
<blockquote>
<p>SpringCloud在宏观上统一管理、协调各个微服务。为微服务提供各个服务的注册中心、网关、配置中心、负载均衡、熔断机制、服务降级、服务监控、服务细节屏蔽等等。 </p>
</blockquote>
<h4 id="2、SpringBoot概述"><a href="#2、SpringBoot概述" class="headerlink" title="2、SpringBoot概述"></a>2、SpringBoot概述</h4><p>​    Spring Boot是由Pivotal团队提供的全新框架，其设计目的是用来简化新Spring应用的初始搭建以及开发过程。该框架使用了特定的方式来进行配置，从而使开发人员不再需要定义样板化的配置。 </p>
<p>① <strong>SpringCloud 和 Dubbo 对比</strong> </p>
<blockquote>
<p> Dubbo:底层RPC 调用</p>
<p>SpringCloud : 底层REST调用（HTTP）</p>
<p>SpringCloud 能够为项目架构直接提供一整套解决方案。</p>
<p>Dubbo只能作为项目架构的核心和基石，完整的项目架构解决方案还需要借助其他技术。</p>
</blockquote>
<h4 id="3、SpringBoot工程的使用"><a href="#3、SpringBoot工程的使用" class="headerlink" title="3、SpringBoot工程的使用"></a>3、SpringBoot工程的使用</h4><ul>
<li>加入需要的场景 starter依赖</li>
<li>配置properties或yml</li>
<li>创建主启动类</li>
<li>通过注解开启相关功能</li>
<li>运行主启动类</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（二）Activiti-插件安装-（两种方式）</title>
    <url>/2020/03/04/Activity-%EF%BC%88%E4%BA%8C%EF%BC%89Activiti-%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85-%EF%BC%88%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%89/</url>
    <content><![CDATA[<h3 id="1、安装Eclipse插件"><a href="#1、安装Eclipse插件" class="headerlink" title="1、安装Eclipse插件"></a>1、安装Eclipse插件</h3><p>1.1 点击eclipse上方工具栏的<strong>Help</strong>，选择<strong>Install New Software</strong></p>
   <img src="https://img-blog.csdnimg.cn/20200224214620411.png" width="60%" >

<p>1.2 弹出如下窗口，然后填写插件名称和安装地址</p>
<p>Name: <strong>Activiti BPMN 2.0 designer</strong></p>
<p>Location: <strong><a href="http://activiti.org/designer/update/" target="_blank" rel="noopener">http://activiti.org/designer/update/</a></strong></p>
<p>然后便是不停的next和finish了，组图如下：</p>
<img src="https://img-blog.csdnimg.cn/20200224214701568.png" width="60%">



<img src="https://img-blog.csdnimg.cn/20200224214715436.png" width="60%">



<img src="https://img-blog.csdnimg.cn/20200224214736205.png" width="60%">



<p>1.3 安装完成后，我们在new的时候，操作面板中便有activiti的相关文件了。</p>
<img src="https://img-blog.csdnimg.cn/20200224214759466.png" width="60%">



<h3 id="2、使用activiti-designer-5-18-0-zip"><a href="#2、使用activiti-designer-5-18-0-zip" class="headerlink" title="2、使用activiti-designer-5.18.0.zip"></a>2、使用activiti-designer-5.18.0.zip</h3><p>2.1 解压   activiti-designer-5.18.0.zip</p>
<p>2.2 把压缩包中的内容放入eclipse根目录的dropins文件夹下</p>
<p>2.3 重启eclipse，点击新建工程new-&gt;Other…打开面板，如果看到下图内容：</p>
<img src="https://img-blog.csdnimg.cn/20200224214849792.png" width="60%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>Activity （一）工作流简介 ：概念与由来</title>
    <url>/2020/03/01/Activity-%EF%BC%88%E4%B8%80%EF%BC%89%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%AE%80%E4%BB%8B-%EF%BC%9A%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%94%B1%E6%9D%A5/</url>
    <content><![CDATA[<h3 id="1、工作流"><a href="#1、工作流" class="headerlink" title="1、工作流"></a>1、工作流</h3><p>简单的理解就是工作的流程，这里的流程指的是，完成一个企业中具体业务的一系列工作步骤，所有的步骤合在一起就是业务从开始到结束的流转过程。从计算机系统的角度来讲，工作流系统表示：业务过程的部分和整体在计算机应用环境的自动化操作。</p>
<p><img src="http://photo.wushaopei.com/p01.png" alt=""></p>
<h2 id="2、工作流三要素"><a href="#2、工作流三要素" class="headerlink" title="2、工作流三要素"></a>2、工作流三要素</h2><p><img src="http://photo.wushaopei.com/p02.png" alt=""></p>
<h2 id="3、工作流示例：请假"><a href="#3、工作流示例：请假" class="headerlink" title="3、工作流示例：请假"></a>3、工作流示例：请假</h2><p><img src="http://photo.wushaopei.com/p03.png" alt=""></p>
<p><img src="http://photo.wushaopei.com/p04.png" alt=""></p>
<h2 id="4、工作流系统的组成"><a href="#4、工作流系统的组成" class="headerlink" title="4、工作流系统的组成"></a>4、工作流系统的组成</h2><p><img src="http://photo.wushaopei.com/p05.png" alt=""></p>
<h2 id="5、工作流的相关概念"><a href="#5、工作流的相关概念" class="headerlink" title="5、工作流的相关概念"></a>5、工作流的相关概念</h2><p><img src="http://photo.wushaopei.com/p06.png" alt=""></p>
<h2 id="6、工作流产品"><a href="#6、工作流产品" class="headerlink" title="6、工作流产品"></a>6、工作流产品</h2><ul>
<li>JBPM</li>
<li>OSWorkFlow</li>
<li>Activiti5</li>
<li>Shark</li>
<li>信雅达</li>
<li>普元工作流</li>
</ul>
<p>##7、Activiti5工作流的由来 </p>
<p><strong>Activiti</strong>的前身是<strong>JBPM</strong>，全称<strong>Java Business Process Management（业务流程管理</strong>）。它是覆盖了<strong>业务流程管理、工作流、服务协作</strong>等领域的一个<strong>开源的、灵活的、易扩展</strong>的<strong>可执行流程</strong>语言框架。</p>
<p><strong>JBPM</strong>是公开源代码项目。<br/><strong>JBPM</strong>在2004年10月18日，发布了2.0版本，并在同一天加入了JBoss ,成为了JBoss企业中间件平台的一个组成部分，它的名称也改成<strong>JBoss jBPM</strong></p>
<p>在<strong>JBPM4</strong>之后，公司内部对于软件的规划发生了分歧，所以当时的项目架构师脱离了原来的公司，加入新的公司后，改了名称<strong>Activiti5</strong>。</p>
<p><strong>JBPM</strong>的持久化层框架是<strong>Hibernate</strong>，而<strong>Activiti</strong>采用了<strong>MyBatis</strong>。</p>
<h2 id="8、Activiti5框架包含的主要组件"><a href="#8、Activiti5框架包含的主要组件" class="headerlink" title="8、Activiti5框架包含的主要组件"></a>8、Activiti5框架包含的主要组件</h2><table>
<thead>
<tr>
<th>组件名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>ProcessEngine</td>
<td>Activiti5的核心，所有的服务都需要通过ProcessEngine来创建，线程安全</td>
</tr>
<tr>
<td>repositoryService</td>
<td>持久化服务，与数据库进行交互</td>
</tr>
<tr>
<td>runtimeService</td>
<td>运行时服务，与运行流程有关</td>
</tr>
<tr>
<td>formService</td>
<td>表单服务</td>
</tr>
<tr>
<td>identityService</td>
<td>身份信息</td>
</tr>
<tr>
<td>taskService</td>
<td>任务服务，与流程中的每一个步骤有关</td>
</tr>
<tr>
<td>historyService</td>
<td>历史信息，查看历史的流程步骤</td>
</tr>
<tr>
<td>managementService</td>
<td>管理定时任务，在固定的时间点完成固定的任务</td>
</tr>
</tbody></table>
<h2 id="9、Activiti5-框架表结构"><a href="#9、Activiti5-框架表结构" class="headerlink" title="9、Activiti5 框架表结构"></a>9、Activiti5 框架表结构</h2><p>① 总体介绍 </p>
<table>
<thead>
<tr>
<th>表名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ACT_RE_*</td>
<td>‘RE’表示repository(存储)，RepositoryService接口所操作的表。带此前缀的表包含的是静态信息，如，流程定义，流程的资源（图片，规则等）。</td>
</tr>
<tr>
<td>ACT_RU_*</td>
<td>‘RU’表示runtime。RuntimeService接口所操作的表。存储着流程变量，用户任务，变量，职责（job）等运行时的数据。Activiti只存储实例执行期间的运行时数据，当流程实例结束时，将删除这些记录。这就保证了这些运行时的表小且快。</td>
</tr>
<tr>
<td>ACT_ID_*</td>
<td>‘ID’表示identity (组织机构)，IdentityService接口所操作的表。用户记录，流程中使用到的用户和组。这些表包含标识的信息，如用户，用户组，等等。</td>
</tr>
<tr>
<td>ACT_HI_*</td>
<td>‘HI’表示history，历史数据表，HistoryService。就是这些表包含着流程执行的历史相关数据，如结束的流程实例，变量，任务，等等</td>
</tr>
<tr>
<td>ACT_GE_*</td>
<td>全局通用数据及设置(general)，各种情况都使用的数据</td>
</tr>
</tbody></table>
<p>②详细介绍 </p>
<table>
<thead>
<tr>
<th>表名</th>
<th>标记</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>act_ge_bytearray</td>
<td></td>
<td>二进制数据表</td>
</tr>
<tr>
<td>act_ge_property</td>
<td></td>
<td>属性数据表存储整个流程引擎级别的数据,初始化表结构时，会默认插入三条记录，</td>
</tr>
<tr>
<td>act_hi_actinst</td>
<td>√</td>
<td>历史节点表</td>
</tr>
<tr>
<td>act_hi_attachment</td>
<td></td>
<td>历史附件表</td>
</tr>
<tr>
<td>act_hi_comment</td>
<td></td>
<td>历史意见表</td>
</tr>
<tr>
<td>act_hi_identitylink</td>
<td></td>
<td>历史流程人员表</td>
</tr>
<tr>
<td>act_hi_detail</td>
<td></td>
<td>历史详情表，提供历史变量的查询</td>
</tr>
<tr>
<td>act_hi_procinst</td>
<td>√</td>
<td>历史流程实例表</td>
</tr>
<tr>
<td>act_hi_taskinst</td>
<td>√</td>
<td>历史任务实例表</td>
</tr>
<tr>
<td>act_hi_varinst</td>
<td></td>
<td>历史变量表</td>
</tr>
<tr>
<td>act_id_group</td>
<td></td>
<td>用户组信息表</td>
</tr>
<tr>
<td>act_id_info</td>
<td></td>
<td>用户扩展信息表</td>
</tr>
<tr>
<td>act_id_membership</td>
<td></td>
<td>用户与用户组对应信息表</td>
</tr>
<tr>
<td>act_id_user</td>
<td></td>
<td>用户信息表</td>
</tr>
<tr>
<td>act_re_deployment</td>
<td>√</td>
<td>部署信息表</td>
</tr>
<tr>
<td>act_re_model</td>
<td></td>
<td>流程设计模型部署表</td>
</tr>
<tr>
<td>act_re_procdef</td>
<td>√</td>
<td>流程定义数据表</td>
</tr>
<tr>
<td>act_ru_event_subscr、throwEvent、catchEvent</td>
<td></td>
<td>时间监听信息表</td>
</tr>
<tr>
<td>act_ru_execution</td>
<td>√</td>
<td>运行时流程执行实例表</td>
</tr>
<tr>
<td>act_ru_identitylink</td>
<td>√</td>
<td>运行时流程人员表，主要存储任务节点与参与者的相关信息</td>
</tr>
<tr>
<td>act_ru_job</td>
<td></td>
<td>运行时定时任务数据表</td>
</tr>
<tr>
<td>act_ru_task</td>
<td>√</td>
<td>运行时任务节点表</td>
</tr>
<tr>
<td>act_ru_variable</td>
<td>√</td>
<td>运行时流程变量数据表</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>workflower</category>
      </categories>
  </entry>
  <entry>
    <title>面试题： hashset如何保证值不会被重复的</title>
    <url>/2020/02/29/%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%9Ahashset%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%80%BC%E4%B8%8D%E4%BC%9A%E8%A2%AB%E9%87%8D%E5%A4%8D%E7%9A%84/</url>
    <content><![CDATA[<p>众所周知，HashSet 的值是不可能被重复的，在业务上经常被用来做数据去重的操作，那么，其内部究竟是怎么保证元素不重复的呢？</p>
<p>这里将对<strong>HashSet</strong> 的源码进行逐步的解析：</p>
<p>当我们对一个<strong>HashSet</strong> 的实例添加一个值时，使用到的是它的 <strong>add</strong> 方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">218</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line"><span class="number">219</span>        <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</span><br><span class="line"><span class="number">220</span>    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>由以上的<strong>add</strong> 方法内的实现可知，其维护了一个 <strong>HashMap</strong> 来实现元素的添加；众所周知，<strong>HashMap</strong> 作为双列集合，它的键是不能够重复的，这里的 <strong>PRESENT</strong> 是作为占位符的存在，与值重复判断与否没有意义，不作赘述。</p>
<p>其实，到了这里，我们已经可以知道 <strong>HashSet</strong> 的值作为 <strong>HashMap</strong> 中的 <strong>key</strong>（键）的，可以确定是不会存在重复值存在的情况发生。</p>
<p>但是，我们要了解的是为什么不会重复，继续深究，这里继续了解对该值的一个不可重复的原因.</p>
<p>以下是<strong>HashSet</strong> 引用<strong>HashMap</strong>的具体位置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashSet</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Set</span>&lt;<span class="title">E</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5024744406713321676L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E,Object&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dummy value to associate with an Object in the backing Map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object PRESENT = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new, empty set; the backing &lt;tt&gt;HashMap&lt;/tt&gt; instance has</span></span><br><span class="line"><span class="comment">     * default initial capacity (16) and load factor (0.75).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new set containing the elements in the specified</span></span><br><span class="line"><span class="comment">     * collection.  The &lt;tt&gt;HashMap&lt;/tt&gt; is created with default load factor</span></span><br><span class="line"><span class="comment">     * (0.75) and an initial capacity sufficient to contain the elements in</span></span><br><span class="line"><span class="comment">     * the specified collection.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> c the collection whose elements are to be placed into this set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified collection is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;&gt;(Math.max((<span class="keyword">int</span>) (c.size()/.<span class="number">75f</span>) + <span class="number">1</span>, <span class="number">16</span>));</span><br><span class="line">        addAll(c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>HashSet</strong> 其实是在构造器内实例化了一个 <strong>HashMap</strong> 对象，那么可以得知，<strong>HashSet</strong> 的值不可重复是依赖于 <strong>HashMap</strong> 的底层对值不可重复的依赖。</p>
<p>其实</p>
<p>以下我们进入到 <strong>HashMap</strong> 的 <strong>put()</strong>方法中去：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Associates the specified value with the specified key in this map.</span></span><br><span class="line"><span class="comment"> * If the map previously contained a mapping for the key, the old</span></span><br><span class="line"><span class="comment"> * value is replaced.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value value to be associated with the specified key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span></span><br><span class="line"><span class="comment"> *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment"> *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span></span><br><span class="line"><span class="comment"> *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>由 <strong>put</strong>  方法的实现可知，该 <strong>put</strong> 方法对传入的 <strong>Map</strong> 的<strong>key - value</strong> 进行了更深一层的 <strong>putVal</strong>（）的处理。</p>
<p>但这个方法不是我们现在需要了解的，稍后再对这里进行了解。</p>
<p>进入 putVal() 方法之前，对传入的 key 进行了hash 运算，获取了一个 hash 值：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取hash 值的规则是 ：当 key == null 时，hash 值为0；若不为null，则说明值有效，会通过 hashCode()</p>
<p><strong>关于 hashCode() 在这里的作用：</strong></p>
<p>hashCode在上面扮演的角色为寻域（寻找某个对象在集合中区域位置）。hashCode可以将集合分成若干个区域，每个对象都可以计算出他们的hash码，可以将hash码分组，每个分组对应着某个存储区域，根据一个对象的hash码就可以确定该对象所存储区域，这样就大大减少查询匹配元素的数量，提高了查询效率。</p>
<p>关于Key 不能够重复，这里可以得出了，相同的值得到的 hash 码大概率上是相同的，所以，key 可以保证不会重复，因为重复的值，一定会被覆盖。具体从后面的源码继续看：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Implements Map.put and related methods</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> hash hash for key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value the value to put</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> onlyIfAbsent if true, don't change existing value</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> evict if false, the table is in creation mode.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> previous value, or null if none</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">      Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">      <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">          n = (tab = resize()).length;</span><br><span class="line">      <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">          tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          Node&lt;K,V&gt; e; K k;</span><br><span class="line">          <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">              ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">              e = p;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">              e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                  <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                      <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                          treeifyBin(tab, hash);</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                      ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  p = e;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">              V oldValue = e.value;</span><br><span class="line">              <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                  e.value = value;</span><br><span class="line">              afterNodeAccess(e);</span><br><span class="line">              <span class="keyword">return</span> oldValue;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++modCount;</span><br><span class="line">      <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">          resize();</span><br><span class="line">      afterNodeInsertion(evict);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>注意 以上方法 中的这一句：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (e.hash == hash &amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                     <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>由此可知，HashMap 的 集合元素 key-value 添加时，这里调用了对象的hashCode和equals方法进行的判断。</p>
<p>但要注意，原生的 hashCode 和 equals 更多的是在引用的位置上进行了去重校验，如要对具体的值或对象本身进行去重，还需进行重写操作。</p>
<p>所以又得出一个结论：<strong>若要将对象存放到HashSet中并保证对象不重复，应根据实际情况将对象的hashCode方法和equals方法进行重写</strong></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>容器-集合</category>
      </categories>
      <tags>
        <tag>集合</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/02/29/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
</search>
