<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Activity （一）工作流简介 ：概念与由来</title>
    <url>/2020/03/01/Activity-%EF%BC%88%E4%B8%80%EF%BC%89%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%AE%80%E4%BB%8B-%EF%BC%9A%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%94%B1%E6%9D%A5/</url>
    <content><![CDATA[<h3 id="1、工作流"><a href="#1、工作流" class="headerlink" title="1、工作流"></a>1、工作流</h3><p>简单的理解就是工作的流程，这里的流程指的是，完成一个企业中具体业务的一系列工作步骤，所有的步骤合在一起就是业务从开始到结束的流转过程。从计算机系统的角度来讲，工作流系统表示：业务过程的部分和整体在计算机应用环境的自动化操作。</p>
<p><img src="http://photo.wushaopei.com/p01.png" alt=""></p>
<h2 id="2、工作流三要素"><a href="#2、工作流三要素" class="headerlink" title="2、工作流三要素"></a>2、工作流三要素</h2><p><img src="http://photo.wushaopei.com/p02.png" alt=""></p>
<h2 id="3、工作流示例：请假"><a href="#3、工作流示例：请假" class="headerlink" title="3、工作流示例：请假"></a>3、工作流示例：请假</h2><p><img src="http://photo.wushaopei.com/p03.png" alt=""></p>
<p><img src="http://photo.wushaopei.com/p04.png" alt=""></p>
<h2 id="4、工作流系统的组成"><a href="#4、工作流系统的组成" class="headerlink" title="4、工作流系统的组成"></a>4、工作流系统的组成</h2><p><img src="http://photo.wushaopei.com/p05.png" alt=""></p>
<h2 id="5、工作流的相关概念"><a href="#5、工作流的相关概念" class="headerlink" title="5、工作流的相关概念"></a>5、工作流的相关概念</h2><p><img src="http://photo.wushaopei.com/p06.png" alt=""></p>
<h2 id="6、工作流产品"><a href="#6、工作流产品" class="headerlink" title="6、工作流产品"></a>6、工作流产品</h2><ul>
<li>JBPM</li>
<li>OSWorkFlow</li>
<li>Activiti5</li>
<li>Shark</li>
<li>信雅达</li>
<li>普元工作流</li>
</ul>
<p>##7、Activiti5工作流的由来 </p>
<p><strong>Activiti</strong>的前身是<strong>JBPM</strong>，全称<strong>Java Business Process Management（业务流程管理</strong>）。它是覆盖了<strong>业务流程管理、工作流、服务协作</strong>等领域的一个<strong>开源的、灵活的、易扩展</strong>的<strong>可执行流程</strong>语言框架。</p>
<p><strong>JBPM</strong>是公开源代码项目。<br/><strong>JBPM</strong>在2004年10月18日，发布了2.0版本，并在同一天加入了JBoss ,成为了JBoss企业中间件平台的一个组成部分，它的名称也改成<strong>JBoss jBPM</strong></p>
<p>在<strong>JBPM4</strong>之后，公司内部对于软件的规划发生了分歧，所以当时的项目架构师脱离了原来的公司，加入新的公司后，改了名称<strong>Activiti5</strong>。</p>
<p><strong>JBPM</strong>的持久化层框架是<strong>Hibernate</strong>，而<strong>Activiti</strong>采用了<strong>MyBatis</strong>。</p>
<h2 id="8、Activiti5框架包含的主要组件"><a href="#8、Activiti5框架包含的主要组件" class="headerlink" title="8、Activiti5框架包含的主要组件"></a>8、Activiti5框架包含的主要组件</h2><table>
<thead>
<tr>
<th>组件名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>ProcessEngine</td>
<td>Activiti5的核心，所有的服务都需要通过ProcessEngine来创建，线程安全</td>
</tr>
<tr>
<td>repositoryService</td>
<td>持久化服务，与数据库进行交互</td>
</tr>
<tr>
<td>runtimeService</td>
<td>运行时服务，与运行流程有关</td>
</tr>
<tr>
<td>formService</td>
<td>表单服务</td>
</tr>
<tr>
<td>identityService</td>
<td>身份信息</td>
</tr>
<tr>
<td>taskService</td>
<td>任务服务，与流程中的每一个步骤有关</td>
</tr>
<tr>
<td>historyService</td>
<td>历史信息，查看历史的流程步骤</td>
</tr>
<tr>
<td>managementService</td>
<td>管理定时任务，在固定的时间点完成固定的任务</td>
</tr>
</tbody></table>
<h2 id="9、Activiti5-框架表结构"><a href="#9、Activiti5-框架表结构" class="headerlink" title="9、Activiti5 框架表结构"></a>9、Activiti5 框架表结构</h2><p>① 总体介绍 </p>
<table>
<thead>
<tr>
<th>表名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ACT_RE_*</td>
<td>‘RE’表示repository(存储)，RepositoryService接口所操作的表。带此前缀的表包含的是静态信息，如，流程定义，流程的资源（图片，规则等）。</td>
</tr>
<tr>
<td>ACT_RU_*</td>
<td>‘RU’表示runtime。RuntimeService接口所操作的表。存储着流程变量，用户任务，变量，职责（job）等运行时的数据。Activiti只存储实例执行期间的运行时数据，当流程实例结束时，将删除这些记录。这就保证了这些运行时的表小且快。</td>
</tr>
<tr>
<td>ACT_ID_*</td>
<td>‘ID’表示identity (组织机构)，IdentityService接口所操作的表。用户记录，流程中使用到的用户和组。这些表包含标识的信息，如用户，用户组，等等。</td>
</tr>
<tr>
<td>ACT_HI_*</td>
<td>‘HI’表示history，历史数据表，HistoryService。就是这些表包含着流程执行的历史相关数据，如结束的流程实例，变量，任务，等等</td>
</tr>
<tr>
<td>ACT_GE_*</td>
<td>全局通用数据及设置(general)，各种情况都使用的数据</td>
</tr>
</tbody></table>
<p>②详细介绍 </p>
<table>
<thead>
<tr>
<th>表名</th>
<th>标记</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>act_ge_bytearray</td>
<td></td>
<td>二进制数据表</td>
</tr>
<tr>
<td>act_ge_property</td>
<td></td>
<td>属性数据表存储整个流程引擎级别的数据,初始化表结构时，会默认插入三条记录，</td>
</tr>
<tr>
<td>act_hi_actinst</td>
<td>√</td>
<td>历史节点表</td>
</tr>
<tr>
<td>act_hi_attachment</td>
<td></td>
<td>历史附件表</td>
</tr>
<tr>
<td>act_hi_comment</td>
<td></td>
<td>历史意见表</td>
</tr>
<tr>
<td>act_hi_identitylink</td>
<td></td>
<td>历史流程人员表</td>
</tr>
<tr>
<td>act_hi_detail</td>
<td></td>
<td>历史详情表，提供历史变量的查询</td>
</tr>
<tr>
<td>act_hi_procinst</td>
<td>√</td>
<td>历史流程实例表</td>
</tr>
<tr>
<td>act_hi_taskinst</td>
<td>√</td>
<td>历史任务实例表</td>
</tr>
<tr>
<td>act_hi_varinst</td>
<td></td>
<td>历史变量表</td>
</tr>
<tr>
<td>act_id_group</td>
<td></td>
<td>用户组信息表</td>
</tr>
<tr>
<td>act_id_info</td>
<td></td>
<td>用户扩展信息表</td>
</tr>
<tr>
<td>act_id_membership</td>
<td></td>
<td>用户与用户组对应信息表</td>
</tr>
<tr>
<td>act_id_user</td>
<td></td>
<td>用户信息表</td>
</tr>
<tr>
<td>act_re_deployment</td>
<td>√</td>
<td>部署信息表</td>
</tr>
<tr>
<td>act_re_model</td>
<td></td>
<td>流程设计模型部署表</td>
</tr>
<tr>
<td>act_re_procdef</td>
<td>√</td>
<td>流程定义数据表</td>
</tr>
<tr>
<td>act_ru_event_subscr、throwEvent、catchEvent</td>
<td></td>
<td>时间监听信息表</td>
</tr>
<tr>
<td>act_ru_execution</td>
<td>√</td>
<td>运行时流程执行实例表</td>
</tr>
<tr>
<td>act_ru_identitylink</td>
<td>√</td>
<td>运行时流程人员表，主要存储任务节点与参与者的相关信息</td>
</tr>
<tr>
<td>act_ru_job</td>
<td></td>
<td>运行时定时任务数据表</td>
</tr>
<tr>
<td>act_ru_task</td>
<td>√</td>
<td>运行时任务节点表</td>
</tr>
<tr>
<td>act_ru_variable</td>
<td>√</td>
<td>运行时流程变量数据表</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（七）流程定义查询</title>
    <url>/2020/03/14/Activity-%EF%BC%88%E4%B8%83%EF%BC%89%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E6%9F%A5%E8%AF%A2/</url>
    <content><![CDATA[<p>流程定义查询本质上就是通过<code>Activiti</code>框架提供的API对<code>act_re_procdef</code>表进行查询操作。 </p>
<img src="http://photo.wushaopei.com/qiniu130.png" width="90%">

<p>通过Activiti提供的API 把act_re_procdef表的所有列的数据全部查询出来，</p>
<p>在开发系统的时候管理员、用户可以通过用户界面来维护这些数据。</p>
<p>Activiti提供非常丰富的API，可以做SQL查询、对某些字段查询、模糊查询、分页查询和排序等。</p>
<h3 id="流程定义参数列表："><a href="#流程定义参数列表：" class="headerlink" title="流程定义参数列表："></a>流程定义参数列表：</h3><table>
<thead>
<tr>
<th>id</th>
<th>仅返回具有给定id的模型。</th>
</tr>
</thead>
<tbody><tr>
<td>category</td>
<td>只返回给定类别的模型。</td>
</tr>
<tr>
<td>categoryLike</td>
<td>仅返回类别类似于给定值的模型。使用<code>%</code>字符作为通配符。</td>
</tr>
<tr>
<td>categoryNotEquals</td>
<td>仅返回没有给定类别的模型。</td>
</tr>
<tr>
<td>name</td>
<td>仅返回具有给定名称的模型。</td>
</tr>
<tr>
<td>nameLike</td>
<td>仅返回名称类似于给定值的模型。使用<code>%</code>字符作为通配符。</td>
</tr>
<tr>
<td>key</td>
<td>仅返回具有给定密钥的模型</td>
</tr>
<tr>
<td>deploymentId</td>
<td>仅返回在给定部署中部署的模型。</td>
</tr>
<tr>
<td>version</td>
<td>只返回给定版本的模型。</td>
</tr>
<tr>
<td>latestVersion</td>
<td>如果为<code>true</code>，则仅返回最新版本的模型。最好与结合使用<code>key</code>。如果<code>false</code>以值形式传递，则将其忽略并返回所有版本。</td>
</tr>
<tr>
<td>deployed</td>
<td>如果为<code>true</code>，则仅返回已部署的模型。如果为<code>false</code>，则仅返回未部署的模型（deploymentId为null）。</td>
</tr>
<tr>
<td>tenantId</td>
<td>仅返回具有给定tenantId的模型。</td>
</tr>
<tr>
<td>tenantIdLike</td>
<td>仅返回具有给定值的tenantId的模型。</td>
</tr>
<tr>
<td>withoutTenantId</td>
<td>如果为<code>true</code>，则仅返回未设置tenantId的模型。如果为<code>false</code>，<code>withoutTenantId</code>则忽略该参数。</td>
</tr>
<tr>
<td>sort</td>
<td>要排序的属性，与<em>order</em>一起使用。</td>
</tr>
</tbody></table>
<h3 id="查询流程定义-返回流程定义集合"><a href="#查询流程定义-返回流程定义集合" class="headerlink" title="查询流程定义 返回流程定义集合"></a>查询流程定义 返回流程定义集合</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询流程定义 返回流程定义集合 ---对应act_re_procdef</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; pdList=processEngine.getRepositoryService() <span class="comment">// 获取service类</span></span><br><span class="line">        .createProcessDefinitionQuery() <span class="comment">// 创建流程定义查询</span></span><br><span class="line">        .processDefinitionKey(<span class="string">"myProcess"</span>) <span class="comment">// 通过key查询</span></span><br><span class="line">        .list(); <span class="comment">// 返回一个集合</span></span><br><span class="line">    <span class="keyword">for</span>(ProcessDefinition pd:pdList)&#123;</span><br><span class="line">    	System.out.println(<span class="string">"流程定义ID:"</span>+pd.getId());<span class="comment">//流程定义的key+版本+随机生成数</span></span><br><span class="line">        System.out.println(<span class="string">"流程定义名称:"</span>+pd.getName());<span class="comment">//对应HelloWorld.bpmn文件中的name属性值</span></span><br><span class="line">        System.out.println(<span class="string">"流程定义的key:"</span>+pd.getKey());<span class="comment">//对应HelloWorld.bpmn文件中的id属性值</span></span><br><span class="line">        System.out.println(<span class="string">"流程定义的版本:"</span>+pd.getVersion());<span class="comment">//当流程定义的key值相同的情况下，版本升级，默认从1开始</span></span><br><span class="line">        System.out.println(<span class="string">"资源名称bpmn文件:"</span>+pd.getResourceName());</span><br><span class="line">        System.out.println(<span class="string">"资源名称png文件:"</span>+pd.getDiagramResourceName());</span><br><span class="line">        System.out.println(<span class="string">"部署对象ID:"</span>+pd.getDeploymentId());</span><br><span class="line">        System.out.println(<span class="string">"################################"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行输入如下：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">流程定义ID:myProcess:<span class="number">10</span>:<span class="number">50004</span></span><br><span class="line">流程定义名称:My process</span><br><span class="line">流程定义的key:myProcess</span><br><span class="line">流程定义的版本:<span class="number">10</span></span><br><span class="line">资源名称bpmn文件:diagrams/MyProcess.bpmn</span><br><span class="line">资源名称png文件:diagrams/MyProcess.myProcess.png</span><br><span class="line">部署对象ID:<span class="number">50001</span></span><br><span class="line">################################</span><br><span class="line">流程定义ID:myProcess:<span class="number">1</span>:<span class="number">22504</span></span><br><span class="line">流程定义名称:My process</span><br><span class="line">流程定义的key:myProcess</span><br><span class="line">流程定义的版本:<span class="number">1</span></span><br><span class="line">资源名称bpmn文件:diagrams/MyProcess.bpmn</span><br><span class="line">资源名称png文件:diagrams/MyProcess.myProcess.png</span><br><span class="line">部署对象ID:<span class="number">22501</span></span><br><span class="line">################################</span><br><span class="line">……省略其他的</span><br></pre></td></tr></table></figure>



<p>也可以根据某个流程定义ID来查询流程定义信息，返回单个结果（说通俗点就是根据ID查询）： </p>
<h3 id="通过ID查询当个流程定义"><a href="#通过ID查询当个流程定义" class="headerlink" title="通过ID查询当个流程定义"></a>通过ID查询当个流程定义</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过ID查询当个流程定义</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getById</span><span class="params">()</span></span>&#123;</span><br><span class="line">   ProcessDefinition pd=processEngine.getRepositoryService() <span class="comment">// 获取service类</span></span><br><span class="line">            .createProcessDefinitionQuery() <span class="comment">// 创建流程定义查询</span></span><br><span class="line">            .processDefinitionId(<span class="string">"myProcess:10:50004"</span>) <span class="comment">// 通过id查询</span></span><br><span class="line">            .singleResult(); <span class="comment">// 查询返回当个结果</span></span><br><span class="line">	   System.out.println(<span class="string">"流程定义ID:"</span>+pd.getId());<span class="comment">//流程定义的key+版本+随机生成数</span></span><br><span class="line">       System.out.println(<span class="string">"流程定义名称:"</span>+pd.getName());<span class="comment">//对应HelloWorld.bpmn文件中的name属性值</span></span><br><span class="line">       System.out.println(<span class="string">"流程定义的key:"</span>+pd.getKey());<span class="comment">//对应HelloWorld.bpmn文件中的id属性值</span></span><br><span class="line">       System.out.println(<span class="string">"流程定义的版本:"</span>+pd.getVersion());<span class="comment">//当流程定义的key值相同的情况下，版本升级，默认从1开始</span></span><br><span class="line">       System.out.println(<span class="string">"资源名称bpmn文件:"</span>+pd.getResourceName());</span><br><span class="line">       System.out.println(<span class="string">"资源名称png文件:"</span>+pd.getDiagramResourceName());</span><br><span class="line">       System.out.println(<span class="string">"部署对象ID:"</span>+pd.getDeploymentId());</span><br><span class="line">       System.out.println(<span class="string">"################################"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行结果如下：</strong>  </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">流程定义ID:myProcess:<span class="number">10</span>:<span class="number">50004</span></span><br><span class="line">流程定义名称:My process</span><br><span class="line">流程定义的key:myProcess</span><br><span class="line">流程定义的版本:<span class="number">10</span></span><br><span class="line">资源名称bpmn文件:diagrams/MyProcess.bpmn</span><br><span class="line">资源名称png文件:diagrams/MyProcess.myProcess.png</span><br><span class="line">部署对象ID:<span class="number">50001</span></span><br><span class="line">################################</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu124.png" width="60%">

<p>可以模糊查询，根据某些字段查询，以及分页查询等等。</p>
<p>整体来说这些操作API的使用就跟Hibernate框架的使用差不多，它内部多封装好了你只需要调用即可。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（九）查看流程图片</title>
    <url>/2020/03/14/Activity-%EF%BC%88%E4%B9%9D%EF%BC%89%E6%9F%A5%E7%9C%8B%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%89%87/</url>
    <content><![CDATA[<p>在开发中可能需要查看某个流程的流程图片。</p>
<p>对应操作的数据库表是act_ge_bytearray的Bytes_字段：</p>
<img src="http://photo.wushaopei.com/qiniu131.png" width="80%">

<p>Activiti提供了操作接口，可以查询返回一个资源文件输入流，</p>
<p>然后就可以得到这张流程图片保存到本地服务器，然后图片多在自己的服务器上，</p>
<p>你想干什么多行。</p>
<p>先在pom.xml中添加IO的Jar架包：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后就是代码实现： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过流程部署ID获取流程图图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getImageById</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"><span class="comment">//        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery()</span></span><br><span class="line"><span class="comment">//        		.processDefinitionId("myProcess.png")</span></span><br><span class="line"><span class="comment">//        		.singleResult();</span></span><br><span class="line">        InputStream inputStream=processEngine.getRepositoryService()</span><br><span class="line">            .getResourceAsStream(<span class="string">"40001"</span>, <span class="string">"myProcess.png"</span>); <span class="comment">// 根据流程部署ID和资源名称获取输入流</span></span><br><span class="line">        FileUtils.copyInputStreamToFile(inputStream, <span class="keyword">new</span> File(<span class="string">"F:/myProcess.png"</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>实际开发的时候，一般会把图片存到项目路径下，然后名字的话，可以根据当前日期年月日时分秒来命名，</p>
<p>然后得到路径后，在新的页面，或者是模态窗口里显示图片；</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（二）Activiti-插件安装-（两种方式）</title>
    <url>/2020/03/04/Activity-%EF%BC%88%E4%BA%8C%EF%BC%89Activiti-%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85-%EF%BC%88%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%89/</url>
    <content><![CDATA[<h3 id="1、安装Eclipse插件"><a href="#1、安装Eclipse插件" class="headerlink" title="1、安装Eclipse插件"></a>1、安装Eclipse插件</h3><p>1.1 点击eclipse上方工具栏的<strong>Help</strong>，选择<strong>Install New Software</strong></p>
   <img src="https://img-blog.csdnimg.cn/20200224214620411.png" width="60%" >

<p>1.2 弹出如下窗口，然后填写插件名称和安装地址</p>
<p>Name: <strong>Activiti BPMN 2.0 designer</strong></p>
<p>Location: <strong><a href="http://activiti.org/designer/update/" target="_blank" rel="noopener">http://activiti.org/designer/update/</a></strong></p>
<p>然后便是不停的next和finish了，组图如下：</p>
<img src="https://img-blog.csdnimg.cn/20200224214701568.png" width="60%">



<img src="https://img-blog.csdnimg.cn/20200224214715436.png" width="60%">



<img src="https://img-blog.csdnimg.cn/20200224214736205.png" width="60%">



<p>1.3 安装完成后，我们在new的时候，操作面板中便有activiti的相关文件了。</p>
<img src="https://img-blog.csdnimg.cn/20200224214759466.png" width="60%">



<h3 id="2、使用activiti-designer-5-18-0-zip"><a href="#2、使用activiti-designer-5-18-0-zip" class="headerlink" title="2、使用activiti-designer-5.18.0.zip"></a>2、使用activiti-designer-5.18.0.zip</h3><p>2.1 解压   activiti-designer-5.18.0.zip</p>
<p>2.2 把压缩包中的内容放入eclipse根目录的dropins文件夹下</p>
<p>2.3 重启eclipse，点击新建工程new-&gt;Other…打开面板，如果看到下图内容：</p>
<img src="https://img-blog.csdnimg.cn/20200224214849792.png" width="60%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（六）流程定义部署ZIP方式</title>
    <url>/2020/03/13/Activity-%EF%BC%88%E5%85%AD%EF%BC%89%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E9%83%A8%E7%BD%B2ZIP%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<p>通过Classpath的方式加载资源文件来部署流程定义，这种方式始终有局限性，只能适合小项目固定流程写死的。</p>
<p>实际项目的话，需要使用动态导入流程定义文件，可以通过bpmn和png文件打包成zip压缩包，</p>
<p>然后用户界面直接导入到系统，然后在解析部署流程定义，Activiti插件是支持这种方式的。</p>
<p>把bpmn流程文件和png流程图文件打成zip压缩包，</p>
<p>放到diagrams文件下（ 在真实的项目中是通过文件上传实现的）：</p>
<img src="http://photo.wushaopei.com/qiniu112.png" width="60%">

<p>创建一个新的测试类ActivitHelloWorldZIPTest 其中新建一个deployWithZip()方法用zip方式来实现： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 部署流程定义使用zip方式</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deployWithZip</span><span class="params">()</span></span>&#123;</span><br><span class="line">      InputStream inputStream=<span class="keyword">this</span>.getClass()  <span class="comment">// 获取当前class对象</span></span><br><span class="line">                          .getClassLoader()   <span class="comment">// 获取类加载器</span></span><br><span class="line">                          .getResourceAsStream(<span class="string">"diagrams/MyProcess.zip"</span>); <span class="comment">// 获取指定文件资源流</span></span><br><span class="line">      ZipInputStream zipInputStream=<span class="keyword">new</span> ZipInputStream(inputStream); <span class="comment">// 实例化zip输入流对象</span></span><br><span class="line">      <span class="comment">// 获取部署对象</span></span><br><span class="line">      Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">                   .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">                   .name(<span class="string">"HelloWorld流程2"</span>)  <span class="comment">// 流程名称</span></span><br><span class="line">                   .addZipInputStream(zipInputStream)  <span class="comment">// 添加zip是输入流</span></span><br><span class="line">                   .deploy(); <span class="comment">// 部署</span></span><br><span class="line">      System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">      System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">09:37:20.775 [main] DEBUG org.activiti.engine.impl.interceptor.LogInterceptor - --- DeployCmd finished --------------------------------------------------------</span><br><span class="line">09:37:20.775 [main] DEBUG org.activiti.engine.impl.interceptor.LogInterceptor - </span><br><span class="line"></span><br><span class="line">流程部署ID:2501</span><br><span class="line">流程部署Name:HelloWorld流程2</span><br></pre></td></tr></table></figure>

<p>已经成功部署流程定义了。</p>
<p>查询定义流程 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询定义流程</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findProcessDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//流程定义和部署相关的service</span></span><br><span class="line">		RepositoryService repositoryService = processEngine.getRepositoryService();</span><br><span class="line">		<span class="comment">//创建一个流程定义的查询</span></span><br><span class="line">		ProcessDefinitionQuery createProcessDefinitionQuery = repositoryService.createProcessDefinitionQuery();</span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.deploymentId(deploymentId)使用对象部署id查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionId(processDefinitionId);使用流程定义的id查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionKey(processDefinitionKey);使用流程定义的key查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionNameLike(processDefinitionNameLike);使用流程定义的名称模糊查询</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionKey(processDefinitionKey).list();返回一个集合</span></span><br><span class="line">		<span class="comment">//createProcessDefinitionQuery.processDefinitionId(processDefinitionId).singleResult();返回唯一结果集</span></span><br><span class="line">		ProcessDefinitionQuery desc = createProcessDefinitionQuery.orderByProcessDefinitionVersion().desc();</span><br><span class="line">		List&lt;ProcessDefinition&gt; list = desc.list();</span><br><span class="line">		<span class="keyword">if</span>(list!=<span class="keyword">null</span>&amp;&amp;list.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">for</span>(ProcessDefinition ProcessDefinition:list)&#123;</span><br><span class="line">				System.out.println(<span class="string">"流程定义id"</span>+ProcessDefinition.getId());</span><br><span class="line">				System.out.println(<span class="string">"流程定义名称"</span>+ProcessDefinition.getName());</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>删除定义流程 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteProcessDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 不带级联删除</span></span><br><span class="line"><span class="comment">		 *  只能删除没有启动的流程 ，流程启动无法删除</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line"><span class="comment">//		processEngine.getRepositoryService().deleteDeployment("1");</span></span><br><span class="line">		<span class="comment">//可以删除任何流程 ，Id 取自 act_ge_bytearry 表的DEPLOYMENT_ID</span></span><br><span class="line">		processEngine.getRepositoryService().deleteDeployment(<span class="string">"2501"</span>,<span class="keyword">true</span>); </span><br><span class="line">		System.out.println(<span class="string">"ok"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>之后仔细观察Activiti25张表中的一些数据变化：</p>
<ol>
<li>act_re_deployment 流程定义部署表</li>
<li>act_re_procdef 流程定义表</li>
<li>act_ge_bytearry 资源文件表</li>
<li>act_ge_property 属性表</li>
</ol>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（八）流程定义删除</title>
    <url>/2020/03/14/Activity-%EF%BC%88%E5%85%AB%EF%BC%89%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E5%88%A0%E9%99%A4/</url>
    <content><![CDATA[<p>在开发中肯定会有一些流程不需要了，要删除，Activiti中也是存在删除操作的，</p>
<p>通过流程定义部署ID来执行删除流程定义。</p>
<p>不说那么多直接上代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除流程定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    processEngine.getRepositoryService()</span><br><span class="line">        .deleteDeployment(<span class="string">"12501"</span>); <span class="comment">// 流程部署ID</span></span><br><span class="line">    System.out.println(<span class="string">"刪除流程定义！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是有一种情况下比如： 这个流程定义的流程实例在运行中，尚未结束。</p>
<p>这时候如果你执行删除肯定会报错的。（这个就不用我多讲了吧，表与表之间的主外键关系）</p>
<p>当然在某种情况下必须要删除就要使用级联删除：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除流程定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    processEngine.getRepositoryService()</span><br><span class="line">        .deleteDeployment(<span class="string">"12501"</span>); <span class="comment">// 流程部署ID</span></span><br><span class="line">    System.out.println(<span class="string">"刪除流程定义！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式在属于在任何情况下多能直接删除流程定义，在实际开发中一般都是使用这种方式。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（十二）历史流程操作</title>
    <url>/2020/03/19/Activity-%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E5%8E%86%E5%8F%B2%E6%B5%81%E7%A8%8B%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>历史流程的操作，其本质上就是查询历史流程实例表act_hi_procinst:</p>
<p>该表中的 ID_ 和流程实例Id始终是一样的。所以Activiti没有提供获取流程实例id的接口；</p>
<p> 因为直接getId()获取的值和流程实例Id是一样的；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询历史流程实例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getHistoryProcessInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">       HistoricProcessInstance hpi= processEngine.getHistoryService() <span class="comment">// 历史任务Service</span></span><br><span class="line">           .createHistoricProcessInstanceQuery() <span class="comment">// 创建历史流程实例查询</span></span><br><span class="line">           .processInstanceId(<span class="string">"57501"</span>) <span class="comment">// 指定流程实例ID</span></span><br><span class="line">           .singleResult();</span><br><span class="line">       System.out.println(<span class="string">"流程实例ID:"</span>+hpi.getId());</span><br><span class="line">       System.out.println(<span class="string">"创建时间："</span>+hpi.getStartTime());</span><br><span class="line">       System.out.println(<span class="string">"结束时间："</span>+hpi.getEndTime());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">流程实例ID</span>:<span class="string">57501</span></span><br><span class="line"><span class="meta">创建时间：Thu</span> <span class="string">Mar 19 21:37:02 CST 2020</span></span><br><span class="line"><span class="meta">结束时间：Thu</span> <span class="string">Mar 19 21:42:17 CST 2020</span></span><br></pre></td></tr></table></figure>



<p><strong>历史流程任务查询act_hi_taskinst表：</strong></p>
<p><code>不管是已经完结的任务还是正在执行的任务，都会记录下这个表里。</code></p>
<p><code>Activiti给我们提供了一个接口finished；加了之后就是查询已经完结的任务；</code></p>
<p><code>同理还有一个接口unfinished 顾名思义，就是查询未完结的任务；当然这两个都不加，</code></p>
<p><code>就是把所有任务都查询出来；</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 历史任务查询</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">historyTaskList</span><span class="params">()</span></span>&#123;</span><br><span class="line">       List&lt;HistoricTaskInstance&gt; list=processEngine.getHistoryService() <span class="comment">// 历史任务Service</span></span><br><span class="line">               .createHistoricTaskInstanceQuery() <span class="comment">// 创建历史任务实例查询</span></span><br><span class="line">               .taskAssignee(<span class="string">"白夜行"</span>) <span class="comment">// 指定办理人</span></span><br><span class="line">               .finished() <span class="comment">// 查询已经完成的任务  </span></span><br><span class="line">               .list();</span><br><span class="line">       <span class="keyword">for</span>(HistoricTaskInstance hti:list)&#123;</span><br><span class="line">           System.out.println(<span class="string">"任务ID:"</span>+hti.getId());</span><br><span class="line">           System.out.println(<span class="string">"流程实例ID:"</span>+hti.getProcessInstanceId());</span><br><span class="line">           System.out.println(<span class="string">"班里人："</span>+hti.getAssignee());</span><br><span class="line">           System.out.println(<span class="string">"创建时间："</span>+hti.getCreateTime());</span><br><span class="line">           System.out.println(<span class="string">"结束时间："</span>+hti.getEndTime());</span><br><span class="line">           System.out.println(<span class="string">"==========================="</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">任务ID:57504</span><br><span class="line">流程实例ID:57501</span><br><span class="line">班里人：白夜行</span><br><span class="line">创建时间：Thu Mar 19 21:37:02 CST 2020</span><br><span class="line">结束时间：Thu Mar 19 21:42:17 CST 2020</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">任务ID:62504</span><br><span class="line">流程实例ID:62501</span><br><span class="line">班里人：白夜行</span><br><span class="line">创建时间：Thu Mar 19 21:41:19 CST 2020</span><br><span class="line">结束时间：Thu Mar 19 21:42:17 CST 2020</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
      <tags>
        <tag>历史流程实例</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity-（十）修改流程定义</title>
    <url>/2020/03/18/Activity-%EF%BC%88%E5%8D%81%EF%BC%89%E4%BF%AE%E6%94%B9%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[<p>流程定义按本质来说是不能修改的；假如一个流程定义的流程实例在活动运行中。</p>
<p>假如可以修改，本来要流转到A这个节点，因为流程定义修改了，流转到B这个节点。</p>
<p>就不符合当时这个流程实例的初衷了；</p>
<p>所以在开发中，不能修改流程定义，而是通过增加版本号的方式。来实现“修改”的；</p>
<p>什么是版本号呢?<br><img src="http://photo.wushaopei.com/qiniu132.png" width="60%"></p>
<p> 在设计流程图的时候，这里的Id 对应到数据库里的就是那个Key值  只要Id相同。就算是同一个流程定义；</p>
<p> 比如这个流程发布多次，Id一样，到数据库表那边 Key作为版本属性 值会增加；</p>
<img src="http://photo.wushaopei.com/qiniu133.png" width="60%">

<p> 启动流程实例的时候，是用Key来启动。这样启动的时候就是用的最新版本的流程定义来启动流程实例。</p>
<img src="http://photo.wushaopei.com/qiniu135.png" width="60%">

<p> 接着说说这个流程ID是怎样组成的：</p>
<img src="http://photo.wushaopei.com/qiniu134.png" width="60%">

<p> 这个Id值组成的话是  key值:版本号:流程部署ID。</p>
<p> 最后传说中的修改就是在发布一次流程定义，因为它在数据库中就原本就存在该流程，</p>
<p> 所以在发布一次它就会在版本号这个字段增加。在到做流程操作的时候之须取最新的版本号即可。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（十一）删除Key相同的流程</title>
    <url>/2020/03/18/Activity-%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E5%88%A0%E9%99%A4Key%E7%9B%B8%E5%90%8C%E7%9A%84%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<p> 一个流程定义不需要的，包括所有版本，这时候在用户界面上一个一个删除太麻烦；</p>
<p> 有时候有这样的需求，一下子把所有Key相同的流程定义批量删除；</p>
<p> 实现步骤是：</p>
<p> 1、根据Key查询所有的流程定义</p>
<p> 2、遍历集合，取得每个流程的部署ID</p>
<p> 3、根据流程部署ID即可删除所有的流程定义</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除所有Key相同的流程定义</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteByKey</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; pdList=processEngine.getRepositoryService()  <span class="comment">// 获取service类</span></span><br><span class="line">            .createProcessDefinitionQuery() <span class="comment">// 创建流程定义查询</span></span><br><span class="line">            .processDefinitionKey(<span class="string">"myProcess"</span>) <span class="comment">// 根据Key查询</span></span><br><span class="line">            .list();</span><br><span class="line">    <span class="keyword">for</span>(ProcessDefinition pd:pdList)&#123;  <span class="comment">// 遍历集合 获取流程定义的每个部署Id，根据这个id来删除所有流程定义</span></span><br><span class="line">        processEngine.getRepositoryService()</span><br><span class="line">        .deleteDeployment(pd.getDeploymentId(), <span class="keyword">true</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity（四）流程设计工具创建流程图</title>
    <url>/2020/03/09/Activity-%EF%BC%88%E5%9B%9B%EF%BC%89%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1%E5%B7%A5%E5%85%B7%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%9B%BE/</url>
    <content><![CDATA[<h3 id="1、引言"><a href="#1、引言" class="headerlink" title="1、引言"></a>1、引言</h3><p>在前面我们知道了怎么创建流程控制引擎，而<strong>Activiti</strong> 的正常使用还需要进行部署流程，而这就有一个很重要的前提。那就是创建相应的流程图，并让其能被 <strong>service</strong> 所调用从而实现流程的执行。</p>
<h3 id="2、流程图创建工具"><a href="#2、流程图创建工具" class="headerlink" title="2、流程图创建工具"></a>2、流程图创建工具</h3><h4 id="2-1-简述第一种创建方式"><a href="#2-1-简述第一种创建方式" class="headerlink" title="2.1 简述第一种创建方式"></a>2.1 简述第一种创建方式</h4><p><code>在这里说明一点，流程图的创建可以使用两种方式，第一种是XML版本的，案例如下：</code></p>
<img src="http://photo.wushaopei.com/qiniu64.png" width="60%">

<p>我们看到的是一个<a href="https://www.activiti.org/5.x/userguide/#bpmnNoneStartEvent" target="_blank" rel="noopener">无开始事件</a>（左侧的圆圈），后面是两个<a href="https://www.activiti.org/5.x/userguide/#bpmnUserTask" target="_blank" rel="noopener">用户任务</a>：<em>“写每月财务报告”</em>和 <em>“验证每月财务报告”</em>，以一个<a href="https://www.activiti.org/5.x/userguide/#bpmnNoneEndEvent" target="_blank" rel="noopener">无结束事件</a>（右侧带有粗边框的圆圈）结束。 </p>
<ul>
<li>在这里，<strong>start task</strong> 告诉我们什么<em>入口点</em>的过程。</li>
<li>在 <strong>user task</strong> 声明是我们的过程的人工任务的表示。请注意，第一个任务分配给<em>会计</em>组，而第二个任务分配给<em>管理</em>组。有关如何将用户和组分配给用户任务的更多信息，请参见<a href="https://www.activiti.org/5.x/userguide/#bpmnUserTaskAssignment" target="_blank" rel="noopener">用户任务分配部分</a>。</li>
<li>当到达 <strong>end task</strong> 时，该过程结束。</li>
<li>这些元素通过<a href="https://www.activiti.org/5.x/userguide/#bpmnSequenceFlow" target="_blank" rel="noopener">顺序流</a>相互连接。这些顺序流具有<code>source</code>和<code>target</code>，用于定义顺序流的<em>方向</em>。</li>
</ul>
<p>其对应的xml 版本的配置如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;definitions</span> <span class="string">id="definitions"</span></span><br><span class="line">  <span class="attr">targetNamespace</span>=<span class="string">"http://activiti.org/bpmn20"</span></span><br><span class="line">  <span class="attr">xmlns</span>:<span class="string">activiti="http://activiti.org/bpmn"</span></span><br><span class="line">  <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">&lt;process</span> <span class="string">id="financialReport" name="Monthly financial report reminder process"&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;startEvent</span> <span class="string">id="theStart" /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;sequenceFlow</span> <span class="string">id='flow1' sourceRef='theStart' targetRef='writeReportTask' /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;userTask</span> <span class="string">id="writeReportTask" name="Write monthly financial report" &gt;</span></span><br><span class="line">	    <span class="attr">&lt;documentation&gt;</span></span><br><span class="line">	      <span class="attr">Write</span> <span class="string">monthly financial report for publication to shareholders.</span></span><br><span class="line">	    <span class="attr">&lt;/documentation&gt;</span></span><br><span class="line">	    <span class="attr">&lt;potentialOwner&gt;</span></span><br><span class="line">	      <span class="attr">&lt;resourceAssignmentExpression&gt;</span></span><br><span class="line">	        <span class="attr">&lt;formalExpression&gt;accountancy&lt;/formalExpression&gt;</span></span><br><span class="line">	      <span class="attr">&lt;/resourceAssignmentExpression&gt;</span></span><br><span class="line">	    <span class="attr">&lt;/potentialOwner&gt;</span></span><br><span class="line">	  <span class="attr">&lt;/userTask&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;sequenceFlow</span> <span class="string">id='flow2' sourceRef='writeReportTask' targetRef='verifyReportTask' /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;userTask</span> <span class="string">id="verifyReportTask" name="Verify monthly financial report" &gt;</span></span><br><span class="line">	    <span class="attr">&lt;documentation&gt;</span></span><br><span class="line">	      <span class="attr">Verify</span> <span class="string">monthly financial report composed by the accountancy department.</span></span><br><span class="line">	      <span class="attr">This</span> <span class="string">financial report is going to be sent to all the company shareholders.</span></span><br><span class="line">	    <span class="attr">&lt;/documentation&gt;</span></span><br><span class="line">	    <span class="attr">&lt;potentialOwner&gt;</span></span><br><span class="line">	      <span class="attr">&lt;resourceAssignmentExpression&gt;</span></span><br><span class="line">	        <span class="attr">&lt;formalExpression&gt;management&lt;/formalExpression&gt;</span></span><br><span class="line">	      <span class="attr">&lt;/resourceAssignmentExpression&gt;</span></span><br><span class="line">	    <span class="attr">&lt;/potentialOwner&gt;</span></span><br><span class="line">	  <span class="attr">&lt;/userTask&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;sequenceFlow</span> <span class="string">id='flow3' sourceRef='verifyReportTask' targetRef='theEnd' /&gt;</span></span><br><span class="line"></span><br><span class="line">	  <span class="meta">&lt;endEvent</span> <span class="string">id="theEnd" /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">&lt;/process&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;/definitions&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-视图模式创建流程图"><a href="#2-2-视图模式创建流程图" class="headerlink" title="2.2 视图模式创建流程图"></a>2.2 视图模式创建流程图</h4><img src="http://photo.wushaopei.com/qiniu65.png" width="60%">

<p><strong>这里我们创建一个简单的流程图作为示范入门。</strong></p>
<p>开发流程 首先要做的，就是要设计好流程图；一个项目可能会包括多个流程图；所以在<strong>src/test/resources</strong>源文件夹下新建一个包<strong>diagrams</strong>，以后所有的流程图文件(bpmn文件和生成的png文件)都放在这个包下； </p>
<img src="http://photo.wushaopei.com/qiniu66.png" width="60%">

<p>然后在<strong>diagrams</strong>上右击，<strong>New - &gt; Other</strong> ：创建一个新的流程实例图 </p>
<img src="http://photo.wushaopei.com/qiniu67.png" width="60%">

<p>选择 <strong>Activiti</strong>下的 <strong>Activiti Diagram</strong> 要开始开发一个<strong>Activiti</strong>流程图表： </p>
<img src="http://photo.wushaopei.com/qiniu68.png" width="60%">

<p>这里 中间区域，是用来绘制流程图标的。右侧是绘制流程图标的工具箱，下面的Properties是属性视图，目前看到的是整个helloWorld流程图的属性： </p>
<img src="http://photo.wushaopei.com/qiniu69.png" width="60%">

<p>然后来画流程图，任何流程，都必须有一个开始事件节点和结束事件节点： </p>
<img src="http://photo.wushaopei.com/qiniu70.png" width="60%">

<p> 在右侧的工具箱里会看到有个<strong>StartEvent</strong> 和<strong>EndEvent</strong>。先点下  然后拖到中间的绘图区域就<strong>OK</strong>了；</p>
<p> 当然每个节点的属性都可以看到，而且可以设置，可以点击选中一个节点，然后在属性视图上看到所以值；</p>
<img src="http://photo.wushaopei.com/qiniu71.png" width="60%">

<p> 会看到这里插件都给设置了初识属性值，可以改  ，也可以不改，都行；</p>
<p> 之后在搞一个用户任务节点（开发最常用的节点），拖一个到中间绘图区域</p>
<img src="http://photo.wushaopei.com/qiniu72.png" width="60%">

<p> 这里的任务节点，必须要有一个人去处理这个任务，而且在实际开发中，根据实际业务，给这个用户任务节点取个名字，</p>
<p> 当然这里是初识，所以就搞个<strong>myprocess</strong>名字，然后分配给“<strong>小龙</strong>”这个人；</p>
<img src="http://photo.wushaopei.com/qiniu73.png" width="60%">

<p>这样就完成了最简单的流程图设计。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity（十六）并行网关</title>
    <url>/2020/04/21/Activity%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%E5%B9%B6%E8%A1%8C%E7%BD%91%E5%85%B3/</url>
    <content><![CDATA[<p>​     并行网关：是会有多条线路同时并行执行，当都执行完才继续执行后面的。</p>
<p>重新画一个流程图取名 MyProcess5.bpmn：</p>
<img src="http://photo.wushaopei.com/qiniu411.png" width="80%">

<p>整体业务是：  员工发起请假申请——&gt;需要部门、经理都同意审批——&gt;才进入最好总监审批</p>
<p>——&gt;需要以上所有人同意方能请假成功</p>
<p>测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.HistoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngines;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RuntimeService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.TaskService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstanceQuery;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.Deployment;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.Execution;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.ProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.Task;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.TaskQuery;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.entity.Employee;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 并行网关</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月21日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">activiti_parallel</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取默认的流程引擎实例 会自动读取activiti.cfg.xml文件 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义一个成员变量</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line">    </span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line">    </span><br><span class="line">    TaskService taskService;</span><br><span class="line">    </span><br><span class="line">    HistoryService historyService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取流程引擎</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">        repositoryService = processEngine.getRepositoryService();</span><br><span class="line">        runtimeService = processEngine.getRuntimeService();</span><br><span class="line">        taskService = processEngine.getTaskService();</span><br><span class="line">        historyService = processEngine.getHistoryService();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 部署流程定义</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="comment">// 获取部署对象</span></span><br><span class="line">	    Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">	                 .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">	                 .addClasspathResource(<span class="string">"diagrams/MyProcess5.bpmn"</span>)  <span class="comment">// 加载资源文件</span></span><br><span class="line">	                 .deploy(); <span class="comment">// 部署</span></span><br><span class="line">	    System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">	    System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"parallel"</span>);</span><br><span class="line">        String processInstanceId = processInstance.getId();</span><br><span class="line">        String activityId = processInstance.getActivityId();</span><br><span class="line">        String definitionId = processInstance.getProcessDefinitionId();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"流程实例ID："</span>+processInstanceId);</span><br><span class="line">        System.out.println(<span class="string">"正在活动的节点ID："</span>+activityId);</span><br><span class="line">        System.out.println(<span class="string">"流程定义ID："</span>+definitionId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        String assignee = <span class="string">"刘松"</span>;  </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 查询并且返回任务即可</span></span><br><span class="line">        List&lt;Task&gt; taskList = taskService.createTaskQuery()  <span class="comment">// 任务相关Service // 创建任务查询</span></span><br><span class="line">                                     .processDefinitionKey(<span class="string">"parallel"</span>)</span><br><span class="line">                                     .taskAssignee(assignee)<span class="comment">// 指定某个人</span></span><br><span class="line">                                     .orderByTaskCreateTime()</span><br><span class="line">                                     .desc()</span><br><span class="line">                                     .list();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(Task task:taskList)&#123;</span><br><span class="line">            System.out.println(<span class="string">"任务ID:"</span>+task.getId()); </span><br><span class="line">            System.out.println(<span class="string">"任务名称:"</span>+task.getName());</span><br><span class="line">            System.out.println(<span class="string">"任务创建时间:"</span>+task.getCreateTime());</span><br><span class="line">            System.out.println(<span class="string">"任务委派人:"</span>+task.getAssignee());</span><br><span class="line">            System.out.println(<span class="string">"流程实例ID:"</span>+task.getProcessInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	</span><br><span class="line">	  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询当前流程实例状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryProInstanceStateByProInstanceId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(<span class="string">"202501"</span>).singleResult();</span><br><span class="line">        <span class="keyword">if</span>(processInstance == <span class="keyword">null</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"当前流程已经完成"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"当前流程实例ID："</span>+processInstance.getId());</span><br><span class="line">            System.out.println(<span class="string">"当前流程所处的位置："</span>+processInstance.getActivityId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//完成任务</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTaskComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    		</span><br><span class="line">     		<span class="comment">//任务委托人</span></span><br><span class="line">    		String assignee = <span class="string">"刘松"</span>; <span class="comment">//分别执行部门和经理</span></span><br><span class="line">    		</span><br><span class="line">    		<span class="comment">//查询当前委托人需要完成的任务</span></span><br><span class="line">    		List&lt;Task&gt; taskList = taskService.createTaskQuery()</span><br><span class="line">    				   .processDefinitionKey(<span class="string">"parallel"</span>)</span><br><span class="line">    				   .taskAssignee(assignee)</span><br><span class="line">    				   .list();</span><br><span class="line">    		</span><br><span class="line">    		<span class="keyword">for</span> (Task task : taskList) &#123;</span><br><span class="line">    			System.err.println(<span class="string">"审批人："</span>+task);</span><br><span class="line">    			</span><br><span class="line">    			<span class="comment">//完成当前任务</span></span><br><span class="line">    			<span class="comment">//获取任务id</span></span><br><span class="line">    			String taskId = task.getId();</span><br><span class="line">    			<span class="comment">//完成指定id的任务</span></span><br><span class="line">    			taskService.complete(taskId);</span><br><span class="line">    		&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 完成任务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		processEngine.getTaskService().complete(<span class="string">"202501"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
      <tags>
        <tag>并行网关</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity（十四）流程连线</title>
    <url>/2020/04/21/Activity%EF%BC%88%E5%8D%81%E5%9B%9B%EF%BC%89%E6%B5%81%E7%A8%8B%E8%BF%9E%E7%BA%BF/</url>
    <content><![CDATA[<img src="http://photo.wushaopei.com/qiniu403.png" width="80%">

<p>当时一般情况下是部门经理审批就行了，假如有特殊的重要情况下就总监审批。</p>
<p>这里连线是有名称的，即name属性；</p>
<img src="http://photo.wushaopei.com/qiniu404.png" width="80%">

<p>怎么区分一般情况和重要情况呢？这里其实是可以使用执行表达式的类似于EL表达式： </p>
<img src="http://photo.wushaopei.com/qiniu405.png" width="80%">

<p><strong>创建ActivitiLineTest测试类：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.HistoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngines;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RuntimeService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.TaskService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstanceQuery;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.Deployment;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.Execution;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.ProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.Task;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.TaskQuery;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.entity.Employee;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> activiti_ligature.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月21日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">activiti_ligature</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取默认的流程引擎实例 会自动读取activiti.cfg.xml文件 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义一个成员变量</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line">    </span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line">    </span><br><span class="line">    TaskService taskService;</span><br><span class="line">    </span><br><span class="line">    HistoryService historyService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取流程引擎</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">        repositoryService = processEngine.getRepositoryService();</span><br><span class="line">        runtimeService = processEngine.getRuntimeService();</span><br><span class="line">        taskService = processEngine.getTaskService();</span><br><span class="line">        historyService = processEngine.getHistoryService();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 部署流程定义</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="comment">// 获取部署对象</span></span><br><span class="line">	    Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">	                 .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">	                 .addClasspathResource(<span class="string">"diagrams/MyProcess3.bpmn"</span>)  <span class="comment">// 加载资源文件</span></span><br><span class="line">	                 .deploy(); <span class="comment">// 部署</span></span><br><span class="line">	    System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">	    System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"myProcess"</span>);</span><br><span class="line">        String processInstanceId = processInstance.getId();</span><br><span class="line">        String activityId = processInstance.getActivityId();</span><br><span class="line">        String definitionId = processInstance.getProcessDefinitionId();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"流程实例ID："</span>+processInstanceId);</span><br><span class="line">        System.out.println(<span class="string">"正在活动的节点ID："</span>+activityId);</span><br><span class="line">        System.out.println(<span class="string">"流程定义ID："</span>+definitionId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        String assignee = <span class="string">"刘松"</span>;  </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 查询并且返回任务即可</span></span><br><span class="line">        List&lt;Task&gt; taskList = taskService.createTaskQuery()  <span class="comment">// 任务相关Service // 创建任务查询</span></span><br><span class="line">                                     .processDefinitionKey(<span class="string">"myProcess"</span>)</span><br><span class="line">                                     .taskAssignee(assignee)<span class="comment">// 指定某个人</span></span><br><span class="line">                                     .orderByTaskCreateTime()</span><br><span class="line">                                     .desc()</span><br><span class="line">                                     .list();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(Task task:taskList)&#123;</span><br><span class="line">            System.out.println(<span class="string">"任务ID:"</span>+task.getId()); </span><br><span class="line">            System.out.println(<span class="string">"任务名称:"</span>+task.getName());</span><br><span class="line">            System.out.println(<span class="string">"任务创建时间:"</span>+task.getCreateTime());</span><br><span class="line">            System.out.println(<span class="string">"任务委派人:"</span>+task.getAssignee());</span><br><span class="line">            System.out.println(<span class="string">"流程实例ID:"</span>+task.getProcessInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 完成任务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		processEngine.getTaskService().complete(<span class="string">"167504"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 完成任务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask2</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		  Map&lt;String, Object&gt; variables=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">	        <span class="comment">//传入流程变量</span></span><br><span class="line">	        variables.put(<span class="string">"msg"</span>, <span class="string">"一般情况"</span>);</span><br><span class="line">	        processEngine.getTaskService() <span class="comment">// 任务相关Service</span></span><br><span class="line">	            .complete(<span class="string">"170002"</span>, variables); <span class="comment">//这里使用任务ID，完成任务的时候，设置流程变量</span></span><br><span class="line">	</span><br><span class="line">	&#125;	</span><br><span class="line">	</span><br><span class="line">	  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询当前流程实例状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryProInstanceStateByProInstanceId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(<span class="string">"167501"</span>).singleResult();   <span class="comment">// 这里使用 流程实例ID 查看当前流程实例是否完成</span></span><br><span class="line">        <span class="keyword">if</span>(processInstance == <span class="keyword">null</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"当前流程已经完成"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"当前流程实例ID："</span>+processInstance.getId());</span><br><span class="line">            System.out.println(<span class="string">"当前流程所处的位置："</span>+processInstance.getActivityId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>completeTask2()方法 执行到部门审批的时候，通过设置流程变量，来执行具体的流程走向；</p>
 <img src="http://photo.wushaopei.com/qiniu406.png" width="80%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
      <tags>
        <tag>流程连线</tag>
      </tags>
  </entry>
  <entry>
    <title>EasyUI笔记（一）EasyUI入门</title>
    <url>/2020/03/14/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89-EasyUI%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h3 id="EasyUI-入门概述"><a href="#EasyUI-入门概述" class="headerlink" title="EasyUI 入门概述"></a>EasyUI 入门概述</h3><p>​    <strong>easyui</strong>为Web开发人员提供了易于使用的组件，它构建在流行的<strong>jquery</strong>核心和<strong>html5</strong>之上。这些使您能够轻松的做出符合<strong>html5</strong>标准的<strong>web</strong>应用程序。</p>
<p>​    </p>
<h3 id="声明UI组件有两种方法："><a href="#声明UI组件有两种方法：" class="headerlink" title="声明UI组件有两种方法："></a>声明UI组件有两种方法：</h3><h4 id="直接在HTML中声明组件"><a href="#直接在HTML中声明组件" class="headerlink" title="直接在HTML中声明组件"></a>直接在HTML中声明组件</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"easyui-dialog"</span> style=<span class="string">"width:400px;height:200px"</span></span><br><span class="line">    data-options=<span class="string">"</span></span><br><span class="line"><span class="string">        title:'My Dialog',</span></span><br><span class="line"><span class="string">        iconCls:'icon-ok',</span></span><br><span class="line"><span class="string">        onOpen:function()&#123;&#125;"</span>&gt;</span><br><span class="line">    dialog content.</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h4 id="编写JavaScript代码来创建组件"><a href="#编写JavaScript代码来创建组件" class="headerlink" title="编写JavaScript代码来创建组件"></a>编写JavaScript代码来创建组件</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;input id=<span class="string">"cc"</span> style=<span class="string">"width:200px"</span> /&gt;</span><br><span class="line"></span><br><span class="line">$(<span class="string">'#cc'</span>).combobox(&#123;</span><br><span class="line">	url: ...,</span><br><span class="line">	required: <span class="keyword">true</span>,</span><br><span class="line">	valueField: <span class="string">'id'</span>,</span><br><span class="line">	textField: <span class="string">'text'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h3><p>遵循： <code>控件 - 属性 - 方法 - 事件</code></p>
<h4 id="控件："><a href="#控件：" class="headerlink" title="控件："></a>控件：</h4><p>​    所有的属性都定义在jQuery.fn.<strong>{plugin}</strong>.defaults里面。例如，对话框属性定义在jQuery.fn.<strong>dialog</strong>.defaults里面。</p>
<h4 id="属性："><a href="#属性：" class="headerlink" title="属性："></a>属性：</h4><p>​    所有的事件（回调函数）也都定义在jQuery.fn.<strong>{plugin}</strong>.defaults里面。</p>
<h4 id="事件："><a href="#事件：" class="headerlink" title="事件："></a>事件：</h4><p>​    所有的事件（回调函数）也都定义在jQuery.fn.<strong>{plugin}</strong>.defaults里面。</p>
<h4 id="方法："><a href="#方法：" class="headerlink" title="方法："></a>方法：</h4><p>​    调用方法的语法：$(‘selector’).plugin(‘method’, parameter); </p>
<p><strong>解释：</strong>  </p>
<ul>
<li>selector 是jQery对象选择器。</li>
<li>plugin 是插件的名称。</li>
<li>method 是相应插件现有的方法。</li>
<li>parameter  是参数对象，可以是一个对象、字符串等。</li>
</ul>
<p>所有方法都定义在jQuery.fn.<strong>{plugin}</strong>.methods。每个方法都有2个参数：jq和param。第一个参数’jq’是必须的，这是指的jQuery对象。第二个参数’param’是指传入方法的实际参数。例如，为dialog组件扩展一个方法名为’mymove’，代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">$.extend($.fn.dialog.methods, &#123;    </span><br><span class="line">    mymove: function(jq, newposition)&#123;    </span><br><span class="line">        return jq.each(function()&#123;    </span><br><span class="line">            $(this).dialog('move', newposition);    </span><br><span class="line">        &#125;);    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>现在你可以调用’mymove’方法将对话框移动到指定位置：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">$('#dd').dialog('mymove', &#123;    </span><br><span class="line">    left: 200,    </span><br><span class="line">    top: 100    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>EasyUI笔记（四）控件的引入与事件的发生</title>
    <url>/2020/03/25/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E6%8E%A7%E4%BB%B6%E7%9A%84%E5%BC%95%E5%85%A5%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="控件的引入"><a href="#控件的引入" class="headerlink" title="控件的引入"></a>控件的引入</h1><h2 id="引入布局"><a href="#引入布局" class="headerlink" title="引入布局"></a>引入布局</h2><h3 id="在页面中引用资源"><a href="#在页面中引用资源" class="headerlink" title="在页面中引用资源"></a>在页面中引用资源</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;主界面&lt;/title&gt;</span><br><span class="line">    &lt;script type="text/javascript" src="/easyui/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type="text/javascript" src="/easyui/jquery.easyui.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type="text/javascript" src="/easyui/easyloader.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"/easyui/themes/icon.css"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span>  href=<span class="string">"/easyui/themes/default/easyui.css"</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br></pre></td></tr></table></figure>

<h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;body <span class="class"><span class="keyword">class</span></span>=<span class="string">"easyui-layout"</span>&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'north',title:'头部',split:true"</span> style=<span class="string">"height:100px;"</span>&gt;</span><br><span class="line">            &lt;h1&gt; 顶部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'south',title:'底部',split:true"</span> style=<span class="string">"height:100px;"</span>&gt;</span><br><span class="line">            &lt;h1&gt;底部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'west',title:'左部',split:true"</span> style=<span class="string">"width:200px;"</span>&gt;</span><br><span class="line">            &lt;h1&gt;左部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div data-options=<span class="string">"region:'center',title:'中部'"</span>  &gt;</span><br><span class="line">            &lt;h1&gt;中部 &lt;/h1&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<h3 id="页面布局效果"><a href="#页面布局效果" class="headerlink" title="页面布局效果"></a>页面布局效果</h3><p><strong>index .html</strong></p>
<ol>
<li>****主界面分为三部分：top，left，right</li>
<li>Left部分有个树形菜单</li>
<li>right部分显示左侧菜单点击后的详细页面。</li>
</ol>
<img src="http://photo.wushaopei.com/qiniu235.png" width="70%">

<h2 id="手风琴控件引入"><a href="#手风琴控件引入" class="headerlink" title="手风琴控件引入"></a>手风琴控件引入</h2><h3 id="手风琴列表"><a href="#手风琴列表" class="headerlink" title="手风琴列表"></a>手风琴列表</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-options</span>=<span class="string">"region:'west',title:'左部',split:true"</span> <span class="attr">style</span>=<span class="string">"width:200px;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"easyui-accordion"</span> <span class="attr">style</span>=<span class="string">"overflow:auto;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"About"</span> <span class="attr">data-option</span>=<span class="string">"iconCls:'icon-ok'"</span> <span class="attr">style</span>=<span class="string">"voerflow:auto;padding:10px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>商品属性管理<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"Help"</span> <span class="attr">data-option</span>=<span class="string">"iconCls:'icon-help'"</span> <span class="attr">style</span>=<span class="string">"padding:10px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>SPU管理<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"TreeMenu"</span> <span class="attr">data-option</span>=<span class="string">"iconCls:'icon-search'"</span> <span class="attr">style</span>=<span class="string">"padding:10px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>仓库接口管理<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里将手风琴控件放置到 左边栏的div 标签内，每添加一个菜单项，只需要在 class=”easyui-accordion”的div标签作用域内添加新的 div 标签即可。</p>
<img src="http://photo.wushaopei.com/qiniu236.png" width="50%">

<h3 id="左侧-菜单项添加子菜单"><a href="#左侧-菜单项添加子菜单" class="headerlink" title="左侧-菜单项添加子菜单"></a>左侧-菜单项添加子菜单</h3><img src="http://photo.wushaopei.com/qiniu237.png" width="40%">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">style</span>=<span class="string">"text-decoration:none;"</span>&gt;</span>平台属性管理<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;p align="center"&gt;&lt;a href="#" style="text-decoration:none;"&gt;平台属性管理&lt;/a&gt;&lt;/p&gt; --&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这里添加子菜单，其实就是在下拉的菜单列表中添加多个单行的 无序列表，该无序列表的每个<code>&lt;li &gt;&lt; /li&gt;</code> 标签独占一行。</p>
<p>因此，除了使用<code>&lt;ul&gt;</code> 标签外，也可以使用如<code>&lt;p&gt;</code>标签，这里使用<code>&lt;p&gt;&lt;/p&gt;</code> 标签.</p>
<h2 id="选项卡控件引入"><a href="#选项卡控件引入" class="headerlink" title="选项卡控件引入"></a>选项卡控件引入</h2><h3 id="中部-增加tab组件"><a href="#中部-增加tab组件" class="headerlink" title="中部-增加tab组件"></a>中部-增加tab组件</h3><h4 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h4><img src="http://photo.wushaopei.com/qiniu253.png" width="70%">



<p>关于选项卡控件的引入规则：这里通过点击“平台属性管理”这一个<code>&lt;/li&gt;</code>  标签来实现页面中部的选项卡控件的展现。</p>
<h4 id="添加选项卡控件："><a href="#添加选项卡控件：" class="headerlink" title="添加选项卡控件："></a>添加选项卡控件：</h4><img src="http://photo.wushaopei.com/qiniu254.png" width="60%">

<p>控件的引入可以从 demo 中去取到对应的代码。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"tt"</span> <span class="attr">class</span>=<span class="string">"easyui-tabs"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将该<code>&lt;div&gt;</code> 标签添加到 布局中部的 <code>&lt;div&gt;</code> 中。</p>
<h4 id="添加后代码位置："><a href="#添加后代码位置：" class="headerlink" title="添加后代码位置："></a>添加后代码位置：</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-options</span>=<span class="string">"region:'center',title:'中部'"</span>  &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"tt"</span> <span class="attr">class</span>=<span class="string">"easyui-tabs"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="事件的发生"><a href="#事件的发生" class="headerlink" title="事件的发生"></a>事件的发生</h1><h2 id="生成新页面"><a href="#生成新页面" class="headerlink" title="生成新页面"></a>生成新页面</h2><p>这里考虑一点，当点击左部手风琴内菜单项“商品属性管理”时要在中部弹出一个新的页面。如下图：</p>
<img src="http://photo.wushaopei.com/qiniu255.png" width="70%">

<p><strong>实现方法：</strong> 通过点击事件进行页面的添加</p>
<h3 id="函数事件"><a href="#函数事件" class="headerlink" title="函数事件"></a>函数事件</h3><h4 id="点击菜单增加右边的标签"><a href="#点击菜单增加右边的标签" class="headerlink" title="点击菜单增加右边的标签"></a>点击菜单增加右边的标签</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">title</span>=<span class="string">"基本信息管理"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:add_tab('商品属性管理','attrListPage')"</span> <span class="attr">style</span>=<span class="string">"text-decoration:none;"</span>&gt;</span>商品属性管理<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>给要点击的那一个菜单项添加一个事件， 使用 <code>&lt;a&gt;</code> 标签配合 href 调用 js 语言添加新页面。</p>
<p><strong>注意：</strong>  如果要想填充到指定的<code>&lt;div&gt;</code>位置，需要获取该 <code>&lt;div&gt;</code> 标签的 id ，并使用 easyui 提供的属性进行填充，详情可以参考EasyUI提供的API文档，相关截图如下：</p>
<img src="http://photo.wushaopei.com/qiniu256.png" width="60%">

<h4 id="function-事件"><a href="#function-事件" class="headerlink" title="function 事件"></a>function 事件</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">add_tab</span><span class="params">(title,url)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">        alert(<span class="string">"调用后台的"</span>+url+<span class="string">"方法，返回一个页面，填充到"</span>);</span></span><br><span class="line">        </span><br><span class="line"><span class="javascript">        $(<span class="string">'#tt'</span>).tabs(<span class="string">'add'</span>,&#123;    </span></span><br><span class="line">            title:title,    </span><br><span class="line">            href: url,</span><br><span class="line"><span class="actionscript">            closable:<span class="literal">true</span>,    </span></span><br><span class="line">            tools:[&#123;    </span><br><span class="line"><span class="actionscript">                iconCls:<span class="string">'icon-mini-refresh'</span>,    </span></span><br><span class="line"><span class="actionscript">                handler:<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;    </span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'refresh'</span>);    </span></span><br><span class="line">                &#125;    </span><br><span class="line">            &#125;]    </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里通过 add_tab（title,url）向后台进行请求，并返回一个 页面进行填充到中部，这里可以看成添加到 <code>&lt;div&gt;</code> 中。</p>
<h4 id="添加结果："><a href="#添加结果：" class="headerlink" title="添加结果："></a>添加结果：</h4><img src="http://photo.wushaopei.com/qiniu257.png" width="70%">

<h4 id="页面重复添加的校验"><a href="#页面重复添加的校验" class="headerlink" title="页面重复添加的校验"></a>页面重复添加的校验</h4><p>​    避免多次点击“商品属性管理”而导致多次添加对应的页面到中部区域。</p>
<p>解决方法：EasyUI自身就提供了这么一个功能。</p>
<p>EasyUI 的API中提供了两个方法适用于这个方面，一个是select，另一个是exists；select可以用于定位到指定的面板，而exists则可以用于判断指定的面板是否存在。</p>
<h5 id="具体代码如下："><a href="#具体代码如下：" class="headerlink" title="具体代码如下："></a>具体代码如下：</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> b =$(<span class="string">'#tt'</span>).tabs(<span class="string">'exists'</span>,title); <span class="comment">// 判断传入的面板（页面）是否存在</span></span><br><span class="line"><span class="keyword">if</span>(!b)&#123;	        	<span class="comment">// 默认不存在的情况下进行添加</span></span><br><span class="line">     	$(<span class="string">'#tt'</span>).tabs(<span class="string">'add'</span>,&#123;    </span><br><span class="line">          title:title,    </span><br><span class="line">          href: url,</span><br><span class="line">          closable:<span class="literal">true</span>,    </span><br><span class="line">          tools:[&#123;    </span><br><span class="line">              iconCls:<span class="string">'icon-mini-refresh'</span>,    </span><br><span class="line">              handler:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;    </span><br><span class="line">                  alert(<span class="string">'refresh'</span>);    </span><br><span class="line">              &#125;    </span><br><span class="line">          &#125;]    </span><br><span class="line">      &#125;);  </span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;     <span class="comment">// 如果存在的话就定位到该页面（面板）</span></span><br><span class="line">     	$(<span class="string">'#tt'</span>).tabs(<span class="string">'select'</span>,title);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>Activity（十五）排他网关</title>
    <url>/2020/04/21/Activity%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3/</url>
    <content><![CDATA[<p>执行到该网关，根据条件只能走一条执行线路； </p>
<img src="http://photo.wushaopei.com/qiniu407.png" width="80%">

<p> 根据请假天数，来具体让谁来审批，</p>
<p> 请假天数小于3天，部门审批；</p>
<p> 请假天数小于7天，大于等于3天，经理审批；</p>
<p> 请假天数大于等于7天，总监审批；</p>
<p>依然用表达式来实现请假天数的判断值：</p>
<img src="http://photo.wushaopei.com/qiniu408.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu409.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu410.png" width="80%">

<p><strong>直接上代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.HistoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngines;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RuntimeService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.TaskService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstanceQuery;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.Deployment;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.Execution;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.ProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.Task;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.TaskQuery;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.entity.Employee;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 排他网关</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月21日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">activiti_exclusive</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取默认的流程引擎实例 会自动读取activiti.cfg.xml文件 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义一个成员变量</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line">    </span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line">    </span><br><span class="line">    TaskService taskService;</span><br><span class="line">    </span><br><span class="line">    HistoryService historyService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取流程引擎</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">        repositoryService = processEngine.getRepositoryService();</span><br><span class="line">        runtimeService = processEngine.getRuntimeService();</span><br><span class="line">        taskService = processEngine.getTaskService();</span><br><span class="line">        historyService = processEngine.getHistoryService();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 部署流程定义</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="comment">// 获取部署对象</span></span><br><span class="line">	    Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">	                 .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">	                 .addClasspathResource(<span class="string">"diagrams/MyProcess4.bpmn"</span>)  <span class="comment">// 加载资源文件</span></span><br><span class="line">	                 .deploy(); <span class="comment">// 部署</span></span><br><span class="line">	    System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">	    System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"exclusive"</span>);</span><br><span class="line">        String processInstanceId = processInstance.getId();</span><br><span class="line">        String activityId = processInstance.getActivityId();</span><br><span class="line">        String definitionId = processInstance.getProcessDefinitionId();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"流程实例ID："</span>+processInstanceId);</span><br><span class="line">        System.out.println(<span class="string">"正在活动的节点ID："</span>+activityId);</span><br><span class="line">        System.out.println(<span class="string">"流程定义ID："</span>+definitionId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        String assignee = <span class="string">"孙总"</span>;  </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 查询并且返回任务即可</span></span><br><span class="line">        List&lt;Task&gt; taskList = taskService.createTaskQuery()  <span class="comment">// 任务相关Service // 创建任务查询</span></span><br><span class="line">                                     .processDefinitionKey(<span class="string">"exclusive"</span>)</span><br><span class="line">                                     .taskAssignee(assignee)<span class="comment">// 指定某个人</span></span><br><span class="line">                                     .orderByTaskCreateTime()</span><br><span class="line">                                     .desc()</span><br><span class="line">                                     .list();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(Task task:taskList)&#123;</span><br><span class="line">            System.out.println(<span class="string">"任务ID:"</span>+task.getId()); </span><br><span class="line">            System.out.println(<span class="string">"任务名称:"</span>+task.getName());</span><br><span class="line">            System.out.println(<span class="string">"任务创建时间:"</span>+task.getCreateTime());</span><br><span class="line">            System.out.println(<span class="string">"任务委派人:"</span>+task.getAssignee());</span><br><span class="line">            System.out.println(<span class="string">"流程实例ID:"</span>+task.getProcessInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *   完成任务 ： 排他网关生效环节</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask2</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		  Map&lt;String, Object&gt; variables=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">	        <span class="comment">//传入流程变量</span></span><br><span class="line">	        variables.put(<span class="string">"days"</span>, <span class="string">"5"</span>);</span><br><span class="line">	        processEngine.getTaskService() <span class="comment">// 任务相关Service</span></span><br><span class="line">	            .complete(<span class="string">"182504"</span>, variables); <span class="comment">//完成任务的时候，设置流程变量</span></span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询当前流程实例状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryProInstanceStateByProInstanceId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(<span class="string">"182501"</span>).singleResult();</span><br><span class="line">        <span class="keyword">if</span>(processInstance == <span class="keyword">null</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"当前流程已经完成"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"当前流程实例ID："</span>+processInstance.getId());</span><br><span class="line">            System.out.println(<span class="string">"当前流程所处的位置："</span>+processInstance.getActivityId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 完成任务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		processEngine.getTaskService().complete(<span class="string">"195004"</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
      <tags>
        <tag>排他网关</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM（一）体系结构概述</title>
    <url>/2020/03/21/JVM%EF%BC%88%E4%B8%80%EF%BC%89%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h2 id="JVM-与系统、硬件"><a href="#JVM-与系统、硬件" class="headerlink" title="JVM 与系统、硬件"></a><strong>JVM 与系统、硬件</strong></h2><img src="http://photo.wushaopei.com/qiniu151.png" width="80%">

<p><strong>JVM</strong>是运行在操作系统之上的，它与硬件没有直接的交互 </p>
<h2 id="JVM-体系结构概览"><a href="#JVM-体系结构概览" class="headerlink" title="JVM 体系结构概览"></a><strong>JVM 体系结构概览</strong></h2><img src="http://photo.wushaopei.com/qiniu152.png" width="80%">



<h2 id="类装载器ClassLoader-执行原理"><a href="#类装载器ClassLoader-执行原理" class="headerlink" title="类装载器ClassLoader 执行原理"></a>类装载器ClassLoader 执行原理</h2><p>​    负责加载<strong>class</strong>文件，class文件在文件开头有特定的文件标示，并且<strong>ClassLoader</strong>只负责<strong>class</strong>文件的加载，至于它是否可以运行，则由<strong>Execution Engine</strong>决定 </p>
<img src="http://photo.wushaopei.com/qiniu153.png" width="80%">



<h2 id="类装载器ClassLoader装载流程（双亲委派）"><a href="#类装载器ClassLoader装载流程（双亲委派）" class="headerlink" title="类装载器ClassLoader装载流程（双亲委派）"></a><strong>类装载器ClassLoader装载流程（双亲委派）</strong></h2><img src="http://photo.wushaopei.com/qiniu154.png" width="80%">

<table>
<thead>
<tr>
<th>虚拟机自带的加载器</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>启动类加载器（Bootstrap）</strong></td>
<td>C++</td>
</tr>
<tr>
<td><strong>扩展类加载器（Extension）</strong></td>
<td>Java</td>
</tr>
<tr>
<td><strong>应用程序类加载器（AppClassLoader）</strong>                                                                     <code>应用程序类加载器 也叫系统类加载器，加载当前应用的classpath的所有类</code></td>
<td>Java</td>
</tr>
<tr>
<td><strong>用户自定义加载器</strong>                                                                                    <code>Java.lang.ClassLoader的子类，用户可以定制类的加载方式</code></td>
<td></td>
</tr>
</tbody></table>
<p>注：<strong>Execution Engine</strong>执行引擎负责解释命令，提交操作系统执行。</p>
<img src="http://photo.wushaopei.com/qiniu155.png" width="80%">



<h2 id="Native-Interface本地接口"><a href="#Native-Interface本地接口" class="headerlink" title="Native Interface本地接口"></a><strong>Native Interface本地接口</strong></h2><p>​    本地接口的作用是融合不同的编程语言为 Java 所用，它的初衷是融合 C/C++程序，Java 诞生的时候是 C/C++横行的时候，要想立足，必须有调用 C/C++程序，于是就在内存中专门开辟了一块区域处理标记为native的代码，它的<strong>具体做法是 Native Method Stack中登记 native方法，在Execution Engine 执行时加载native libraies。</strong></p>
<p>​    目前<strong>该方法</strong>使用的越来越少了，除非是与硬件有关的<strong>应用</strong>，比如<strong>通过Java程序驱动打印机或者Java系统管理生产设备</strong>，在企业级应用中已经比较少见。因为现在的异构领域间的通信很发达，比如可以使用 Socket通信，也可以使用Web Service等等，不多做介绍。</p>
<h2 id="Native-Method-Stack（本地方法栈）"><a href="#Native-Method-Stack（本地方法栈）" class="headerlink" title="Native Method Stack（本地方法栈）"></a><strong>Native Method Stack（本地方法栈）</strong></h2><p>​    它的具体做法是Native Method Stack中登记native方法，在Execution Engine 执行时加载本地方法库。 </p>
<h2 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a><strong>PC寄存器</strong></h2><p>​    每个线程都有一个程序计数器，是线程私有的,就是一个指针，指向方法区中的方法字节码<font color=red>（用来存储指向下一条指令的地址,也即将要执行的指令代码）</font> ，由执行引擎读取下一条指令，是一个非常小的内存空间，几乎可以忽略不记。</p>
<p>​    这块内存区域很小，<font color=red>它是当前线程所执行的字节码的行号指示器</font>，字节码解释器通过改变这个计数器的值来选取下一条需要执行的字节码指令。</p>
<p>​    如果执行的是一个Native方法，那这个计数器是空的。</p>
<p>​    用以完成分支、循环、跳转、异常处理、线程恢复等基础功能。不会发生内存溢出(OutOfMemory=OOM)错误</p>
<h2 id="Method-Area-方法区"><a href="#Method-Area-方法区" class="headerlink" title="Method Area 方法区"></a><strong>Method Area 方法区</strong></h2><p>​    方法区是被所有线程共享，所有字段和方法字节码，以及一些特殊方法如构造函数，接口代码也在此定义。简单说，所有定义的方法的信息都保存在该区域，<font color=red>此区属于共享区间</font>。<br><font color=blue>静态变量+常量+类信息(构造方法/接口定义)+运行时常量池存在方法区中</font></p>
<p><font color=blue>But 实例变量存在堆内存中,和方法区无关</font></p>
<h2 id="Stack-栈"><a href="#Stack-栈" class="headerlink" title="Stack 栈"></a><strong>Stack 栈</strong></h2><p>​    <strong>栈</strong>也叫<strong>栈内存</strong>，主管Java程序的运行，是在线程创建时创建，它的生命期是跟随线程的生命期，线程结束栈内存也就释放，<font color=blue>对于栈来说不存在垃圾回收问题</font>，只要线程一结束该栈就Over，生命周期和线程一致，是线程私有的。8种<font color=red>基本类型的变量+对象的引用变量+实例方法都是在函数的栈内存中分配</font>。 </p>
<h3 id="栈存储什么？"><a href="#栈存储什么？" class="headerlink" title="栈存储什么？"></a>栈存储什么？</h3><p><strong>栈帧中主要保存3 类数据：</strong></p>
<ul>
<li>本地变量（Local Variables）:输入参数和输出参数以及方法内的变量；</li>
<li>栈操作（Operand Stack）:记录出栈、入栈的操作；</li>
<li>栈帧数据（Frame Data）:包括类文件、方法等等。</li>
</ul>
<h3 id="栈运行原理"><a href="#栈运行原理" class="headerlink" title="栈运行原理"></a>栈运行原理</h3><p>栈中的数据都是以<strong>栈帧</strong>（Stack Frame）的格式存在，栈帧是一个内存区块，是一个数据集，是一个有关方法(Method)和运行期数据的数据集，当一个方法A被调用时就产生了一个栈帧 F1，并被压入到栈中，<br>A方法又调用了 B方法，于是产生栈帧 F2 也被压入栈，<br>B方法又调用了 C方法，于是产生栈帧 F3 也被压入栈，<br>……<br>执行完毕后，先弹出F3栈帧，再弹出F2栈帧，再弹出F1栈帧……</p>
<p>遵循“先进后出”/“后进先出”原则。</p>
<p><font color=red>每个方法执行的同时都会创建一个栈帧，用于存储局部变量表、操作数栈、动态链接、方法出口等信息</font>，每一个方法从调用直至执行完毕的过程，就对应着一个栈帧在虚拟机中入栈到出栈的过程。<font color=red>栈的大小和具体JVM的实现有关，通常在256K~756K之间</font>。</p>
<img src="http://photo.wushaopei.com/qiniu156.png" width="80%">

<p>图示在一个栈中有两个栈帧：</p>
<ul>
<li>栈帧 2是最先被调用的方法，先入栈，</li>
<li>然后方法 2 又调用了方法1，栈帧 1处于栈顶的位置，</li>
<li>栈帧 2 处于栈底，执行完毕后，依次弹出栈帧 1和栈帧 2，</li>
<li>线程结束，栈释放。</li>
</ul>
<p>每执行一个方法都会产生一个栈帧，保存到栈(后进先出)的<font color=red>顶部，顶部栈就是当前的方法，该方法执行完毕 后会自动将此栈帧出栈</font>。</p>
<img src="http://photo.wushaopei.com/qiniu157.png" width="80%">



<h3 id="栈-堆-方法区的交互关系"><a href="#栈-堆-方法区的交互关系" class="headerlink" title="栈+堆+方法区的交互关系"></a><strong>栈+堆+方法区的交互关系</strong></h3><img src="http://photo.wushaopei.com/qiniu158.png" width="80%">

<p><strong>HotSpot</strong>是使用<font color=red><strong>指针的方式</strong>来访问对象</font>：<br>         Java堆中会存放访问类元数据的地址，reference存储的就直接是对象的地址</p>
<h3 id="三种JVM："><a href="#三种JVM：" class="headerlink" title="三种JVM："></a>三种JVM：</h3><ul>
<li>Sun公司的HotSpot</li>
<li>BEA公司的JRockit</li>
<li>IBM公司的J9 VM</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>GC</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>内存回收机制</tag>
      </tags>
  </entry>
  <entry>
    <title>EasyUI笔记（三）案例:后台管理页面-框架与需求确立</title>
    <url>/2020/03/14/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89%E6%A1%88%E4%BE%8B-%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2-%E6%A1%86%E6%9E%B6%E4%B8%8E%E9%9C%80%E6%B1%82%E7%A1%AE%E7%AB%8B/</url>
    <content><![CDATA[<h3 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h3><p><code>模拟实现一个电商项目中子模块后台管理模块的增删改查。</code></p>
<p>粗粒度：</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>细功能</th>
</tr>
</thead>
<tbody><tr>
<td>后台管理模块</td>
<td>对商品菜单的增删改查</td>
</tr>
</tbody></table>
<p>细粒度</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>细功能</th>
</tr>
</thead>
<tbody><tr>
<td>查</td>
<td>列表分三级，一级查一级</td>
</tr>
<tr>
<td>增</td>
<td>商品有spu、sku属性，都需要进行相应的添加，做两级添加操作</td>
</tr>
<tr>
<td>改</td>
<td>初步实现对商品的信息进行修改，其次实现对三级分类属性的修改</td>
</tr>
<tr>
<td>删</td>
<td>具体商品信息可以删除，三级分类菜单的次一级菜单为空也可以</td>
</tr>
</tbody></table>
<h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a><strong>技术选型</strong></h3><p>前端：</p>
<p>​    使用Freemarkr，分模块，每个模块add、update、delete、分页都是单独页面。</p>
<p>​    后端：</p>
<p>​        基础框架：SpringBoot、Mybatis 、SpringMVC、Log4j、Lombok、Swagger</p>
<p>​        数据库：MySQL</p>
<p>前后端交互：</p>
<p>​    Json</p>
<img src="http://photo.wushaopei.com/qiniu129.png" width="60%">

<h3 id="实现逻辑："><a href="#实现逻辑：" class="headerlink" title="实现逻辑："></a>实现逻辑：</h3><p>围绕EasyUI的 <strong>控件、属性</strong>以及动态获取数据的<strong>事件、方法</strong>来进行。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>EasyUI笔记（二）--EasyUI下载及引入项目、示例</title>
    <url>/2020/03/14/EasyUI%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89-EasyUI%E4%B8%8B%E8%BD%BD%E5%8F%8A%E5%BC%95%E5%85%A5%E9%A1%B9%E7%9B%AE%E3%80%81%E7%A4%BA%E4%BE%8B/</url>
    <content><![CDATA[<h3 id="EasyUI下载"><a href="#EasyUI下载" class="headerlink" title="EasyUI下载"></a>EasyUI下载</h3><hr>
<p>　EasyUI官方下载地址：<a href="http://www.jeasyui.com/download/index.php，目前最新的版本是：jQuery" target="_blank" rel="noopener">http://www.jeasyui.com/download/index.php，目前最新的版本是：jQuery</a> EasyUI 1.6.1 </p>
<img src="http://photo.wushaopei.com/qiniu125.png" width="60%">

<p>下载完成之后，将压缩包进行解压后，得到一个【jquery-easyui-1.6.1】文件夹，里面有如下图所示的文件： </p>
<img src="http://photo.wushaopei.com/qiniu126.png" width="60%">



<h3 id="EasyUI引入项目及范例："><a href="#EasyUI引入项目及范例：" class="headerlink" title="EasyUI引入项目及范例："></a>EasyUI引入项目及范例：</h3><hr>
<h4 id="引入相关js和css样式文件："><a href="#引入相关js和css样式文件：" class="headerlink" title="引入相关js和css样式文件："></a>引入相关js和css样式文件：</h4><p>要想在页面中使用EasyUI，那么首先要做的就是在页面中引入必要js和css样式文件，以在jsp文件中使用EasyUI为例，文件引入的顺序如下所示 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入JQuery --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/jquery.easyui.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI的中文国际化js，让EasyUI支持中文 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/locale/easyui-lang-zh_CN.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI的样式文件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/themes/default/easyui.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入EasyUI的图标样式文件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"$&#123;pageContext.request.contextPath&#125;/jquery-easyui-1.4.1/themes/icon.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>　在jsp文件中引用了这些文件之后，就可以使用EasyUI了。 </p>
<h4 id="EasyUI使用范例"><a href="#EasyUI使用范例" class="headerlink" title="EasyUI使用范例"></a>EasyUI使用范例</h4><p>将jquery-easyui-1.9.1加入到SpringBoot工程中，将jquery-easyui-1.9.1文件夹中一些不必要的文件删掉，只保留必要的就可以了，如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu127.png" width="60%">

<p>　新创建一个01.html页面，在01.jsp页面中使用EasyUI，代码如下： </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"jquery-1.11.3.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入JQuery --&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/easyui/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI --&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/easyui/jquery.easyui.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI的中文国际化js，让EasyUI支持中文 --&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/easyui/locale/easyui-lang-zh_CN.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI的样式文件--&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/easyui/themes/default/easyui.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br><span class="line">	  <span class="comment">&lt;!-- 引入EasyUI的图标样式文件--&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/easyui/themes/icon.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">      $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">//console.info($('#dd2'));</span></span></span><br><span class="line">          /*使用JavaScript动态创建EasyUI的Dialog的步骤：</span><br><span class="line">          1、定义一个div，并给div指定一个id</span><br><span class="line">          2、使用Jquery选择器选中该div，然后调用dialog()方法就可以创建EasyUI的Dialog</span><br><span class="line">          */</span><br><span class="line"><span class="javascript">          $(<span class="string">'#dd2'</span>).dialog();<span class="comment">//使用默认的参数创建EasyUI的Dialog</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">//使用自定义参数创建EasyUI的Dialog</span></span></span><br><span class="line"><span class="javascript">          $(<span class="string">'#dd3'</span>).dialog(&#123;</span></span><br><span class="line"><span class="actionscript">              title: <span class="string">'使用JavaScript创建的Dialog'</span>,</span></span><br><span class="line">              width: 400,</span><br><span class="line">              height: 200,</span><br><span class="line"><span class="actionscript">              closed: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">              cache: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">              modal: <span class="literal">true</span></span></span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"easyui-dialog"</span> <span class="attr">id</span>=<span class="string">"dd1"</span> <span class="attr">title</span>=<span class="string">"EasyUI Dialog"</span> <span class="attr">style</span>=<span class="string">"width: 500px;height: 300px;"</span>&gt;</span></span><br><span class="line">        Hello World!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"dd2"</span>&gt;</span>Dialog Content<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"dd3"</span>&gt;</span>Dialog Content<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>accordion.html 运行结果如下：</p>
<img src="http://photo.wushaopei.com/qiniu129.png" width="60%">

<p>这里的两种EasyUI 的Dialog展现UI正是 <a href="">EasyUI笔记（一）EasyUI入门</a>中提到的声明UI组件的两种方法的实现。</p>
<p>以上便是关于EasyUI的简单入门，接下来将使用EasyUI做一个稍微复杂点的后台管理页面。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>EasyUI前端框架</category>
      </categories>
  </entry>
  <entry>
    <title>JVM(三)堆参数微调优入门</title>
    <url>/2020/03/22/JVM%EF%BC%88%E4%B8%89%EF%BC%89%E5%A0%86%E5%8F%82%E6%95%B0%E5%BE%AE%E8%B0%83%E4%BC%98%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h3 id="调优的本质："><a href="#调优的本质：" class="headerlink" title="调优的本质："></a><strong>调优的本质：</strong></h3><p>​     其本质：是对<strong>JVM</strong>垃圾的收集(<strong>Java Garbage Collection</strong> ) 。</p>
<p>这里均以<strong>JDK1.8+HotSpot</strong>为例 </p>
<h3 id="Java-7"><a href="#Java-7" class="headerlink" title="Java 7"></a><strong>Java 7</strong></h3><img src="http://photo.wushaopei.com/qiniu164.png" width="80%">

<h3 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a><strong>Java 8</strong></h3><img src="http://photo.wushaopei.com/qiniu165.png" width="80%">

<h3 id="堆内存调优简介01"><a href="#堆内存调优简介01" class="headerlink" title="堆内存调优简介01"></a><strong>堆内存调优简介01</strong></h3><table>
<thead>
<tr>
<th>-Xms</th>
<th>设置初始分配大小，默认为物理内存的“1/64”</th>
</tr>
</thead>
<tbody><tr>
<td>-Xmx</td>
<td>最大分配内存，默认为物理内存的“1/4”</td>
</tr>
<tr>
<td>-XX:+PrintGCDetails</td>
<td>输出详细的GC处理日志</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">   	<span class="keyword">long</span> maxMemory = Runtime.getRuntime().maxMemory();<span class="comment">//返回Java虚拟机试图使用的最大内存量</span></span><br><span class="line">   	<span class="keyword">long</span> totalMemory = Runtime.getRuntime().totalMemory();<span class="comment">//返回Java虚拟机中的内存总量</span></span><br><span class="line">   	System.out.println(<span class="string">"MAX_MEMORY = "</span>+ maxMemory + <span class="string">"（字节）、"</span> + (maxMemory / (<span class="keyword">double</span>)<span class="number">1024</span> / <span class="number">1024</span>)+<span class="string">"MB"</span>);</span><br><span class="line">   	System.out.println(<span class="string">"TOTAL_MEMORY = "</span>+ totalMemory + <span class="string">"（字节）、"</span> + (totalMemory / (<span class="keyword">double</span>)<span class="number">1024</span> / <span class="number">1024</span>)+<span class="string">"MB"</span>);</span><br><span class="line">   	</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="堆内存调优简介02"><a href="#堆内存调优简介02" class="headerlink" title="堆内存调优简介02"></a><strong>堆内存调优简介02</strong></h3><p>发现默认的情况下分配的内存是总内存的“1/4” 、 而初始化的内存为“1/ 64” </p>
<blockquote>
<p>MAX_MEMORY = 2731016192（字节）、2604.5MB<br>TOTAL_MEMORY = 185073664（字节）、176.5MB</p>
</blockquote>
<p>VM 参数：<code>-Xms1024m -Xmx1024m -XX:+PrintGCDetails</code></p>
<img src="http://photo.wushaopei.com/qiniu166.png" width="80%">

<h3 id="堆内存调优简介03"><a href="#堆内存调优简介03" class="headerlink" title="堆内存调优简介03"></a><strong>堆内存调优简介03</strong></h3><p>此图为java7，演示为8 </p>
<img src="http://photo.wushaopei.com/qiniu167.png" width="80%">

<h3 id="堆内存调优简介04"><a href="#堆内存调优简介04" class="headerlink" title="堆内存调优简介04"></a><strong>堆内存调优简介04</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String str = <span class="string">"www.wushaopei.com"</span>;</span><br><span class="line">  	<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">  		str += str + <span class="keyword">new</span> Random().nextInt(<span class="number">88888888</span>) + <span class="keyword">new</span> Random().nextInt(<span class="number">99999999</span>);</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>VM参数： -Xms8m -Xmx8m -XX:+PrintGCDetails</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu168.png" width="80%">



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>Heap堆</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>Heap堆</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(二)堆体系结构概述</title>
    <url>/2020/03/22/JVM%EF%BC%88%E4%BA%8C%EF%BC%89%E5%A0%86%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<hr>
<img src="http://photo.wushaopei.com/qiniu152.png" width="80%">

<hr>
<h3 id="Heap堆-Java7之前"><a href="#Heap堆-Java7之前" class="headerlink" title="Heap堆(Java7之前)"></a>Heap堆(Java7之前)</h3><p>​    一个JVM实例只存在一个堆内存，堆内存的大小是可以调节的。类加载器读取了类文件后，需要把类、方法、常变量放到堆内存中，保存所有引用类型的真实信息，以方便执行器执行。              </p>
<p>​    <strong>堆内存逻辑上分为三部分：新生+养老+永久</strong> </p>
<img src="http://photo.wushaopei.com/qiniu159.png" width="80%">

<h4 id="新生区"><a href="#新生区" class="headerlink" title="新生区"></a>新生区</h4><p>​    新生区是类的诞生、成长、消亡的区域，一个类在这里产生，应用，最后被垃圾回收器收集，结束生命。新生区又分为两部分： 伊甸区（Eden space）和幸存者区（Survivor pace） ，所有的类都是在伊甸区被new出来的。幸存区有两个： 0区（Survivor 0 space）和1区（Survivor 1 space）。当伊甸园的空间用完时，程序又需要创建对象，JVM的垃圾回收器将对伊甸园区进行垃圾回收(Minor GC)，将伊甸园区中的不再被其他对象所引用的对象进行销毁。然后将伊甸园中的剩余对象移动到幸存 0区。若幸存 0区也满了，再对该区进行垃圾回收，然后移动到 1 区。那如果1 区也满了呢？再移动到养老区。若养老区也满了，那么这个时候将产生MajorGC（FullGC），进行养老区的内存清理。若养老区执行了Full GC之后发现依然无法进行对象的保存，就会产生OOM异常“OutOfMemoryError”。</p>
<p><font color=red>如果出现java.lang.OutOfMemoryError: Java heap space异常，说明Java虚拟机的堆内存不够。原因有二：</font></p>
<p>（1）<font color=red>Java虚拟机的堆内存设置不够，可以通过参数-Xms、-Xmx来调整。</font></p>
<p>（2）<font color=red>代码中创建了大量大对象，并且长时间不能被垃圾收集器收集（存在被引用）。</font><br><img src="http://photo.wushaopei.com/qiniu160.png" width="80%"></p>
<img src="http://photo.wushaopei.com/qiniu161.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu162.png" width="80%">

<h4 id="永久区"><a href="#永久区" class="headerlink" title="永久区"></a>永久区</h4><pre><code>永久存储区是一个常驻内存区域，用于存放JDK自身所携带的 Class,Interface 的元数据，也就是说它存储的是运行环境必须的类信息，被装载进此区域的数据是不会被垃圾回收器回收掉的，关闭 JVM 才会释放此区域所占用的内存。</code></pre><p>​    如果出现   <code>java.lang.OutOfMemoryError: PermGen space</code>，说明是Java虚拟机对永久代Perm内存设置不够。一般出现这种情况，都是程序启动需要加载大量的第三方jar包。例如：在一个Tomcat下部署了太多的应用。或者大量动态反射生成的类不断被加载，最终导致Perm区被占满。</p>
<table>
<thead>
<tr>
<th>Jdk1.6及之前：</th>
<th>有永久代, 常量池1.6在方法区</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Jdk1.7：</strong></td>
<td><strong>有永久代，但已经逐步“去永久代”，常量池1.7在堆</strong></td>
</tr>
<tr>
<td><strong>Jdk1.8及之后：</strong></td>
<td><strong>无永久代，常量池1.8在元空间</strong></td>
</tr>
</tbody></table>
<h4 id="了解三区结构后方可了解-JVM垃圾收集"><a href="#了解三区结构后方可了解-JVM垃圾收集" class="headerlink" title="了解三区结构后方可了解-JVM垃圾收集"></a>了解三区结构后方可了解-JVM垃圾收集</h4><p>​    实际而言，方法区（Method Area）和堆一样，是各个线程共享的内存区域，它用于存储虚拟机加载的：类信息+普通常量+静态常量+编译器编译后的代码等等，虽然JVM规范将方法区描述为堆的一个逻辑部分，但它却还有一个别名叫做Non-Heap(非堆)，目的就是要和堆分开。</p>
<p>​    对于HotSpot虚拟机，很多开发者习惯将方法区称之为“永久代(Parmanent Gen)” ，但严格本质上说两者不同，或者说使用永久代来实现方法区而已，永久代是方法区(相当于是一个接口interface)的一个实现，<font color=blue>jdk1.7的版本中，已经将原本放在永久代的字符串常量池移走</font>。</p>
<img src="http://photo.wushaopei.com/qiniu163.png" width="80%">


<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>GC</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>内存回收机制</tag>
      </tags>
  </entry>
  <entry>
    <title>Java8:Lambda指南（一）接口的默认方法</title>
    <url>/2020/03/12/Java8-Lambda%E6%8C%87%E5%8D%97%EF%BC%88%E4%B8%80%EF%BC%89%E6%8E%A5%E5%8F%A3%E7%9A%84%E9%BB%98%E8%AE%A4%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>Java 8允许我们利用<strong>default关键字向接口添加非抽象方法实现</strong>。这个特性也称为<strong>虚拟扩展方法</strong>（ <a href="http://stackoverflow.com/a/24102730" target="_blank" rel="noopener">virtual extension methods</a>）。 </p>
<p>这是我们的第一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Formula</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">double</span> <span class="title">sqrt</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Math.sqrt(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了抽象方法计算外，接口公式还定义了默认方法sqrt。 具体类只需实现抽象方法计算。 默认方法sqrt可以开箱即用。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Formula formula = <span class="keyword">new</span> Formula() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sqrt(a * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">formula.calculate(<span class="number">100</span>);     <span class="comment">// 100.0</span></span><br><span class="line">formula.sqrt(<span class="number">16</span>);           <span class="comment">// 4.0</span></span><br></pre></td></tr></table></figure>

<p>该公式被实现为一个匿名object。它的代码是相当冗长的：这样简单的一个 sqrt(a * 100)计算需要 6行代码。我们将会在下一节看到，在Java 8中有一种更好的实现单个方法对象的方法。 </p>
<p>原文链接： <a href="https://github.com/winterbe/java8-tutorial" target="_blank" rel="noopener">Modern Java - A Guide to Java 8 </a> </p>
<p>翻译： <a href="http://wushaopei.com/" target="_blank" rel="noopener">http://wushaopei.com/</a> - <a href="http://wushaopei.com/" target="_blank" rel="noopener">吴少培</a></p>
<p>译文链接： <a href="http://www.wushaopei/8554.html" target="_blank" rel="noopener">http://www.wushaopei/8554.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>java 8 新特性</category>
      </categories>
  </entry>
  <entry>
    <title>Java8-Lambda指南（二）Lambda 表达式</title>
    <url>/2020/03/12/Java8-Lambda%E6%8C%87%E5%8D%97%EF%BC%88%E4%BA%8C%EF%BC%89Lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="Lambda-expressions"><a href="#Lambda-expressions" class="headerlink" title="Lambda expressions"></a>Lambda expressions</h2><p>让我们从一个简单的例子开始，先了解下在以前的Java版本中，是 如何对字符串列表进行排序的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; names = Arrays.asList(<span class="string">"peter"</span>, <span class="string">"anna"</span>, <span class="string">"mike"</span>, <span class="string">"xenia"</span>);</span><br><span class="line"></span><br><span class="line">Collections.sort(names, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String a, String b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b.compareTo(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通用的静态方法 <strong>Collections.sort</strong> 可以接收一个列表和一个比较器，以便对给定列表中的元素进行排序。您经常发现自己创建了匿名比较器，并将它们传递给sort方法。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collections.sort(names, (String a, String b) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> b.compareTo(a);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如你所见，代码更短，更容易阅读。但它变得更短: </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collections.sort(names, (String a, String b) -&gt; b.compareTo(a));</span><br></pre></td></tr></table></figure>

<p>在只针对一个方法主体时，可以跳过大括号{}和return关键字 。此时可以看到它变得更短了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">names.sort((a, b) -&gt; b.compareTo(a));</span><br></pre></td></tr></table></figure>

<p>List现在有一个排序方法。 java编译器也知道参数类型，所以您也可以跳过它们。让我们更深入地研究lambda表达式如何在外部使用。 </p>
<p><strong>问题： 作为匿名方法的 new Comparator 怎么被省去的？</strong></p>
<p>​             <strong>(String a, String b) -&gt; b.compareTo(a) 中的 “- &gt; ”代表什么？</strong></p>
<p>原文链接： <a href="https://github.com/winterbe/java8-tutorial" target="_blank" rel="noopener">Modern Java - A Guide to Java 8 </a> </p>
<p>翻译： <a href="http://wushaopei.com/" target="_blank" rel="noopener">http://wushaopei.com/</a> - <a href="http://wushaopei.com/" target="_blank" rel="noopener">吴少培</a></p>
<p>译文链接： <a href="http://www.wushaopei/8554.html" target="_blank" rel="noopener">http://www.wushaopei/8554.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>java 8 新特性</category>
      </categories>
  </entry>
  <entry>
    <title>Java对象的值传递问题：传值还是传引用？</title>
    <url>/2020/03/10/Java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%80%BC%E4%BC%A0%E9%80%92%E9%97%AE%E9%A2%98%EF%BC%9A%E4%BC%A0%E5%80%BC%E8%BF%98%E6%98%AF%E4%BC%A0%E5%BC%95%E7%94%A8%EF%BC%9F/</url>
    <content><![CDATA[<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>​    在使用<strong>Java</strong>语言进行开发过程中，涉及到<strong>局部变量</strong>与<strong>方法内部作用域</strong>的<strong>数据交换与解析</strong>的过程，而这一过程，一般都是通过<strong>方法形参</strong>的方式进行<strong>java</strong>对象的传递。</p>
<blockquote>
<p> 这里引出一个问题，<strong>当对象作为参数传递时，究竟传的是对象的值，还是对象的引用呢？–_–</strong></p>
</blockquote>
<p>这是一个保守争议的话题。</p>
<p>​    假设，传的是值，那么函数接收的只是一个<strong>副本</strong>，由于<strong>作用域</strong>的存在，函数对象形参的操作，并不会对实参产生影响；若传的是<strong>引用</strong>，那么此时<strong>对形参</strong>的操作则会影响到实参。</p>
<p>​    在这里引用一句代码来举例分析：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object obj = <span class="keyword">new</span> Object();</span><br></pre></td></tr></table></figure>

<p>这句代码的意思是：创建一个Object对象，并在堆内存开辟一个空间（new），同时创建一个名为obj 的引用，让这个引用指向这个对象，如下图所示：</p>
<img src="http://photo.wushaopei.com/qiniu83.png" width="60%">

<p>在上面我们创建了一个对象以及其引用，下面我们通过例子来从代码层面进行分析。</p>
<h3 id="基本数据类型作为参数传递："><a href="#基本数据类型作为参数传递：" class="headerlink" title="基本数据类型作为参数传递："></a>基本数据类型作为参数传递：</h3><p>例1:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> test.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年3月10日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        System.out.println(<span class="string">"before change, i = "</span>+i);</span><br><span class="line">        change(i);</span><br><span class="line">        System.out.println(<span class="string">"after change, i = "</span>+i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        i = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子中使用基本数据类型的 <strong>int</strong> 作为形参传递，执行结果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before change, i = <span class="number">1</span></span><br><span class="line">after change, i = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>从 int 类型作为形参的例子的执行结果可知，<strong>当基本数据类型（Boolean，byte，char，String，int，Long，float，double）作为参数传递时，传递的是实参值的副本，即传的是值，无论在函数中怎么操作这个副本，实参的值是不会被改变的</strong>。 </p>
<hr>
<h3 id="对象作为参数传递："><a href="#对象作为参数传递：" class="headerlink" title="对象作为参数传递："></a>对象作为参数传递：</h3><p>例2： 我们使用 StringBuffer对象作为参数传递到<strong>change</strong>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">"Hello "</span>);</span><br><span class="line">        System.out.println(<span class="string">"before change, sb is "</span>+sb.toString());</span><br><span class="line">        change(sb);</span><br><span class="line">        System.out.println(<span class="string">"after change, sb is "</span>+sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(StringBuffer stringBuffer)</span></span>&#123;</span><br><span class="line">        stringBuffer.append(<span class="string">"world !"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>程序的<strong>运行结果</strong>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before change, sb is Hello </span><br><span class="line">after change, sb is Hello world !</span><br></pre></td></tr></table></figure>

<p>从输出结果中我们可以发现，sb所指向的对象的值被改变了，那么是否我们可以推论出，在Java中，当对象作为参数传递时，传递的是该对象的引用呢？我们再来看下面这个例子：  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">"Hello "</span>);</span><br><span class="line">        System.out.println(<span class="string">"before change, sb is "</span>+sb.toString());</span><br><span class="line">        change(sb);</span><br><span class="line">        System.out.println(<span class="string">"after change, sb is "</span>+sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(StringBuffer stringBuffer)</span></span>&#123;</span><br><span class="line">        stringBuffer = <span class="keyword">new</span> StringBuffer(<span class="string">"Hi "</span>);</span><br><span class="line">        stringBuffer.append(<span class="string">"world !"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果上面的推论是正确的，即Java中对象作为参数传递，实际传递的是该对象的引用，那么在调用change函数之后，原对象的值应该是会改变的，变为“Hi world ！”，但是，当我们运行程序后，结果却是如下所示：  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before change, sb is Hello </span><br><span class="line">after change, sb is Hello</span><br></pre></td></tr></table></figure>

<p>​    原对象的值并没有被改变，这与上面的推论相矛盾！为什么在Java中，当对象作为参数传递时，有的时候实参被改变了，而有的时候实参并未被改变呢？下面让我们来分析一下其中的原因：  　　从文章的开头我们知道，当执行<strong>StringBuffer sb = new StringBuffer(“Hello “)</strong>时，我们创建了一个指向新建对象“<strong>new StringBuffer(“Hello “)”</strong>的引用“<strong>sb</strong>”，如下图所示：  </p>
<img src="http://photo.wushaopei.com/qiniu84.png" width="60%">

<p>在例2中，当我们调用change函数后，实际上，形参stringBuffer也指向了实参sb所指向的对象，即： </p>
<img src="http://photo.wushaopei.com/qiniu85.png" width="60%">

<p>那么当我们执行<strong>stringBuffer.append(“world !”)</strong>后，便通过对象的引用“stringBuffer”修改了对象的值，使之变成了<strong>“Hello world ！”</strong>，即：  </p>
<img src="http://photo.wushaopei.com/qiniu86.png" width="60%">

<p>但是，在例3中的change函数中，我们又新建了一个对象<strong>“new StringBuffer(“Hi  “)”</strong>（这实际上在内存中开辟了一块在原对象地址之外的新区域），这让形参stringBuffer实际指向了这个新建的对象，并将新对象的值设置为<strong>“Hi world ！”</strong>，例三中stringBuffer的值已经被改变为了Hi  world，但是因为值没有被<strong>return</strong>返回赋值给sb对象，所以sb对象并没有被改变，所以输出的任然是hello，即： </p>
<img src="http://photo.wushaopei.com/qiniu87.png" width="60%">

<p>那么我们就不难理解，为何在执行完change函数之后，实参的值仍为“Hello”了。 </p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>　　<strong>综上所述，我们可以得出结论：在Java中，当对象作为参数传递时，实际上传递的是一份“引用的拷贝”。 （实际传递的是对象的引用）</strong></p>
<p><strong>转载自：<a href="https://blog.csdn.net/xiangwanpeng/article/details/52454479" target="_blank" rel="noopener">https://blog.csdn.net/xiangwanpeng/article/details/52454479</a></strong></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JavaSE</category>
      </categories>
      <tags>
        <tag>值传递</tag>
        <tag>引用</tag>
        <tag>值</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（一）了解SQL</title>
    <url>/2020/05/07/MySQL%EF%BC%88%E4%B8%80%EF%BC%89%E4%BA%86%E8%A7%A3SQL/</url>
    <content><![CDATA[<h2 id="数据库基础"><a href="#数据库基础" class="headerlink" title="数据库基础"></a>数据库基础</h2><h3 id="数据库的应用"><a href="#数据库的应用" class="headerlink" title="数据库的应用"></a>数据库的应用</h3><blockquote>
<p>你可能还没有意识到，其实你自己一直在使用数据库。每当你从自己的电子邮件地址簿里查找名字时，你就在使用数据库。如果你在某个 因特网搜索站点上进行搜索，也是在使用数据库。如果你在工作中登录网络，也需要依靠数据库验证自己的名字和密码。即使是在自动取款机上使用ATM卡，也要利用数据库进行PIN码验证和余额检查。</p>
</blockquote>
<p><code>Mark :</code> 我们从上面可以知道，数据库在生活中已经应用的很广泛了。接下来，我们来了解一下什么是数据库？以及数据的简单概念、结构等？</p>
<h3 id="什么是数据库"><a href="#什么是数据库" class="headerlink" title="什么是数据库"></a>什么是数据库</h3><p><strong>注意：</strong><code>数据库和数据库软件是不同的定义。</code></p>
<p>关于数据库软件和数据库，经常被混为一谈。</p>
<blockquote>
<p><strong>数据库（database）</strong> 保存有组织的数据的容器（通常是一个文 件或一组文件）。</p>
</blockquote>
<blockquote>
<p><strong>数据库软件</strong> 应称为DBMS（数据库管理系统）.</p>
</blockquote>
<ul>
<li>数据库是通过<strong>DBMS</strong>创建和操纵的容器。数据库可以是保存在硬设备上的文件，但也可以不是。在很大程度上说，<strong>数据库</strong>究竟是文件还是别的什么东西并不重要，因为你并不直接访问<strong>数据库</strong>；你使用的是<strong>DBMS</strong>，它替你访问数据库。</li>
</ul>
<hr>
<h3 id="表"><a href="#表" class="headerlink" title="表"></a>表</h3><blockquote>
<p><strong>表</strong>是一种结构化的文件，可用来存储某种特定类型的数据。表可以保存顾客清单、产品目录，或者其他信息清单。</p>
</blockquote>
<h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a><strong>示例：</strong></h4><p>​    在你将资料放入自己的文件柜时，并不是随便将它们扔进某个抽屉就完事了，而是在文件柜中创建文件，然后将相关的资料放入特定的文件中。 </p>
<p>​    在数据库领域中，这种文件称为表。</p>
<h4 id="表名的唯一标识"><a href="#表名的唯一标识" class="headerlink" title="表名的唯一标识"></a>表名的唯一标识</h4><p>​    数据库中的每个表都有一个名字，用来标识自己。此名字是唯一的， 这表示数据库中没有其他表具有相同的名字。</p>
<h4 id="特例："><a href="#特例：" class="headerlink" title="特例："></a>特例：</h4><p>​    <code>表名的唯一性取决于多个因素，如数据库名和表名等的结合。这表示，虽然在相同数据库中不能两次使用相同的表名，但在不同的数据库中却可以使用相同的表名。</code></p>
<hr>
<h3 id="列和数据类型"><a href="#列和数据类型" class="headerlink" title="列和数据类型"></a>列和数据类型</h3><p>​    表由<strong>列</strong>组成。<strong>列</strong>中存储着表中某部分的信息。 </p>
<blockquote>
<p><strong>反向理解：</strong>列（column） 表中的一个字段。所有表都是由一个或多个列组 成的。</p>
</blockquote>
<h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>​    <strong>数据类型（datatype）</strong> 所容许的数据的类型。每个表列都有相应的数据类型，它限制（或容许）该列中存储的数据。 </p>
<p><strong>说明：</strong></p>
<p>​    数据库中每个列都有相应的数据类型。数据类型定义列可以存储的数据种类。例如，如果列中存储的为数字（或许是订单中的物品数），则相应的数据类型应该为数值类型。如果列中存储的是日期、文本、注释、金额等，则应该用恰当的数据类型规定出来</p>
<hr>
<h3 id="行"><a href="#行" class="headerlink" title="行"></a>行</h3><p>​    <strong>行</strong>（row） 表中的一个记录。 ͗</p>
<blockquote>
<p>表中的数据是按行存储的，所保存的每个记录存储在自己的行内。如果将表想象为网格，网格中垂直的列为表列，水平行为表行。</p>
<p><strong>例如，</strong>顾客表可以每行存储一个顾客。表中的行数为记录的总数。</p>
</blockquote>
<hr>
<h3 id="主键"><a href="#主键" class="headerlink" title="主键"></a>主键</h3><p>​    <strong>主键（primary key）</strong> 唯一标识表中每行的这个列（或这组列）称为主键 。</p>
<blockquote>
<p>表中每一行都应该有可以唯一标识自己的一列（或一组列）。 </p>
<p><strong>例如：</strong> 一个顾客表可以使用顾客编号列，而订单表可以使用订单ID，雇员表可以使用雇员ID或雇员社会保险号</p>
</blockquote>
<p><strong>注意：</strong></p>
<ul>
<li>任意两行都不具有相同的主键值； </li>
<li>每个行都必须具有一个主键值（主键列不允许NULL值） </li>
</ul>
<blockquote>
<p>Mark ： 除了之间，还有一种非常重要的键，称为<strong>外键</strong> 。</p>
</blockquote>
<h2 id="什么是SQL"><a href="#什么是SQL" class="headerlink" title="什么是SQL"></a>什么是SQL</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote>
<p><strong>SQL</strong>（发音为字母S-Q-L或sequel）是结构化查询语言（Structured Query  Language）的缩写。SQL是一种专门用来与数据库通信的语言。 </p>
</blockquote>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>所有数据库都支持SQL </li>
<li>简单易学 </li>
<li>灵活，可进行复杂和高级的数据操作</li>
</ul>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p><strong>SQL是用来与数据库打交道的</strong></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>MySQL必知必会</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（七）数据过滤</title>
    <url>/2020/05/15/MySQL%EF%BC%88%E4%B8%83%EF%BC%89%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4/</url>
    <content><![CDATA[<h1 id="数据过滤"><a href="#数据过滤" class="headerlink" title="数据过滤"></a>数据过滤</h1><p>要点： SELECT 语句中 使用 where子句 ，AND、IN、NOT  等操作符 进行指定过滤条件</p>
<p><strong>工具表：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;NewTable&#96; (</span><br><span class="line">&#96;id&#96;  int(11) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">&#96;name&#96;  varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;sex&#96;  char(1) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT &#39;女&#39; ,</span><br><span class="line">&#96;borndate&#96;  datetime NULL DEFAULT &#39;1987-01-01 00:00:00&#39; ,</span><br><span class="line">&#96;phone&#96;  varchar(11) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;photo&#96;  blob NULL ,</span><br><span class="line">&#96;boyfriend_id&#96;  int(11) NULL DEFAULT NULL ,</span><br><span class="line">PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">)</span><br><span class="line">ENGINE&#x3D;InnoDB</span><br><span class="line">DEFAULT CHARACTER SET&#x3D;utf8 COLLATE&#x3D;utf8_general_ci</span><br><span class="line">AUTO_INCREMENT&#x3D;12</span><br><span class="line">ROW_FORMAT&#x3D;DYNAMIC</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<h2 id="组合-WHERE-子句"><a href="#组合-WHERE-子句" class="headerlink" title="组合 WHERE 子句"></a>组合 WHERE 子句</h2><p><strong>更强大过滤条件：</strong></p>
<blockquote>
<ol>
<li>多个 WHERE 子句</li>
<li>WHERE 子句结合AND子句\OR子句等</li>
</ol>
</blockquote>
<h3 id="AND-操作符"><a href="#AND-操作符" class="headerlink" title="AND 操作符"></a>AND 操作符</h3><blockquote>
<p>使用AND操作符给WHERE子句附加条件。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone from beauty where sex &#x3D; &#39;女&#39; and  borndate &#x3D; &#39;1993-02-03 00:00:00&#39;;</span><br><span class="line">+----+------+-----+-------------+</span><br><span class="line">| id | name | sex | phone       |</span><br><span class="line">+----+------+-----+-------------+</span><br><span class="line">|  4 | 热巴 | 女  | 18209876579 |</span><br><span class="line">|  9 | 双儿 | 女  | 18209876579 |</span><br><span class="line">| 11 | 夏雪 | 女  | 18209876579 |</span><br><span class="line">+----+------+-----+-------------+</span><br><span class="line">3 rows in set</span><br></pre></td></tr></table></figure>
</blockquote>
<p>此 SQL 语句检索满足条件为 sex 为女 , 且 borndate 为 ‘1993-02-03 00:00:00’ 的女性的 id , name ,sex,phone 等数据。</p>
<blockquote>
<p>AND  的使用： 可以根据需要在 SQL 中多次出现。</p>
</blockquote>
<h3 id="OR操作符"><a href="#OR操作符" class="headerlink" title="OR操作符"></a>OR操作符</h3><blockquote>
<p> OR操作符与AND操作符不同，它指示MySQL检索匹配任一条件的行。 </p>
<p>OR WHERE子句中使用的关键字，用来表示检索匹配任一给定条件的行。</p>
<p><strong>示例</strong>： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone from beauty where id &#x3D; 1 OR id &#x3D; 7</span><br><span class="line">;</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">| id | name   | sex | phone       |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">|  1 | 柳岩   | 女  | 18209876577 |</span><br><span class="line">|  7 | 岳灵珊 | 女  | 18219876577 |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>

<p>OR操作符告诉DBMS匹配任一条件而不是同时匹配两个条件。如果这里使用的是AND操作符，则没有数据返回（此时创建的WHERE子句不会检索到匹配的产品）。</p>
</blockquote>
<h3 id="计算次序"><a href="#计算次序" class="headerlink" title="计算次序"></a>计算次序</h3><blockquote>
<p>WHERE + AND + OR 的高级过滤</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where </span><br><span class="line">id &#x3D; 1 OR id &#x3D; 7 and borndate &#x3D; &#39;1993-02-03 00:00:00</span><br><span class="line">&#39;;</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">| id | name | sex | phone       | borndate            |</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">|  1 | 柳岩 | 女  | 18209876577 | 1988-02-03 00:00:00 |</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">1 row in set</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回 满足 id 分别为 1 和  7 的两条数据，并且还需要满足 borndate=  ‘1993-02-03 00:00:00’.</p>
<p><strong>问题：</strong></p>
<p>​    从执行结果可以看出，我们这里检索过滤到的数据是错误的， brondate 并不是 select 语句中要求的；经过分析，我们可以知道，这有可能是由于AND 和 OR 的计算次序问题导致的。</p>
<p><strong>正确的检索方式如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where (id &#x3D; 1 OR id &#x3D; 7) and borndate &#x3D; &#39;1993-02-03 00:00:00</span><br><span class="line">&#39;;</span><br><span class="line">Empty set</span><br></pre></td></tr></table></figure>

<p>这个 SELECT 语句与前一条的区别在于，将前面的 OR 条件使用圆括号括了起来。</p>
<p>因为圆括号具有较AND或OR操作符高的计算次序，DBMS首先过滤圆括号内的OR条件。这时，会将满足 OR 条件的结果集过滤出来，再根据 borndate 条件进行过滤，从而避免了第一次发生的错误，也可以理解为歧义。</p>
</blockquote>
<h3 id="IN操作符"><a href="#IN操作符" class="headerlink" title="IN操作符"></a>IN操作符</h3><blockquote>
<p>圆括号在WHERE子句中还有另外一种用法。IN操作符用来指定条件范 围，范围中的每个条件都可以进行匹配。IN取合法值的由逗号分隔的清单，全都括在圆括号中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where id in (1,3,5,6) order by name </span><br><span class="line">;</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">| id | name       | sex | phone       | borndate            |</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">|  3 | Angelababy | 女  | 18209876567 | 1989-02-03 00:00:00 |</span><br><span class="line">|  5 | 周冬雨     | 女  | 18209179577 | 1992-02-03 00:00:00 |</span><br><span class="line">|  6 | 周芷若     | 女  | 18209876577 | 1988-02-03 00:00:00 |</span><br><span class="line">|  1 | 柳岩       | 女  | 18209876577 | 1988-02-03 00:00:00 |</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">4 rows in set</span><br></pre></td></tr></table></figure>

<p>此 SQL 主要检索 id  为 1,3,5,6 的四个人的数据。</p>
<p>IN操作符后跟由逗号分隔的合法值清单，整个清单必须括在圆括号中。</p>
<p><strong>说明：</strong> 为IN操作符完成与OR相同的功能 ，从使用上，IN 要更便捷。</p>
<p>示例： OR </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where id&#x3D;1 or id &#x3D;3 or id &#x3D; 5 or id&#x3D;6</span><br><span class="line"> order by name ;</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">| id | name       | sex | phone       | borndate            |</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">|  3 | Angelababy | 女  | 18209876567 | 1989-02-03 00:00:00 |</span><br><span class="line">|  5 | 周冬雨     | 女  | 18209179577 | 1992-02-03 00:00:00 |</span><br><span class="line">|  6 | 周芷若     | 女  | 18209876577 | 1988-02-03 00:00:00 |</span><br><span class="line">|  1 | 柳岩       | 女  | 18209876577 | 1988-02-03 00:00:00 |</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">4 rows in set</span><br></pre></td></tr></table></figure>



<p><strong>IN 操作符的优点：</strong> </p>
<ul>
<li>在使用长的合法选项清单时，IN操作符的语法更清楚且更直观。 </li>
<li>在使用IN时，计算的次序更容易管理（因为使用的操作符更少）。  </li>
<li>IN操作符一般比OR操作符清单执行更快。 </li>
<li>IN的最大优点是可以包含其他SELECT语句，使得能够更动态地建立WHERE子句。</li>
</ul>
</blockquote>
<h3 id="NOT-操作符"><a href="#NOT-操作符" class="headerlink" title="NOT  操作符"></a>NOT  操作符</h3><blockquote>
<p>NOT 用于否定它之后跟着的任何条件。</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where id NOT IN </span><br><span class="line">(1,3,5,6) order by name ;</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| id | name   | sex | phone       | borndate            |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">|  9 | 双儿   | 女  | 18209876579 | 1993-02-03 00:00:00 |</span><br><span class="line">| 11 | 夏雪   | 女  | 18209876579 | 1993-02-03 00:00:00 |</span><br><span class="line">|  8 | 小昭   | 女  | 18209876567 | 1989-02-03 00:00:00 |</span><br><span class="line">|  7 | 岳灵珊 | 女  | 18219876577 | 1987-12-30 00:00:00 |</span><br><span class="line">|  4 | 热巴   | 女  | 18209876579 | 1993-02-03 00:00:00 |</span><br><span class="line">| 10 | 王语嫣 | 女  | 18209179577 | 1992-02-03 00:00:00 |</span><br><span class="line">|  2 | 苍老师 | 女  | 18219876577 | 1987-12-30 00:00:00 |</span><br><span class="line">| 12 | 赵敏   | 女  | 18209179577 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">8 rows in set</span><br></pre></td></tr></table></figure>

<p>这里的NOT否定跟在它之后的条件，因此，MySQL不是匹配 id  为1,3,5,6的，而是匹配 1,3,5,6以外的 id。</p>
<p><strong>NOT 的作用：</strong></p>
<p>在更复杂的子句中，NOT 可以在与IN操作符联合使用时，NOT用来找出与条件列表不匹配的行非常简单。****</p>
</blockquote>
<h3 id="说明："><a href="#说明：" class="headerlink" title="说明："></a><strong>说明：</strong></h3><p>​    MySQL中的NOT MySQL支持使用NOT对IN、BETWEEN和 EXISTS子句取反，这与多数其他DBMS允许使用NOT对各种条件取反有很大的差别。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h2><p>本节主要学习内容为:</p>
<ul>
<li>如何用AND和OR操作符组合成WHERE子句 。</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>MySQL必知必会</category>
        <category>过滤</category>
      </categories>
      <tags>
        <tag>where</tag>
        <tag>AND</tag>
        <tag>OR</tag>
        <tag>IN</tag>
        <tag>NOT</tag>
        <tag>过滤</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（二）MySQL简介</title>
    <url>/2020/05/08/MySQL%EF%BC%88%E4%BA%8C%EF%BC%89MySQL%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="什么是-MySQL"><a href="#什么是-MySQL" class="headerlink" title="什么是 MySQL"></a>什么是 MySQL</h2><h3 id="定义："><a href="#定义：" class="headerlink" title="定义："></a><strong>定义：</strong></h3><blockquote>
<p> MySQL是一种DBMS，即它是一种数据库软件。 </p>
</blockquote>
<hr>
<h3 id="选择-MySQL-的原因"><a href="#选择-MySQL-的原因" class="headerlink" title="选择 MySQL 的原因"></a>选择 MySQL 的原因</h3><ul>
<li>成本——MySQL是开放源代码的，一般可以免费使用（甚至可以免费修改）。 </li>
<li>性能——MySQL执行很快（非常快）。 </li>
<li>可信赖——某些非常重要和声望很高的公司、站点使用MySQL，这些公司和站点都用MySQL来处理自己的重要数据。</li>
<li>简单——MySQL很容易安装和使用。</li>
</ul>
<hr>
<h3 id="客户机—服务器软件"><a href="#客户机—服务器软件" class="headerlink" title="客户机—服务器软件"></a>客户机—服务器软件</h3><p><strong>DBMS可分为两类：</strong></p>
<blockquote>
<p>一类为基于共享文件系统的DBMS；</p>
<p>另一类为基于客户机—服务器的DBMS。</p>
</blockquote>
<p>​    前者（包括诸如Microsoft Access和FileMaker），用于桌面用途，通常不用于高端或更关键的应用。</p>
<p>​    MySQL、Oracle以及Microsoft SQL Server等数据库是基于客户机—服务器的数据库。客户机—服务器应用分为两个不同的部分。服务器部分是负责所有数据访问和处理的一个软件。这个软件运行在称为数据库服务器的计算机上。</p>
<p><strong>服务器与客户机</strong></p>
<ul>
<li>服务器软件为MySQL DBMS。你可以在本地安装的副本上运行，也可以连接到运行在你具有访问权的远程服务器上的一个副本。</li>
<li>客户机可以是MySQL提供的工具、脚本语言（如Perl）、Web应用开发语言（如ASP、ColdFusion、JSP和PHP）、程序设计语言（如C、C++、Java）等。</li>
</ul>
<h3 id="MySQL版本"><a href="#MySQL版本" class="headerlink" title="MySQL版本"></a>MySQL版本</h3><p>MySQL的当前版本为版本8① （虽然许多公司正在使用MySQL 4 和 5）。 </p>
<p>下面是最近版本中引入的主要更改。 </p>
<ul>
<li>4——InnoDB引擎，增加事务处理（二十六）、并（十七）、改进全文本搜索（十八）等的支持。 </li>
<li>4.1——对函数库、子查询（十四）、集成帮助等的重要增加。</li>
<li>5——存储过程（二十三）、触发器（二十五）、游标（二十四）、 视图（二十二）等。</li>
<li>8——待更新</li>
</ul>
<hr>
<h2 id="MySQL-工具"><a href="#MySQL-工具" class="headerlink" title="MySQL 工具"></a>MySQL 工具</h2><p>​    MySQL是一个客户机—服务器DBMS，因此，为了使用MySQL，需要有一个客户机，即你需要用来与MySQL打交道（给MySQL 提供要执行的命令）的一个应用。</p>
<h3 id="mysql命令行实用程序"><a href="#mysql命令行实用程序" class="headerlink" title="mysql命令行实用程序"></a>mysql命令行实用程序</h3><p>​    每个MySQL安装都有一个名为mysql的简单命令行实用程序。这个实用程序没有下拉菜单、流行的用户界面、鼠标支持或任何类似的东西。</p>
<p>​    在操作系统命令提示符下输入mysql将出现一个如下的简单提示： </p>
<img src="http://photo.wushaopei.com/qiniu604.png" width="60%">

<p>​    这里需要通过在地址栏输入 cmd 打开命令行，并在 mysql 后面添加相应的账号信息以启动该 MySQL 客户端，<code>mysql -u ${username} -p ${passowrd}</code>.</p>
<p>​    以上连接密令方式不受 MySQL 版本的限制，是通用的。</p>
<h4 id="使用-MySQL-命令要注意的几个点："><a href="#使用-MySQL-命令要注意的几个点：" class="headerlink" title="使用 MySQL 命令要注意的几个点："></a><strong>使用 MySQL 命令要注意的几个点：</strong></h4><ul>
<li>命令输入在mysql&gt;之后； </li>
<li>命令用;或\g结束，换句话说，仅按Enter不执行命令； </li>
<li>输入help或\h获得帮助，也可以输入更多的文本获得特定命令的帮助（如，输入help select获得使用SELECT语句的帮助）；</li>
<li>输入quit或exit退出命令行实用程序。 </li>
</ul>
<p>mysql命令行实用程序是使用最多的实用程序之一，它对于快速测试 和执行脚本（如前一章和附录B中的样例表创建和填充脚本）非常有价值。</p>
<blockquote>
<p>启动 mysql 客户端命令行的 命令 <code>mysql -u ${username} -p ${passowrd}</code> 在 Linux 系统上也同样适用。</p>
</blockquote>
<h3 id="MySQL-Navicat-等"><a href="#MySQL-Navicat-等" class="headerlink" title="MySQL - Navicat 等"></a>MySQL - Navicat 等</h3><p>​    <strong>Navicat</strong> 为一个图形交互客户机，用来编写和执行MySQL命令。</p>
<blockquote>
<p>Navicat 要求输入服务器和登录信息、数据库类型（这里是选中MySQL），然后显示应用界面。</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu605.png" width="60%">

<p>Navicat 中 在选择对应的 数据库软件类型后，再进行服务器、登录信息的输入，通过连接器连接到服务端，最后显示应用界面。</p>
<img src="http://photo.wushaopei.com/qiniu606.png" width="60%">

<h4 id="这里要注意几点："><a href="#这里要注意几点：" class="headerlink" title="这里要注意几点："></a><strong>这里要注意几点：</strong></h4><ul>
<li><p>选择数据库后，右键开启 “ 命令行界面 ” 后，输入MySQL命令到窗口中。在输入语句后，单击 </p>
<p>回车按钮把它提交给MySQL处理。</p>
</li>
<li><p>选中数据库后，点击工具栏 <code>查询</code> 按钮打开查询编辑器，输入 CRUD 语句后，选中或直接点击 <code>运行</code> 按钮把它提交给 MySQL 处理</p>
</li>
<li><p>客户端（图形化工具）的结果（如果有）显示在屏幕左边的大区域网格中。 </p>
</li>
<li><p>多条语句和结果显示在它们自己的标签中，并且允许快速切换。 </p>
</li>
<li><p>屏幕右边是一个标签，它列出所有可能的数据源（这里称为大纲），展开任一数据源查看它的表，展开任一个表查看它的列。</p>
</li>
<li><p>你还可以选择表和列让 Navicat为你编写MySQL语句。</p>
</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu607.png" width="60%">

<h4 id="脚本的保存"><a href="#脚本的保存" class="headerlink" title="脚本的保存"></a>脚本的保存</h4><p>​    点击    <code>保存</code>  按钮执行保存的脚本。为执行保存的脚本，请选择File, Open Script，选择相应的脚本（它将显示在一个新标签中），然后单击Execute按钮。</p>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a><strong>小结：</strong></h3><p>本节主要介绍了什么是 MySQL ， 并引入了几个客户机实用程序（一个命令行实用程序，一个图形实用程序）。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>MySQL必知必会</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>服务器软件</tag>
        <tag>客户机</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（三）使用MySQL</title>
    <url>/2020/05/08/MySQL%EF%BC%88%E4%B8%89%EF%BC%89%E4%BD%BF%E7%94%A8MySQL/</url>
    <content><![CDATA[<h2 id="本节要点："><a href="#本节要点：" class="headerlink" title="本节要点："></a>本节要点：</h2><ul>
<li>如何连接和登录到 MySQL</li>
<li>如何执行 MySQL 语句</li>
<li>如何获得数据库和表的信息</li>
</ul>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><p>​    MySQL与所有客户机—服务器DBMS一样，要求在能执行命令之前登录到DBMS。登录名可以与网络登录名不相同（假定你使用网络）。MySQL 在内部保存自己的用户列表，并且把每个用户与各种权限关联起来。</p>
<p>​    在最初安装MySQL时，很可能会要求你输入一个管理登录（通常为root）和一个口令。</p>
<p>​    在不考虑上线环境登录保护的情况下，可以直接通过上述方式就登录到本地服务器。</p>
<p><strong>登录到 MySQL 服务器，需要的信息：</strong></p>
<ul>
<li>主机名（计算机名）——如果连接到本地MySQL服务器，为localhost； </li>
<li>端口（如果使用默认端口3306之外的端口）； </li>
<li>一个合法的用户名； </li>
<li>用户口令（如果需要） </li>
</ul>
<h2 id="选择数据库"><a href="#选择数据库" class="headerlink" title="选择数据库"></a>选择数据库</h2><p>​    默认情况下，首次连接到 MySQL 时，已有的数据库都是关闭状态，需要手动选择并打开需要使用的数据库。 </p>
<p>​    打开方式， 使用 <strong>USE 关键字</strong>。</p>
<blockquote>
<p><strong>关键字(key word)</strong> 作为MySQL语言组成部分的一个保留字。决不要用关键字命名一个表或列。附录E列出了MySQL的关键字。</p>
</blockquote>
<p>不要用关键字命名一个表或列。附录E列出了MySQL的关键字。 </p>
<p>例如，为了使用 <strong>test</strong> 数据库，应该输入以下内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; USE test;</span><br><span class="line">Database changed</span><br></pre></td></tr></table></figure>

<p><strong>USE</strong>语句并不返回任何结果。依赖于使用的客户机，显示某种形式的通知。例如，这里显示出的<code>Database changed</code> 消息是mysql命令行实用程序在数据库选择成功后显示的。</p>
<h2 id="了解数据库和表"><a href="#了解数据库和表" class="headerlink" title="了解数据库和表"></a>了解数据库和表</h2><h3 id="显示数据库列表"><a href="#显示数据库列表" class="headerlink" title="显示数据库列表"></a>显示数据库列表</h3><p>数据库、表、列、用户、权限等的信息被存储在数据库和表中（MySQL 使用MySQL来存储这些信息）。</p>
<p>可用 MySQL 的SHOW命令来显示这些信息（MySQL从内部表中提取这些信息）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| commodity         |</span><br><span class="line">| activiti-explorer  |</span><br><span class="line">| imooc-video-dev    |</span><br><span class="line">| information_schema |</span><br><span class="line">| mc_orderdb         |</span><br><span class="line">| mc_productdb       |</span><br><span class="line">| mc_userdb          |</span><br><span class="line">| mp                 |</span><br><span class="line">| mybatis            |</span><br><span class="line">| myemployees        |</span><br><span class="line">| mysql              |</span><br><span class="line">| one                |</span><br><span class="line">| order              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| permission         |</span><br><span class="line">| xproduct           |</span><br><span class="line">+--------------------+</span><br><span class="line">16 rows in set</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SHOW DATABASES;返回可用数据库的一个列表。包含在这个列表中的可能是MySQL内部使用的数据库（如例子中的mysql和information_schema）。当然，你自己的数据库列表可能看上去与这里的不一样。</p>
</blockquote>
<h3 id="显示可用的表的列表"><a href="#显示可用的表的列表" class="headerlink" title="显示可用的表的列表"></a>显示可用的表的列表</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| course         |</span><br><span class="line">| customer       |</span><br><span class="line">| mytable        |</span><br><span class="line">| sc             |</span><br><span class="line">| student        |</span><br><span class="line">| table_emp      |</span><br><span class="line">| teacher        |</span><br><span class="line">| user           |</span><br><span class="line">| user_table     |</span><br><span class="line">+----------------+</span><br><span class="line">9 rows in set</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SHOW TABLES;返回当前选择的数据库内可用表的列表。 </p>
</blockquote>
<h3 id="显示表的列信息"><a href="#显示表的列信息" class="headerlink" title="显示表的列信息"></a>显示表的列信息</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW COLUMNS FROM customer;</span><br><span class="line">+-------+-------------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra          |</span><br><span class="line">+-------+-------------+------+-----+---------+----------------+</span><br><span class="line">| id    | bigint(20)  | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name  | varchar(30) | YES  |     | NULL    |                |</span><br><span class="line">| email | varchar(20) | YES  |     | NULL    |                |</span><br><span class="line">| birth | date        | YES  |     | NULL    |                |</span><br><span class="line">| photo | mediumblob  | YES  |     | NULL    |                |</span><br><span class="line">+-------+-------------+------+-----+---------+----------------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>SHOW COLUMNS</strong> 要求给出一个表名（这个例子中的 FROM  customers），它对每个字段返回一行，行中包含字段名、数据类型、是否允许NULL、键信息、默认值以及其他信息（如字段cust_id的auto_increment）。</p>
</blockquote>
<p><strong>同义 命令</strong>  *<em>- DESCRIBE语句  *</em></p>
<pre><code>MySQL支持用DESCRIBE作为SHOW COLUMNS FROM的一种快捷方式。换句话说，DESCRIBE customers;是 SHOW COLUMNS FROM customers;的一种快捷方式。</code></pre><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; DESCRIBE customer;</span><br><span class="line">+-------+-------------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra          |</span><br><span class="line">+-------+-------------+------+-----+---------+----------------+</span><br><span class="line">| id    | bigint(20)  | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name  | varchar(30) | YES  |     | NULL    |                |</span><br><span class="line">| email | varchar(20) | YES  |     | NULL    |                |</span><br><span class="line">| birth | date        | YES  |     | NULL    |                |</span><br><span class="line">| photo | mediumblob  | YES  |     | NULL    |                |</span><br><span class="line">+-------+-------------+------+-----+---------+----------------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<p><strong>其他常用的 SHOW 语句：</strong></p>
<ul>
<li>SHOW STATUS，用于显示广泛的服务器状态信息； </li>
<li>SHOW CREATE DATABASE和SHOW CREATE TABLE，分别用来显示创建特定数据库或表的MySQL语句；</li>
<li>SHOW GRANTS，用来显示授予用户（所有用户或特定用户）的安全权限；</li>
<li>SHOW ERRORS和SHOW WARNINGS，用来显示服务器错误或警告消息。 </li>
</ul>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><p>本小节主要讲述了以下几个方面：</p>
<ul>
<li>如何连接和登录MySQL，</li>
<li>如何用USE选择数据库，</li>
<li>如何用 SHOW查看MySQL数据库、表和内部信息</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>MySQL必知必会</category>
      </categories>
      <tags>
        <tag>连接和登录到 MySQL</tag>
        <tag>执行 MySQL 语句</tag>
        <tag>获得数据库和表的信息</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity（十七）流程监听器</title>
    <url>/2020/04/21/Activity%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89%E6%B5%81%E7%A8%8B%E7%9B%91%E5%90%AC%E5%99%A8/</url>
    <content><![CDATA[<h2 id="流程监听器"><a href="#流程监听器" class="headerlink" title="流程监听器"></a>流程监听器</h2><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>绑定到某一个任务节点上，当这个节点被执行时执行预先设定的操作。</p>
<h3 id="创建流程定义"><a href="#创建流程定义" class="headerlink" title="创建流程定义"></a>创建流程定义</h3><img src="http://photo.wushaopei.com/qiniu412.png" width="80%">

<h3 id="设置流程定义"><a href="#设置流程定义" class="headerlink" title="设置流程定义"></a>设置流程定义</h3><h4 id="指定任务委托人"><a href="#指定任务委托人" class="headerlink" title="指定任务委托人"></a>指定任务委托人</h4><img src="http://photo.wushaopei.com/qiniu413.png" width="80%">

<h4 id="设置排他网关分支条件"><a href="#设置排他网关分支条件" class="headerlink" title="设置排他网关分支条件"></a>设置排他网关分支条件</h4><img src="http://photo.wushaopei.com/qiniu414.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu415.png" width="80%">

<p>两个表达式是：${flag==true}和${flag==false}</p>
<h4 id="创建流程监听器类"><a href="#创建流程监听器类" class="headerlink" title="创建流程监听器类"></a>创建流程监听器类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YesListener</span> <span class="keyword">implements</span> <span class="title">ExecutionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(DelegateExecution execution)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"This is YesListener...☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoListener</span> <span class="keyword">implements</span> <span class="title">ExecutionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(DelegateExecution execution)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"This is NoListener...☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="绑定监听器"><a href="#绑定监听器" class="headerlink" title="绑定监听器"></a>绑定监听器</h4><img src="http://photo.wushaopei.com/qiniu416.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu418.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu417.png" width="80%">



<h4 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.HistoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngines;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RuntimeService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.TaskService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricProcessInstanceQuery;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.Deployment;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.Execution;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.ProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.Task;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.TaskQuery;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.entity.Employee;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 监听器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月21日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">activiti_listener</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取默认的流程引擎实例 会自动读取activiti.cfg.xml文件 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义一个成员变量</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line">    </span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line">    </span><br><span class="line">    TaskService taskService;</span><br><span class="line">    </span><br><span class="line">    HistoryService historyService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取流程引擎</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">        repositoryService = processEngine.getRepositoryService();</span><br><span class="line">        runtimeService = processEngine.getRuntimeService();</span><br><span class="line">        taskService = processEngine.getTaskService();</span><br><span class="line">        historyService = processEngine.getHistoryService();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 部署流程定义</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="comment">// 获取部署对象</span></span><br><span class="line">	    Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">	                 .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">	                 .addClasspathResource(<span class="string">"diagrams/MyProcess6.bpmn"</span>)  <span class="comment">// 加载资源文件</span></span><br><span class="line">	                 .deploy(); <span class="comment">// 部署</span></span><br><span class="line">	    System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">	    System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"listener"</span>);</span><br><span class="line">        String processInstanceId = processInstance.getId();</span><br><span class="line">        String activityId = processInstance.getActivityId();</span><br><span class="line">        String definitionId = processInstance.getProcessDefinitionId();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"流程实例ID："</span>+processInstanceId);</span><br><span class="line">        System.out.println(<span class="string">"正在活动的节点ID："</span>+activityId);</span><br><span class="line">        System.out.println(<span class="string">"流程定义ID："</span>+definitionId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//启动指定流程</span></span><br><span class="line">    <span class="comment">//	</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStartProcessInstanceWithVariable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		String processDefinitionKey = <span class="string">"listener"</span>;</span><br><span class="line">		</span><br><span class="line">		String processDefinitionId = repositoryService.createProcessDefinitionQuery().processDefinitionKey(processDefinitionKey).latestVersion().singleResult().getId();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//为启动流程实例，给流程变量指定值</span></span><br><span class="line">		Map&lt;String,Object&gt; variables = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">		variables.put(<span class="string">"flag"</span>, <span class="string">"true"</span>);</span><br><span class="line">		</span><br><span class="line">		ProcessInstance processInstance = </span><br><span class="line">				runtimeService.startProcessInstanceById(processDefinitionId, variables);</span><br><span class="line">		</span><br><span class="line">		System.err.println(<span class="string">"----------------"</span>+processInstance);</span><br><span class="line">	&#125;</span><br><span class="line">   </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        String assignee = <span class="string">"吴刚"</span>;  </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 查询并且返回任务即可</span></span><br><span class="line">        List&lt;Task&gt; taskList = taskService.createTaskQuery()  <span class="comment">// 任务相关Service // 创建任务查询</span></span><br><span class="line">                                     .processDefinitionKey(<span class="string">"listener"</span>)</span><br><span class="line">                                     .taskAssignee(assignee)<span class="comment">// 指定某个人</span></span><br><span class="line">                                     .orderByTaskCreateTime()</span><br><span class="line">                                     .desc()</span><br><span class="line">                                     .list();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(Task task:taskList)&#123;</span><br><span class="line">            System.out.println(<span class="string">"任务ID:"</span>+task.getId()); </span><br><span class="line">            System.out.println(<span class="string">"任务名称:"</span>+task.getName());</span><br><span class="line">            System.out.println(<span class="string">"任务创建时间:"</span>+task.getCreateTime());</span><br><span class="line">            System.out.println(<span class="string">"任务委派人:"</span>+task.getAssignee());</span><br><span class="line">            System.out.println(<span class="string">"流程实例ID:"</span>+task.getProcessInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 完成任务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask2</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		  Map&lt;String, Object&gt; variables=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">	        <span class="comment">//传入流程变量</span></span><br><span class="line">	        variables.put(<span class="string">"flag"</span>, <span class="string">"true"</span>);</span><br><span class="line">	        processEngine.getTaskService() <span class="comment">// 任务相关Service</span></span><br><span class="line">	            .complete(<span class="string">"237504"</span>, variables); <span class="comment">//完成任务的时候，设置流程变量</span></span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
      <tags>
        <tag>流程监听器</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（八）使用通配符过滤</title>
    <url>/2020/05/15/MySQL%EF%BC%88%E5%85%AB%EF%BC%89%E4%BD%BF%E7%94%A8%E9%80%9A%E9%85%8D%E7%AC%A6%E8%BF%87%E6%BB%A4/</url>
    <content><![CDATA[<h1 id="通配符过滤"><a href="#通配符过滤" class="headerlink" title="通配符过滤"></a>通配符过滤</h1><p>要点： SELECT 语句中 使用  like 、%、_  等通配符 进行指定模糊过滤条件</p>
<p><strong>工具表：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;beauty&#96; (</span><br><span class="line">&#96;id&#96;  int(11) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">&#96;name&#96;  varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;sex&#96;  char(1) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT &#39;女&#39; ,</span><br><span class="line">&#96;borndate&#96;  datetime NULL DEFAULT &#39;1987-01-01 00:00:00&#39; ,</span><br><span class="line">&#96;phone&#96;  varchar(11) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;photo&#96;  blob NULL ,</span><br><span class="line">&#96;boyfriend_id&#96;  int(11) NULL DEFAULT NULL ,</span><br><span class="line">PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">)</span><br><span class="line">ENGINE&#x3D;InnoDB</span><br><span class="line">DEFAULT CHARACTER SET&#x3D;utf8 COLLATE&#x3D;utf8_general_ci</span><br><span class="line">AUTO_INCREMENT&#x3D;12</span><br><span class="line">ROW_FORMAT&#x3D;DYNAMIC</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<h2 id="LIKE-操作符"><a href="#LIKE-操作符" class="headerlink" title="LIKE 操作符"></a>LIKE 操作符</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote>
<ol>
<li>通配符（wildcard） 用来匹配值的一部分的特殊字符。</li>
<li>搜索模式（search pattern）由字面值、通配符或两者组合构成的搜索条件。</li>
</ol>
</blockquote>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><blockquote>
<p>用于查询表中未知确切条件的数据。没有精确查询的对象。</p>
</blockquote>
<h3 id="百分号（-）通配符"><a href="#百分号（-）通配符" class="headerlink" title="百分号（%）通配符"></a>百分号（%）通配符</h3><blockquote>
<p>最常使用的通配符是百分号（%）。在搜索串中，%表示任何字符出现任意次数。</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name </span><br><span class="line">like &#39;%雪&#39;;</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">| id | name | sex | phone       | borndate            |</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">| 11 | 夏雪 | 女  | 18209876579 | 1993-02-03 00:00:00 |</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">1 row in set</span><br></pre></td></tr></table></figure>
</blockquote>
<p>此 SQL 语句模糊查询 ‘%雪’  , 在执行这条子句时，会检索结果集中满足 name  的最后一个字符为 ‘雪’  的 name .   % 代表前面不管它前面有多少字符。</p>
<blockquote>
<p>下面的例子使用两个通配符;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name like &#39;%灵%</span><br><span class="line">&#39;;</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| id | name   | sex | phone       | borndate            |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">|  7 | 岳灵珊 | 女  | 18219876577 | 1987-12-30 00:00:00 |</span><br><span class="line">|  9 | 灵儿   | 女  | 18209876579 | 1993-02-03 00:00:00 |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>注意：</strong>  </p>
<p>​    <code>虽然似乎%通配符可以匹配任何东西，但有一个例外，即NULL。</code></p>
<h3 id="下划线（-）通配符"><a href="#下划线（-）通配符" class="headerlink" title="下划线（_）通配符"></a>下划线（_）通配符</h3><blockquote>
<p> 另一个有用的通配符是下划线（_）。下划线的用途与%一样，但下划线只匹配单个字符而不是多个字符。</p>
<p> <strong>示例</strong>： </p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name like &#39;灵_</span><br><span class="line">&#39;;</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">| id | name | sex | phone       | borndate            |</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">|  9 | 灵儿 | 女  | 18209876579 | 1993-02-03 00:00:00 |</span><br><span class="line">+----+------+-----+-------------+---------------------+</span><br><span class="line">1 row in set</span><br></pre></td></tr></table></figure>

<p> 此WHERE子句中的搜索模式给出了后面跟有文本的两个通配符。</p>
</blockquote>
<h3 id="和-的区别"><a href="#和-的区别" class="headerlink" title="% 和 _ 的区别"></a>% 和 _ 的区别</h3><blockquote>
<p>%能匹配0个字符，_总是匹配一个字符，不能多也不能少。 </p>
</blockquote>
<h2 id="使用通配符的技巧"><a href="#使用通配符的技巧" class="headerlink" title="使用通配符的技巧"></a>使用通配符的技巧</h2><ul>
<li><p>不要过度使用通配符。如果其他操作符能达到相同的目的，应该使用其他操作符。</p>
</li>
<li><p>在确实需要使用通配符时，除非绝对有必要，否则不要把它们用在搜索模式的开始处。把通配符置于搜索模式的开始处，搜索起来是最慢的。</p>
</li>
<li><p>仔细注意通配符的位置。如果放错地方，可能不会返回想要的数据。 </p>
<p>总之，通配符是一种极重要和有用的搜索工具，以后我们经常会用到它。</p>
</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h2><p>本节主要学习内容为:</p>
<ul>
<li>什么是通配符 </li>
<li>如何在WHERE子句中使用SQL通配符 </li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>MySQL必知必会</category>
        <category>过滤</category>
      </categories>
      <tags>
        <tag>like</tag>
        <tag>通配符</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（六）过滤数据</title>
    <url>/2020/05/15/MySQL%EF%BC%88%E5%85%AD%EF%BC%89%E8%BF%87%E6%BB%A4%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<h1 id="过滤数据"><a href="#过滤数据" class="headerlink" title="过滤数据"></a>过滤数据</h1><p>要点： SELECT 语句中 使用 where 进行指定过滤条件</p>
<p><strong>工具表：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;NewTable&#96; (</span><br><span class="line">&#96;id&#96;  int(11) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">&#96;name&#96;  varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;sex&#96;  char(1) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT &#39;女&#39; ,</span><br><span class="line">&#96;borndate&#96;  datetime NULL DEFAULT &#39;1987-01-01 00:00:00&#39; ,</span><br><span class="line">&#96;phone&#96;  varchar(11) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;photo&#96;  blob NULL ,</span><br><span class="line">&#96;boyfriend_id&#96;  int(11) NULL DEFAULT NULL ,</span><br><span class="line">PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">)</span><br><span class="line">ENGINE&#x3D;InnoDB</span><br><span class="line">DEFAULT CHARACTER SET&#x3D;utf8 COLLATE&#x3D;utf8_general_ci</span><br><span class="line">AUTO_INCREMENT&#x3D;12</span><br><span class="line">ROW_FORMAT&#x3D;DYNAMIC</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<h2 id="使用-WHERE-子句"><a href="#使用-WHERE-子句" class="headerlink" title="使用 WHERE 子句"></a>使用 WHERE 子句</h2><h3 id="过滤原因"><a href="#过滤原因" class="headerlink" title="过滤原因"></a>过滤原因</h3><blockquote>
<p>在实际开发中，对DB 中数据的获取一般都是有条件的检索，即大概率不会检索表中所有的行。</p>
</blockquote>
<h3 id="过滤条件"><a href="#过滤条件" class="headerlink" title="过滤条件"></a>过滤条件</h3><blockquote>
<p>只检索所需数据需要指定搜索条件（search criteria），搜索条件也称为过滤条件（filter  </p>
<p>condition）</p>
</blockquote>
<h3 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h3><blockquote>
<p>在SELECT语句中，数据根据WHERE子句中指定的搜索条件进行过滤。 </p>
</blockquote>
<h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a><strong>示例：</strong></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone from beauty where boyfriend_id &#x3D;1</span><br><span class="line">;</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">| id | name   | sex | phone       |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">|  6 | 周芷若 | 女  | 18209876577 |</span><br><span class="line">|  8 | 小昭   | 女  | 18209876567 |</span><br><span class="line">| 12 | 赵敏   | 女  | 18209179577 |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">3 rows in set</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="WHERE-子句操作符"><a href="#WHERE-子句操作符" class="headerlink" title="WHERE 子句操作符"></a>WHERE 子句操作符</h2><table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>=</td>
<td>等于</td>
</tr>
<tr>
<td>&lt;&gt;</td>
<td>不等于</td>
</tr>
<tr>
<td>!=</td>
<td>不等于</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于等于</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>&gt;=</td>
<td>大于等于</td>
</tr>
<tr>
<td>BETWEEN</td>
<td>在指定的两个值之间</td>
</tr>
</tbody></table>
<h3 id="检查单个值"><a href="#检查单个值" class="headerlink" title="检查单个值"></a>检查单个值</h3><p>​    数据排序不限于升序排序（从A到Z）。这只是默认的排序顺序，还可以使用ORDER BY子句以降序（从Z到A）顺序排序。为了进行降序排序，必须指定DESC关键字。</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone from beauty where boyfriend_id &#x3D;1</span><br><span class="line">;</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">| id | name   | sex | phone       |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">|  6 | 周芷若 | 女  | 18209876577 |</span><br><span class="line">|  8 | 小昭   | 女  | 18209876567 |</span><br><span class="line">| 12 | 赵敏   | 女  | 18209179577 |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">3 rows in set</span><br></pre></td></tr></table></figure>

<blockquote>
<p>检查出 boyfriend_id = 1 的语句，返回 3行完整的数据。</p>
</blockquote>
<h3 id="不匹配检查："><a href="#不匹配检查：" class="headerlink" title="不匹配检查："></a><strong>不匹配检查：</strong></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone from beauty where boyfriend_id &lt;&gt;</span><br><span class="line">1;</span><br><span class="line">+----+------------+-----+-------------+</span><br><span class="line">| id | name       | sex | phone       |</span><br><span class="line">+----+------------+-----+-------------+</span><br><span class="line">|  1 | 柳岩       | 女  | 18209876577 |</span><br><span class="line">|  2 | 苍老师     | 女  | 18219876577 |</span><br><span class="line">|  3 | Angelababy | 女  | 18209876567 |</span><br><span class="line">|  4 | 热巴       | 女  | 18209876579 |</span><br><span class="line">|  5 | 周冬雨     | 女  | 18209179577 |</span><br><span class="line">|  7 | 岳灵珊     | 女  | 18219876577 |</span><br><span class="line">|  9 | 双儿       | 女  | 18209876579 |</span><br><span class="line">| 10 | 王语嫣     | 女  | 18209179577 |</span><br><span class="line">| 11 | 夏雪       | 女  | 18209876579 |</span><br><span class="line">+----+------------+-----+-------------+</span><br><span class="line">9 rows in set</span><br></pre></td></tr></table></figure>



<h3 id="范围值检查"><a href="#范围值检查" class="headerlink" title="范围值检查"></a>范围值检查</h3><p>为了检查某个范围的值，可使用BETWEEN操作符。 其语法与其他WHERE 子句的操作符稍有不同，因为它需要两个值，即范围的开始值和结束值。 </p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone</span><br><span class="line"> from beauty where boyfriend_id Between 1 and 3;</span><br><span class="line">+----+------------+-----+-------------+</span><br><span class="line">| id | name       | sex | phone       |</span><br><span class="line">+----+------------+-----+-------------+</span><br><span class="line">|  3 | Angelababy | 女  | 18209876567 |</span><br><span class="line">|  4 | 热巴       | 女  | 18209876579 |</span><br><span class="line">|  6 | 周芷若     | 女  | 18209876577 |</span><br><span class="line">|  8 | 小昭       | 女  | 18209876567 |</span><br><span class="line">| 12 | 赵敏       | 女  | 18209179577 |</span><br><span class="line">+----+------------+-----+-------------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>



<h3 id="空值检查"><a href="#空值检查" class="headerlink" title="空值检查"></a>空值检查</h3><blockquote>
<p> 在创建表时，表设计人员可以指定其中的列是否可以不包含值。  </p>
<p>一个列不包含值时，称其为包含空值NULL。</p>
</blockquote>
<p><strong>IS NULL</strong> </p>
<blockquote>
<p>SELECT语句有一个特殊的WHERE子句，可用来检查具有NULL值的列。 </p>
<p>这个WHERE子句就是IS NULL子句。</p>
</blockquote>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone from beauty where boyfriend_id is null;</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">| id | name   | sex | phone       |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">| 10 | 王语嫣 | 女  | 18209179577 |</span><br><span class="line">+----+--------+-----+-------------+</span><br><span class="line">1 row in set</span><br></pre></td></tr></table></figure>

<p>这条语句返回的结果中，id 为10 的行的 boyfriend_id 为 null ，所以该行被检索过滤并返回。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h2><p>本节主要学习内容为:</p>
<ul>
<li>如何用SELECT语句的 WHERE 子句对检索出的数据进行过滤。</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>MySQL必知必会</category>
        <category>过滤</category>
      </categories>
      <tags>
        <tag>where</tag>
        <tag>过滤</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（五）排序检索数据</title>
    <url>/2020/05/09/MySQL%EF%BC%88%E4%BA%94%EF%BC%89%E6%8E%92%E5%BA%8F%E6%A3%80%E7%B4%A2%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<h1 id="排序检索数据"><a href="#排序检索数据" class="headerlink" title="排序检索数据"></a>排序检索数据</h1><p>要点： SELECT 语句中 ORDER BY 子句的使用</p>
<h2 id="排序数据"><a href="#排序数据" class="headerlink" title="排序数据"></a>排序数据</h2><h3 id="子句定义"><a href="#子句定义" class="headerlink" title="子句定义"></a>子句定义</h3><blockquote>
<p><strong>子句（clause）</strong> SQL语句由子句构成，有些子句是必需的，而有的是可选的。一个子句通常由一个关键字和所提供的数据组成。</p>
</blockquote>
<h3 id="ORDER-BY-作用"><a href="#ORDER-BY-作用" class="headerlink" title="ORDER BY 作用"></a>ORDER BY 作用</h3><blockquote>
<p>关系数据库设计理论认为，如果不明确规定排序顺序，则不应该假定检索出的数据的顺序有意义。 </p>
<p>为了明确地排序用SELECT语句检索出的数据，可使用<strong>ORDER BY</strong>子句。 </p>
</blockquote>
<h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a><strong>示例：</strong></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select birth</span><br><span class="line"> from customer order by birth;</span><br><span class="line">+------------+</span><br><span class="line">| birth      |</span><br><span class="line">+------------+</span><br><span class="line">| 2019-01-27 |</span><br><span class="line">| 2019-01-27 |</span><br><span class="line">| 2019-01-31 |</span><br><span class="line">| 2019-01-31 |</span><br><span class="line">| 2019-01-31 |</span><br><span class="line">+------------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="按多个列排序"><a href="#按多个列排序" class="headerlink" title="按多个列排序"></a>按多个列排序</h2><p>实际开发过程中，不一定只根据一个列进行数据排序。</p>
<blockquote>
<p>为了按多个列排序，只要指定列名，列名之间用逗号分开即可（就像选择多个列时所做的那样）。</p>
</blockquote>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select name,email,birth from customer order by name,birth;</span><br><span class="line">+-------+----------+------------+</span><br><span class="line">| name  | email    | birth      |</span><br><span class="line">+-------+----------+------------+</span><br><span class="line">| 10001 | 21       | 2019-01-27 |</span><br><span class="line">| 10002 | 22       | 2019-01-27 |</span><br><span class="line">| 强哥  | dfds@sdf | 2019-01-31 |</span><br><span class="line">| 文少  | 文敏     | 2019-01-31 |</span><br><span class="line">| 文星  | 文敏     | 2019-01-31 |</span><br><span class="line">+-------+----------+------------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<p>重要的是理解在按多个列排序时，排序完全按所规定的顺序进行。 </p>
<p>换句话说，对于上述例子中的输出，仅在多个行具有相同的 name 值时才对产品按birth进行排序。如果 name 列中所有的值都是 唯一的，则不会按 birth 排序。</p>
<hr>
<h2 id="指定排序方向"><a href="#指定排序方向" class="headerlink" title="指定排序方向"></a>指定排序方向</h2><p>​    数据排序不限于升序排序（从A到Z）。这只是默认的排序顺序，还可以使用ORDER BY子句以降序（从Z到A）顺序排序。为了进行降序排序，必须指定DESC关键字。</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select Sname,Sage,Ssex from student ORDER BY Sage DESC</span><br><span class="line">;</span><br><span class="line">+--------+------+------+</span><br><span class="line">| Sname  | Sage | Ssex |</span><br><span class="line">+--------+------+------+</span><br><span class="line">| 李秋水 | 21   | 女   |</span><br><span class="line">| 任盈盈 | 20   | 女   |</span><br><span class="line">| 瑛姑   | 20   | 女   |</span><br><span class="line">| 周芷若 | 19   | 女   |</span><br><span class="line">| 杨过   | 19   | 男   |</span><br><span class="line">| 令狐冲 | 19   | 男   |</span><br><span class="line">| 岳灵珊 | 19   | 女   |</span><br><span class="line">| 萧峰   | 19   | 男   |</span><br><span class="line">| 郭靖   | 19   | 男   |</span><br><span class="line">| 周伯通 | 19   | 男   |</span><br><span class="line">| 张无忌 | 18   | 男   |</span><br><span class="line">| 赵敏   | 18   | 女   |</span><br><span class="line">| 张三丰 | 18   | 男   |</span><br><span class="line">| 韦小宝 | 18   | 男   |</span><br><span class="line">| 黄蓉   | 18   | 女   |</span><br><span class="line">| 黄药师 | 18   | 男   |</span><br><span class="line">| 李莫愁 | 18   | 女   |</span><br><span class="line">| 郭襄   | 18   | 女   |</span><br><span class="line">| 小龙女 | 17   | 女   |</span><br><span class="line">| 康敏   | 17   | 女   |</span><br><span class="line">| 冯默风 | 17   | 男   |</span><br><span class="line">| 王重阳 | 17   | 男   |</span><br><span class="line">+--------+------+------+</span><br><span class="line">22 rows in set</span><br></pre></td></tr></table></figure>

<p><strong>多列排序示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select Sname,Sage,Ssex from student ORDER BY Sage DESC,Ssex;</span><br><span class="line">+--------+------+------+</span><br><span class="line">| Sname  | Sage | Ssex |</span><br><span class="line">+--------+------+------+</span><br><span class="line">| 李秋水 | 21   | 女   |</span><br><span class="line">| 任盈盈 | 20   | 女   |</span><br><span class="line">| 瑛姑   | 20   | 女   |</span><br><span class="line">| 周芷若 | 19   | 女   |</span><br><span class="line">| 岳灵珊 | 19   | 女   |</span><br><span class="line">| 杨过   | 19   | 男   |</span><br><span class="line">| 令狐冲 | 19   | 男   |</span><br><span class="line">| 萧峰   | 19   | 男   |</span><br><span class="line">| 郭靖   | 19   | 男   |</span><br><span class="line">| 周伯通 | 19   | 男   |</span><br><span class="line">| 赵敏   | 18   | 女   |</span><br><span class="line">| 黄蓉   | 18   | 女   |</span><br><span class="line">| 李莫愁 | 18   | 女   |</span><br><span class="line">| 郭襄   | 18   | 女   |</span><br><span class="line">| 张无忌 | 18   | 男   |</span><br><span class="line">| 张三丰 | 18   | 男   |</span><br><span class="line">| 韦小宝 | 18   | 男   |</span><br><span class="line">| 黄药师 | 18   | 男   |</span><br><span class="line">| 小龙女 | 17   | 女   |</span><br><span class="line">| 康敏   | 17   | 女   |</span><br><span class="line">| 冯默风 | 17   | 男   |</span><br><span class="line">| 王重阳 | 17   | 男   |</span><br><span class="line">+--------+------+------+</span><br><span class="line">22 rows in set</span><br></pre></td></tr></table></figure>

<blockquote>
<p>DESC关键字只应用到直接位于其前面的列名。 </p>
</blockquote>
<p><strong>注意：</strong> 在多个列上降序排序 如果想在多个列上进行降序排序，必须对每个列指定DESC关键字。</p>
<blockquote>
<p>与DESC相反的关键字是ASC（ASCENDING），在升序排序时可以指定它。 </p>
</blockquote>
<hr>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h2><p>本节主要学习内容为:</p>
<ul>
<li>如何用SELECT语句的ORDER BY子句对检索出的数据进行排序。</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>MySQL必知必会</category>
      </categories>
      <tags>
        <tag>排序检索数据</tag>
      </tags>
  </entry>
  <entry>
    <title>OSGI: (一) 简述对OSGI的认识</title>
    <url>/2020/04/13/OSGI-%E4%B8%80-%E7%AE%80%E8%BF%B0%E5%AF%B9OSGI%E7%9A%84%E8%AE%A4%E8%AF%86/</url>
    <content><![CDATA[<h2 id="OSGI：简述对OSGI的认识"><a href="#OSGI：简述对OSGI的认识" class="headerlink" title="OSGI：简述对OSGI的认识"></a>OSGI：简述对OSGI的认识</h2><h2 id="一、OSGI的概念"><a href="#一、OSGI的概念" class="headerlink" title="一、OSGI的概念"></a>一、OSGI的概念</h2><p>OSGI（Open Service Gateway Initiative，直译为“开放服务网关”）实际上是一个由OSGi联盟（OSGi Alliance）发起的以Java为技术平台的动态模块化规范。</p>
<p>OSGi联盟是由Sun Microsystems、IBM、Ericsson等公司于1999年3月成立的一个世界性的开放标准化组织，最初的名称为Connected Alliance。最初的OSGi规范也只是关注于嵌入式领域，前三个版本的OSGi规范主要满足诸如机顶盒、服务网关、手机等应用环境的模块化需求。从第四个版本开始，OSGi将主要关注点转向了Java SE和EE领域，并且在这些领域中获得了很大的发展，成为Java平台事实上的模块化规范。</p>
<p>随着OSGi技术的不断发展，OSGi联盟的成员数量已经由最开始的几个增长到目前超过100个，很多世界著名的IT企业都加入到OSGi的阵营之中，如Adobe、IBM、Oracle、SAP、RedHat和Siemens等。它们推出的许多产品都支持OSGi技术，甚至产品本身就使用了OSGi技术构建，例如IBM的WebSphere、Lotus和JAZZ，Oracle的GlassFish和Weblogic，RedHat的JBoss，Eclipse基金会的Eclipse IDE、Equinox及之下的众多子项目，Apache基金会的Karaf、Aries、Geronimo、Felix及之下的众多子项目等。这些IT巨头的踊跃参与，也从侧面证明了OSGi技术有着非常广阔的市场前景。</p>
<p>今天，OSGi的已经不再是原来Open Service Gateway Initiative的字面意义能涵盖的了，OSGi联盟给出的最新OSGi定义是The Dynamic Module System for Java，即面向Java的动态模块化系统。</p>
<p>OSGI的架构图如下：</p>
<img src="http://photo.wushaopei.com/qiniu304.png" width="60%">

<h2 id="二、OSGI的功能"><a href="#二、OSGI的功能" class="headerlink" title="二、OSGI的功能"></a>二、OSGI的功能</h2><p>以一个简单开的开发场景作说明：假设我们使用SSM框架来开发我们的Web项目，我们做产品设计和开发的时候都是分模块的，我们分模块的目的就是实现模块之间的“解耦”，更进一步的目的是方便对一个项目的控制和管理。我们对一个项目进行模块化分解之后，我们就可以把不同模块交给不同的开发人员来完成开发，然后项目经理把大家完成的模块集中在一起，然后拼装成一个最终的产品。一般我们开发都是这样的基本情况。</p>
<p>在开发过程中，模块之间还要彼此保持联系，比如A模块要从B模块拿到一些数据，而B模块可能要调用C模块中的一些方法(除了公共底层的工具类之外)。</p>
<p>最后，我们要把最终的项目部署到tomcat或者jBoss的服务器中。那么我们启动服务器的时候，能不能关闭项目的某个模块或功能呢？很明显是做不到的，一旦服务器启动，所有模块就要一起启动，都要占用服务器资源，所以关闭不了模块，假设能强制拿掉，就会影响其它的功能。</p>
<p><strong>以上就是我们传统模块式开发的一些局限性。</strong></p>
<p>软件开发一直在追求一个境界，就是模块之间的真正“解耦”、“分离”，这样我们在软件的管理和开发上面就会更加的灵活，甚至包括给客户部署项目的时候都可以做到更加的灵活可控。但是我们以前使用SSM等架构模式进行产品开发的时候我们是达不到这种要求的。</p>
<p>所以OSGI的技术规范应运而生。现在的OSGI技术就可以满足我们之前所说的境界：在不同的模块中做到彻底的分离，而不是逻辑意义上的分离，是物理上的分离，也就是说在运行部署之后都可以在不停止服务器的时候直接把某些模块拿下来，其他模块的功能也不受影响。</p>
<p>现在主流的一些应用服务器，Oracle的weblogic服务器，IBM的WebSphere，JBoss，还有Sun公司的glassfish服务器，都对OSGI提供了强大的支持，都是在OSGI的技术基础上实现的。</p>
<p><strong>简单点说，OSGI被设计专门用来开发可分解为功能模块的复杂的Java应用。</strong> OSGI提供以下优势：</p>
<p>​    1. 可以动态地安装、卸载、启动、停止不同的应用模块，而不需要重启容器。<br>    2. 在同一时刻可以跑多个同一个应用模块的实例。<br>    3. OSGI在SOA领域提供成熟的解决方案，包括嵌入式，移动设备和富客户端应用等。</p>
<p>————————————————<br>转载，原文链接：<a href="https://blog.csdn.net/qq_29229567/article/details/88534277" target="_blank" rel="noopener">https://blog.csdn.net/qq_29229567/article/details/88534277</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>OSGI</category>
      </categories>
      <tags>
        <tag>OSGI</tag>
        <tag>简介</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（四）检索数据</title>
    <url>/2020/05/08/MySQL%EF%BC%88%E5%9B%9B%EF%BC%89%E6%A3%80%E7%B4%A2%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<h1 id="检索数据"><a href="#检索数据" class="headerlink" title="检索数据"></a>检索数据</h1><blockquote>
<p>从表中查询一个或多个数据列。</p>
</blockquote>
<h2 id="SELECT语句"><a href="#SELECT语句" class="headerlink" title="SELECT语句"></a>SELECT语句</h2><h3 id="SQL-语句构成"><a href="#SQL-语句构成" class="headerlink" title="SQL 语句构成"></a>SQL 语句构成</h3><blockquote>
<p>SQL语句是由简单的英语单词构成的。这些单词称为<strong>关键字</strong>，每个SQL语句都是由一个或多个关键字构成的。</p>
</blockquote>
<p>一条查询语句必须有两点信息  —— <code>想选择什么，以及从什么地方选择</code>。</p>
<h2 id="检索单个列"><a href="#检索单个列" class="headerlink" title="检索单个列"></a>检索单个列</h2><p> <strong>SQL SELECT 语句的使用：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT param1</span><br><span class="line">FROM   tableName;</span><br></pre></td></tr></table></figure>

<p>上述语句利用SELECT语句从 tableName 表中检索一个名为  param1 的列。所需的列名在SELECT关键字之后给出，FROM关键字指出从其中检索数据的表名。 </p>
<p><strong>示例语句输出如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select Tname from teacher;</span><br><span class="line">+----------+</span><br><span class="line">| Tname    |</span><br><span class="line">+----------+</span><br><span class="line">| 姚明     |</span><br><span class="line">| 叶平     |</span><br><span class="line">| 叶开     |</span><br><span class="line">| 孟星魂   |</span><br><span class="line">| 独孤求败 |</span><br><span class="line">| 裘千仞   |</span><br><span class="line">| 裘千尺   |</span><br><span class="line">| 赵志敬   |</span><br><span class="line">| 阿紫     |</span><br><span class="line">| 郭芙蓉   |</span><br><span class="line">| 佟湘玉   |</span><br><span class="line">| 白展堂   |</span><br><span class="line">| 吕轻侯   |</span><br><span class="line">| 李大嘴   |</span><br><span class="line">| 花无缺   |</span><br><span class="line">| 金不换   |</span><br><span class="line">| 乔丹     |</span><br><span class="line">+----------+</span><br><span class="line">17 rows in set</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> </p>
<ul>
<li>如果没有明确排序查询结果（下一章介绍），则返回的数据的顺序没有特殊意义。</li>
<li>返回数据的顺序可能是数据被添加到表中的顺序，也可能不是。</li>
<li>SQL语句不区分大小写 </li>
</ul>
<blockquote>
<p><strong>结束SQL语句</strong> : 多条SQL语句必须以分号（；）分隔。</p>
</blockquote>
<h2 id="检索多个列"><a href="#检索多个列" class="headerlink" title="检索多个列"></a>检索多个列</h2><p>​    要想从一个表中检索多个列，使用相同的SELECT语句。唯一的不同是必须在SELECT关键字后给出多个列名，列名之间必须以逗号分隔。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT param1,param2,param3....</span><br><span class="line">FROM   tableName;</span><br></pre></td></tr></table></figure>

<p>在选择多个列时，一定要在列名之间加上逗号，但最后一个列名后不加。</p>
<p><strong>示例如下：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select name,email,birth,photo</span><br><span class="line"> from customer;</span><br><span class="line">+-------+----------+------------+-------+</span><br><span class="line">| name  | email    | birth      | photo |</span><br><span class="line">+-------+----------+------------+-------+</span><br><span class="line">| 10002 | 22       | 2019-01-27 | NULL  |</span><br><span class="line">| 10001 | 21       | 2019-01-27 | NULL  |</span><br><span class="line">| 文星  | 文敏     | 2019-01-31 | NULL  |</span><br><span class="line">| 强哥  | dfds@sdf | 2019-01-31 | NULL  |</span><br><span class="line">| 文少  | 文敏     | 2019-01-31 | NULL  |</span><br><span class="line">+-------+----------+------------+-------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<p>与前一个例子一样，上述语句使用SELECT语句从表 customer 中选择数据。在这个例子中，指定了3个列名，列名之间用逗号分隔。</p>
<h2 id="检索所有列"><a href="#检索所有列" class="headerlink" title="检索所有列"></a>检索所有列</h2><p>​    除了指定所需的列外（如上所述，一个或多个列），SELECT语句还可以检索所有的列而不必逐个列出它们。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM   tableName;</span><br></pre></td></tr></table></figure>

<p>如果给定一个通配符（*），则返回表中所有列。</p>
<p><strong>示例如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from customer;</span><br><span class="line">+----+-------+----------+------------+-------+</span><br><span class="line">| id | name  | email    | birth      | photo |</span><br><span class="line">+----+-------+----------+------------+-------+</span><br><span class="line">|  1 | 10002 | 22       | 2019-01-27 | NULL  |</span><br><span class="line">|  2 | 10001 | 21       | 2019-01-27 | NULL  |</span><br><span class="line">|  4 | 文星  | 文敏     | 2019-01-31 | NULL  |</span><br><span class="line">|  5 | 强哥  | dfds@sdf | 2019-01-31 | NULL  |</span><br><span class="line">|  6 | 文少  | 文敏     | 2019-01-31 | NULL  |</span><br><span class="line">+----+-------+----------+------------+-------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<blockquote>
<p>虽然使用通配符可能会使你自己省事，不用明确列出所需列，但检索不需要的列通常会降低检索和应用程序的性能。</p>
</blockquote>
<h2 id="检索不同的行"><a href="#检索不同的行" class="headerlink" title="检索不同的行"></a>检索不同的行</h2><p><strong>需求：</strong> 某些情况下，不希望将所有的结果都查询出来，只针对某个列结果不同的行进行返回。</p>
<p><strong>解决方法：</strong> 使用 <code>DISTINCT</code> 关键字</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT DISTINCT param </span><br><span class="line">FROM   tableName;</span><br></pre></td></tr></table></figure>

<p><strong>示例如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select DISTINCT birth from customer;</span><br><span class="line">+------------+</span><br><span class="line">| birth      |</span><br><span class="line">+------------+</span><br><span class="line">| 2019-01-27 |</span><br><span class="line">| 2019-01-31 |</span><br><span class="line">+------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>

<p><code>SELECT DISTINCT birth</code> 告诉MySQL只返回不同（唯一）的 <code>birth</code> 行，因此只返回2行，如下面的输出所示。如果使用<code>DISTINCT</code>关键字，它必须直接放在列名的前面</p>
<p><strong>注意：</strong> </p>
<blockquote>
<p>DISTINCT关键字应用于所有列而不仅是前置它的列。</p>
</blockquote>
<h2 id="限制结果"><a href="#限制结果" class="headerlink" title="限制结果"></a>限制结果</h2><p>SELECT语句返回所有匹配的行，它们可能是指定表中的每个行。为了返回第一行或前几行，可使用LIMIT子句。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT param </span><br><span class="line">FROM   tableName</span><br><span class="line">limit  row,number;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此语句使用SELECT语句检索单个列。实际项目中不限于单个列的应用。</p>
</blockquote>
<p><strong>示例如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select name from customer limit 3,2 ;</span><br><span class="line">+------+</span><br><span class="line">| name |</span><br><span class="line">+------+</span><br><span class="line">| 强哥 |</span><br><span class="line">| 文少 |</span><br><span class="line">+------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>

<p><strong>分析：</strong> LIMIT 3, 2指示MySQL返回从行3开始的2行。第一个数为开始位置，第二个数为要检索的行数。</p>
<h2 id="使用完全限定的表名"><a href="#使用完全限定的表名" class="headerlink" title="使用完全限定的表名"></a>使用完全限定的表名</h2><p>SQL不只是能通过列名引用列。也可能会使用完全限定的名字来引用列（同时使用表名和列字）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT tableName.param </span><br><span class="line">FROM   tableName;</span><br></pre></td></tr></table></figure>

<p><strong>示例如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select customer.name from customer;</span><br><span class="line">+-------+</span><br><span class="line">| name  |</span><br><span class="line">+-------+</span><br><span class="line">| 10002 |</span><br><span class="line">| 10001 |</span><br><span class="line">| 文星  |</span><br><span class="line">| 强哥  |</span><br><span class="line">| 文少  |</span><br><span class="line">+-------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<p>这条SQL语句在功能上等于本节中最开始使用的那一条语句，但这里指定了一个完全限定的列名</p>
<p><strong>注意：</strong></p>
<blockquote>
<p>全限定名的作用在单表查询中并不明显，但在多表联合查询中，当多个表存在相同的列时，可以通过全限定名区分每个表的同名的列。</p>
</blockquote>
<h2 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h2><p>本节主要讲述的内容如下：</p>
<ul>
<li>如何使用SQL的SELECT语句来检索单个表列、多个表列 以及所有表列</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>MySQL必知必会</category>
      </categories>
      <tags>
        <tag>检索列</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot功能（二）定制 starter 启动器</title>
    <url>/2020/03/08/SpringBoot%E5%8A%9F%E8%83%BD%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AE%9A%E5%88%B6%20starter%20%E5%90%AF%E5%8A%A8%E5%99%A8/</url>
    <content><![CDATA[<p>在实际项目开发中，我们常常会用到各种各样的 starter，这些starter 有的是有 springboot官方提供并已经整合一些基本功能的，如：<strong>spring-boot-starter，</strong>也有一些是由 第三方将框架与<strong>springboot</strong>进行定制整合后提供给我们进行快捷高效开发的，如：<strong>MyBatis-Spring-Boot-Starter。</strong></p>
<p>在日常开发中，由于项目的要求以及高效开发、部署等，我们可以对springboot进行私有定制，生成自己需要的启动器，再引入到实际项目中，提高开发的效率。</p>
<p>举例： 我们在<strong>springboot</strong> 中使用 <strong>redis</strong> 的 <strong>java</strong>控件<strong>jedis</strong> 时，需要 进行创建  <strong>Jedis</strong> 的实例并传入相应参数如  <strong>ip</strong> 、<strong>port</strong> 等，在使用<strong>springboot</strong>后，可以进行定制化<strong>starter</strong>，将<strong>Jedis</strong> 用<strong>ip</strong>、<strong>port</strong> 进行实例化，并将 <strong>Bean</strong> 注入容器由 <strong>SpringBoot</strong> 进行管理，制成启动器。</p>
<p>在需要使用到 <strong>redis</strong> 功能的工程项目中引入该启动器，这样就能够提高开发的效率。</p>
<p>正规的<strong>starter</strong>是一个独立的工程，然后在<strong>maven</strong>中新仓库注册发布，其他开发人员就可以使用你的<strong>starter</strong>了。</p>
<p>以下实现一个针对 <strong>redis</strong> 的 定制器 <strong>starter</strong>。 </p>
<h3 id="一、新建一个maven项目spring-boot-starter-redis-（启动器）"><a href="#一、新建一个maven项目spring-boot-starter-redis-（启动器）" class="headerlink" title="一、新建一个maven项目spring-boot-starter-redis （启动器）"></a>一、新建一个maven项目spring-boot-starter-redis （启动器）</h3><p>引入如下依赖： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!--自动配置依赖--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="二、在此项目中编写-RedisProperties-class-，用以从-application-properties-中读取-redis-的配置信息"><a href="#二、在此项目中编写-RedisProperties-class-，用以从-application-properties-中读取-redis-的配置信息" class="headerlink" title="二、在此项目中编写 RedisProperties.class ，用以从 application.properties 中读取 redis 的配置信息"></a>二、在此项目中编写 RedisProperties.class ，用以从 application.properties 中读取 redis 的配置信息</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.properties;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> JedisProperties</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/2/2 18:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"jedis"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三、在此项目中编写RedisAutoConfiguration-class，用以将-Jedis-的bean-装载进-spring-容器中"><a href="#三、在此项目中编写RedisAutoConfiguration-class，用以将-Jedis-的bean-装载进-spring-容器中" class="headerlink" title="三、在此项目中编写RedisAutoConfiguration.class，用以将 Jedis 的bean 装载进 spring 容器中"></a>三、在此项目中编写RedisAutoConfiguration.class，用以将 Jedis 的bean 装载进 spring 容器中</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.autoConfigure;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.demo.properties.RedisProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> JedisAutoConfigure</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/2/2 18:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Jedis<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(</span>&#123;RedisProperties<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(</span>&#123;RedisProperties<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Jedis <span class="title">Jedis</span><span class="params">(RedisProperties redisProperties)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//spring会自动将RedisProperties这个bean注入进来，</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Jedis(redisProperties.getHost(),redisProperties.getPort(),<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为大家解释一下这些注解的含义</p>
<table>
<thead>
<tr>
<th>@SpringBootConfiguration：</th>
<th>代表这是一个配置类</th>
</tr>
</thead>
<tbody><tr>
<td>@EnableConfigurationProperties (RedisProperties.class)：</td>
<td>将RedisProperties加载到spring容器中。参考Spring-Boot之@Enable*注解的工作原理</td>
</tr>
<tr>
<td>@ConditionalOnClass(Jedis.class)：</td>
<td>当项目引用了Jedis的jar时，才加载此配置类。参考Spring-Boot autoconfigure之Condition</td>
</tr>
</tbody></table>
<h3 id="四、在此项目中resource目录下新建-application-properties-文件"><a href="#四、在此项目中resource目录下新建-application-properties-文件" class="headerlink" title="四、在此项目中resource目录下新建 application.properties 文件"></a>四、在此项目中resource目录下新建 application.properties 文件</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">redis.host=127.0.0.1</span><br><span class="line">redis.port=6379</span><br></pre></td></tr></table></figure>

<h3 id="五、Bean-注入方式："><a href="#五、Bean-注入方式：" class="headerlink" title="五、Bean 注入方式："></a>五、Bean 注入方式：</h3><h4 id="第一种：自动注入，创建-依赖配置-spring-factories"><a href="#第一种：自动注入，创建-依赖配置-spring-factories" class="headerlink" title="第一种：自动注入，创建 依赖配置 spring.factories"></a>第一种：自动注入，创建 依赖配置 spring.factories</h4><p>在resource 目录下新建 META-INF 目录，并在该目录下创建 spring.factories 文件，在文件添加以下数据：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration =com.example.demo.autoConfigure.RedisAutoConfiguration</span><br></pre></td></tr></table></figure>

<p>当前数据用于将加载生成的Bean 交给当前启动器所在的容器进行管理，并在被引入到具体的工程项目时被项目中的容器所扫描到而调用。 </p>
<h4 id="第二种：手动注入，创建EnableRedis类"><a href="#第二种：手动注入，创建EnableRedis类" class="headerlink" title="第二种：手动注入，创建EnableRedis类"></a>第二种：手动注入，创建<strong>EnableRedis</strong>类</h4><p>根据<strong>@Import</strong>注解 的作用进行切面配置，手动添加到 工程项目启动类 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(RedisAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableRedis</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用方式：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableRedis</span><span class="comment">//关键的一步</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlogApplication</span> </span>&#123;</span><br><span class="line">......    </span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="六、新建Blog-工程项目，引入-spring-boot-starter-redis-依赖"><a href="#六、新建Blog-工程项目，引入-spring-boot-starter-redis-依赖" class="headerlink" title="六、新建Blog 工程项目，引入 spring-boot-starter-redis 依赖"></a>六、新建Blog 工程项目，引入 spring-boot-starter-redis 依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="七、在Blog项目中，编写启动类BlogApplication"><a href="#七、在Blog项目中，编写启动类BlogApplication" class="headerlink" title="七、在Blog项目中，编写启动类BlogApplication"></a>七、在Blog项目中，编写启动类BlogApplication</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> BlogApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/2/2 23:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlogApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(BlogApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        Jedis jedis = context.getBean(Jedis<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(jedis);</span><br><span class="line">        <span class="comment">//如果成功连接上了redis，jedis.ping()会返回一个pong</span></span><br><span class="line">        System.out.println(jedis.ping());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="八、启动redis"><a href="#八、启动redis" class="headerlink" title="八、启动redis"></a>八、启动redis</h3><p><strong>启动虚拟机或云服务器的redis</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@wsp &#x2F;]# redis-server &#x2F;etc&#x2F;redis.conf </span><br><span class="line">[root@wsp &#x2F;]# redis-cli</span><br></pre></td></tr></table></figure>

<p>先启动 <strong>Spring-boot-starter-redis</strong> 启动器 ，再启动具体的项目工程 <strong>spring-boot-starter-apps</strong> </p>
<img src="http://photo.wushaopei.com/qiniu60.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/springboot-starter" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot功能篇</category>
      </categories>
  </entry>
  <entry>
    <title>POI系列：java读、写、追加CSV </title>
    <url>/2020/04/17/POI%E7%B3%BB%E5%88%97%EF%BC%9Ajava%E8%AF%BB%E3%80%81%E5%86%99%E3%80%81%E8%BF%BD%E5%8A%A0CSV/</url>
    <content><![CDATA[<p><strong>csv文件其实就是格式化的txt文件，所以操作和txt文件差不多，直接上代码了：</strong> </p>
<p><strong>相关jar包代码</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      </span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ostermiller<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>utils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.07.00<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Csv文件写操作类代码  <a href="javascript:void()"><img src="https://www.iteye.com/images/icon_star.png" alt="收藏代码"></a> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.config;</span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Date;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.time.DateFormatUtils;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.CSVPrint;  </span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.CSVPrinter;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvFilePrinter</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> CSVPrint csvPrint;  </span><br><span class="line">	  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * csv文件写入    </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件路径  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> append 是否支持追加  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvFilePrinter</span><span class="params">(String fileName,<span class="keyword">boolean</span> append)</span> <span class="keyword">throws</span> IOException </span>&#123;   </span><br><span class="line">    	File file = <span class="keyword">new</span> File(fileName);  </span><br><span class="line">        <span class="keyword">if</span>(!file.exists())&#123;  </span><br><span class="line">            csvPrint = <span class="keyword">new</span> CSVPrinter(<span class="keyword">new</span> FileWriter(fileName,append));  </span><br><span class="line">            init();  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            csvPrint = <span class="keyword">new</span> CSVPrinter(<span class="keyword">new</span> FileWriter(fileName,append));  </span><br><span class="line">            <span class="keyword">if</span>(!append)&#123;  </span><br><span class="line">                init();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">           </span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 表头</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;  </span><br><span class="line">        write(<span class="keyword">new</span> String[]&#123;<span class="string">"id"</span>,<span class="string">"mac"</span>,<span class="string">"val"</span>,<span class="string">"date"</span>&#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String[] values)</span> <span class="keyword">throws</span> IOException </span>&#123;    </span><br><span class="line">        csvPrint.writeln(values);  </span><br><span class="line">    &#125;     </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;     </span><br><span class="line"><span class="comment">//	 	String csvFile = "J:\\eclipse_1\\ToolsSourceCode\\ToolsSourceCode\\felixlaunch\\LinkSignal\\2020041160741.csv";  </span></span><br><span class="line">	 	</span><br><span class="line">	 	<span class="comment">// 使用绝对路径获取工程目录路径</span></span><br><span class="line">	    String csvFile = System.getProperty(<span class="string">"user.dir"</span>)+File.separator+<span class="string">"src\\main\\resources"</span>+File.separator + <span class="string">"diagrams\\202100411160741.csv"</span>;</span><br><span class="line">        CsvFilePrinter print;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			print = <span class="keyword">new</span> CsvFilePrinter(<span class="string">"demo.csv"</span>,<span class="keyword">true</span>);</span><br><span class="line">		    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;  </span><br><span class="line">	            print.write(<span class="keyword">new</span> String[]&#123;<span class="string">"L03"</span>,<span class="string">"1.91E+14"</span>,<span class="string">"L02_1ToL03_1"</span>,<span class="string">"L02_1"</span>, <span class="string">"L03_1"</span>,<span class="string">"1E+28"</span>&#125;);  </span><br><span class="line">	        &#125; </span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">      </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Csv文件解析类代码</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.config;</span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.CSVPrint;</span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.CSVPrinter;</span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.ExcelCSVParser;  </span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.LabeledCSVParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.time.DateFormatUtils;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.CSVPrint;  </span><br><span class="line"><span class="keyword">import</span> com.Ostermiller.util.CSVPrinter;  </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> CsvFileParser.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月16日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * csv文件解析器  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvFileParser</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> LabeledCSVParser csvParser;<span class="comment">//csv解析器，对于第一行的表头信息，自动加载为索引关键字     </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currLineNum = -<span class="number">1</span>;<span class="comment">//文件所读到行数     </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String[] currLine = <span class="keyword">null</span>;<span class="comment">//用来存放当前行的数据    </span></span><br><span class="line">       </span><br><span class="line">    <span class="keyword">private</span> CSVPrint csvPrint;  </span><br><span class="line">	  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     *   </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件路径  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> append 是否支持追加  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CsvFilePrinter</span><span class="params">(String fileName,<span class="keyword">boolean</span> append)</span> <span class="keyword">throws</span> IOException </span>&#123;   </span><br><span class="line">        File file = <span class="keyword">new</span> File(fileName);  </span><br><span class="line">             </span><br><span class="line">        <span class="keyword">if</span>(!file.exists())&#123;  </span><br><span class="line">            csvPrint = <span class="keyword">new</span> CSVPrinter(<span class="keyword">new</span> FileWriter(fileName,append));   </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            csvPrint = <span class="keyword">new</span> CSVPrinter(<span class="keyword">new</span> FileWriter(fileName,append));  </span><br><span class="line">        &#125;  </span><br><span class="line">           </span><br><span class="line">    &#125;  </span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String[] values)</span> <span class="keyword">throws</span> IOException </span>&#123;    </span><br><span class="line">        csvPrint.writeln(values);  </span><br><span class="line">    &#125;     </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*   </span></span><br><span class="line"><span class="comment">     *  构造函数，   </span></span><br><span class="line"><span class="comment">     *  Param: in InputStream 要解析的信息流   </span></span><br><span class="line"><span class="comment">     *  throws IOException   </span></span><br><span class="line"><span class="comment">     */</span>      </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvFileParser</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;    </span><br><span class="line">            csvParser = <span class="keyword">new</span> LabeledCSVParser(<span class="keyword">new</span> ExcelCSVParser(in));    </span><br><span class="line">            currLineNum = csvParser.getLastLineNumber();    </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvFileParser</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;   </span><br><span class="line">        InputStream in = <span class="keyword">new</span> FileInputStream(fileName);  </span><br><span class="line">        csvParser = <span class="keyword">new</span> LabeledCSVParser(<span class="keyword">new</span> ExcelCSVParser(in));    </span><br><span class="line">        currLineNum = csvParser.getLastLineNumber();   </span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/*   </span></span><br><span class="line"><span class="comment">     * 检查是否还有数据   </span></span><br><span class="line"><span class="comment">     *   </span></span><br><span class="line"><span class="comment">     * return ture 还有一行数据，false 没有数据   </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMore</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;    </span><br><span class="line">    	</span><br><span class="line">        currLine = csvParser.getLine();    </span><br><span class="line">        currLineNum = csvParser.getLastLineNumber()-<span class="number">1</span>;    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == currLine)    </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;    </span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*   </span></span><br><span class="line"><span class="comment">     * 获取全部数据</span></span><br><span class="line"><span class="comment">     *   </span></span><br><span class="line"><span class="comment">     * return ture 还有一行数据，false 没有数据   </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="keyword">public</span> String[][] getAllValue() <span class="keyword">throws</span> IOException &#123;    </span><br><span class="line">    	</span><br><span class="line">    	String [][] csvStr = csvParser.getAllValues();</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> csvStr;    </span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*   </span></span><br><span class="line"><span class="comment">     * 返回当前行数据，关键字所指向的数据   </span></span><br><span class="line"><span class="comment">     * param:String filedName 该行的表头   </span></span><br><span class="line"><span class="comment">     * return:String 返回当前行数据，关键字所指向的数据   </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getByFieldName</span><span class="params">(String fieldName)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">return</span> csvParser.getValueByLabel(fieldName);    </span><br><span class="line">    &#125;     </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*   </span></span><br><span class="line"><span class="comment">     * 关闭解析器   </span></span><br><span class="line"><span class="comment">     *   </span></span><br><span class="line"><span class="comment">     *    </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;    </span><br><span class="line">        csvParser.close();     </span><br><span class="line">    &#125;     </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*   </span></span><br><span class="line"><span class="comment">     * 读取当前行数据   </span></span><br><span class="line"><span class="comment">     *   </span></span><br><span class="line"><span class="comment">     *  return String[] 读取当前行数据   </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="keyword">public</span> String[] readLine() <span class="keyword">throws</span> IOException &#123;    </span><br><span class="line"><span class="comment">//        currLine = csvParser.getLine();     </span></span><br><span class="line">        currLineNum = csvParser.getLastLineNumber()-<span class="number">1</span>;     </span><br><span class="line">        <span class="keyword">return</span> currLine;    </span><br><span class="line">    &#125;     </span><br><span class="line">    </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCurrLineNum</span><span class="params">()</span></span>&#123;     </span><br><span class="line">         <span class="keyword">return</span> currLineNum;     </span><br><span class="line">   &#125;      </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;     </span><br><span class="line">    </span><br><span class="line">	    String csvFile = System.getProperty(<span class="string">"user.dir"</span>)+File.separator+<span class="string">"src\\main\\resources"</span>+File.separator + <span class="string">"diagrams\\2020041160741.csv"</span>;</span><br><span class="line"></span><br><span class="line">    	</span><br><span class="line">       <span class="comment">//创建解析信息流    </span></span><br><span class="line">       InputStream in=<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"demo.csv"</span>));     </span><br><span class="line">    </span><br><span class="line">       <span class="comment">//实例解析器CsvFileParser     </span></span><br><span class="line">       CsvFileParser parser=<span class="keyword">new</span> CsvFileParser(in);     </span><br><span class="line">        </span><br><span class="line">       <span class="comment">//读取数据    </span></span><br><span class="line">       <span class="keyword">while</span>(parser.hasMore())&#123;</span><br><span class="line">        	</span><br><span class="line">       </span><br><span class="line">        	String [] str =   parser.readLine();</span><br><span class="line">        	Arrays.asList(str).forEach(curr -&gt; System.out.print(curr + <span class="string">" "</span>));</span><br><span class="line"><span class="comment">//            System.out.print(parser.getByFieldName("time")+" ");//time 系表头数据    </span></span><br><span class="line"><span class="comment">//            System.out.print(parser.getByFieldName("total")+" ");    </span></span><br><span class="line"></span><br><span class="line">           System.out.println();</span><br><span class="line"></span><br><span class="line">        &#125;     </span><br><span class="line">         parser.close();    </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot基础（三）包扫描与启动过程</title>
    <url>/2020/03/06/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%B8%89%EF%BC%89%E5%8C%85%E6%89%AB%E6%8F%8F%E4%B8%8E%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="一-SpringBoot-的版本与启动过程"><a href="#一-SpringBoot-的版本与启动过程" class="headerlink" title="一. SpringBoot 的版本与启动过程"></a>一. SpringBoot 的版本与启动过程</h3><h5 id="1-SpringBoot都是jar工程"><a href="#1-SpringBoot都是jar工程" class="headerlink" title="1.SpringBoot都是jar工程"></a>1.SpringBoot都是jar工程</h5><img src="http://photo.wushaopei.com/qiniu13.png" width="80%">

<h5 id="2-SpringBoot-版本问题"><a href="#2-SpringBoot-版本问题" class="headerlink" title="2.SpringBoot 版本问题"></a>2.SpringBoot 版本问题</h5><blockquote>
<p>大版本1：内置的Spring是大版本4</p>
<p>​      1.5.8</p>
<p>​      1.5.12</p>
<p>大版本2：内置的Spring是大版本5</p>
</blockquote>
<h5 id="3-SpringBoot启动过程观察"><a href="#3-SpringBoot启动过程观察" class="headerlink" title="3.SpringBoot启动过程观察"></a>3.SpringBoot启动过程观察</h5><h5 id=""><a href="#" class="headerlink" title=""></a><img src="http://photo.wushaopei.com/qiniu14.png" alt=""></h5><p><strong>① 核心机制：</strong></p>
<img src="http://photo.wushaopei.com/qiniu15.png" width="80%">

<p><strong>② 重要注解</strong></p>
<table>
<thead>
<tr>
<th>注解名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>@SpringBootApplication</td>
<td>声明一个SpringBoot程序，并使@SpringBootConfiguration@EnableAutoConfiguration@ComponentScan等注解生效</td>
</tr>
<tr>
<td>@SpringBootConfiguration</td>
<td>相当于@Configuration注解的重新定义</td>
</tr>
<tr>
<td>@Configuration</td>
<td>声明一个Spring配置类</td>
</tr>
<tr>
<td>@Bean</td>
<td>在@Configuration注解标记的类中将标记了@Bean的方法返回值对象加入IOC容器，可以对应XML配置文件中的bean标签来理解</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>启用自动配置</td>
</tr>
<tr>
<td>@AutoConfigurationPackage</td>
<td>当前包下包含需要自动扫描的类</td>
</tr>
<tr>
<td>@ComponentScan</td>
<td>指定要扫描的包</td>
</tr>
</tbody></table>
<h3 id="二-扫描包的问题"><a href="#二-扫描包的问题" class="headerlink" title="二. 扫描包的问题"></a>二. 扫描包的问题</h3><h5 id="1-自动扫描"><a href="#1-自动扫描" class="headerlink" title="1.自动扫描"></a>1.<strong>自动扫描</strong></h5><pre><code>需要被扫描的类（@Controller、@Service）所在的包是主启动类所在包的子类。 </code></pre><img src="http://photo.wushaopei.com/qiniu16.png" width="80%">

<h5 id="2-手动指定扫描的包"><a href="#2-手动指定扫描的包" class="headerlink" title="2.手动指定扫描的包"></a>2.手动指定扫描的包</h5><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">在主启动类上使用@ComponeneScan（“com.webcode.spring2boot.handler”）注解</span><br></pre></td></tr></table></figure>

<h5 id="3、-Configuration-注解"><a href="#3、-Configuration-注解" class="headerlink" title="3、@Configuration 注解"></a>3、@Configuration 注解</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;bean id="message" class="com.webcode.springboot.entities.Message"/&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Lenovo</span></span><br><span class="line"><span class="comment"> * 当前这个类必须能够被扫描到</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span><span class="comment">//这个方法返回的对象会被加入到IOC容器中</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Message <span class="title">getMessageBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Message();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4、扫描Mapper接口的两种方式"><a href="#4、扫描Mapper接口的两种方式" class="headerlink" title="4、扫描Mapper接口的两种方式"></a>4、扫描Mapper接口的两种方式</h5><ul>
<li>方式一： 使用 @MapperScan </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.webcode.springboot.mappers"</span>)标记在主启动类上</span><br></pre></td></tr></table></figure>

<ul>
<li><p>方式二：使用@Mapper </p>
<p>标记在Mapper接口上 </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpMapper</span></span>&#123;</span><br><span class="line"></span><br><span class="line">     ......................</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5、为Mybatis配置实体类包"><a href="#5、为Mybatis配置实体类包" class="headerlink" title="5、为Mybatis配置实体类包"></a>5、为Mybatis配置实体类包</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath*:/mybatis/mappers/*Mapper.xml</span><br><span class="line">  type-aliases-package: com.atguigu.springboot.entities</span><br></pre></td></tr></table></figure>

<h3 id="三、SpringBoot环境下配置文件"><a href="#三、SpringBoot环境下配置文件" class="headerlink" title="三、SpringBoot环境下配置文件"></a>三、SpringBoot环境下配置文件</h3><h5 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h5><blockquote>
<p>SpringBoot环境下常用的配置文件有两种，一种是properties 属性文件，一种是yml文件。二者各有特点，语法也有很大区别，但是最终效果基本一致。 </p>
</blockquote>
<h5 id="2、Properties-文件使用"><a href="#2、Properties-文件使用" class="headerlink" title="2、Properties 文件使用"></a>2、Properties 文件使用</h5><p><strong>文件名： application.properties</strong></p>
<p>语法格式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxx.xxx.xxx&#x3D;xxx</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">server.port = 8181  //用于指定handler访问的端口号</span><br></pre></td></tr></table></figure>

<h5 id="3、yml文件的使用"><a href="#3、yml文件的使用" class="headerlink" title="3、yml文件的使用"></a>3、yml文件的使用</h5><p>3.1 yml简介 </p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">yml是YAML（YAML Ain't Markup Language）语言的文件，以数据为中心，比json、xml等更适合做配置文件。</span><br></pre></td></tr></table></figure>

<p>3.2 yml 语法</p>
<blockquote>
<ul>
<li>使用缩进表示层级关系</li>
<li>缩进时不允许使用Tab键，只允许使用空格</li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li>
<li>大小写敏感</li>
</ul>
</blockquote>
<p>3.3 YAML 支持的三种数据结构 </p>
<blockquote>
<ul>
<li><strong>对象： 键值对的集合</strong></li>
<li><strong>数值：一组按次序排列的值</strong></li>
<li><strong>字面量：单个的、不可再分的值</strong></li>
</ul>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">apple</span></span><br><span class="line">        <span class="attr">//微服务的名字</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">8181</span></span><br><span class="line">    <span class="meta">context-path</span>: <span class="string">/banana</span></span><br></pre></td></tr></table></figure>

<p>用于指定<strong>handler</strong>访问的路径 </p>
<h3 id="四、主启动类"><a href="#四、主启动类" class="headerlink" title="四、主启动类"></a>四、主启动类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.webcode.springBoot"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootHelloWorld</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		SpringApplication.run(SpringBootHelloWorld<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>application.properties </li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8081   #指定访问的端口</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application.yml </li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span> :<span class="string"></span></span><br><span class="line">    <span class="attr">name</span> : <span class="string">applie</span></span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（一） SpringBoot概述与微服务理念</title>
    <url>/2020/03/05/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%B8%80%EF%BC%89-SpringBoot%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E5%BF%B5/</url>
    <content><![CDATA[<h4 id="1、前言：-分布式架构及微服务理念"><a href="#1、前言：-分布式架构及微服务理念" class="headerlink" title="1、前言： 分布式架构及微服务理念"></a>1、前言： 分布式架构及微服务理念</h4><h5 id="SOA理念-思想）"><a href="#SOA理念-思想）" class="headerlink" title="SOA理念(思想）"></a>SOA理念(思想）</h5><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">SOA :即 Service Oriented Architecture，面向服务架构</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>主张：</strong> </p>
<p>​    把项目中的各个模块从单一架构中拆分出来，封装成一个一个可以远程调用的服务，从而实现分布式架构。</p>
<pre><code>开发具体的每一个服务时，使用一个interface定义这个服务的功能，这就是我们常说的暴露接口。</code></pre><p>​     当我们实现了interface,将接口暴露到了网络上，可以进行远程调用了，就可以说这个服务开发完成了，这就是我们常说的“写接口”。</p>
<hr>
<p><strong>SOA精髓：</strong><code>通过提供服务和对服务的调用实现分布式架构。</code></p>
<hr>
<h5 id="micro-service-微服务理念"><a href="#micro-service-微服务理念" class="headerlink" title="micro service 微服务理念"></a>micro service 微服务理念</h5><img src="https://img-blog.csdnimg.cn/2019042117295770.png" width="80%" >

<img src="https://img-blog.csdnimg.cn/20190421173021813.png" width="80%" >



<img src="https://img-blog.csdnimg.cn/20190421173049381.png" width="80%" >

<blockquote>
<p>这是对微服务理念的一整套具体实现 </p>
</blockquote>
<blockquote>
<p>SpringBoot在微观上开发具体的一个一个微服务。 </p>
</blockquote>
<blockquote>
<p>SpringCloud在宏观上统一管理、协调各个微服务。为微服务提供各个服务的注册中心、网关、配置中心、负载均衡、熔断机制、服务降级、服务监控、服务细节屏蔽等等。 </p>
</blockquote>
<h4 id="2、SpringBoot概述"><a href="#2、SpringBoot概述" class="headerlink" title="2、SpringBoot概述"></a>2、SpringBoot概述</h4><p>​    Spring Boot是由Pivotal团队提供的全新框架，其设计目的是用来简化新Spring应用的初始搭建以及开发过程。该框架使用了特定的方式来进行配置，从而使开发人员不再需要定义样板化的配置。 </p>
<p>① <strong>SpringCloud 和 Dubbo 对比</strong> </p>
<blockquote>
<p> Dubbo:底层RPC 调用</p>
<p>SpringCloud : 底层REST调用（HTTP）</p>
<p>SpringCloud 能够为项目架构直接提供一整套解决方案。</p>
<p>Dubbo只能作为项目架构的核心和基石，完整的项目架构解决方案还需要借助其他技术。</p>
</blockquote>
<h4 id="3、SpringBoot工程的使用"><a href="#3、SpringBoot工程的使用" class="headerlink" title="3、SpringBoot工程的使用"></a>3、SpringBoot工程的使用</h4><ul>
<li>加入需要的场景 starter依赖</li>
<li>配置properties或yml</li>
<li>创建主启动类</li>
<li>通过注解开启相关功能</li>
<li>运行主启动类</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（六）实现热部署</title>
    <url>/2020/03/14/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E5%85%AD%EF%BC%89%E5%AE%9E%E7%8E%B0%E7%83%AD%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h3 id="devtools的原理"><a href="#devtools的原理" class="headerlink" title="devtools的原理"></a>devtools的原理</h3><hr>
<p>​     深层原理是使用了两个ClassLoader，一个Classloader加载那些不会改变的类（第三方Jar包），另一个ClassLoader加载会更改的类，称为restart  ClassLoader,这样在有代码更改的时候，原来的restart ClassLoader 被丢弃，重新创建一个restart  ClassLoader，由于需要加载的类相比较少，所以实现了较快的重启时间。</p>
<h4 id="使用需要添加以下的配置："><a href="#使用需要添加以下的配置：" class="headerlink" title="使用需要添加以下的配置："></a>使用需要添加以下的配置：</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> 必须设置以下内容：</p>
<p>​     <strong>eclipse –&gt; Project –&gt; Build Automatically 要选中，不选中的话不起作用。</strong></p>
<p> <strong>说明：</strong></p>
<p>（1） devtools可以实现页面热部署（即页面修改后会立即生效，这个可以直接在application.properties文件中配置spring.thymeleaf.cache=false来实现），<br> 实现类文件热部署（类文件修改后不会立即生效），实现对属性文件的热部署。<br> 即devtools会监听classpath下的文件变动，并且会立即重启应用（发生在保存时机），注意：因为其采用的虚拟机机制，该项重启是很快的<br> （2）配置了后在修改java文件后也就支持了热启动，不过这种方式是属于项目重启（速度比较快的项目重启），会清空session中的值，也就是如果有用户登陆的话，项目重启后需要重新登陆。</p>
<p> 默认情况下，<code>/META-INF/maven，/META-INF/resources，/resources，/static，/templates，</code></p>
<p><code>/public</code>这些文件夹下的文件修改不会使应用重启，但是会重新加载（devtools内嵌了一个LiveReload  server，当资源发生改变时，浏览器刷新）。</p>
<h4 id="devtools的配置"><a href="#devtools的配置" class="headerlink" title="devtools的配置"></a><strong>devtools的配置</strong></h4><p> 在application.properties中配置spring.devtools.restart.enabled=false，此时restart类加载器还会初始化，但不会监视文件更新。<br> 在SprintApplication.run之前调用System.setProperty(“spring.devtools.restart.enabled”, “false”);可以完全关闭重启支持，配置内容：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#热部署生效</span></span><br><span class="line"><span class="meta">spring.devtools.restart.enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="comment">#设置重启的目录</span></span><br><span class="line"><span class="comment">#spring.devtools.restart.additional-paths: src/main/java</span></span><br><span class="line"><span class="comment">#classpath目录下的WEB-INF文件夹内容修改不重启</span></span><br><span class="line"><span class="meta">spring.devtools.restart.exclude</span>: <span class="string">WEB-INF/**</span></span><br></pre></td></tr></table></figure>

<p> 测试</p>
<ul>
<li>修改类–&gt;保存：应用会重启</li>
<li>修改配置文件–&gt;保存：应用会重启</li>
<li>修改页面–&gt;保存：应用不会重启，但会重新加载，页面会刷新（原理是将spring.thymeleaf.cache设为false，参考:Spring Boot配置模板引擎）</li>
</ul>
<p>转载自： <a href="https://blog.csdn.net/liben0429/article/details/79011775" target="_blank" rel="noopener">https://blog.csdn.net/liben0429/article/details/79011775</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（四）整合 mybatis</title>
    <url>/2020/03/06/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E5%9B%9B%EF%BC%89%E6%95%B4%E5%90%88-mybatis/</url>
    <content><![CDATA[<h4 id="1、增加持久化层"><a href="#1、增加持久化层" class="headerlink" title="1、增加持久化层"></a>1、增加持久化层</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2、实体类及表的创建"><a href="#2、实体类及表的创建" class="headerlink" title="2、实体类及表的创建"></a>2、实体类及表的创建</h3><p>实体类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Emp</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Integer empId;</span><br><span class="line">	<span class="keyword">private</span> String empName;</span><br><span class="line">	<span class="keyword">private</span> Integer empAge;</span><br><span class="line">    …… </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`table_emp`</span> (</span><br><span class="line"><span class="string">`emp_id`</span>  <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT ,</span><br><span class="line"><span class="string">`emp_name`</span>  <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="literal">NULL</span> ,</span><br><span class="line"><span class="string">`emp_age`</span>  <span class="built_in">int</span> <span class="literal">NULL</span> ,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`emp_id`</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="3、Mapper-及配置文件"><a href="#3、Mapper-及配置文件" class="headerlink" title="3、Mapper 及配置文件"></a>3、Mapper 及配置文件</h3><p>*mapper.java </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpMapper</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;Emp&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*mapper.xml </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.webcode.springboot.mappers.EmpMapper"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.springboot.bean.Emp"</span>&gt;</span></span><br><span class="line">		select emp_id empId, emp_name empName, emp_age empAge</span><br><span class="line">		from table_emp</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4、Service-业务接口及实现"><a href="#4、Service-业务接口及实现" class="headerlink" title="4、Service 业务接口及实现"></a>4、Service 业务接口及实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;Emp&gt; <span class="title">getAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmpServiceImpl</span> <span class="keyword">implements</span> <span class="title">EmpService</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> empMapper.selectAll();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、handler-接口调用"><a href="#5、handler-接口调用" class="headerlink" title="5、handler 接口调用"></a>5、handler 接口调用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> EmpService empService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/getAll"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> empService.getAll();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、application-yml-配置"><a href="#6、application-yml-配置" class="headerlink" title="6、application.yml 配置"></a>6、application.yml 配置</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">mydb</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://127.0.0.1:3306/sb_db</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">root</span></span><br><span class="line">    <span class="meta">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">mybatis</span>:<span class="string"></span></span><br><span class="line">  <span class="meta">mapper-locations</span>: <span class="string">classpath*:/mybatis/*Mapper.xml</span></span><br><span class="line"><span class="comment">    # spring boot集成mybatis的方式打印sql </span></span><br><span class="line">  <span class="attr">configuration</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">log-impl</span>: <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"><span class="comment">   # 开启日志</span></span><br><span class="line"><span class="attr">logging</span>: <span class="string"></span></span><br><span class="line">  <span class="attr">level</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">com.eth.wallet.mapper</span>: <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h3 id="7、在主启动类上使用注解扫描Mapper"><a href="#7、在主启动类上使用注解扫描Mapper" class="headerlink" title="7、在主启动类上使用注解扫描Mapper"></a>7、在主启动类上使用注解扫描Mapper</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.webcode.springboot.mappers"</span>)</span><br></pre></td></tr></table></figure>

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/SpringBoot_mybatis" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（二）helloworld</title>
    <url>/2020/03/05/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%BA%8C%EF%BC%89helloworld/</url>
    <content><![CDATA[<p><strong>操作步骤：</strong></p>
<h4 id="第一种创建SpringBoot的方案："><a href="#第一种创建SpringBoot的方案：" class="headerlink" title="第一种创建SpringBoot的方案："></a><strong>第一种创建SpringBoot的方案：</strong></h4><p><strong>1、</strong>创建Maven工程  </p>
<p><img src="http://photo.wushaopei.com/qiniu01.png" alt=""></p>
<p><img src="http://photo.wushaopei.com/qiniu02.png" alt=""></p>
<p><strong>2、</strong>加入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 继承SpringBoot官方指定的父工程 --&gt;</span>	</span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 加入Web开发所需要的场景启动器 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 指定groupId和artifactId即可，版本已在父工程中定义 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>3、</strong>创建主动启动类</p>
<p><img src="http://photo.wushaopei.com/qiniu03.png" alt=""></p>
<p><strong>4、</strong>创建HelloHandler </p>
<p><img src="http://photo.wushaopei.com/qiniu04.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"Hello SpringBoot!"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5、</strong>启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">运行主启动类中的main方法启动SpringBoot程序。</span><br></pre></td></tr></table></figure>

<p><strong>6、</strong>通过网页访问handler方法 </p>
<p><img src="http://photo.wushaopei.com/qiniu05.png" alt=""></p>
<p><strong>扩展：</strong> 关于包扫描的问题 </p>
<blockquote>
<p>SpringBoot中主启动类会自动扫描该类所在包的子包，相当于xml配置文件中的&lt;mvc:context scan=”包扫描路径”/&gt; </p>
</blockquote>
<p><img src="http://photo.wushaopei.com/qiniu06.png" alt=""></p>
<p><strong>注意：</strong> 要进行扫描的包必须处于主启动类的子包中。 </p>
<blockquote>
<ul>
<li><blockquote>
<p>手动扫描包</p>
<p>使用注解进行包</p>
</blockquote>
</li>
</ul>
</blockquote>
<p><img src="http://photo.wushaopei.com/qiniu07.png" alt=""></p>
<p><strong>访问结果：</strong> </p>
<p><img src="http://photo.wushaopei.com/qiniu08.png" alt=""></p>
<h4 id="第二种创建SpringBoot的方案"><a href="#第二种创建SpringBoot的方案" class="headerlink" title="第二种创建SpringBoot的方案"></a>第二种创建SpringBoot的方案</h4><p><strong>1、</strong>通过 Spring 插件创建 SpringBoot工程</p>
<p>限制： 每次创建工程都必须联网：必须借助Spring 插件</p>
<p><img src="http://photo.wushaopei.com/qiniu09.png" alt=""></p>
<p><img src="http://photo.wushaopei.com/qiniu10.png" alt=""></p>
<blockquote>
<p><strong>效果</strong> ：自动生成主启动器和application.properties，以及测试类</p>
</blockquote>
<p><img src="http://photo.wushaopei.com/qiniu12.png" alt=""></p>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/SpringBoot_helloworld" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot基础（五）项目打包</title>
    <url>/2020/03/08/SpringBoot%E5%9F%BA%E7%A1%80%EF%BC%88%E4%BA%94%EF%BC%89%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E3%80%81%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="1、Spring-Boot-项目打包"><a href="#1、Spring-Boot-项目打包" class="headerlink" title="1、Spring Boot 项目打包"></a>1、Spring Boot 项目打包</h3><p><strong>打包方式：</strong> </p>
<blockquote>
<p>构建 JAR 包</p>
<p>构建 WAR 包</p>
<p>指定 Main-Class</p>
</blockquote>
<p><strong>（1）右击工程名  “copy path” 获取工程路径，到 cmd.exe 命令行中进入该目录下，输入</strong> </p>
  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mvn -Dmaven.test.skip -U clean <span class="keyword">package</span></span><br></pre></td></tr></table></figure>

<p>命令执行打包操作，</p>
<p>此时执行过程会发生报错，因为 在进行多模块拆分后，需要重新为工程指定 main.class ，也就是 springboot 的启动器入口的位置的明确。这是由于在拆分过后，在父工程下找不到main.class 。</p>
<p>解决方法：</p>
<p>将父工程的pom.xml 中的 <build></build>依赖驱动剪切到 web 子模块中 ，然后再到修改后的web子模块的 pom.xml 中的   <build></build> 中的<plugin></plugin>添加一个 <configuration/>,并为其配置一个<mainClass/>，将 springboot入口启动器的 Reference 路径复制并放入到 <mainClass>中，然后执行打包就可以了。</p>
<p>注意： 不要把<build/>放在父工程的pom.xml 下进行打包，那样会有很多错误要进行修正，而且由于主启动器迁移到 了web 中，在父工程下 添加<build/>意义不大</p>
<img src="http://photo.wushaopei.com/qiniu61.png" width="60%">

<p><strong>（2）在 cmd 命令行中启动 jar 包 或者 war 包 的方式：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar web-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.jar</span><br><span class="line">或者</span><br><span class="line">java -jar web-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.war</span><br></pre></td></tr></table></figure>

<p>注意： 要在 当前工程打成 war 包，需要在 web 的mian 目录下创建 “webapp” 和  “WEB-INF”两个目录，并在 “WEB-INF” 目录下创建 一个 web.xml 文件 </p>
<img src="http://photo.wushaopei.com/qiniu62.png" width="60%">

<h3 id="2、Spring-Boot-运行模式"><a href="#2、Spring-Boot-运行模式" class="headerlink" title="2、Spring Boot 运行模式"></a>2、Spring Boot 运行模式</h3><p><strong>Springboot</strong>项目的3种运行模式：</p>
<p><strong>idea</strong>方式，<strong>jar</strong>/<strong>war</strong>方式，<strong>maven</strong>插件方式</p>
<blockquote>
<p>（1）如果是在开发过程中，会使用<strong>idea</strong>方式</p>
<p>（2）如果是在线上的服务器上，会使用<strong>jar/war</strong>方式，作为启动脚本</p>
<p>（3）如果开发环境是Linux环境，会使用<strong>maven</strong>插件方式。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot入门</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（二）集成SMTP发送邮件</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%BA%8C%EF%BC%89%E9%9B%86%E6%88%90SMTP%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><blockquote>
<p>可发送邮箱链接进行用户注册认证等</p>
</blockquote>
<h3 id="1、添加SMTP-及-MAIL-的-pom-xml-依赖"><a href="#1、添加SMTP-及-MAIL-的-pom-xml-依赖" class="headerlink" title="1、添加SMTP 及 MAIL 的 pom.xml 依赖"></a>1、添加SMTP 及 MAIL 的 pom.xml 依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">      <span class="comment">&lt;!--郵箱發送--&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>  依赖添加后会要求刷新 springBootConguration 的配置信息，可执行也可不理睬</p>
<p><strong>具体操作如下：</strong></p>
<img src="http://photo.wushaopei.com/qiniu22.png" width="80%">

<h3 id="2、配置yml邮箱参数"><a href="#2、配置yml邮箱参数" class="headerlink" title="2、配置yml邮箱参数"></a>2、配置yml邮箱参数</h3><h4 id="2-1-在-application-dev-yml中配置对应的邮箱参数"><a href="#2-1-在-application-dev-yml中配置对应的邮箱参数" class="headerlink" title="2.1 在 application-dev.yml中配置对应的邮箱参数"></a>2.1 在 application-dev.yml中配置对应的邮箱参数</h4><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#邮件配置</span></span><br><span class="line"><span class="attr">email</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">host</span>: <span class="string">smtp.163.com</span></span><br><span class="line">  <span class="attr">username</span>: <span class="string">1598974689@163.com</span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">1598974689wsp</span></span><br><span class="line">  <span class="attr">senderName</span>: <span class="string">1598974689@163.com</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#发送提醒邮件的接收方</span></span><br><span class="line"><span class="attr">sendToMail</span>: <span class="string">1862030785@foxmail.com</span></span><br><span class="line"><span class="attr">sendToPeopleName</span>: <span class="string">wen</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的-SMTP-设置，"><a href="#2-2-由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的-SMTP-设置，" class="headerlink" title="2.2 由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的 SMTP 设置，"></a>2.2 由于是使用SMTP实现邮箱发送，除了提供必要的邮箱、密码等参数外，还要开启邮箱账号的 SMTP 设置，</h4><img src="http://photo.wushaopei.com/qiniu23.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu24.png" width="80%">

<blockquote>
<p>打勾选中要设置的服务项，通过校验短信息设置授权码，使用授权码代替  邮箱密码 实现邮件的发送，流程很简单的。 </p>
</blockquote>
<h3 id="3、相关工具类和-实体类的创建"><a href="#3、相关工具类和-实体类的创建" class="headerlink" title="3、相关工具类和 实体类的创建"></a>3、相关工具类和 实体类的创建</h3><h4 id="3-1-邮箱-参数-config"><a href="#3-1-邮箱-参数-config" class="headerlink" title="3.1 邮箱 参数 config"></a>3.1 邮箱 参数 config</h4><img src="http://photo.wushaopei.com/qiniu25.png" width="80%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.model.common;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> EmailConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 10:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"email"</span>, ignoreUnknownFields = <span class="keyword">false</span>)</span><br><span class="line"><span class="comment">//@PropertySource("classpath:/application.yml")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String senderName;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSenderName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSenderName</span><span class="params">(String senderName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.senderName = senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"EmailConfig&#123;"</span> +</span><br><span class="line">                <span class="string">"host='"</span> + host + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", senderName='"</span> + senderName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-Email-发送实现工具类"><a href="#3-2-Email-发送实现工具类" class="headerlink" title="3.2  Email 发送实现工具类"></a>3.2  Email 发送实现工具类</h4><img src="http://photo.wushaopei.com/qiniu26.png" width="50%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.utils.Email;</span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.common.EmailConfig;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.JavaMailSenderImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.MimeMessageHelper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.mail.MessagingException;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MailSenderFacade</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 10:22</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSenderFacade</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailConfig emailConfig;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MailSenderFacade<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMailHtml</span><span class="params">(<span class="keyword">final</span> String toEmail,<span class="keyword">final</span> String subject,<span class="keyword">final</span> String text)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            JavaMailSenderImpl javaMailSender = <span class="keyword">new</span> JavaMailSenderImpl();</span><br><span class="line">            javaMailSender.setUsername(emailConfig.getUsername());</span><br><span class="line">            javaMailSender.setPassword(emailConfig.getPassword());</span><br><span class="line">            javaMailSender.setHost(emailConfig.getHost());</span><br><span class="line">            javaMailSender.setPort(<span class="number">25</span>);</span><br><span class="line">            javaMailSender.setProtocol(<span class="string">"smtp"</span>);</span><br><span class="line">            javaMailSender.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">            Properties mailProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.auth"</span>, <span class="keyword">true</span>);</span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.starttls.enable"</span>, <span class="keyword">true</span>);</span><br><span class="line">            javaMailSender.setJavaMailProperties(mailProperties);</span><br><span class="line">            MimeMessage mimeMessage = getMimeMessage(toEmail,subject,text, javaMailSender);</span><br><span class="line">            javaMailSender.send(mimeMessage);</span><br><span class="line">            logger.info(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送异常"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> MimeMessage <span class="title">getMimeMessage</span><span class="params">(String toEmail,String subject,String text, JavaMailSenderImpl javaMailSender)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line">        MimeMessage mimeMessage = javaMailSender.createMimeMessage();</span><br><span class="line">        MimeMessageHelper mimeMessageHelper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage, <span class="keyword">true</span>, <span class="string">"UTF-8"</span>);</span><br><span class="line">        mimeMessageHelper.setFrom(emailConfig.getSenderName());</span><br><span class="line">        mimeMessageHelper.setTo(toEmail);</span><br><span class="line">        mimeMessageHelper.setSubject(subject);</span><br><span class="line">        mimeMessageHelper.setText(text, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> mimeMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、测试SMTP功能发送一个邮件试试"><a href="#4、测试SMTP功能发送一个邮件试试" class="headerlink" title="4、测试SMTP功能发送一个邮件试试"></a>4、测试SMTP功能发送一个邮件试试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/please/emailTest"</span>, method = RequestMethod.GET)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getEmailTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           Map&lt;String,Object&gt; map = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">           mailSenderFacade.sendMailHtml(<span class="string">"18620307785@163.com"</span>, <span class="string">"来自邮箱测试接口邮件"</span>, <span class="string">"来自邮箱测试接口邮件"</span>);</span><br><span class="line">           map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">           map.put(<span class="string">"message"</span>, <span class="string">"导出成功"</span>);</span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           map.put(<span class="string">"state"</span>,<span class="string">"1"</span>);</span><br><span class="line">           map.put(<span class="string">"message"</span>, <span class="string">"导出失敗"</span>);</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> map;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>发送成功：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu27.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu28.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-smtp" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（三）集成Quartz 定时任务</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%B8%89%EF%BC%89%E9%9B%86%E6%88%90Quartz-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><ul>
<li>将首页所展示的数据存入redis中并且每隔一小时更新一次数据。 </li>
<li>自动结账 ，票务系统或结算系统进行定时拉取票务或消费数据</li>
<li>定时加载POI生成 word、 excel 、PDF等，预先提交申请，定时器定时获取请求信息并后台加载到本地</li>
</ul>
<h3 id="1、在-pom-xml-中-添加-Quartz-所需要-的-依赖"><a href="#1、在-pom-xml-中-添加-Quartz-所需要-的-依赖" class="headerlink" title="1、在 pom.xml 中 添加 Quartz 所需要 的 依赖"></a>1、在 pom.xml 中 添加 Quartz 所需要 的 依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">       <span class="comment">&lt;!--定时器 quartz--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> </p>
<p><code>quartz 只能基于 springboot 的 parent 2.0 以上 版本 才能使用过，低于2.0 的版本无法加载到 quartz 的pom依赖包</code></p>
<h3 id="2、创建要执行的任务类："><a href="#2、创建要执行的任务类：" class="headerlink" title="2、创建要执行的任务类："></a>2、创建要执行的任务类：</h3><p> TestTask1  与  TestTask2 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartzHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> TestTask1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 12:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTask1</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        System.out.println(<span class="string">"TestQuartz01----"</span> + sdf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartzHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> TestTask2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 12:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTask2</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        System.out.println(<span class="string">"TestQuartz02----"</span> + sdf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、定时器（执行类）："><a href="#3、定时器（执行类）：" class="headerlink" title="3、定时器（执行类）："></a>3、定时器（执行类）：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartzHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> QuartzConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 12:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(QuartzConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//    testTask1使用的固定间隔方式，testTask2使用的是cron表达式方式。</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">testQuartz1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        return JobBuilder.newJob(TestTask1.class).withIdentity("testTask1").storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">testQuartzTrigger1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//5秒执行一次</span></span><br><span class="line">        SimpleScheduleBuilder scheduleBuilder = SimpleScheduleBuilder.simpleSchedule()</span><br><span class="line">                .withIntervalInSeconds(<span class="number">5</span>)</span><br><span class="line">                .repeatForever();</span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(testQuartz1())</span><br><span class="line">                .withIdentity(<span class="string">"testTask1"</span>)</span><br><span class="line">                .withSchedule(scheduleBuilder)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">testQuartz2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        return JobBuilder.newJob(TestTask2.class).withIdentity("testTask2").storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">testQuartzTrigger2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//cron方式，每隔5秒执行一次</span></span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(testQuartz2())</span><br><span class="line">                .withIdentity(<span class="string">"testTask2"</span>)</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">"*/5 * * * * ?"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu43.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-quartz" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>bootstrap 入门（一）简介</title>
    <url>/2020/04/13/bootstrap-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>​    利用 BootstrapCDN 和一个最简模板快速上手 Bootstrap。Bootstrap 是全球最流行的前端框架，用于构建响应式、移动设备优先的 WEB 站点。 </p>
<p>​    简单灵活的用于搭建WEB页面的HTML、CSS、JavaScript的工具集，基于HTML5和CSS3。是一款简洁强大的开发框架，让WEB开发更迅速更简单更简洁 </p>
<h3 id="如何开始使用-Bootstrap"><a href="#如何开始使用-Bootstrap" class="headerlink" title="如何开始使用 Bootstrap"></a>如何开始使用 Bootstrap</h3><img src="http://photo.wushaopei.com/qiniu307.png" width="90%">

<p><strong>此处针对 bootstrap 的3.0 以上版本(包括3.0)</strong></p>
<h3 id="下载-Bootstrap-框架"><a href="#下载-Bootstrap-框架" class="headerlink" title="下载 Bootstrap 框架"></a>下载 Bootstrap 框架</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;v4.bootcss.com&#x2F;docs&#x2F;getting-started&#x2F;download&#x2F;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu347.png" width="90%">

<h3 id="Bootstrap-版本差异"><a href="#Bootstrap-版本差异" class="headerlink" title="Bootstrap 版本差异"></a>Bootstrap 版本差异</h3><p><strong>注意：</strong> </p>
<blockquote>
<p>bootstrap必须基于jquary，所以要在引用bootstrap框架之前引入jquary </p>
</blockquote>
<p>BootStrap不支持IE8以下的兼容模式，这条代码是为了让IE中运行最新的渲染模式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>初始化移动浏览器显示 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使低版本浏览器 支持H5标签 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使低版本浏览器对媒体查询进行支持 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://oss.maxcdn.com/respond/1.4.2/respond.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>视口的宽度等于物理设备上真实的分辨率，初始的缩放比例为1（不做缩放） </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1"</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- 这句话的意思打开浏览器时，浏览器的宽度等于屏幕的分辨率  刚开始为1 是说屏幕不缩放 </span></span><br><span class="line"><span class="comment">		width=device-width 宽度等于设备的宽度</span></span><br><span class="line"><span class="comment">		initial-scale=1  初始不缩放</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="最基本的模板"><a href="#最基本的模板" class="headerlink" title="最基本的模板"></a>最基本的模板</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Required meta tags --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap CSS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"</span> <span class="attr">integrity</span>=<span class="string">"sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Optional JavaScript --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- jQuery first, then Popper.js, then Bootstrap JS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.slim.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="编程练习"><a href="#编程练习" class="headerlink" title="编程练习"></a>编程练习</h3><p>基于Bootstrap实现下图所示效果的页面，一个居中的标题和一个大按钮：</p>
<p><strong>效果图:</strong></p>
<img src="http://photo.wushaopei.com/qiniu347.png" width="90%">

<p><strong>库引用地址:</strong></p>
<p>   <strong>bootstrap框架:</strong> //netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css</p>
<p>   <strong>jquery库:</strong> <a href="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js" target="_blank" rel="noopener">http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js</a></p>
<p>   <strong>bootstrap.min.js：</strong><a href="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js" target="_blank" rel="noopener">http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js</a></p>
<h4 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h4><ol>
<li>搭建基础的bootstrap页面</li>
<li>居中的标题和按钮</li>
</ol>
<p><strong>注意居中：</strong>通过文本对齐类，可以简单方便的将文字重新对齐，如class=”text-center”</p>
<h4 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-cn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> &gt;</span>我是按钮，按我一下<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="文档中组件的引用"><a href="#文档中组件的引用" class="headerlink" title="文档中组件的引用"></a>文档中组件的引用</h4><img src="http://photo.wushaopei.com/qiniu349.png" width="90%">



<h3 id="Bootstrap中的-CSS"><a href="#Bootstrap中的-CSS" class="headerlink" title="Bootstrap中的 CSS"></a>Bootstrap中的 CSS</h3><p>​    Bootstrap是移动设备优先的，它针对移动设备的样式融合进了框架的每个角落，使得只需要通过简单的编码，便可以实现漂亮的响应式布局。 </p>
<img src="http://photo.wushaopei.com/qiniu350.png" width="70%">



<h4 id="初始化框架使用的是Normalize-css"><a href="#初始化框架使用的是Normalize-css" class="headerlink" title="初始化框架使用的是Normalize.css"></a>初始化框架使用的是Normalize.css</h4><h4 id="栅格结构-grid-system"><a href="#栅格结构-grid-system" class="headerlink" title="栅格结构(grid system)"></a>栅格结构(grid system)</h4><p>​    栅格布局中所有的行必须放在class为container的容器中. </p>
<p>​    通过一系列的行（row）与列（column）的组合来创建页面布局, 自动分为最多12列,内容在列中.  栅格的class在屏幕宽度大于或等于阈值的设备上起作用，并针对小屏幕设备所设置的class覆盖掉         </p>
<h4 id="栅格系统的用法："><a href="#栅格系统的用法：" class="headerlink" title="栅格系统的用法："></a>栅格系统的用法：</h4><p>​    首先，它的行必须要包含在container容器中。内容放在列中，而且只有列能成为行的直接子元素。</p>
<p>​     通过设置padding 造成列之间的间隔</p>
<pre><code>栅格的宽度在大于或等于预置的宽度上起作用，并且针对小屏幕设置的class给覆盖掉</code></pre><img src="http://photo.wushaopei.com/qiniu394.png" width="70%">



<h3 id="Bootstrap中的组件"><a href="#Bootstrap中的组件" class="headerlink" title="Bootstrap中的组件"></a>Bootstrap中的组件</h3><p>​    Bootstrap包含很多可复用的组件，包括图标，下拉菜单，导航，警告框，弹出框等更多功能。</p>
<h4 id="按钮、按钮组-组件"><a href="#按钮、按钮组-组件" class="headerlink" title="按钮、按钮组 组件"></a>按钮、按钮组 组件</h4><p>​    对所有按钮外部加上<div  class="btn-group">后所有按钮会成为按钮组，bootstrap会自动为第一个及最后一个加圆角，这些按钮会连在一块。按钮的功能的实现可用js插件</p>
<p>​     js插件包括了所有jqury，可一次引入所有插件，也可单个引入。</p>
<p>​     第一以及最后一个元素设置负的margin，抵消掉影响。</p>
<h3 id="Bootstrap的插件"><a href="#Bootstrap的插件" class="headerlink" title="Bootstrap的插件"></a>Bootstrap的插件</h3><h4 id="Tooltip插件–鼠标放上就可显示相关提示内容。"><a href="#Tooltip插件–鼠标放上就可显示相关提示内容。" class="headerlink" title="Tooltip插件–鼠标放上就可显示相关提示内容。"></a><strong>Tooltip插件–鼠标放上就可显示相关提示内容。</strong></h4><p>​    工具提示（Tooltip）插件不像之前所讨论的下拉菜单及其他插件那样，它不是纯 CSS 插件。如需使用该插件，您必须使用 jquery  激活它（读取 javascript）。使用下面的脚本来启用页面中的所有的工具提示（tooltip）：</p>
<p> jquery引入位置得在bootstrap.js的前面</p>
 <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn-group"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">data-toggle</span>=<span class="string">"tooltip"</span>  <span class="attr">data-placement</span>=<span class="string">"left"</span> <span class="attr">title</span>=<span class="string">"Tooltip on left"</span> &gt;</span>Tooltip on  left<span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">data-toggle</span>=<span class="string">"tooltip"</span>  <span class="attr">data-placement</span>=<span class="string">"top"</span> <span class="attr">title</span>=<span class="string">"Tooltip on top"</span>&gt;</span>Tooltip on  top<span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span><br><span class="line">	。。。 </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="定制Bootstrap"><a href="#定制Bootstrap" class="headerlink" title="定制Bootstrap"></a>定制Bootstrap</h3><p>通过自定义Bootstrap 组件、Less变量和 jQuery  插件，可以定制一份属于自己的 Bootstrap 版本。</p>
]]></content>
  </entry>
  <entry>
    <title>计算机网络（三）TCP三次握手和四次挥手</title>
    <url>/2020/03/19/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/</url>
    <content><![CDATA[<h2 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h2><p>所谓三次握手（Three-Way Handshake）即建立TCP连接，就是指建立一个TCP连接时，需要客户端和服务端总共发送3个包以确认连接的建立。整个流程如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu136.png" width="100%">

<ol>
<li>第一次握手：Client将标志位SYN置为1，随机产生一个值seq=J，并将该数据包发送给Server，Client进入SYN_SENT状态，等待Server确认。</li>
<li>第二次握手：Server收到数据包后由标志位SYN=1知道Client请求建立连接，Server将标志位SYN和ACK都置为1，ack=J+1，随机产生一个值seq=K，并将该数据包发送给Client以确认连接请求，Server进入SYN_RCVD状态。</li>
<li>第三次握手：Client收到确认后，检查ack是否为J+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1，并将该数据包发送给Server，Server检查ack是否为K+1，ACK是否为1，如果正确则连接建立成功，Client和Server进入ESTABLISHED状态，完成三次握手，随后Client与Server之间可以开始传输数据了。</li>
</ol>
<h3 id="为什么需要三次握手，而不是二次握手？"><a href="#为什么需要三次握手，而不是二次握手？" class="headerlink" title="为什么需要三次握手，而不是二次握手？"></a>为什么需要三次握手，而不是二次握手？</h3><p>主要是为了防止两次握手情况下已失效的连接请求报文段突然又传送到服务端,而产生的错误。举例如下:</p>
<p>Client向Server发出TCP连接请求,第一个连接请求报文在网络的某个节点长时间滞留,Client超时后认为报文丢失,于是再重传一次连接请求,Server收到后建立连接。数据传输完毕后双方断开连接。而此时,前一个滞留在网络中的连接请求到达了服务端Server,而Server认为Client又发来连接请求,若采用的是“两次握手”,则这种情况下Server认为传输连接已经建立,并一直等待Client传输数据,而Client此时并无连接请求,因此不予理睬,这样就造成了Server的资源白白浪费了;但此时若是使用“三次握手”,则Server向Client返回确认报文段,由于是一个失效的请求,因此Client不予理睬,建立连接失败。第三次握手的作用:防止已失效的连接请求报文段突然又传送到了服务器。</p>
<h3 id="第三次握手失败后怎么处理？"><a href="#第三次握手失败后怎么处理？" class="headerlink" title="第三次握手失败后怎么处理？"></a>第三次握手失败后怎么处理？</h3><p>如果此时ACK在网络中丢失，那么Server端该TCP连接的状态为SYN_RECV，并且依次等待3秒、6秒、12秒后重新发送SYN+ACK包，以便Client重新发送ACK包，以便Client重新发送ACK包。</p>
<p>Server重发SYN+ACK包的次数，可以通过设置/proc/sys/net/ipv4/tcp_synack_retries修改，默认值为5。</p>
<p>如果重发指定次数后，仍然未收到ACK应答，那么一段时间后，Server自动关闭这个连接。但是Client认为这个连接已经建立，如果Client端向Server写数据，Server端将以RST包响应，方能感知到Server的错误。</p>
<h2 id="TCP四次挥手-Client或Server均可主动发起挥手动作"><a href="#TCP四次挥手-Client或Server均可主动发起挥手动作" class="headerlink" title="TCP四次挥手(Client或Server均可主动发起挥手动作)"></a>TCP四次挥手(Client或Server均可主动发起挥手动作)</h2><p>所谓四次挥手（Four-Way Wavehand）即终止TCP连接，就是指断开一个TCP连接时，需要客户端和服务端总共发送4个包以确认连接的断开。整个流程如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu137.png" width="100%">

<ol>
<li>第一次挥手：Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。</li>
<li>第二次挥手：Server收到FIN后，发送一个ACK给Client，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），Server进入CLOSE_WAIT状态。</li>
<li>第三次挥手：Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。</li>
<li>第四次挥手：Client收到FIN后，Client进入TIME_WAIT状态，接着发送一个ACK给Server，确认序号为收到序号+1，Server进入CLOSED状态，完成四次挥手。</li>
</ol>
<h3 id="为什么连接的时候是三次握手，关闭的时候却是四次握手？"><a href="#为什么连接的时候是三次握手，关闭的时候却是四次握手？" class="headerlink" title="为什么连接的时候是三次握手，关闭的时候却是四次握手？"></a>为什么连接的时候是三次握手，关闭的时候却是四次握手？</h3><p>Server在LISTEN状态下，收到建立连接请求的SYN报文后，可以直接把ACK和SYN放在一个报文里发送给Client。而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，己方也未必全部数据都发送给对方了，所以己方可以立即close，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送。 </p>
<h3 id="为什么TIME-WAIT状态需要经过2MSL-最大报文段生存时间-才能返回到CLOSE状态？"><a href="#为什么TIME-WAIT状态需要经过2MSL-最大报文段生存时间-才能返回到CLOSE状态？" class="headerlink" title="为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？"></a>为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？</h3><ol>
<li>Client的最后一个ACK报文在传输的时候丢失，Server并没有接收到这个报文。这个时候，Server就会超时重传这个FIN消息，然后Client就会重新返回最后一个ACK报文，等待两个时间周期，完成关闭。如果不等待这两个时间周期，Server重传的那条消息就不会收到。Server就因为接收不到Client的信息而无法正常关闭。</li>
<li>防止“已失效的连接请求报文段”出现在本连接中。在发送完最后一个ACK报文段后,再经过2MSL,就可以使本连接持续的时间内所产生的所有报文段,都从网络中消失。这样就可以使下一个新的连接中不会出现这种就得连接请求报文段。</li>
</ol>
<p><strong>声明：</strong>本文转载自： <a href="https://www.cnblogs.com/wupeixuan/p/8639469.html" target="_blank" rel="noopener">https://www.cnblogs.com/wupeixuan/p/8639469.html</a> </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/02/29/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo搭建个人博客（一）博客框架搭建</title>
    <url>/2020/03/09/hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%EF%BC%88%E4%B8%80%EF%BC%89%E5%8D%9A%E5%AE%A2%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p><strong>前言</strong>：作为一个技术宅，怎么能够没有自己的个人Blog呢，自己搭建博客，一来可以用来作为学习的记录，二来将来面试的时候抛出自己满满的博客，那可是加分项呀，三来最次也可以用来装装X嘛</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">实验环境:win10</span><br><span class="line">前期准备：安装好git和node.js（自行百度下载git和nedo.js）</span><br></pre></td></tr></table></figure>

<hr>
<p>好，话不多说，开始动手</p>
<p>终端中输入 node -v 和git 分别出现以下界面，则安装正确（我使用的终端是cmder完整版，可以在win下使用linux的命令）</p>
<img src="http://photo.wushaopei.com/qiniu100.png" width="60%">

<p>上面这张图显示的是我安装node的版本 </p>
<img src="http://photo.wushaopei.com/qiniu101.png" width="80%">

<hr>
<p>上面的步骤完成之后，接下来就可以开始安装hexo了</p>
<p>首先介绍下npm，这是一个包管理器，接下来的安装都和这个命令有关，但由于众所周知的原因，国内速度很慢，所以我们进行一个镜像源更改，改到淘宝的源，利用npm安装一个cnpm包管理器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g cnpm --registry&#x3D;https:&#x2F;&#x2F;registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<p>替换成功之后cnpm就安装完成了，接下来开始正式安装hexo，用以下命令安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<p>hexo安装完成之后可以使用  hexo - v 命令验证下是否安装成功，成功的话就能够得到以下这个界面 </p>
<p><img src="https://img2018.cnblogs.com/blog/1502090/201905/1502090-20190526232835559-905739455.png" alt="img"></p>
<hr>
<p>接下来，选择一个盘新建一个文件夹，取名为blog(如果你和我一样是使用cmder的话，直接可以用mkdir命令)</p>
<p>然后终端进入这个blog文件夹，运行以下命令初始化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure>

<p>完成之后会在blog文件夹下生成一些文件，到这一步，hexo的初始化就已经完成了</p>
<img src="http://photo.wushaopei.com/qiniu103.png" width="80%">

<p> 安装依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install</span><br></pre></td></tr></table></figure>

<p> 这时候我们启动hexo博客，运行以下命令，然后在你的浏览器中输入 localhost:4000</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">这个命令默认的是使用4000端口，如果没有错误的话，你可以使用 localhost:4000 在你的浏览器中预览你的博客</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">但是有些人的电脑4000端口可能被占用什么的，这个时候　你可以使用以下命令</span><br><span class="line">hexo  s -p 5555　　&#x2F;&#x2F;指定5555端口</span><br></pre></td></tr></table></figure>

<p>此时hexo的基本布置完成了</p>
<hr>
<p>接下来要做的就是把博客部署到github上去</p>
<p>首先你要有个github账号，注册账号省略</p>
<p>然后你要创建一个仓库，仓库名字严格要求为 ： 你的用户名.github.io      </p>
<p>接下来打开的你的blog文件夹，推荐使用sublime，编辑 _config.yml 文件 </p>
<img src="http://photo.wushaopei.com/qiniu104.png" width="80%">

<p> 配置如上图所示，repo 配置为你的github仓库的地址 ，下图中的地址 </p>
<img src="http://photo.wushaopei.com/qiniu105.png" width="80%">

<p>保存更改，打开终端，进入blog文件夹路径，把博客部署到远端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo d</span><br></pre></td></tr></table></figure>



<p>这个时候可能报错，如：（xxxxx为你的github  ID）</p>
<h2 id="fatal-unable-to-access-‘https-github-com-xxxxxx-xxxxxx-github-io-git"><a href="#fatal-unable-to-access-‘https-github-com-xxxxxx-xxxxxx-github-io-git" class="headerlink" title="fatal: unable to access ‘https://github.com/xxxxxx/xxxxxx.github.io.git"></a>fatal: unable to access ‘<a href="https://github.com/xxxxxx/xxxxxx.github.io.git" target="_blank" rel="noopener">https://github.com/xxxxxx/xxxxxx.github.io.git</a></h2><p>这是因为git没有配置好原因，你可以把上面的 repo 的库地址配置为  </p>
<h2 id="https-用户名：密码-github-com-xxxxxx-xxxxxx-github-io-git"><a href="#https-用户名：密码-github-com-xxxxxx-xxxxxx-github-io-git" class="headerlink" title="https://用户名：密码@github.com/xxxxxx/xxxxxx.github.io.git"></a>https://用户名：密码@github.com/xxxxxx/xxxxxx.github.io.git</h2><p>完成之后刷新你的github仓库，就会发现仓库不是空的了。</p>
<p>然后在浏览器中输入     你的用户名.github.io   就能够访问你的博客了</p>
<hr>
<p>  总结：到此，个人博客就搭建完成了，不过此时的主题是hexo默认的主题，后续可以自己查找资料换主题</p>
<p><strong>注：转载自</strong>：<a href="https://www.cnblogs.com/hztjiayou/p/10928410.html" target="_blank" rel="noopener">https://www.cnblogs.com/hztjiayou/p/10928410.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>个人博客搭建</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot整合（六）集成timer 定时任务</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E5%85%AD%EF%BC%89%E9%9B%86%E6%88%90timer-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="1、创建具体要执行的任务类"><a href="#1、创建具体要执行的任务类" class="headerlink" title="1、创建具体要执行的任务类"></a>1、创建具体要执行的任务类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.timer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.TimerTask;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MyTimeTask</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 15:55</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTimeTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(MyTimeTask<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTimeTask</span><span class="params">(String inputName)</span></span>&#123;</span><br><span class="line">        name = inputName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//打印当前name 的内容</span></span><br><span class="line">        System.out.println(<span class="string">"Current exec name is "</span> + name);</span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">"111"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>run（）</strong>方法中是要执行的任务代码，定时器启动时会执行 <strong>run()</strong> 方法中的业务逻辑 ; </p>
<h3 id="2、创建-timer-的-实例工作类"><a href="#2、创建-timer-的-实例工作类" class="headerlink" title="2、创建 timer 的 实例工作类"></a>2、创建 timer 的 实例工作类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.timer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.Trigger;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.sql.Time;</span><br><span class="line"><span class="keyword">import</span> java.util.Timer;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MyTimer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/26 15:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTimer</span> </span>&#123;</span><br><span class="line"><span class="comment">//    public static void main(String[] args) &#123;</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuartzTrigger1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.创建一个timer实例</span></span><br><span class="line">        Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line">        <span class="comment">//2.创建一个MyTimerTask实例</span></span><br><span class="line">        MyTimeTask myTimeTask = <span class="keyword">new</span> MyTimeTask(<span class="string">"No.1"</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//3.通过timer定时定频率调用myTimerTask的业务逻辑</span></span><br><span class="line">        <span class="comment">// 即 第一次执行是在当前时间的两秒之后，之后每隔一秒钟执行一次\</span></span><br><span class="line">        timer.schedule(myTimeTask,<span class="number">2000L</span>,<span class="number">1000L</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加<strong>@Configuration</strong>  注解，自动注入实例对象，并由<strong>springboot</strong> 启动 定时器，执行任务。</p>
<p>注意： 使用<strong>springboot</strong> 时保证包扫描路径是正确的；</p>
<p><strong>执行效果：</strong></p>
<img src="http://photo.wushaopei.com/qiniu46.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-timer" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>jdbc(二)获取数据库连接的五种方式</title>
    <url>/2020/03/10/jdbc(%E4%BA%8C)%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%9A%84%20%E4%BA%94%20%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="获取数据库连接"><a href="#获取数据库连接" class="headerlink" title="获取数据库连接"></a>获取数据库连接</h2><h3 id="连接参数与协议"><a href="#连接参数与协议" class="headerlink" title="连接参数与协议"></a>连接参数与协议</h3><p>（1）可以调用 DriverManager 类的 getConnection() 方法建立到数据库的连接</p>
<p>（2）User,password可以用“属性名=属性值”方式告诉数据库；</p>
<p>（3）JDBC URL 用于标识一个被注册的驱动程序，驱动程序管理器通过这个 URL 选择正确的驱动程序，从而建立到数据库的连接。</p>
<p>（4）JDBC URL的标准由三部分组成，各部分间用冒号分隔。</p>
<ul>
<li><span style="color:red;">jdbc:子协议:子名称</span></li>
<li>协议：JDBC URL中的协议总是jdbc</li>
<li>子协议：子协议用于标识一个数据库驱动程序</li>
<li>子名称：一种标识数据库的方法。子名称可以依不同的子协议而变化，用子名称的目的是为了定位数据库提供足够的信息。包含主机名(对应服务端的ip地址)，端口号，数据库名</li>
</ul>
<h3 id="几种常用数据库的JDBC-URL"><a href="#几种常用数据库的JDBC-URL" class="headerlink" title="几种常用数据库的JDBC URL"></a>几种常用数据库的JDBC URL</h3><img src="http://photo.wushaopei.com/qiniu92.png" width="60%">

<ul>
<li><p>对于Oracle 数据库连接，采用如下形式：</p>
<p><span style="color:red;">jdbc:oracle:thin:@localhost:1521:webcode</span></p>
</li>
<li><p>对于SQLServer数据库连接，采用如下形式：</p>
<p> <span style="color:red;">jdbc:microsoft:sqlserver//localhost:1433;DatabaseName=sid</span></p>
</li>
<li><p>对于MYSQL 数据库连接，采用如下形式：</p>
<p> <span style="color:red;">jdbc:mysql://localhost:3306/webcode</span></p>
</li>
</ul>
<h3 id="JDBC连接数据库的5种方式"><a href="#JDBC连接数据库的5种方式" class="headerlink" title="JDBC连接数据库的5种方式"></a>JDBC连接数据库的5种方式</h3><p><strong>注意：</strong></p>
<ol>
<li>安装数据库 - 服务必须开启</li>
<li>需要导入数据库的驱动</li>
</ol>
<p>连接数据库的<strong>五种方式</strong>： </p>
<p><strong>代码：</strong> </p>
<h4 id="方式1-："><a href="#方式1-：" class="headerlink" title="方式1 ："></a><strong>方式1 ：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 数据库的连接：</span></span><br><span class="line"><span class="comment"> * 1.必须保证数据库是安装好的，服务是启动的</span></span><br><span class="line"><span class="comment"> * 2.必须将驱动添加到项目中</span></span><br><span class="line"><span class="comment"> * 3.必须保证数据库的账号和密码是对的</span></span><br><span class="line"><span class="comment"> * 4.必须保证数据库的版本和驱动的一样。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式一  ：通过多态的方式获取连接驱动</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	<span class="comment">//多态 ： 左边是接口的类型，右边是接口的实现</span></span><br><span class="line">	Driver driver = <span class="keyword">new</span> com.mysql.jdbc.Driver();</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	<span class="comment">//设置数据库的账号和密码</span></span><br><span class="line">	Properties info = <span class="keyword">new</span> Properties();</span><br><span class="line">	info.setProperty(<span class="string">"user"</span>, <span class="string">"root"</span>);</span><br><span class="line">	info.setProperty(<span class="string">"password"</span>, <span class="string">"root"</span>);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connect = driver.connect(url, info);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式2-：通过反射获取对象"><a href="#方式2-：通过反射获取对象" class="headerlink" title="方式2   ：通过反射获取对象"></a><strong>方式2   ：</strong>通过反射获取对象</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式二：通过反射获取对象</span></span><br><span class="line"><span class="comment"> * 体会面向接口的编程思想</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	Class clazz = Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">	Object obj = clazz.newInstance();</span><br><span class="line">	<span class="comment">//多态 ： 左边是接口的类型，右边是接口的实现</span></span><br><span class="line">	Driver driver = (Driver) obj;</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	<span class="comment">//设置数据库的账号和密码</span></span><br><span class="line">	Properties info = <span class="keyword">new</span> Properties();</span><br><span class="line">	info.setProperty(<span class="string">"user"</span>, <span class="string">"root"</span>);</span><br><span class="line">	info.setProperty(<span class="string">"password"</span>, <span class="string">"root"</span>);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connect = driver.connect(url, info);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式3-：-通过DriverMananger获取数据库的连接"><a href="#方式3-：-通过DriverMananger获取数据库的连接" class="headerlink" title="方式3 ： 通过DriverMananger获取数据库的连接"></a><strong>方式3 ： 通过DriverMananger获取数据库的连接</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式三：通过DriverMananger获取数据库的连接</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 使用DriverMananger有两个操作</span></span><br><span class="line"><span class="comment"> * 1.注册驱动</span></span><br><span class="line"><span class="comment"> * 2.获取连接</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	Class clazz = Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">	Object obj = clazz.newInstance();</span><br><span class="line">	<span class="comment">//多态 ： 左边是接口的类型，右边是接口的实现</span></span><br><span class="line">	Driver driver = (Driver) obj;</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	String user = <span class="string">"root"</span>;</span><br><span class="line">	String password = <span class="string">"root"</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * mysql可以不用注册，其它的数据库必须进行注册</span></span><br><span class="line"><span class="comment">	 * 这一步不要省。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">//注册驱动</span></span><br><span class="line">	DriverManager.registerDriver(driver);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式4-：-mysql驱动默认会进行驱动的注册"><a href="#方式4-：-mysql驱动默认会进行驱动的注册" class="headerlink" title="方式4 ： mysql驱动默认会进行驱动的注册"></a><strong>方式4 ： mysql驱动默认会进行驱动的注册</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接方式四：mysql驱动默认会进行驱动的注册</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//数据库连接的url</span></span><br><span class="line">	String url = <span class="string">"jdbc:mysql://localhost:3306/test"</span>;</span><br><span class="line">	String user = <span class="string">"root"</span>;</span><br><span class="line">	String password = <span class="string">"root"</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * mysql可以不用注册，其它的数据库必须进行注册</span></span><br><span class="line"><span class="comment">	 * 这一步不要省。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class clazz = Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">	<span class="comment">//数据库的连接</span></span><br><span class="line">	Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">	</span><br><span class="line">	System.out.println(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式5-：-使用配置文件获取数据库的连接"><a href="#方式5-：-使用配置文件获取数据库的连接" class="headerlink" title="方式5 ： 使用配置文件获取数据库的连接"></a><strong>方式5 ： 使用配置文件获取数据库的连接</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 方式五：使用配置文件获取数据库的连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		<span class="comment">//读取配置文件中的内容</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * 实际上是从bin目录下读取的配置文件</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		InputStream is = <span class="keyword">this</span>.getClass().getClassLoader()</span><br><span class="line">				.getResourceAsStream(<span class="string">"sqlDriver.properties"</span>);</span><br><span class="line">		Properties ps = <span class="keyword">new</span> Properties();</span><br><span class="line">		ps.load(is);</span><br><span class="line">		String user = ps.getProperty(<span class="string">"user"</span>);</span><br><span class="line">		String password = ps.getProperty(<span class="string">"password"</span>);</span><br><span class="line">		String driverClass = ps.getProperty(<span class="string">"driverClass"</span>);</span><br><span class="line">		String url = ps.getProperty(<span class="string">"url"</span>);</span><br><span class="line">		is.close();</span><br><span class="line">		</span><br><span class="line"><span class="comment">//		创建Driver对象</span></span><br><span class="line">		Class clazz = Class.forName(driverClass);</span><br><span class="line">		Object obj = clazz.newInstance();</span><br><span class="line">		Driver driver = (Driver) obj;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//注册驱动</span></span><br><span class="line">		DriverManager.registerDriver(driver);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//数据库的连接</span></span><br><span class="line">		Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">		</span><br><span class="line">		System.out.println(connection);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>数据库连接</tag>
      </tags>
  </entry>
  <entry>
    <title>jdbc(一)概述</title>
    <url>/2020/03/10/jdbc(%E4%B8%80)%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h3 id="1、JDBC-的概述"><a href="#1、JDBC-的概述" class="headerlink" title="1、JDBC 的概述"></a>1、JDBC 的概述</h3><p><strong>1.1 jdbc 是什么</strong> </p>
<p><strong>JDBC(Java Database Connectivity)</strong>是一个独立于特定数据库管理系统、通用的SQL数据库存取和操作的公共接口（一组<strong>API</strong>），定义了用来访问数据库的标准<strong>Java</strong>类库，（<strong>java.sql,javax.sql</strong>）使用这个类库可以以一种标准的方法、方便地访问数据库资源</p>
<ul>
<li><strong>JDBC</strong>为访问不同的数据库提供了一种统一的途径，为开发者屏蔽了一些细节问题。</li>
<li><strong>JDBC</strong>的目标是使Java程序员使用<strong>JDBC</strong>可以连接任何提供了<strong>JDBC</strong>驱动程序的数据库系统，这样就使得程序员无需对特定的数据库系统的特点有过多的了解，从而大大简化和加快了开发过程。</li>
</ul>
<p><strong>1.2 jdbc 与 数据库的连接方式：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu89.png" width="60%">

<p><strong>规范化的jdbc</strong> 连接数据库方式： </p>
<img src="http://photo.wushaopei.com/qiniu90.png" width="60%">

<p><strong>1.3 JDBC 体系结构</strong></p>
<p>JDBC接口（API）包括两个层次：</p>
<ul>
<li><strong>面向应用的API</strong>：Java API，抽象接口，供应用程序开发人员使用（连接数据库，执行SQL语句，获得结果）。</li>
<li><strong>面向数据库的API：</strong>Java Driver API，供开发商开发数据库驱动程序用。</li>
</ul>
<p><strong>JDBC是sun公司提供一套用于数据库操作的接口，java程序员只需要面向这套接 口编程即可。</strong>不同的数据库厂商，需要针对这套接口，提供不同实现。不同的实现的集合，即为不同数据库的驱动。这种方式是<strong>面向接口编程</strong>。</p>
<p><strong>1.4 JDBC API</strong></p>
<p><strong>JDBC API</strong> 是一系列的接口，它使得应用程序能够进行数据库联接，执行<strong>SQL</strong>语句，并且得到返回结果。</p>
<img src="http://photo.wushaopei.com/qiniu91.png" width="60%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
  </entry>
  <entry>
    <title>jdbc(三)预编译-Statement、PreparedStatement</title>
    <url>/2020/03/10/jdbc(%E4%B8%89)%E9%A2%84%E7%BC%96%E8%AF%91-Statement%E3%80%81PreparedStatement/</url>
    <content><![CDATA[<h2 id="预编译：statement-与-PreparedStatement"><a href="#预编译：statement-与-PreparedStatement" class="headerlink" title="预编译：statement 与 PreparedStatement"></a>预编译：statement 与 PreparedStatement</h2><h3 id="sql提供访问的接口："><a href="#sql提供访问的接口：" class="headerlink" title="sql提供访问的接口："></a><strong>sql提供访问的接口：</strong></h3><ul>
<li>数据库连接被用于向数据库服务器发送命令和 SQL 语句，在连接建立后，需要对数据库进行访问，执行 sql 语句</li>
<li>在 java.sql 包中有 3 个接口分别定义了对数据库的调用的不同方式：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">|-----   Statement</span><br><span class="line"> </span><br><span class="line">       |------PreparedStatement</span><br><span class="line"> </span><br><span class="line">              |------CallableStatement</span><br></pre></td></tr></table></figure>

<p>使用<span style="color:red;">statement</span>进行预编译可能会导致SQL注入的发生 </p>
<img src="http://photo.wushaopei.com/qiniu92.png" width="60%">

<h3 id="SQL-注入攻击"><a href="#SQL-注入攻击" class="headerlink" title="SQL 注入攻击"></a><strong>SQL 注入攻击</strong></h3><ul>
<li>SQL 注入是利用某些系统没有对用户输入的数据进行充分的检查，而在用户输入数据中注入非法的 SQL 语句段或命令(如：SELECT user, password FROM user_table WHERE user=’a’ OR 1 = ‘ AND password = ‘ OR ‘1’ = ‘1’) ，从而利用系统的 SQL 引擎完成恶意行为的做法</li>
<li>对于 Java 而言，要防范 SQL 注入，只要用 PreparedStatement(从Statement扩展而来) 取代 Statement 就可以了</li>
</ul>
<h3 id="PreparedStatement"><a href="#PreparedStatement" class="headerlink" title="PreparedStatement"></a><strong>PreparedStatement</strong></h3><ul>
<li>可以通过调用 Connection 对象的 preparedStatement() 方法获取 PreparedStatement 对象</li>
<li>PreparedStatement 接口是 Statement 的子接口，它表示一条预编译过的 SQL 语句</li>
<li>PreparedStatement 对象所代表的 SQL 语句中的参数用问号(?)来表示，调用 PreparedStatement 对象的 setXxx() 方法来设置这些参数. setXxx() 方法有两个参数，第一个参数是要设置的 SQL 语句中的参数的索引(从 1 开始)，第二个是设置的 SQL 语句中的参数的值</li>
</ul>
<h3 id="PreparedStatement-vs-Statement"><a href="#PreparedStatement-vs-Statement" class="headerlink" title="PreparedStatement vs Statement"></a><strong>PreparedStatement vs Statement</strong></h3><ul>
<li>代码的可读性和可维护性.</li>
<li>PreparedStatement 能最大可能提高性能：</li>
</ul>
<blockquote>
<ol>
<li>DBServer会对预编译语句提供性能优化。因为预编译语句有可能被重复调用，所以语句在被DBServer的编译器编译后的执行代码被缓存下来，那么下次调用时只要是相同的预编译语句就不需要编译，只要将参数直接传入编译过的语句执行代码中就会得到执行。</li>
<li>在statement语句中,即使是相同操作但因为数据内容不一样,所以整个语句本身不能匹配,没有缓存语句的意义.事实是没有数据库会对普通语句编译后的执行代码缓存.这样每执行一次都要对传入的语句编译一次.  </li>
<li>(语法检查，语义检查，翻译成二进制命令，缓存)</li>
</ol>
</blockquote>
<ul>
<li>PreparedStatement 可以防止 SQL 注入防止 SQL 注入 </li>
</ul>
<h3 id="数据类型转换表"><a href="#数据类型转换表" class="headerlink" title="数据类型转换表"></a><strong>数据类型转换表</strong></h3><table>
<thead>
<tr>
<th>java类型</th>
<th>SQL类型</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>BIT</td>
</tr>
<tr>
<td>byte</td>
<td>TINYINT</td>
</tr>
<tr>
<td>short</td>
<td>SMALLINT</td>
</tr>
<tr>
<td>int</td>
<td>INTEGER</td>
</tr>
<tr>
<td>long</td>
<td>BIGINT</td>
</tr>
<tr>
<td>String</td>
<td>CHAR,VARCHAR,LONGVARCHAR</td>
</tr>
<tr>
<td>byte array</td>
<td>BINARY , VAR  BINARY</td>
</tr>
<tr>
<td>java.sql.Date</td>
<td>DATE</td>
</tr>
<tr>
<td>java.sql.Time</td>
<td>TIME</td>
</tr>
<tr>
<td>java.sql.Timestamp</td>
<td>TIMESTAMP</td>
</tr>
</tbody></table>
<h3 id="连接数据库、操作表的步骤："><a href="#连接数据库、操作表的步骤：" class="headerlink" title="连接数据库、操作表的步骤："></a><strong>连接数据库、操作表的步骤：</strong></h3><img src="http://photo.wushaopei.com/qiniu93.png" width="60%">

<p><strong>注意：</strong></p>
<ul>
<li>释放ResultSet, Statement,Connection。</li>
<li>数据库连接（Connection）是非常稀有的资源，用完后必须马上释放，如果Connection不能及时正确的关闭将导致系统宕机。Connection的使用原则是<span style="color:red;">尽量晚创建，尽量早的释放。</span></li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>数据库连接</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot整合（五）集成Lombok 插件</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%BA%94%EF%BC%89%E9%9B%86%E6%88%90Lombok-%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="应用原因："><a href="#应用原因：" class="headerlink" title="应用原因："></a>应用原因：</h3><p><code>为了减少代码量，为当前项目添加 **lombok** 来优雅编码</code></p>
<h3 id="Lombok-插件安装："><a href="#Lombok-插件安装：" class="headerlink" title="Lombok 插件安装："></a>Lombok 插件安装：</h3><h4 id="a-添加依赖"><a href="#a-添加依赖" class="headerlink" title="a . 添加依赖:"></a><strong>a . 添加依赖:</strong></h4><p>在 pom.xml 文件中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span></span><br><span class="line">     </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="b-安装-Lombok-插件"><a href="#b-安装-Lombok-插件" class="headerlink" title="b . 安装 Lombok 插件"></a>b . 安装 Lombok 插件</h4><p><strong>Eclipse:</strong></p>
<pre><code>下载地址：https://projectlombok.org/download
　　将下载的lombok.jar文件，放到eclipse安装路径，该jar包也就是lombok插件的jar文件了
　　打开eclipse.ini文件，添加如下内容：
　　　　-javaagent:lombok.jar
　　　　-Xbootclasspath/a:lombok.jar
 　　　　重启eclipse</code></pre><p><strong>IDEA:</strong></p>
<pre><code>可以在线安装lombok的插件
settings -&gt; plugins -&gt; 在搜索框输入lombok -&gt;  安装</code></pre><p>sts安装Lombok：</p>
<p><a href="https://blog.csdn.net/zhaoxiaohua125/article/details/80211684" target="_blank" rel="noopener">https://blog.csdn.net/zhaoxiaohua125/article/details/80211684</a></p>
<p>Lombok常用注解及原理：</p>
<table>
<thead>
<tr>
<th>@Data</th>
<th>注解在类上</th>
<th>包含了@ToString，@EqualsAndHashCode，@Getter / @Setter和@RequiredArgsConstructor的功能，提供类所有属性的 getter 和 setter 方法，此外还提供了equals、canEqual、hashCode、toString 方法</th>
</tr>
</thead>
<tbody><tr>
<td><strong>@Setter</strong></td>
<td>注解在属性上</td>
<td>为属性提供 setter 方法</td>
</tr>
<tr>
<td><strong>@Getter</strong></td>
<td>注解在属性上</td>
<td>为属性提供 getter 方法</td>
</tr>
<tr>
<td><strong>@ToString</strong></td>
<td>注解在类上</td>
<td>生成toString()方法，默认情况下，它会按顺序（以逗号分隔）打印你的类名称以及每个字段。                 可以这样设置不包含哪些字段<strong>@ToString(exclude = “id”) / @ToString(exclude = {“id”,”name”})</strong>如果继承的有父类的话，可以设置callSuper 让其调用父类的toString()方法，例如：@ToString(callSuper = true)</td>
</tr>
<tr>
<td>@<strong>EqualsAndHashCode</strong></td>
<td>注解在类上</td>
<td>生成hashCode()和equals()方法，默认情况下，它将使用所有非静态，非transient字段。但可以通过在可选的exclude参数中来排除更多字段。或者，通过在parameter参数中命名它们来准确指定希望使用哪些字段。</td>
</tr>
<tr>
<td>@<strong>NonNull</strong></td>
<td>注解在属性上</td>
<td>标识属性是不能为空，为空则抛出异常。</td>
</tr>
<tr>
<td>@<strong>Slf4j</strong></td>
<td>注解在类上</td>
<td>根据用户实际使用的日志框架生成log日志对象。</td>
</tr>
<tr>
<td>@<strong>Log4j</strong></td>
<td>注解在类上</td>
<td>为类提供一个 属性名为log 的 log4j 日志对象</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>jdbc(四)ResultSet</title>
    <url>/2020/03/10/jdbc(%E5%9B%9B)ResultSet/</url>
    <content><![CDATA[<h2 id="ResultSet"><a href="#ResultSet" class="headerlink" title="ResultSet"></a><strong>ResultSet</strong></h2><h3 id="ResultSet-的作用："><a href="#ResultSet-的作用：" class="headerlink" title="ResultSet 的作用："></a><strong>ResultSet 的作用：</strong></h3><ul>
<li>通过调用 PreparedStatement 对象的 excuteQuery() 方法创建该对象</li>
<li>ResultSet 对象以逻辑表格的形式封装了执行数据库操作的结果集，ResultSet 接口由数据库厂商实现</li>
<li>ResultSet 对象维护了一个指向当前数据行的游标，初始的时候，游标在第一行之前，可以通过 ResultSet 对象的 next() 方法移动到下一行</li>
</ul>
<h3 id="ResultSet-接口的常用方法："><a href="#ResultSet-接口的常用方法：" class="headerlink" title="ResultSet 接口的常用方法："></a><strong>ResultSet 接口的常用方法：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">getString</span><span class="params">( )</span></span></span><br></pre></td></tr></table></figure>

<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a><strong>案例</strong></h3><p><strong>（1）</strong> </p>
<img src="http://photo.wushaopei.com/qiniu94.png" width="60%">

<p><strong>（2）</strong> </p>
<img src="http://photo.wushaopei.com/qiniu95.png" width="60%">

<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a><strong>说明</strong></h3><ol>
<li>查询需要调用Prepared Statement 的 executeQuery() 方法，查询结果是一个 ResultSet 对象 </li>
<li>关于 ResultSet：代表结果集 </li>
</ol>
<blockquote>
<ul>
<li>ResultSet: 结果集. 封装了使用 JDBC 进行查询的结果.</li>
<li>调用 PreparedStatement 对象的 executeQuery() 可以得到结果集.</li>
<li>ResultSet 返回的实际上就是一张数据表. 有一个指针指向数据表的第一条记录的前面.</li>
</ul>
</blockquote>
<ol start="3">
<li><p>可以调用 next() 方法检测下一行是否有效. 若有效该方法返回 true, 且指针下移. 相当于Iterator 对象的 hasNext() 和 next() 方法的结合体 </p>
</li>
<li><p>当指针指向一行时, 可以通过调用 getXxx(int index) 或 getXxx(int columnName) 获取每一列的值. </p>
<blockquote>
<p>   例如: getInt(1), getString(“name”) </p>
</blockquote>
</li>
<li><p>ResultSet 当然也需要进行关闭. </p>
</li>
</ol>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>resultSet</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot整合（四）集成@Scheduled 定时任务</title>
    <url>/2020/03/07/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E5%9B%9B%EF%BC%89%E9%9B%86%E6%88%90-Scheduled-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="1、在SpringBoot-项目中使用-Scheduled注解执行定时任务："><a href="#1、在SpringBoot-项目中使用-Scheduled注解执行定时任务：" class="headerlink" title="1、在SpringBoot 项目中使用@Scheduled注解执行定时任务："></a>1、在SpringBoot 项目中使用<strong>@Scheduled</strong>注解执行定时任务：</h3><p>配置pom.xml 依赖：</p>
<p>一般情况下，SpringBoot 的 相关依赖，如：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>是有包含对应  <strong>@Scheduled 定时注解启动所需要的jar包的，如下：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br></pre></td></tr></table></figure>

<h3 id="2、创建定时类"><a href="#2、创建定时类" class="headerlink" title="2、创建定时类"></a>2、创建定时类</h3><p>（1）@Component ： 将当前类实例化注入到容器中</p>
<p>（2）定时器的生效要素：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Scheduled</span>(cron=<span class="string">"0/5 * *  * * ? "</span>)   <span class="comment">//每5秒执行一次</span></span><br></pre></td></tr></table></figure>

<p>在程序启动时，定时器会开始计时，并根据设定时间执行设置好的任务内容,<strong>线程的执行是以单线程进行</strong>； </p>
<p>（3）创建以下定时类 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.quartz;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.common.SystemLogHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> HandleTimeQuartz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 20:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandleTimeQuartz</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 系统日志</span></span><br><span class="line">    <span class="comment">//private static SystemLogHandler systemLogger = SystemLogHandler</span></span><br><span class="line">   <span class="comment">//         .getLogger(HandleTimeQuartz.class);</span></span><br><span class="line"> </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(InvoiceController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Scheduled</span>(cron=<span class="string">"0/5 * *  * * ? "</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userStatusJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">"进入测试"</span>);</span><br><span class="line">        logger.info(System.currentTimeMillis()+<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 程序入口处添加注解 </p>
<img src="http://photo.wushaopei.com/qiniu44.png" width="60%">

<p>直接启动后会自动执行：效果如下： </p>
<img src="http://photo.wushaopei.com/qiniu45.png" width="60%">

<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-scheduled" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>mybatis 入门（三）Mybatis 的基本构成-创建SqlSession</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%89%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E5%88%9B%E5%BB%BASqlSession/</url>
    <content><![CDATA[<h2 id="创建SqlSession"><a href="#创建SqlSession" class="headerlink" title="创建SqlSession"></a>创建SqlSession</h2><p>SqlSession是一个接口类，它类似于你们公司前台的美女客服，它扮演着门面的作用，而真正干活的是Executor接口，你可以认为它是公司的工程师。假设我是客户找你们公司干活，我只需要告诉前台的美女客服（SqlSession）我要什么信息（参数），要做什么东西，过段时间，她会将结果给我。在这个过程中，作为用户的我所关心的是：</p>
<p>​    （1）要给美女客服（SqlSession)什么信息（功能和参数）</p>
<p>​    （2）美女客服会返回什么结果（Result)</p>
<p>​    而我并不关心工程师（Executor）是怎么为我工作的，只要前台告诉工程师（Executor)工程师就知道如何为我工作，这个步骤对我而言是个黑箱操作。</p>
<p>​    在MyBatis中，SqlSession的具体实现类有两个，分别是DefaultSqlSession和SqlSessionManager。当我们构建好SqlSessionFactory，然后生成SqlSession。</p>
<p>​    注意一点： 前面提到过，SqlSession接口类似于一个JDBC中的Connection接口对象，我们需要保证每次用完正常关闭它，所以正确的做法是每次都把关闭SqlSession接口的代码写在finally语句中从而保证SqlSession的关闭，从而将连接资源进行释放，交还给数据库。<code>数据库的资源是有限的，频繁的建立连接而不进行释放资源，会因为最终资源匮乏而导致系统的瘫痪，从而引发更大的问题。</code></p>
<p>​    </p>
<img src="http://photo.wushaopei.com/qiniu267.png" width="80%">

<h3 id="SqlSession-代码示例"><a href="#SqlSession-代码示例" class="headerlink" title="SqlSession 代码示例"></a>SqlSession 代码示例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">		<span class="comment">// 定义 SqlSession</span></span><br><span class="line">		SqlSession sqlsession = <span class="keyword">null</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;			</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 定义SqlSession</span></span><br><span class="line">			sqlsession = sqlSessionFactory.openSession();</span><br><span class="line"><span class="comment">//			selectOne方法用来执行select查询语句，并返回一个对象</span></span><br><span class="line">			<span class="comment">// some code ...</span></span><br><span class="line">			User user = sqlsession.selectOne(<span class="string">"com.webcode.cn.entity.User.selectUserById"</span>, <span class="number">1</span>);</span><br><span class="line">			System.out.println( user );</span><br><span class="line">			sqlsession.commit();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			sqlsession.rollback();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 在finally 语句中确保资源被顺利关闭</span></span><br><span class="line">			sqlsession.close();<span class="comment">//释放资源</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这样SqlSession就被我们创建出来了，在finally语句中我们保证了它的合理关闭，让连接资源归还给数据库连接池，以便后续使用。</p>
<h3 id="SqlSession的用途："><a href="#SqlSession的用途：" class="headerlink" title="SqlSession的用途："></a>SqlSession的用途：</h3><p>（1）获取映射器，让映射器通过命名空间和方法名称找到对应的SQL，发送给数据库执行后返回结果。 这里主要是配置 namespace 为  <code>*Mapper</code> （如 UserMapper ）的时候。</p>
<p>（2）直接通过命名信息去执行SQL返回结果，这是iBatis版本留下的方式。在SqlSession层我们可以通过update、insert、select、delete等方法，带上SQL的id来操作在XML中配置好的SQL，从而完成我们的工作；与此同时它也支持事务，通过commit、rollback方法提交或者回滚事务。这里主要是配置 namespace 为 JavaBean时使用。</p>
<p><strong>声明：</strong>后面会针对这两种用途进行分析比较。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（五）生命周期</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%94%EF%BC%89%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
    <content><![CDATA[<h2 id="声明周期"><a href="#声明周期" class="headerlink" title="声明周期"></a>声明周期</h2><p>理解我们之前讨论过的不同作用域和生命周期类别是至关重要的，因为错误的使用会导致非常严重的并发问题。 </p>
<img src="http://photo.wushaopei.com/qiniu265.png" width="80%">

<p>​         <strong>对象生命周期和依赖注入框架</strong>       </p>
<p>​         依赖注入框架可以创建线程安全的、基于事务的 SqlSession 和映射器，并将它们直接注入到你的 bean 中，因此可以直接忽略它们的生命周期。如果对如何通过依赖注入框架使用 MyBatis 感兴趣，可以研究一下 MyBatis-Spring 或 MyBatis-Guice 两个子项目。</p>
<p>​    </p>
<h3 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h3><p>​    SqlSessionFactoryBuilder 是利用XML或者Java编码获得资源来构建SqlSessionFactory的，通过它可以构建多个SqlSessionFactory。它的作用就是一个构建器，这个类可以被实例化、使用和丢弃，一旦创建了 SqlSessionFactory，就不再需要它了。</p>
<p>​    这时我门就应该毫不犹豫的<strong>废弃它，将它回收</strong>。</p>
<p> 因此 SqlSessionFactoryBuilder 实例的最佳作用域是方法作用域（也就是<strong>局部方法变量</strong>）。 你可以重用 SqlSessionFactoryBuilder 来创建多个 SqlSessionFactory 实例，但最好还是不要一直保留着它，以保证所有的 XML 解析资源可以被释放给更重要的事情。 </p>
<h3 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h3><p>​    SqlSessionFactory 的作用是创建SqlSession，而SqlSession就是一个绘画，相当于JDBC中的Connection对象。每次应用程序需要访问数据库，我们就要通过SqlSessionFactory 创建Session，所以SqlSessionFactory 一旦被创建就应该在应用的运行期间一直存在，没有任何理由丢弃它或重新创建另一个实例。 使用 SqlSessionFactory 的最佳实践是在应用运行期间不要重复创建多次，多次重建 SqlSessionFactory 被视为一种代码“坏习惯”。因此 SqlSessionFactory 的最佳作用域是应用作用域（类变量）。 有很多方法可以做到，最简单的就是使用单例模式或者静态单例模式。 </p>
<h3 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h3><p>每个线程都应该有它自己的 SqlSession 实例。SqlSession 的实例不是线程安全的，因此是不能被共享的，所以它的最佳的作用域是请求或方法作用域。 绝对不能将 SqlSession 实例的引用放在一个类的静态域，甚至一个类的实例变量也不行。 也绝不能将 SqlSession 实例的引用放在任何类型的托管作用域中，比如 Servlet 框架中的 HttpSession。 如果你现在正在使用一种 Web 框架，考虑将 SqlSession 放在一个和 HTTP 请求相似的作用域中。 换句话说，每次收到 HTTP 请求，就可以打开一个 SqlSession，返回一个响应后，就关闭它。 这个关闭操作很重要，为了确保每次都能执行关闭操作，你应该把这个关闭操作放到 finally 块中。 下面的示例就是一个确保 SqlSession 关闭的标准模式： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> (SqlSession session = sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  <span class="comment">// 你的应用逻辑代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在所有代码中都遵循这种使用模式，可以保证所有数据库资源都能被正确地关闭。 </p>
<h3 id="映射器实例-（Mapper）"><a href="#映射器实例-（Mapper）" class="headerlink" title="映射器实例 （Mapper）"></a>映射器实例 （Mapper）</h3><p>映射器（Mapper) 是一些绑定映射语句的接口。映射器接口的实例是从 SqlSession 中获得的。虽然从技术层面上来讲，任何映射器实例的最大作用域与请求它们的 SqlSession 相同。但方法作用域才是映射器实例的最合适的作用域。 也就是说，映射器实例应该在调用它们的方法中被获取，使用完毕之后即可丢弃。 映射器实例并不需要被显式地关闭。尽管在整个请求作用域保留映射器实例不会有什么问题，但是你很快会发现，在这个作用域上管理太多像 SqlSession 的资源会让你忙不过来。 因此，最好将映射器放在方法作用域内。就像下面的例子一样： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">try (SqlSession session &#x3D; sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  BlogMapper mapper &#x3D; session.getMapper(BlogMapper.class);</span><br><span class="line">  &#x2F;&#x2F; 你的应用逻辑代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>  Mapper是一个接口，而没有任何实现类，它的作用是发送SQL，然后返回我们需要的结果，或者执行SQL从而修改数据库的数据，因此它应该在一个SqlSession事务方法之内，是一个方法级别的东西。</p>
<p><strong>MyBatis组件的生命周期示意图：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu268.png" width="80%"> 



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（一）传统的JDBC编程的不足</title>
    <url>/2020/03/12/mybatis%20%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%80%EF%BC%89%E4%BC%A0%E7%BB%9F%E7%9A%84JDBC%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%8D%E8%B6%B3/</url>
    <content><![CDATA[<h3 id="JDBC的作用"><a href="#JDBC的作用" class="headerlink" title="JDBC的作用"></a>JDBC的作用</h3><p>Java程序都是通过JDBC连接数据库的，这样我们才能实现通过SQL对数据库编程。JDBC是SUN公司提出的一系列规范，并交由下游的数据库厂商去通过定义好的接口规范实现具体的数据库数据操作。</p>
<p>具体实现如下：</p>
<img src="http://photo.wushaopei.com/qiniu90.png" width="60%">

<h3 id="JDBC的不足"><a href="#JDBC的不足" class="headerlink" title="JDBC的不足"></a>JDBC的不足</h3><p>传统的JDBC功能虽然让我们能够连接数据库并实现对数据的操作，但也在一定程度上对我们的开发效率产生了影响。或者说，这是基于JDBC本身调用规则的一种缺陷。</p>
<p>关于以上说到的缺陷，我们通过代码来进行体现，这里通过JDBC实现对数据库的连接，并进行查询数据的操作。具体的数据库配置参数都放在了 <code>sqlDriver.properties</code>文件中</p>
<h4 id="创建jdbc连接，并封装为方法"><a href="#创建jdbc连接，并封装为方法" class="headerlink" title="创建jdbc连接，并封装为方法"></a><strong>创建jdbc连接，并封装为方法</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*	 * 获取数据库的连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 数据库的连接</span></span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			is = JDBCUtils.class.getClassLoader().getResourceAsStream("sqlDriver.properties");</span><br><span class="line">			Properties ps = <span class="keyword">new</span> Properties();</span><br><span class="line">			ps.load(is);</span><br><span class="line">			String user = ps.getProperty(<span class="string">"user"</span>);</span><br><span class="line">			String password = ps.getProperty(<span class="string">"password"</span>);</span><br><span class="line">			String driverClass = ps.getProperty(<span class="string">"driverClass"</span>);</span><br><span class="line">			String url = ps.getProperty(<span class="string">"url"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 创建Driver对象</span></span><br><span class="line">			Class clazz = Class.forName(driverClass);</span><br><span class="line">			Object obj = clazz.newInstance();</span><br><span class="line">			Driver driver = (Driver) obj;</span><br><span class="line">			<span class="comment">// 注册驱动</span></span><br><span class="line">			DriverManager.registerDriver(driver);</span><br><span class="line">			connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					is.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> connection;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在操作完成后要进行连接的关闭"><a href="#在操作完成后要进行连接的关闭" class="headerlink" title="在操作完成后要进行连接的关闭"></a><strong>在操作完成后要进行连接的关闭</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			connection.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ps.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps, ResultSet rs)</span> </span>&#123;</span><br><span class="line">	close(connection,ps);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(rs != <span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			rs.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询一条数据"><a href="#查询一条数据" class="headerlink" title="查询一条数据"></a>查询一条数据</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 查询一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Customer <span class="title">getCustomerById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"select * from customers where id = ?"</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		ps.setInt(<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery(); <span class="comment">// 查找的结果都已经放到ResultSet中了</span></span><br><span class="line"> </span><br><span class="line">		Customer customer = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 5.取数据</span></span><br><span class="line">		<span class="keyword">if</span> (rs.next()) &#123; <span class="comment">// 如果有数据就返回true,否则返回false</span></span><br><span class="line">			<span class="comment">// 获取列上值的第一种方式</span></span><br><span class="line">			<span class="comment">// int id = rs.getInt(1); //根据列的索引获取对应的列上的值</span></span><br><span class="line">			<span class="comment">// String name = rs.getString(2);</span></span><br><span class="line">			<span class="comment">// String email = rs.getString(3);</span></span><br><span class="line">			<span class="comment">// Date date = rs.getDate(4);</span></span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 获取列上值的第二种方式</span></span><br><span class="line">			<span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">			String name = rs.getString(<span class="string">"name"</span>);</span><br><span class="line">			String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">			Date birth = rs.getDate(<span class="string">"birth"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 考虑将数据进行封装</span></span><br><span class="line">			customer = <span class="keyword">new</span> Customer(id, name, email, birth);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 输出获取到的内容</span></span><br><span class="line">			System.out.println(id + <span class="string">" "</span> + name + <span class="string">" "</span> + email + <span class="string">" "</span> + birth);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 6.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		<span class="keyword">return</span> customer;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中我们可以可能出整个过程大致分为以下几步：</p>
<ul>
<li>使用JDBC编程需要连接数据库，注册驱动和数据库信息</li>
<li>操作Connection，打开PreparedStatement对象</li>
<li>通过PreparedStatement执行SQL，返回结果到ResultSet对象</li>
<li>使用ResultSet读取数据，然后通过代码转化为具体的POJO对象</li>
<li>关闭数据库相关资源</li>
</ul>
<h4 id="弊端"><a href="#弊端" class="headerlink" title="弊端"></a>弊端</h4><p>从以上分析中，我们可以看出，使用传统的JDBC会导致以下几个问题：</p>
<p>（1）工作量会很大，每次执行CRUD操作都需要线连接，然后处理JDBC底层事务，处理数据类型。然后还要操作Connection、PreparedStatement和ResultSet对象去获取数据，并在执行完后关闭它们</p>
<p>（2) 需要对JDBC编程可能产生的异常进行捕捉处理并正确关闭资源</p>
<p>如以上两个原因，会导致在使用JDBC开发编程的过程中多出了许多重复而无太大意义的工作量。有鉴于这一点，ORM框架应运而生，并且ORM框架也更加的轻量和高效。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
        <category>知识树</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（四）Mybatis 的基本构成-映射器</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E5%9B%9B%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E6%98%A0%E5%B0%84%E5%99%A8/</url>
    <content><![CDATA[<h2 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h2><h3 id="构成："><a href="#构成：" class="headerlink" title="构成："></a>构成：</h3><p>映射器是由Java接口和XML文件（或注解）共同组成的，它的作用如下。</p>
<ul>
<li>定义参数类型</li>
<li>描述缓存</li>
<li>描述SQL语句</li>
<li>定义查询结果和POJO的映射关系</li>
</ul>
<h3 id="两种实现方式"><a href="#两种实现方式" class="headerlink" title="两种实现方式"></a>两种实现方式</h3><ul>
<li>一种是通过XML文件方式实现；</li>
<li>另一种就是通过代码方式实现。</li>
</ul>
<p>第一种，XML配置实现的方式， 这里需要在mytais-config.xml文件中进行描述一个XML文件的具体路径，它是用来生成Mapper的。</p>
<p>而第二种通过注解实现的方式，在Configuration里面注册Mapper接口（需要添加相应的Java注解）。当然它也是MyBatis的河西内容，同时也是最为复杂的。</p>
<p>推荐： 在项目开发中，比较推荐使用XML文件配置方式。</p>
<p>原因：</p>
<ul>
<li>Java 注解方式受限较大，功能相对少，而Mapper中内容比较多，功能相对强大一些，使用上也比较灵活。</li>
<li>Mapper中适合编写复杂，条件较多的SQL，并且有助于进行动态SQL的使用，提高可读性和代码的复用率，降低维护和编码成本</li>
</ul>
<h4 id="XML-文件配置方式实现Mapper"><a href="#XML-文件配置方式实现Mapper" class="headerlink" title="XML 文件配置方式实现Mapper"></a>XML 文件配置方式实现Mapper</h4><p>使用XML文件配置是Mybatis实现Mapper的首选方式。其构成主要包括一个Java接口和一个XML文件构成。</p>
<p>第一步：给出Java 接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.mapper;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserMapper.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月5日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们定义了一个接口，它由一个方法selectUserById,通过用户ID 找到用户对象</p>
<p>第二部，给出一个映射XML文件</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">  PUBLIC <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line">  <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  		namespace名称空间</span><br><span class="line">  		取值一般有两种情况：</span><br><span class="line">  			一种情况是：使用javaBean的全类名</span><br><span class="line">  			二种情况是：使用Mapper接口的全类名</span><br><span class="line">   --&gt;</span><br><span class="line">&lt;!-- &lt;mapper namespace=<span class="string">"com.webcode.cn.mapper.UserMapper"</span>&gt; --&gt;</span><br><span class="line">	&lt;mapper namespace=<span class="string">"com.webcode.cn.entity.User"</span>&gt;	</span><br><span class="line">  &lt;!-- </span><br><span class="line">  	select标签用来配置一个select语句</span><br><span class="line">  		id 用来配置一个唯一的标识</span><br><span class="line">  		resultType 是查询完之后一条记录对应转换成为的javaBean对象</span><br><span class="line">  		#&#123;id&#125;是点位符</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;select id=<span class="string">"selectUserById"</span> resultType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">    	select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<p>关于XML文件：</p>
<ul>
<li>针对该XML文件，需要现在Mybatis的配置文件 mybatis-config.xml中进行配置，这样MyBatis会读取这个配置文件，生成映射器。</li>
<li>定义了一个命名空间为com.webcode.cn.entity.User的SQL Mapper，这个名称空间必须和我们定义的接口权限定名一致</li>
<li>其中的Select方法定义了一个查询SQL，id为selectUserById，与前面的接口方法一致对应。resultType 定义了我们需要返回的数据类型，这里为User，该User是之前定义好的JavaBean实体类。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String lastName;</span><br><span class="line">	<span class="keyword">private</span> Integer sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的SQL是：</p>
<p><code>select id,last_name lastName,sex from t_user where id = #{id}</code></p>
<p><code>#{id}</code> 为这条SQL的参数。而SQL列的列名和POJO的属性名称保持一致。那么MyBatis就会把这条语句查询的结果自动映射到我们需要的POJO属性上，这就是自动映射。我们可以用SqlSession来获取这个Mapper,代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//			selectOne方法用来执行select查询语句，并返回一个对象</span></span><br><span class="line">			<span class="comment">// 获取映射器Mapper</span></span><br><span class="line">			UserMapper userMapper = openSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;			</span><br><span class="line">			User user = userMapper.selectUserById(<span class="number">1</span>);</span><br><span class="line">			System.out.println( user );</span><br></pre></td></tr></table></figure>

<p>这样就完成了MyBatis的一次完整查询。</p>
<h4 id="Java注解方式实现Mapper"><a href="#Java注解方式实现Mapper" class="headerlink" title="Java注解方式实现Mapper"></a>Java注解方式实现Mapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="meta">@Select</span>(value=<span class="string">"select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span></span><br><span class="line"><span class="string">"</span>)  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这里使用@Select注解，注入了和XML一样的select元素，这样MyBatis就会读取这条SQL，并将参数传递进SQL。然后进行自动映射操作，从而得到我们需要的User对象。</p>
<p>注意： 这种方式虽然相对简单，但是在使用多表关联、查询、级联等情况下会使SQL显得很复杂，不利于阅读和维护。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select u.id as userid,u.username,r.id as roleid,r.role_name </span><br><span class="line">from user u left join user_role ur on u.id &#x3D; ur.user_id </span><br><span class="line">left join role r on ur.role_id &#x3D; r.id</span><br><span class="line">where 1&#x3D;1</span><br><span class="line">and u.username like concat(&#39;%&#39;,#&#123;username&#125;,&#39;%&#39;)</span><br><span class="line">and r.role_name like concat(&#39;%&#39;,#&#123;roleNme&#125;,&#39;%&#39;)</span><br></pre></td></tr></table></figure>

<p>如果还需要在以上的SQL中进行 动态SQL的特性判断功能，那么整条SQL就会显得很复杂和难以阅读（if、trim、foreach等）。</p>
<h3 id="重点：映射原理"><a href="#重点：映射原理" class="headerlink" title="重点：映射原理"></a><strong>重点</strong>：映射原理</h3><p><strong>提问</strong>： Java接口不是实现类，一个没有实现类的接口是怎么运行的？</p>
<p><strong>答案</strong>： 这里运用到了Java语言的动态代理机制。</p>
<p>​    <font color=red>我们会在MyBatis上下文中描述这个接口，而MyBatis会为这个接口生成代理类对象，代理对象会根据 ” 接口全路径 + 方法名“ 去匹配，找到对应的XML文件（或注解）去完成它所需要的任务，返回我们需要的结果。</font></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（一）开发环境准备</title>
    <url>/2020/04/01/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/</url>
    <content><![CDATA[<h2 id="开发环境准备"><a href="#开发环境准备" class="headerlink" title="开发环境准备"></a>开发环境准备</h2><h3 id="下载MyBatis"><a href="#下载MyBatis" class="headerlink" title="下载MyBatis"></a>下载MyBatis</h3><p>最简单的方式是直接访问 MyBatis 托管在Github的官网，从上面下载MyBatis，地址如下：</p>
<p><code>https://github.com/mybatis/mybatis-3/releases</code></p>
<p>该官网可以下载到配置启动MyBatis所需要的Jar包和源码包</p>
<p>使用Mybatis项目可以参考 <a href="https://mybatis.org/mybatis-3/zh/index.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/index.html</a></p>
<img src="http://photo.wushaopei.com/qiniu261.png" width="60%">

<p>使用Mybatis-Spring项目可以参考<a href="http://mybatis.org/spring/zh/index.html" target="_blank" rel="noopener">http://mybatis.org/spring/zh/index.html</a></p>
<img src="http://photo.wushaopei.com/qiniu262.png" width="60%">

<h3 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h3><img src="http://photo.wushaopei.com/qiniu263.png" width="60%">

<p>上图中是MyBatis开发环境所要配置的一些jar包。</p>
<p>​    这里的jar文件分为两类，mybatis打头的jar包是MyBatis本身需要的jar包，另一类如log大头的是在lib文件夹里的。</p>
<p>​    在开发MyBatis项目的过程中只需要在Eclipse项目的lib目录中引入MyBatis的jar即可。如下图：</p>
<img src="http://photo.wushaopei.com/qiniu264.png" width="60%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
        <category>知识树</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（一）映射器的主要元素</title>
    <url>/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%B8%80%EF%BC%89%E6%98%A0%E5%B0%84%E5%99%A8%E7%9A%84%E4%B8%BB%E8%A6%81%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<h2 id="XML-映射器"><a href="#XML-映射器" class="headerlink" title="XML 映射器"></a>XML 映射器</h2><p>MyBatis 的真正强大在于它的语句映射，这是它的魔力所在。由于它的异常强大，映射器的        XML 文件就显得相对简单。如果拿它跟具有相同功能的 JDBC 代码进行对比，你会立即发现省掉了将近       95% 的代码。MyBatis 致力于减少使用成本，让用户能更专注于 SQL 代码。</p>
<p>SQL 映射文件只有很少的几个顶级元素（按照应被定义的顺序列出）：</p>
<ul>
<li><code>cache</code> – 该命名空间的缓存配置。         </li>
<li><code>cache-ref</code>  – 引用其它命名空间的缓存配置。         </li>
<li><code>resultMap</code>  – 描述如何从数据库结果集中加载对象，是最复杂也是最强大的元素。         </li>
<li><code>parameterMap</code>  – 老式风格的参数映射。此元素已被废弃，并可能在将来被移除！请使用行内参数映射。文档中不会介绍此元素。                    </li>
<li><code>sql</code>  – 可被其它语句引用的可重用语句块。         </li>
<li><code>insert</code>  – 映射插入语句。         </li>
<li><code>update</code>  – 映射更新语句。         </li>
<li><code>delete</code>  – 映射删除语句。         </li>
<li><code>select</code>  – 映射查询语句。         </li>
</ul>
<p><strong>下一部分将从语句本身开始来描述每个元素的细节。</strong> </p>
<p>本文转载自 Mybatis 中文官网<a href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/sqlmap-xml.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>映射器的主要元素</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（三）select元素-简易数据类型的例子</title>
    <url>/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%B8%89%EF%BC%89select%E5%85%83%E7%B4%A0-%E7%AE%80%E6%98%93%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%BE%8B%E5%AD%90/</url>
    <content><![CDATA[<h3 id="简单数据类型的例子"><a href="#简单数据类型的例子" class="headerlink" title="简单数据类型的例子"></a>简单数据类型的例子</h3><p>例如，我们需要统计一个用户名的数量。我们应该把用户名作为参数传递，而将结果设置为整形返回给调用者，代码如下所示：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 查询全部的同名对象 --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryUsersCountByName"</span> <span class="attr">resultType</span>=<span class="string">"int"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> &gt;</span></span><br><span class="line"> 		select count(1) from t_user where last_name like concat(#&#123;lastName&#125;,'%') </span><br><span class="line"> <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们在接口UserDao中定义方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">queryUsersCountByName</span><span class="params">(String  lastName)</span></span>;</span><br></pre></td></tr></table></figure>



<p>这样就可以使用MyBatis 调用SQL了，十分简单。下面对操作步骤进行归纳概括。</p>
<ul>
<li>id 标出了这条SQL</li>
<li>parameterType 定义参数类型</li>
<li>resultType 定义返回值类型</li>
</ul>
<p><strong>main</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span> <span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">			UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">int</span> counts = userMapper.queryUsersCountByName(<span class="string">"tom"</span>);</span><br><span class="line">			</span><br><span class="line">			sqlSession.commit();			</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			System.err.println(ex.getMessage());</span><br><span class="line">			sqlSession.rollback();</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSession.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>select元素</tag>
        <tag>简易数据类型的例子</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-映射器（五）select元素-传递多个参数</title>
    <url>/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%BA%94%EF%BC%89select%E5%85%83%E7%B4%A0-%E4%BC%A0%E9%80%92%E5%A4%9A%E4%B8%AA%E5%8F%82%E6%95%B0/</url>
    <content><![CDATA[<h1 id="mybatis的参数传递"><a href="#mybatis的参数传递" class="headerlink" title="mybatis的参数传递"></a><strong>mybatis的参数传递</strong></h1><p>前面的 《mybatis 映射器（四）select元素-自动映射》中的例子是传递一个参数给映射器，大部分情况下我们需要传递多个参数给映射器。</p>
<p>现在我们要根据用户名和性别来查询用户，显然这涉及到了两个参数。</p>
<h3 id="使用多个普通数据类型传参"><a href="#使用多个普通数据类型传参" class="headerlink" title="使用多个普通数据类型传参"></a>使用多个普通数据类型传参</h3><p><strong>配置文件：</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;select id=<span class="string">"queryUserByNameAndSex"</span> resultType=<span class="string">"com.webcode.pojo.User"</span>&gt;</span><br><span class="line">		&lt;!-- </span><br><span class="line">			多个普通类型的参数，在配置sql语句的时候，</span><br><span class="line">			方案一：那么在#&#123;&#125;占位符中，可以写0,1</span><br><span class="line">			<span class="number">0</span>表示第一个参数，<span class="number">1</span>表示第二个参数。（不推荐使用）</span><br><span class="line">			</span><br><span class="line">			方案二：那么在#&#123;&#125;占位符中，可以写param1,param2……</span><br><span class="line">			param1表示第一参数</span><br><span class="line">			param2表示第二个参数</span><br><span class="line">			以此类推 第n个参数，就是paramn</span><br><span class="line">		 --&gt;</span><br><span class="line">		select id,last_name lastName,sex from t_user where last_name = #&#123;param1&#125; and sex = #&#123;param2&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p>对于<strong>UserDao</strong> 接口，我们提供一个方法： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUserByNameAndSex</span><span class="params">(String name, Integer sex)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这种传参方式看起来可以传递多个参数，但是存在传递的参数太多时要多次配置传参，会很麻烦。</p>
<h3 id="使用-Map-传递参数"><a href="#使用-Map-传递参数" class="headerlink" title="使用 Map 传递参数"></a>使用 Map 传递参数</h3><p><strong>配置文件：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryUserByMap"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.pojo.User"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">			当参数是Map类型的时候，sql语句中的参数名必须和map的key一致</span></span><br><span class="line"><span class="comment">			map.put("name",xxx);</span></span><br><span class="line"><span class="comment">			map.put("sex",xxx);</span></span><br><span class="line"><span class="comment">		 --&gt;</span></span><br><span class="line">		select id,last_name lastName,sex from t_user where last_name = #&#123;name&#125; and sex = #&#123;sex&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于UserDao 接口，我们同样提供一个对应的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Map&lt;String, Object&gt; param,我们希望在Map中放name的值和sex的值，来进行查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUserByMap</span><span class="params">(Map&lt;String, Object&gt; param)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这个方法虽然简单易用，但是存在一个弊端：这样设置的参数使用了 Map ， 而 Map 需要键值对应，由于业务关联性不强，你需要深入到程序中看代码，造成可读性下降。 MyBatis 为我们提供了更好的实现方法，它就是注解参数的形式，下面就是它的实现。</p>
<h3 id="使用-Param-注解方式传递参数"><a href="#使用-Param-注解方式传递参数" class="headerlink" title="使用 @Param() 注解方式传递参数"></a>使用 @Param() 注解方式传递参数</h3><p>我们需要使用 MyBatis 的参数注解 @Para（org.apache.ibatis.annotations.Param）来实现想要的功能。操作方法是，把UserDao 接口修改为下面的形式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们把映射器的 XML 修改为无需定义参数类型，如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;select id=<span class="string">"queryUserByNameAndSex"</span> resultType=<span class="string">"com.webcode.pojo.User"</span>&gt;</span><br><span class="line">	&lt;!-- </span><br><span class="line">		<span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUserByNameAndSex</span><span class="params">(@Param(<span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">		@<span class="title">Param</span><span class="params">(<span class="string">"sex"</span>)</span> Integer sex)</span>;</span><br><span class="line">		当我们在方法的参数上使用了<span class="meta">@Param</span>注解给参数进行全名之后，我们可以在配置的sql语句中的占位符里写中参数的名</span><br><span class="line">	 --&gt;</span><br><span class="line">	select id,last_name lastName,sex from t_user where last_name = #&#123;name&#125; and sex = #&#123;sex&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p>当我们把参数传递给后台的时候，通过 @Param 提供的名称 MyBatis 就会知道 #{roleName} 代表 roleName 参数，参数的可读性大大提供了。但是这会引起另一个麻烦，一条 SQL 拥有 10 个参数的查询，如果我们都使用 @Param 方式，那么参数将十分复杂，可读性依旧不高，不过 MyBatis 为我们提供了 JavaBean  定义参数的方式来解决这个问题。</p>
<h3 id="使用-JavaBean-传递参数"><a href="#使用-JavaBean-传递参数" class="headerlink" title="使用 JavaBean 传递参数"></a>使用 JavaBean 传递参数</h3><p>在参数过多的情况下， MyBatis 允许组织一个 JavaBean ， 通过简单的 setter 和 getter 方法设置参数，这样就可以提供我们的可读性。首先，定义一个 UserParams 的 JavaBean ，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserParams</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(Integer id, String lastName, Integer sex)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">		<span class="keyword">this</span>.sex = sex;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String lastName;</span><br><span class="line">	<span class="keyword">private</span> Integer sex;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们用 JavaBean 改写一下传递参数的例子，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;select id&#x3D;&quot;queryUserByUser&quot; resultType&#x3D;&quot;com.webcode.pojo.User&quot;&gt;</span><br><span class="line">		&lt;!-- 当传递的参数是javaBean对象的时候，在sql语句的配置的占位符中，使用属性名 --&gt;</span><br><span class="line">		select id,last_name lastName,sex from t_user where last_name &#x3D; #&#123;lastName&#125; and sex &#x3D; #&#123;sex&#125;</span><br><span class="line">	&lt;&#x2F;select&gt;</span><br></pre></td></tr></table></figure>

<p>同样我们在 UserDao 接口提供一个方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 我们希望使用user对象的lastName属性和sex属性，来进行查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUserByUser</span><span class="params">(User user)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这就是通过 JavaBean 的方式传递多个参数的方式。</p>
<h3 id="使用多个POJO-数据类型传参"><a href="#使用多个POJO-数据类型传参" class="headerlink" title="使用多个POJO 数据类型传参"></a>使用多个POJO 数据类型传参</h3><p>我们用 JavaBean 改写一下传递参数的例子，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 我们希望使用第一个user对象的lastName属性和第二个user对象的sex属性，来进行查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUserByUsers</span><span class="params">(User name,User sex)</span></span>;</span><br></pre></td></tr></table></figure>

<p>配置信息：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryUserByUsers"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.pojo.User"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">		如果参数是多个javaBean的时候，</span></span><br><span class="line"><span class="comment">		第一个javaBean是param1，第二个javaBean是param2.以此类推。</span></span><br><span class="line"><span class="comment">		但我们使用的只是javaBean的属性。#&#123;param1.属性名&#125;	就表示使用第一个javaBean的某个属性的值</span></span><br><span class="line"><span class="comment">	 --&gt;</span></span><br><span class="line">	select id,last_name lastName,sex from t_user where last_name = #&#123;param1.lastName&#125; and sex = #&#123;param2.sex&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上我们描述了4种传递多个参数的方式；</p>
<ul>
<li>使用 Map 传递参数。因为 Map 导致业务可读性的丧失，从而导致后续扩展和维护的困难，我们应该在实际的应用中果断废弃这样的传递参数的方式。</li>
<li>使用 @Param 注解传递多个参数，这种方式的使用受到参数个数（n）的影响。当 n &lt;= 5 时，它 是最佳的传参方式，它比用 JavaBean 更好，因为它更加直观；当 n &gt; 5 时，多个参数将给调用带来困难。</li>
<li>当参数个数多于 5 个时，建议使用 JavaBean 方式。</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>select元素</tag>
        <tag>参数传递</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（二）select元素-概述</title>
    <url>/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%BA%8C%EF%BC%89select%E5%85%83%E7%B4%A0-%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>查询语句是 MyBatis 中最常用的元素之一——光能把数据存到数据库中价值并不大，还要能重新取出来才有用，多数应用也都是查询比修改要频繁。 MyBatis 的基本原则之一是：在每个插入、更新或删除操作之间，通常会执行多个查询操作。 </p>
<p>在执行select 语句前，我们需要定义参数，它可以是一个简单的参数类型，例如 int 、float、String ，也可以是一个复杂的参数类型，例如 JavaBean、Map 等，这些都是MyBatis 接收的参数类型。执行SQL后，MyBatis 也提供了强大的映射规则，甚至是自动映射来帮助我们把返回的结果集绑定到 JavaBean 中。</p>
<h4 id="Select-元素的属性配置"><a href="#Select-元素的属性配置" class="headerlink" title="Select 元素的属性配置"></a>Select 元素的属性配置</h4><table>
<thead>
<tr>
<th>id</th>
<th>在命名空间中唯一的标识符，可以被用来引用这条语句。</th>
</tr>
</thead>
<tbody><tr>
<td>parameterType</td>
<td>将会传入这条语句的参数的类全限定名或别名。这个属性是可选的，因为 MyBatis 可以通过类型处理器（TypeHandler）推断出具体传入语句的参数，默认值为未设置（unset）。</td>
</tr>
<tr>
<td>parameterMap</td>
<td>用于引用外部 parameterMap 的属性，目前已被废弃。请使用行内参数映射和 parameterType 属性。</td>
</tr>
<tr>
<td>resultType</td>
<td>期望从这条语句中返回结果的类全限定名或别名。注意，如果返回的是集合，那应该设置为集合包含的类型，而不是集合本身的类型。                 resultType 和 resultMap 之间只能同时使用一个。</td>
</tr>
<tr>
<td>resultMap</td>
<td>对外部 resultMap 的命名引用。结果映射是 MyBatis 最强大的特性，如果你对其理解透彻，许多复杂的映射问题都能迎刃而解。resultType 和 resultMap 之间只能同时使用一个。</td>
</tr>
<tr>
<td>flushCache</td>
<td>将其设置为 true 后，只要语句被调用，都会导致本地缓存和二级缓存被清空，默认值：false。</td>
</tr>
<tr>
<td>useCache</td>
<td>将其设置为 true 后，将会导致本条语句的结果被二级缓存缓存起来，默认值：对 select 元素为 true。</td>
</tr>
<tr>
<td>timeout</td>
<td>这个设置是在抛出异常之前，驱动程序等待数据库返回请求结果的秒数。默认值为未设置（unset）（依赖数据库驱动）。</td>
</tr>
<tr>
<td>fetchSize</td>
<td>这是一个给驱动的建议值，尝试让驱动程序每次批量返回的结果行数等于这个设置值。 默认值为未设置（unset）（依赖驱动）。</td>
</tr>
<tr>
<td>statementType</td>
<td>可选 STATEMENT，PREPARED 或 CALLABLE。这会让 MyBatis 分别使用                 Statement，PreparedStatement 或 CallableStatement，默认值：PREPARED。</td>
</tr>
<tr>
<td>resultSetType</td>
<td>FORWARD_ONLY，SCROLL_SENSITIVE, SCROLL_INSENSITIVE 或                DEFAULT（等价于 unset） 中的一个，默认值为 unset （依赖数据库驱动）。</td>
</tr>
<tr>
<td>databaseId</td>
<td>如果配置了数据库厂商标识（databaseIdProvider），MyBatis                 会加载所有不带 databaseId 或匹配当前 databaseId 的语句；如果带和不带的语句都有，则不带的会被忽略。</td>
</tr>
<tr>
<td>resultOrdered</td>
<td>这个设置仅针对嵌套结果 select 语句：如果为true，将会假设包含了嵌套结果集或是分组，当返回一个主结果行时，就不会产生对前面结果集的引用。这就使得在获取嵌套结果集的时候不至于内存不够用。默认值：<code>false</code>。</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>映射器的主要元素</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（六）select元素-使用resultMap 映射结果集</title>
    <url>/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E5%85%AD%EF%BC%89select%E5%85%83%E7%B4%A0-%E4%BD%BF%E7%94%A8resultMap-%E6%98%A0%E5%B0%84%E7%BB%93%E6%9E%9C%E9%9B%86/</url>
    <content><![CDATA[<p>前面讲到了自动映射，但是在某些时候，我们需要处理更为复杂的映射， resultMap 为我们提供了这样的模式。我们需要在映射器中定义 resultMap ，这也是我们常见的场景，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"com.webcode.cn.entity.User"</span> <span class="attr">id</span>=<span class="string">"userResultMap"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"last_name"</span> <span class="attr">column</span>=<span class="string">"lastName"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserById"</span> <span class="attr">resultMap</span>=<span class="string">"userResultMap"</span>&gt;</span></span><br><span class="line">  	select id,last_name,sex from t_user where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>会话工厂工具类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SqlSessionFactoryUtil.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月7日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryUtil</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// SqlSessionFactory对象</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 类线程锁</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class CLASS_LOCK = SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 私有化构造参数 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtil</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构建SqlSessionFactory </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">initSqlSessionFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//		String resource = "mybatis-config.xml";</span></span><br><span class="line"><span class="comment">//		String resource = "mybatis-property.xml";</span></span><br><span class="line">		String resource = <span class="string">"mybatis-properties.xml"</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">		&#125;<span class="keyword">catch</span> (IOException ex)&#123;</span><br><span class="line">			Logger.getLogger(SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()).<span class="title">log</span>(<span class="title">Level</span>.<span class="title">SEVERE</span>,<span class="title">null</span>,<span class="title">ex</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">synchronized</span>(CLASS_LOCK)&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 打开 SqlSession </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title">openSqlSession</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">			initSqlSessionFactory();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>main 执行 使用该 resultMap 的映射器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span> <span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">		SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">			UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			User s = userMapper.selectUserById(<span class="number">2</span>);</span><br><span class="line">			System.out.println(s.toString());</span><br><span class="line">			sqlSession.commit();			</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			System.err.println(ex.getMessage());</span><br><span class="line">			sqlSession.rollback();</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSession.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - <span class="tag">&lt;<span class="name">==</span>      <span class="attr">Total:</span> <span class="attr">1</span></span></span><br><span class="line"><span class="tag"><span class="attr">User</span>(<span class="attr">id</span>=<span class="string">2,</span> <span class="attr">lastName</span>=<span class="string">null,</span> <span class="attr">sex</span>=<span class="string">1)</span></span></span><br><span class="line"><span class="tag"><span class="attr">DEBUG</span> [<span class="attr">main</span>] <span class="attr">-</span> <span class="attr">Committing</span> <span class="attr">JDBC</span> <span class="attr">Connection</span> [<span class="attr">com.mysql.cj.jdbc.ConnectionImpl</span>@<span class="attr">71d15f18</span>]</span></span><br><span class="line"><span class="tag"><span class="attr">DEBUG</span> [<span class="attr">main</span>] <span class="attr">-</span> <span class="attr">Resetting</span> <span class="attr">autocommit</span> <span class="attr">to</span> <span class="attr">true</span> <span class="attr">on</span> <span class="attr">JDBC</span> <span class="attr">Connection</span> [<span class="attr">com.mysql.cj.jdbc.ConnectionImpl</span>@<span class="attr">71d15f18</span>]</span></span><br><span class="line"><span class="tag"><span class="attr">DEBUG</span> [<span class="attr">main</span>] <span class="attr">-</span> <span class="attr">Closing</span> <span class="attr">JDBC</span> <span class="attr">Connection</span> [<span class="attr">com.mysql.cj.jdbc.ConnectionImpl</span>@<span class="attr">71d15f18</span>]</span></span><br><span class="line"><span class="tag"><span class="attr">DEBUG</span> [<span class="attr">main</span>] <span class="attr">-</span> <span class="attr">Returned</span> <span class="attr">connection</span> <span class="attr">1909546776</span> <span class="attr">to</span> <span class="attr">pool.</span></span></span><br></pre></td></tr></table></figure>

<p>这里解释一下 resultMap 的配置：</p>
<ul>
<li>定义了一个唯一标识（id) 为 userResultMap 的 resultMap ， 用 type 属性去定义它对应的是哪个 JavaBean（或别名）</li>
<li>通过 id  元素定义 resultResultMap, 这个对象代表着使用哪个属性作为其主键。 result 元素定义普通列的映射关系，例如，把 SQL 结果返回的列user_no 和 type 属性定义 JavaBean 的属性userNo 等做一一对应。</li>
<li>这样 select 语句就不再需要使用自动映射的规则，直接用 resultMap 属性指定 userResultMap 即可，这样MyBatis 就会使用我们的自定义映射规则。</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>select元素</tag>
        <tag>resultMap</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（十一）resultMap结果映射集</title>
    <url>/2020/04/28/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89resultMap%E7%BB%93%E6%9E%9C%E6%98%A0%E5%B0%84%E9%9B%86/</url>
    <content><![CDATA[<p>​    <code>resultMap</code> 元素是 MyBatis 中最重要最强大的元素。 它可以让你从 90% 的 JDBC <code>ResultSets</code> 数据提取代码中解放出来，并在一些情形下允许你进行一些 JDBC 不支持的操作。实际上，在为一些比如连接的复杂语句编写映射代码的时候，一份 <code>resultMap</code> 能够代替实现同等功能的数千行代码。ResultMap 的设计思想是，对简单的语句做到零配置，对于复杂一点的语句，只需要描述语句之间的关系就行了。 </p>
<p>​    resultMap 定义的主要是一个结果集的映射关系，主要针对复杂 Bean 对象。</p>
<p>​    <strong>复杂 bean 对象，</strong> 原来我们查询出来的结果，封装的对象里面的属性都是普通的属性。不包含子的javaBean对象。也不包含Bean对象的集合。那种叫普通的javabean。那些Bean对象中又包含了子的Bean对象的情况，或者是Bean对象中又包含的bean对象集合的情况，叫复杂的Bean对象。</p>
<p>​    这种情况，只能使用ResultMap标签来将结果集转换成为复杂的Bean对象。而简单的不需要。简单的Bean对象，只需要使用ResultType属性即可。</p>
<p>​    MyBatis 现有的版本只支持 resultMap 查询，不支持更新或者保存，更不必说级联的更新、删除和修改了。</p>
<h3 id="resultMap-元素的构成"><a href="#resultMap-元素的构成" class="headerlink" title="resultMap 元素的构成"></a>resultMap 元素的构成</h3><p>resultMap 元素里面所包含的元素有：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">idArg</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">arg</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">discriminator</span> <span class="attr">javaType</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 constructor 元素用于配置构造方法。一个 POJO 可能不存在没有参数的构造方法，这个时候我们就可以使用 constructor 进行配置。假设用户类 User 不存在没有参数的构造方法，它的构造方法声明为 public  User(Integer id , String lastName) , 那我们需要配置这个结果集，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">idArg</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">javaType</span>=<span class="string">"int"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">arg</span> <span class="attr">column</span>=<span class="string">"lastName"</span> <span class="attr">javaType</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    这样 MyBatis 就知道需要用这个构造方法来构造 POJO 了。</p>
<p>​    id 元素是表示哪个列是主键，允许多个主键，多个主键则称为联合主键。 result 是配置 POJO 到 SQL 列名的映射关系。</p>
<h4 id="result-元素和-id-元素的属性"><a href="#result-元素和-id-元素的属性" class="headerlink" title="result 元素和 id 元素的属性"></a>result 元素和 id 元素的属性</h4><table>
<thead>
<tr>
<th>元素名称</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>property</td>
<td>映射到列结果的字段或属性。如果 pojo 的属性匹配的是存在的，和给定 SQL 列名 (column元素) 相同的，那么 MyBatis 就会映射到 POJO 上</td>
<td>可以使用导航式的字段，比如访问一个学生对象（Studeng)需要访问学生证（selfcard)的发证日期（issueDat），那么我们可以写成selfcard.issueDate</td>
</tr>
<tr>
<td>column</td>
<td>这里对应的是 SQL 的列</td>
<td></td>
</tr>
<tr>
<td>javaType</td>
<td>配置 Java 的类型</td>
<td>可以是特定的类完全限定名或者 MyBatis 上下文的别名</td>
</tr>
<tr>
<td>jdbcType</td>
<td>配置数据库类型</td>
<td>这是一个 JDBC 的类型， MyBatis 已经为我们做了限定，基本支持所有常用的数据库类型</td>
</tr>
<tr>
<td>typeHandler</td>
<td>类型处理器</td>
<td>允许你用特定的处理器来覆盖 MyBatis 默认的处理器。这就要指定 javaType 和 javaType 相互转化的规则</td>
</tr>
</tbody></table>
<h3 id="使用-map-存储结果集"><a href="#使用-map-存储结果集" class="headerlink" title="使用 map 存储结果集"></a>使用 map 存储结果集</h3><p>一般而言，任何的 select 语句都可以使用 map 存储，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;select id&#x3D;&quot;selectUserByName&quot; resultType&#x3D;&quot;map&quot; parameterType&#x3D;&quot;com.webcode.cn.entity.User&quot;&gt;</span><br><span class="line">  	select id,last_name lastName,sex from t_user where last_name &#x3D; $&#123;lastName&#125; and sex &#x3D; #&#123;sex&#125;</span><br><span class="line">&lt;&#x2F;select&gt;</span><br></pre></td></tr></table></figure>

<p>使用 map 原则上是可以匹配所有结果集的，但是使用 map 接口就意味着可读性的下降，所以这不是一种推荐的方式。更多的时候我们使用的是 POJO 的方式。</p>
<h3 id="使用-POJO-存储结果集"><a href="#使用-POJO-存储结果集" class="headerlink" title="使用 POJO 存储结果集"></a>使用 POJO 存储结果集</h3><p>使用 map 方式就意味着可读性的丢失。 POJO 是我们最常用的方式，也是我们推荐的方式。一方面我们可以使用自动映射，正如 select 语句里论述的一样。我们还可以使用 select 语句的属性 resultMap 配置映射集合，只是使用前需要配置类似的 resultMap ，如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"com.webcode.cn.entity.User"</span> <span class="attr">id</span>=<span class="string">"userResultMap"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"last_name"</span> <span class="attr">column</span>=<span class="string">"lastName"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    resultMap 元素的属性 id 代表这个 resultMap 的标识，type 代表着你需要映射的 POJO 。我们可以使用 MyBatis 定义好的类的别名，也可以使用自定义的类的全限定名。</p>
<p>​    映射关系中， id 元素表示这个对象的主键， property 代表着 POJO 的属性名称， column 表示数据库 SQL 的列名，于是 POJO 就和数据库 SQL 结果一一对应起来了。接着我们在映射文件中的 select 元素里面就可以引用 resultMap 的配置，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserById"</span> <span class="attr">resultMap</span>=<span class="string">"userResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">  	select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"user_columns"</span>/&gt;</span> from t_user where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们可以发现 SQL 语句的列名和  userResultMap 的 column 是一一对应的。使用 XML 配置的结果集，我们还可以配置 typeHandler、javaType 、 jdbcType，但是这条语句配置了 resultMap 就不能再配置 resultType 了。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>resultMap结果映射集</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（三）Hibernate</title>
    <url>/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%89%EF%BC%89Hibernate/</url>
    <content><![CDATA[<h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>​    基于JDBC在企业级开发过程中频繁建立连接等对资源与性能无法兼顾的弊端。</p>
<p>​    基于这个需求，互联网企业Sun公司推出了一个ORM模型框架——Hibernate 。</p>
<h2 id="Hiberate"><a href="#Hiberate" class="headerlink" title="Hiberate"></a>Hiberate</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Hibernate 是建立在若干POJO通过XML映射文件（或注解）提供的规则映射到数据库表上的。换句话说，我们可以通过POJO直接操作数据库的数据。它提供的是一种全表映射的模型。</p>
<h3 id="回顾一下JDBC写程序的历程"><a href="#回顾一下JDBC写程序的历程" class="headerlink" title="回顾一下JDBC写程序的历程"></a>回顾一下JDBC写程序的历程</h3><ol>
<li><strong>在DAO层操作XML，将数据封装到XML文件上，读写XML文件数据实现CRUD</strong></li>
<li><strong>在DAO层使用原生JDBC连接数据库，实现CRUD</strong></li>
<li><strong>再调用JDBC的Connection\Statement\ResultSet等对象实现对DB的操作和事务管理</strong></li>
</ol>
<h3 id="Hibernate-开发流程示意图"><a href="#Hibernate-开发流程示意图" class="headerlink" title="Hibernate 开发流程示意图"></a>Hibernate 开发流程示意图</h3><img src="http://photo.wushaopei.com/qiniu243.png" width="80%">

<p>相对而言，Hibernate对JDBC 的封装程度还是比较高的，我们已经不需要编写SQL语言，只要使用HQL语言就可以了。</p>
<h3 id="Hibernate-的优缺点"><a href="#Hibernate-的优缺点" class="headerlink" title="Hibernate 的优缺点"></a>Hibernate 的优缺点</h3><ol>
<li><p>hibernate在配置好关系后，可直接对对象进行操作，让使用会话对象的方法实现对数据库的crud操作，而mybatis则需要手动编写sql语句，这样一对比，hibernate的开发速度要优于mybatis,但同时问题也出现了，在面对一些高级查询时，hibernate则是显得有些力不从心了，hibernate的sql语句是写死的，有时候一些字段我们并不需要查询或者修改，但是他封装的是全部，虽然我们可以手动设置字段，但是却破坏了hibernate的简洁性。而mybatis则可以自己手动编写sql进行优化，且有动态sql的功能，可以优化sql. </p>
</li>
<li><p>hibernate有自己的缓存机制，mybatis则没有，而现在大多数都是使用第三方缓存，所以这个优点已被抹去。</p>
</li>
<li><p>hibernate相对来说是重量级的，入门门槛高，而mybatis则是轻量级封装jdbc,可以现学现用。</p>
</li>
</ol>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（四）select元素-自动映射</title>
    <url>/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E5%9B%9B%EF%BC%89select%E5%85%83%E7%B4%A0-%E8%87%AA%E5%8A%A8%E6%98%A0%E5%B0%84/</url>
    <content><![CDATA[<p>在MyBatis 中，有这么一个参数 <code>autoMapping</code>  ，如果设置这个属性，MyBatis 将会为本结果映射开启或者关闭自动映射。 这个属性会覆盖全局的属性 autoMappingBehavior。默认值：未设置（unset）。 </p>
<p>在默认开启自动映射的情况下，只要返回的 SQL 列名和 JavaBean 的属性一致，MyBatis 就会帮助我们回填这些字段而无需任何配置，它可以在很大程度上简化我们的配置工作。</p>
<p>而在实际的情况中，大部分的数据库规范要求每个单词用下划线分割，而 Java 则是用驼峰命名法来命名，于是使用列的别名就可以使得 MyBatis 自动映射，或者直接在配置文件中开启驼峰命名方式。</p>
<p>案例演示，这里通过用户名查询一个用户的信息，并将结果集映射到角色的 JavaBean 上。我们先给出 JavaBean , 如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> User.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月5日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(Integer id, String lastName, Integer sex)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">		<span class="keyword">this</span>.sex = sex;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String lastName;</span><br><span class="line">	<span class="keyword">private</span> Integer sex;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据库表 （t_user) 字段如下：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>用户id，主键，递增</td>
</tr>
<tr>
<td>last_name</td>
<td>varchar</td>
<td>用户名</td>
</tr>
<tr>
<td>sex</td>
<td>int</td>
<td>性别</td>
</tr>
</tbody></table>
<p>编写 UserMapper 的映射语句，这里根据 用户id 获取用户的所有信息：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserById"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.cn.entity.User"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">    	select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为映射器语句配置一个 Dao 接口 中对应的方法，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 该接口中的 方法名需要与映射的语句的 id 一致。</p>
<p>通过以上的配置，我们就可以使用它，用户名称（last_name) 使用SQL 提供的别名功能使得查询结果和 JavaBean 的属性一一对应起来，然后 MyBatis 提供的自动映射的功能使得我们无需过多的提供配置信息，大大地减少了我们的工作量。</p>
<p>​    自动映射可以在 setting 元素中配置  <code>autoMappingBehavior</code> 属性值来设置其策略。它包含3个值。</p>
<ul>
<li>NONE , 取消自动映射</li>
<li>PARTIAL , 只会自动映射，没有定义嵌套结果集映射的结果集</li>
<li>FULL ， 会自动映射任意复杂的结果集（无论是否嵌套）。</li>
</ul>
<p>默认值为 PARTIAL。所以在默认的情况下，它可以做到当前对象的映射，使用 FULL 是嵌套映射，在性能上会下降。</p>
<p>​    如果你的数据库是规范命名的，即使每一个单词都用下划线分隔， POJO 采用驼峰式命名方法，那么你也可以设置 mapUnderscoreToCamelCase 为 true , 这样就可以实现从数据库到 POJO 的自动映射了。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 自动开启驼峰命名 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 是否开自动映射 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"autoMappingBehavior"</span> <span class="attr">value</span>=<span class="string">"FULL "</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>select元素</tag>
        <tag>自动映射</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（八）update元素和delete元素</title>
    <url>/2020/04/23/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E5%85%AB%EF%BC%89update%E5%85%83%E7%B4%A0%E5%92%8Cdelete%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<p>数据变更语句 insert，update 和 delete 的实现非常接近，这里我们将三者的属性配置放到一起比较一下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span>  </span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">"insertAuthor"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">parameterType</span>=<span class="string">"domain.blog.Author"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">flushCache</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">statementType</span>=<span class="string">"PREPARED"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keyProperty</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keyColumn</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">  <span class="attr">useGeneratedKeys</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">  <span class="attr">timeout</span>=<span class="string">"20"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">update</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">"updateAuthor"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">parameterType</span>=<span class="string">"domain.blog.Author"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">flushCache</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">statementType</span>=<span class="string">"PREPARED"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">timeout</span>=<span class="string">"20"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">"deleteAuthor"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">parameterType</span>=<span class="string">"domain.blog.Author"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">flushCache</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">statementType</span>=<span class="string">"PREPARED"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">timeout</span>=<span class="string">"20"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>和 insert 元素一样， MyBatis 执行完 update 元素和 delete 元素后会返回一个整数，标出执行后影响的记录条数。</p>
<p>下面我们来配置一下 更新和删除用户的 xml 文件，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--   根据id删除一个用户 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUserById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">		delete from t_user where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span></span><br><span class="line">		update t_user set last_name = #&#123;lastName&#125;,sex = #&#123;sex&#125; where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>大部分情况下，开发过程中锁面对的场景都和这相似，需要通过一个 JavaBean 插入一张表的记录或者根据主键删除记录，对于参数传递可以参考 select 元素传递参数的例子。插入和删除执行完成 MyBatis 会返回一个整数显示更新或删除了几条记录。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>update元素</tag>
        <tag>delete元素</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（五）什么时候用MyBatis</title>
    <url>/2020/04/01/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%94%EF%BC%89%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8MyBatis/</url>
    <content><![CDATA[<p>​    通过前面对JDBC、Hibernate和MyBatis的介绍，我们有了一些认识。</p>
<p>​    JDBC的方式在目前的企业级开发中是极少用到，因为要提供的代码太多，开发过程太繁琐而冗余，以及容易出错，并不推荐这一种方式；适用于直接使用JDBC的业务场景也是极少的。</p>
<p>​    Hibernate作为较流行的Java ORM框架，它的全自动映射使得编程更简易也方便，只需要我们提供映射规则，就可以通过IDE生成，不需要手动去编写SQL，这对于开发者的SQL编写能力要求不高，相对的减少了工作量，效率上要优于MyBatis。同时，Hibernate也提供了缓存、日志、级联映射等功能。但Hibernate的缺陷也极其明显，多表关联复杂SQL，数据系统权限限制，根据条件变化的SQL，存储过程等场景的使用相对于Hibernate来说会显得力有不逮，并且无法通过SQL进行效率上的增删改查上的优化。所以注定了Hibernate只适用于在场景不太复杂，性能要求不苛刻，数据模型规范严格的情况下使用。</p>
<p>​    反观，Mybatis 由于半自动化映射的关系，其更加具有灵活性，作为一个可以动态生成映射关系的框架，MyBatis会是一个更好的选择。其底层对JDBC进行了封装，拥有动态列、动态表名、并支持存储过程，同样具有 缓存、日志、级联映射的强大的功能。</p>
<p>​    Mybatis的缺点是映射规则需要开发者自己进行创建并提供，以及要根据具体的业务需求编写SQL语句，所以，其开发量要远大于Hibernate.</p>
<p>​    虽然说，在实际开发中，我们是需要根据项目的具体业务场景去选择对应的框架来对DAO进行管理操作。但是，由于Mybatis 的各方面性能的优越性，以及后来出现的Mybatis-Plush，现在MyBatis体系在企业开发中的占比越来越高，仅其动态列、动态表名所能够实现的动态SQL语句就能在开发过程中对同一个DAO进行复用而减少在DAO持久层的编码量，提高开发效率。所以，目前MyBatis在新立项的开发项目中将是一个更好的选择。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
        <tag>场景</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（七）environments 配置环境</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%83%EF%BC%89environments-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<h2 id="环境配置（environments）"><a href="#环境配置（environments）" class="headerlink" title="环境配置（environments）"></a>环境配置（environments）</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>MyBatis 可以配置成适应多种环境，这种机制有助于将 SQL 映射应用于多种数据库之中，现实情况下有多种理由需要这么做。例如，开发、测试和生产环境需要有不同的配置；或者想在具有相同 Schema的多个生产数据库中使用相同的 SQL 映射。还有许多类似的使用场景。</p>
<p><strong>不过要记住：尽管可以配置多个环境，但每个 SqlSessionFactory 实例只能选择一种环境。</strong>         </p>
<p>​           所以，如果你想连接两个数据库，就需要创建两个 SqlSessionFactory实例，每个数据库对应一个。而如果是三个数据库，就需要三个实例，依此类推，记起来很简单：         </p>
<ul>
<li><strong>每个数据库对应一个 SqlSessionFactory 实例</strong>          </li>
</ul>
<p>为了指定创建哪种环境，只要将它作为可选的参数传递给 SqlSessionFactoryBuilder 即可。可以接受环境配置的两个方法签名是： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SqlSessionFactory factory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(reader, environment);</span><br><span class="line">SqlSessionFactory factory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(reader, environment, properties);</span><br></pre></td></tr></table></figure>

<p>如果忽略了环境参数，那么将会加载默认环境，如下所示： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SqlSessionFactory factory &#x3D; new SqlSessionFactoryBuilder().build(reader);</span><br><span class="line">SqlSessionFactory factory &#x3D; new SqlSessionFactoryBuilder().build(reader, properties);</span><br></pre></td></tr></table></figure>

<p>environments 元素定义了如何配置环境。 </p>
<h3 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h3><h4 id="连接池的数据源配置如下："><a href="#连接池的数据源配置如下：" class="headerlink" title="连接池的数据源配置如下："></a><strong>连接池的数据源配置如下：</strong></h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"autoCommit"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8<span class="symbol">&amp;amp;</span>serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析一下上面的配置"><a href="#分析一下上面的配置" class="headerlink" title="分析一下上面的配置"></a>分析一下上面的配置</h4><ul>
<li><p>environments 中的属性 default ， 标明在缺省的情况下，我们将启用哪个数据源配置。</p>
</li>
<li><p>environment  元素是配置一个数据源的开始，属性 id 是设置这个数据源的标志，以便MyBatis 上下文使用它。</p>
</li>
<li><p>transactionManager 配置的是数据库事务，其中 type 属性有3种配置方式。 </p>
<p> (1)  JDBC , 采用 JDBC 方式管理事务，在独立编码中我们常常使用</p>
<p> (2) MANAGED  , 采用容器方式管理事务，在 JNDI 数据源中常用</p>
<p> (3) 由使用者自定义数据库事务管理方法，适用于特殊应用</p>
</li>
<li><p>property  元素则是可以配置数据源的各类属性，我们这里配置了 autoCommit = false , 则是要求数据源不自动提交。</p>
</li>
<li><p>dataSource 标签，是配置数据源连接的信息， type 属性是提供我们对数据库连接方式的配置，通过杨MyBatis 提供这么几种配置方式 :</p>
<p>(1) UNPOOLED, 非连接池数据库（UnpooledDataSource);</p>
<p>(2) POOLED ， 连接池数据库 (PooledDataSource);</p>
<p>(3) JNDI， JNDI 数据源（JNDIDataSource);</p>
<p>(4) 自定义数据源</p>
<p>其中，配置的property元素，就是定义数据库的各类参数</p>
</li>
</ul>
<h3 id="数据源的实现代码"><a href="#数据源的实现代码" class="headerlink" title="数据源的实现代码"></a>数据源的实现代码</h3><p>这里使用C3P0来实现：</p>
<p>你可以通过实现接口 <code>org.apache.ibatis.datasource.DataSourceFactory</code> 来使用第三方数据源实现： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceFactory</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span></span>;</span><br><span class="line">  <span class="function">DataSource <span class="title">getDataSource</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory</code> 可被用作父类来构建新的数据源适配器，比如下面这段插入 C3P0 数据源所必需的代码： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3P0DataSourceFactory</span> <span class="keyword">extends</span> <span class="title">UnpooledDataSourceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">C3P0DataSourceFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.dataSource = <span class="keyword">new</span> ComboPooledDataSource();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了令其工作，记得在配置文件中为每个希望 MyBatis 调用的 setter 方法增加对应的属性。 下面是一个可以连接至 PostgreSQL 数据库的例子： </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dataSource type=<span class="string">"org.myproject.C3P0DataSourceFactory"</span>&gt;</span><br><span class="line">  &lt;property name=<span class="string">"driver"</span> value=<span class="string">"org.postgresql.Driver"</span>/&gt;</span><br><span class="line">  &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:postgresql:mydb"</span>/&gt;</span><br><span class="line">  &lt;property name=<span class="string">"username"</span> value=<span class="string">"postgres"</span>/&gt;</span><br><span class="line">  &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">&lt;/dataSource&gt;</span><br></pre></td></tr></table></figure>



<h3 id="事务管理器（transactionManager）"><a href="#事务管理器（transactionManager）" class="headerlink" title="事务管理器（transactionManager）"></a><strong>事务管理器（transactionManager）</strong></h3><p>在 MyBatis 中有两种类型的事务管理器（也就是 type=”[JDBC|MANAGED]”）： </p>
<ul>
<li><p>JDBC – 这个配置直接使用了 JDBC 的提交和回滚设施，它依赖从数据源获得的连接来管理事务作用域。           </p>
</li>
<li><p>MANAGED – 这个配置几乎没做什么。它从不提交或回滚一个连接，而是让容器来管理事务的整个生命周期（比如 JEE 应用服务器的上下文）。             默认情况下它会关闭连接。然而一些容器并不希望连接被关闭，因此需要将 closeConnection 属性设置为 false 来阻止默认的关闭行为。例如: </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"MANAGED"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"closeConnection"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>提示</strong> 如果你正在使用 Spring + MyBatis，则没有必要配置事务管理器，因为 Spring 模块会使用自带的管理器来覆盖前面的配置。   </p>
<p>这两种事务管理器类型都不需要设置任何属性。它们其实是类型别名，换句话说，你可以用 TransactionFactory 接口实现类的全限定名或类型别名代替它们。 </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionFactory</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span> </span>&#123; <span class="comment">// 从 3.5.2 开始，该方法为默认方法</span></span><br><span class="line">    <span class="comment">// 空实现</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(Connection conn)</span></span>;</span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(DataSource dataSource, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在事务管理器实例化后，所有在 XML 中配置的属性将会被传递给 setProperties() 方法。你的实现还需要创建一个 Transaction 接口的实现类，这个接口也很简单： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line">  <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function">Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h3><p>数据库事务 MyBatis 是交由 SqlSession 去控制的，我们可以通过 SqlSession 提交 (commit) 或者回滚（rollback) 。 我们插入一个角色对象，如果成功就提交，否则就回滚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">	UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	User user = <span class="keyword">new</span> User();</span><br><span class="line">	user.setLastName(<span class="string">"tom"</span>);</span><br><span class="line">	user.setSex(<span class="number">1</span>);</span><br><span class="line">	userMapper.saveUser(user);</span><br><span class="line">	userMapper.deleteUserById(<span class="number">1</span>);</span><br><span class="line">	userMapper.updateUser(<span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"jetty"</span>,<span class="number">1</span>));</span><br><span class="line">	sqlSession.commit();			</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">	System.err.println(ex.getMessage());</span><br><span class="line">	sqlSession.rollback();</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在大部分的工作环境下，我们都会使用 Spring  框架来控制它</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>environments</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-知识树目录</title>
    <url>/2020/03/12/mybatis-%E7%9F%A5%E8%AF%86%E6%A0%91%E7%9B%AE%E5%BD%95/</url>
    <content><![CDATA[<h2 id="MyBatis简介"><a href="#MyBatis简介" class="headerlink" title="MyBatis简介"></a>MyBatis简介</h2><h3 id="传统的JDBC编程"><a href="#传统的JDBC编程" class="headerlink" title="传统的JDBC编程"></a><a href="http://wushaopei.com/2020/03/12/mybatis%20%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%80%EF%BC%89%E4%BC%A0%E7%BB%9F%E7%9A%84JDBC%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%8D%E8%B6%B3/" target="_blank" rel="noopener">传统的JDBC编程</a></h3><h3 id="ORM模型"><a href="#ORM模型" class="headerlink" title="ORM模型"></a><a href="https://blog.wushaopei.com/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%8C%EF%BC%89ORM-%E6%A8%A1%E5%9E%8B-1/">ORM模型</a></h3><h3 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a><a href="https://blog.wushaopei.com/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%B8%89%EF%BC%89Hibernate/">Hibernate</a></h3><h3 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a><a href="https://blog.wushaopei.com/2020/03/30/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E5%9B%9B%EF%BC%89Mybatis/">MyBatis</a></h3><h3 id="什么时候用MyBatis"><a href="#什么时候用MyBatis" class="headerlink" title="什么时候用MyBatis"></a><a href="https://blog.wushaopei.com/2020/04/01/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%94%EF%BC%89%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8MyBatis/">什么时候用MyBatis</a></h3><h2 id="MyBatis-入门"><a href="#MyBatis-入门" class="headerlink" title="MyBatis 入门"></a>MyBatis 入门</h2><h3 id="开发环境准备"><a href="#开发环境准备" class="headerlink" title="开发环境准备"></a><a href="https://blog.wushaopei.com/2020/04/01/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/">开发环境准备</a></h3><h4 id="构建SqlSessionFactory"><a href="#构建SqlSessionFactory" class="headerlink" title="构建SqlSessionFactory"></a><a href="https://blog.wushaopei.com/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%8C%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E6%9E%84%E5%BB%BASqlSessionFactory/">构建SqlSessionFactory</a></h4><h4 id="创建SqlSession"><a href="#创建SqlSession" class="headerlink" title="创建SqlSession"></a><a href="https://blog.wushaopei.com/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%89%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E5%88%9B%E5%BB%BASqlSession/">创建SqlSession</a></h4><h4 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a><a href="https://blog.wushaopei.com/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E5%9B%9B%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E6%98%A0%E5%B0%84%E5%99%A8/">映射器</a></h4><h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a><a href="https://blog.wushaopei.com/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%94%EF%BC%89%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">生命周期</a></h3><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a><a href="https://blog.wushaopei.com/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E5%85%AD%EF%BC%89%E5%AE%9E%E4%BE%8B/">实例</a></h3><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="properties"><a href="#properties" class="headerlink" title="properties"></a><a href="https://blog.wushaopei.com/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%80%EF%BC%89properties-%E5%85%83%E7%B4%A0/">properties</a></h3><h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a><a href="https://blog.wushaopei.com/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BA%8C%EF%BC%89%E8%AE%BE%E7%BD%AE/">设置</a></h3><h3 id="别名"><a href="#别名" class="headerlink" title="别名"></a><a href="https://blog.wushaopei.com/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%89%EF%BC%89%E5%88%AB%E5%90%8D/">别名</a></h3><h3 id="typeHandler类型处理器"><a href="#typeHandler类型处理器" class="headerlink" title="typeHandler类型处理器"></a><a href="https://blog.wushaopei.com/2020/04/16/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%9B%9B%EF%BC%89typeHandler-%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8-%E7%B3%BB%E7%BB%9F%E5%AE%9A%E4%B9%89/">typeHandler类型处理器</a></h3><h3 id="ObjectFactory"><a href="#ObjectFactory" class="headerlink" title="ObjectFactory"></a><a href="https://blog.wushaopei.com/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BA%94%EF%BC%89ObjectFactory/">ObjectFactory</a></h3><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a><a href="https://blog.wushaopei.com/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%85%AD%EF%BC%89%E6%8F%92%E4%BB%B6/">插件</a></h3><h3 id="environments-配置环境"><a href="#environments-配置环境" class="headerlink" title="environments 配置环境"></a><a href="https://blog.wushaopei.com/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%83%EF%BC%89environments-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83/">environments 配置环境</a></h3><h3 id="引入映射器的方法"><a href="#引入映射器的方法" class="headerlink" title="引入映射器的方法"></a><a href="https://blog.wushaopei.com/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B9%9D%EF%BC%89%E5%BC%95%E5%85%A5%E6%98%A0%E5%B0%84%E5%99%A8%E7%9A%84%E6%96%B9%E6%B3%95/">引入映射器的方法</a></h3><h2 id="映射器-1"><a href="#映射器-1" class="headerlink" title="映射器"></a>映射器</h2><h3 id="映射器的主要元素"><a href="#映射器的主要元素" class="headerlink" title="映射器的主要元素"></a><a href="https://blog.wushaopei.com/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%B8%80%EF%BC%89%E6%98%A0%E5%B0%84%E5%99%A8%E7%9A%84%E4%B8%BB%E8%A6%81%E5%85%83%E7%B4%A0/">映射器的主要元素</a></h3><h3 id="select-元素-概述"><a href="#select-元素-概述" class="headerlink" title="select 元素 - 概述"></a><a href="https://blog.wushaopei.com/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%BA%8C%EF%BC%89select%E5%85%83%E7%B4%A0-%E6%A6%82%E8%BF%B0/">select 元素 - 概述</a></h3><h4 id="select-元素-简易数据类型的例子"><a href="#select-元素-简易数据类型的例子" class="headerlink" title="select 元素-简易数据类型的例子"></a><a href="https://blog.wushaopei.com/2020/04/21/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%B8%89%EF%BC%89select%E5%85%83%E7%B4%A0-%E7%AE%80%E6%98%93%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%BE%8B%E5%AD%90/">select 元素-简易数据类型的例子</a></h4><h4 id="自动映射"><a href="#自动映射" class="headerlink" title="自动映射"></a>自动映射</h4><h4 id="传递多个参数"><a href="#传递多个参数" class="headerlink" title="传递多个参数"></a>传递多个参数</h4><h4 id="使用resultMap映射结果集"><a href="#使用resultMap映射结果集" class="headerlink" title="使用resultMap映射结果集"></a>使用resultMap映射结果集</h4><h3 id="insert元素"><a href="#insert元素" class="headerlink" title="insert元素"></a>insert元素</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><h4 id="主键回填和自定义"><a href="#主键回填和自定义" class="headerlink" title="主键回填和自定义"></a>主键回填和自定义</h4><h3 id="update元素和-delete元素"><a href="#update元素和-delete元素" class="headerlink" title="update元素和 delete元素"></a>update元素和 delete元素</h3><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><h4 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h4><h4 id="存储过程支持"><a href="#存储过程支持" class="headerlink" title="存储过程支持"></a>存储过程支持</h4><h4 id="特殊字符串替换和处理"><a href="#特殊字符串替换和处理" class="headerlink" title="特殊字符串替换和处理"></a>特殊字符串替换和处理</h4><h3 id="sql元素"><a href="#sql元素" class="headerlink" title="sql元素"></a>sql元素</h3><h3 id="resultMap结果映射集"><a href="#resultMap结果映射集" class="headerlink" title="resultMap结果映射集"></a>resultMap结果映射集</h3><h4 id="resultMap元素的构成"><a href="#resultMap元素的构成" class="headerlink" title="resultMap元素的构成"></a>resultMap元素的构成</h4><h4 id="使用map存储结果集"><a href="#使用map存储结果集" class="headerlink" title="使用map存储结果集"></a>使用map存储结果集</h4><h4 id="使用POJO存储结果集"><a href="#使用POJO存储结果集" class="headerlink" title="使用POJO存储结果集"></a>使用POJO存储结果集</h4><h4 id="级联"><a href="#级联" class="headerlink" title="级联"></a>级联</h4><h3 id="缓存cache"><a href="#缓存cache" class="headerlink" title="缓存cache"></a>缓存cache</h3><h4 id="系统缓存（一级缓存和二级缓存）"><a href="#系统缓存（一级缓存和二级缓存）" class="headerlink" title="系统缓存（一级缓存和二级缓存）"></a>系统缓存（一级缓存和二级缓存）</h4><h4 id="自定义缓存"><a href="#自定义缓存" class="headerlink" title="自定义缓存"></a>自定义缓存</h4>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>mybatis</tag>
        <tag>知识树</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（十）sql元素</title>
    <url>/2020/04/28/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E5%8D%81%EF%BC%89sql%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<h3 id="sql-元素"><a href="#sql-元素" class="headerlink" title="sql 元素"></a>sql 元素</h3><pre><code>这个元素可以用来定义可重用的 SQL 代码片段，以便在其它语句中使用。 参数可以静态地（在加载的时候）确定下来，并且可以在不同的 include 元素中定义不同的参数值。</code></pre><p>​    例如，你有一条 SQL 需要 select 几十个字段映射到 JavaBean 中去，如果我们有第二条 SQL 也是这几十个字段映射到 JavaBean 中去，显然这些字段写两遍不太合适。那么我们就用 sql 元素来完成，例如，插入用户，查询用户列表就可以这样定义，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"user_columns"</span>&gt;</span></span><br><span class="line">		id,last_name,sex</span><br><span class="line">	<span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	 <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserById"</span> <span class="attr">resultMap</span>=<span class="string">"userResultMap"</span>&gt;</span></span><br><span class="line"> 	  	select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"user_columns"</span>/&gt;</span> from t_user where id = #&#123;id&#125;</span><br><span class="line"> <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    这里我们用 sql 元素定义了 user_columns，它可以很方便地使用 include 元素的 refid 属性进行引用，从而达到重用的功能。上面只是一个简单的例子，在真实环境中我们也可以指定参数来使用它们。 代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"user_columns"</span>&gt;</span></span><br><span class="line">  #&#123;prefix&#125;.id , #&#123;prefix&#125;.last_name,#&#123;prefix&#125;.sex</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"select"</span> <span class="attr">resultType</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">    field1, field2, field3</span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"user_columns"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"u"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">  from t_user u where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>表名 （table) 参数可以静态地（在加载的时候）确定下来，并且可以在不同的 include 元素中定义不同的参数值。比如： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">   <span class="comment">&lt;!-- 定义表名的 sql 参数 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"sometable"</span>&gt;</span></span><br><span class="line">  $&#123;prefix&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"someinclude"</span>&gt;</span>  <span class="comment">&lt;!-- 将表名的引入使用 sql 参数包裹 --&gt;</span></span><br><span class="line">  from</span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"$&#123;include_target&#125;"</span>/&gt;</span>    <span class="comment">&lt;!-- 使用 $&#123;&#125; 引入表名key --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selects"</span> <span class="attr">resultType</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">  select  *    </span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"someinclude"</span>&gt;</span> 		<span class="comment">&lt;!-- 引入 from table 语句 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"t_user"</span>/&gt;</span>			 </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"include_target"</span> <span class="attr">value</span>=<span class="string">"sometable"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>  这样可以实现移除定义多出引用，大大减少了工作量。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>sql 元素</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（四）Mybatis</title>
    <url>/2020/03/30/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E5%9B%9B%EF%BC%89Mybatis/</url>
    <content><![CDATA[<p>​    针对Hibernate的不足，Mybatis应运而生，它是一个<strong>半自动映射</strong>的框架。</p>
<p>​    之所以称它为<strong>半自动框架</strong>，是因为它需要手动匹配提供POJO、SQL和映射关系，而全表映射的Hibernate 只需要提供POJO和映射关系便可。</p>
<p>​    Mybatis 是Apach 开源的项目Ibatis在迁移到Google code后更名的一个持久层框架。目前由Github进行维护。</p>
<p>​    关于IBatis一词的由来，可以拆解为“internet” 和 “abatis” ，该框架基于Java实现的 持久层框架。</p>
<p>​    后面全部使用Mybatis进行表述。</p>
<p>​    Mybatis提供的持久层框架包括SQL Maps和 DAO（Data Access Objects）。它能更好的解决Hibernate遇到的问题。</p>
<p>​    相较于Hibernate，Mybatis除了需要我们提供基本的映射文件外，还需要我们提供SQL语句。</p>
<p>简单来说，Mybatis 需要我们提供的映射文件包括如下三部分：</p>
<ul>
<li>SQL </li>
<li>映射规则</li>
<li>POJO</li>
</ul>
<p>Mybatis 相较于Hibernate ，其优势比较明显的体现在SQL的编写、优化上。</p>
<p>​    由于在Mybatis 中需要自己编写SQL，同样的Mybatis也提供了配置动态SQL的功能。这就解决了Hibernate中的表明根据时间变化，不同的条件下列名不一样的问题。</p>
<p>​    简而言之，Mybatis适用于对数据模型要求不高的场景，而Hibernate对数据模型的要求很高，相对而言，也比较刻板和缺乏灵活性。</p>
<p><strong>Mybatis 的优势：</strong></p>
<ul>
<li><p>可以对SQL进行优化</p>
</li>
<li><p>可以通过配置决定SQL的映射规则</p>
</li>
<li><p>支持存储过程</p>
<pre><code>&lt;img src=&quot;http://photo.wushaopei.com/qiniu258.png&quot; width=&quot;80%&quot;&gt;</code></pre></li>
</ul>
<p><strong>Mybatis的连接配置</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">      	<span class="comment">&lt;!-- 数据库的四个连接属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/atguigu/pojo/UserMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>MyBatis 映射文件配置</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">  PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Mapper 3.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">  &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  		namespace名称空间</span><br><span class="line">  		取值一般有两种情况：</span><br><span class="line">  			一种情况是：使用javaBean的全类名</span><br><span class="line">  			二种情况是：使用Mapper接口的全类名</span><br><span class="line">   --&gt;</span><br><span class="line">&lt;mapper namespace&#x3D;&quot;com.webcode.pojo.User&quot;&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  	select标签用来配置一个select语句</span><br><span class="line">  		id 用来配置一个唯一的标识</span><br><span class="line">  		resultType 是查询完之后一条记录对应转换成为的javaBean对象</span><br><span class="line">  		#&#123;id&#125;是点位符</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;select id&#x3D;&quot;queryUserById&quot; resultType&#x3D;&quot;com.webcode.pojo.User&quot;&gt;</span><br><span class="line">    	select id,last_name lastName,sex from t_user where id &#x3D; #&#123;id&#125;</span><br><span class="line">  &lt;&#x2F;select&gt;</span><br><span class="line">&lt;&#x2F;mapper&gt;</span><br></pre></td></tr></table></figure>

<p>在这里我们给出了SQL，并没有给出映射规则。如果要使用到映射规则，需要保证SQL列名和POJO的属性名保持一直，这样能够和Mybatis的自动配置规则匹配上并自动进行调用。因此，这一步的操作其实是可以省略掉的。</p>
<p><strong>Mybatis DAO层代码</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public interface UserMapper &#123;</span><br><span class="line"></span><br><span class="line">	public User queryUserById(Integer id);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyBatis想要正常使用，还需要创建 SqlSessionFactory,</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSqlSessionFactory</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拿到SqlSessionFactory 之后我们就可以实现代码功能了.</p>
<p><strong>Mybatis实现对SQL的查询操作</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">queryUserById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">		SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> session.selectOne(<span class="string">"com.webcode.pojo.User.queryUserById"</span>, id);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			session.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（一）properties 元素</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%80%EF%BC%89properties-%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<h2 id="MyBatis-配置XML-文件的层次结构"><a href="#MyBatis-配置XML-文件的层次结构" class="headerlink" title="MyBatis 配置XML 文件的层次结构"></a>MyBatis 配置XML 文件的层次结构</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>    <span class="comment">&lt;!-- 配置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>/&gt;</span>	   <span class="comment">&lt;!-- 属性 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span>/&gt;</span>        <span class="comment">&lt;!-- 设置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAliases</span>/&gt;</span>	<span class="comment">&lt;!-- 类型命名 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandlers</span>/&gt;</span>	<span class="comment">&lt;!-- 类型处理器 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">objectFactory</span>/&gt;</span>	<span class="comment">&lt;!-- 对象工厂 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>/&gt;</span>		<span class="comment">&lt;!-- 插件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> &gt;</span>   <span class="comment">&lt;!-- 配置环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> &gt;</span>    <span class="comment">&lt;!-- 环境变量 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> /&gt;</span>     <span class="comment">&lt;!-- 事务管理器 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> /&gt;</span>     <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span>      </span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span>       </span><br><span class="line">  <span class="tag">&lt;<span class="name">databaseIdProvider</span>/&gt;</span> 	<span class="comment">&lt;!-- 数据库厂商标识 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span>		<span class="comment">&lt;!-- 映射器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上是全部MyBatis的配置元素。</p>
<h1 id="mybatis的核心配置之properties"><a href="#mybatis的核心配置之properties" class="headerlink" title="mybatis的核心配置之properties"></a><strong>mybatis的核心配置之properties</strong></h1><blockquote>
<p>properties 是一个配置属性的元素，让我们在配置文件的上下文中使用它。</p>
</blockquote>
<h3 id="properties-元素"><a href="#properties-元素" class="headerlink" title="properties 元素"></a>properties 元素</h3><p>properties 是一个配置属性的元素，让我们在配置文件的上下文中使用它</p>
<p>MyBatis 提供 3 中配置方式：</p>
<ul>
<li>property 子元素</li>
<li>properties 配置文件</li>
<li>程序参数传递</li>
</ul>
<h3 id="property-子元素"><a href="#property-子元素" class="headerlink" title="property 子元素"></a>property 子元素</h3><h4 id="property-子元素的配置方法："><a href="#property-子元素的配置方法：" class="headerlink" title="property 子元素的配置方法："></a>property 子元素的配置方法：</h4><p><strong>property 子元素配置：</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">&lt;property name=<span class="string">"driver"</span> value=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;amp;serverTimezone=UTC"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"username"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>

<p><strong>在上下文中使用已经配置好的属性值：</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">&lt;property name=<span class="string">"driver"</span> value=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;amp;serverTimezone=UTC"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"username"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">   &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>

<h4 id="properties-配置文件"><a href="#properties-配置文件" class="headerlink" title="properties 配置文件"></a>properties 配置文件</h4><p>更多的时候，我们会使用 properties 配置文件来配置属性值，以方便我们在多个配置文件中重复使用它们，也便于日后的维护和修改。</p>
<p> <strong>properties 文件的使用</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">username=root</span><br><span class="line">password=root</span><br><span class="line">url=jdbc:mysql:<span class="comment">//localhost:3333/mybatis?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone = GMT</span></span><br><span class="line">driver=com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>

<p><strong>配置文件的引入：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"jdbc.properties"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>properties标签在引入外部属性配置文件和内部定义属性的时候。外部会替换掉内部定义的值。</p>
</blockquote>
<h3 id="程序参数传递"><a href="#程序参数传递" class="headerlink" title="程序参数传递"></a>程序参数传递</h3><p>应用场景： 系统是由运维人员去配置的，生产数据库的用户密码对于开发者而言是保密的，而且为了安全，运维人员要求对配置文件中的数据库用户和密码进行加密，这样我们的配置文件中往往配置的是加密过后的数据库信息，而无法通过加密的字符串去连接数据库，这个时候可以通过编码的形式来满足我们遇到的场景。</p>
<p>下面假设 jdbc.properties 文件中的username 和 password 两个属性使用了加密的字符串，这个时候我们需要在生成SqlSessionFactory 之前将它转化为明文，而系统已经提供了解密的方法 decodee(str) ，让我们来看看如何使用代码的方式来完成 SqlSessionFactory 的创建 .</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.testMain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Level;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.util.SqlSessionFactoryUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SqlSessionFactory_Property.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月13日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactory_Property</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">decode</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">		<span class="comment">//解密</span></span><br><span class="line">		<span class="keyword">return</span> str;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span> <span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		InputStream cfgStream = <span class="keyword">null</span>;</span><br><span class="line">		Reader cfgReader = <span class="keyword">null</span>;</span><br><span class="line">		InputStream proStream = <span class="keyword">null</span>;</span><br><span class="line">		Reader proReader = <span class="keyword">null</span>;</span><br><span class="line">		Properties properties = <span class="keyword">null</span>;</span><br><span class="line">		SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line">		SqlSession session = <span class="keyword">null</span>; </span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="comment">// 读入配置文件流</span></span><br><span class="line">			cfgStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line">			cfgReader = <span class="keyword">new</span> InputStreamReader(cfgStream); </span><br><span class="line">			</span><br><span class="line">			<span class="comment">//读入属性文件</span></span><br><span class="line">			proStream = Resources.getResourceAsStream(<span class="string">"jdbc.properties"</span>);</span><br><span class="line">			proReader = <span class="keyword">new</span> InputStreamReader(proStream);</span><br><span class="line">			properties = <span class="keyword">new</span> Properties();</span><br><span class="line">			properties.load(proReader);</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 解密为明文</span></span><br><span class="line">			properties.setProperty(<span class="string">"username"</span>, decode(properties.getProperty(<span class="string">"username"</span>)));			</span><br><span class="line">			properties.setProperty(<span class="string">"password"</span>, decode(properties.getProperty(<span class="string">"password"</span>)));				</span><br><span class="line">					</span><br><span class="line">			</span><br><span class="line">			System.out.println( decode(properties.getProperty(<span class="string">"username"</span>)) );</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			</span><br><span class="line">			Logger.getLogger(SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()).<span class="title">log</span>(<span class="title">null</span>,<span class="title">ex</span>)</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">synchronized</span>(SqlSessionFactory_Property<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">				<span class="comment">// 使用属性来创建SqlSessionFactory</span></span><br><span class="line">				sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(cfgReader, properties);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上述代码，我们完全可以在jdbc.properties 配置密文，满足对系统安全的要求。</p>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>MyBatis 支持的以上三种配置方式可能同时出现，并且属性还会重复配置。这3中方式是存在优先级的，MyBatis 中将按照下面的顺序来加载。</p>
<ol>
<li>在 properties 元素体内指定的属性首先被读取</li>
<li>根据properties 元素中的 resource 属性读取类路径下属性文件，或者根据url属性指定的路径读取属性文件，并覆盖已读取的同名属性</li>
<li>读取作为方法参数传递的属性，并覆盖已读取的同名属性。</li>
</ol>
<p><strong>以上声明的优先级如下：</strong></p>
<blockquote>
<p>如果3种配置同时出现，优先级为第3种 &gt; 第2种 &gt; 第1种，推荐使用第2种，有特殊需求时使用第3种。</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·
]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>properties</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（三）别名 - typeAliases</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%89%EF%BC%89%E5%88%AB%E5%90%8D/</url>
    <content><![CDATA[<h3 id="自定义类型别名（typeAliases）"><a href="#自定义类型别名（typeAliases）" class="headerlink" title="自定义类型别名（typeAliases）"></a>自定义类型别名（typeAliases）</h3><p>类型别名可为 Java 类型设置一个缩写名字。 它仅用于 XML 配置，意在降低冗余的全限定类名书写。例如： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- typeAliases多个类型别名 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- typeAlias每个都是类型别名 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Author"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Author"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Blog"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Blog"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Comment"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Comment"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Post"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Post"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Section"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Section"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Tag"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Tag"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当这样配置时，<code>Blog</code> 可以用在任何使用 <code>domain.blog.Blog</code> 的地方。</p>
<p>也可以指定一个包名，MyBatis 会在包名下面搜索需要的 Java Bean，比如：         </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- package使用包名，自动扫描，进行别名配置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"domain.blog"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>每一个在包 <code>domain.blog</code> 中的 Java Bean，在没有注解的情况下，会使用 Bean 的首字母小写的非限定类名来作为它的别名。 比如 <code>domain.blog.Author</code> 的别名为 <code>author</code>；若有注解，则别名为其注解值。见下面的例子： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Alias</span>("author") 注解可以自定义别名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"author"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当配置上面的配置，MyBatis 就会自动扫描包，将扫描到的类装载到上下文中，以便将来使用。这样就算是多个 POJO 也可以通过包扫描的方式装载到 MyBatis 的上下文中。</p>
<p>当然配置了包扫描的路径，而没有注解@Alias 的MyBatis 也会装载，只是说它将把你的类名的第一个字母变为小写，作为MyBatis 的别名，要特别注意避免出现重名的场景，建议使用部分包名加类名的限定。</p>
<h3 id="系统定义别名"><a href="#系统定义别名" class="headerlink" title="系统定义别名"></a>系统定义别名</h3><p>下面是一些为常见的 Java 类型内建的类型别名。它们都是不区分大小写的，注意，为了应对原始类型的命名重复，采取了特殊的命名风格。 </p>
<table>
<thead>
<tr>
<th><strong>别名</strong></th>
<th><strong>映射的类型</strong></th>
</tr>
</thead>
<tbody><tr>
<td>_byte</td>
<td>byte</td>
</tr>
<tr>
<td>_long</td>
<td>long</td>
</tr>
<tr>
<td>_short</td>
<td>short</td>
</tr>
<tr>
<td>_int</td>
<td>int</td>
</tr>
<tr>
<td>_integer</td>
<td>int</td>
</tr>
<tr>
<td>_double</td>
<td>double</td>
</tr>
<tr>
<td>_float</td>
<td>float</td>
</tr>
<tr>
<td>_boolean</td>
<td>boolean</td>
</tr>
<tr>
<td>string</td>
<td>String</td>
</tr>
<tr>
<td>byte</td>
<td>Byte</td>
</tr>
<tr>
<td>long</td>
<td>Long</td>
</tr>
<tr>
<td>short</td>
<td>Short</td>
</tr>
<tr>
<td>int</td>
<td>Integer</td>
</tr>
<tr>
<td>integer</td>
<td>Integer</td>
</tr>
<tr>
<td>double</td>
<td>Double</td>
</tr>
<tr>
<td>float</td>
<td>Float</td>
</tr>
<tr>
<td>boolean</td>
<td>Boolean</td>
</tr>
<tr>
<td>date</td>
<td>Date</td>
</tr>
<tr>
<td>decimal</td>
<td>BigDecimal</td>
</tr>
<tr>
<td>bigdecimal</td>
<td>BigDecimal</td>
</tr>
<tr>
<td>object</td>
<td>Object</td>
</tr>
<tr>
<td>map</td>
<td>Map</td>
</tr>
<tr>
<td>hashmap</td>
<td>HashMap</td>
</tr>
<tr>
<td>list</td>
<td>List</td>
</tr>
<tr>
<td>arraylist</td>
<td>ArrayList</td>
</tr>
<tr>
<td>collection</td>
<td>Collection</td>
</tr>
<tr>
<td>iterator</td>
<td>Iterator</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>别名</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（九）引入映射器的方法</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B9%9D%EF%BC%89%E5%BC%95%E5%85%A5%E6%98%A0%E5%B0%84%E5%99%A8%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h2 id="引入映射器的方法"><a href="#引入映射器的方法" class="headerlink" title="引入映射器的方法"></a>引入映射器的方法</h2><p>映射器是  MyBatis 最复杂、最核心的组件它具有参数类型、动态SQL、定义SQL、缓存信息等功能。</p>
<h3 id="映射器的使用"><a href="#映射器的使用" class="headerlink" title="映射器的使用"></a>映射器的使用</h3><p>映射器定义了命名空间的方法，命名空间对应的是一个接口的全路径，而不是实体类。一下是对接口实现调度的过程：</p>
<h4 id="首先，定义映射器的接口："><a href="#首先，定义映射器的接口：" class="headerlink" title="首先，定义映射器的接口："></a><strong>首先，定义映射器的接口：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="其次给出XML文件："><a href="#其次给出XML文件：" class="headerlink" title="其次给出XML文件："></a><strong>其次给出XML文件：</strong></h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.webcode.cn.mapper.UserMapper"</span>&gt;</span> </span><br><span class="line"> <span class="comment">&lt;!--   &lt;mapper namespace="com.webcode.cn.entity.User"&gt;	--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserById"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span></span><br><span class="line">    	select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="引入映射器的方法，共分为一下几种："><a href="#引入映射器的方法，共分为一下几种：" class="headerlink" title="引入映射器的方法，共分为一下几种："></a><strong>引入映射器的方法，共分为一下几种：</strong></h3><h4 id="1、用文件路径引入映射器"><a href="#1、用文件路径引入映射器" class="headerlink" title="1、用文件路径引入映射器"></a>1、用文件路径引入映射器</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"> <span class="comment">&lt;!-- 使用相对于类路径的资源引用 --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/webcode/cn/mapper/UserMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/webcode/cn/mapper/RoleMapper.xml"</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2、用包名引入映射器，"><a href="#2、用包名引入映射器，" class="headerlink" title="2、用包名引入映射器，"></a>2、用包名引入映射器，</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 将包内的映射器接口实现全部注册为映射器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.webcode.cn.mapper"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3、用类注册引入映射器，"><a href="#3、用类注册引入映射器，" class="headerlink" title="3、用类注册引入映射器，"></a>3、用类注册引入映射器，</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用映射器接口实现类的完全限定类名 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"com.webcode.cn.mapper.UserMapper"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"com.webcode.cn.mapper.RoleMapper"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="4、用-userMapper-xml-引入映射器，"><a href="#4、用-userMapper-xml-引入映射器，" class="headerlink" title="4、用 userMapper.xml 引入映射器，"></a>4、用 userMapper.xml 引入映射器，</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用完全限定资源定位符（URL） --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file:///mybatis-exercise/src/main/java/com/webcode/cn/mapper/UserMapper.xml"</span>/&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file:///mybatis-exercise/src/main/java/com/webcode/cn/mapper/RoleMapper.xml"</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这些配置会告诉 MyBatis 去哪里找映射文件，剩下的细节就应该是每个 SQL 映射文件了，也就是接下来我们要讨论的。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>引入映射器的方法</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（八）databaseIdProvider 数据库厂商标识</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%85%AB%EF%BC%89databaseIdProvider-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%82%E5%95%86%E6%A0%87%E8%AF%86/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>mybatis 配置（六）插件</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%85%AD%EF%BC%89%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p> MyBatis 允许你在映射语句执行过程中的某一点进行拦截调用。默认情况下，MyBatis 允许使用插件来拦截的方法调用包括：         </p>
<ul>
<li><strong>Executor</strong>          (update, query, flushStatements, commit, rollback, getTransaction, close,  isClosed)           </li>
<li><strong>ParameterHandler</strong>           (getParameterObject, setParameters)           </li>
<li><strong>ResultSetHandler</strong>             (handleResultSets, handleOutputParameters)           </li>
<li><strong>StatementHandler</strong>           (prepare, parameterize, batch, update, query)           </li>
</ul>
<p>这些类中方法的细节可以通过查看每个方法的签名来发现，或者直接查看 MyBatis 发行包中的源代码。 如果你想做的不仅仅是监控方法的调用，那么你最好相当了解要重写的方法的行为。因为在试图修改或重写已有方法的行为时，很可能会破坏 MyBatis 的核心模块。这些都是更底层的类和方法，所以使用插件的时候要特别当心。</p>
<p>通过 MyBatis 提供的强大机制，使用插件是非常简单的，只需实现 Interceptor 接口，并指定想要拦截的方法签名即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ExamplePlugin.java</span></span><br><span class="line"><span class="meta">@Intercepts</span>(&#123;<span class="meta">@Signature</span>(</span><br><span class="line">  type= Executor<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">  <span class="title">method</span> </span>= <span class="string">"update"</span>,</span><br><span class="line">  args = &#123;MappedStatement<span class="class">.<span class="keyword">class</span>,<span class="title">Object</span>.<span class="title">class</span>&#125;)&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ExamplePlugin</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// implement pre processing if need</span></span><br><span class="line">    Object returnObject = invocation.proceed();</span><br><span class="line">    <span class="comment">// implement post processing if need</span></span><br><span class="line">    <span class="keyword">return</span> returnObject;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.properties = properties;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"org.mybatis.example.ExamplePlugin"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"someProperty"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面的插件将会拦截在 Executor 实例中所有的 “update” 方法调用，这里的 Executor 是负责执行底层映射语句的内部对象。</p>
<p><code>提示</code>    <strong>覆盖配置类</strong>         </p>
<p>除了用插件来修改 MyBatis 核心行为以外，还可以通过完全覆盖配置类来达到目的。只需继承配置类后覆盖其中的某个方法，再把它传递到  SqlSessionFactoryBuilder.build(myConfig) 方法即可。再次重申，这可能会极大影响 MyBatis  的行为，务请慎之又慎。</p>
<p><strong>由于对 MyBatis 内部运行原理不是太熟，这里直接将官网文档Copy过来做个笔记，用以参考。</strong></p>
<p><strong>转载自： <a href="https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers</a></strong></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>插件</tag>
      </tags>
  </entry>
  <entry>
    <title>原码，反码，补码的深入理解与原理</title>
    <url>/2020/03/23/%E5%8E%9F%E7%A0%81%EF%BC%8C%E5%8F%8D%E7%A0%81%EF%BC%8C%E8%A1%A5%E7%A0%81%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%B8%8E%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="计算机符号构成"><a href="#计算机符号构成" class="headerlink" title="计算机符号构成"></a>计算机符号构成</h2><p>​    计算机中的有符号数有三种表示方法，即<a href="https://baike.baidu.com/item/%E5%8E%9F%E7%A0%81/1097586" target="_blank" rel="noopener">原码</a>、<a href="https://baike.baidu.com/item/%E5%8F%8D%E7%A0%81/769985" target="_blank" rel="noopener">反码</a>和补码。三种表示方法均有符号位和数值位两部分，符号位都是用0表示“正”，用1表示“负”，而数值位，三种表示方法各不相同 。</p>
<p>​    在<a href="https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA/140338" target="_blank" rel="noopener">计算机</a>系统中，数值一律用补码来表示和存储。原因在于，使用补码，可以将符号位和数值域统一处理；同时，加法和减法也可以统一处理  。 </p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>​    <strong>原码</strong>就是符号位加上真值的绝对值， 即用第一位表示符号， 其余位表示值。  </p>
<p>​    <strong>反码</strong>的表示方法是:<strong>正数的反码</strong>是其本身；<strong>负数的反码</strong>是在其原码的基础上， 符号位不变，其余各个位取反。  </p>
<p>​    <strong>补码</strong>的表示方法是:<strong>正数的补码</strong>就是其<strong>本身</strong>；<strong>负数的补码</strong>是在其原码的基础上， 符号位不变， 其余各位<strong>取反， 最后+1</strong>。 (即在反码的基础上+1) </p>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><table>
<thead>
<tr>
<th>十进制数</th>
<th>原码</th>
<th>反码</th>
<th>补码</th>
</tr>
</thead>
<tbody><tr>
<td>85</td>
<td><code>0101 0101</code></td>
<td><code>0101 0101</code></td>
<td><code>0101 0101</code></td>
</tr>
<tr>
<td>-85</td>
<td><code>1101 0101</code></td>
<td><code>1010 1010</code></td>
<td><code>1010 1011</code></td>
</tr>
<tr>
<td>9</td>
<td><code>0000 1001</code></td>
<td><code>0000 1001</code></td>
<td><code>0000 1001</code></td>
</tr>
<tr>
<td>-9</td>
<td><code>1000 1001</code></td>
<td><code>1111 0110</code></td>
<td><code>1111 0111</code></td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>原码</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 简介（二）ORM 模型</title>
    <url>/2020/03/24/mybatis-%E7%AE%80%E4%BB%8B%EF%BC%88%E4%BA%8C%EF%BC%89ORM-%E6%A8%A1%E5%9E%8B-1/</url>
    <content><![CDATA[<p>​    由于JDBC存在的缺陷，在实际工作中我们很少使用JDBC进行编程，于是提出了对 象关系映射(0可ect Relational Mapping,简称 0RM,或者 O/RM,或者 0/R mapping)。那 什么是ORM模型呢？ </p>
<p>​    简单地说，ORM模型就是数据库的表和简单Java对象(Plain Ordinary Java Object, 简称POJO)的映射关系模型，它主要解决数据库数据和POJO对象的相互映射。我们通过 这层映射关系就可以简单迅速地把数据库表的数据转化为POJO,以便程序员更加容易理解 和应用Java程序，如下图所示。</p>
<img src="http://photo.wushaopei.com/qiniu214.png" width="80%">

<p>有了 ORM模型，在大部分情况下，程序员只需要了解 java 应用而无需对数据库相关 知识深入了解，便可以写出通俗易懂的程序。此外，ORM模型提供了统一的规则使得数据 库的数据通过配置便可轻易映射到POJO上。</p>
<p>其好处有以下几点：</p>
<table>
<thead>
<tr>
<th>优点</th>
<th>体现</th>
</tr>
</thead>
<tbody><tr>
<td>易用性</td>
<td>使用ORM做数据库的开发可以有效的减少重复SQL语句的概率，写出来的模型也更加直观、清晰。</td>
</tr>
<tr>
<td>性能损耗小</td>
<td>ORM转换成底层数据库操作指令确实会有一些开销。但从实际的情况来看，这种性能损耗很少（不足5%），只要不是对性能有严苛的要求，综合考虑开发效率、代码的阅读性，带来的好处要远远大于性能损耗，而且项目越大作用越明显。</td>
</tr>
<tr>
<td>设计灵活</td>
<td>可以轻松的写出复杂的查询。</td>
</tr>
<tr>
<td>可移植性</td>
<td>mybatis封装了底层的数据库实现，支持多个关系数据库引擎，包括流行的MySQL、PostgreSQL和SQServer。可以非常轻松的切换数据库。</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>简介</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（五）ObjectFactory</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BA%94%EF%BC%89ObjectFactory/</url>
    <content><![CDATA[<h3 id="对象工厂（objectFactory）"><a href="#对象工厂（objectFactory）" class="headerlink" title="对象工厂（objectFactory）"></a>对象工厂（objectFactory）</h3><p>每次 MyBatis 创建结果对象的新实例时，它都会使用一个对象工厂（ObjectFactory）实例来完成实例化工作。 默认的对象工厂需要做的仅仅是实例化目标类，要么通过默认无参构造方法，要么通过存在的参数映射来调用带有参数的构造方法。 如果想覆盖对象工厂的默认行为，可以通过创建自己的对象工厂来实现。</p>
<p>我们这里配置了一个对象工厂 <code>ExampleObjectFactory</code>  ，对它的要求是实现ObjectFactory 的接口。实际上 DefaultObjectFactory  已经实现了 ObjectFactory 的接口，我们可以通过 继承DefaultObjectFactory类来简化编程。</p>
<p><strong>具体代码如下：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.SortedSet;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.factory.DefaultObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ExampleObjectFactory.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月17日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//ExampleObjectFactory.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleObjectFactory</span> <span class="keyword">extends</span> <span class="title">DefaultObjectFactory</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3814827216040286292L</span>;</span><br><span class="line">	</span><br><span class="line">	Logger log = Logger.getLogger(ExampleObjectFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt;  type)</span> </span>&#123;</span><br><span class="line">		log.info(<span class="string">"使用定制对象工厂的create方法构建单个对象"</span>);</span><br><span class="line">	 <span class="keyword">return</span> <span class="keyword">super</span>.create(type);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt;  type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		log.info(<span class="string">"使用定制对象工厂的create方法构建列表对象"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.create(type, constructorArgTypes, constructorArgs);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">		log.info(<span class="string">"定制属性： "</span> + properties);</span><br><span class="line">	 <span class="keyword">super</span>.setProperties(properties);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">	 <span class="keyword">return</span> Collection<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">type</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在mybatis-config.xml中做如下配置，并自定义一个<strong>property</strong>子元素，设置其name和value </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- mybatis-config.xml --&gt;</span><br><span class="line">&lt;objectFactory type&#x3D;&quot;com.webcode.config.ExampleObjectFactory&quot;&gt;</span><br><span class="line">  &lt;property name&#x3D;&quot;someProperty&quot; value&#x3D;&quot;100&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;objectFactory&gt;</span><br></pre></td></tr></table></figure>

<p>ObjectFactory 接口很简单，它包含两个创建实例用的方法，一个是处理默认无参构造方法的，另外一个是处理带参数的构造方法的。 另外，setProperties 方法可以被用来配置 ObjectFactory，在初始化你的 ObjectFactory 实例后， objectFactory 元素体中定义的属性会被传递给 setProperties 方法。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Logging initialized using <span class="string">'class org.apache.ibatis.logging.log4j.Log4jImpl'</span> adapter.</span><br><span class="line"> INFO [main] - 定制属性： &#123;someProperty=<span class="number">100</span>&#125;</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection <span class="number">480971771</span>.</span><br><span class="line">DEBUG [main] - Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1</span>cab0bfb]</span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_user</span><span class="params">(`last_name`,`sex`)</span> <span class="title">values</span><span class="params">(?,?)</span> </span></span><br><span class="line"><span class="function">DEBUG [main] - </span>==&gt; Parameters: tom(String), <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">1</span></span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: delete from t_user where id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">0</span></span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: update t_user set last_name = ?,sex = ? where id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: jetty(String), <span class="number">1</span>(Integer), <span class="number">2</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">1</span></span><br><span class="line">DEBUG [main] - Committing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1</span>cab0bfb]</span><br><span class="line">DEBUG [main] - Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1</span>cab0bfb]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1</span>cab0bfb]</span><br><span class="line">DEBUG [main] - Returned connection <span class="number">480971771</span> to pool.</span><br></pre></td></tr></table></figure>

<p><strong>从运行的结果可以看出</strong>，首先，setProperties 方法可以使得我们如何去处理设置进去的属性，而 create 方法分别可以处理单个对象和列表对象。其次，我们配置的 ObjectFactory 已经生效。 注意，大部分的情况下，我们不需要使用自己配置的 ObjectFactory，使用系统默认的即可。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>objectFactory</tag>
      </tags>
  </entry>
  <entry>
    <title>工具-IP类：获取访问者IP</title>
    <url>/2020/05/11/%E5%B7%A5%E5%85%B7-IP%E7%B1%BB%EF%BC%9A%E8%8E%B7%E5%8F%96%E8%AE%BF%E9%97%AE%E8%80%85IP/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 获取访问者IP</span></span><br><span class="line"><span class="comment">* @param request</span></span><br><span class="line"><span class="comment">* @return</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getIpAddr</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//在一般情况下使用Request.getRemoteAddr()即可，但是经过nginx等反向代理软件后，这个方法会失效。</span></span><br><span class="line">    String ip = request.getHeader(<span class="string">"X-Real-IP"</span>);</span><br><span class="line">    <span class="comment">//Header中获取X-Real-IP，如果不存在再从X-Forwarded-For获得第一个IP(用,分割)</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(ip) &amp;&amp; !<span class="string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;<span class="comment">//</span></span><br><span class="line">    ip = request.getHeader(<span class="string">"X-Forwarded-For"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(ip) &amp;&amp; !<span class="string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        <span class="comment">// 多次反向代理后会有多个IP值，第一个为真实IP。</span></span><br><span class="line">        <span class="keyword">int</span> index = ip.indexOf(<span class="string">','</span>);</span><br><span class="line">        <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ip.substring(<span class="number">0</span>, index);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ip;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">//还不存在则调用Request .getRemoteAddr()</span></span><br><span class="line">        <span class="keyword">return</span> request.getRemoteAddr();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>工具类大全</category>
      </categories>
      <tags>
        <tag>java工具</tag>
        <tag>IP</tag>
      </tags>
  </entry>
  <entry>
    <title>工具-编码类：编码转换</title>
    <url>/2020/05/11/%E5%B7%A5%E5%85%B7-%E7%BC%96%E7%A0%81%E7%B1%BB%EF%BC%9A%E7%BC%96%E7%A0%81%E8%BD%AC%E6%8D%A2/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.hutool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.Console;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileFilter;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcertEncodeing</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        convertCharset("D:\\Developments\\git-projects\\workflow2.0\\server\\src\\main\\java\\com\\legion\\workflow\\orgauthorization", Charset.forName("GBK"), Charset.forName("UTF-8"), "java");</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换文件编码格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path        需要转换的文件或文件夹路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fromCharset 原编码格式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toCharset   目标编码格式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expansion   需要转换的文件扩展名,如需全部转换则传 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">convertCharset</span><span class="params">(String path, <span class="keyword">final</span> Charset fromCharset, <span class="keyword">final</span> Charset toCharset, <span class="keyword">final</span> String expansion)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(path)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        File file = FileUtil.file(path);</span><br><span class="line">        File[] listFiles = file.listFiles(<span class="keyword">new</span> FileFilter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File pathname)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (StrUtil.isBlank(expansion)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (FileUtil.isDirectory(pathname) || FileUtil.extName(pathname).equals(<span class="string">"java"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listFiles.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listFiles[i].isDirectory()) &#123;</span><br><span class="line">                <span class="keyword">final</span> String canonicalPath = FileUtil.getCanonicalPath(listFiles[i]);</span><br><span class="line">                <span class="comment">//每个文件夹分个线程处理,提高点儿效率</span></span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        convertCharset(canonicalPath, fromCharset, toCharset, expansion);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                FileUtil.convertCharset(listFiles[i], fromCharset, toCharset);</span><br><span class="line">                Console.log(<span class="string">"转换完成文件名:&#123;&#125;"</span>, listFiles[i].getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>工具类大全</category>
      </categories>
      <tags>
        <tag>java工具</tag>
        <tag>编码工具</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（三）并发基础-Java内存模型</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<h2 id="JAVA内存模型"><a href="#JAVA内存模型" class="headerlink" title="JAVA内存模型"></a>JAVA内存模型</h2><h3 id="Java内存模型（Java-Memory-Model-JMM）"><a href="#Java内存模型（Java-Memory-Model-JMM）" class="headerlink" title="Java内存模型（Java Memory Model,JMM）"></a>Java内存模型（Java Memory Model,JMM）</h3><img src="http://photo.wushaopei.com/qiniu183.png" width="70%">

<p><strong>Java内存模型规范</strong>：规定了一个线程如何和何时可以看到由其他线程修改过后的共享变量的值，以及在必须时如何同步的访问共享变量。</p>
<p><strong>Java内存模型</strong>：Java里的堆是一个运行时数据区，堆是由垃圾回收来负责的，堆的优势是可以动态的分配内存大小，生成期也不必告诉编译器。因为它是在运行时动态分配内存的。Java收集器会自动搜索这些不再使用的数据。</p>
<p>其<strong>缺点</strong>是，由于是在运行时动态分配内存，因此它的存取速度相对慢一些.</p>
<p><strong>Java的栈(stack)，</strong>优势是存取数据的速度要比堆快，仅次于计算机里的寄存器，栈的数据是可以共享的；</p>
<p><strong>缺点</strong>是存在栈中的数据大小与生存期必须是确定的，缺乏一些灵活性，栈中主要存放一些基本类型的变量，比如int、short、float、double、char和对象句柄</p>
<p>Java内存模型要求调用栈和本地变量存放在线程栈上，而Thread stack对象则存放在堆上。</p>
<p>一个本地变量有可能指向一个<strong>对象的引用</strong>，这种情况下，引用这个本地变量是存放在这个线程栈上，但是对象本身是存放在堆上的；一个对象，它可能包含方法(methodOne()、method Two()),</p>
<h3 id="Java内存模型抽象结构图"><a href="#Java内存模型抽象结构图" class="headerlink" title="Java内存模型抽象结构图"></a>Java内存模型抽象结构图</h3><img src="http://photo.wushaopei.com/qiniu184.png" width="70%">

<p>线程A在操作共享变量时，是从主存中复制共享变量的副本到本地内存中，进行逻辑修改后，再将副本同步到主存中；并发环境下，线程A将副本修改后要同步到主存中时，线程B可能刚好将主存的共享变量同步到本地内存B中进行逻辑修改。而这是很不安全的。因为线程B所操作的共享变量相对线程A来说是已经过期的值，这会导致后续的一系列运算都是基于错误的基础上执行的。</p>
<p><strong>解决思路</strong>： 对线程A和线程B进行加锁，在主存共享变量进行副本复制后就不再允许其他线程操作，即实现线程的同步操作。从而解决并发线程的读写安全问题。</p>
<h3 id="Java内存模型-同步八种操作"><a href="#Java内存模型-同步八种操作" class="headerlink" title="Java内存模型 - 同步八种操作"></a>Java内存模型 - 同步八种操作</h3><table>
<thead>
<tr>
<th><strong>lock （锁定）</strong></th>
<th>作用域主内存的变量</th>
<th>把一个变量标识为一条线程独占状态</th>
</tr>
</thead>
<tbody><tr>
<td><strong>unlock （解锁）</strong></td>
<td><strong>作用于主内存的变量</strong></td>
<td><strong>把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定</strong></td>
</tr>
<tr>
<td><strong>read（读取）</strong></td>
<td><strong>作用域主内存的变量，</strong></td>
<td><strong>把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用</strong></td>
</tr>
<tr>
<td><strong>load（载入）</strong></td>
<td><strong>作用于工作内存的变量</strong></td>
<td><strong>它把read操作从主内存中得到的变量值放入工作内存的变量副本中</strong></td>
</tr>
<tr>
<td><strong>use （使用）</strong></td>
<td><strong>作用域工作内存的变量</strong></td>
<td><strong>把工作内中的一个变量值传递给执行引擎</strong></td>
</tr>
<tr>
<td><strong>assign（赋值）</strong></td>
<td><strong>作用于工作内存的变量</strong></td>
<td><strong>把一个从执行引擎接收到的值赋值给工作内存的变量</strong></td>
</tr>
<tr>
<td><strong>store （存储）</strong></td>
<td><strong>作用于工作内存的变量</strong></td>
<td><strong>把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作</strong></td>
</tr>
<tr>
<td><strong>write（写入）</strong></td>
<td><strong>作用于主内存的变量</strong></td>
<td><strong>把store操作从工作内存中一个变量的值传送到主内存的变量中</strong></td>
</tr>
</tbody></table>
<h3 id="Java内存模型-同步规则"><a href="#Java内存模型-同步规则" class="headerlink" title="Java内存模型 - 同步规则"></a>Java内存模型 - 同步规则</h3><ol>
<li><p>如果要把一个变量从主内存中复制到工作内存，就需要按顺序地执行read和load操作，如果把变量从工作内存中同步回主内存中，就要按顺序地执行store和write操作。但Java内存模型值要求上述操作必须按顺序执行，而没有保证必须是连续执行；</p>
</li>
<li><p>不允许read和load、store和write操作之一单独出现；</p>
</li>
<li><p>不允许一个线程丢弃它的最近assign的操作，即变量在工作内存中改变了之后必须同步到主内存中；</p>
</li>
<li><p>不允许一个线程无原因地（没有发生过任何assign操作）把数据从工作内存同步回主内存中；</p>
</li>
<li><p>一个新的变量只能在主内存中诞生，不允许在工作内存中直接使用一个未被初始化（load或assign的）变量。即就是对一个变量实施use和store操作之前，必须先执行过了assign和load操作；</p>
</li>
<li><p>一个变量在同一时刻只允许一条线程对其进行lock操纵，但lock操作可以被同一条线程重复执行富哦次，多次执行lock后，只有执行相同次数的unlock操作，变量才会被解锁。lock和unlock必须成对出现；</p>
</li>
<li><p>如果对一个变量执行lock操作，将会清空工作内存中此变量的值，在执行引擎使用这个变量前需要重新执行load或assign操作初始化变量的值；</p>
</li>
<li><p>如果一个变量事先没有被lock操作锁定，则不允许对它执行unlock操作；也不允许去unlock一个被其他线程锁定的变量；</p>
<p>对一个变量执行unlock操作之前，必须先把次变量同步到主内存中（执行store和write操作）</p>
</li>
</ol>
<h3 id="Java内存模型-执行流程图："><a href="#Java内存模型-执行流程图：" class="headerlink" title="Java内存模型 - 执行流程图："></a>Java内存模型 - 执行流程图：</h3><img src="http://photo.wushaopei.com/qiniu185.png" width="70%">



<h2 id="并发的优势与风险"><a href="#并发的优势与风险" class="headerlink" title="并发的优势与风险"></a>并发的优势与风险</h2><img src="http://photo.wushaopei.com/qiniu186.png" width="70%">

<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a><strong>小结：</strong></h3><blockquote>
<ol>
<li>CPU多级缓存：缓存一致性、乱序执行优化</li>
<li>Java内存模型： JMM规定、抽象结构、同步八种操作及规则</li>
<li>Java并发的优势与风险</li>
</ol>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（九）线程安全性-有序性与总结</title>
    <url>/2020/04/03/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B9%9D%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E6%9C%89%E5%BA%8F%E6%80%A7%E4%B8%8E%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><p>​    <strong>定义：</strong> Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性； </p>
<p>​    <strong>实现方式</strong>： volatile 、synchronized、Lock </p>
<h3 id="有序性-happens-before原则"><a href="#有序性-happens-before原则" class="headerlink" title="有序性 - happens - before原则"></a>有序性 - happens - before原则</h3><blockquote>
<p><strong>程序次序规则</strong>：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作</p>
<p><strong>锁定规则</strong>： 一个unlOCK操作先行发生于后面对同一个锁的lock操作</p>
<p><strong>volatile变量规则：</strong> 对一个变量的写操作先行发生于后面对这个变量的读操作</p>
<p><strong>传递规则</strong>：如果操作A线性发生于操作B，而操作B又先行发生于操作C，则可以得出操作A先行发生于操作C</p>
<p><strong>线程启动规则：</strong> Thread对象的start()方法先行于发生于此线程的每一个动作</p>
<p><strong>线程中断规则：</strong>对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生</p>
<p><strong>线程终结规则</strong>：线程中所有的操作都先行发生于线程的终止检测，我们可以通过Thread.join()方法    结束 、 Thread.isAlive()的返回值手段检测到线程已经终止执行</p>
<p><strong>对象终结规则：</strong>一个对象的初始化完成先行发生于它的finalize()方法的开始</p>
</blockquote>
<h3 id="小结-："><a href="#小结-：" class="headerlink" title="小结 ："></a>小结 ：</h3><blockquote>
<p> <strong>原子性 ：</strong> Atomic包、CAS算法、synchronized、Lock</p>
<p> <strong>可见性</strong>：synchronized 、volatile</p>
<p> <strong>有序性：</strong>happens-before</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>内存可见性</tag>
        <tag>synchronized</tag>
        <tag>有序性</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十一）J-U-C-组件-FutureTask</title>
    <url>/2020/04/17/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%E4%B8%80%EF%BC%89J-U-C-%E7%BB%84%E4%BB%B6-FutureTask/</url>
    <content><![CDATA[<h2 id="J-U-C-FutureTask"><a href="#J-U-C-FutureTask" class="headerlink" title="J.U.C-FutureTask"></a>J.U.C-FutureTask</h2><h3 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h3><p><code>FutureTask组件，该组件是JUC中的。但该组件不是 AQS 的子类。</code></p>
<p>创建一个线程通常有<strong>两种方式</strong>，<strong>一种是直接继承Thread类，另一红就是实现Runnable接口</strong>，这俩种方式有一个共同的缺陷，那就是在<strong>完成任务之后无法获取执行结果</strong>。从Java1.5开始提供了Callable和FutureTask，可以在任务完成之后得到任务执行的结果。</p>
<h3 id="Callable-与-Runnable-接口对比"><a href="#Callable-与-Runnable-接口对比" class="headerlink" title="Callable 与 Runnable 接口对比:"></a>Callable 与 Runnable 接口对比:</h3><ul>
<li>Runnable的代码非常简单，它是一个接口，而且只有一个方法，那就是run（），实现它把一些业务的操作写在里面，然后使用某个线程去执行该Runnable实现类就可以实现多线</li>
<li>Callable的代码也非常简单，不同的是它是一个泛型的接口，有一个call 函数，call函数的类型就是我们传进去的类的类型。</li>
<li>Callable和Runnable的功能大致相似，Callable的功能更强大一些。主要是Callable在执行完后可以有返回值，并且抛出异常。</li>
</ul>
<h3 id="Future接口："><a href="#Future接口：" class="headerlink" title="Future接口："></a>Future接口：</h3><p>​    <strong>Future</strong>也是一个接口，对于我们定义的Callable或者Runnable定义的具体的任务，它可以取消。查询的任务是否被取消、查询的过程是否完成以及获取结果等等。 </p>
<p>​    通常程序的线程都是   <code>异步执行</code> 的，所以通常需要可以直接从其他的线程中得到返回值。这个时候，Future就出场了。Future可以监视目标线程调用<code>call（）</code>的情况，当你调用Future的  <code>get()</code> 方法时，就可以获得它的结果。通常这个时候，线程可能不会直接完成，当前线程就开始阻塞，知道call()方法结束返回结果，线程才继续执行。</p>
<p><strong>总结</strong>： Future可以得到其他线程的任务方法的返回值。</p>
<h3 id="FutureTask类："><a href="#FutureTask类：" class="headerlink" title="FutureTask类："></a>FutureTask类：</h3><p>FutureTask的父类是RunnableFuture,，而RunnableFuture实现了Runnable和Future两个接口；由此我们可以知道，<strong>FutureTask它最终执行的是callable类型的任务。</strong></p>
<p><code>如果构造函数参数的类型是callable的话，它会转换成callable类型。</code></p>
<blockquote>
<p>RunnableFuture实现了Runnable和Future两个接口，所以它既可以作为Runnable被线程执行，又可以作为Future得到Callable的返回值。</p>
</blockquote>
<p><strong>该组合FutureTask的使用的好处是？</strong></p>
<blockquote>
<p>假设有一个很费时的逻辑需要计算，并且需要返回这个值，同时这个值又不是马上需要，那么就可以使用这个组合。用另外一个线程去计算返回值，而当前线程在使用这个返回值之前做其他的操作，等到需要用到这个返回值的时候再通过Future得到。</p>
</blockquote>
<h3 id="代码演示Future的使用"><a href="#代码演示Future的使用" class="headerlink" title="代码演示Future的使用"></a>代码演示Future的使用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCallable</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            log.info(<span class="string">"do something in callable"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Done"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        Future&lt;String&gt; future = executorService.submit(<span class="keyword">new</span> MyCallable());</span><br><span class="line">        log.info(<span class="string">"do something in main"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        String result = future.get();</span><br><span class="line">        log.info(<span class="string">"resultï¼&#123;&#125;"</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代码执行结果：</strong> </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">17:28:32.168 [main] INFO com.mmall.concurrency.example.aqs.FutureExample - do something in main</span><br><span class="line">17:28:32.168 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.FutureExample - do something in callable</span><br><span class="line">17:28:37.171 [main] INFO com.mmall.concurrency.example.aqs.FutureExample - resultï¼Done</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由执行结果的时间可知，call()方法中打印do something in callable 即线程初始化执行的时间和main方法中执行打印do something in main的时间一直，可说明两者是异步同时执行的。</p>
</blockquote>
<blockquote>
<p>再由call()线程返回值的打印时间可知，它是在线程初始化以及main初始化5秒后才打印结果result，可以说明future一直被阻塞，直到call()方法中的业务执行完成并返回结果后才接着继续执行get()方法。</p>
</blockquote>
<h3 id="代码演示FutureTask的使用"><a href="#代码演示FutureTask的使用" class="headerlink" title="代码演示FutureTask的使用"></a>代码演示FutureTask的使用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTaskExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       FutureTask&lt;String&gt; futureTask = <span class="keyword">new</span> FutureTask&lt;String&gt;(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               log.info(<span class="string">"do something in callable"</span>);</span><br><span class="line">               Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">"Done"</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">new</span> Thread(futureTask).start();</span><br><span class="line">       log.info(<span class="string">"do something in main"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        String result = futureTask.get();</span><br><span class="line">        log.info(<span class="string">"result:&#123;&#125;"</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代码执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">37</span>:<span class="number">57.378</span> [Thread-<span class="number">0</span>] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - <span class="keyword">do</span> something in callable</span><br><span class="line"><span class="number">17</span>:<span class="number">37</span>:<span class="number">57.378</span> [main] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - <span class="keyword">do</span> something in main</span><br><span class="line"><span class="number">17</span>:<span class="number">38</span>:<span class="number">02.384</span> [main] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - result:Done</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>分析执行结果：</strong> </p>
<blockquote>
<p>由执行结果的时间可知，call()方法中打印do something in callable 即线程初始化执行的时间和main方法中执行打印do something in main的时间一直，可说明两者是异步同时执行的。</p>
<p>再由call()线程返回值的打印时间可知，它是在线程初始化以及main初始化5秒后才打印结果result，可以说明futureTask 一直被阻塞，直到call()方法中的业务执行完成并返回结果后才接着继续执行get()方法。</p>
</blockquote>
<h3 id="对比Future和FutureTask执行声明与执行结果："><a href="#对比Future和FutureTask执行声明与执行结果：" class="headerlink" title="对比Future和FutureTask执行声明与执行结果："></a><strong>对比Future和FutureTask执行声明与执行结果：</strong></h3><p>可以知道，FutureTask使用起来要更加方便，定义好任务之后，直接启动任务，什么时候想用，什么时候就可以用它。 </p>
<h3 id="部分源码分析："><a href="#部分源码分析：" class="headerlink" title="部分源码分析："></a>部分源码分析：</h3><img src="http://photo.wushaopei.com/qiniu390.png" width="60%">

<p>由FutureTask的构造方法可以知道，它支持多种类型的构造函数的。 </p>
<img src="http://photo.wushaopei.com/qiniu391.png" width="60%">



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>FutureTask</tag>
        <tag>组件</tag>
      </tags>
  </entry>
  <entry>
    <title>工具-日期类：字符串转换成Date对象</title>
    <url>/2020/05/11/%E5%B7%A5%E5%85%B7-%E6%97%A5%E6%9C%9F%E7%B1%BB%EF%BC%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E6%88%90Date%E5%AF%B9%E8%B1%A1/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把字符串转换成Date对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dateString</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">getDate</span><span class="params">(String dateString)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dateString == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	dateString = dateString.trim();</span><br><span class="line">	SimpleDateFormat df = <span class="keyword">null</span>;</span><br><span class="line">	Date date = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (dateString.length() &lt;= <span class="number">11</span>) &#123;<span class="comment">// 只有年月日</span></span><br><span class="line">		<span class="keyword">if</span> (dateString.matches(<span class="string">"[0-9]&#123;4&#125;-[0-9]&#123;1,2&#125;"</span>)) &#123;<span class="comment">// 2018-01</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString.matches(<span class="string">"[0-9]&#123;4&#125;-[0-9]&#123;1,2&#125;-[0-9]&#123;1,2&#125;"</span>)) &#123;<span class="comment">// 2018-01-01</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString.matches(<span class="string">"[0-9]&#123;4&#125;/[0-9]&#123;1,2&#125;/[0-9]&#123;1,2&#125;"</span>)) &#123;<span class="comment">// 2018/01/01</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy/MM/dd"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString.matches(<span class="string">"[0-9]&#123;2,8&#125;"</span>)) &#123;<span class="comment">// 20180101</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString.matches(<span class="string">"[0-9]&#123;4&#125;年[0-9]&#123;1,2&#125;月[0-9]&#123;1,2&#125;日"</span>)) &#123;<span class="comment">// 2018年01月01日</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy年MM月dd日"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString.matches(<span class="string">"[0-9]&#123;4&#125; [0-9]&#123;1,2&#125; [0-9]&#123;1,2&#125;"</span>)) &#123;<span class="comment">// 2018</span></span><br><span class="line">																			<span class="comment">// 01</span></span><br><span class="line">																			<span class="comment">// 01</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy MM dd"</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> (dateString.matches(<span class="string">"[0-9]&#123;4&#125;.[0-9]&#123;1,2&#125;.[0-9]&#123;1,2&#125;"</span>)) &#123;</span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy.MM.dd"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;<span class="comment">// 年月日时分秒</span></span><br><span class="line">		<span class="keyword">if</span> (dateString</span><br><span class="line">				.matches(<span class="string">"[0-9]&#123;4&#125;-[0-9]&#123;1,2&#125;-[0-9]&#123;1,2&#125; [0-9]&#123;2&#125;:[0-9]&#123;2&#125;:[0-9]&#123;2&#125;"</span>)) &#123;<span class="comment">// 2018-01-01</span></span><br><span class="line">																						<span class="comment">// 10:10:10</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString</span><br><span class="line">				.matches(<span class="string">"[0-9]&#123;4&#125;/[0-9]&#123;1,2&#125;/[0-9]&#123;1,2&#125; [0-9]&#123;2&#125;:[0-9]&#123;2&#125;:[0-9]&#123;2&#125;"</span>)) &#123;<span class="comment">// 2018/01/01</span></span><br><span class="line">																						<span class="comment">// 10:10:10</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString</span><br><span class="line">				.matches(<span class="string">"[0-9]&#123;8&#125; [0-9]&#123;1,2&#125;:[0-9]&#123;1,2&#125;:[0-9]&#123;2&#125;"</span>)) &#123;<span class="comment">// 20180101</span></span><br><span class="line">																		<span class="comment">// 10:10:10</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd HH:mm:ss"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString</span><br><span class="line">				.matches(<span class="string">"[0-9]&#123;4&#125;年[0-9]&#123;1,2&#125;月[0-9]&#123;1,2&#125;日 [0-9]&#123;2&#125;:[0-9]&#123;2&#125;:[0-9]&#123;2&#125;"</span>)) &#123;<span class="comment">// 2018年01月01日</span></span><br><span class="line">																							<span class="comment">// 10:10:10</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy年MM月dd日  HH:mm:ss"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString</span><br><span class="line">				.matches(<span class="string">"[0-9]&#123;4&#125; [0-9]&#123;1,2&#125; [0-9]&#123;1,2&#125; [0-9]&#123;2&#125;:[0-9]&#123;2&#125;:[0-9]&#123;2&#125;"</span>)) &#123;<span class="comment">// 2018</span></span><br><span class="line">																						<span class="comment">// 01</span></span><br><span class="line">																						<span class="comment">// 01</span></span><br><span class="line">																						<span class="comment">// 10:10:10</span></span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy MM dd HH:mm:ss"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString</span><br><span class="line">				.matches(<span class="string">"[0-9]&#123;4&#125;[0-9]&#123;1,2&#125;[0-9]&#123;1,2&#125;[0-9]&#123;2&#125;[0-9]&#123;2&#125;[0-9]&#123;2&#125;"</span>)) &#123;</span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateString</span><br><span class="line">				.matches(<span class="string">"[0-9]&#123;4&#125;-[0-9]&#123;1,2&#125;-[0-9]&#123;1,2&#125; [0-9]&#123;2&#125;:[0-9]&#123;2&#125;:[0-9]&#123;2&#125;.[0-9]"</span>)) &#123;</span><br><span class="line">			df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss.S"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (df != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			date = df.parse(dateString);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> date;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 日期转换</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> datetime</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">dateTrans</span><span class="params">(String datetime)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">char</span> buf[] = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">4</span>];</span><br><span class="line">		datetime.getChars(<span class="number">0</span>, <span class="number">4</span>, buf, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">char</span> bur[] = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">2</span>];</span><br><span class="line">		datetime.getChars(<span class="number">5</span>, <span class="number">7</span>, bur, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span> buw[] = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">2</span>];</span><br><span class="line">		datetime.getChars(<span class="number">8</span>, <span class="number">10</span>, buw, <span class="number">0</span>);</span><br><span class="line">		String date = String.valueOf(buf) + <span class="string">"年"</span> + String.valueOf(bur) + <span class="string">"月"</span></span><br><span class="line">				+ String.valueOf(buw) + <span class="string">"日"</span>;</span><br><span class="line">		<span class="keyword">return</span> date;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 判断时间是不是今天</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 是返回true，不是返回false</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isNow</span><span class="params">(Date date)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 当前时间</span></span><br><span class="line">		Date now = <span class="keyword">new</span> Date();</span><br><span class="line">		SimpleDateFormat sf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">		<span class="comment">// 获取今天的日期</span></span><br><span class="line">		String nowDay = sf.format(now);</span><br><span class="line">		<span class="comment">// 对比的时间</span></span><br><span class="line">		String day = sf.format(date);</span><br><span class="line">		<span class="keyword">return</span> day.equals(nowDay);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMinute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		SimpleDateFormat myFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">		<span class="keyword">return</span> myFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMinuteDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		SimpleDateFormat myFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>);</span><br><span class="line">		<span class="keyword">return</span> myFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMinuteGe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		SimpleDateFormat myFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">		<span class="keyword">return</span> myFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>工具类大全</category>
      </categories>
      <tags>
        <tag>java工具</tag>
        <tag>日期工具</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（一）概念引入与并发场景</title>
    <url>/2020/03/23/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89%E6%A6%82%E5%BF%B5%E5%BC%95%E5%85%A5%E4%B8%8E%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF/</url>
    <content><![CDATA[<h3 id="涉及的基础知识与核心知识："><a href="#涉及的基础知识与核心知识：" class="headerlink" title="涉及的基础知识与核心知识："></a>涉及的基础知识与核心知识：</h3><img src="http://photo.wushaopei.com/qiniu176.png" width="70%">



<h3 id="并发及并发的线程安全处理"><a href="#并发及并发的线程安全处理" class="headerlink" title="并发及并发的线程安全处理"></a>并发及并发的线程安全处理</h3><img src="http://photo.wushaopei.com/qiniu177.png" width="80%">



<h3 id="并发编程的基本概念"><a href="#并发编程的基本概念" class="headerlink" title="并发编程的基本概念"></a>并发编程的基本概念</h3><p> <strong>并发</strong>： 同时拥有两个或者多个线程，如果程序在单核处理器上运行，多个线程将交替地换入或换出内存，这些线程是同时 “ 存在” 的 ，每个线程都处于执行过程中的某个状态，如果运行在多核处理器上，此时，程序中的每个线程都将分配到一个处理器核上，因此可以同时运行。</p>
<p><strong>高并发：</strong> 并发（High Concurrency） 是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计保证系统能够同时并行处理很多请求。</p>
<p><strong>并发与高并发的区别：</strong></p>
<p> <strong>并发：</strong>  多个线程操作相同的资源，保证线程安全，合理使用资源</p>
<p>  <strong>高并发：</strong> 服务能同时处理很多请求，提高程序性能</p>
<h3 id="简单的并发业务场景"><a href="#简单的并发业务场景" class="headerlink" title="简单的并发业务场景"></a>简单的并发业务场景</h3><h4 id="实现一个计数功能"><a href="#实现一个计数功能" class="headerlink" title="实现一个计数功能"></a>实现一个计数功能</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.count;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.NotThreadSafe;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 创建可缓存线程池</span></span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="comment">// 使用countDownLatch计数管理并发请求数</span></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">00</span>:<span class="number">37.322</span> [main] INFO com.mmall.concurrency.example.count.CountExample1 - count:<span class="number">4994</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>将线程修改为1时，count为5000:</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 同时并发执行的线程数</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><strong>结果如下：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">02</span>:<span class="number">37.170</span> [main] INFO com.mmall.concurrency.example.count.CountExample1 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><font color=red>注意：</font>这里可以引发出一个问题，当我们在编写程序时，在本地进行测试时，只有一个进程，并且基本处于单线程环境下，而当项目部署上线后，项目登录、使用的用户绝不止一个用户，此时，会存在并发的情况，即同一服务进程下，多个用户的客户端操作线程进行请求服务器，此时，就可能由于服务器的响应问题等导致对部分客户端的请求响应中断、丢包等问题。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十二）J-U-C-组件-ForkJoin</title>
    <url>/2020/04/17/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%E4%BA%8C%EF%BC%89J-U-C-%E7%BB%84%E4%BB%B6-ForkJoin/</url>
    <content><![CDATA[<h2 id="J-U-C-ForkJoin"><a href="#J-U-C-ForkJoin" class="headerlink" title="J.U.C-ForkJoin"></a>J.U.C-ForkJoin</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>JUC 里面的 ForkJoin 框架是 JAVA7 提供的一个用于实现并行任务的框架，它是一个  <code>把大任务分割成若干个小任务</code>，最终汇总每个小任务结果后得到大任务的结果的框架。</p>
<blockquote>
<p>它的思想和Mapreduce的思想比较类似。</p>
</blockquote>
<p>从字面上看，Fork就是把一个大任务切割成若干个子任务来并行执行，Join就是合并这些子任务的执行结果，最后得到这个大任务的执行结果。它主要采用的是工作窃取算法。</p>
<p><strong>工作窃取算法的意思是指某个线程从其他队列里窃取任务来执行。</strong></p>
<h3 id="工作窃取算法的工作流程图及原理："><a href="#工作窃取算法的工作流程图及原理：" class="headerlink" title="工作窃取算法的工作流程图及原理："></a>工作窃取算法的工作流程图及原理：</h3><img src="http://photo.wushaopei.com/qiniu392.png" width="60%">

<p>从<strong>图中分析，</strong>该算法从线程1开始执行，然后到达任务4时，会在尾部进入到线程2去窃取属于线程2 的任务来执行。窃取线程的执行顺序自下而上，被窃取线程在执行时是自上而下。</p>
<p><strong>这里为什么要使用工作窃取算法呢？</strong></p>
<blockquote>
<p>假如我们需要做一个比较大的任务，我们可以把这个任务分割成若干个互不依赖的子任务。为了减少线程间的竞争，于是把这些子任务放到不同的队列里。为每个队列创建一个单独的线程来执行队列里的任务。线程和队列一一对应，比如A线程负责A队列里的任务。</p>
</blockquote>
<blockquote>
<p>但是，有的线程会先把自己线程里的任务干完。其他线程对应的队列里还有任务等待处理。干完活的线程与其光等着，还不如去帮助其他的线程干活。于是，它就去其他线程的队列里去窃取一个线程来执行，而在这时，它们会访问同一个队列，所以，为了减少窃取任务线程和被窃取任务线程之间的竞争，我们会使用双端队列。被窃取任务的线程永远从双端队列的头部拿任务执行，而窃取任务的线程永远从双端队列的尾部那任务执行。</p>
</blockquote>
<p><strong>优点：</strong>充分利用了线程进行并行计算，并减少线程之间的竞争。</p>
<p><strong>缺点：</strong>某些情况下，还是存在竞争，比如，双端队列里只有一个任务时，同时执行会消耗更多的系统资源。比如，创建了多个线程和多个双端队列。</p>
<p>​    对于<strong>ForkJoin</strong>框架而言，当一个任务正在等待它使用 <strong>join()</strong> 操作创建的子任务结束时。执行这个任务的工作线程，它的其他未被执行的任务会开始它的执行。通过这种方式，线程充分利用他们的运行时间来提高应用程序的性能。</p>
<p><strong>为了达到这个目标，ForkJoin框架有一些局限性。具体有：</strong></p>
<p>任务始终只能够使用Fork（）或Join()操作来作为同步机制。如果使用了为他同步机制，当那个它们在同步工作时，工作线程就不能执行任务了。比如：在ForkJoin框架中，你使任务进入了睡眠，这个睡眠期间内执行其他任务的工作线程将不能执行其他任务了。</p>
<p>第二个局限性，我们所拆分的任务不应该去执行IO操作，如读或写数据文件；</p>
<p>第三个局限性，任务不能抛出或检查异常，它必须通过bug的代码来处理它</p>
<p>ForkJoin框架的核心是两个类，ForkJoinPool和ForkJoinTask.,Pool负责来做实现，包括工作窃取算法，它管理工作线程和提供任务工作的状态和它们的执行信息。而ForkJoinTask主要负责在任务中执行 <strong>Fork()</strong> 或者 <strong>Join()</strong> 操作的机制。</p>
<h3 id="代码演示ForkJoin的使用："><a href="#代码演示ForkJoin的使用：" class="headerlink" title="代码演示ForkJoin的使用："></a>代码演示ForkJoin的使用：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinTaskExample</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> threshold = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> end;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ForkJoinTaskExample</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//如果任务足够小就计算任务</span></span><br><span class="line">        <span class="keyword">boolean</span> canCompute = (end - start) &lt;= threshold;</span><br><span class="line">        <span class="keyword">if</span> (canCompute) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">                sum += i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果任务大于阈值，就分裂成两个子任务计算</span></span><br><span class="line">            <span class="keyword">int</span> middle = (start + end) / <span class="number">2</span>;</span><br><span class="line">            ForkJoinTaskExample leftTask = <span class="keyword">new</span> ForkJoinTaskExample(start, middle);</span><br><span class="line">            ForkJoinTaskExample rightTask = <span class="keyword">new</span> ForkJoinTaskExample(middle + <span class="number">1</span>, end);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 执行子任务</span></span><br><span class="line">            leftTask.fork();</span><br><span class="line">            rightTask.fork();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 等待任务执行结束合并其结果</span></span><br><span class="line">            <span class="keyword">int</span> leftResult = leftTask.join();</span><br><span class="line">            <span class="keyword">int</span> rightResult = rightTask.join();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 合并子任务</span></span><br><span class="line">            sum = leftResult + rightResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ForkJoinPool forkjoinPool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//生成一个计算任务，计算1+2+3+4</span></span><br><span class="line">        ForkJoinTaskExample task = <span class="keyword">new</span> ForkJoinTaskExample(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//执行一个任务</span></span><br><span class="line">        Future&lt;Integer&gt; result = forkjoinPool.submit(task);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">"result:&#123;&#125;"</span>, result.get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"exception"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代码执行结果</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">26</span>:<span class="number">35.223</span> [main] INFO com.mmall.concurrency.example.aqs.ForkJoinTaskExample - result:<span class="number">5050</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>组件</tag>
        <tag>ForkJoin</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十五）JUC-线程调度-线程池-常用API与线程池框架</title>
    <url>/2020/04/22/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%E4%BA%94%EF%BC%89JUC-%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6-%E7%BA%BF%E7%A8%8B%E6%B1%A0-%E5%B8%B8%E7%94%A8API%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%A1%86%E6%9E%B6/</url>
    <content><![CDATA[<h2 id="线程池常用API"><a href="#线程池常用API" class="headerlink" title="线程池常用API"></a>线程池常用API</h2><h3 id="提交任务的方法："><a href="#提交任务的方法：" class="headerlink" title="提交任务的方法："></a><strong>提交任务的方法：</strong></h3><blockquote>
<p>execute () : 提交任务，交给线程池执行</p>
<p>submit () : 提交任务，能够返回执行结果 execute + Future</p>
</blockquote>
<h3 id="关闭线程池的方法："><a href="#关闭线程池的方法：" class="headerlink" title="关闭线程池的方法："></a><strong>关闭线程池的方法：</strong></h3><blockquote>
<p>shutdown ( ) : 关闭线程池，等待任务都执行完</p>
<p>shutdownNow () ： 关闭线程池，不等待任务执行完</p>
</blockquote>
<h3 id="使用与监控的方法："><a href="#使用与监控的方法：" class="headerlink" title="使用与监控的方法："></a><strong>使用与监控的方法：</strong></h3><blockquote>
<p>getTaskCount ( ): 线程池已执行和未执行的任务总数</p>
<p>   get CompletedTaskCount ( ) :  已完成的任务数量</p>
<p>   getPoolSize ( ) : 线程池当前的线程数量</p>
<p>   getActiveCount ( ) : 当前线程池中正在执行任务的线程数量</p>
</blockquote>
<h3 id="ThreadPoolExecutor常见方法-总览："><a href="#ThreadPoolExecutor常见方法-总览：" class="headerlink" title="ThreadPoolExecutor常见方法 总览："></a><strong>ThreadPoolExecutor常见方法 总览：</strong></h3><img src="http://photo.wushaopei.com/qiniu462.png" width="60%">

<h2 id="线程池的类图："><a href="#线程池的类图：" class="headerlink" title="线程池的类图："></a>线程池的类图：</h2><img src="http://photo.wushaopei.com/qiniu463.png" width="60%">

<p>Executors是根据一组执行策略执行调度调用异步任务的框架，目的是将任务提交与任务运行分离开来处理。</p>
<p>JUC里有<strong>三个Executor接口，</strong>分别是<code>Executor、ExecutorService、ScheduledExecutorService</code></p>
<blockquote>
<p> Executor是一个运行新任务的简单接口；</p>
<pre><code>ExecutorService扩展了Executor接口，添加了用来管理执行器、生命周期和任务声明周期的方法；

ScheduledExecutorService扩展了ExecutorService接口，支持Future和定期执行任务.</code></pre></blockquote>
<h3 id="通过Executors提供的四种创建线程池的方法："><a href="#通过Executors提供的四种创建线程池的方法：" class="headerlink" title="通过Executors提供的四种创建线程池的方法："></a>通过Executors提供的四种创建线程池的方法：</h3><p>  <strong>第一种：</strong><code>Executors.newCachedThreadPool</code></p>
<blockquote>
<p>它可以创建一个可缓存的线程池。如果线程池的长度超过了处理的需要，可以灵活回收空闲线程，如果没有可回收的，就新建线程 </p>
</blockquote>
<p><strong>第二种 :</strong>  <code>Executors.newFixedThreadPool</code></p>
<blockquote>
<p>它创建的是一个定长的线程池，可以创建线程池的最大线程数，超出的任务会在队列中等待 </p>
</blockquote>
<p><strong>第三种，</strong> <code>Executors.newScheduledThreadPool</code></p>
<blockquote>
<p>它创建的也是一个定长的线程池，它支持定时以及周期性的任务执行； </p>
</blockquote>
<p><strong>第四种，</strong><code>Executors.newSingleThreadExecutor</code></p>
<blockquote>
<p>它是一个单线程化的线程池，它会用唯一的一个工作线程来执行任务，保证所有任务按照指定顺序去执行。该顺序可以按照指定先入先出、优先级等等来设定 </p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>线程池常用API</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十三）J-U-C-组件-BlockingQueue</title>
    <url>/2020/04/17/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%E4%B8%89%EF%BC%89J-U-C-%E7%BB%84%E4%BB%B6-BlockingQueue/</url>
    <content><![CDATA[<h2 id="J-U-C-BlockingQueue"><a href="#J-U-C-BlockingQueue" class="headerlink" title="J.U.C-BlockingQueue"></a>J.U.C-BlockingQueue</h2><p>BlockingQueue， 阻塞队列 </p>
<img src="http://photo.wushaopei.com/qiniu392.png" width="60%">

<p>BlockingQueue，在某些情况下，对该队列的访问，可能会造成阻塞。</p>
<p><strong>被阻塞的情况主要有如下两种：</strong> </p>
<pre><code>第一种：当队列满的时候，进行入队列操作；

第二种：当队列空的时候，进行出队列操作</code></pre><p>当一个线程对一个满了的队列进行入队列操作的时候，它就会阻塞，除非有另一个线程做了出队列的操作。同样的，当一个线程对一个空的队列做出队列操作时，它也将被阻塞，除非有一个线程做了如队列操作。</p>
<p>阻塞队列是线程安全的，阻塞队列主要用作生产者和消费者的场景。由图进行分析：负责生产的线程T1不断制造新对象并插入到队列中，知道达到队列的上限值，此时，生产线程将被阻塞，知道消费者线程T2开始对这个队列进行消费。</p>
<p>同理，负责消费的线程不断从队列中消费对象，知道队列为空。当队列为空时，消费线程将会被阻塞，知道队列中有新的线程被插入进来。</p>
<h3 id="BlockingQueue主要方法示意图："><a href="#BlockingQueue主要方法示意图：" class="headerlink" title="BlockingQueue主要方法示意图："></a>BlockingQueue主要方法示意图：</h3><table>
<thead>
<tr>
<th>-</th>
<th>Throws Exception</th>
<th>Special Value</th>
<th>Blocks</th>
<th>Times Out</th>
</tr>
</thead>
<tbody><tr>
<td>Insert</td>
<td>add(o)</td>
<td>offer(o)</td>
<td>put(o)</td>
<td>offer(o,timeout,timeunit)</td>
</tr>
<tr>
<td>Remove</td>
<td>remove(o)</td>
<td>poll()</td>
<td>take()</td>
<td>poll(timeout,timeunit)</td>
</tr>
<tr>
<td>Examine</td>
<td>element()</td>
<td>peek</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="BlockingQueue的主要实现类："><a href="#BlockingQueue的主要实现类：" class="headerlink" title="BlockingQueue的主要实现类："></a>BlockingQueue的主要实现类：</h3><ul>
<li>ArrayBlockingQueue</li>
<li>DelayQueue</li>
<li>LinkedBlockingQueue</li>
<li>PriorityBlockingQueue</li>
<li>SynchronousQueue</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>组件</tag>
        <tag>BlockingQueue</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十七）JUC-多线程并发扩展</title>
    <url>/2020/04/28/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%E4%B8%83%EF%BC%89JUC-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91%E6%89%A9%E5%B1%95/</url>
    <content><![CDATA[<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><h3 id="死锁的定义"><a href="#死锁的定义" class="headerlink" title="死锁的定义"></a>死锁的定义</h3><p>所谓的<strong>死锁</strong>是指两个或两个以上的线程在等待执行的过程中，因为竞争资源而造成的一种互相等待的现象。若不受外力作用，他们都将无法推进下去。此时，处于系统中所处的状态就是死锁。 </p>
<h3 id="发生死锁所必须具备的条件："><a href="#发生死锁所必须具备的条件：" class="headerlink" title="发生死锁所必须具备的条件："></a>发生死锁所必须具备的条件：</h3><p><strong>互斥条件：</strong>它是指进程对所分配的资源进行排他性的使用，在一定时间内，某资源只由一个进程在用，如果此时还有其他进程请求资源，请求者只能等待。直到占有资源的进程用完或释放之后才可以继续使用。</p>
<p><strong>请求和保持条件：</strong>它是指进程已经保持了至少一个资源，又提出了新的资源请求，该资源已被其它进程占用。此时，请求进程阻塞，对自己或者其它资源保持不放；</p>
<p><strong>不剥夺条件：</strong> 指进程获取资源在用完之前不能被剥夺，只能在使用完后再由自己释放；</p>
<p><strong>环路等待条件：</strong> 发生死锁的时候，一定存在一个进程的资源是一个环形的链。</p>
<h3 id="代码演示死锁："><a href="#代码演示死锁：" class="headerlink" title="代码演示死锁："></a>代码演示死锁：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个简单的死锁类</span></span><br><span class="line"><span class="comment"> * 当DeadLock类的对象flag==1时（td1），先锁定o1,睡眠500毫秒</span></span><br><span class="line"><span class="comment"> * 而td1在睡眠的时候另一个flag==0的对象（td2）线程启动，先锁定o2,睡眠500毫秒</span></span><br><span class="line"><span class="comment"> * td1睡眠结束后需要锁定o2才能继续执行，而此时o2已被td2锁定；</span></span><br><span class="line"><span class="comment"> * td2睡眠结束后需要锁定o1才能继续执行，而此时o1已被td1锁定；</span></span><br><span class="line"><span class="comment"> * td1、td2相互等待，都需要得到对方锁定的资源才能继续执行，从而死锁。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//静态对象是类的所有对象共享的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object o1 = <span class="keyword">new</span> Object(), o2 = <span class="keyword">new</span> Object();</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"flag:&#123;&#125;"</span>, flag);</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (o1) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (o2) &#123;</span><br><span class="line">                    log.info(<span class="string">"1"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (o2) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (o1) &#123;</span><br><span class="line">                    log.info(<span class="string">"0"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DeadLock td1 = <span class="keyword">new</span> DeadLock();</span><br><span class="line">        DeadLock td2 = <span class="keyword">new</span> DeadLock();</span><br><span class="line">        td1.flag = <span class="number">1</span>;</span><br><span class="line">        td2.flag = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//td1,td2都处于可执行状态，但JVM线程调度先执行哪个线程是不确定的。</span></span><br><span class="line">        <span class="comment">//td2的run()可能在td1的run()之前运行</span></span><br><span class="line">        <span class="keyword">new</span> Thread(td1).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(td2).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">13</span>:<span class="number">12.979</span> [Thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.deadLock.DeadLock - flag:<span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">13</span>:<span class="number">12.979</span> [Thread-<span class="number">0</span>] INFO com.mmall.concurrency.example.deadLock.DeadLock - flag:<span class="number">1</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure>



<h2 id="多线程并发最佳实践"><a href="#多线程并发最佳实践" class="headerlink" title="多线程并发最佳实践"></a>多线程并发最佳实践</h2><h4 id="使用本地变量："><a href="#使用本地变量：" class="headerlink" title="使用本地变量："></a>使用本地变量：</h4><blockquote>
<p>应该使用本地变量，而不是创建一个类或实例变量。通常情况下，开发人员使用对象实例作为一个类，可以节省内存，并可以重用。因为每次在方法中创建新的本地变量会消耗很多内存。 </p>
</blockquote>
<h4 id="使用不可变类："><a href="#使用不可变类：" class="headerlink" title="使用不可变类："></a>使用不可变类：</h4><blockquote>
<p>如 String 、Integer等，一旦创建就不会改变了，不可变类可以降低代码中的同步数量 </p>
</blockquote>
<h4 id="最小化锁的作用域范围："><a href="#最小化锁的作用域范围：" class="headerlink" title="最小化锁的作用域范围："></a>最小化锁的作用域范围：</h4><blockquote>
<p>S=1/(1-a+a/n) </p>
</blockquote>
<h4 id="使用线程池的Executor，而不是直接new-Thread执行："><a href="#使用线程池的Executor，而不是直接new-Thread执行：" class="headerlink" title="使用线程池的Executor，而不是直接new Thread执行："></a>使用线程池的Executor，而不是直接new Thread执行：</h4><blockquote>
<p>创建一个线程的代价是昂贵的，如果你要得到一个可伸缩的java应用，那么你需要使用线程池，从线程池来管理线程，jdk中提供了各种方法实现 </p>
</blockquote>
<h4 id="宁可使用同步也不要使用线程的wait和notify"><a href="#宁可使用同步也不要使用线程的wait和notify" class="headerlink" title="宁可使用同步也不要使用线程的wait和notify"></a>宁可使用同步也不要使用线程的wait和notify</h4><blockquote>
<p>从java1.5以后增加了许多的同步工具，要优先使用同步工具，而不是使用wait和notify方法 </p>
</blockquote>
<h4 id="使用BlockingQueue实现生产-消费模式"><a href="#使用BlockingQueue实现生产-消费模式" class="headerlink" title="使用BlockingQueue实现生产-消费模式"></a>使用BlockingQueue实现生产-消费模式</h4><h4 id="使用并发集合而不是加了锁的同步集合"><a href="#使用并发集合而不是加了锁的同步集合" class="headerlink" title="使用并发集合而不是加了锁的同步集合"></a>使用并发集合而不是加了锁的同步集合</h4><h4 id="使用Semaphore创建有界的访问"><a href="#使用Semaphore创建有界的访问" class="headerlink" title="使用Semaphore创建有界的访问"></a>使用Semaphore创建有界的访问</h4><h4 id="使用Semaphore创建有界的访问-1"><a href="#使用Semaphore创建有界的访问-1" class="headerlink" title="使用Semaphore创建有界的访问"></a>使用Semaphore创建有界的访问</h4><h4 id="避免使用静态变量"><a href="#避免使用静态变量" class="headerlink" title="避免使用静态变量"></a>避免使用静态变量</h4><h2 id="Spring与线程安全"><a href="#Spring与线程安全" class="headerlink" title="Spring与线程安全"></a>Spring与线程安全</h2><blockquote>
<p> Spring bean  : singleton 、 prototype </p>
<p> 无状态对象</p>
</blockquote>
<p><strong>无状态对象：</strong>就是自身没有状态的对象，当然也就不会因为多个线程交替调度破坏自身的状态而导致安全问题。无状态对象包括经常使用的DTO、VO，只作为数据实体的模型对象。 </p>
<h2 id="HashMap与ConcurrentHashMap解析"><a href="#HashMap与ConcurrentHashMap解析" class="headerlink" title="HashMap与ConcurrentHashMap解析"></a>HashMap与ConcurrentHashMap解析</h2><h3 id="HashMap-的数据结构："><a href="#HashMap-的数据结构：" class="headerlink" title="HashMap 的数据结构："></a>HashMap 的数据结构：</h3><p>在java编程语言中，最基本的结构有两种，一个是数组，另外一个就是指针，即引用。 </p>
<img src="http://photo.wushaopei.com/qiniu481.png" width="80%">

<p>HashMap的底层就是一个数组结构，数组的每一项又是一个链表，当我们新建HashMap的时候就会初始化一个数组出来。</p>
<p>HashMap有两个参数影响它的性能，分别是<strong>初始容量</strong>和<strong>加载因子。</strong></p>
<img src="http://photo.wushaopei.com/qiniu482.png" width="80%">

<p>由源码可知，HashMap的初始容量为16, </p>
<img src="http://photo.wushaopei.com/qiniu483.png" width="80%">

<p>由上图中，可知HashMap的默认加载因子为0.75. </p>
<img src="http://photo.wushaopei.com/qiniu484.png" width="80%">

<p>当HashMap 的长度达到的容量长度满足初始值的0.75时，就会调用resize()方法进行扩容： </p>
<img src="http://photo.wushaopei.com/qiniu485.png" width="80%">

<p>我们也可以根据需要指定HashMap的初始化容量和加载因子。 </p>
<h4 id="HashMap-的线程安全性："><a href="#HashMap-的线程安全性：" class="headerlink" title="HashMap 的线程安全性："></a>HashMap 的线程安全性：</h4><p>HashMap是线程不安全的，主要体现在前面的resize()方法，它可能会导致死循环的发生，并且在使用迭代器的时候fasfree。当HashMap的长度超过了它的capacity * loadFactor时，就需要对它进行扩容，具体方法是：它要创建一个新的长度为原来容量的两倍的数组。它保证新的容量为2的N次方，从而保证寻址的方式依然适用。同时，它原来的数组会全部插入到新的数组中。这个过程我们称之为rehash。</p>
<p>这个方法并不保证线程安全，而且在多线程并发调用时可能陷入死循环。</p>
<h4 id="HashMap的ReHash-操作示意图："><a href="#HashMap的ReHash-操作示意图：" class="headerlink" title="HashMap的ReHash 操作示意图："></a>HashMap的ReHash 操作示意图：</h4><p>单线程下的ReHash操作： </p>
<img src="http://photo.wushaopei.com/qiniu486.png" width="80%">

<p>多线程下的ReHash操作： </p>
<img src="http://photo.wushaopei.com/qiniu487.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu488.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu489.png" width="80%">

<h3 id="ConcurrentHashMap的底层数据结构："><a href="#ConcurrentHashMap的底层数据结构：" class="headerlink" title="ConcurrentHashMap的底层数据结构："></a>ConcurrentHashMap的底层数据结构：</h3><img src="http://photo.wushaopei.com/qiniu490.png" width="80%">

<h3 id="ConcurrentHashMap和HashMap的不同点："><a href="#ConcurrentHashMap和HashMap的不同点：" class="headerlink" title="ConcurrentHashMap和HashMap的不同点："></a>ConcurrentHashMap和HashMap的不同点：</h3><blockquote>
<ul>
<li>ConcurrentHashMap是线程安全的，HashMap是线程不安全的；</li>
<li>HashMap允许key\value为空，而ConcurrentHashMap是不允许的</li>
</ul>
</blockquote>
<h3 id="ConcurrentHashMap-改进后"><a href="#ConcurrentHashMap-改进后" class="headerlink" title="ConcurrentHashMap 改进后"></a>ConcurrentHashMap 改进后</h3><img src="http://photo.wushaopei.com/qiniu491.png" width="80%">

<p>Java7以后针对并发访问引入了Segment这个结构，实现了分段锁，提高并发度，与Segment的个数是相等的。Java8以后为了进一步提高并发性，它废弃了这里面的分段锁方案，并且直接使用一个大的数组，同时为了提高hash碰撞下的寻址做了性能优化。</p>
<p>Java8以后它的链表的长度超过一定的值（默认为8），这里的链表就会变成了红黑树。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>死锁</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十四）JUC-线程调度-线程池-概念与API</title>
    <url>/2020/04/22/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%E5%9B%9B%EF%BC%89JUC-%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6-%E7%BA%BF%E7%A8%8B%E6%B1%A0-%E6%A6%82%E5%BF%B5%E4%B8%8EAPI/</url>
    <content><![CDATA[<h2 id="线程池-概念与API"><a href="#线程池-概念与API" class="headerlink" title="线程池-概念与API"></a>线程池-概念与API</h2><h2 id="引子："><a href="#引子：" class="headerlink" title="引子："></a><strong>引子：</strong></h2><p>实际上，在开发中并不会普遍的使用Thread，因为它具有一些弊端，对并发性能的影响比较大，如下： </p>
<blockquote>
<p><strong>new Thread 弊端：</strong></p>
<p>​         每次 new Thread 新建对象，性能差；</p>
<p>​         线程缺乏统一管理，可能无限制的新建线程，相互竞争，有可能占用过多系统资源导致死机或OOM；</p>
<p>​         缺少更多功能，如更多执行、定期执行、线程中断</p>
</blockquote>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><h3 id="线程池的好处"><a href="#线程池的好处" class="headerlink" title="线程池的好处"></a>线程池的好处</h3><blockquote>
<p>重用存在的线程，减少对象创建、消亡的开销，性能佳；</p>
<p>可有效控制最大并发线程数，提高系统资源利用率，同时可以避免过多资源竞争，避免阻塞；</p>
<p>提供定时执行、定期执行、单线程、并发数控制等功能</p>
</blockquote>
<h3 id="线程池相关的类-ThreadPoolExecutor"><a href="#线程池相关的类-ThreadPoolExecutor" class="headerlink" title="线程池相关的类 - ThreadPoolExecutor"></a>线程池相关的类 - ThreadPoolExecutor</h3><h4 id="第一种：线程池-ThreadPoolExecutor"><a href="#第一种：线程池-ThreadPoolExecutor" class="headerlink" title="第一种：线程池 - ThreadPoolExecutor"></a>第一种：线程池 - ThreadPoolExecutor</h4><h4 id="其主要参数有："><a href="#其主要参数有：" class="headerlink" title="其主要参数有："></a><strong>其主要参数有：</strong></h4><table>
<thead>
<tr>
<th>corePoolSize</th>
<th>核心线程数量</th>
</tr>
</thead>
<tbody><tr>
<td>maximumPoolSize</td>
<td>线程最大线程数</td>
</tr>
<tr>
<td>workQueue</td>
<td>阻塞队列，存储等待执行的任务，很重要，会对线程运行过程产生重大影响</td>
</tr>
</tbody></table>
<h4 id="具体说一下以上3个主要参数的关系："><a href="#具体说一下以上3个主要参数的关系：" class="headerlink" title="具体说一下以上3个主要参数的关系："></a><strong>具体说一下以上3个主要参数的关系：</strong></h4><ul>
<li>如果运行的线程数少于 corePooSize，直接创建新线程来处理任务，即使线程池中的其他线程是空闲的；</li>
<li>如果线程池中的线程数量大于等于corePooSize， 且小于maximumPoolSize的时候，则只有当workQueue满了的时候，才会创建新的执行线程去处理任务。 </li>
<li>如果我们设置的corePooSize和maximumPoolSize的数量相同的话，那么由于线程池的大小是固定的，这时候如果有新任务提交，如果里面的workQueue还没满的时候，就会把请求放入到workQueue里面，等待有空闲的线程，去workQueue里面去取出来进行处理。 </li>
<li>如果当前运行的线程数量大于等于maximumPoolSize时，如果此时workQueue也满了，那么就会通过拒绝策略 指定策略去处理任务。 </li>
</ul>
<p>所以，在任务提交时，它的<strong>顺序主要有三个</strong>，先判断是否<strong>小于corePooSize</strong>，如果小于它，就直接创建新线程来调用任务；然后再接着判断<strong>workQueue</strong>，最后再判断与maximumPoolSize的比较结果。 </p>
<p>扩展连接地址：<a href="https://blog.csdn.net/xiaojin21cen/article/details/87363143" target="_blank" rel="noopener">https://blog.csdn.net/xiaojin21cen/article/details/87363143</a> </p>
<h4 id="其他参数："><a href="#其他参数：" class="headerlink" title="其他参数："></a><strong>其他参数：</strong></h4><table>
<thead>
<tr>
<th><strong>keepAliveTime</strong></th>
<th><strong>线程没有任务执行时最多保持多久时间终止</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>unit</strong></td>
<td><strong>keepAliveTime的时间单位</strong></td>
</tr>
<tr>
<td><strong>threadFactory</strong></td>
<td><strong>threadFactory</strong></td>
</tr>
<tr>
<td><strong>threadFactory</strong></td>
<td><strong>threadFactory</strong></td>
</tr>
</tbody></table>
<ul>
<li><strong>keepAliveTime</strong>  ：  线程池维护线程所允许的空闲时间；当线程池中的线程数量大于corePooSize时，如果这时没有新的任务提交，核心线程外的线程不会立即销毁，而是会一直等待，直.到等待的时间超过了keepAliveTime. </li>
<li><strong>threadFactory</strong>   ：  线程池中默认会有一个默认的工厂用来创建线程；默认的工厂来创建线程时，会使新创建的线程会具有相同的优先级，并且是可以守护的线程。同时它也设置了线程的名称。 </li>
</ul>
<h4 id="线程池对线程的具体处理策略："><a href="#线程池对线程的具体处理策略：" class="headerlink" title="线程池对线程的具体处理策略："></a><strong>线程池对线程的具体处理策略</strong>：</h4><p>如果线程池中的workQueue 满了，这时候还继续提交任务，我们就需要采取一种策略来处理这个任务。 </p>
<p><strong>线程池总共提供了四种策略：</strong>  </p>
<ul>
<li>第一种是直接抛出异常，这也是默认的策略；默认是直接抛出异常；</li>
<li>第二种是用调用者所在的线程来执行任务；</li>
<li>第三种是丢弃队列中最靠前的任务并执行当前任务；</li>
</ul>
<p>最后一种策略是直接丢弃这个任务。 </p>
<h4 id="线程池实例的创建分析："><a href="#线程池实例的创建分析：" class="headerlink" title="线程池实例的创建分析："></a><strong>线程池实例的创建分析：</strong></h4><p><strong>常用的线程池创建如下：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ExecutorService exec = Executors.newCachedThreadPool();</span><br></pre></td></tr></table></figure>

<h4 id="该实例的底层实现是："><a href="#该实例的底层实现是：" class="headerlink" title="该实例的底层实现是："></a><strong>该实例的底层实现是：</strong></h4><img src="http://photo.wushaopei.com/qiniu459.png" width="60%">

<p>由源码可知，Executors创建线程池的底层实际是由 ThreadPoolExecutor的实例初始化返回的，再进入ThreadPoolExecutor底层看一看： </p>
<img src="http://photo.wushaopei.com/qiniu460.png" width="60%">

<p>ThreadPoolExecutor的实例化包括但不限于上图中的构造方法的实现，当前图中的参数包含了所有可能需要用到的参数，这里对线程工厂和策略都做了参数传入。具体需要根据业务需求进行选择相应的构造器。 </p>
<img src="http://photo.wushaopei.com/qiniu461.png" width="60%">

<p>当我们初试化了一个线程池之后，它通常有RUNNING、SHUTDOWN、STOP、TIDYING、TERMINATED集中状态。</p>
<table>
<thead>
<tr>
<th>RUNNING</th>
<th>能接收新提交的任务，并且也能阻塞队列中的任务；</th>
</tr>
</thead>
<tbody><tr>
<td><strong>SHUTDOWN</strong></td>
<td><strong>当一个线程处于shutdown状态时，不能接收、处理新提交的任务；但是可以处理阻塞队列中已经保存的任务；     在线程池处于Running状态时，调用shutdown（）方法就会进入到SHUTDOWN状态</strong></td>
</tr>
<tr>
<td><strong>STOP</strong></td>
<td><strong>stop 状态不接收新的任务，也不处理队列中的任务；它会中断正在处理任务的队列中的线程 ;   线程池处理Running状态的任务时，如果调用了shutdownNow()方法会使线程池进入到该状态；</strong></td>
</tr>
<tr>
<td><strong>TIDYING</strong></td>
<td><strong>如果所有任务都终止了，这时候的有效线程数为0，线程池就会进入到该状态</strong></td>
</tr>
<tr>
<td><strong>TERMINATED</strong></td>
<td><strong>在TIDYING状态时调用terminated()方法就会进入到TERMINATED状态，默认的terminated()方法什么都不会做。只是会在调用terminated()方法让线程池进入到TERMINATED状态。</strong></td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>线程池</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二）并发基础-CPU多级缓存机制</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80-CPU%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h2 id="CPU多级缓存-缓存一致性"><a href="#CPU多级缓存-缓存一致性" class="headerlink" title="CPU多级缓存-缓存一致性"></a>CPU多级缓存-缓存一致性</h2><h3 id="CPU多级缓存"><a href="#CPU多级缓存" class="headerlink" title="CPU多级缓存"></a>CPU多级缓存</h3><img src="http://photo.wushaopei.com/qiniu178.png" width="60%">

<p>​    上图展示的是CPU高级缓存的配置，数据的读取和存储都经过高速缓存，CPU核心与高速缓存之间有一条特殊的快速通道；在这个简化的图中，主存和缓存都连接在系统总线上，这条总线同时还用于其他组件的通信。 </p>
<img src="http://photo.wushaopei.com/qiniu179.png" width="60%">

<p>​    高速缓存出现后不久，系统变得更加复杂，高速缓存和主存之间的速度差异被拉大，直到加入L1d（又叫一级缓存）的缓存，新加入的这一个缓存比高速缓存更大，但是更慢，由于加大一级缓存的做法从经济上是行不通的。所以有了二级缓存。甚至，现在有些系统有了三级缓存。 </p>
<h3 id="CPU-cache"><a href="#CPU-cache" class="headerlink" title="CPU cache:"></a>CPU cache:</h3><h4 id="为什么需要CPU-cache？"><a href="#为什么需要CPU-cache？" class="headerlink" title="为什么需要CPU cache？"></a>为什么需要CPU cache？</h4><p>​    CPU的频率太快了，快到主存跟不上，这样在处理器时钟周期内，CPU常常需要等待主存，浪费资源。所以cache的出现，是为了缓解CPU和内存之间速度的不匹配问题（结构： CPU -&gt; cache - &gt;memory ）. </p>
<h4 id="CPU-cache-有什么意义？"><a href="#CPU-cache-有什么意义？" class="headerlink" title="CPU cache 有什么意义？"></a>CPU cache 有什么意义？</h4><blockquote>
<p> 1）时间局部性： 如果某个数据被访问，那么在不久的将来它很可能被再次访问；</p>
<p> 2）空间局部性： 如果某个数据被访问，那么与它相邻的数据很快也可能被访问；</p>
</blockquote>
<h3 id="CPU多级缓存-缓存一致性（MESI）"><a href="#CPU多级缓存-缓存一致性（MESI）" class="headerlink" title="CPU多级缓存 - 缓存一致性（MESI）"></a>CPU多级缓存 - 缓存一致性（MESI）</h3><p><strong>用于保证多个CPU cache之间缓存共享数据的一致</strong> </p>
<img src="http://photo.wushaopei.com/qiniu180.png" width="60%">

<p>*<em>M *</em> 代表 <code>modify</code>  ,表示被修改；指的是该缓存行只被缓存在该CPU的缓存中，并且是被修改过的，因此，它与主存中的数据是不一致的，该缓存中的内存需要在未来的某个时间点写回主存；这个时间点我们是允许其他CPU读取主存中相应的内存之间的值，当这里的值被写回主存之后，该缓存行的状态会变成E的状态；</p>
<p><strong>E</strong> 代表 <code>Exclusive</code>  ,表示独享状态；该状态下的缓存行只被缓存在该CPU的缓存中，它是未被修改过的，是与主存中的数据一直的，这个状态可以在任意时刻，当有其他读取该内存时，变成共享状态，即S;    同样，当CPU修改该缓存行时，该缓存行状态可以被修改为M 的状态。</p>
<p><strong>S</strong> 代表  <code>share</code>，代表共享的意思；该状态意味着该缓存行可能被多个CPU进行缓存，并且各个缓存数据和主存数据是一致的，当有一个CPU修改该缓存行时，其他CPU所有的缓存行是可以被作废的，变成I 的状态；</p>
<p><strong>I</strong> 代表 <code>invalid</code>，表示无效的；代表该缓存行是无效的，有其他CPU修改了该缓存行。</p>
<p><strong>四种操作：</strong></p>
<p><strong>local read</strong> 代表读本地缓存中的数据</p>
<p><strong>local write</strong> 代表将数据写到本地缓存中</p>
<p><strong>remote read</strong>   代表将内存中的数据读取过来，</p>
<p><strong>remote write</strong> 代表将数据写回到主存中</p>
<p><strong>状态转换示意图：</strong></p>
<img src="http://photo.wushaopei.com/qiniu181.png" width="60%">



<h2 id="CPU多级缓存-乱序执行优化"><a href="#CPU多级缓存-乱序执行优化" class="headerlink" title="CPU多级缓存 - 乱序执行优化"></a>CPU多级缓存 - 乱序执行优化</h2><h3 id="意义："><a href="#意义：" class="headerlink" title="意义："></a>意义：</h3><p>​    <code>处理器为提高运算速度而做出违背代码原有顺序的优化</code></p>
<img src="http://photo.wushaopei.com/qiniu182.png" width="60%">

<p><strong>a :</strong> 数据写入顺序，先写入a=10，再写入b=200,最后计算a*b的值</p>
<p><strong>b :</strong> 乱序执行的执行顺序：先执行b=200,再执行a=10，单核情况下不做任何影响。</p>
<blockquote>
<p> <font color=red>多核心</font>的情况下，可能由于乱序而导致各个核所写入数据的最终计算结果与预想的结果不一致。 </p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
        <tag>CPU多级缓存</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十七）J.U.C-AQS-Semaphore</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89J-U-C-AQS-Semaphore/</url>
    <content><![CDATA[<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>​    <strong>Semaphore</strong>维护了当前访问的个数，通过<strong>同步机制</strong>来控制同时访问个数，<strong>Semaphore</strong>可以保存有限个数的链表。 </p>
<h3 id="Semaphore的使用场景："><a href="#Semaphore的使用场景：" class="headerlink" title="Semaphore的使用场景："></a>Semaphore的使用场景：</h3><blockquote>
<p>常用于仅能提供有限访问的资源，比如项目中使用的数据库，数据库的链接数最大只有20，而项目的并发数可能远远大于20；如果同时对数据库进行操作，就可能出现因为无法取数据库连接数而导致的异常，这个时候就可以通过Semaphore来进行并发访问控制。当Semaphore把并发数控制到一定数量时，就和单线程很相似了。</p>
</blockquote>
<h3 id="Semaphore线程安全代码演示："><a href="#Semaphore线程安全代码演示：" class="headerlink" title="Semaphore线程安全代码演示："></a>Semaphore线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span>  <span class="keyword">int</span> threadCount = <span class="number">20</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; threadCount ; i++ )&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> threadNum = i;</span><br><span class="line">            exec.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();<span class="comment">// 获取一个许可</span></span><br><span class="line">                    test(threadNum);</span><br><span class="line">                    semaphore.release();<span class="comment">// 释放一个许可</span></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"finish"</span>);</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,threadNum);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行打印线程结果："><a href="#执行打印线程结果：" class="headerlink" title="执行打印线程结果："></a><strong>执行打印线程结果：</strong></h3><img src="http://photo.wushaopei.com/qiniu302.png" width="60%">

<p>由图中结果可以知道，代码中<strong>Semaphore</strong>限定了当前同时执行的线程数为3，而在统一时间只有<strong>3个线程被打印，</strong>一秒后又有3个线程被打印，由此可以说明<strong>Semaphore</strong>是可以实现线程安全操作的。 </p>
<h3 id="测试多个许可条件下的Semaphore业务场景："><a href="#测试多个许可条件下的Semaphore业务场景：" class="headerlink" title="测试多个许可条件下的Semaphore业务场景："></a>测试多个许可条件下的Semaphore业务场景：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">semaphore.acquire(<span class="number">3</span>);<span class="comment">// 获取多个许可</span></span><br><span class="line">test(threadNum);</span><br><span class="line">semaphore.release(<span class="number">3</span>);<span class="comment">// 释放多个许可</span></span><br></pre></td></tr></table></figure>

<h3 id="执行打印线程结果：-1"><a href="#执行打印线程结果：-1" class="headerlink" title="执行打印线程结果："></a><strong>执行打印线程结果：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">57.078</span> [main] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - finish</span><br><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">57.078</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">58.084</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">12</span>:<span class="number">59.084</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">13</span>:<span class="number">00.085</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">13</span>:<span class="number">01.085</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>由执行结果可知，每一秒Semaphore只执行一次线程操作，这是因为同一时间内获取3个许可，又同一时间内释放3个许可，就相当于是在同一时间内只执行一次test(threadNum)线程操作。而同一秒钟内拿到了3个许可，而与原本Semaphore定义的3个可执行线程数一校验，发现在同一秒钟内没有多余的许可可以释放了。这就很接近单线程的执行了。</p>
<h3 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h3><h4 id="场景需求：当前的并发数是3个，超过部分则丢弃："><a href="#场景需求：当前的并发数是3个，超过部分则丢弃：" class="headerlink" title="场景需求：当前的并发数是3个，超过部分则丢弃："></a><strong>场景需求：当前的并发数是3个，超过部分则丢弃：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(semaphore.tryAcquire())&#123; <span class="comment">//尝试获取一个许可</span></span><br><span class="line">    test(threadNum);</span><br><span class="line">    semaphore.release();<span class="comment">//释放一个许可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>当尝试获取一个许可，如果获取不到，就丢弃；获取到，就执行。又由于线程业务处理消耗了一秒，如：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    log.info(<span class="string">"&#123;&#125;"</span>,threadNum);</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，最终可能执行的线程数只有Semaphore最初定义时所并发执行的3个线程。 </p>
<h4 id="场景需求：超时时间内，执行许可："><a href="#场景需求：超时时间内，执行许可：" class="headerlink" title="场景需求：超时时间内，执行许可："></a><strong>场景需求：超时时间内，执行许可：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(semaphore.tryAcquire(<span class="number">5000</span>, TimeUnit.MILLISECONDS))&#123; <span class="comment">//尝试获取一个许可</span></span><br><span class="line">    test(threadNum);</span><br><span class="line">    semaphore.release();<span class="comment">//释放一个许可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当尝试在5秒内获取一个许可，如果超时后依旧获取不到，就丢弃；获取到，就执行。</p>
<p>最终可能执行的超过约定的初始3个线程，但不一定全部线程数都能够被执行。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
        <tag>Semaphore</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（五）并发模拟-工具</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%94%EF%BC%89%E5%B9%B6%E5%8F%91%E6%A8%A1%E6%8B%9F-%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<h2 id="并发模拟——工具"><a href="#并发模拟——工具" class="headerlink" title="并发模拟——工具"></a>并发模拟——工具</h2><h3 id="常用工具："><a href="#常用工具：" class="headerlink" title="常用工具："></a>常用工具：</h3><p>  <strong>Postman</strong> : Http请求模拟工具</p>
<p>  <strong>Apache Bench</strong> （<strong>AB</strong>） ： Apache附带的工具，测试网站性能</p>
<p>  <strong>JMeter</strong> : Apache 组织开发的压力测试工具</p>
<blockquote>
<p><strong>代码</strong>： Semaphore 、CountDownLatch等</p>
</blockquote>
<h3 id="并发模拟——POSTMAN"><a href="#并发模拟——POSTMAN" class="headerlink" title="并发模拟——POSTMAN"></a>并发模拟——POSTMAN</h3><img src="http://photo.wushaopei.com/qiniu190.png" width="80%">

<h4 id="创建测试接口："><a href="#创建测试接口：" class="headerlink" title="创建测试接口："></a><strong>创建测试接口：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> TestController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 15:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="新建测试用用户组："><a href="#新建测试用用户组：" class="headerlink" title="新建测试用用户组："></a>新建测试用用户组：</h4><p><strong>使用POSTMAN模拟并发：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu191.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu192.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu193.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu194.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu195.png" width="80%">

<h4 id="执行Run-Concurrency按钮："><a href="#执行Run-Concurrency按钮：" class="headerlink" title="执行Run Concurrency按钮："></a><strong>执行Run Concurrency按钮：</strong></h4><img src="http://photo.wushaopei.com/qiniu196.png" width="80%">



<h3 id="使用专业并发模拟测试工具——Apache-Bench-AB"><a href="#使用专业并发模拟测试工具——Apache-Bench-AB" class="headerlink" title="使用专业并发模拟测试工具——Apache Bench(AB)"></a>使用专业并发模拟测试工具——Apache Bench(AB)</h3><img src="http://photo.wushaopei.com/qiniu197.png" width="80%">

<p><strong>使用ab命令指定每秒的请求数和间隔时间以及请求接口地址</strong> </p>
<img src="http://photo.wushaopei.com/qiniu198.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu199.png" width="80%">

<h3 id="压测工具JMeter"><a href="#压测工具JMeter" class="headerlink" title="压测工具JMeter:"></a>压测工具JMeter:</h3><img src="http://photo.wushaopei.com/qiniu200.png" width="80%">

<p><strong>jmeter</strong>文件目录下文件概览： </p>
<img src="http://photo.wushaopei.com/qiniu201.png" width="80%">

<p><strong>启动方式：</strong> </p>
<blockquote>
<p>linux环境使用<strong>jmeter.sh</strong>启动脚本测试</p>
<p>Windows环境使用<strong>jmeter.bat</strong>启动脚本测试</p>
</blockquote>
<p><strong>使用界面：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu202.png" width="80%">

<p><strong>Ramp-Up Period</strong> 代表虚拟用户增长时长，可理解为一段时间内多个用户登录的总时间范围，如8点15到9点这段时间是打卡上班的时间，也就是45分钟*60秒=2700秒 </p>
<p><strong>添加HTTP请求：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu203.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu204.png" width="70%">

<p><strong>添加监听窗口-图形结果和察看结果树</strong> </p>
<img src="http://photo.wushaopei.com/qiniu205.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu206.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu207.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu208.png" width="70%">

<p><strong>点击绿色三角按钮启动HTTP请求</strong> </p>
<img src="http://photo.wushaopei.com/qiniu209.png" width="70%">

<p><strong>请求响应结果查看：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu210.png" width="70%">

<img src="http://photo.wushaopei.com/qiniu211.png" width="70%">



<h2 id="并发模拟-代码"><a href="#并发模拟-代码" class="headerlink" title="并发模拟-代码"></a>并发模拟-代码</h2><h3 id="CountDownLatch-计数器向下减的闭锁"><a href="#CountDownLatch-计数器向下减的闭锁" class="headerlink" title="CountDownLatch (计数器向下减的闭锁)"></a>CountDownLatch (计数器向下减的闭锁)</h3><img src="http://photo.wushaopei.com/qiniu212.png" width="70%">

<p>案例解析该类的使用： 假设计数器值 cnt = 3, 线程A在调用了await()方法之后，当前线程就进入了等待状态awaiting；之后在其他进程中每次执行countDown()方法（如T1）之后计数器 cnt 就会减一，然后当前线程继续执行；之后的T2、T3一次执行完成，当计数器 cnt 变成 0之后，线程A才会继续执行。</p>
<p><strong>说明： CountDownLatch这个类可以阻塞线程，并在满足某种特定条件下去执行。</strong></p>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><img src="http://photo.wushaopei.com/qiniu213.png" width="70%">

<p>假如一条公路上只有两条车道，那么同时只有两辆车可以通过同一个点；当两辆车中的其中一辆车让开以后，其他的等待的车就可以继续通过了。</p>
<p><strong>说明： Semaphore可以阻塞进程，并且可以控制同一时间请求的并发量</strong></p>
<blockquote>
<p><strong>CountDownLatch 和 Semaphore 通常会和线程池一起使用</strong></p>
</blockquote>
<h3 id="并发模拟"><a href="#并发模拟" class="headerlink" title="并发模拟"></a>并发模拟</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ConcurrencyTest</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 16:50</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span> <span class="comment">//该标识表示当前线程及线程池的并发处理使用方式不正确，建议不要这么写</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencyTest</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<p>第一次</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">16:58:27.063 [main] INFO com.mmall.concurrency.ConcurrencyTest - count:4944</span><br><span class="line"> </span><br><span class="line">Process finished <span class="keyword">with</span> <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>第二次： </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">16:59:48.185 [main] INFO com.mmall.concurrency.ConcurrencyTest - count:4938</span><br><span class="line"> </span><br><span class="line">Process finished <span class="keyword">with</span> <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：程序执行结果数量少于5000，并且每次都不同。所以这是不确定的结果，<strong>存在线程安全的问题。</strong> </p>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a><strong>小结：</strong></h3><p>  <strong>Postman</strong> : Http请求模拟工具</p>
<p>  <strong>Apache Bench(AB)</strong>：Apache附带的工具，测试网站性能</p>
<p>  <strong>JMeter</strong> ： Apache组织开发的压力测试工具</p>
<p>  <strong>代码</strong>： Semaphore、CountDownLatch等</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发模拟</tag>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十九）J-U-C-AQS-ReentrantLock与锁</title>
    <url>/2020/04/14/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B9%9D%EF%BC%89J-U-C-AQS-ReentrantLock%E4%B8%8E%E9%94%81/</url>
    <content><![CDATA[<h2 id="ReentrantLock与锁"><a href="#ReentrantLock与锁" class="headerlink" title="ReentrantLock与锁"></a>ReentrantLock与锁</h2><h3 id="ReentrantLock-可重入锁-和-synchronized-区别"><a href="#ReentrantLock-可重入锁-和-synchronized-区别" class="headerlink" title="ReentrantLock (可重入锁) 和 synchronized 区别"></a>ReentrantLock (可重入锁) 和 synchronized 区别</h3><p><strong>可重入性：</strong> ReentrantLock的字面意思就是可重入的，而synchronized也是属于可重入的，两者的却别不大；都是进入一次线程，锁的计数器就自增1，所以等到锁的计数器下降为0时才会释放锁。</p>
<p><strong>锁的实现：</strong> synchronized是依赖于JVM实现的，而ReentrantLock基于JDK实现的；两者的区别就类似于用户控制操作系统来实现和自己敲代码实现的区别；</p>
<p><strong>性能的区别</strong>：在synchronized的关键字优化以前，synchronized的性能比ReentrantLock的性能差很多；从synchronized引入了偏向锁、轻量级锁也就是自旋锁后，它们两者的性能就差不多了，在两者都可用的情况下，官方更建议使用synchronized的，因为它的写法更容易。</p>
<h4 id="功能区别："><a href="#功能区别：" class="headerlink" title="功能区别："></a><strong>功能区别</strong>：</h4><blockquote>
<p>从便利性来说：synchronized比较方便、简洁，并且它是有编译器去保证锁的加锁和释放的；而ReentrantLock需要我们来手动声明加锁和释放锁，为了避免忘记手动释放锁而导致死锁，最好是在finally中声明释放锁；</p>
<p>从细腻度和灵活度来说：ReentrantLock要优胜于synchronized的。</p>
</blockquote>
<h3 id="ReentrantLock独有的功能"><a href="#ReentrantLock独有的功能" class="headerlink" title="ReentrantLock独有的功能"></a>ReentrantLock独有的功能</h3><blockquote>
<ul>
<li>可指定是<strong>公平锁</strong>还是<strong>非公平锁</strong></li>
<li><strong>提供了一个Condition类，可以分组唤醒需要唤醒的线程</strong></li>
<li><strong>提供能够中断等待锁的线程的机制 ， lock.lockInterruptibly()</strong></li>
</ul>
</blockquote>
<p>所谓<strong>公平锁</strong> ，就是先等待的线程先获得锁，这一点<strong>ReentrantLock</strong>是独有的，可以自己选择公平还是不公平 </p>
<h3 id="ReentranLock的定义："><a href="#ReentranLock的定义：" class="headerlink" title="ReentranLock的定义："></a>ReentranLock的定义：</h3><blockquote>
<p><strong>ReentrantLock</strong>实际上是一种自旋锁，通过循环调用CAS操作来实现加锁，它的性能比较好也是因为避免了进入内核态的阻塞状态，想尽办法避免进入内核的阻塞状态是去分析和理解锁的设计的关键要素。 </p>
</blockquote>
<h3 id="什么情况下适合使用ReentrantLock呢？"><a href="#什么情况下适合使用ReentrantLock呢？" class="headerlink" title="什么情况下适合使用ReentrantLock呢？"></a>什么情况下适合使用ReentrantLock呢？</h3><blockquote>
<p>当你需要用到<strong>ReentrantLock</strong>这三个独立功能的时候你就必须使用<strong>ReentrantLock</strong>，而且你可以根据业务场景来选择使用<strong>ReentrantLock</strong>或者是<strong>Synchronized</strong>的。 </p>
</blockquote>
<h3 id="ReentrantLock-和-Synchronized"><a href="#ReentrantLock-和-Synchronized" class="headerlink" title="ReentrantLock 和 Synchronized"></a>ReentrantLock 和 Synchronized</h3><p>Synchronized 能做的事情，ReentrantLock都能做，而ReentrantLock能做的Synchronized却有许多都做不了，在性能方面ReentrantLock不比Synchronized差！</p>
<h4 id="那么，是否可以抛弃Synchronized呢？"><a href="#那么，是否可以抛弃Synchronized呢？" class="headerlink" title="那么，是否可以抛弃Synchronized呢？"></a><strong>那么，是否可以抛弃Synchronized呢？</strong></h4><blockquote>
<p>不可以，Javautil.current.lock包中的锁定类是应用于高级用户和高级情况的工具，一般来说，除非你对lock的某个高级的包邮明确的需要，或者有明确的证据。这里不仅仅是怀疑，而是表名特定的情况下，同步已经成为可伸缩性的瓶颈的时候，建议还是使用synchronized。</p>
<p>并且即使是相对于高级锁定类而言，synchronized也有它的优势，比如，使用synchronized 的时候，你不会忘记释放锁，退出synchronized块的时候，jvm会为你做这件事情。你会很容易忘记使用finally去释放锁，这对程序非常有害。你的程序会通过测试，但在实际工作中会出现死锁，当时会很指出原因。这也是很不建议初级开发人员使用ReentrantLock的好理由。</p>
<p>另外一个原因是，当JVM使用synchronized管理线程的锁定请求和释放时，JVM在生成线程转储时，能够包括锁定信息。这些信息对调试程序很有帮助。有利于分析死锁以及其它异常问题的来源。而lock类只是普通的，jvm不知道具体哪个线程拥有lock对象，而且几乎每个开发人员都熟悉synchronized的，它可以在JVM的所有版本中工作，在jdk5.0成为标准之前，使用lock类将意味着要利用lock的特性而不是每个JVM都有的，而且也不是每个开发人员都熟悉的。</p>
<p>所以，程序员在开发中遇到的大部分的加锁的情景都可以使用synchronized，那种特别高级的特殊情况还是很少的。</p>
</blockquote>
<h3 id="ReentrantLock相关类的代码演示；"><a href="#ReentrantLock相关类的代码演示；" class="headerlink" title="ReentrantLock相关类的代码演示；"></a>ReentrantLock相关类的代码演示；</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count );</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            count ++;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">47</span>:<span class="number">27.962</span> [main] INFO com.mmall.concurrency.example.lock.LockExample2 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="重要底层实现原理分析："><a href="#重要底层实现原理分析：" class="headerlink" title="重要底层实现原理分析："></a>重要底层实现原理分析：</h3><p>ReentrantLock的底层代码实现中： </p>
<img src="http://photo.wushaopei.com/qiniu321.png" width="60%">

<p>默认构造方法中生成给定的是一个不公平的锁； </p>
<img src="http://photo.wushaopei.com/qiniu322.png" width="60%">

<p>在带参构造中，根据传入的true或者false来决定是使用公平锁或不公平锁 </p>
<img src="http://photo.wushaopei.com/qiniu323.png" width="60%">

<p>仅在调用时锁定未被保持的情况下才获取锁定 </p>
<img src="http://photo.wushaopei.com/qiniu324.png" width="60%">

<p>如果锁定在给定的等待时间内没有被线程保持，且当前线程没有被中断，则获取这个锁定 </p>
<img src="http://photo.wushaopei.com/qiniu325.png" width="60%">

<p>如果当前线程没有被中断，就获取锁定；如果被中断，就抛出异常。 </p>
<img src="http://photo.wushaopei.com/qiniu326.png" width="60%">

<p>查询此锁定，是否有任意线程保持 </p>
<img src="http://photo.wushaopei.com/qiniu327.png" width="60%">

<p>查询当前线程是否处于锁定状态 </p>
<img src="http://photo.wushaopei.com/qiniu327.png" width="60%">

<p><strong>isFair()</strong> 作用是判断是不是公平锁 </p>
<h3 id="扩展：ReentrantReadWriteLock"><a href="#扩展：ReentrantReadWriteLock" class="headerlink" title="扩展：ReentrantReadWriteLock"></a>扩展：ReentrantReadWriteLock</h3><p><strong>作用</strong>：在没有任何读写锁的时候才可以取得写入锁 </p>
<blockquote>
<p>ReentrantReadWriteLock可以用于实现悲观读取，即读取时经常有另一个可能要写入的需求，为了保持同步，ReentrantReadWriteLock的读取锁定就可以派上用场了。如果读取情况很多，写入情况很少的情况下，使用ReentrantReadWriteLock可能会使写入线程遭遇饥饿，也就是说写入线程迟迟不能竞争到锁定，而一直等待。</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>AQS</tag>
        <tag>可重入锁</tag>
        <tag>ReentrantLock</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十五）J.U.C-AQS-简介</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89J-U-C-AQS-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><h3 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h3><p>​    <strong>AbstractQueuedSynchronizer</strong>简称<strong>AQS</strong>，<strong>AQS</strong>是<strong>JUC</strong>的核心，<strong>AQS</strong>是并发类的重中之重，可以用来构建锁的同步框架。 </p>
<h3 id="AQS底层的数据结构："><a href="#AQS底层的数据结构：" class="headerlink" title="AQS底层的数据结构："></a>AQS底层的数据结构：</h3><img src="http://photo.wushaopei.com/qiniu300.png" width="60%">

<h3 id="AQS的特点："><a href="#AQS的特点：" class="headerlink" title="AQS的特点："></a>AQS的特点：</h3><ul>
<li>使用Node实现FIFO队列，可以用于构建锁或者其它同步装置的基础框架</li>
<li>利用了一个int类型表示状态</li>
<li>使用方法是继承；</li>
<li>子类通过继承并通过实现它的方法管理其状态{ acquire 和 release } 的方法操纵状态；</li>
<li>可以同时实现排它锁和共享锁模式（独占、共享）</li>
</ul>
<h3 id="AQS具体实现的大致思路："><a href="#AQS具体实现的大致思路：" class="headerlink" title="AQS具体实现的大致思路："></a>AQS具体实现的大致思路：</h3><blockquote>
<p>AQS内部维护了一个CAS队列来管理锁，线程会首先尝试获取锁，如果失败就会将当前线程以及等待状态的信息包装成一个节点加入到之前的同步队列Sync queue里。接着会不断循环尝试获取锁，他的条件是当前节点为head的直接后进才会尝试。如果失败就会阻塞自己，知道自己被唤醒，而它持有锁的线程在释放锁的时候会唤醒队列中的后进线程，基于这些基础的设计和思路，jdk提供了许多基于AQS的子类。</p>
</blockquote>
<h3 id="AQS-同步组件"><a href="#AQS-同步组件" class="headerlink" title="AQS 同步组件"></a>AQS 同步组件</h3><ul>
<li>CountDownLatch<ul>
<li>CountDownLatch 是一个闭锁，通过线程计数来保证线程是否需要一直阻塞；</li>
</ul>
</li>
<li>Semaphore<ul>
<li>Semaphore能控制同一时间并发线程的数目</li>
</ul>
</li>
<li>CyclicBarrier</li>
<li>ReentrantLock</li>
<li>Condition</li>
<li>FutureTask</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十六）J.U.C-AQS-CountDownLatch</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89J-U-C-AQS-CountDownLatch/</url>
    <content><![CDATA[<h2 id="J-U-C之AQS-CountDownLatch"><a href="#J-U-C之AQS-CountDownLatch" class="headerlink" title="J.U.C之AQS-CountDownLatch"></a>J.U.C之AQS-CountDownLatch</h2><h3 id="J-U-C之AQS-CountDownLatch-1"><a href="#J-U-C之AQS-CountDownLatch-1" class="headerlink" title="J.U.C之AQS-CountDownLatch"></a>J.U.C之AQS-CountDownLatch</h3><img src="http://photo.wushaopei.com/qiniu301.png" width="60%">

<p><strong>说明：</strong> </p>
<blockquote>
<p>CountDownLatch是一个同步辅助类，通过它可以完成类似于阻塞当前线程的功能，换句话说一个线程或多个线程一直等待，直到其他线程执行的操作完成。 </p>
</blockquote>
<blockquote>
<p>Latch它使用一个给定的计数器来初始化，该计数器的操作是原子操作，就是同一时间只能有一个线程去操作计数器。调用该类的await()方法的线程会一直处于阻塞状态，直到线程调用countDown（）方法使当前的cnt值变成0，每次countDown时，计数器的值会减一。当计数器的值减到0的时候，所有因调用await()方法而处于等待状态的线程就会往下执行。这个操作只会出现一次，因为cnt值是不能被重置的。</p>
</blockquote>
<h3 id="CountDownLatch线程安全测试代码实例："><a href="#CountDownLatch线程安全测试代码实例：" class="headerlink" title="CountDownLatch线程安全测试代码实例："></a>CountDownLatch线程安全测试代码实例：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span>  <span class="keyword">int</span> threadCount = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(threadCount);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; threadCount ; i++ )&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> threadNum = i;</span><br><span class="line">            exec.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    test(threadNum);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        log.info(<span class="string">"finish"</span>); </span><br><span class="line">exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,threadNum);</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行打印结果："><a href="#执行打印结果：" class="headerlink" title="执行打印结果："></a><strong>执行打印结果：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">47</span>:<span class="number">37.052</span> [pool-<span class="number">1</span>-thread-<span class="number">101</span>] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - <span class="number">100</span></span><br><span class="line">.......</span><br><span class="line"><span class="number">22</span>:<span class="number">47</span>:<span class="number">37.060</span> [pool-<span class="number">1</span>-thread-<span class="number">192</span>] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - <span class="number">191</span></span><br><span class="line"><span class="number">22</span>:<span class="number">47</span>:<span class="number">37.192</span> [main] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - finish</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由打印结果可知，finish是在所有线程执行完后才执行的。</p>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a><strong>分析：</strong></h3><p>这是因为CountDownLatch.countDown()计数器已经降到0了，所以在最后的CountDownLatch.await()校验通过，接着就打印最后面的finish字段</p>
<h3 id="实现CountDownLatch在指定时间内完成："><a href="#实现CountDownLatch在指定时间内完成：" class="headerlink" title="实现CountDownLatch在指定时间内完成："></a>实现CountDownLatch在指定时间内完成：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//让CountDownLatch等待10毫秒</span></span><br><span class="line">countDownLatch.await(<span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>

<h3 id="作用-："><a href="#作用-：" class="headerlink" title="作用 ："></a><strong>作用</strong> ：</h3><p>​    可以给定时间让线程有时间反应过来执行。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十八）J.U.C-AQS-CyclicBarrier</title>
    <url>/2020/04/13/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E5%85%AB%EF%BC%89J-U-C-AQS-CyclicBarrier/</url>
    <content><![CDATA[<h2 id="J-U-C之AQS-CyclicBarrier"><a href="#J-U-C之AQS-CyclicBarrier" class="headerlink" title="J.U.C之AQS-CyclicBarrier"></a>J.U.C之AQS-CyclicBarrier</h2><h3 id="图解-CyclicBarrier"><a href="#图解-CyclicBarrier" class="headerlink" title="图解 CyclicBarrier"></a>图解 CyclicBarrier</h3><img src="http://photo.wushaopei.com/qiniu303.png" width="60%">

<p>CyclicBarrier是一个同步辅助类，它允许一组线程同步等待，直到某一个公共的屏障点，通过它可以实现线程之间的相互等待，每个线程都各自就绪后，才能够继续执行后续的操作。</p>
<p>它和CountDownLatch一样都是通过计数器来实现的。CyclicBarrier可以用于多线程计算数据，最后合并计算结果的应用场景。</p>
<p><strong>比如：</strong></p>
<p>我们用excel保存用户的银行流水，excel的每一页保存用户每一年的银行流水，现在我们要统计用户的日均流水，我们就可以用多线程处理每个页里面的银行流水，都执行完以后得到每一个页里面的日均银行流水，之后CyclicBarrier.action利用多线程计算结果再计算用户的日均银行流水。</p>
<h3 id="CyclicBarrier和CountDownLatch的区别："><a href="#CyclicBarrier和CountDownLatch的区别：" class="headerlink" title="CyclicBarrier和CountDownLatch的区别："></a>CyclicBarrier和CountDownLatch的区别：</h3><p>第一点：CountDownLatch的计数器只能使用一次，CyclicBarrier的计数器可以使用resume方法重置，重复使用；</p>
<p>第二点：CountDownLatch主要实现一个或N个线程需要等待其他线程完成某项操作之后才能去往下执行，它描述的是一个或N个线程等待其他线程的关系；</p>
<p>而CyclicBarrier是实现多个线程之间相互等待，在所有线程都满足条件之后才能去执行后续的操作，它描述的是各个线程内部相互等待的关系。</p>
<h3 id="CyclicBarrier线程安全代码演示："><a href="#CyclicBarrier线程安全代码演示：" class="headerlink" title="CyclicBarrier线程安全代码演示："></a>CyclicBarrier线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//告知当前有多少个线程同时在等待</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">5</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">            <span class="keyword">final</span>  <span class="keyword">int</span> threadNum = i;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            executor.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    race(threadNum);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">race</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125; is ready"</span>,threadNum);</span><br><span class="line">        <span class="comment">//当每一个线程准备就绪后，调用await方法告知CyclicBarrier当前线程OK了，当准备就绪的线程数达到了CyclicBarrier声明的5个线程的数量后，后面的线程就可以开始执行了</span></span><br><span class="line">        barrier.await();</span><br><span class="line">        log.info(<span class="string">"&#123;&#125; continue"</span>,threadNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CyclicBarrier支持传入等待时间，代码演示如下："><a href="#CyclicBarrier支持传入等待时间，代码演示如下：" class="headerlink" title="CyclicBarrier支持传入等待时间，代码演示如下："></a>CyclicBarrier支持传入等待时间，代码演示如下：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">race</span><span class="params">(<span class="keyword">int</span> threadNum)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    log.info(<span class="string">"&#123;&#125; is ready"</span>,threadNum);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        barrier.await(<span class="number">2000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.warn(<span class="string">"BrokenBarrierException"</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"&#123;&#125; continue"</span>,threadNum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CyclicBarrier支持线程到达屏障时，优先支持running"><a href="#CyclicBarrier支持线程到达屏障时，优先支持running" class="headerlink" title="CyclicBarrier支持线程到达屏障时，优先支持running"></a>CyclicBarrier支持线程到达屏障时，优先支持running</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//告知当前有多少个线程同时在等待</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">5</span>,()-&gt;&#123;</span><br><span class="line">    log.info(<span class="string">"callback is running "</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">24.350</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">0</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">25.348</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">1</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">26.349</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">2</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">27.350</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">3</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.350</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">4</span> is ready</span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.350</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - callback is running </span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.350</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - <span class="number">4</span> <span class="keyword">continue</span></span><br><span class="line"><span class="number">00</span>:<span class="number">04</span>:<span class="number">28.351</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 -</span><br></pre></td></tr></table></figure>

<p>线程中的屏障是 <strong>4 is ready ，</strong>此时所有入队线程已准备就绪，即到达了屏障，在进入执行序列时，会优先执行 <strong>running</strong> ，即匿名指定的线程对象。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>AQS</tag>
        <tag>Semaphore</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十）线程安全策略-不可变对象</title>
    <url>/2020/04/03/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1/</url>
    <content><![CDATA[<h2 id="不可变对象"><a href="#不可变对象" class="headerlink" title="不可变对象"></a>不可变对象</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">有一种安全的发布对象，即不可变对象。</span><br></pre></td></tr></table></figure>

<h3 id="不可变对象的存在条件"><a href="#不可变对象的存在条件" class="headerlink" title="不可变对象的存在条件"></a>不可变对象的存在条件</h3><blockquote>
<p> ① 对象创建以后其状态就不能修改</p>
<p> ② 对象所有域都是final类型</p>
<p> ③ 对象是正确创建的（在对象创建期间，this引用没有逸出）</p>
</blockquote>
<h3 id="关键字-final"><a href="#关键字-final" class="headerlink" title="关键字 - final"></a>关键字 - final</h3><h4 id="final-的作用"><a href="#final-的作用" class="headerlink" title="final 的作用"></a>final 的作用</h4><blockquote>
<p><strong>final</strong> 关键字可以用来修饰：<strong>类、方法、变量</strong> </p>
</blockquote>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">修饰类：不能被继承，final类中的成员方法都会被隐式的指定为final方法</span><br><span class="line"></span><br><span class="line">修饰方法：1、锁定方法不被继承类修改；2、效率</span><br><span class="line"></span><br><span class="line">	 注意：一个类的private方法会被隐式的指定为final方法</span><br><span class="line"></span><br><span class="line">修饰变量：基本数据类型变量、引用类型变量</span><br></pre></td></tr></table></figure>

<p><strong>被final修饰的数值不能再被修改；被final修饰的引用类型不能再指向另一个对象。</strong></p>
<p>重点：fianl修饰数据类型变量和引用类型变量的区别</p>
<h4 id="fianl的使用代码演示："><a href="#fianl的使用代码演示：" class="headerlink" title="fianl的使用代码演示："></a>fianl的使用代码演示：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">immutableExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String b = <span class="string">"2"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = Maps.newHashMap();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">        map.put(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">        map.put(<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        a = 2;</span></span><br><span class="line"><span class="comment">//        b = "3";</span></span><br><span class="line"><span class="comment">//        map = Maps.newHashMap();</span></span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,map.get(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> a )</span></span>&#123;</span><br><span class="line"><span class="comment">//        a = 1;</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">13</span>:<span class="number">54.256</span> [main] INFO com.mmall.concurrency.example.immutable.immutableExample1 - <span class="number">3</span></span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu265.png" width="80%">

<p><strong>分析：</strong>由图中可知，被final修饰的变量无法被重新赋值，被final修饰的map引用类型变量也不能指向新的内存引用。 </p>
<p>又由代码执行结果可知，被final修饰的引用数据类型如map的值是可以改变的。 </p>
<h3 id="常见不可变对象"><a href="#常见不可变对象" class="headerlink" title="常见不可变对象"></a>常见不可变对象</h3><pre><code>&gt;      **Collections.unmodifiableXXX : Collection 、List、Set、Map ..,**
&gt;
&gt;       **Guava : ImmutableXXX : Collection 、List、Set、Map....**</code></pre><p><strong>注意：</strong> </p>
<blockquote>
<p>使用Collections的unmodifiableXXX生成的引用变量就不能再被修改了；</p>
<p>使用Guava的ImmutableXXX生成的引用变量就不能再被修改了；</p>
</blockquote>
<h4 id="Collections-unmodifiableXXX"><a href="#Collections-unmodifiableXXX" class="headerlink" title="Collections.unmodifiableXXX :"></a><strong>Collections.unmodifiableXXX :</strong></h4><h5 id="代码演示："><a href="#代码演示：" class="headerlink" title="代码演示："></a><strong>代码演示：</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">immutableExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = Maps.newHashMap();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">        map.put(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">        map.put(<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line">        map = Collections.unmodifiableMap(map);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        map.put(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,map.get(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsupportedOperationException</span><br><span class="line">	at java.util.Collections$UnmodifiableMap.put(Collections.java:<span class="number">1457</span>)</span><br><span class="line">	at com.mmall.concurrency.example.immutable.immutableExample2.main(immutableExample2.java:<span class="number">31</span>)</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>由执行结果可知，被Collections.unmodifiableMap()修改过的map不能再被重新赋值，虽然声明时没有报错，但是编译运行时却抛出了异常。 </p>
<h5 id="从源码对原因进行分析："><a href="#从源码对原因进行分析：" class="headerlink" title="从源码对原因进行分析："></a>从源码对原因进行分析：</h5><p><strong>unmodifiableMap</strong>调用了<strong>UnmodifiableMap</strong>方法； </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; <span class="function">Map&lt;K,V&gt; <span class="title">unmodifiableMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UnmodifiableMap&lt;&gt;(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<strong>UnmodifiableMap</strong>方法中，进行了序列化已经使用final对传入参数m进行修饰： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1034234728574286014L</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;? extends K, ? extends V&gt; m;</span><br></pre></td></tr></table></figure>

<p>相当于將原本的map使用另一个map进行替代，并将所有的更新方法在操作时进行异常的抛出，相关源码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceAll</span><span class="params">(BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; function)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line">.............</span><br></pre></td></tr></table></figure>

<p>当第一次声明值时，会对引用变量的长度和数据进行副本备份，如果有第二次修改时，会进行校验，发现传入参数和底层取出的值不同时，抛出异常。 </p>
<h4 id="ImmutableXXX代码演示："><a href="#ImmutableXXX代码演示：" class="headerlink" title="ImmutableXXX代码演示："></a>ImmutableXXX代码演示：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">immutableExample3</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableList list = ImmutableList.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableSet set = ImmutableSet.copyOf(list);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableMap&lt;Integer,Integer&gt; map = ImmutableMap.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableMap&lt;Integer,Integer&gt; map2 = ImmutableMap.&lt;Integer,Integer&gt;builder().put(<span class="number">1</span>,<span class="number">2</span>).put(<span class="number">3</span>,<span class="number">4</span>).put(<span class="number">5</span>,<span class="number">6</span>).build();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        list.add(4);</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//        map.put(1,4);</span></span><br><span class="line">        System.out.println(map.get(<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ImmutableList</strong> 重新赋值测试结果： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsupportedOperationException</span><br><span class="line">	at com.google.common.collect.ImmutableCollection.add(ImmutableCollection.java:<span class="number">221</span>)</span><br><span class="line">	at com.mmall.concurrency.example.immutable.immutableExample3.main(immutableExample3.java:<span class="number">33</span>)</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>ImmutableMap</strong>重新赋值测试结果： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsupportedOperationException</span><br><span class="line">	at com.google.common.collect.ImmutableMap.put(ImmutableMap.java:<span class="number">495</span>)</span><br><span class="line">	at com.mmall.concurrency.example.immutable.immutableExample3.main(immutableExample3.java:<span class="number">35</span>)</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>查询<strong>ImmutableMap</strong>的value值： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，<strong>ImmutableXXX</strong>声明的对象为不可变对象，是线程安全的，同时不影响值的获取。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>synchronized</tag>
        <tag>不可变对象</tag>
      </tags>
  </entry>
  <entry>
    <title>最新idea2020注册码永久激活(激活到2100年)</title>
    <url>/2020/03/10/%E6%9C%80%E6%96%B0idea2020%E6%B3%A8%E5%86%8C%E7%A0%81%E6%B0%B8%E4%B9%85%E6%BF%80%E6%B4%BB-%E6%BF%80%E6%B4%BB%E5%88%B02100%E5%B9%B4/</url>
    <content><![CDATA[<p>这篇文章主要介绍了idea2020注册码永久激活（激活到2100年）,文中给大家提到了2020年最新JetBrains授权服务器-IntelliJ IDEA激活，需要的朋友可以参考下 </p>
<p><strong>2020年最新JetBrains授权服务器-IntelliJ IDEA激活</strong></p>
<p>2020年最近可激活JetBrains授权服务器地址</p>
<p>1：<a href="https://idea.ouyanglol.com/" target="_blank" rel="noopener">https://idea.ouyanglol.com/</a></p>
<p>2：<a href="http://101.132.235.155:1017/" target="_blank" rel="noopener">http://101.132.235.155:1017/</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>激活码</category>
      </categories>
      <tags>
        <tag>IDEA</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化开发（一）BC架构讲解</title>
    <url>/2020/03/24/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89BC%E6%9E%B6%E6%9E%84%E8%AE%B2%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="BC项目架构图"><a href="#BC项目架构图" class="headerlink" title="BC项目架构图"></a>BC项目架构图</h2><img src="http://photo.wushaopei.com/qiniu215.png" width="100%">

<h2 id="整个BC项目的架构层次分别为："><a href="#整个BC项目的架构层次分别为：" class="headerlink" title="整个BC项目的架构层次分别为："></a>整个BC项目的架构层次分别为：</h2><ul>
<li>前端      (BC Client(WEB)  、 BC Monitor(WEB))</li>
<li>服务        ( OSGI Bundles服务)</li>
<li>Workflow   (WorkflowRuntime，整体包括 Workflow API and Interchange Formats)</li>
<li>接口层     (BC Server ，从Redis DB中加载产线Run货数据与 Host/EQP端交互、分发)</li>
<li>数据源  (分为Redis DB 、Postgresql DB)</li>
<li>硬件      (下游设备： 包含但不限于 HSMS 、EIP、Cclink板卡、设备PLC)</li>
</ul>
<h2 id="数据发布流程："><a href="#数据发布流程：" class="headerlink" title="数据发布流程："></a>数据发布流程：</h2><h3 id="数据的入口："><a href="#数据的入口：" class="headerlink" title="数据的入口："></a>数据的入口：</h3><p>数据从<strong>WEB</strong>层进入后，首先进入到的是<strong>Workflow</strong> </p>
<h4 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h4><ol>
<li>怎么和workflow串起来？</li>
<li>怎么定位到workflow的？</li>
</ol>
<h4 id="Workflow-的主要功能："><a href="#Workflow-的主要功能：" class="headerlink" title="Workflow 的主要功能："></a>Workflow 的主要功能：</h4><pre><code>`将各个逻辑给串起来`,Workflow 将各个服务的接口给串连起来。</code></pre><h3 id="数据的处理："><a href="#数据的处理：" class="headerlink" title="数据的处理："></a>数据的处理：</h3><p>数据从上层发布到下层，都是通过接口实现的。然后再经由接口的实现类方法将数据写入到底层的DB(Redis或Postgre)中去。</p>
<h3 id="前后端关系："><a href="#前后端关系：" class="headerlink" title="前后端关系："></a>前后端关系：</h3><p>前后端是分离开的，后端在没有使用前端的情况下是可以独立运行的。</p>
<h2 id="交互结构："><a href="#交互结构：" class="headerlink" title="交互结构："></a>交互结构：</h2><img src="http://photo.wushaopei.com/qiniu216.png" width="100%">

<p><strong>上游</strong>： MES Simulator</p>
<p><strong>中间层</strong>： BC </p>
<p><strong>下游</strong>： PLC Simulator  </p>
<p>​             HSMS Simulator</p>
<p><strong>模拟器：</strong>  测试环境与开发环境中，MES 和PLC 都使用模拟器（Simulator）。</p>
<p><strong>模拟规则：</strong> </p>
<p>PLC 将数据写入到Redis数据库中，BC到Redis数据库中去取数据，从而实现对PLC硬件的模拟。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>自动化开发（三）Specification-02.Communication Structure</title>
    <url>/2020/03/31/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%89%EF%BC%89Specification-02-Communication-Structure/</url>
    <content><![CDATA[<h2 id="Communication-Structure-通讯结构"><a href="#Communication-Structure-通讯结构" class="headerlink" title="Communication Structure - 通讯结构"></a>Communication Structure - 通讯结构</h2><h3 id="T6BC架构概述"><a href="#T6BC架构概述" class="headerlink" title="T6BC架构概述"></a>T6BC架构概述</h3><h3 id="Data-Communication"><a href="#Data-Communication" class="headerlink" title="Data Communication"></a>Data Communication</h3><p>设备通过CC-Link IE的链路信号与上下游设备进行连接</p>
<p>链接区域。链路信号仅用于控制作业转移。工作数据通过CCLink IE传输。设备通过三菱公司的CC-Link IE网络与BC公司连接，发送/接收CIM数据</p>
<p><code>BC与设备通信的基础是三菱PLC。</code></p>
<img src="http://photo.wushaopei.com/qiniu259.png" width="80%">

<p>​                            图02内联通信结构 </p>
<p>​    如图所示，<strong>最上层</strong> 是MES，在该架构中所有的数据都需要回复到MES那边的。MES 与 BC 之间是通过Tib/RV 去实现数据传输的。</p>
<p>​    <strong>中间层</strong>的BC，也就L1是使用板卡。 </p>
<p>​    <strong>在下层</strong> 的PLC网络中，存在着一个主站，BC（L1）默认是作为PLC网络中的L1存在的。</p>
<p>​    每一个具体的设备（机台）可以看作是一个PLC，PLC是从L2开始进行连接和起始计算的，在一个PLC网络中，抛去作为主站的BC（L1）之后，可能存在数量不等的多台PLC机台，具体有几个PLC机台要根据每条线自身的具体情况而定。</p>
<p>​    <strong>最底层</strong> 是机台的示意图，其顺序根据PLC的L{num}从左往右递增而呈现从左往右看的规则。</p>
<p>​    对应PLC（L2）的机台是loader(装载板卡) ，而对应最右边的PLC(Ln)则是unLoader。</p>
<h4 id="Loader与unLoader"><a href="#Loader与unLoader" class="headerlink" title="Loader与unLoader"></a>Loader与unLoader</h4><p>Loader与unLoader一般通过连接Stock或者其他搬运的设备（robot等）来将Cassette或者Glass搬上或搬下机台。</p>
<h4 id="机台间的通讯"><a href="#机台间的通讯" class="headerlink" title="机台间的通讯"></a>机台间的通讯</h4><p>每一台机台之间通过光纤进行连接和数据交互，数据使用cclink IE导入到BC。</p>
<h3 id="Inline-CC-Link-IE-Concept"><a href="#Inline-CC-Link-IE-Concept" class="headerlink" title="Inline CC-Link IE Concept"></a>Inline CC-Link IE Concept</h3><h4 id="主机台与子机台"><a href="#主机台与子机台" class="headerlink" title="主机台与子机台"></a>主机台与子机台</h4><img src="http://photo.wushaopei.com/qiniu260.png" width="80%">

<p>每个机台都会划分出一个或一个以上的unit，每个unit可以理解为是子机台。每个子机台与PLC网络不会产生直接关系，每个子机台只对自己的主机台负责，这从另一个层面上可以理解为每个主机台与子机台之间构成了以主机台为主导的子机台网络。</p>
<p>每个unit子机台都会把所处理的数据提交给主机台，并由主机台直接或经过处理后再与PLC网络、BC进行交互。</p>
<p>  <code>EQP需要监控CCLINK IE光纤网络连接状态。如果EQP检测到任何错误发生，EQP需要火灾报警</code></p>
]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>并发编程（四）并发案例-环境搭建</title>
    <url>/2020/03/24/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%9B%9B%EF%BC%89%E5%B9%B6%E5%8F%91%E6%A1%88%E4%BE%8B-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h2 id="案例环境初始化"><a href="#案例环境初始化" class="headerlink" title="案例环境初始化"></a>案例环境初始化</h2><h3 id="环境搭建与准备"><a href="#环境搭建与准备" class="headerlink" title="环境搭建与准备"></a>环境搭建与准备</h3><p>Spring Boot 项目，<a href="https://start.spring.io/" target="_blank" rel="noopener">https://start.spring.io/</a></p>
<p>Git 管理代码，<a href="https://github.com/wushaopei/concurrency" target="_blank" rel="noopener">https://github.com/wushaopei/concurrency</a></p>
<p>码云：<a href="https://gitee.com/wushaopei/concurrency" target="_blank" rel="noopener">https://gitee.com/wushaopei/concurrency</a></p>
<img src="http://photo.wushaopei.com/qiniu187.png" width="70%">

<p><strong>点击Generate -Ctrl + 将项目下载到本地，并解压。</strong></p>
<p>使用git bash 将码云仓库下载到本地：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://gitee.com/wushaopei/concurrency.git</span><br></pre></td></tr></table></figure>

<p>将concurrency.zip压缩包解压后的src、mvnw.cmd、mvnw、pom.xml文件复制到git仓库目录concurrency下， </p>
<img src="http://photo.wushaopei.com/qiniu188.png" width="70%">

<p>配置依赖驱动，加载项目 </p>
<img src="http://photo.wushaopei.com/qiniu189.png" width="70%">



<h2 id="案例准备工作"><a href="#案例准备工作" class="headerlink" title="案例准备工作"></a>案例准备工作</h2><h3 id="自定义注解ThreadSafe-java类，用于标识线程安全的类："><a href="#自定义注解ThreadSafe-java类，用于标识线程安全的类：" class="headerlink" title="自定义注解ThreadSafe.java类，用于标识线程安全的类："></a>自定义注解ThreadSafe.java类，用于标识线程安全的类：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ThreadSafe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 14:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 用来标记线程安全的类或写法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ThreadSafe &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义注解NoThreadSafe-java类，用于标识线程不安全的类："><a href="#自定义注解NoThreadSafe-java类，用于标识线程不安全的类：" class="headerlink" title="自定义注解NoThreadSafe.java类，用于标识线程不安全的类："></a>自定义注解NoThreadSafe.java类，用于标识线程不安全的类：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> NoThreadSafe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 14:44</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 用来标记线程不安全的类或写法</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NoThreadSafe &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用来标记-不推荐-的类或者写法"><a href="#用来标记-不推荐-的类或者写法" class="headerlink" title="用来标记 不推荐 的类或者写法"></a>用来标记 不推荐 的类或者写法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用来标记 不推荐 的类或者写法</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NoRecommend &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Recommend-java-用来标记-推荐-的类或者写法"><a href="#Recommend-java-用来标记-推荐-的类或者写法" class="headerlink" title="Recommend.java 用来标记 推荐 的类或者写法"></a>Recommend.java 用来标记 推荐 的类或者写法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用来标记 推荐 的类或者写法</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Recommend &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span>  ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发案例</tag>
      </tags>
  </entry>
  <entry>
    <title>重写一个对象的时候为什么要同时重写hashcode()和equals（）方法</title>
    <url>/2020/03/13/%E9%87%8D%E5%86%99%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%90%8C%E6%97%B6%E9%87%8D%E5%86%99hashcode-%E5%92%8Cequals%EF%BC%88%EF%BC%89%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>​    在新创建的类不重写<strong>hashCode()</strong>和<strong>equals()</strong> 方法时，默认使用 <strong>java</strong> 提供的 <strong>java.lang.Object</strong> 下的 <strong>hashCode</strong>()和<strong>equals</strong>() 方法。 </p>
<blockquote>
<p>注意：Object 的public boolean equals(Object obj)方法主要是对非空对象的引用地址的判断相同才返回true，而非对象本身的字符串内容或数值是否相同。 </p>
</blockquote>
<p>​    简而言之，当且仅当 值A 和 值B 都是引用自同一个对象时，此方法才会返回true;</p>
<p>​    所以，当我们重写一个对象，重写了equals（）方法后，通常必须重写 hashCode（）方法，以维护 hashCode 方法的常规协定，该协定声明了相等对象必须具有相等的哈希码。</p>
<blockquote>
<p>说白了，就是equals 返回true的两个值，在hashCode（） 中结果也必然是true。 </p>
</blockquote>
<p>例子：**</p>
<p>​    (1)当<strong>obj1.equals(obj2)</strong>为<strong>true</strong>时，<strong>obj1.hashCode() == obj2.hashCode()</strong>必须为<strong>true</strong><br>    (2)当<strong>obj1.hashCode() == obj2.hashCode()</strong>为<strong>false</strong>时，<strong>obj1.equals(obj2)</strong>必须为<strong>false</strong></p>
<p>这里引出一个问题，<strong>为什么要重写equals（）方法</strong>呢？难道原生的不能用吗？</p>
<p>​    答案: 是<strong>必须重写</strong>，从前面的注意事项中可以知道，如果不重写<strong>equals</strong> 方法，那么比较的将是对象的引用是否<strong>指向同一块内存地址</strong>，而我们<strong>重写的目的</strong>是为了能够比较<strong>两个对象的value值</strong>是否相等。</p>
<p>​    在高级类的<strong>八个包装类</strong>与<strong>引用类型的String类型</strong>（该类对euqals和hashcode方法进行了重写）中都 是使用重写后的 <strong>equals</strong> 方法来比较对象的，<strong>默认比较的是值</strong>，在比较其它自定义对象时都是<strong>比较的引用地址。</strong></p>
<p>​    后面会对<strong>equals</strong> 和 <strong>hashcode</strong> 的关系进行关联解释。</p>
<p>​    <strong>hashcode</strong>是用于<strong>散列数据的快速存取</strong>，如利用<code>HashSet/HashMap/Hashtable</code>类来存储数据时，都是根据存储对象的<code>hashcode</code>值来进行判断是否相同的。</p>
<p>​    那么，如果我们值重  写<code>equals</code> ，而不重写 <code>hashcode</code> 会怎么样？</p>
<p>​    如果我们对一个对象重写了   <code>equals</code> 方法，意味着只要对象的成员变量值都相等那么 <code>equals</code> 就返回true ,但在不重写 <code>hashcode</code> 方法的情况下，当我们重新 <strong>new</strong> 了一个新对象。<br>此时，当原对象<strong>.equals</strong>（新对象）等于<strong>true</strong>时，两者的 <strong>hashcode</strong> 却是不一样的，由此会产生了理解的不一致，也违反了<strong>equals</strong> 与 <strong>hashcode</strong>的约定规则。</p>
<p><strong>不重写导致的结果案例：</strong></p>
<p>​    在不重写<strong>hashcode</strong>的情况下，如果 <code>hashset</code>存储两个引用不同但值相同的对象，此时hashcode返回false，认为后者与前者不重复，则会重新 newNode() 创建一个新节点将重复的值添加到集合中，意味着不可重复的单列集合中出现了两个值一样的对象，导致混淆。（假设没有重写）</p>
<p>所以，需要重写 hashcode()方法。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JavaSE</category>
      </categories>
  </entry>
  <entry>
    <title>面试题： hashset如何保证值不会被重复的</title>
    <url>/2020/02/29/%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%9Ahashset%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%80%BC%E4%B8%8D%E4%BC%9A%E8%A2%AB%E9%87%8D%E5%A4%8D%E7%9A%84/</url>
    <content><![CDATA[<p>众所周知，HashSet 的值是不可能被重复的，在业务上经常被用来做数据去重的操作，那么，其内部究竟是怎么保证元素不重复的呢？</p>
<p>这里将对<strong>HashSet</strong> 的源码进行逐步的解析：</p>
<p>当我们对一个<strong>HashSet</strong> 的实例添加一个值时，使用到的是它的 <strong>add</strong> 方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">218</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line"><span class="number">219</span>        <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</span><br><span class="line"><span class="number">220</span>    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>由以上的<strong>add</strong> 方法内的实现可知，其维护了一个 <strong>HashMap</strong> 来实现元素的添加；众所周知，<strong>HashMap</strong> 作为双列集合，它的键是不能够重复的，这里的 <strong>PRESENT</strong> 是作为占位符的存在，与值重复判断与否没有意义，不作赘述。</p>
<p>其实，到了这里，我们已经可以知道 <strong>HashSet</strong> 的值作为 <strong>HashMap</strong> 中的 <strong>key</strong>（键）的，可以确定是不会存在重复值存在的情况发生。</p>
<p>但是，我们要了解的是为什么不会重复，继续深究，这里继续了解对该值的一个不可重复的原因.</p>
<p>以下是<strong>HashSet</strong> 引用<strong>HashMap</strong>的具体位置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashSet</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Set</span>&lt;<span class="title">E</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5024744406713321676L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E,Object&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dummy value to associate with an Object in the backing Map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object PRESENT = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new, empty set; the backing &lt;tt&gt;HashMap&lt;/tt&gt; instance has</span></span><br><span class="line"><span class="comment">     * default initial capacity (16) and load factor (0.75).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new set containing the elements in the specified</span></span><br><span class="line"><span class="comment">     * collection.  The &lt;tt&gt;HashMap&lt;/tt&gt; is created with default load factor</span></span><br><span class="line"><span class="comment">     * (0.75) and an initial capacity sufficient to contain the elements in</span></span><br><span class="line"><span class="comment">     * the specified collection.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> c the collection whose elements are to be placed into this set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified collection is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;&gt;(Math.max((<span class="keyword">int</span>) (c.size()/.<span class="number">75f</span>) + <span class="number">1</span>, <span class="number">16</span>));</span><br><span class="line">        addAll(c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>HashSet</strong> 其实是在构造器内实例化了一个 <strong>HashMap</strong> 对象，那么可以得知，<strong>HashSet</strong> 的值不可重复是依赖于 <strong>HashMap</strong> 的底层对值不可重复的依赖。</p>
<p>其实</p>
<p>以下我们进入到 <strong>HashMap</strong> 的 <strong>put()</strong>方法中去：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Associates the specified value with the specified key in this map.</span></span><br><span class="line"><span class="comment"> * If the map previously contained a mapping for the key, the old</span></span><br><span class="line"><span class="comment"> * value is replaced.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value value to be associated with the specified key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span></span><br><span class="line"><span class="comment"> *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment"> *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span></span><br><span class="line"><span class="comment"> *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>由 <strong>put</strong>  方法的实现可知，该 <strong>put</strong> 方法对传入的 <strong>Map</strong> 的<strong>key - value</strong> 进行了更深一层的 <strong>putVal</strong>（）的处理。</p>
<p>但这个方法不是我们现在需要了解的，稍后再对这里进行了解。</p>
<p>进入 putVal() 方法之前，对传入的 key 进行了hash 运算，获取了一个 hash 值：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取hash 值的规则是 ：当 key == null 时，hash 值为0；若不为null，则说明值有效，会通过 hashCode()</p>
<p><strong>关于 hashCode() 在这里的作用：</strong></p>
<p>hashCode在上面扮演的角色为寻域（寻找某个对象在集合中区域位置）。hashCode可以将集合分成若干个区域，每个对象都可以计算出他们的hash码，可以将hash码分组，每个分组对应着某个存储区域，根据一个对象的hash码就可以确定该对象所存储区域，这样就大大减少查询匹配元素的数量，提高了查询效率。</p>
<p>关于Key 不能够重复，这里可以得出了，相同的值得到的 hash 码大概率上是相同的，所以，key 可以保证不会重复，因为重复的值，一定会被覆盖。具体从后面的源码继续看：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Implements Map.put and related methods</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> hash hash for key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value the value to put</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> onlyIfAbsent if true, don't change existing value</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> evict if false, the table is in creation mode.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> previous value, or null if none</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">      Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">      <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">          n = (tab = resize()).length;</span><br><span class="line">      <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">          tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          Node&lt;K,V&gt; e; K k;</span><br><span class="line">          <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">              ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">              e = p;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">              e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                  <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                      <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                          treeifyBin(tab, hash);</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                      ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  p = e;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">              V oldValue = e.value;</span><br><span class="line">              <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                  e.value = value;</span><br><span class="line">              afterNodeAccess(e);</span><br><span class="line">              <span class="keyword">return</span> oldValue;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++modCount;</span><br><span class="line">      <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">          resize();</span><br><span class="line">      afterNodeInsertion(evict);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>注意 以上方法 中的这一句：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (e.hash == hash &amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                     <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>由此可知，HashMap 的 集合元素 key-value 添加时，这里调用了对象的hashCode和equals方法进行的判断。</p>
<p>但要注意，原生的 hashCode 和 equals 更多的是在引用的位置上进行了去重校验，如要对具体的值或对象本身进行去重，还需进行重写操作。</p>
<p>所以又得出一个结论：<strong>若要将对象存放到HashSet中并保证对象不重复，应根据实际情况将对象的hashCode方法和equals方法进行重写</strong></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>容器-集合</category>
      </categories>
      <tags>
        <tag>集合</tag>
      </tags>
  </entry>
  <entry>
    <title>01.基础架构：一条SQL查询语句是如何执行的？</title>
    <url>/2020/04/15/01-%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%EF%BC%9A%E4%B8%80%E6%9D%A1SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84%EF%BC%9F/</url>
    <content><![CDATA[<!DOCTYPE html>
<html>

  <body>

<p>​      <div id=app><br>                     <div data-v-87ffcada="" class="article"><br>                      <div data-v-87ffcada="" class="main main-app"><br>                       <div data-v-87ffcada="" class="breadcrumb breadcrumb pd"><br>                       </div><br>                       <h1 data-v-87ffcada="" class="article-title pd"> 01 | 基础架构：一条SQL查询语句是如何执行的？ </h1><br>                       <div data-v-87ffcada="" class="article-info pd"><br>                        <span data-v-87ffcada="">2018-11-14</span><br>                        <span data-v-87ffcada="">林晓斌</span><br>                       </div><br>                       <div data-v-87ffcada="" class="article-content typo common-content pd"><br>                        <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/38/8b/38dd4b12f16d2f9667fb169be0f0698b.jpg" /><br>                        <div data-v-87ffcada="" id="article-content" class=""><br>                         <div class="text"><br>                             <p>你好，我是林晓斌。</p><p>这是专栏的第一篇文章，我想来跟你聊聊MySQL的基础架构。我们经常说，看一个事儿千万不要直接陷入细节里，你应该先鸟瞰其全貌，这样能够帮助你从高维度理解问题。同样，对于MySQL的学习也是这样。平时我们使用数据库，看到的通常都是一个整体。比如，你有个最简单的表，表里只有一个ID字段，在执行下面这个查询语句时：</p><pre><code>mysql&gt; select * from T where ID=10；<br></code></pre><p>我们看到的只是输入一条语句，返回一个结果，却不知道这条语句在MySQL内部的执行过程。</p><p>所以今天我想和你一起把MySQL拆解一下，看看里面都有哪些“零件”，希望借由这个拆解过程，让你对MySQL有更深入的理解。这样当我们碰到MySQL的一些异常或者问题时，就能够直戳本质，更为快速地定位并解决问题。</p><p>下面我给出的是MySQL的基本架构示意图，从中你可以清楚地看到SQL语句在MySQL的各个功能模块中的执行过程。</p><p><img src="https://static001.geekbang.org/resource/image/0d/d9/0d2070e8f84c4801adbfa03bda1f98d9.png" alt=""></p><center><span class="reference">MySQL的逻辑架构图</span></center><p>大体来说，MySQL可以分为Server层和存储引擎层两部分。</p><p>Server层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。</p><!-- [[[read_end]]] --><p>而存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎。现在最常用的存储引擎是InnoDB，它从MySQL 5.5.5版本开始成为了默认存储引擎。</p><p>也就是说，你执行create table建表的时候，如果不指定引擎类型，默认使用的就是InnoDB。不过，你也可以通过指定存储引擎的类型来选择别的引擎，比如在create table语句中使用engine=memory, 来指定使用内存引擎创建表。不同存储引擎的表数据存取方式不同，支持的功能也不同，在后面的文章中，我们会讨论到引擎的选择。</p><p>从图中不难看出，不同的存储引擎共用一个<strong>Server层</strong>，也就是从连接器到执行器的部分。你可以先对每个组件的名字有个印象，接下来我会结合开头提到的那条SQL语句，带你走一遍整个执行流程，依次看下每个组件的作用。</p><h1>连接器</h1><p>第一步，你会先连接到这个数据库上，这时候接待你的就是连接器。连接器负责跟客户端建立连接、获取权限、维持和管理连接。连接命令一般是这么写的：</p><pre><code>mysql -h$ip -P$port -u$user -p<br></code></pre><p>输完命令之后，你就需要在交互对话里面输入密码。虽然密码也可以直接跟在-p后面写在命令行中，但这样可能会导致你的密码泄露。如果你连的是生产服务器，强烈建议你不要这么做。</p><p>连接命令中的mysql是客户端工具，用来跟服务端建立连接。在完成经典的TCP握手后，连接器就要开始认证你的身份，这个时候用的就是你输入的用户名和密码。</p><ul></p>
<li>如果用户名或密码不对，你就会收到一个"Access denied for user"的错误，然后客户端程序结束执行。</li>
<li>如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。</li>
</ul><p>这就意味着，一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。</p><p>连接完成后，如果你没有后续的动作，这个连接就处于空闲状态，你可以在show processlist命令中看到它。文本中这个图是show processlist的结果，其中的Command列显示为“Sleep”的这一行，就表示现在系统里面有一个空闲连接。</p><p><img src="https://static001.geekbang.org/resource/image/f2/ed/f2da4aa3a672d48ec05df97b9f992fed.png" alt=""><br>
客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数wait_timeout控制的，默认值是8小时。</p><p>如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： Lost connection to MySQL server during query。这时候如果你要继续，就需要重连，然后再执行请求了。</p><p>数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。</p><p>建立连接的过程通常是比较复杂的，所以我建议你在使用中要尽量减少建立连接的动作，也就是尽量使用长连接。</p><p>但是全部使用长连接后，你可能会发现，有些时候MySQL占用内存涨得特别快，这是因为MySQL在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是MySQL异常重启了。</p><p>怎么解决这个问题呢？你可以考虑以下两种方案。</p><ol>
<li>
<p>定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。</p>
</li>
<li>
<p>如果你用的是MySQL 5.7或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。</p>
</li>
</ol><h1>查询缓存</h1><p>连接建立完成后，你就可以执行select语句了。执行逻辑就会来到第二步：查询缓存。</p><p>MySQL拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以key-value对的形式，被直接缓存在内存中。key是查询的语句，value是查询的结果。如果你的查询能够直接在这个缓存中找到key，那么这个value就会被直接返回给客户端。</p><p>如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。你可以看到，如果查询命中缓存，MySQL不需要执行后面的复杂操作，就可以直接返回结果，这个效率会很高。</p><p><strong>但是大多数情况下我会建议你不要使用查询缓存，为什么呢？因为查询缓存往往弊大于利。</strong></p><p>查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。因此很可能你费劲地把结果存起来，还没使用呢，就被一个更新全清空了。对于更新压力大的数据库来说，查询缓存的命中率会非常低。除非你的业务就是有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。</p><p>好在MySQL也提供了这种“按需使用”的方式。你可以将参数query_cache_type设置成DEMAND，这样对于默认的SQL语句都不使用查询缓存。而对于你确定要使用查询缓存的语句，可以用SQL_CACHE显式指定，像下面这个语句一样：</p><pre><code>mysql&gt; select SQL_CACHE * from T where ID=10；
</code></pre><p>需要注意的是，MySQL 8.0版本直接将查询缓存的整块功能删掉了，也就是说8.0开始彻底没有这个功能了。</p><h1>分析器</h1><p>如果没有命中查询缓存，就要开始真正执行语句了。首先，MySQL需要知道你要做什么，因此需要对SQL语句做解析。</p><p>分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条SQL语句，MySQL需要识别出里面的字符串分别是什么，代表什么。</p><p>MySQL从你输入的"select"这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名T”，把字符串“ID”识别成“列ID”。</p><p>做完了这些识别以后，就要做“语法分析”。根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个SQL语句是否满足MySQL语法。</p><p>如果你的语句不对，就会收到“You have an error in your SQL syntax”的错误提醒，比如下面这个语句select少打了开头的字母“s”。</p><pre><code>mysql&gt; elect * from t where ID=1;

<p>ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ‘elect * from t where ID=1’ at line 1<br></code></pre><p>一般语法错误会提示第一个出现错误的位置，所以你要关注的是紧接“use near”的内容。</p><h1>优化器</h1><p>经过了分析器，MySQL就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。</p><p>优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。比如你执行下面这样的语句，这个语句是执行两个表的join：</p><pre><code>mysql&gt; select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;<br></code></pre><ul></p>
<li>既可以先从表t1里面取出c=10的记录的ID值，再根据ID值关联到表t2，再判断t2里面d的值是否等于20。</li>
<li>也可以先从表t2里面取出d=20的记录的ID值，再根据ID值关联到t1，再判断t1里面c的值是否等于10。</li>
</ul><p>这两种执行方法的逻辑结果是一样的，但是执行的效率会有不同，而优化器的作用就是决定选择使用哪一个方案。</p><p>优化器阶段完成后，这个语句的执行方案就确定下来了，然后进入执行器阶段。如果你还有一些疑问，比如优化器是怎么选择索引的，有没有可能选择错等等，没关系，我会在后面的文章中单独展开说明优化器的内容。</p><h1>执行器</h1><p>MySQL通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。</p><p>开始执行的时候，要先判断一下你对这个表T有没有执行查询的权限，如果没有，就会返回没有权限的错误，如下所示。</p><pre><code>mysql&gt; select * from T where ID=10;

<p>ERROR 1142 (42000): SELECT command denied to user ‘b’@’localhost’ for table ‘T’<br></code></pre><p>如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口。</p><p>比如我们这个例子中的表T中，ID字段没有索引，那么执行器的执行流程是这样的：</p><ol></p>
<li>
<p>调用InnoDB引擎接口取这个表的第一行，判断ID值是不是10，如果不是则跳过，如果是则将这行存在结果集中；</p>
</li>
<li>
<p>调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</p>
</li>
<li>
<p>执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</p>
</li>
</ol><p>至此，这个语句就执行完成了。</p><p>对于有索引的表，执行的逻辑也差不多。第一次调用的是“取满足条件的第一行”这个接口，之后循环取“满足条件的下一行”这个接口，这些接口都是引擎中已经定义好的。</p><p>你会在数据库的慢查询日志中看到一个rows_examined的字段，表示这个语句执行过程中扫描了多少行。这个值就是在执行器每次调用引擎获取数据行的时候累加的。</p><p>在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此<strong>引擎扫描行数跟rows_examined并不是完全相同的。</strong>我们后面会专门有一篇文章来讲存储引擎的内部机制，里面会有详细的说明。</p><h1>小结</h1><p>今天我给你介绍了MySQL的逻辑架构，希望你对一个SQL语句完整执行流程的各个阶段有了一个初步的印象。由于篇幅的限制，我只是用一个查询的例子将各个环节过了一遍。如果你还对每个环节的展开细节存有疑问，也不用担心，后续在实战章节中我还会再提到它们。</p><p>我给你留一个问题吧，如果表T中没有字段k，而你执行了这个语句 select * from T where k=1, 那肯定是会报“不存在这个列”的错误： “Unknown column ‘k’ in ‘where clause’”。你觉得这个错误是在我们上面提到的哪个阶段报出来的呢？</p><p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。</p>
                         </div>
                        </div> 
                       </div> 
                       <!----> 
                       <!---->
                      </div>
                     </div>
      </div>
   </body>
   </html>



<p>本文为转载自 “ 极客时间 ”，发布在此是为了方便自己随时阅读，如有涉及版权问题，请留言提示删除。</p>
]]></content>
      <categories>
        <category>极客时间</category>
        <category>MySQL实战45讲</category>
      </categories>
      <tags>
        <tag>SQL查询</tag>
      </tags>
  </entry>
  <entry>
    <title>02 | 日志系统：一条SQL更新语句是如何执行的？ </title>
    <url>/2020/04/23/02-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%EF%BC%9A%E4%B8%80%E6%9D%A1SQL%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84%EF%BC%9F/</url>
    <content><![CDATA[<!DOCTYPE html>
<html>



  <body>
      <div id=app>
                     <div data-v-87ffcada="" class="article"> 
                      <div data-v-87ffcada="" class="main main-app"> 
                       <div data-v-87ffcada="" class="breadcrumb breadcrumb pd"> 
                       </div> 
                       <h1 data-v-87ffcada="" class="article-title pd"> 02  | 日志系统：一条SQL更新语句是如何执行的？ </h1> 
                       <div data-v-87ffcada="" class="article-info pd"> 
                        <span data-v-87ffcada="">2018-11-16</span> 
                        <span data-v-87ffcada="">林晓斌</span>
                       </div> 
                       <div data-v-87ffcada="" class="article-content typo common-content pd"> 
                        <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/f6/f5/f613f6d2d8a72032c16b211f933c1cf5.jpg" /> 
                        <div data-v-87ffcada="" id="article-content" class="">
                         <div class="text"> 
                             <p>前面我们系统了解了一个查询语句的执行流程，并介绍了执行过程中涉及的处理模块。相信你还记得，一条查询语句的执行过程一般是经过连接器、分析器、优化器、执行器等功能模块，最后到达存储引擎。</p><p>那么，一条更新语句的执行流程又是怎样的呢？</p><p>之前你可能经常听DBA同事说，MySQL可以恢复到半个月内任意一秒的状态，惊叹的同时，你是不是心中也会不免会好奇，这是怎样做到的呢？</p><p>我们还是从一个表的一条更新语句说起，下面是这个表的创建语句，这个表有一个主键ID和一个整型字段c：</p><pre><code>mysql&gt; create table T(ID int primary key, c int);
</code></pre><p>如果要将ID=2这一行的值加1，SQL语句就会这么写：</p><pre><code>mysql&gt; update T set c=c+1 where ID=2;
</code></pre><p>前面我有跟你介绍过SQL语句基本的执行链路，这里我再把那张图拿过来，你也可以先简单看看这个图回顾下。首先，可以确定的说，查询语句的那一套流程，更新语句也是同样会走一遍。</p><p><img src="https://static001.geekbang.org/resource/image/0d/d9/0d2070e8f84c4801adbfa03bda1f98d9.png" alt=""></p><center><span class="reference">MySQL的逻辑架构图</span></center><p>你执行语句前要先连接数据库，这是连接器的工作。</p><p>前面我们说过，在一个表上有更新的时候，跟这个表有关的查询缓存会失效，所以这条语句就会把表T上所有缓存结果都清空。这也就是我们一般不建议使用查询缓存的原因。</p><p>接下来，分析器会通过词法和语法解析知道这是一条更新语句。优化器决定要使用ID这个索引。然后，执行器负责具体执行，找到这一行，然后更新。</p><!-- [[[read_end]]] --><p>与查询流程不一样的是，更新流程还涉及两个重要的日志模块，它们正是我们今天要讨论的主角：redo log（重做日志）和 binlog（归档日志）。如果接触MySQL，那这两个词肯定是绕不过的，我后面的内容里也会不断地和你强调。不过话说回来，redo log和binlog在设计上有很多有意思的地方，这些设计思路也可以用到你自己的程序里。</p><h1>重要的日志模块：redo log</h1><p>不知道你还记不记得《孔乙己》这篇文章，酒店掌柜有一个粉板，专门用来记录客人的赊账记录。如果赊账的人不多，那么他可以把顾客名和账目写在板上。但如果赊账的人多了，粉板总会有记不下的时候，这个时候掌柜一定还有一个专门记录赊账的账本。</p><p>如果有人要赊账或者还账的话，掌柜一般有两种做法：</p><ul>
<li>一种做法是直接把账本翻出来，把这次赊的账加上去或者扣除掉；</li>
<li>另一种做法是先在粉板上记下这次的账，等打烊以后再把账本翻出来核算。</li>
</ul><p>在生意红火柜台很忙时，掌柜一定会选择后者，因为前者操作实在是太麻烦了。首先，你得找到这个人的赊账总额那条记录。你想想，密密麻麻几十页，掌柜要找到那个名字，可能还得带上老花镜慢慢找，找到之后再拿出算盘计算，最后再将结果写回到账本上。</p><p>这整个过程想想都麻烦。相比之下，还是先在粉板上记一下方便。你想想，如果掌柜没有粉板的帮助，每次记账都得翻账本，效率是不是低得让人难以忍受？</p><p>同样，在MySQL里也有这个问题，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程IO成本、查找成本都很高。为了解决这个问题，MySQL的设计者就用了类似酒店掌柜粉板的思路来提升更新效率。</p><p>而粉板和账本配合的整个过程，其实就是MySQL里经常说到的WAL技术，WAL的全称是Write-Ahead Logging，它的关键点就是先写日志，再写磁盘，也就是先写粉板，等不忙的时候再写账本。</p><p>具体来说，当有一条记录需要更新的时候，InnoDB引擎就会先把记录写到redo log（粉板）里面，并更新内存，这个时候更新就算完成了。同时，InnoDB引擎会在适当的时候，将这个操作记录更新到磁盘里面，而这个更新往往是在系统比较空闲的时候做，这就像打烊以后掌柜做的事。</p><p>如果今天赊账的不多，掌柜可以等打烊后再整理。但如果某天赊账的特别多，粉板写满了，又怎么办呢？这个时候掌柜只好放下手中的活儿，把粉板中的一部分赊账记录更新到账本中，然后把这些记录从粉板上擦掉，为记新账腾出空间。</p><p>与此类似，InnoDB的redo log是固定大小的，比如可以配置为一组4个文件，每个文件的大小是1GB，那么这块“粉板”总共就可以记录4GB的操作。从头开始写，写到末尾就又回到开头循环写，如下面这个图所示。</p><p><img src="https://static001.geekbang.org/resource/image/b0/9c/b075250cad8d9f6c791a52b6a600f69c.jpg" alt=""></p><p>write pos是当前记录的位置，一边写一边后移，写到第3号文件末尾后就回到0号文件开头。checkpoint是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件。</p><p>write pos和checkpoint之间的是“粉板”上还空着的部分，可以用来记录新的操作。如果write pos追上checkpoint，表示“粉板”满了，这时候不能再执行新的更新，得停下来先擦掉一些记录，把checkpoint推进一下。</p><p>有了redo log，InnoDB就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为<strong>crash-safe</strong>。</p><p>要理解crash-safe这个概念，可以想想我们前面赊账记录的例子。只要赊账记录记在了粉板上或写在了账本上，之后即使掌柜忘记了，比如突然停业几天，恢复生意后依然可以通过账本和粉板上的数据明确赊账账目。</p><h1>重要的日志模块：binlog</h1><p>前面我们讲过，MySQL整体来看，其实就有两块：一块是Server层，它主要做的是MySQL功能层面的事情；还有一块是引擎层，负责存储相关的具体事宜。上面我们聊到的粉板redo log是InnoDB引擎特有的日志，而Server层也有自己的日志，称为binlog（归档日志）。</p><p>我想你肯定会问，为什么会有两份日志呢？</p><p>因为最开始MySQL里并没有InnoDB引擎。MySQL自带的引擎是MyISAM，但是MyISAM没有crash-safe的能力，binlog日志只能用于归档。而InnoDB是另一个公司以插件形式引入MySQL的，既然只依靠binlog是没有crash-safe能力的，所以InnoDB使用另外一套日志系统——也就是redo log来实现crash-safe能力。</p><p>这两种日志有以下三点不同。</p><ol>
<li>
<p>redo log是InnoDB引擎特有的；binlog是MySQL的Server层实现的，所有引擎都可以使用。</p>
</li>
<li>
<p>redo log是物理日志，记录的是“在某个数据页上做了什么修改”；binlog是逻辑日志，记录的是这个语句的原始逻辑，比如“给ID=2这一行的c字段加1 ”。</p>
</li>
<li>
<p>redo log是循环写的，空间固定会用完；binlog是可以追加写入的。“追加写”是指binlog文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。</p>
</li>
</ol><p>有了对这两个日志的概念性理解，我们再来看执行器和InnoDB引擎在执行这个简单的update语句时的内部流程。</p><ol>
<li>
<p>执行器先找引擎取ID=2这一行。ID是主键，引擎直接用树搜索找到这一行。如果ID=2这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回。</p>
</li>
<li>
<p>执行器拿到引擎给的行数据，把这个值加上1，比如原来是N，现在就是N+1，得到新的一行数据，再调用引擎接口写入这行新数据。</p>
</li>
<li>
<p>引擎将这行新数据更新到内存中，同时将这个更新操作记录到redo log里面，此时redo log处于prepare状态。然后告知执行器执行完成了，随时可以提交事务。</p>
</li>
<li>
<p>执行器生成这个操作的binlog，并把binlog写入磁盘。</p>
</li>
<li>
<p>执行器调用引擎的提交事务接口，引擎把刚刚写入的redo log改成提交（commit）状态，更新完成。</p>
</li>
</ol><p>这里我给出这个update语句的执行流程图，图中浅色框表示是在InnoDB内部执行的，深色框表示是在执行器中执行的。</p><p><img src="https://static001.geekbang.org/resource/image/2e/be/2e5bff4910ec189fe1ee6e2ecc7b4bbe.png" alt=""></p><center><span class="reference">update语句执行流程</span></center><p>你可能注意到了，最后三步看上去有点“绕”，将redo log的写入拆成了两个步骤：prepare和commit，这就是"两阶段提交"。</p><h1>两阶段提交</h1><p>为什么必须有“两阶段提交”呢？这是为了让两份日志之间的逻辑一致。要说明这个问题，我们得从文章开头的那个问题说起：<strong>怎样让数据库恢复到半个月内任意一秒的状态？</strong></p><p>前面我们说过了，binlog会记录所有的逻辑操作，并且是采用“追加写”的形式。如果你的DBA承诺说半个月内可以恢复，那么备份系统中一定会保存最近半个月的所有binlog，同时系统会定期做整库备份。这里的“定期”取决于系统的重要性，可以是一天一备，也可以是一周一备。</p><p>当需要恢复到指定的某一秒时，比如某天下午两点发现中午十二点有一次误删表，需要找回数据，那你可以这么做：</p><ul>
<li>首先，找到最近的一次全量备份，如果你运气好，可能就是昨天晚上的一个备份，从这个备份恢复到临时库；</li>
<li>然后，从备份的时间点开始，将备份的binlog依次取出来，重放到中午误删表之前的那个时刻。</li>
</ul><p>这样你的临时库就跟误删之前的线上库一样了，然后你可以把表数据从临时库取出来，按需要恢复到线上库去。</p><p>好了，说完了数据恢复过程，我们回来说说，为什么日志需要“两阶段提交”。这里不妨用反证法来进行解释。</p><p>由于redo log和binlog是两个独立的逻辑，如果不用两阶段提交，要么就是先写完redo log再写binlog，或者采用反过来的顺序。我们看看这两种方式会有什么问题。</p><p>仍然用前面的update语句来做例子。假设当前ID=2的行，字段c的值是0，再假设执行update语句过程中在写完第一个日志后，第二个日志还没有写完期间发生了crash，会出现什么情况呢？</p><ol>
<li>
<p><strong>先写redo log后写binlog</strong>。假设在redo log写完，binlog还没有写完的时候，MySQL进程异常重启。由于我们前面说过的，redo log写完之后，系统即使崩溃，仍然能够把数据恢复回来，所以恢复后这一行c的值是1。<br>
但是由于binlog没写完就crash了，这时候binlog里面就没有记录这个语句。因此，之后备份日志的时候，存起来的binlog里面就没有这条语句。<br>
然后你会发现，如果需要用这个binlog来恢复临时库的话，由于这个语句的binlog丢失，这个临时库就会少了这一次更新，恢复出来的这一行c的值就是0，与原库的值不同。</p>
</li>
<li>
<p><strong>先写binlog后写redo log</strong>。如果在binlog写完之后crash，由于redo log还没写，崩溃恢复以后这个事务无效，所以这一行c的值是0。但是binlog里面已经记录了“把c从0改成1”这个日志。所以，在之后用binlog来恢复的时候就多了一个事务出来，恢复出来的这一行c的值就是1，与原库的值不同。</p>
</li>
</ol><p>可以看到，如果不使用“两阶段提交”，那么数据库的状态就有可能和用它的日志恢复出来的库的状态不一致。</p><p>你可能会说，这个概率是不是很低，平时也没有什么动不动就需要恢复临时库的场景呀？</p><p>其实不是的，不只是误操作后需要用这个过程来恢复数据。当你需要扩容的时候，也就是需要再多搭建一些备库来增加系统的读能力的时候，现在常见的做法也是用全量备份加上应用binlog来实现的，这个“不一致”就会导致你的线上出现主从数据库不一致的情况。</p><p>简单说，redo log和binlog都可以用于表示事务的提交状态，而两阶段提交就是让这两个状态保持逻辑上的一致。</p><h1>小结</h1><p>今天，我介绍了MySQL里面最重要的两个日志，即物理日志redo log和逻辑日志binlog。</p><p>redo log用于保证crash-safe能力。innodb_flush_log_at_trx_commit这个参数设置成1的时候，表示每次事务的redo log都直接持久化到磁盘。这个参数我建议你设置成1，这样可以保证MySQL异常重启之后数据不丢失。</p><p>sync_binlog这个参数设置成1的时候，表示每次事务的binlog都持久化到磁盘。这个参数我也建议你设置成1，这样可以保证MySQL异常重启之后binlog不丢失。</p><p>我还跟你介绍了与MySQL日志系统密切相关的“两阶段提交”。两阶段提交是跨系统维持数据逻辑一致性时常用的一个方案，即使你不做数据库内核开发，日常开发中也有可能会用到。</p><p>文章的最后，我给你留一个思考题吧。前面我说到定期全量备份的周期“取决于系统重要性，有的是一天一备，有的是一周一备”。那么在什么场景下，一天一备会比一周一备更有优势呢？或者说，它影响了这个数据库系统的哪个指标？</p><p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾给出我的答案。</p><p>感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p>
                         </div>
                        </div> 
                       </div> 
                       <!----> 
                       <!---->

<p>​                  </div><br>                     </div><br>      </div><br>   </body><br>   </html></p>
<p>本文为转载自 “ 极客时间 ”，发布在此是为了方便自己随时阅读，如有涉及版权问题，请留言提示删除。    </p>
]]></content>
      <categories>
        <category>极客时间</category>
        <category>MySQL实战45讲</category>
      </categories>
      <tags>
        <tag>SQL更新</tag>
      </tags>
  </entry>
  <entry>
    <title>03.事务隔离：为什么你改了我还看不见？</title>
    <url>/2020/04/23/03-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E6%94%B9%E4%BA%86%E6%88%91%E8%BF%98%E7%9C%8B%E4%B8%8D%E8%A7%81%EF%BC%9F/</url>
    <content><![CDATA[<!DOCTYPE html>
<html>

  <body>
      <div id=app>
                     <div data-v-87ffcada="" class="article"> 
                      <div data-v-87ffcada="" class="main main-app"> 
                       <div data-v-87ffcada="" class="breadcrumb breadcrumb pd"> 
                       </div> 
                       <h1 data-v-87ffcada="" class="article-title pd"> 03 | 事务隔离：为什么你改了我还看不见？ </h1> 
                       <div data-v-87ffcada="" class="article-info pd"> 
                        <span data-v-87ffcada="">2018-11-19</span> 
                        <span data-v-87ffcada="">林晓斌</span>
                       </div> 
                       <div data-v-87ffcada="" class="article-content typo common-content pd"> 
                        <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/5b/bd/5b414d250e735b9373e46eee3f8c1fbd.jpg" /> 
                        <div data-v-87ffcada="" id="article-content" class="">
                         <div class="text"> 
                             <p>提到事务，你肯定不陌生，和数据库打交道的时候，我们总是会用到事务。最经典的例子就是转账，你要给朋友小王转100块钱，而此时你的银行卡只有100块钱。</p><p>转账过程具体到程序里会有一系列的操作，比如查询余额、做加减法、更新余额等，这些操作必须保证是一体的，不然等程序查完之后，还没做减法之前，你这100块钱，完全可以借着这个时间差再查一次，然后再给另外一个朋友转账，如果银行这么整，不就乱了么？这时就要用到“事务”这个概念了。</p><p>简单来说，事务就是要保证一组数据库操作，要么全部成功，要么全部失败。在MySQL中，事务支持是在引擎层实现的。你现在知道，MySQL是一个支持多引擎的系统，但并不是所有的引擎都支持事务。比如MySQL原生的MyISAM引擎就不支持事务，这也是MyISAM被InnoDB取代的重要原因之一。</p><p>今天的文章里，我将会以InnoDB为例，剖析MySQL在事务支持方面的特定实现，并基于原理给出相应的实践建议，希望这些案例能加深你对MySQL事务原理的理解。</p><h1>隔离性与隔离级别</h1><p>提到事务，你肯定会想到ACID（Atomicity、Consistency、Isolation、Durability，即原子性、一致性、隔离性、持久性），今天我们就来说说其中I，也就是“隔离性”。</p><!-- [[[read_end]]] --><p>当数据库上有多个事务同时执行的时候，就可能出现脏读（dirty read）、不可重复读（non-repeatable read）、幻读（phantom read）的问题，为了解决这些问题，就有了“隔离级别”的概念。</p><p>在谈隔离级别之前，你首先要知道，你隔离得越严实，效率就会越低。因此很多时候，我们都要在二者之间寻找一个平衡点。SQL标准的事务隔离级别包括：读未提交（read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（serializable ）。下面我逐一为你解释：</p><ul>
<li>读未提交是指，一个事务还没提交时，它做的变更就能被别的事务看到。</li>
<li>读提交是指，一个事务提交之后，它做的变更才会被其他事务看到。</li>
<li>可重复读是指，一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的。当然在可重复读隔离级别下，未提交变更对其他事务也是不可见的。</li>
<li>串行化，顾名思义是对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。</li>
</ul><p>其中“读提交”和“可重复读”比较难理解，所以我用一个例子说明这几种隔离级别。假设数据表T中只有一列，其中一行的值为1，下面是按照时间顺序执行两个事务的行为。</p><pre><code>mysql&gt; create table T(c int) engine=InnoDB;
insert into T(c) values(1);
</code></pre><p><img src="https://static001.geekbang.org/resource/image/7d/f8/7dea45932a6b722eb069d2264d0066f8.png" alt=""><br>
我们来看看在不同的隔离级别下，事务A会有哪些不同的返回结果，也就是图里面V1、V2、V3的返回值分别是什么。</p><ul>
<li>若隔离级别是“读未提交”， 则V1的值就是2。这时候事务B虽然还没有提交，但是结果已经被A看到了。因此，V2、V3也都是2。</li>
<li>若隔离级别是“读提交”，则V1是1，V2的值是2。事务B的更新在提交后才能被A看到。所以， V3的值也是2。</li>
<li>若隔离级别是“可重复读”，则V1、V2是1，V3是2。之所以V2还是1，遵循的就是这个要求：事务在执行期间看到的数据前后必须是一致的。</li>
<li>若隔离级别是“串行化”，则在事务B执行“将1改成2”的时候，会被锁住。直到事务A提交后，事务B才可以继续执行。所以从A的角度看， V1、V2值是1，V3的值是2。</li>
</ul><p>在实现上，数据库里面会创建一个视图，访问的时候以视图的逻辑结果为准。在“可重复读”隔离级别下，这个视图是在事务启动时创建的，整个事务存在期间都用这个视图。在“读提交”隔离级别下，这个视图是在每个SQL语句开始执行的时候创建的。这里需要注意的是，“读未提交”隔离级别下直接返回记录上的最新值，没有视图概念；而“串行化”隔离级别下直接用加锁的方式来避免并行访问。</p><p>我们可以看到在不同的隔离级别下，数据库行为是有所不同的。Oracle数据库的默认隔离级别其实就是“读提交”，因此对于一些从Oracle迁移到MySQL的应用，为保证数据库隔离级别的一致，你一定要记得将MySQL的隔离级别设置为“读提交”。</p><p>配置的方式是，将启动参数transaction-isolation的值设置成READ-COMMITTED。你可以用show variables来查看当前的值。</p><pre><code>mysql&gt; show variables like 'transaction_isolation';

<p>+———————–+—————-+</p>
<p>| Variable_name | Value |</p>
<p>+———————–+—————-+</p>
<p>| transaction_isolation | READ-COMMITTED |</p>
<p>+———————–+—————-+<br></code></pre><p>总结来说，存在即合理，哪个隔离级别都有它自己的使用场景，你要根据自己的业务情况来定。我想<strong>你可能会问那什么时候需要“可重复读”的场景呢</strong>？我们来看一个数据校对逻辑的案例。</p><p>假设你在管理一个个人银行账户表。一个表存了每个月月底的余额，一个表存了账单明细。这时候你要做数据校对，也就是判断上个月的余额和当前余额的差额，是否与本月的账单明细一致。你一定希望在校对过程中，即使有用户发生了一笔新的交易，也不影响你的校对结果。</p><p>这时候使用“可重复读”隔离级别就很方便。事务启动时的视图可以认为是静态的，不受其他事务更新的影响。</p><h1>事务隔离的实现</h1><p>理解了事务的隔离级别，我们再来看看事务隔离具体是怎么实现的。这里我们展开说明“可重复读”。</p><p>在MySQL中，实际上每条记录在更新的时候都会同时记录一条回滚操作。记录上的最新值，通过回滚操作，都可以得到前一个状态的值。</p><p>假设一个值从1被按顺序改成了2、3、4，在回滚日志里面就会有类似下面的记录。</p><p><img src="https://static001.geekbang.org/resource/image/d9/ee/d9c313809e5ac148fc39feff532f0fee.png" alt=""><br><br>当前值是4，但是在查询这条记录的时候，不同时刻启动的事务会有不同的read-view。如图中看到的，在视图A、B、C里面，这一个记录的值分别是1、2、4，同一条记录在系统中可以存在多个版本，就是数据库的多版本并发控制（MVCC）。对于read-view A，要得到1，就必须将当前值依次执行图中所有的回滚操作得到。</p><p>同时你会发现，即使现在有另外一个事务正在将4改成5，这个事务跟read-view A、B、C对应的事务是不会冲突的。</p><p>你一定会问，回滚日志总不能一直保留吧，什么时候删除呢？答案是，在不需要的时候才删除。也就是说，系统会判断，当没有事务再需要用到这些回滚日志时，回滚日志会被删除。</p><p>什么时候才不需要了呢？就是当系统里没有比这个回滚日志更早的read-view的时候。</p><p>基于上面的说明，我们来讨论一下为什么建议你尽量不要使用长事务。</p><p>长事务意味着系统里面会存在很老的事务视图。由于这些事务随时可能访问数据库里面的任何数据，所以这个事务提交之前，数据库里面它可能用到的回滚记录都必须保留，这就会导致大量占用存储空间。</p><p>在MySQL 5.5及以前的版本，回滚日志是跟数据字典一起放在ibdata文件里的，即使长事务最终提交，回滚段被清理，文件也不会变小。我见过数据只有20GB，而回滚段有200GB的库。最终只好为了清理回滚段，重建整个库。</p><p>除了对回滚段的影响，长事务还占用锁资源，也可能拖垮整个库，这个我们会在后面讲锁的时候展开。</p><h1>事务的启动方式</h1><p>如前面所述，长事务有这些潜在风险，我当然是建议你尽量避免。其实很多时候业务开发同学并不是有意使用长事务，通常是由于误用所致。MySQL的事务启动方式有以下几种：</p><ol></p>
<li>
<p>显式启动事务语句， begin 或 start transaction。配套的提交语句是commit，回滚语句是rollback。</p>
</li>
<li>
<p>set autocommit=0，这个命令会将这个线程的自动提交关掉。意味着如果你只执行一个select语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行commit 或 rollback 语句，或者断开连接。</p>
</li>
</ol><p>有些客户端连接框架会默认连接成功后先执行一个set autocommit=0的命令。这就导致接下来的查询都在事务中，如果是长连接，就导致了意外的长事务。</p><p>因此，我会建议你总是使用set autocommit=1, 通过显式语句的方式来启动事务。</p><p>但是有的开发同学会纠结“多一次交互”的问题。对于一个需要频繁使用事务的业务，第二种方式每个事务在开始时都不需要主动执行一次 “begin”，减少了语句的交互次数。如果你也有这个顾虑，我建议你使用commit work and chain语法。</p><p>在autocommit为1的情况下，用begin显式启动的事务，如果执行commit则提交事务。如果执行 commit work and chain，则是提交事务并自动启动下一个事务，这样也省去了再次执行begin语句的开销。同时带来的好处是从程序开发的角度明确地知道每个语句是否处于事务中。</p><p>你可以在information_schema库的innodb_trx这个表中查询长事务，比如下面这个语句，用于查找持续时间超过60s的事务。</p><pre><code>select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))&gt;60
</code></pre><h1>小结</h1><p>这篇文章里面，我介绍了MySQL的事务隔离级别的现象和实现，根据实现原理分析了长事务存在的风险，以及如何用正确的方式避免长事务。希望我举的例子能够帮助你理解事务，并更好地使用MySQL的事务特性。</p><p>我给你留一个问题吧。你现在知道了系统里面应该避免长事务，如果你是业务开发负责人同时也是数据库负责人，你会有什么方案来避免出现或者处理这种情况呢？</p><p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>在上期文章的最后，我给你留下的问题是一天一备跟一周一备的对比。</p><p>好处是“最长恢复时间”更短。</p><p>在一天一备的模式里，最坏情况下需要应用一天的binlog。比如，你每天0点做一次全量备份，而要恢复出一个到昨天晚上23点的备份。</p><p>一周一备最坏情况就要应用一周的binlog了。</p><p>系统的对应指标就是 @尼古拉斯·赵四 @慕塔 提到的RTO（恢复目标时间）。</p><p>当然这个是有成本的，因为更频繁全量备份需要消耗更多存储空间，所以这个RTO是成本换来的，就需要你根据业务重要性来评估了。</p><p>同时也感谢 @super blue cat、@高枕、@Jason 留下了高质量的评论。</p>
                         </div>
                        </div> 
                       </div> 
                       <!----> 
                       <!---->
                      </div>
                     </div>
      </div>
   </body>
   </html>]]></content>
      <categories>
        <category>极客时间</category>
        <category>MySQL实战45讲</category>
      </categories>
      <tags>
        <tag>事务隔离</tag>
      </tags>
  </entry>
  <entry>
    <title>05.深入浅出索引（下）</title>
    <url>/2020/04/23/05-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%B4%A2%E5%BC%95%EF%BC%88%E4%B8%8B%EF%BC%89/</url>
    <content><![CDATA[<!DOCTYPE html>
<html>

  <body>
      <div id=app>
                     <div data-v-87ffcada="" class="article"> 
                      <div data-v-87ffcada="" class="main main-app"> 
                       <div data-v-87ffcada="" class="breadcrumb breadcrumb pd"> 
                       </div> 
                       <h1 data-v-87ffcada="" class="article-title pd"> 05 | 深入浅出索引（下） </h1> 
                       <div data-v-87ffcada="" class="article-info pd"> 
                        <span data-v-87ffcada="">2018-11-23</span> 
                        <span data-v-87ffcada="">林晓斌</span>
                       </div> 
                       <div data-v-87ffcada="" class="article-content typo common-content pd"> 
                        <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/b1/9a/b19cb8fb9c5f7b565a89ab4c49811f9a.jpg" /> 
                        <div data-v-87ffcada="" id="article-content" class="">
                         <div class="text"> 
                             <p>在上一篇文章中，我和你介绍了InnoDB索引的数据结构模型，今天我们再继续聊聊跟MySQL索引有关的概念。</p><p>在开始这篇文章之前，我们先来看一下这个问题：</p><p>在下面这个表T中，如果我执行 select * from T where k between 3 and 5，需要执行几次树的搜索操作，会扫描多少行？</p><p>下面是这个表的初始化语句。</p><pre><code>mysql&gt; create table T (
ID int primary key,
k int NOT NULL DEFAULT 0, 
s varchar(16) NOT NULL DEFAULT '',
index k(k))
engine=InnoDB;

<p>insert into T values(100,1, ‘aa’),(200,2,’bb’),(300,3,’cc’),(500,5,’ee’),(600,6,’ff’),(700,7,’gg’);<br></code></pre><p><img src="https://static001.geekbang.org/resource/image/dc/8d/dcda101051f28502bd5c4402b292e38d.png" alt=""></p><center><span class="reference">图1 InnoDB的索引组织结构</span></center><p>现在，我们一起来看看这条SQL查询语句的执行流程：</p><ol></p>
<li>
<p>在k索引树上找到k=3的记录，取得 ID = 300；</p>
</li>
<li>
<p>再到ID索引树查到ID=300对应的R3；</p>
</li>
<li>
<p>在k索引树取下一个值k=5，取得ID=500；</p>
</li>
<li>
<p>再回到ID索引树查到ID=500对应的R4；</p>
</li>
<li>
<p>在k索引树取下一个值k=6，不满足条件，循环结束。</p>
</li>
</ol><p>在这个过程中，<strong>回到主键索引树搜索的过程，我们称为回表</strong>。可以看到，这个查询过程读了k索引树的3条记录（步骤1、3和5），回表了两次（步骤2和4）。</p><p>在这个例子中，由于查询结果所需要的数据只在主键索引上有，所以不得不回表。那么，有没有可能经过索引优化，避免回表过程呢？</p><h1>覆盖索引</h1><p>如果执行的语句是select ID from T where k between 3 and 5，这时只需要查ID的值，而ID的值已经在k索引树上了，因此可以直接提供查询结果，不需要回表。也就是说，在这个查询里面，索引k已经“覆盖了”我们的查询需求，我们称为覆盖索引。</p><!-- [[[read_end]]] --><p><strong>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</strong></p><p>需要注意的是，在引擎内部使用覆盖索引在索引k上其实读了三个记录，R3~R5（对应的索引k上的记录项），但是对于MySQL的Server层来说，它就是找引擎拿到了两条记录，因此MySQL认为扫描行数是2。</p><blockquote>
<p>备注：关于如何查看扫描行数的问题，我将会在第16文章《如何正确地显示随机消息？》中，和你详细讨论。</p>
</blockquote><p>基于上面覆盖索引的说明，我们来讨论一个问题：<strong>在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？</strong></p><p>假设这个市民表的定义是这样的：</p><pre><code>CREATE TABLE `tuser` (
  `id` int(11) NOT NULL,
  `id_card` varchar(32) DEFAULT NULL,
  `name` varchar(32) DEFAULT NULL,
  `age` int(11) DEFAULT NULL,
  `ismale` tinyint(1) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `id_card` (`id_card`),
  KEY `name_age` (`name`,`age`)
) ENGINE=InnoDB
</code></pre><p>我们知道，身份证号是市民的唯一标识。也就是说，如果有根据身份证号查询市民信息的需求，我们只要在身份证号字段上建立索引就够了。而再建立一个（身份证号、姓名）的联合索引，是不是浪费空间？</p><p>如果现在有一个高频请求，要根据市民的身份证号查询他的姓名，这个联合索引就有意义了。它可以在这个高频请求上用到覆盖索引，不再需要回表查整行记录，减少语句的执行时间。</p><p>当然，索引字段的维护总是有代价的。因此，在建立冗余索引来支持覆盖索引时就需要权衡考虑了。这正是业务DBA，或者称为业务数据架构师的工作。</p><h1>最左前缀原则</h1><p>看到这里你一定有一个疑问，如果为每一种查询都设计一个索引，索引是不是太多了。如果我现在要按照市民的身份证号去查他的家庭地址呢？虽然这个查询需求在业务中出现的概率不高，但总不能让它走全表扫描吧？反过来说，单独为一个不频繁的请求创建一个（身份证号，地址）的索引又感觉有点浪费。应该怎么做呢？</p><p>这里，我先和你说结论吧。<strong>B+树这种索引结构，可以利用索引的“最左前缀”，来定位记录。</strong></p><p>为了直观地说明这个概念，我们用（name，age）这个联合索引来分析。</p><p><img src="https://static001.geekbang.org/resource/image/89/70/89f74c631110cfbc83298ef27dcd6370.jpg" alt=""></p><center><span class="reference">图2 （name，age）索引示意图</span></center><p>可以看到，索引项是按照索引定义里面出现的字段顺序排序的。</p><p>当你的逻辑需求是查到所有名字是“张三”的人时，可以快速定位到ID4，然后向后遍历得到所有需要的结果。</p><p>如果你要查的是所有名字第一个字是“张”的人，你的SQL语句的条件是"where name like ‘张%’"。这时，你也能够用上这个索引，查找到第一个符合条件的记录是ID3，然后向后遍历，直到不满足条件为止。</p><p>可以看到，不只是索引的全部定义，只要满足最左前缀，就可以利用索引来加速检索。这个最左前缀可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符。</p><p>基于上面对最左前缀索引的说明，我们来讨论一个问题：<strong>在建立联合索引的时候，如何安排索引内的字段顺序。</strong></p><p>这里我们的评估标准是，索引的复用能力。因为可以支持最左前缀，所以当已经有了(a,b)这个联合索引后，一般就不需要单独在a上建立索引了。因此，<strong>第一原则是，如果通过调整顺序，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。</strong></p><p>所以现在你知道了，这段开头的问题里，我们要为高频请求创建(身份证号，姓名）这个联合索引，并用这个索引支持“根据身份证号查询地址”的需求。</p><p>那么，如果既有联合查询，又有基于a、b各自的查询呢？查询条件里面只有b的语句，是无法使用(a,b)这个联合索引的，这时候你不得不维护另外一个索引，也就是说你需要同时维护(a,b)、(b) 这两个索引。</p><p>这时候，我们要<strong>考虑的原则就是空间</strong>了。比如上面这个市民表的情况，name字段是比age字段大的 ，那我就建议你创建一个（name,age)的联合索引和一个(age)的单字段索引。</p><h1>索引下推</h1><p>上一段我们说到满足最左前缀原则的时候，最左前缀可以用于在索引中定位记录。这时，你可能要问，那些不符合最左前缀的部分，会怎么样呢？</p><p>我们还是以市民表的联合索引（name, age）为例。如果现在有一个需求：检索出表中“名字第一个字是张，而且年龄是10岁的所有男孩”。那么，SQL语句是这么写的：</p><pre><code>mysql&gt; select * from tuser where name like '张%' and age=10 and ismale=1;
</code></pre><p>你已经知道了前缀索引规则，所以这个语句在搜索索引树的时候，只能用 “张”，找到第一个满足条件的记录ID3。当然，这还不错，总比全表扫描要好。</p><p>然后呢？</p><p>当然是判断其他条件是否满足。</p><p>在MySQL 5.6之前，只能从ID3开始一个个回表。到主键索引上找出数据行，再对比字段值。</p><p>而MySQL 5.6 引入的索引下推优化（index condition pushdown)， 可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。</p><p>图3和图4，是这两个过程的执行流程图。</p><p><img src="https://static001.geekbang.org/resource/image/b3/ac/b32aa8b1f75611e0759e52f5915539ac.jpg" alt=""></p><center><span class="reference">图3 无索引下推执行流程</span></center><p><img src="https://static001.geekbang.org/resource/image/76/1b/76e385f3df5a694cc4238c7b65acfe1b.jpg" alt=""></p><center><span class="reference">图4 索引下推执行流程</span></center><p>在图3和4这两个图里面，每一个虚线箭头表示回表一次。</p><p>图3中，在(name,age)索引里面我特意去掉了age的值，这个过程InnoDB并不会去看age的值，只是按顺序把“name第一个字是’张’”的记录一条条取出来回表。因此，需要回表4次。</p><p>图4跟图3的区别是，InnoDB在(name,age)索引内部就判断了age是否等于10，对于不等于10的记录，直接判断并跳过。在我们的这个例子中，只需要对ID4、ID5这两条记录回表取数据判断，就只需要回表2次。</p><h1>小结</h1><p>今天这篇文章，我和你继续讨论了数据库索引的概念，包括了覆盖索引、前缀索引、索引下推。你可以看到，在满足语句需求的情况下， 尽量少地访问资源是数据库设计的重要原则之一。我们在使用数据库的时候，尤其是在设计表结构时，也要以减少资源消耗作为目标。</p><p>接下来我给你留下一个问题吧。</p><p>实际上主键索引也是可以使用多个字段的。DBA小吕在入职新公司的时候，就发现自己接手维护的库里面，有这么一个表，表结构定义类似这样的：</p><pre><code>CREATE TABLE `geek` (
  `a` int(11) NOT NULL,
  `b` int(11) NOT NULL,
  `c` int(11) NOT NULL,
  `d` int(11) NOT NULL,
  PRIMARY KEY (`a`,`b`),
  KEY `c` (`c`),
  KEY `ca` (`c`,`a`),
  KEY `cb` (`c`,`b`)
) ENGINE=InnoDB;
</code></pre><p>公司的同事告诉他说，由于历史原因，这个表需要a、b做联合主键，这个小吕理解了。</p><p>但是，学过本章内容的小吕又纳闷了，既然主键包含了a、b这两个字段，那意味着单独在字段c上创建一个索引，就已经包含了三个字段了呀，为什么要创建“ca”“cb”这两个索引？</p><p>同事告诉他，是因为他们的业务里面有这样的两种语句：</p><pre><code>select * from geek where c=N order by a limit 1;
select * from geek where c=N order by b limit 1;
</code></pre><p>我给你的问题是，这位同事的解释对吗，为了这两个查询模式，这两个索引是否都是必须的？为什么呢？</p><p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>上期的问题是，通过两个alter 语句重建索引k，以及通过两个alter语句重建主键索引是否合理。</p><p>在评论区，有同学问到为什么要重建索引。我们文章里面有提到，索引可能因为删除，或者页分裂等原因，导致数据页有空洞，重建索引的过程会创建一个新的索引，把数据按顺序插入，这样页面的利用率最高，也就是索引更紧凑、更省空间。</p><p>这道题目，我给你的“参考答案”是：</p><p>重建索引k的做法是合理的，可以达到省空间的目的。但是，重建主键的过程不合理。不论是删除主键还是创建主键，都会将整个表重建。所以连着执行这两个语句的话，第一个语句就白做了。这两个语句，你可以用这个语句代替 ： alter table T engine=InnoDB。在专栏的第12篇文章《为什么表数据删掉一半，表文件大小不变？》中，我会和你分析这条语句的执行流程。</p><p>评论区留言中， @壹笙☞漂泊 做了很详细的笔记，@高枕 帮同学解答了问题，@约书亚 提了一个很不错的面试问题。在这里，我要和你们道一声感谢。</p><p>PS：如果你在面试中，曾有过被MySQL相关问题难住的经历，也可以把这个问题发到评论区，我们一起来讨论。如果解答这个问题，需要的篇幅会很长的话，我可以放到答疑文章展开。</p>
                         </div>
                        </div> 
                       </div> 
                       <!----> 
                       <!---->
                      </div>
                     </div>
      </div>
   </body>
   </html>

























<p>本文为转载自 “ 极客时间 ”，发布在此是为了方便自己随时阅读，如有涉及版权问题，请留言提示删除。    </p>
]]></content>
      <categories>
        <category>极客时间</category>
        <category>MySQL实战45讲</category>
      </categories>
      <tags>
        <tag>索引</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity-（五）HelloWorld实现</title>
    <url>/2020/03/11/Activity-%EF%BC%88%E4%BA%94%EF%BC%89HelloWorld%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h3 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h3><p>做一个最简单的HellWorld流程用代码的方式实现并且走完流程。 </p>
<h3 id="以下是涉及到的比较重要的八张表"><a href="#以下是涉及到的比较重要的八张表" class="headerlink" title="以下是涉及到的比较重要的八张表"></a>以下是涉及到的比较重要的八张表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_re_deployment;   <span class="comment">-- 一 流程部署表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_ge_bytearray;    <span class="comment">-- 二 流程二进制表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_re_procdef;      <span class="comment">-- 三 流程定义表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_ru_execution;    <span class="comment">-- 四 流程正在运行表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_hi_procinst;     <span class="comment">-- 五 流程实例历史表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_ru_task;         <span class="comment">-- 六 流程当前任务表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_hi_taskinst;     <span class="comment">-- 七 流程历史任务表</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> act_hi_actinst;      <span class="comment">-- 八 流程历史活动节点表</span></span><br></pre></td></tr></table></figure>

<h3 id="相关步骤如下："><a href="#相关步骤如下：" class="headerlink" title="相关步骤如下："></a>相关步骤如下：</h3><blockquote>
<p>1.首先是需要部署流程定义。</p>
<p>2.启动流程实例。</p>
<p>3.查看流程任务以及完成流程任务。</p>
</blockquote>
<h3 id="先决工作，成员变量定义"><a href="#先决工作，成员变量定义" class="headerlink" title="先决工作，成员变量定义"></a>先决工作，成员变量定义</h3><ol>
<li>获取流程实例引擎<strong>ProcessEngines</strong>；</li>
<li>获取<strong>RepositoryService</strong>;</li>
<li>获取<strong>RuntimeService</strong>;</li>
<li>获取<strong>TaskService</strong>;</li>
<li>获取<strong>HistoryService</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取默认的流程引擎实例 会自动读取activiti.cfg.xml文件 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个成员变量</span></span><br><span class="line">   RepositoryService repositoryService;</span><br><span class="line">   </span><br><span class="line">   RuntimeService runtimeService;</span><br><span class="line">   </span><br><span class="line">   TaskService taskService;</span><br><span class="line">   </span><br><span class="line">   HistoryService historyService;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取流程引擎</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Before</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">       repositoryService = processEngine.getRepositoryService();</span><br><span class="line">       runtimeService = processEngine.getRuntimeService();</span><br><span class="line">       taskService = processEngine.getTaskService();</span><br><span class="line">       historyService = processEngine.getHistoryService();</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="部署流程定义图："><a href="#部署流程定义图：" class="headerlink" title="部署流程定义图："></a>部署流程定义图：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 部署流程定义</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="comment">// 获取部署对象</span></span><br><span class="line">	    Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">	                 .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">	                 .addClasspathResource(<span class="string">"diagrams/MyProcess.bpmn"</span>)  <span class="comment">// 加载资源文件</span></span><br><span class="line"><span class="comment">//	                 .addClasspathResource("diagrams/helloWorld.png")   // 加载资源文件</span></span><br><span class="line"><span class="comment">//	                 .name("HelloWorld流程")  // 流程名称</span></span><br><span class="line">	                 .deploy(); <span class="comment">// 部署</span></span><br><span class="line">	    System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">	    System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">流程部署ID:17501</span><br><span class="line">流程部署Name:null</span><br></pre></td></tr></table></figure>



<h3 id="接着启动流程实例，这样一个流程才开始："><a href="#接着启动流程实例，这样一个流程才开始：" class="headerlink" title="接着启动流程实例，这样一个流程才开始："></a>接着启动流程实例，这样一个流程才开始：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 启动流程</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"myProcess"</span>);</span><br><span class="line">       String processInstanceId = processInstance.getId();</span><br><span class="line">       String activityId = processInstance.getActivityId();</span><br><span class="line">       String definitionId = processInstance.getProcessDefinitionId();</span><br><span class="line">       </span><br><span class="line">       System.out.println(<span class="string">"流程实例ID："</span>+processInstanceId);</span><br><span class="line">       System.out.println(<span class="string">"正在活动的节点ID："</span>+activityId);</span><br><span class="line">       System.out.println(<span class="string">"流程定义ID："</span>+definitionId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">流程实例ID：20001</span><br><span class="line">正在活动的节点ID：usertask1</span><br><span class="line">流程定义ID：myProcess:2:17504</span><br></pre></td></tr></table></figure>



<h3 id="查询正在运行的实例："><a href="#查询正在运行的实例：" class="headerlink" title="查询正在运行的实例："></a>查询正在运行的实例：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询正在运行的实例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryExecution</span><span class="params">()</span></span>&#123;</span><br><span class="line">       List&lt;Execution&gt; executionList = runtimeService.createExecutionQuery()  <span class="comment">//创建正在执行的流程查询对象</span></span><br><span class="line">                     .processDefinitionKey(<span class="string">"myProcess"</span>)   <span class="comment">//根据流程定义的key查询</span></span><br><span class="line">                     .orderByProcessInstanceId()  <span class="comment">//根据流程实例id排序</span></span><br><span class="line">                     .desc()  <span class="comment">//倒序</span></span><br><span class="line">                     .list();  <span class="comment">//查询出集合</span></span><br><span class="line">       <span class="keyword">for</span>(Execution execution: executionList)&#123;</span><br><span class="line">           System.out.println(<span class="string">"正在执行的流程对象的id: "</span>+execution.getId());</span><br><span class="line">           System.out.println(<span class="string">"所属流程实例的id:"</span>+execution.getProcessInstanceId());</span><br><span class="line">           System.out.println(<span class="string">"正在活动的节点的id: "</span>+execution.getActivityId());</span><br><span class="line">           System.out.println(<span class="string">"任务名称: "</span>+execution.getName());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正在执行的流程对象的id: 20001</span><br><span class="line">所属流程实例的id:20001</span><br><span class="line">正在活动的节点的id: usertask1</span><br><span class="line">任务名称: null</span><br></pre></td></tr></table></figure>



<h3 id="查看一下白夜行这个用户的任务信息："><a href="#查看一下白夜行这个用户的任务信息：" class="headerlink" title="查看一下白夜行这个用户的任务信息："></a>查看一下白夜行这个用户的任务信息：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据办理人查询任务</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryTaskByAssignee</span><span class="params">()</span></span>&#123;</span><br><span class="line">       String assignee = <span class="string">"白夜行"</span>;    <span class="comment">// assignee 要与流程图上的 Assignee 相同才会被查询到，否则就不返回该任务对象</span></span><br><span class="line">       <span class="comment">// 查询并且返回任务即可</span></span><br><span class="line">       List&lt;Task&gt; taskList = taskService.createTaskQuery()  <span class="comment">// 任务相关Service // 创建任务查询</span></span><br><span class="line">                                    .processDefinitionKey(<span class="string">"myProcess"</span>)</span><br><span class="line">                                    .taskAssignee(assignee)<span class="comment">// 指定某个人</span></span><br><span class="line">                                    .orderByTaskCreateTime()</span><br><span class="line">                                    .desc()</span><br><span class="line">                                    .list();</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">for</span>(Task task: taskList)&#123;</span><br><span class="line">        System.out.println(<span class="string">"任务ID:"</span>+task.getId());</span><br><span class="line">        System.out.println(<span class="string">"任务名称："</span>+task.getName());</span><br><span class="line">        System.out.println(<span class="string">"任务创建时间："</span>+task.getCreateTime());</span><br><span class="line">        System.out.println(<span class="string">"任务委派人："</span>+task.getAssignee());</span><br><span class="line">        System.out.println(<span class="string">"流程实例ID:"</span>+task.getProcessInstanceId());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">任务ID:20004</span><br><span class="line">任务名称：myprocess</span><br><span class="line">任务创建时间：Thu Mar 12 10:02:57 CST 2020</span><br><span class="line">任务委派人：白夜行</span><br><span class="line">流程实例ID:20001</span><br></pre></td></tr></table></figure>

<h3 id="查询当前流程实例状态"><a href="#查询当前流程实例状态" class="headerlink" title="查询当前流程实例状态"></a>查询当前流程实例状态</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询当前流程实例状态</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryProInstanceStateByProInstanceId</span><span class="params">()</span></span>&#123;</span><br><span class="line">       ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(<span class="string">"12501"</span>).singleResult();</span><br><span class="line">       <span class="keyword">if</span>(processInstance == <span class="keyword">null</span>)&#123;</span><br><span class="line">           System.out.println(<span class="string">"当前流程已经完成"</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           System.out.println(<span class="string">"当前流程实例ID："</span>+processInstance.getId());</span><br><span class="line">           System.out.println(<span class="string">"当前流程所处的位置："</span>+processInstance.getActivityId());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">当前流程实例ID：20001</span><br><span class="line">当前流程所处的位置：usertask1</span><br></pre></td></tr></table></figure>

<h3 id="最后完成HelloWorld节点任务，把流程走完："><a href="#最后完成HelloWorld节点任务，把流程走完：" class="headerlink" title="最后完成HelloWorld节点任务，把流程走完："></a>最后完成HelloWorld节点任务，把流程走完：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	TaskQuery query = taskService.createTaskQuery();			<span class="comment">//创建任务查询对象</span></span><br><span class="line">	List&lt;Task&gt; list = query.processDefinitionKey(<span class="string">"myProcess"</span>)	<span class="comment">//指定流程定义</span></span><br><span class="line">						   .taskAssignee(<span class="string">"白夜行"</span>)				<span class="comment">//指定委托人</span></span><br><span class="line">						   .list();								<span class="comment">//执行查询</span></span><br><span class="line">	<span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">		System.out.println(task);</span><br><span class="line">		<span class="comment">//taskService某些框架下需要使用@Autowired注解装配</span></span><br><span class="line">		taskService.complete(task.getId());						<span class="comment">//完成任务，使任务进入下一步</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询流程实例历史"><a href="#查询流程实例历史" class="headerlink" title="查询流程实例历史"></a>查询流程实例历史</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询流程实例历史</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryHistory</span><span class="params">()</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//1.创建流程实例的历史查询对象，historyService使用@Autowired注解注入</span></span><br><span class="line">	HistoricProcessInstanceQuery query = historyService.createHistoricProcessInstanceQuery();</span><br><span class="line">	HistoricProcessInstance instance = </span><br><span class="line">			query</span><br><span class="line">				.processInstanceId(<span class="string">"12501"</span>)	<span class="comment">//流程实例的id</span></span><br><span class="line">				.finished()					<span class="comment">//调用这个方法后未完成的流程实例会返回null</span></span><br><span class="line">				.singleResult();</span><br><span class="line">	System.out.println(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这里引出一个概念，流程定义和流程实例的关系，可以把这两种关系理解成是类和对象的关系。 </p>
<p>​    流程定义是一个模板，而流程实例就是通过模板演变出来的具体的可用的东西。</p>
<p>首先当运行：deploy()部署流程定义方法，在数据库中流程定义表会发生一些变化新增了一条数据，</p>
<p><strong>act_re_deployment</strong>流程定义部署表：</p>
<img src="http://photo.wushaopei.com/qiniu106.png" width="80%">

<p>然后<strong>act_re_prodef</strong>流程定义表也会有一条数据插入： </p>
<img src="http://photo.wushaopei.com/qiniu107.png" width="80%">

<p>以及在<strong>act_ge_bytearray</strong>表中用来存储资源信息： </p>
<img src="http://photo.wushaopei.com/qiniu108.png" width="80%">

<p>接着来运行<strong>start()</strong>启动流程实例：</p>
<p><strong>act_ru_task</strong>运行时流程任务表新增了一条数据：</p>
<img src="http://photo.wushaopei.com/qiniu109.png" width="80%">

<p><strong>act_ru_execution</strong> 运行时流程执行表： </p>
<img src="http://photo.wushaopei.com/qiniu111.png" width="80%">

<p><strong>act_ru_identitulink</strong>是用于执行主体相关信息表： </p>
<img src="http://photo.wushaopei.com/qiniu110.png" width="80%">

<p>可以查看刚刚”<strong>白夜行</strong>”这个用户的任务：</p>
<p>运行findTask()查看用户任务，控制台输出如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">任务ID:<span class="number">20004</span></span><br><span class="line">任务名称：myprocess</span><br><span class="line">任务创建时间：Thu Mar <span class="number">12</span> <span class="number">10</span>:<span class="number">02</span>:<span class="number">57</span> CST <span class="number">2020</span></span><br><span class="line">任务委派人：白夜行</span><br><span class="line">流程实例ID:<span class="number">20001</span></span><br></pre></td></tr></table></figure>

<p><strong>completeTask()</strong>方法完成任务：</p>
<p>然后数据库中<strong>ru</strong>开头的运行时候所有表的数据都没了，因为现在流程结束，不需要这些数据了。</p>
<p>在hi开头的表里，会新增不少数据，这些数据主要是用来归档查询用的，也就是历史数据。</p>
<p><strong>act_hi_taskinst</strong> 历史流程实例任务表加了一条任务数据；</p>
<p><strong>act_hi_procinst</strong> 历史流程实例实例表加了一条流程实例相关信息的数据（包括开始时间，结束时间等等信息）；</p>
<p><strong>act_hi_identitylink</strong> 历史流程实例参数者的表加了一条数据；</p>
<p><strong>act_hi_actinst</strong> 历史活动节点表加了三条流程活动节点信息的数据（每个流程实例具体的执行活动节点的信息）；</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity-（三）创建流程引擎ProcessEngine</title>
    <url>/2020/03/08/Activity-%EF%BC%88%E4%B8%89%EF%BC%89%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8EProcessEngine/</url>
    <content><![CDATA[<h3 id="1、创建并设置Maven-项目"><a href="#1、创建并设置Maven-项目" class="headerlink" title="1、创建并设置Maven 项目"></a>1、创建并设置Maven 项目</h3><p>创建一个<code>$quickStartJavaProjectName</code>具有以下Maven依赖项的Java项目“ plush-activiti”（以后称为）： </p>
<p>文件：$ mvnProject / pom.xml </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- druid --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.12&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- mysql --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.30&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- lombok --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.16.12&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- logback --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;logback-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.8&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.8&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.7.22&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.activiti&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;activiti-engine&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.22.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;pluginManagement&gt;&lt;!-- <span class="function">lock down plugins versions to avoid using Maven <span class="title">defaults</span> <span class="params">(may be moved to parent pom)</span> --&gt;</span></span><br><span class="line"><span class="function">            &lt;plugins&gt;</span></span><br><span class="line"><span class="function">                &lt;plugin&gt;</span></span><br><span class="line"><span class="function">                    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span></span><br><span class="line"><span class="function">                    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span></span><br><span class="line"><span class="function">                    &lt;configuration&gt;</span></span><br><span class="line"><span class="function">                        &lt;source&gt;1.8&lt;/source&gt;</span></span><br><span class="line"><span class="function">                        &lt;target&gt;1.8&lt;/target&gt;</span></span><br><span class="line"><span class="function">                    &lt;/configuration&gt;</span></span><br><span class="line"><span class="function">                &lt;/plugin&gt;</span></span><br><span class="line"><span class="function">            &lt;/plugins&gt;</span></span><br><span class="line"><span class="function">        &lt;/pluginManagement&gt;</span></span><br><span class="line"><span class="function">    &lt;/build&gt;</span></span><br></pre></td></tr></table></figure>

<p>请注意以下依赖性：</p>
<ul>
<li>Activiti（org.activiti）– Activiti的BPM引擎</li>
<li>数据库（mysql）– mysql数据库</li>
<li>日志记录（org.slf4j）– Java的简单日志记录外观</li>
</ul>
<p>当引用构建目录时，假定您的maven项目的标准Maven构建路径： </p>
<table>
<thead>
<tr>
<th>路径</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>$mvnProject</code>/ src / main / java</td>
<td>Java源目录</td>
</tr>
<tr>
<td><code>$mvnProject</code>/ src / main / resources</td>
<td>资源目录</td>
</tr>
<tr>
<td><code>$mvnProject</code>/ src / test / java</td>
<td>Java测试目录</td>
</tr>
<tr>
<td><code>$mvnProject</code>/ src / test / resources</td>
<td>资源测试目录</td>
</tr>
</tbody></table>
<p>您应该能够构建空白项目。在继续之前，请确保总体状态为“ BUILD SUCCESS”。 </p>
<hr>
<p>命令：mvn编译 </p>
<p>基本路径：$ mvnProject </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO]                                                                         </span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Building $quickStartJavaProjectName 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ plush-activiti ---</span><br><span class="line">[WARNING] Using platform encoding (UTF-8 actually) to copy filtered resources, i.e. build is platform dependent!</span><br><span class="line">[INFO] Copying 0 resource</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.5.1:compile (default-compile) @ HelloProcess2 ---</span><br><span class="line">[INFO] Nothing to compile - all classes are up to date</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 0.592s</span><br><span class="line">[INFO] Finished at: Sun Nov 27 05:09:59 EST 2020</span><br><span class="line">[INFO] Final Memory: 10M&#x2F;309M</span><br><span class="line">[INFO] -----------------------------</span><br></pre></td></tr></table></figure>

<p>*<em>笔记： *</em></p>
<ul>
<li>您的输出可能看起来有所不同。最值得注意的是，maven可能需要检索项目依赖项。</li>
</ul>
<hr>
<h3 id="2、添加log4j-日志文件"><a href="#2、添加log4j-日志文件" class="headerlink" title="2、添加log4j 日志文件"></a>2、添加log4j 日志文件</h3><p><strong>两种配置内容（效果一致）：</strong></p>
<p>文件：$ mvnProject / src / main / resources / log4j.properties </p>
<p>第一种：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">log4j.rootLogger</span>=<span class="string">DEBUG, ACT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.ACT</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.ACT.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.ACT.layout.ConversionPattern</span>= <span class="string">%d&#123;hh:mm:ss,SSS&#125; [%t] %-5p %c %x - %m%n</span></span><br></pre></td></tr></table></figure>

<p>第二种：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml</span> <span class="string">version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;configuration</span> <span class="string">scan="true" scanPeriod="60 seconds"&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;appender</span> <span class="string">name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;</span></span><br><span class="line">        <span class="attr">&lt;encoder&gt;</span></span><br><span class="line">            <span class="meta">&lt;pattern&gt;%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125; [%thread] %-5level %logger - %msg%n&lt;/pattern&gt;</span></span><br><span class="line">        <span class="attr">&lt;/encoder&gt;</span></span><br><span class="line">    <span class="attr">&lt;/appender&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;!--&lt;appender</span> <span class="string">name="permission" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;file&gt;$&#123;catalina.home&#125;/logs/permission.log&lt;/file&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;rollingPolicy</span> <span class="string">class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;FileNamePattern&gt;$&#123;catalina.home&#125;/logs/permission.%d&#123;yyyy-MM-dd&#125;.log.gz&lt;/FileNamePattern&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/rollingPolicy&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;layout</span> <span class="string">class="ch.qos.logback.classic.PatternLayout"&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;pattern&gt;%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125; [%thread] %-5level %logger - %msg%n&lt;/pattern&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/layout&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/appender&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!----&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;logger</span> <span class="string">name="xxx" level="INFO"&gt;--&gt;</span></span><br><span class="line">    <span class="meta">&lt;!--&lt;appender-ref</span> <span class="string">ref="permission"/&gt;--&gt;</span></span><br><span class="line">    <span class="attr">&lt;!--&lt;/logger&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;!--</span> <span class="string">TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR --&gt;</span></span><br><span class="line">    <span class="meta">&lt;root</span> <span class="string">level="INFO"&gt;</span></span><br><span class="line">        <span class="meta">&lt;appender-ref</span> <span class="string">ref="STDOUT"/&gt;</span></span><br><span class="line">    <span class="attr">&lt;/root&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;/configuration&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3、创建流程引起对象"><a href="#3、创建流程引起对象" class="headerlink" title="3、创建流程引起对象"></a>3、创建流程引起对象</h3><p><code>用空白的main创建一个新的Java类。</code></p>
<hr>
<p><code>文件：$ mvnProject / src / main / java / com / webcode/ activiti_create.java</code></p>
<p><strong>3.1</strong> 添加到主入口点的是流程引擎的创建。如下所示添加到<strong>activiti_create</strong>.java中： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; &#123;</span><br><span class="line">    <span class="comment">// 创建流程引擎配置信息对象</span></span><br><span class="line">    ProcessEngineConfiguration pec = ProcessEngineConfiguration</span><br><span class="line">            .createStandaloneProcessEngineConfiguration();</span><br><span class="line">    <span class="comment">// 设置数据库的类型</span></span><br><span class="line">    pec.setDatabaseType(<span class="string">"mysql"</span>);</span><br><span class="line">    <span class="comment">// 设置创建数据库的方式</span></span><br><span class="line">    pec.setDatabaseSchemaUpdate(<span class="string">"true"</span>);</span><br><span class="line">    <span class="comment">// 设置数据库驱动</span></span><br><span class="line">    pec.setJdbcDriver(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">    <span class="comment">// 设置jdbcURL</span></span><br><span class="line">    pec.setJdbcUrl(<span class="string">"jdbc:mysql://49.234.197.103:3306/activiti-explorer?useUnicode=true&amp;characterEncoding=UTF-8"</span>);</span><br><span class="line">    <span class="comment">// 设置用户名</span></span><br><span class="line">    pec.setJdbcUsername(<span class="string">"root"</span>);</span><br><span class="line">    <span class="comment">// 设置密码</span></span><br><span class="line">    pec.setJdbcPassword(<span class="string">"wushaopei"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建流程引擎对象</span></span><br><span class="line">    ProcessEngine pe = pec.buildProcessEngine(); <span class="comment">// 调用访方法才会创建数据表</span></span><br><span class="line">    </span><br><span class="line">    String pName = pe.getName();</span><br><span class="line">    String ver = ProcessEngine.VERSION;</span><br><span class="line">    System.out.println(<span class="string">"ProcessEngine ["</span> + pName + <span class="string">"] Version: ["</span> + ver + <span class="string">"]"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用close方法时，才会删除</span></span><br><span class="line">    pe.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.2</strong> 也可以通过 引入<strong>Activiti</strong>配置文件<strong>activiti.cfg.xml</strong> 的方式来创建流程引擎实例；</p>
<p>创建<strong>activiti.cfg.xml</strong>配置：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml</span> <span class="string">version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;beans</span> <span class="string">xmlns="http://www.springframework.org/schema/beans"</span></span><br><span class="line">       <span class="attr">xmlns</span>:<span class="string">xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       <span class="attr">xsi</span>:<span class="string">schemaLocation="http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="meta">&lt;bean</span> <span class="string">id="processEngineConfiguration" class="org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcUrl" value="jdbc:mysql://49.234.197.103:3306/activiti-explorer" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcDriver" value="com.mysql.jdbc.Driver" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcUsername" value="root" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="jdbcPassword" value="wushaopei" /&gt;</span></span><br><span class="line">    <span class="meta">&lt;property</span> <span class="string">name="databaseSchemaUpdate" value="true" /&gt;</span></span><br><span class="line">  <span class="attr">&lt;/bean&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">&lt;/beans&gt;</span></span><br></pre></td></tr></table></figure>

<p>流程引擎创建实例代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用xml配置 简化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;&#123;</span><br><span class="line">    <span class="comment">// 引擎配置</span></span><br><span class="line">    ProcessEngineConfiguration pec=ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(<span class="string">"activiti.cfg.xml"</span>);</span><br><span class="line">    <span class="comment">// 获取流程引擎对象</span></span><br><span class="line">    ProcessEngine processEngine=pec.buildProcessEngine();</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">       String pName = processEngine.getName();</span><br><span class="line">       String ver = ProcessEngine.VERSION;</span><br><span class="line">       System.out.println(<span class="string">"ProcessEngine ["</span> + pName + <span class="string">"] Version: ["</span> + ver + <span class="string">"]"</span>);</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>使用xml配置会简化很多东西，而且在正规情况下的项目都是使用这种读取.XMl配置文件的方式。 </p>
<img src="http://photo.wushaopei.com/qiniu63.png" width="60%">

<p>之前生成Activiti25张表是使用Java类生成的，但是在实际的开发中是使用activiti.cfg.xml配置文件生成。</p>
<p>官方文档参考地址：<a href="http://activiti.org/userguide/index.html#configuration" target="_blank" rel="noopener">http://activiti.org/userguide/index.html#configuration</a> （英文看不懂可以用谷歌浏览器翻译功能）</p>
<h3 id="4、打包配置"><a href="#4、打包配置" class="headerlink" title="4、打包配置"></a>4、打包配置</h3><p><code>文件：$ mvnProject / pom.xml</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">...</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">...</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">...</span><br><span class="line">      &lt;!-- Maven Assembly Plugin --&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.4.1&lt;/version&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">          &lt;!-- get all project dependencies --&gt;</span><br><span class="line">          &lt;descriptorRefs&gt;</span><br><span class="line">            &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">          &lt;/descriptorRefs&gt;</span><br><span class="line">          &lt;!-- MainClass in mainfest make a executable jar --&gt;</span><br><span class="line">          &lt;archive&gt;</span><br><span class="line">            &lt;manifest&gt;</span><br><span class="line">              &lt;mainClass&gt;com.example.OnboardingRequest&lt;/mainClass&gt;</span><br><span class="line">            &lt;/manifest&gt;</span><br><span class="line">          &lt;/archive&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">            &lt;!-- bind to the packaging phase --&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">...</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">...</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>通过运行“ <strong>mvn package</strong>”来打包代码。 </p>
<p>启动 .jar 包命令：  </p>
<blockquote>
<p><strong>命令：java -jar target / ActivitiDeveloperQuickStart-0.0.1-SNAPSHOT-jar-with-dependencies.jar</strong></p>
<p><strong>-要么-</strong></p>
<p><strong>java -jar target / $ quickStartJavaProjectName-0.0.1-SNAPSHOT-jar-with-dependencies.jar</strong></p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
  </entry>
  <entry>
    <title>Activity（十三）流程变量</title>
    <url>/2020/04/15/Activity%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%E6%B5%81%E7%A8%8B%E5%8F%98%E9%87%8F/</url>
    <content><![CDATA[<h2 id="流程变量"><a href="#流程变量" class="headerlink" title="流程变量"></a>流程变量</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>​    在流程实例运行过程中，难免要记录或者保存一些数据，然后运行到某个节点的时候取数据查看， 或者是后面学到流程分支的时候 判断流程走向，都要用到一些数据存储。 </p>
<p>​    就有了一个新的概念流程变量，顾名思义就是流程中用来存储数据的变量。</p>
<p>​    Activiti中基本支持所有的基本数据类型作为流程变量，以及支持序列化对象， </p>
<p>​    所以也可以存一个对象；当然在开发的话，还是要建立一些业务表，来存储业务数据；简单的数据，可以存到到流程变量，比较方便.</p>
<p>​    根据一个流程定义可以启动很多流程实例，每个流程实例里的流程变量都是独立的互不影响。 </p>
<h3 id="分类："><a href="#分类：" class="headerlink" title="分类："></a>分类：</h3><pre><code>&gt;    全局变量、局部变量</code></pre><h3 id="流程变量示例"><a href="#流程变量示例" class="headerlink" title="流程变量示例"></a>流程变量示例</h3><h4 id="定义流程图，员工请假流程："><a href="#定义流程图，员工请假流程：" class="headerlink" title="定义流程图，员工请假流程："></a>定义流程图，员工请假流程：</h4><img src="http://photo.wushaopei.com/qiniu383.png" width="80%">

<p>流程图如上，三个任务节点名分别是 “员工提交请假申请” ,   “ 经理审批” , “ 部门审批” .</p>
<h4 id="部署流程定义-及-启动流程实例"><a href="#部署流程定义-及-启动流程实例" class="headerlink" title="部署流程定义 及 启动流程实例"></a>部署流程定义 及 启动流程实例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> activiti_create2.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年3月8日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">activiti_variable</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取默认的流程引擎实例 会自动读取activiti.cfg.xml文件 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义一个成员变量</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line">    </span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line">    </span><br><span class="line">    TaskService taskService;</span><br><span class="line">    </span><br><span class="line">    HistoryService historyService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取流程引擎</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">        repositoryService = processEngine.getRepositoryService();</span><br><span class="line">        runtimeService = processEngine.getRuntimeService();</span><br><span class="line">        taskService = processEngine.getTaskService();</span><br><span class="line">        historyService = processEngine.getHistoryService();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 部署流程定义</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="comment">// 获取部署对象</span></span><br><span class="line">	    Deployment deployment=processEngine.getRepositoryService() <span class="comment">// 部署Service</span></span><br><span class="line">	                 .createDeployment()  <span class="comment">// 创建部署</span></span><br><span class="line">	                 .addClasspathResource(<span class="string">"diagrams/MyProcess2.bpmn"</span>)  <span class="comment">// 加载资源文件</span></span><br><span class="line">	                 .deploy(); <span class="comment">// 部署</span></span><br><span class="line">	    System.out.println(<span class="string">"流程部署ID:"</span>+deployment.getId());</span><br><span class="line">	    System.out.println(<span class="string">"流程部署Name:"</span>+deployment.getName());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"myProcess"</span>);</span><br><span class="line">        String processInstanceId = processInstance.getId();</span><br><span class="line">        String activityId = processInstance.getActivityId();</span><br><span class="line">        String definitionId = processInstance.getProcessDefinitionId();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"流程实例ID："</span>+processInstanceId);</span><br><span class="line">        System.out.println(<span class="string">"正在活动的节点ID："</span>+activityId);</span><br><span class="line">        System.out.println(<span class="string">"流程定义ID："</span>+definitionId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <strong>运行start()方法</strong> ，启动流程实例，这样一个新的流程实例就产生并且开始运行了。 </p>
<p>这时候就可以看到 act_hi_actinst 表有数据了：</p>
<img src="http://photo.wushaopei.com/qiniu384.png" width="80%">

<p> 这时候到了 “员工请假提交”任务节点，这时候可以添加一些流程变量，比如请假日期，请假天数，</p>
<p> 请假原因，当然这里为了演示Activiti还支持序列化对象，</p>
<p> 这里再加一个请假的员工对象信息；</p>
<h4 id="创建一个员工实体对象Employee"><a href="#创建一个员工实体对象Employee" class="headerlink" title="创建一个员工实体对象Employee:"></a>创建一个员工实体对象Employee:</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> Employee.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月14日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getSerialversionuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialVersionUID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="流程变量-1"><a href="#流程变量-1" class="headerlink" title="流程变量"></a>流程变量</h4><p>这里需要说明一下，Activiti中的流程变量有两种，一种是全局，可以从第一个节点传递到最后一个节点的；另一种是局部变量，只在当前节点有效，无法被下一个节点接收到。</p>
<h4 id="全局变量-——-Variable"><a href="#全局变量-——-Variable" class="headerlink" title="全局变量  —— Variable"></a>全局变量  —— Variable</h4><h5 id="设置流程变量："><a href="#设置流程变量：" class="headerlink" title="设置流程变量："></a>设置流程变量：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置流程变量以及值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVariablesValues</span><span class="params">()</span></span>&#123;</span><br><span class="line">        TaskService taskService=processEngine.getTaskService(); <span class="comment">// 任务Service</span></span><br><span class="line">        String taskId=<span class="string">"80004"</span>; <span class="comment">// 任务id  对应表act_hi_actinst上的 TASK_ID</span></span><br><span class="line">        taskService.setVariableLocal(taskId, <span class="string">"days"</span>, <span class="number">2</span>); <span class="comment">// 存Integer类型</span></span><br><span class="line">        taskService.setVariable(taskId, <span class="string">"date"</span>, <span class="keyword">new</span> Date()); <span class="comment">// 存日期类型</span></span><br><span class="line">        taskService.setVariable(taskId, <span class="string">"reason"</span>, <span class="string">"发烧"</span>); <span class="comment">// 存字符串</span></span><br><span class="line">        Employee employee=<span class="keyword">new</span> Employee();</span><br><span class="line">        employee.setId(<span class="number">1</span>);</span><br><span class="line">        employee.setName(<span class="string">"李四"</span>);</span><br><span class="line">        taskService.setVariable(taskId, <span class="string">"employee"</span>, employee);  <span class="comment">// 存序列化对象</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="获取流程变量："><a href="#获取流程变量：" class="headerlink" title="获取流程变量："></a>获取流程变量：</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 获取流程变量数据</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Test</span><br><span class="line">public void getVariableValues()&#123;</span><br><span class="line">	TaskService taskService&#x3D;processEngine.getTaskService();&#x2F;&#x2F;获取任务</span><br><span class="line">	String taskId&#x3D;&quot;80004&quot;;</span><br><span class="line">	Integer day&#x3D;(Integer) taskService.getVariable(taskId, &quot;days&quot;);&#x2F;&#x2F;获取请假天数</span><br><span class="line">	Date date&#x3D;(Date) taskService.getVariable(taskId, &quot;date&quot;);&#x2F;&#x2F;请假日期</span><br><span class="line">	String reason&#x3D;(String) taskService.getVariable(taskId, &quot;reason&quot;);&#x2F;&#x2F;请假原因</span><br><span class="line">	</span><br><span class="line">	Employee employee&#x3D;(Employee) taskService.getVariable(taskId, &quot;employee&quot;);&#x2F;&#x2F;序列化对象</span><br><span class="line">	System.out.println(&quot;请假天数：&quot;+day);</span><br><span class="line">	System.out.println(&quot;请假日期：&quot;+date);</span><br><span class="line">	System.out.println(&quot;请假原因:&quot;+reason);</span><br><span class="line">	System.err.println(&quot;请假对象：&quot;+employee.getId()+&quot; —— &quot;+employee.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="查看获取的流程变量："><a href="#查看获取的流程变量：" class="headerlink" title="查看获取的流程变量："></a><strong>查看获取的流程变量：</strong></h5><img src="http://photo.wushaopei.com/qiniu385.png" width="80%">

<p>​    要设置流程变量，需要获取Service，这里的话，TaskService可以设置变量，RuntimeService也可以设置流程变量。</p>
<p>​    假如节点不是任务节点的时候，只能用RuntimeService。接口和方法和TaskService一样的；</p>
<p>​    这里设置了 请假日期，请假天数，请假理由，请假对象。当然这里set变量的时候 需要一个任务ID。</p>
<p>​    大家可以从任务表里去找；后面的变量都是key:value形式，这里的key当然也可以用中文，</p>
<p>设置的时候也可以一次性设置多个变量。</p>
<p>​    执行下这个方法，会对应的把数据库查询到对应的流程变量表中，当然那个对象序列的话，特殊点，存到了字节文件表里去了；</p>
<h5 id="使用-CompleteTask（）方法完成流程"><a href="#使用-CompleteTask（）方法完成流程" class="headerlink" title="使用 CompleteTask（）方法完成流程"></a>使用 CompleteTask（）方法完成流程</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	processEngine.getTaskService().complete(<span class="string">"102504"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行完成后， act_hi_actinst 表会再次发生改变：</p>
 <img src="http://photo.wushaopei.com/qiniu386.png" width="80%">

<p>这时候可以看到任务表 act_ru_task 中有这么一条数据，代表已完成的任务：</p>
 <img src="http://photo.wushaopei.com/qiniu387.png" width="80%">

<h5 id="经理审批-–-获取流程变量"><a href="#经理审批-–-获取流程变量" class="headerlink" title="经理审批 – 获取流程变量"></a>经理审批 – 获取流程变量</h5><p>这样就轮到部门审批的节点了。 现在可以获取 “员工请假提交” 任务节点设置的流程变量： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取流程变量数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getVariableValues2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	TaskService taskService=processEngine.getTaskService();<span class="comment">//获取任务</span></span><br><span class="line">	String taskId=<span class="string">"107502"</span>;</span><br><span class="line">	Integer day=(Integer) taskService.getVariable(taskId, <span class="string">"days"</span>);<span class="comment">//获取请假天数</span></span><br><span class="line">	Date date=(Date) taskService.getVariable(taskId, <span class="string">"date"</span>);<span class="comment">//请假日期</span></span><br><span class="line">	String reason=(String) taskService.getVariable(taskId, <span class="string">"reason"</span>);<span class="comment">//请假原因</span></span><br><span class="line">	</span><br><span class="line">	Employee employee=(Employee) taskService.getVariable(taskId, <span class="string">"employee"</span>);<span class="comment">//序列化对象</span></span><br><span class="line">	System.out.println(<span class="string">"请假天数："</span>+day);</span><br><span class="line">	System.out.println(<span class="string">"请假日期："</span>+date);</span><br><span class="line">	System.out.println(<span class="string">"请假原因:"</span>+reason);</span><br><span class="line">	System.err.println(<span class="string">"请假对象："</span>+employee.getId()+<span class="string">" —— "</span>+employee.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>获取流程结果：</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">19:48:41.555 [main] DEBUG org.activiti.engine.impl.interceptor.LogInterceptor - </span><br><span class="line"></span><br><span class="line">请假天数：null</span><br><span class="line">请假日期：Wed Apr 15 19:41:23 CST 2020</span><br><span class="line">请假原因:发烧</span><br><span class="line">请假对象：1 —— 李四</span><br></pre></td></tr></table></figure>

<p><strong>定论：</strong> 走到这里，我们可以知道，全局变量  <strong>Variable</strong> 可以被后面的节点给获取到。</p>
<h4 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h4><p>经过经理审批后，还有部门审批，我们在这里验证局部流程变量不能被下一个节点获取的问题</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置流程局部变量数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVariableLocalValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">	TaskService taskService=processEngine.getTaskService();<span class="comment">//获取任务</span></span><br><span class="line">	String taskId=<span class="string">"107502"</span>;<span class="comment">//更加任务id知道是哪个人物，设置流程变量。可以更加查看任务方法查看任务的id，可以到数据库直接看</span></span><br><span class="line">	<span class="comment">//下面设置任务的内容，比如请假流程，任务的第一节点也就是申请人要写请节哀的原因</span></span><br><span class="line">	taskService.setVariableLocal(taskId, <span class="string">"days"</span>, <span class="number">5</span>);<span class="comment">//请假天数</span></span><br><span class="line">	taskService.setVariable(taskId, <span class="string">"date"</span>, <span class="keyword">new</span> Date());<span class="comment">//请假日期</span></span><br><span class="line">	taskService.setVariable(taskId, <span class="string">"reason"</span>, <span class="string">"局部"</span>);<span class="comment">//请假原因</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在当前节点获取局部流程变量：</strong> </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">请假天数：<span class="number">5</span></span><br><span class="line">请假日期：Wed Apr <span class="number">15</span> <span class="number">20</span>:<span class="number">05</span>:<span class="number">56</span> CST <span class="number">2020</span></span><br><span class="line">请假原因:局部</span><br><span class="line">请假对象：<span class="number">1</span> —— zhangsan</span><br></pre></td></tr></table></figure>

<p>我们继续往下走，执行完成任务方法，注意修改任务id：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask2</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	processEngine.getTaskService().complete(<span class="string">"107502"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="获取局部流程变量："><a href="#获取局部流程变量：" class="headerlink" title="获取局部流程变量："></a>获取局部流程变量：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取流程变量数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getVariableLocalValues</span><span class="params">()</span></span>&#123;</span><br><span class="line">	TaskService taskService=processEngine.getTaskService();<span class="comment">//获取任务</span></span><br><span class="line">	String taskId=<span class="string">"97502"</span>;</span><br><span class="line">	Integer day=(Integer) taskService.getVariableLocal(taskId, <span class="string">"days"</span>);<span class="comment">//获取请假天数</span></span><br><span class="line">	Date date=(Date) taskService.getVariable(taskId, <span class="string">"date"</span>);<span class="comment">//请假日期</span></span><br><span class="line">	String reason=(String) taskService.getVariable(taskId, <span class="string">"reason"</span>);<span class="comment">//请假原因</span></span><br><span class="line">	</span><br><span class="line">	Employee employee=(Employee) taskService.getVariable(taskId, <span class="string">"employee"</span>);<span class="comment">//序列化对象</span></span><br><span class="line">	System.out.println(<span class="string">"请假天数："</span>+day);</span><br><span class="line">	System.out.println(<span class="string">"请假日期："</span>+date);</span><br><span class="line">	System.out.println(<span class="string">"请假原因:"</span>+reason);</span><br><span class="line">	System.err.println(<span class="string">"请假对象："</span>+employee.getId()+<span class="string">",,,"</span>+employee.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里查看一下相关的表数据变化：</p>
<p><strong>act_hi_actinst:</strong> </p>
 <img src="http://photo.wushaopei.com/qiniu388.png" width="90%">

<p>从图中我们可以看到，流程已经走到了部门审批的节点上</p>
<p>*<em>act_ru_task: *</em> </p>
 <img src="http://photo.wushaopei.com/qiniu389.png" width="90%">

<p> 从图中我们可以看到，任务节点走到了 task_ID为 112502 的部门审批上。</p>
<h5 id="局部变量的获取结果："><a href="#局部变量的获取结果：" class="headerlink" title="局部变量的获取结果："></a>局部变量的获取结果：</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">09</span>:<span class="number">59.430</span> [main] DEBUG org.activiti.engine.impl.interceptor.LogInterceptor - --- GetTaskVariableCmd finished --------------------------------------------------------</span><br><span class="line"><span class="number">20</span>:<span class="number">09</span>:<span class="number">59.430</span> [main] DEBUG org.activiti.engine.impl.interceptor.LogInterceptor - </span><br><span class="line"></span><br><span class="line">请假天数：<span class="literal">null</span></span><br><span class="line">请假日期：Wed Apr <span class="number">15</span> <span class="number">20</span>:<span class="number">05</span>:<span class="number">56</span> CST <span class="number">2020</span></span><br><span class="line">请假原因:局部</span><br><span class="line">请假对象：<span class="number">1</span>,,,zhangsan</span><br></pre></td></tr></table></figure>

<p>从结果可以得知，被声明为 局部流程变量，也就是 LocalVariable的 请假天数在部门经理审批节点被声明为 5 天，但是在部门审批节点没有获取到，而其他的全局流程变量都顺利获取到了。</p>
<h3 id="多流程变量的设置与获取"><a href="#多流程变量的设置与获取" class="headerlink" title="多流程变量的设置与获取"></a>多流程变量的设置与获取</h3><p>下面再介绍一种可以设置多个变量的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置多个流程变量数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVariableValue1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	TaskService taskService=processEngine.getTaskService();<span class="comment">//获取任务</span></span><br><span class="line">	String taskId=<span class="string">"107502"</span>;<span class="comment">//更加任务id知道是哪个人物，设置流程变量。可以更加查看任务方法查看任务的id，可以到数据库直接看</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//下面我们再测试一个额外的知识点，就是流程传输变量，这里我们再新建一个employee对象，对象有id 和name两个属性,还有就是序列化传输</span></span><br><span class="line">	Employee employee=<span class="keyword">new</span> Employee();</span><br><span class="line">	employee.setId(<span class="number">1</span>);</span><br><span class="line">	employee.setName(<span class="string">"zhangsan"</span>);</span><br><span class="line">	taskService.setVariable(taskId, <span class="string">"employee"</span>,employee);<span class="comment">//序列化对象</span></span><br><span class="line">	</span><br><span class="line">	Map&lt;String, Object&gt; variables=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">	variables.put(<span class="string">"days"</span>, <span class="number">3</span>);</span><br><span class="line">	variables.put(<span class="string">"date"</span>,<span class="keyword">new</span> Date());</span><br><span class="line">	variables.put(<span class="string">"reason"</span>, <span class="string">"faShao2"</span>);</span><br><span class="line">	variables.put(<span class="string">"employee"</span>, employee);</span><br><span class="line">	taskService.setVariables(taskId, variables);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取多个变量：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取多个流程变量数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getVariableValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">	TaskService taskService=processEngine.getTaskService();<span class="comment">//获取任务</span></span><br><span class="line">	String taskId=<span class="string">"97502"</span>;</span><br><span class="line">	</span><br><span class="line">	Map&lt;String, Object&gt; variables=taskService.getVariables(taskId);</span><br><span class="line">	Integer day=(Integer) variables.get(<span class="string">"days"</span>);<span class="comment">//获取请假天数</span></span><br><span class="line">	Date date=(Date) variables.get(<span class="string">"date"</span>);<span class="comment">//请假日期</span></span><br><span class="line">	String reason=(String) variables.get(<span class="string">"reason"</span>);<span class="comment">//请假原因</span></span><br><span class="line">	</span><br><span class="line">	Employee employee=(Employee) variables.get(<span class="string">"employee"</span>);<span class="comment">//序列化对象</span></span><br><span class="line">	System.out.println(<span class="string">"请假天数："</span>+day);</span><br><span class="line">	System.out.println(<span class="string">"请假日期："</span>+date);</span><br><span class="line">	System.out.println(<span class="string">"请假原因:"</span>+reason);</span><br><span class="line">	System.err.println(<span class="string">"请假对象："</span>+employee.getId()+<span class="string">",,,"</span>+employee.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Activity</category>
      </categories>
      <tags>
        <tag>流程变量</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL（九）用正则表达式进行搜索</title>
    <url>/2020/05/15/MySQL%EF%BC%88%E4%B9%9D%EF%BC%89%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BF%9B%E8%A1%8C%E6%90%9C%E7%B4%A2/</url>
    <content><![CDATA[<h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><p>要点： SELECT 语句中 使用 where子句 ，结合 OR 、[]   等操作符、表达式进行指定过滤条件</p>
<p><strong>工具表：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;NewTable&#96; (</span><br><span class="line">&#96;id&#96;  int(11) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">&#96;name&#96;  varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;sex&#96;  char(1) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT &#39;女&#39; ,</span><br><span class="line">&#96;borndate&#96;  datetime NULL DEFAULT &#39;1987-01-01 00:00:00&#39; ,</span><br><span class="line">&#96;phone&#96;  varchar(11) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,</span><br><span class="line">&#96;photo&#96;  blob NULL ,</span><br><span class="line">&#96;boyfriend_id&#96;  int(11) NULL DEFAULT NULL ,</span><br><span class="line">PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">)</span><br><span class="line">ENGINE&#x3D;InnoDB</span><br><span class="line">DEFAULT CHARACTER SET&#x3D;utf8 COLLATE&#x3D;utf8_general_ci</span><br><span class="line">AUTO_INCREMENT&#x3D;12</span><br><span class="line">ROW_FORMAT&#x3D;DYNAMIC</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<h2 id="正则表达式介绍"><a href="#正则表达式介绍" class="headerlink" title="正则表达式介绍"></a>正则表达式介绍</h2><blockquote>
<p><strong>作用：</strong></p>
<p>正则表达式是用来匹配文本的特殊的串（字符集合）。</p>
<p><strong>举例：</strong></p>
<ul>
<li>如果你想从一个文本文件中提取电话号码，可以使用正则表达式。</li>
<li>如果你需要查找名字中间有数字的所有文件，可以使用一个正则表达式。</li>
<li>等等</li>
</ul>
</blockquote>
<hr>
<h2 id="使用MySQL正则表达式"><a href="#使用MySQL正则表达式" class="headerlink" title="使用MySQL正则表达式"></a>使用MySQL正则表达式</h2><blockquote>
<p>MySQL用WHERE子句对正则表达式提供了初步的支持，允许你指定正则表达式，过滤SELECT检索出的数据。</p>
</blockquote>
<h3 id="基本字符匹配"><a href="#基本字符匹配" class="headerlink" title="基本字符匹配"></a>基本字符匹配</h3><blockquote>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where phone REGEXP &#39;18209179517&#39;;</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| id | name   | sex | phone       | borndate            |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| 10 | 王语嫣 | 女  | 18209179517 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">1 row in set</span><br></pre></td></tr></table></figure>

<p>​    除关键字LIKE被REGEXP替代外，这条语句看上去非常像使用LIKE的语句。</p>
<p><strong>分析：</strong> </p>
<p>​    它告诉MySQL：REGEXP后所跟的东西作为正则表达式（与文字正文18209179517匹配的一个正则表达式）处理。</p>
</blockquote>
<p><strong>. 通配符：</strong></p>
<blockquote>
<p>. 是正则表达式语言中一个特殊的字符。它表示匹配任意一个字符</p>
</blockquote>
<h3 id="进行OR匹配"><a href="#进行OR匹配" class="headerlink" title="进行OR匹配"></a>进行OR匹配</h3><blockquote>
<p> 为搜索两个串之一（或者为这个串，或者为另一个串），使用| 。</p>
<p> <strong>示例</strong>： </p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where phone REGEXP &#39;18209179517|18209876529&#39;;</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| id | name   | sex | phone       | borndate            |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| 10 | 王语嫣 | 女  | 18209179517 | 1992-02-03 00:00:00 |</span><br><span class="line">| 11 | 夏雪   | 女  | 18209876529 | 1993-02-03 00:00:00 |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>

<p> 语句中使用了正则表达式 18209179517|18209876529。|为正则表达式的OR操作符。它表示匹配其中之一，因此18209179517 和18209876529都匹配并返回。</p>
</blockquote>
<h3 id="匹配几个字符之一"><a href="#匹配几个字符之一" class="headerlink" title="匹配几个字符之一"></a>匹配几个字符之一</h3><blockquote>
<p>匹配任何单一字符。 这里可以通过指定一组用[和]括起来的字符来完成 。</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; mysql&gt; select id , name , sex ,phone,borndate from beauty where name REGEXP &#39;[12]赵敏&#39; ;</span><br><span class="line">+----+-------+-----+-------------+---------------------+</span><br><span class="line">| id | name  | sex | phone       | borndate            |</span><br><span class="line">+----+-------+-----+-------------+---------------------+</span><br><span class="line">| 12 | 1赵敏 | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">| 13 | 2赵敏 | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+-------+-----+-------------+---------------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>

<p>这里，使用了正则表达式[12]赵敏。[12]定义一组字符，它的意思是匹配1或2或3，因此，1赵敏和2赵敏都匹配且返回（没有3 ton）</p>
<p><strong>分析：</strong></p>
<p>[]是另一种形式的OR语句。</p>
<p><strong>理解：</strong></p>
<p>正则表达式 [12]赵敏 为 [1|2]赵敏 的缩写，也可以使用后者。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name REGEXP &#39;[1|</span><br><span class="line">2]赵敏&#39; ;</span><br><span class="line">+----+-------+-----+-------------+---------------------+</span><br><span class="line">| id | name  | sex | phone       | borndate            |</span><br><span class="line">+----+-------+-----+-------------+---------------------+</span><br><span class="line">| 12 | 1赵敏 | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">| 13 | 2赵敏 | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+-------+-----+-------------+---------------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="匹配范围"><a href="#匹配范围" class="headerlink" title="匹配范围"></a>匹配范围</h3><blockquote>
<p>集合可用来定义要匹配的一个或多个字符。 </p>
<p>例如，下面的集合将匹配数字0到9：</p>
<p>​    [0123456789]</p>
<p>​    为简化这种类型的集合，可使用-来定义一个范围。下面的式子功能上等同于上述数字列表：</p>
<p>​    [0-9]    </p>
<p>​    范围不限于完整的集合，[1-3]和[6-9]也是合法的范围。此外，范围不一定只是数值的，<code>[a-z]</code>匹配任意字母字符。</p>
<p><strong>示例：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name REGEXP &#39;[1-3]赵敏&#39;;</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| id | name   | sex | phone       | borndate            |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| 12 | 1赵敏  | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">| 13 | 2赵敏  | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">| 14 | .3赵敏 | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">3 rows in set</span><br></pre></td></tr></table></figure>

<p>这里使用正则表达式[1-3]赵敏。[1-3]定义了一个范围，这个表达式意思是匹配1到3，因此返回3个匹配行。由于3 赵敏匹配，所以返回.3赵敏。</p>
<p><strong>说明：</strong> 为IN操作符完成与OR相同的功能 ，从使用上，IN 要更便捷。</p>
</blockquote>
<h3 id="匹配特殊字符-转义字符的使用："><a href="#匹配特殊字符-转义字符的使用：" class="headerlink" title="匹配特殊字符 (转义字符的使用：\\)"></a>匹配特殊字符 (转义字符的使用：<code>\\</code>)</h3><blockquote>
<p>正则表达式语言由具有特定含义的特殊字符构成。 包括：.、[]、|和-等，还有其他一些字符。</p>
<p>*<em>. 字符 *</em></p>
<p><strong>错误示例：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name REGEXP &#39;.</span><br><span class="line">&#39; ;</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">| id | name       | sex | phone       | borndate            |</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">|  1 | 柳岩       | 女  | 18209876571 | 1988-02-03 00:00:00 |</span><br><span class="line">|  2 | 苍老师     | 女  | 18219876572 | 1987-12-30 00:00:00 |</span><br><span class="line">|  3 | Angelababy | 女  | 18209876563 | 1989-02-03 00:00:00 |</span><br><span class="line">|  4 | 热巴       | 女  | 18209876574 | 1993-02-03 00:00:00 |</span><br><span class="line">|  5 | 周冬雨     | 女  | 18209179575 | 1992-02-03 00:00:00 |</span><br><span class="line">|  6 | 周芷若     | 女  | 18209876576 | 1988-02-03 00:00:00 |</span><br><span class="line">|  7 | 岳灵珊     | 女  | 18219876577 | 1987-12-30 00:00:00 |</span><br><span class="line">|  8 | 小昭       | 女  | 18209876568 | 1989-02-03 00:00:00 |</span><br><span class="line">|  9 | 灵儿       | 女  | 18209876579 | 1993-02-03 00:00:00 |</span><br><span class="line">| 10 | 王语嫣     | 女  | 18209179517 | 1992-02-03 00:00:00 |</span><br><span class="line">| 11 | 夏雪       | 女  | 18209876529 | 1993-02-03 00:00:00 |</span><br><span class="line">| 12 | 1赵敏      | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">| 13 | 2赵敏      | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">| 14 | .3赵敏     | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+------------+-----+-------------+---------------------+</span><br><span class="line">14 rows in set</span><br></pre></td></tr></table></figure>

<p>这并不是期望的输出，.匹配任意字符，因此每个行都被检索出来。</p>
<p><strong>解决方法：</strong></p>
<p>为了匹配特殊字符，必须用\为前导。\-表示查找-，\.表示查找 .。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name REGEXP &#39;\\</span><br><span class="line">.&#39; ;</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| id | name   | sex | phone       | borndate            |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| 14 | .3赵敏 | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">1 row in set</span><br></pre></td></tr></table></figure>

<p>这才是期望的输出。\.匹配.，所以只检索出一行。这种处理就是所谓的转义（escaping），正则表达式内具有特殊意义的所有字符都必须以这种方式转义。这包括.、|、[]以及迄今为止使用过的其他特殊字符。 </p>
<p><strong>转义字符配置表：</strong></p>
<table>
<thead>
<tr>
<th>元字符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>\ \ f</td>
<td>换页</td>
</tr>
<tr>
<td>\ \ n</td>
<td>换行</td>
</tr>
<tr>
<td>\ \ r</td>
<td>回车</td>
</tr>
<tr>
<td>\ \ t</td>
<td>制表</td>
</tr>
<tr>
<td>\ \ v</td>
<td>纵向制表</td>
</tr>
</tbody></table>
</blockquote>
<hr>
<h3 id="匹配字符类"><a href="#匹配字符类" class="headerlink" title="匹配字符类"></a>匹配字符类</h3><blockquote>
<p>存在找出你自己经常使用的数字、所有字母字符或所有数字字母字符等的匹配。</p>
<table>
<thead>
<tr>
<th>类</th>
<th>说 明</th>
</tr>
</thead>
<tbody><tr>
<td>[:alnum:]</td>
<td>任意字母和数字（同[a-zA-Z0-9]）</td>
</tr>
<tr>
<td>[:alpha:]</td>
<td>任意字符（同[a-zA-Z]）</td>
</tr>
<tr>
<td>[:blank:]</td>
<td>空格和制表（同[\t]）</td>
</tr>
<tr>
<td>[:cntrl:]</td>
<td>ASCII控制字符（ASCII 0到31和127）</td>
</tr>
<tr>
<td>[:digit:]</td>
<td>任意数字（同[0-9]）</td>
</tr>
<tr>
<td>[:graph:]</td>
<td>与[:print:]相同，但不包括空格</td>
</tr>
<tr>
<td>[:lower:]</td>
<td>任意小写字母（同[a-z]）</td>
</tr>
<tr>
<td>[:print:]</td>
<td>任意可打印字符</td>
</tr>
<tr>
<td>[:punct:]</td>
<td>既不在[:alnum:]又不在[:cntrl:]中的任意字符</td>
</tr>
<tr>
<td>[:space:]</td>
<td>包括空格在内的任意空白字符（同[\f\n\r\t\v]）</td>
</tr>
<tr>
<td>[:upper:]</td>
<td>任意大写字母（同[A-Z]）</td>
</tr>
<tr>
<td>[:xdigit:]</td>
<td>任意十六进制数字（同[a-fA-F0-9]）</td>
</tr>
</tbody></table>
</blockquote>
<hr>
<h3 id="匹配多个实例"><a href="#匹配多个实例" class="headerlink" title="匹配多个实例"></a>匹配多个实例</h3><blockquote>
<p>有时需要对匹配的数目进行更强的控制。</p>
<p><strong>例子：</strong> </p>
<p>​    你可能需要寻找所有的数，不管数中包含多少数字，或者你可能想寻找一个单词并且还能够适应一个尾随的s（如果存在），等等。    </p>
<p><strong>正则表达式重复元字符表</strong></p>
<table>
<thead>
<tr>
<th>元 字 符</th>
<th>说 明</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>0个或多个匹配</td>
</tr>
<tr>
<td>+</td>
<td>1个或多个匹配（等于{1,}）</td>
</tr>
<tr>
<td>？</td>
<td>0个或1个匹配（等于{0,1}）</td>
</tr>
<tr>
<td>{n}</td>
<td>指定数目的匹配</td>
</tr>
<tr>
<td>{n,}</td>
<td>不少于指定数目的匹配</td>
</tr>
<tr>
<td>{n,m}</td>
<td>匹配数目的范围（m不超过255)</td>
</tr>
</tbody></table>
<p><strong>示例1：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name , sex ,phone,borndate from beauty where name REGEXP &#39;\\.([0-9]赵敏)&#39;;</span><br><span class="line"></span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| id | name   | sex | phone       | borndate            |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">| 14 | .3赵敏 | 女  | 18209179537 | 1992-02-03 00:00:00 |</span><br><span class="line">+----+--------+-----+-------------+---------------------+</span><br><span class="line">1 row in set</span><br></pre></td></tr></table></figure>

<p>正则表达式 <code>\\.([0-9]赵敏)</code>拆解； 。<code>\\(匹配)</code>，<code>[0-9]</code>匹配任意数字（这个例子中为3），笔者在参考 MySQL 必知必会时配置的 <code>？\\</code> 没有生效，具体原因不明。后面再找时间搞清楚。</p>
<p><font color='red' >MARK </font></p>
<p><strong>示例2:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name  from beauty where name REGEXP &#39;[[:digit:]]&#123;4&#125;&#39;;</span><br><span class="line">+----+-------------+</span><br><span class="line">| id | name        |</span><br><span class="line">+----+-------------+</span><br><span class="line">| 10 | 王语嫣 1000 |</span><br><span class="line">| 11 |  夏雪 2000  |</span><br><span class="line">+----+-------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>

<p>参考前面给出的参数配置表，[:digit:]匹配任意数字，因而它为数字的一个集合。{4}确切地要求它前面的字符（任意数字）出现4次，所以 [[:digit:]]{4}匹配连在一起的任意4位数字</p>
<p><strong>[[:digit:]]{4}的另一种表现形式</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name  from beauty where name REGEXP &#39;[0-9][0-9][0-9][0-9]</span><br><span class="line">&#39;;</span><br><span class="line">+----+-------------+</span><br><span class="line">| id | name        |</span><br><span class="line">+----+-------------+</span><br><span class="line">| 10 | 王语嫣 1000 |</span><br><span class="line">| 11 |  夏雪 2000  |</span><br><span class="line">+----+-------------+</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
<h3 id="定位符"><a href="#定位符" class="headerlink" title="定位符"></a>定位符</h3><blockquote>
<p><strong>说明：</strong> 匹配文本。</p>
<p><strong>匹配文本的定位符配置列表：</strong></p>
<p>定位元字符 </p>
<table>
<thead>
<tr>
<th>元 字 符</th>
<th>说 明</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>文本的开始</td>
</tr>
<tr>
<td>$</td>
<td>文本的结尾</td>
</tr>
<tr>
<td>[[:&lt;:]]</td>
<td>词的开始</td>
</tr>
<tr>
<td>[[:&gt;:]]</td>
<td>词的结尾</td>
</tr>
</tbody></table>
<p><strong>示例：</strong></p>
<p>找出以一个数（包括以小数点开始的数）开始的所有人名。使用 ^ 定位符表示起始位。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name  from beauty where name REGEXP &#39;^[0-9\\.]&#39;;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  8 | 1 sticks |</span><br><span class="line">|  9 | 2 stick  |</span><br><span class="line">| 12 | 1赵敏    |</span><br><span class="line">| 13 | 2赵敏2   |</span><br><span class="line">| 14 | .3赵敏   |</span><br><span class="line">+----+----------+</span><br><span class="line">5 rows in set</span><br></pre></td></tr></table></figure>

<p>^匹配串的开始。因此，^[0-9\.]只在.或任意数字为串中第一个字符时才匹配它们。没有^，则还要多检索出2个别的行（那些中间有数字的行）。<strong>其结果如下：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select id , name  from beauty where name REGEXP &#39;[0-9\\.]&#39;;</span><br><span class="line">+----+-------------+</span><br><span class="line">| id | name        |</span><br><span class="line">+----+-------------+</span><br><span class="line">|  8 | 1 sticks    |</span><br><span class="line">|  9 | 2 stick     |</span><br><span class="line">| 10 | 王语嫣 1000 |</span><br><span class="line">| 11 |  夏雪 2000  |</span><br><span class="line">| 12 | 1赵敏       |</span><br><span class="line">| 13 | 2赵敏2      |</span><br><span class="line">| 14 | .3赵敏      |</span><br><span class="line">+----+-------------+</span><br><span class="line">7 rows in set</span><br></pre></td></tr></table></figure>

<p>^的双重用途 ^有两种用法。在集合中（用[和]定义），用它来否定该集合，否则，用来指串的开始处。</p>
</blockquote>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h2><p>本节主要学习内容为:</p>
<ul>
<li>如何在MySQL的SELECT语句中通过REGEXP关键字使用它们</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>MySQL必知必会</category>
      </categories>
      <tags>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>OSGI(二) Apache Felix 介绍 与 案例实现</title>
    <url>/2020/04/13/OSGI%20(%E4%BA%8C)%20Apache%20Felix%20%E4%BB%8B%E7%BB%8D%20%E4%B8%8E%20%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="Felix-项目历史"><a href="#Felix-项目历史" class="headerlink" title="Felix 项目历史"></a>Felix 项目历史</h2><p>作为<a href="http://apache.org" target="_blank" rel="noopener">Apache</a>旗下的其中一个项目，<a href="http://felix.apache.org" target="_blank" rel="noopener">Felix</a>在2006年就拥有了自己的网站。不过一开始似乎进展并不快，直到2007年的七月，才发布了自己的1.0.0版本，其后他们发布了很多与Felix框架相关的<a href="http://maven.apache.org" target="_blank" rel="noopener">Maven</a>插件，到了2008年初，开始对纲要标准（Compendium Specification）进行部分实现。此后Felix项目的发展壮大非常的迅速，那时候的OSGi标准也日趋稳定和完善。时至今日，Felix项目不仅包含了一个OSGi R4(到今天为止，准确的版本号是4.2)服务平台标准的实现，在此之外还包含了很多OSGi相关的技术和功能（非标准），他们能帮助OSGi框架更好的发挥作用. </p>
<h2 id="Felix-项目概述"><a href="#Felix-项目概述" class="headerlink" title="Felix 项目概述"></a>Felix 项目概述</h2><p>整个Felix项目被分解为了若干个子项目，我们可以从SVN上将Felix检出： </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">svn checkout http://svn.apache.org/repos/asf/felix/trunk felix-trunk</span><br></pre></td></tr></table></figure>

<p>完成了上述操作后，我们可以看到有整整57个文件夹，里面除了examples（示例程序）、src（无关紧要的内容，一些图片和css）、commons（项目需要用到的公共包，比如beanutils），还有pom（里面是总体的pom文件）这4个文件夹外，基本都是与Felix项目直接相关的代码，里面除了一些已经发布的，还有非常多的未发布项目。 </p>
<h3 id="Felix对标准的实现情况"><a href="#Felix对标准的实现情况" class="headerlink" title="Felix对标准的实现情况"></a>Felix对标准的实现情况</h3><p>下面我们从一个总体的角度来看看Felix对标准的那些内容进行了实现： </p>
<h4 id="核心标准-Core-Specification"><a href="#核心标准-Core-Specification" class="headerlink" title="核心标准(Core Specification)"></a>核心标准(Core Specification)</h4><p>Felix对核心标准的实现都是通过了[OSGi联盟][OSGi Alliance]认证的。 </p>
<table>
<thead>
<tr>
<th>标准名称</th>
<th>版本号</th>
<th>Felix中的子项目</th>
<th>项目版本</th>
</tr>
</thead>
<tbody><tr>
<td>Framework</td>
<td>R4.2</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Package Admin</td>
<td>1.2 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Start Level</td>
<td>1.1 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Permission Admin</td>
<td>R4.2</td>
<td>Framework Security</td>
<td>1.4.0</td>
</tr>
<tr>
<td>Conditional Permission Admin</td>
<td>R4.2</td>
<td>Framework Security</td>
<td>1.4.0</td>
</tr>
<tr>
<td>URL Handlers</td>
<td>1.0 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
</tr>
<tr>
<td>Service Hooks</td>
<td>1.0 (R4.2)</td>
<td>Framework</td>
<td></td>
</tr>
</tbody></table>
<h4 id="纲要标准-Compendium-Specification"><a href="#纲要标准-Compendium-Specification" class="headerlink" title="纲要标准(Compendium Specification)"></a>纲要标准(Compendium Specification)</h4><p>在这里我们只把实现并且已经发布过的子项目列举出来： </p>
<table>
<thead>
<tr>
<th>标准名称</th>
<th>版本号</th>
<th>Felix中的子项目</th>
<th>项目版本</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Log Service</td>
<td>1.3 (R4.2)</td>
<td>Log</td>
<td>1.0.0</td>
<td></td>
</tr>
<tr>
<td>Http Service</td>
<td>1.2 (R4.2)</td>
<td>Http Service Projects</td>
<td>2.0.4</td>
<td></td>
</tr>
<tr>
<td>Configuration Admin</td>
<td>1.3 (R4.2)</td>
<td>Configuration Admin</td>
<td>1.2.8</td>
<td>参考实现</td>
</tr>
<tr>
<td>Metatype</td>
<td>1.1 (R4.2)</td>
<td>Metatype</td>
<td>1.0.4</td>
<td>—</td>
</tr>
<tr>
<td>Preferences</td>
<td>1.1 (R4.2)</td>
<td>Preferences</td>
<td>1.0.4</td>
<td>—</td>
</tr>
<tr>
<td>UPnP Device</td>
<td>1.1 (R4.2)</td>
<td>UPnP Base Driver</td>
<td>0.8.0</td>
<td>—</td>
</tr>
<tr>
<td>Declarative Services</td>
<td>1.1 (R4.2)</td>
<td>SCR</td>
<td>1.6.0</td>
<td>通过了R4.2相应的服从测试</td>
</tr>
<tr>
<td>Event Admin</td>
<td>1.2 (R4.2)</td>
<td>Event Admin</td>
<td>1.2.8</td>
<td>同上</td>
</tr>
<tr>
<td>Blueprint</td>
<td>1.0 (R4.2)</td>
<td></td>
<td></td>
<td>由Apache Aries实现</td>
</tr>
<tr>
<td>Tracker</td>
<td>1.4 (R4.2)</td>
<td>Framework</td>
<td>3.0.6</td>
<td>OSG</td>
</tr>
</tbody></table>
<h3 id="标准以外的相关技术实现"><a href="#标准以外的相关技术实现" class="headerlink" title="标准以外的相关技术实现"></a>标准以外的相关技术实现</h3><h4 id="用于简化OSGi开发的子项目"><a href="#用于简化OSGi开发的子项目" class="headerlink" title="用于简化OSGi开发的子项目"></a>用于简化OSGi开发的子项目</h4><ul>
<li><p><a href="http://felix.apache.org/site/apache-felix-dependency-manager.html" target="_blank" rel="noopener">Dependency Manager</a> </p>
<p>在OSGi基于服务的体系结构中，应用是由一个个组件建立起来的，每个组件分别依赖和发布了一些服务，这样这些服务就形成了一个网络。但是由于其动态性，这个网络的结构总是在不停的变化，所以开发者总是不得不考虑和应对这样的变化，OSGi本身提供了服务的listener和tracker这两个机制来捕捉和监控服务的状态变化，但是对于开发者来说这个太底层了。而这个工具提供给我们了一套JavaAPI来声明式的定义和管理这些依赖。</p>
</li>
<li><p><a href="http://felix.apache.org/site/apache-felix-ipojo.html" target="_blank" rel="noopener">iPOJO</a></p>
<p>这是一个相当大的项目，从这个项目的主页上就可以看出Felix项目在这个子项目上花了很多精力，可以说是在OSGi基础上的一个革新。</p>
<p>iPOJO是一个用于简化OSGi开发的服务组件运行时，它本身支持了所有OSGi的动态性。它基于<a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object" target="_blank" rel="noopener">POJO</a>的概念简化了程序逻辑的开发，任何非功能性的对象属性只在运行的时候被注入进来。它主要有以下几个特点：</p>
<ul>
<li>开发组件的时候只需要定义POJO即可，没有多余的工作</li>
<li>组件模型可扩展，所以很容易根据你的需要来调整</li>
<li>标准的组件模型会管理服务的提供与依赖</li>
<li>iPOJO管理组件实例的生命周期和OSGi环境的动态性，这是前所未有的</li>
<li>为了创建高动态性的应用，iPOJO提供了一个强大的组装系统</li>
<li>iPOJO支持标注、XML和JavaAPI来定义组件</li>
</ul>
<p>如果有机会，我会在一篇单独的文档中详细的介绍iPOJO。</p>
</li>
</ul>
<h4 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h4><ul>
<li><a href="http://felix.apache.org/site/apache-felix-gogo.html" target="_blank" rel="noopener">Gogo</a> - 用来和OSGi交互的较为常用的shell，除了基本的框架命令，其中还包含grep，cat，echo这类指令，并且可以自定义宏命令。</li>
<li><a href="http://felix.apache.org/site/apache-felix-shell.html" target="_blank" rel="noopener">Shell</a> - 这个子项目只提供了单纯的shell服务API，而没有提供用户界面。</li>
<li><a href="http://felix.apache.org/site/apache-felix-shell-tui.html" target="_blank" rel="noopener">Shell TUI</a> - Apache Felix Shell的文字界面，相比gogo来说更为简单，但是不怎么常用，他的使用依赖于shell bundle。</li>
<li><a href="http://felix.apache.org/site/apache-felix-remote-shell.html" target="_blank" rel="noopener">Remote Shell</a> - Apache Felix Shell的远程文字界面，我们通过这个工具可以在其他终端上远程操作Felix。</li>
</ul>
<h4 id="Maven插件"><a href="#Maven插件" class="headerlink" title="Maven插件"></a>Maven插件</h4><ul>
<li><p><a href="http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html" target="_blank" rel="noopener">Maven Bundle Plugin</a></p>
<p>这个插件用于简化Bundle的构建，可以将一个bundle看做以个Maven工程，其中还包括自动化对OSGi Bundle仓库的管理。它的前身曾经是OBR Plugin和OSGi Plugin这两个插件。</p>
</li>
<li><p><a href="http://felix.apache.org/site/apache-felix-maven-scr-plugin.html" target="_blank" rel="noopener">Maven SCR Plugin</a></p>
<p>这个插件的主要作用是帮助用户生成OSGi中使用Declarative Services, Config Admin和Metatype services这三个功能所必要的信息，这样就简化了用户的操作。</p>
</li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li><a href="http://felix.apache.org/site/apache-felix-file-install.html" target="_blank" rel="noopener">File Install</a> - 用来管理bundle部署及其目录的一个简单的代理。</li>
<li><a href="http://felix.apache.org/site/apache-felix-osgi-bundle-repository.html" target="_blank" rel="noopener">OSGi Bundle Repository</a> - 帮助我们更好的发现和部署bundle和bundle的依赖。</li>
<li><a href="http://felix.apache.org/site/apache-felix-web-console.html" target="_blank" rel="noopener">Web Console</a> - 基于web的Felix控制台。</li>
</ul>
<h2 id="Felix-基本运行环境配置"><a href="#Felix-基本运行环境配置" class="headerlink" title="Felix 基本运行环境配置"></a>Felix 基本运行环境配置</h2><h3 id="Felix执行环境的下载"><a href="#Felix执行环境的下载" class="headerlink" title="Felix执行环境的下载"></a>Felix执行环境的下载</h3><p>进入下载页面，选择Felix Framework Distribution的下载项：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//felix.apache.org/downloads.cgi?Preferred=https%3A%2F%2Fmirror.bit.edu.cn%2Fapache%2F</span></span><br></pre></td></tr></table></figure>

<p>如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu305.png" width="60%">

<h3 id="启动Felix"><a href="#启动Felix" class="headerlink" title="启动Felix"></a>启动Felix</h3><p>将下载好的包解压，从命令行进入这个文件夹的根目录，执行如下命令，进入到Felix的命令行：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar bin/felix.jar</span><br></pre></td></tr></table></figure>

<p>如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu306.png" width="60%">

<p>这样我们就进入了Felix的执行环境，可以通过Shell与框架进行一些交互 </p>
<h3 id="一些简单的命令"><a href="#一些简单的命令" class="headerlink" title="一些简单的命令"></a>一些简单的命令</h3><p>在这个命令行下输入help我们就可以看到大部分的指令，由于数量不少，不在这里一一列出。为了避免命令名字的冲突，这些命令都有自己的名字空间，现有的名字空间有三种：</p>
<ul>
<li>felix - 关于felix框架的核心命令，比如列出所有bundle，安装/卸载bundle等等</li>
<li>gogo - 包含grep，cat，echo这类的指令，并且gogo是个Felix的子项目，他是参照<a href="http://felix.apache.org/site/rfc-147-overview.html" target="_blank" rel="noopener">RFC 147</a>来实现的，这个标准定义了OSGi环境的shell应该是怎么样的。</li>
<li>obr - 关于OSGi Bundle Repository功能的指令</li>
</ul>
<p>如果对任何的命令有所疑问，用help+空格+“命令名称”来查看说明即可。</p>
<h2 id="Felix环境配置"><a href="#Felix环境配置" class="headerlink" title="Felix环境配置"></a>Felix环境配置</h2><p>下载felix的最新版本，并且将最新的felix解压到本地路径。</p>
<p>新建一个Java工程</p>
<img src="http://photo.wushaopei.com/qiniu331.png" width="60%">

<p>工程名为felix，这个工程名可以随意设置 </p>
<img src="http://photo.wushaopei.com/qiniu332.png" width="60%">

<p>选择下一步，修改输出路径 </p>
<img src="http://photo.wushaopei.com/qiniu333.png" width="60%">

<p>复制解压后的felix目录中的内容到工程中。完成后的目录如下所示： </p>
<img src="http://photo.wushaopei.com/qiniu335.png" width="60%">

<p>将felix.jar添加到工程的目录中，选择Build Path-&gt;Add to Build Path ：</p>
<img src="http://photo.wushaopei.com/qiniu336.png" width="60%">

<p>然后配置Run Configuration </p>
<img src="http://photo.wushaopei.com/qiniu337.png" width="60%">

<p>修改配置 </p>
<img src="http://photo.wushaopei.com/qiniu338.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu339.png" width="60%">

<p>点击Run，就可以运行felix，启动后结果如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">四月 <span class="number">14</span>, <span class="number">2020</span> <span class="number">5</span>:<span class="number">00</span>:<span class="number">44</span> 下午 org.jline.utils.Log logr</span><br><span class="line">警告: Unable to create a system terminal, <span class="function">creating a dumb <span class="title">terminal</span> <span class="params">(enable debug logging <span class="keyword">for</span> more information)</span></span></span><br><span class="line"><span class="function">____________________________</span></span><br><span class="line"><span class="function">Welcome to Apache Felix Gogo</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">g!</span></span><br></pre></td></tr></table></figure>



<h2 id="发布应用到Felix中"><a href="#发布应用到Felix中" class="headerlink" title="发布应用到Felix中"></a>发布应用到Felix中</h2><p>新建插件工程HelloFelix </p>
<img src="http://photo.wushaopei.com/qiniu340.png" width="60%">

<p>“ next ” 下一步，选择生成 Activator ：</p>
<img src="http://photo.wushaopei.com/qiniu334.png" width="60%">

<p>完成后修改Activator类，加入两段输出： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * (non-Javadoc)</span></span><br><span class="line"><span class="comment"> * @see org.osgi.framework.BundleActivator#start(org.osgi.framework.BundleContext)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(BundleContext bundleContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Activator.context = bundleContext;</span><br><span class="line">	System.out.println(<span class="string">"hello felix应用启动！"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * (non-Javadoc)</span></span><br><span class="line"><span class="comment"> * @see org.osgi.framework.BundleActivator#stop(org.osgi.framework.BundleContext)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(BundleContext bundleContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Activator.context = <span class="keyword">null</span>;</span><br><span class="line">	System.out.println(<span class="string">"hello felix应用停止！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成后选择 File–&gt;Export，选择Plug-in Development的Deployable plug-ins and fragments </p>
<img src="http://photo.wushaopei.com/qiniu341.png" width="60%">

<p>选择要导出的插件，Destination选项卡的Directory选择Felix环境的物理地址，导出后，会在Felix工程的根目录自动创建一个felix-cache和plugins目录，bundle会默认导出这个目录，单击Finish按钮。 </p>
<img src="http://photo.wushaopei.com/qiniu342.png" width="60%">

<p>点击完成，得到结果，然后到工程中已经搭建好的环境felix项目中进行刷新，可以看到多出pluglins目录 </p>
<img src="http://photo.wushaopei.com/qiniu343.png" width="60%">

<p>环境和工程都已经完成，下面安装和卸载一下工程在felix中</p>
<p>启动Felix，在Console中先使用install命令安装bundle，接着使用start命令启动bundle。</p>
<img src="http://photo.wushaopei.com/qiniu344.png" width="60%">

<p>启动的时候，start命令后接着那个bundle的启动ID就可以启动bundle。</p>
<p>停止的时候，stop命令后接着那个bundle的ID就可以停止bundle。</p>
<img src="http://photo.wushaopei.com/qiniu345.png" width="60%">

<p>最后卸载工程HelloFelix，使用命令uninstall </p>
<img src="http://photo.wushaopei.com/qiniu346.png" width="60%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>OSGI</category>
        <category>Felix</category>
      </categories>
      <tags>
        <tag>OSGI</tag>
        <tag>Felix</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot 2.0 新特性-浅析</title>
    <url>/2020/03/20/SpringBoot-2-0-%E6%96%B0%E7%89%B9%E6%80%A7-%E6%B5%85%E6%9E%90/</url>
    <content><![CDATA[<h2 id="Spring-Boot-概述"><a href="#Spring-Boot-概述" class="headerlink" title="Spring Boot 概述"></a>Spring Boot 概述</h2><h3 id="Spring-Boot-的角色"><a href="#Spring-Boot-的角色" class="headerlink" title="Spring Boot 的角色"></a>Spring Boot 的角色</h3><blockquote>
<p>底层：Spring Frameword是 JAVAEE 的框架</p>
<p>中层：Spring Boot 是快速构建Spring框架的应用</p>
<p>顶层：Spring Cloud 是JAVAEE 的分布式</p>
</blockquote>
<h3 id="Spring-Boot-2-0新特性"><a href="#Spring-Boot-2-0新特性" class="headerlink" title="Spring Boot 2.0新特性"></a>Spring Boot 2.0新特性</h3><h4 id="SpringBoot2-0新特性："><a href="#SpringBoot2-0新特性：" class="headerlink" title="SpringBoot2.0新特性："></a><strong>SpringBoot2.0新特性：</strong></h4><ul>
<li>编程语言必须依赖于java 8++(&gt;jdk1.8)，Kotlin</li>
<li>底层框架：spring Framework 5.0X(必须依赖于java1.8)</li>
<li>全新特性：Web Flux(全新编程模型，对SpringMVC的补充)</li>
</ul>
<h4 id="为什么选择Web-Flux？"><a href="#为什么选择Web-Flux？" class="headerlink" title="为什么选择Web Flux？"></a><strong>为什么选择Web Flux？</strong></h4><ul>
<li>函数编程：Java8 Lambda</li>
<li>响应编程：Reactive Streams</li>
<li>异步编程：Servlet3.1 或 Asyc NIO</li>
</ul>
<h2 id="Spring-Boot-项目"><a href="#Spring-Boot-项目" class="headerlink" title="Spring Boot 项目"></a>Spring Boot 项目</h2><h3 id="Spring-Boot-环境准备"><a href="#Spring-Boot-环境准备" class="headerlink" title="Spring Boot 环境准备"></a>Spring Boot 环境准备</h3><ul>
<li>装配 JDK （<a href="https://java.oracle.com/）" target="_blank" rel="noopener">https://java.oracle.com/）</a></li>
<li>装配Maven （<a href="http://maven.apache.org）" target="_blank" rel="noopener">http://maven.apache.org）</a></li>
<li>装配IDEA （<a href="http://www.jetbrains.com/idea/）" target="_blank" rel="noopener">http://www.jetbrains.com/idea/）</a></li>
</ul>
<h4 id="具体操作："><a href="#具体操作：" class="headerlink" title="具体操作："></a><strong>具体操作：</strong></h4><ul>
<li>JDK：JDK1.8</li>
<li>Maven：配置仓库地址，配置下载镜像</li>
</ul>
<p><strong>配置文件路径</strong>: <code>..\apache-maven-3.5.4-bin\apache-maven-3.5.4\conf\settings.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>E:/softwareData/.m2/repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="maven配置环境变量"><a href="#maven配置环境变量" class="headerlink" title="maven配置环境变量"></a><strong>maven配置环境变量</strong></h4><blockquote>
<p><strong>M2_HOME</strong>   maven安装地址</p>
<p>PATH 后加上  <strong>;%M2_HOME\bin</strong></p>
</blockquote>
<ul>
<li>IDEA：<a href="http://www.jetbrains.com/idea" target="_blank" rel="noopener">http://www.jetbrains.com/idea</a> </li>
</ul>
<p><code>download community version（社区版）</code></p>
<h3 id="Spring-Boot应用（一）"><a href="#Spring-Boot应用（一）" class="headerlink" title="Spring Boot应用（一）"></a>Spring Boot应用（一）</h3><h4 id="简单应用："><a href="#简单应用：" class="headerlink" title="简单应用："></a>简单应用：</h4><ul>
<li>编写REST程序</li>
<li>运行Spring Boot 应用</li>
<li>使用HTTP请求工具：PostMan</li>
</ul>
<h4 id="场景说明："><a href="#场景说明：" class="headerlink" title="场景说明："></a>场景说明：</h4><ul>
<li>定义用户模型，包括属性：用户ID和名称</li>
<li>客户端发送POST请求，创建用户（Web MVC）</li>
<li>客户端发送GET请求，获取所有用户（Web Flux）</li>
</ul>
<h4 id="应用创建："><a href="#应用创建：" class="headerlink" title="应用创建："></a>应用创建：</h4><h5 id="创建springboot工程-first-app-demo："><a href="#创建springboot工程-first-app-demo：" class="headerlink" title="创建springboot工程 first-app-demo："></a><strong>创建springboot工程 first-app-demo：</strong></h5><img src="http://photo.wushaopei.com/qiniu142.png" width="80%">

<h5 id="配置依赖："><a href="#配置依赖：" class="headerlink" title="配置依赖："></a>配置依赖：</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- lombok 简化 java 代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="创建用户模型-User类，并声明-id、-name-两个变量"><a href="#创建用户模型-User类，并声明-id、-name-两个变量" class="headerlink" title="创建用户模型 User类，并声明 id、 name 两个变量"></a><strong>创建用户模型 User类，并声明 id、 name 两个变量</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用了Lombok优化了代码，不需要手动创建set/get方法 </p>
<h5 id="创建UserRepository-用户仓库类，用来存储用户的信息"><a href="#创建UserRepository-用户仓库类，用来存储用户的信息" class="headerlink" title="创建UserRepository 用户仓库类，用来存储用户的信息**"></a>创建UserRepository 用户仓库类，用来存储用户的信息**</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*  &#123;@link User&#125; &#123;@link Repository&#125;</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *  采用内存型的存储方式 -&gt;Map</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;Integer,User&gt; repository = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, User&gt;() &#123;&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> AtomicInteger idGenera = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *  保存用户对象</span></span><br><span class="line"><span class="comment">    *  @param user &#123;@link User&#125; 对象</span></span><br><span class="line"><span class="comment">    *  @return  如果保存成功，返回&lt;code&gt; true&lt;/code&gt;</span></span><br><span class="line"><span class="comment">    *           否则，返回&lt;code&gt;false&lt;/code&gt;</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span> <span class="params">(User user)</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ID 从 1 开始</span></span><br><span class="line">        Integer id = idGenera.incrementAndGet();</span><br><span class="line"> </span><br><span class="line">        user.setId(id);</span><br><span class="line">        <span class="keyword">return</span>  repository.put(id,user) == <span class="keyword">null</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建用户接口类-UserController-java"><a href="#创建用户接口类-UserController-java" class="headerlink" title="创建用户接口类 UserController.java"></a><strong>创建用户接口类 UserController.java</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/6 9:55</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserController</span><span class="params">(UserRepository userRepository)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="注意："><a href="#注意：" class="headerlink" title="注意："></a><strong>注意：</strong></h5><p>构造器形式的注入方式的好处：</p>
<blockquote>
<ol>
<li>不能修改。</li>
<li>可以更早的进行初始化，相对于字段性的注入方式会好一点。</li>
<li>但实际开发中，为了节约时间，还是会用字段形式的注入方式</li>
<li>参数由spring框架传递，@Autowired可以写也可以不写</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserRepository userRepository;</span><br></pre></td></tr></table></figure>

<h5 id="创建新增用户接口："><a href="#创建新增用户接口：" class="headerlink" title="创建新增用户接口："></a>创建新增用户接口：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/person/save"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">save</span> <span class="params">(@RequestParam String name)</span></span>&#123;</span><br><span class="line">       User user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">       user.setName(name);</span><br><span class="line">       <span class="keyword">if</span>(userRepository.save(user))&#123;</span><br><span class="line">           System.out.println(<span class="string">"用户对象： % 保存成功 ! \n"</span> + user);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span>  user;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h5><p>请求接口地址：</p>
<blockquote>
<p>localhost:8080/person/save?name=李清照</p>
</blockquote>
<blockquote>
<p>请求方式： <strong>POST 请求</strong></p>
</blockquote>
<h5 id="POSTMAN测试响应结果："><a href="#POSTMAN测试响应结果：" class="headerlink" title="POSTMAN测试响应结果："></a><strong>POSTMAN测试响应结果：</strong></h5><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"李清照"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>控制台打印：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu143.png" width="80%">  



<h2 id="构建方式、多模块和运行方式"><a href="#构建方式、多模块和运行方式" class="headerlink" title="构建方式、多模块和运行方式"></a>构建方式、多模块和运行方式</h2><h3 id="Spring-Boot-构建应用-命令行方式"><a href="#Spring-Boot-构建应用-命令行方式" class="headerlink" title="Spring Boot  构建应用-命令行方式"></a>Spring Boot  构建应用-命令行方式</h3><p><strong>spring-boot-starter-web的话@Configuration路由无法生效</strong> </p>
<p>（1）flux内嵌Netty容器，适用于</p>
<pre><code>@Configuration</code></pre><p>（2）web内嵌tomcat容器，适用于@RestController</p>
<p>（3）通过Maven的方式构建Spring Boot项目</p>
<pre><code>mvn archetype:generate -DinteractiveMode=false

-DgroupId=com.imooc  -DartifactId=first-app-by-maven

-Dversion=1.0.0-SNAPSHOT</code></pre><h3 id="Spring-Boot-多模块"><a href="#Spring-Boot-多模块" class="headerlink" title="Spring Boot 多模块"></a>Spring Boot 多模块</h3><blockquote>
<p>调整主（父）工程类型（<packaging>）</p>
<p>  创建子模块工程（<module>）</p>
<p>   模型层：model</p>
<p>   持久层：persistence</p>
<p>   表示层：web</p>
<p>子模块依赖管理（<dependencyManagement>）</p>
</blockquote>
<h4 id="将-first-app-demo-中的pom-xml-的打包-由-jar改成-pom"><a href="#将-first-app-demo-中的pom-xml-的打包-由-jar改成-pom" class="headerlink" title="将  first-app-demo 中的pom.xml 的打包 由 jar改成 pom"></a><strong>将  first-app-demo 中的pom.xml 的打包 由 jar改成 pom</strong></h4><img src="http://photo.wushaopei.com/qiniu144.png" width="80%">  



<h4 id="右击工程名，-创建一个-artifactId-为-web-的Maven-工程"><a href="#右击工程名，-创建一个-artifactId-为-web-的Maven-工程" class="headerlink" title="*右击工程名， 创建一个 artifactId 为 web 的Maven 工程 *"></a>*<em>右击工程名， 创建一个 artifactId 为 web 的Maven 工程 *</em></h4><img src="http://photo.wushaopei.com/qiniu145.png" width="80%">  



<h4 id="将原-first-app-demo-工程下java目录下的-com-包-拖到-web-工程的-java-包下，并删除原工程中的-src-目录"><a href="#将原-first-app-demo-工程下java目录下的-com-包-拖到-web-工程的-java-包下，并删除原工程中的-src-目录" class="headerlink" title="将原 first-app-demo 工程下java目录下的 com 包 拖到 web 工程的 java 包下，并删除原工程中的 src 目录"></a><strong>将原 first-app-demo 工程下java目录下的 com 包 拖到 web 工程的 java 包下，并删除原工程中的 src 目录</strong></h4><img src="http://photo.wushaopei.com/qiniu146.png" width="70%">  



<h4 id="右击工程名，-创建一个-artifactId-为-persistence-的Maven-工程，并在java-目录下创建一个-路径为"><a href="#右击工程名，-创建一个-artifactId-为-persistence-的Maven-工程，并在java-目录下创建一个-路径为" class="headerlink" title="右击工程名， 创建一个 artifactId 为 persistence  的Maven 工程，并在java 目录下创建一个 路径为"></a>右击工程名， 创建一个 artifactId 为 persistence  的Maven 工程，并在java 目录下创建一个 路径为</h4><blockquote>
<p>com.example.demo.model 的包，将web中的 User 模型类 剪切到 model工程 的 com.example.demo.model 包下</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu147.png" width="80%">



<h4 id="persistence-中的User-找不到对应的包报错"><a href="#persistence-中的User-找不到对应的包报错" class="headerlink" title="persistence 中的User 找不到对应的包报错"></a>persistence 中的User 找不到对应的包报错</h4><p>解决方法： 修正 多模块之间的 依赖关系，将 User 所在的 model 依赖添加到persistence 的pom.xml 中，同时将 persistence  的 依赖添加到 web 的pom.xml中 </p>
<img src="http://photo.wushaopei.com/qiniu148.png" width="80%">



<h3 id="Spring-Boot-项目打包"><a href="#Spring-Boot-项目打包" class="headerlink" title="Spring Boot 项目打包"></a>Spring Boot 项目打包</h3><h4 id="打包方式："><a href="#打包方式：" class="headerlink" title="打包方式："></a><strong>打包方式：</strong></h4><blockquote>
<p>  构建 JAR 包</p>
<p>  构建 WAR 包</p>
<p>  指定 Main-Class</p>
</blockquote>
<h4 id="右击工程名-“copy-path”-获取工程路径，到-cmd-exe-命令行中进入该目录下，输入"><a href="#右击工程名-“copy-path”-获取工程路径，到-cmd-exe-命令行中进入该目录下，输入" class="headerlink" title="右击工程名  “copy path” 获取工程路径，到 cmd.exe 命令行中进入该目录下，输入"></a><strong>右击工程名  “copy path” 获取工程路径，到 cmd.exe 命令行中进入该目录下，输入</strong></h4><p><code>mvn -Dmaven.test.skip -U clean package</code></p>
<h5 id="命令执行打包操作，"><a href="#命令执行打包操作，" class="headerlink" title="命令执行打包操作，"></a>命令执行打包操作，</h5><p>此时执行过程会发生报错，因为 在进行多模块拆分后，需要重新为工程指定 main.class ，也就是 springboot 的启动器入口的位置的明确。这是由于在拆分过后，在父工程下找不到main.class 。</p>
<h5 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h5><p>将父工程的pom.xml 中的 <build></build>依赖驱动剪切到 web 子模块中 ，然后再到修改后的web子模块的 pom.xml 中的   <build></build> 中的<plugin></plugin>添加一个 <configuration/>,并为其配置一个<mainClass/>，将 springboot入口启动器的 Reference 路径复制并放入到 <mainClass>中，然后执行打包就可以了。</p>
<p><strong>注意：</strong> 不要把<build/>放在父工程的pom.xml 下进行打包，那样会有很多错误要进行修正，而且由于主启动器迁移到 了web 中，在父工程下 添加<build/>意义不大<img src="http://photo.wushaopei.com/qiniu149.png" width="80%"></p>
<h4 id="在-cmd-命令行中启动-jar-包-或者-war-包-的方式："><a href="#在-cmd-命令行中启动-jar-包-或者-war-包-的方式：" class="headerlink" title="在 cmd 命令行中启动 jar 包 或者 war 包 的方式："></a><strong>在 cmd 命令行中启动 jar 包 或者 war 包 的方式：</strong></h4><blockquote>
<p>java -jar web-0.0.1-SNAPSHOT.jar</p>
<p>或者</p>
<p>java -jar web-0.0.1-SNAPSHOT.war</p>
</blockquote>
<p><strong>注意：</strong> 要在 当前工程打成 war 包，需要在 web 的mian 目录下创建 “webapp” 和  “WEB-INF”两个目录，并在 “WEB-INF” 目录下创建 一个 web.xml 文件 </p>
<img src="http://photo.wushaopei.com/qiniu150.png" width="80%">



<h3 id="Spring-Boot-运行模式"><a href="#Spring-Boot-运行模式" class="headerlink" title="Spring Boot 运行模式"></a>Spring Boot 运行模式</h3><h4 id="Springboot项目的3种运行模式："><a href="#Springboot项目的3种运行模式：" class="headerlink" title="Springboot项目的3种运行模式："></a>Springboot项目的3种运行模式：</h4><p><strong>idea</strong>方式，<strong>jar/war</strong>方式，<strong>maven</strong>插件方式</p>
<ol>
<li>如果是在开发过程中，会使用idea方式</li>
<li>如果是在线上的服务器上，会使用jar/war方式，作为启动脚本</li>
<li>如果开发环境是Linux环境，会使用maven插件方式。</li>
</ol>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">mvn</span> <span class="string">spring-boot:run</span></span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot功能篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot框架（一）整合ApacheShiro权限管理框架</title>
    <url>/2020/03/08/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%B8%83%EF%BC%89%E6%95%B4%E5%90%88ApacheShiro%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6/</url>
    <content><![CDATA[<h3 id="1、Spring-Security-权限管理框架介绍"><a href="#1、Spring-Security-权限管理框架介绍" class="headerlink" title="1、Spring Security 权限管理框架介绍"></a>1、Spring Security 权限管理框架介绍</h3><p><strong>简介</strong>： Spring Security 提供了基于javaEE的企业应有个你软件全面的安全服务。这里特别强调支持使用SPring框架构件的项目，Spring框架是企业软件开发javaEE方案的领导者。 </p>
<blockquote>
<p>Spring Security 的两个目标： <strong>“认证”</strong> 与<strong>“授权”</strong>。 </p>
</blockquote>
<ul>
<li>“<strong>认证</strong>”，是建立一个他声明的主题的过程（一个“主体”一般是指用户，设备或一些可以在你的应用程序中执行动作的其他系统）。</li>
<li>“<strong>授权</strong>” 指确定一个主体是否允许在你的应用程序执行一个动作的过程。为了抵达需要授权的店，主体的身份已经有认证过程建立。这个概念是通用的而不只在Spring Security中。</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu49d.png" width="60%">

<p>​    在SpringSecurity 中，请求进入后会被拦截器拦截到，并交由认证管理器首先处理；这是在身份验证层，Spring Security  的支持多种认证模式。包括 Basic、Digest、X.509、LDAP、Form（基于表单的认证） 等多种HTTP 认证。 </p>
<p><strong>浅析：</strong></p>
<blockquote>
<p><strong>Basic 认证</strong>：在HTTP1.0提出的认证方法，针对特定的用户和资源，需要提供特定的密码认证后方可访问，其中密码是使用明文传输的；一个请求到来时，浏览器弹出对话框，让用户输入用户名和密码，并用BASE 64 进行编码进行传输，服务器接受并解析这些信息，并认证通过，才会允许继续访问。</p>
</blockquote>
<blockquote>
<p><strong>Digest认证</strong>： 解决Basic 认证的安全问题，当访问时，浏览器依旧弹出对话框，让用户输入用户名和密码，浏览器会对用户名、密码、HTTP请求方法、被请求资源的URI进行组合后进行MD5运算，然后把计算得到的摘要信息发送给服务器；服务器获取报文头部相关认证信息后获取到 username ,同时获取到密码，同样对用户名、密码、HTTP请求方法、被请求资源的URI进行组合后和 response 进行比较，如果相同，才算认证通过。</p>
</blockquote>
<h3 id="2、Spring-Security-常用权限拦截器："><a href="#2、Spring-Security-常用权限拦截器：" class="headerlink" title="2、Spring Security 常用权限拦截器："></a>2、Spring Security 常用权限拦截器：</h3><img src="http://photo.wushaopei.com/qiniu50.png" width="60%">

<p>主要功能性拦截器有 11 个， FilterChainProxy 对拦截器进行过滤操作并代理执行！ </p>
<h3 id="3、Spring-Security-项目-Demo"><a href="#3、Spring-Security-项目-Demo" class="headerlink" title="3、Spring Security 项目 Demo"></a>3、Spring Security 项目 Demo</h3><p>（1）环境搭建及使用 </p>
<blockquote>
<ol>
<li>基于Spring Boot + Spring Security 环境</li>
<li>常用 Case 实现</li>
</ol>
</blockquote>
<p>（2）创建SpringBoot 工程 </p>
<img src="http://photo.wushaopei.com/qiniu51.png" width="60%">

<p>（3）整合SpringSecurity 依赖 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">       <span class="comment">&lt;!--springsecurity 主要依赖--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（4）主启动类配置： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span>          <span class="comment">//返回响应体为json</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span>  <span class="comment">//扫描Bean注入到容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Bootstrap<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>) <span class="comment">// 测试接口</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">home</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>) <span class="comment">//测试接口</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（5）配置 Servlet 初始化 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ServletInitializer 告诉程序，项目启动时从 Bootstrap 开始</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/19 10:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletInitializer</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(Bootstrap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（6）启动SpringBoot 项目- - run 主启动类： </p>
<blockquote>
<p>启动SpringBoot 项目进行接口访问时，弹出登录界面，说明SpringSecurity生效了 </p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu52.png" width="60%">

<h3 id="4、SpringSecurity拦截配置："><a href="#4、SpringSecurity拦截配置：" class="headerlink" title="4、SpringSecurity拦截配置："></a>4、SpringSecurity拦截配置：</h3><p><strong>注意</strong>：在 3  的基础上，对工程进一步配置： </p>
<p>（1）创建 SpringSecurityConfig 类管理 拦截配置： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>     <span class="comment">// 将Bean 放到容器中管理</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">// 用于将Security 生成 Bean </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 接口请求拦截</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()  <span class="comment">//安全请求策略</span></span><br><span class="line">                .antMatchers(<span class="string">"/"</span>).permitAll() <span class="comment">//可放行请求配置</span></span><br><span class="line">                .anyRequest().authenticated()    <span class="comment">//其他请求进行拦截</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout().permitAll()  <span class="comment">// 注销任意访问</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin();</span><br><span class="line">        http.cors().disable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *  前端拦截</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(WebSecurity web)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 忽视 js 、css 、 images 后缀访问</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">"/js/**"</span>,<span class="string">"/css/**"</span>,<span class="string">"/images/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该 <strong>SpringSecurityConfig</strong> 继承 <strong>WebSecurityConfigurerAdapter</strong> 类，并重写 <strong>configure(HttpSecurity http)</strong>和 <strong>configure（WebSecurity web）</strong>两个方法，分别针对 接口请求 和 静态页面 资源进行拦截。</p>
<blockquote>
<p><strong>接口请求</strong>： ip:port/  的请求一律通过，主要进入到 Bootstrap 中的 RequestMapping(“/”)接口中；并对 “/”后带有标识地址的请求进行拦截认证； </p>
</blockquote>
<blockquote>
<p><strong>静态资源</strong>： 此处对静态 js 、css、images 三者进行放行。 </p>
</blockquote>
<p>效果截图： </p>
<blockquote>
<p>配置 SpringSecurity 后，默认可以通过 “/” 的接口请求； 而当进行 如“/hello”接口请求时会被拦截进行验证 </p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu53.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu54.png" width="60%">

<h3 id="5、基于SpringSecurity-权限管理-Case-实操"><a href="#5、基于SpringSecurity-权限管理-Case-实操" class="headerlink" title="5、基于SpringSecurity 权限管理 Case 实操"></a>5、基于SpringSecurity 权限管理 Case 实操</h3><p><strong>权限管理 Case 的需求有两个要求：</strong> </p>
<blockquote>
<ol>
<li><strong>第一点</strong> ：只要能登录即可；</li>
<li><strong>第二点</strong>：有指定的角色，每个角色有指定的权限.</li>
</ol>
</blockquote>
<p>（1）只要能登录即可，功能体现： </p>
<p>在SpringSecurityConfig.java中配置用户信息： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*  告诉程序，系统中有个用户 用户名为 admin ,密码为 admin  角色为 ADMIN</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">"admin"</span>).password(<span class="string">"admin"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意 ：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在springboot使用spring security 做权限管理 ，使用内存用户验证，会返回无响应报错：</span><br><span class="line">java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id &quot;null&quot;</span><br></pre></td></tr></table></figure>

<p><strong>解决方法：</strong> </p>
<blockquote>
<p>这是因为Spring boot 2.0.3引用的security 依赖是 spring security 5.X版本，此版本需要提供一个PasswordEncorder的实例，否则后台汇报错误：</p>
<p>java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id “null”<br>并且页面毫无响应。<br>因此，需要创建PasswordEncorder的实现类。</p>
</blockquote>
<p>创建PasswordEncorder 实体类后可通过<strong>两种方式</strong>完成明文验证通过：</p>
<p><strong>第一种</strong>：直接在配置好的 PasswordEncorder 类上添加 @Component 装配 MyPasswordEncoder 为Bean 注入到容器即可；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> charSequence.toString();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence charSequence, String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.equals(charSequence.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后继续使用 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  *  告诉程序，系统中有个用户 用户名为 admin ,密码为 admin  角色为 ADMIN</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">//可以设置内存指定的登录的账号密码,指定角色</span></span><br><span class="line">      <span class="comment">//不加.passwordEncoder(new MyPasswordEncoder())或者注入该类的Bean</span></span><br><span class="line">      <span class="comment">//就不是以明文的方式进行匹配，会报错</span></span><br><span class="line">      auth.inMemoryAuthentication().withUser(<span class="string">"admin"</span>).password(<span class="string">"admin"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>进行 密码明文登录，可以成功 </p>
<img src="http://photo.wushaopei.com/qiniu55.png" width="60%">

<p><strong>第二种</strong>：在auth.inMemoryAuthentication()后面使用<em>.passwordEncoder(new MyPasswordEncoder())**对登录信息进行包装后提交即可；这样也可以成功</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这样，页面提交时候，密码以明文的方式进行匹配。</span></span><br><span class="line">auth.inMemoryAuthentication().passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder()).withUser(<span class="string">"wsp"</span>).password(<span class="string">"wsp"</span>).roles(<span class="string">"ADMIN"</span>);</span><br></pre></td></tr></table></figure>

<p><strong>推荐</strong>： 最好是使用第一种 装载成 Bean 后注入容器，对于开发效率更高，也更便捷。</p>
<p>（2）有指定的角色，每个角色有指定的权限，功能体现：</p>
<p>① 创建接口 role1() 并对其添加 @PreAuthorize(<strong>“hasRole(‘ROLE_ADMIN’)”</strong>)  以进行角色拦截</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_ADMIN')"</span>) <span class="comment">// 角色拦截校验注解</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/roleAuth"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">role1</span><span class="params">()</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">return</span> <span class="string">"roleAuth"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>（2）角色拦截 - -</strong> 功能解析： </p>
<p> @PreAuthorize(<strong>“hasRole(‘ROLE_ADMIN’)”</strong>) 注解说明： </p>
<img src="http://photo.wushaopei.com/qiniu56.png" width="60%">

<p>②并在 SpringSecurityConfig.java 中创建新用户，以提供测试： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//可以设置内存指定的登录的账号密码,指定角色</span></span><br><span class="line">        <span class="comment">//不加.passwordEncoder(new MyPasswordEncoder())</span></span><br><span class="line">        <span class="comment">//就不是以明文的方式进行匹配，会报错</span></span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">"admin"</span>).password(<span class="string">"admin"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">"demo"</span>).password(<span class="string">"demo"</span>).roles(<span class="string">"DEMO"</span>);</span><br><span class="line">        .passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder())。</span><br><span class="line">        <span class="comment">//这样，页面提交时候，密码以明文的方式进行匹配。</span></span><br><span class="line">        auth.inMemoryAuthentication().passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder()).withUser(<span class="string">"wsp"</span>).password(<span class="string">"wsp"</span>).roles(<span class="string">"ADMIN"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>③ 创建好接口后，进行登录尝试，发现，使用 用户为 demo ，角色 为 DEMO 依旧可以通过该接口 </p>
<img src="http://photo.wushaopei.com/qiniu57.png" width="60%">

<p>问题解析：</p>
<p>这是因为还需要再添加一个@EnableGlobalMethodSecurity(prePostEnabled = <strong>true</strong>) 注解到 启动器上，以让 @PreAuthorize(<strong>“hasRole(‘ROLE_ADMIN’)”</strong>) 这个注解生效，完整 启动类代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Bootstrap<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">home</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello spring boot"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_ADMIN')"</span>)</span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/roleAuth"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">role1</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"roleAuth"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>添加注解后</strong>：</p>
<p><strong>使用 demo 进行登录：</strong></p>
<img src="http://photo.wushaopei.com/qiniu58.png" width="60%">

<p><strong>使用admin进行登录：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu59.png" width="60%">

<p><strong>（3）数据库管理实现</strong>： </p>
<blockquote>
<p> 通过数据库获取用户信息进行登录认证 </p>
</blockquote>
<p>创建 MyUserService.java类，并装载 Bean 到 容器中，在SpringSecurityConfig.java 中进行配置： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringSecurityConfig.java 中 configure(AuthenticationManagerBuilder auth)方法修改为通过注入MyUserService 的Bean实现数据库查询 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyUserService myUserService;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">           auth.userDetailsService(myUserService); <span class="comment">// 通过注入 MyUserService 的方式实现数据库查询用户信息的登录认证</span></span><br><span class="line"> </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>密码的自定义验证：</strong> </p>
<blockquote>
<p>创建 MyPasswordEncoder 类，实现 PasswordEncoder 接口类；重写 encode（CharSequence obj和 matches（CharSequence obj,String str） 方法： </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String SALT = <span class="string">"wenmin"</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> MD5Util.MD5Encode(charSequence.toString(),SALT);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> MD5Util.isPasswordValid(encodedPassword,rawPassword.toString(),SALT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>说明：</strong>第一个是加密的方法，第二个是匹配密码，具体操作是加密方法加密后与原始密码在匹配方法中进行匹配</p>
<p>底层逻辑解析：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">passwordEncoder. isPasswordValid(userDetails.getPassword(), presentedPassword, salt) 这个实现是在接口PasswordEncoder的实现类MessageDigestPasswordEncoder中实现的。 </span><br><span class="line"> </span><br><span class="line">MessageDigestPasswordEncoder类： </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPasswordValid</span><span class="params">(String encPass, String rawPass, Object salt)</span> </span>&#123; </span><br><span class="line">        String pass1 = <span class="string">""</span> + encPass; </span><br><span class="line">        String pass2 = encodePassword(rawPass, salt); </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> pass1.equals(pass2); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">其中 encodePassword(rawPass, salt)方法如下： </span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">encodePassword</span><span class="params">(String rawPass, Object salt)</span> </span>&#123; </span><br><span class="line">        String saltedPass = mergePasswordAndSalt(rawPass, salt, <span class="keyword">false</span>); </span><br><span class="line"> </span><br><span class="line">        MessageDigest messageDigest = getMessageDigest(); </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">byte</span>[] digest; </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123; </span><br><span class="line">            digest = messageDigest.digest(saltedPass.getBytes(<span class="string">"UTF-8"</span>)); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123; </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"UTF-8 not supported!"</span>); </span><br><span class="line">        &#125; </span><br><span class="line"> </span><br><span class="line">        <span class="comment">// "stretch" the encoded value if configured to do so </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; iterations; i++) &#123; </span><br><span class="line">            digest = messageDigest.digest(digest); </span><br><span class="line">        &#125; </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (getEncodeHashAsBase64()) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(Base64.encode(digest)); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(Hex.encode(digest)); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">使用的是MD5加密方法。</span><br></pre></td></tr></table></figure>

<p><strong>引入自定义的登录信息验证器</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">auth.userDetailsService(myUserService).passwordEncoder(<span class="keyword">new</span> MyPasswordEncoder());</span><br></pre></td></tr></table></figure>

<p>相关注解说明： </p>
<table>
<thead>
<tr>
<th>@PreAuthorize(“hasRole(‘ROLE_ADMIN’)”)</th>
<th>方法调用前进行权限检查</th>
</tr>
</thead>
<tbody><tr>
<td><strong>@PostAuthorize(“hasRole(‘’)”)</strong></td>
<td>方法调用后进行权限检查</td>
</tr>
<tr>
<td><strong>@PreFilter(“”)</strong></td>
<td>方法调用前针对集合类参数或返回值进行过滤</td>
</tr>
<tr>
<td><strong>@PostFilter(“”)</strong></td>
<td>方法调用后针对集合类参数或返回值进行过滤</td>
</tr>
</tbody></table>
<h3 id="6、Spring-Security-的优缺点"><a href="#6、Spring-Security-的优缺点" class="headerlink" title="6、Spring Security 的优缺点"></a>6、Spring Security 的优缺点</h3><p><strong>优点：</strong></p>
<blockquote>
<p>提供了一套安全框架，而且这个框架是可以用的；</p>
<p>提供了很多用户认证的功能，实现相关接口即可，节约大量开发工作；</p>
<p>基于spring，易于集成到 spring 项目中，且封装了许多方法。</p>
</blockquote>
<p><strong>缺点：</strong></p>
<blockquote>
<p>配置文件多，角色被“编码”到配置文件盒源文件中，RBAC 不明显；</p>
<p>对于系统中用户、角色、权限之间的关系，没有可操作的界面；</p>
<p>大数据量情况下，几乎不可用。 </p>
</blockquote>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/Spring-boot-Security" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot整合（一）集成swagger-ui</title>
    <url>/2020/03/06/SpringBoot%E6%95%B4%E5%90%88%EF%BC%88%E4%B8%80%EF%BC%89%E9%9B%86%E6%88%90swagger-ui/</url>
    <content><![CDATA[<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a><strong>前言：</strong></h3><p><strong>使用swagger-ui 的原因之一，也是最重要的原因。</strong></p>
<ul>
<li>SwaggerHub充当我们的API开发人员门户，产品所有者，Test QA分析人员，开发人员和架构师可以在其中进行API设计和开发并进行协作。 </li>
<li>SwaggerHub充当协作的集中主机，使该过程非常高效，直观和无缝。 </li>
<li>SwaggerHub旨在为组织和团队提供最佳的体验，以维护和扩展从设计到部署的API开发。  </li>
<li>SwaggerHub的自动生成的API文档使内部和外部用户易于使用您的API。 </li>
</ul>
<p><strong>官网链接地址</strong>：<a href="https://swagger.io/tools/swaggerhub/" target="_blank" rel="noopener">https://swagger.io/tools/swaggerhub/</a> </p>
<h3 id="1、工程创建"><a href="#1、工程创建" class="headerlink" title="1、工程创建"></a>1、工程创建</h3><blockquote>
<p> 创建一个maven 管理的springboot 工程，这里不做赘述</p>
</blockquote>
<h3 id="2、添加依赖"><a href="#2、添加依赖" class="headerlink" title="2、添加依赖"></a>2、添加依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">       <span class="comment">&lt;!--SpringBoot整合Swagger-ui--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger-ui --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3、设置配置类"><a href="#3、设置配置类" class="headerlink" title="3、设置配置类"></a>3、设置配置类</h3><img src="http://photo.wushaopei.com/qiniu17.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.config;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Contact;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SwaggerConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/22 16:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 启动时加载类</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 启用Swagger API文档</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">api</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">// 自行修改为自己的包路径</span></span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.example.poiutis.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">"报表管理"</span>)</span><br><span class="line">                .description(<span class="string">"报表管理中心 API 1.0 操作文档"</span>)</span><br><span class="line">                <span class="comment">//服务条款网址</span></span><br><span class="line">                .termsOfServiceUrl(<span class="string">"https://blog.csdn.net/weixin_42405670"</span>)</span><br><span class="line">                .version(<span class="string">"1.0"</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> Contact(<span class="string">"鮀城小帅"</span>, <span class="string">"https://blog.csdn.net/weixin_42405670"</span>, <span class="string">"15989746839@163.com"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<blockquote>
<p>启动类加上注解<strong>@EnableSwagger</strong></p>
</blockquote>
<p>启动该注解使得用在<strong>controller</strong>中的<strong>swagger</strong>注解生效，覆盖的范围下的所有<strong>controller</strong></p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu18.png" width="80%">

<h3 id="4、Controller-类配置"><a href="#4、Controller-类配置" class="headerlink" title="4、Controller 类配置"></a>4、Controller 类配置</h3><p><strong>@Api的使用</strong> </p>
<p><strong>API</strong>作用在<strong>Controller</strong>,作为swagger文档资源,该注解将一个<strong>controller</strong>标注为一个<strong>Swagger</strong>资源(API). 在默认情况下，<strong>Swagger</strong>-<strong>Core</strong> 只会扫描解析具有 @Api 注解的类，而会自动忽略其他类别资源（<strong>JAX-RS endpoints、Servlets</strong> 等）的注解。</p>
<p><strong>@ApiOperation</strong> 的使用</p>
<p><strong>ApiOperation</strong> 定义在方法上，描述方法名、方法解释、返回信息、标记等信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发票管理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> issuser</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"发票"</span>,description = <span class="string">"发票操作 API"</span>, position = <span class="number">100</span>, protocols = <span class="string">"http"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/webcode"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvoiceController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(InvoiceController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    invoiceOrderService InvoiceOrderService;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@ApiOperation</span>(value = <span class="string">"导出操作日志到xls文件"</span>, notes = <span class="string">"需要登录"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/exporInvoiceOrderXls"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">exporInvoiceOrderXls</span><span class="params">( HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        @RequestParam(value=<span class="string">"invoiceOrders"</span>)</span>@<span class="title">ApiParam</span><span class="params">(value=<span class="string">"invoiceOrders"</span>)</span> List&lt;String&gt;  invoiceOrders) </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">        response.setContentType(<span class="string">"octets/stream"</span>);</span><br><span class="line"> </span><br><span class="line">        Map&lt;String, Object&gt; map2 = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        map2.put(<span class="string">"sheetTitle"</span>, <span class="string">"消费记录"</span>);</span><br><span class="line">        map2.put(<span class="string">"header"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"订单号"</span>, <span class="string">"商店名称"</span>, <span class="string">"发票批次"</span>, <span class="string">"账户名称"</span>, <span class="string">"商店地址"</span>, <span class="string">"刷卡账号"</span>,<span class="string">"商店电话"</span>,<span class="string">"信用卡开户行名称"</span>&#125;);</span><br><span class="line">        map2.put(<span class="string">"fields"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"invoiceOrder"</span>, <span class="string">"companyName"</span>, <span class="string">"taxNumber"</span>, <span class="string">"accountBank"</span>, <span class="string">"companyAddress"</span>,<span class="string">"bankNumber"</span>,<span class="string">"companyTelephone"</span>,<span class="string">"accountName"</span>&#125;);</span><br><span class="line"> </span><br><span class="line">        List&lt;InvoiceOrder&gt; invoiceOrderss = InvoiceOrderService.queryInvoiceLists(invoiceOrders,<span class="number">0</span>,<span class="number">9999</span>);</span><br><span class="line">        map2.put(<span class="string">"data"</span>,invoiceOrderss);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(map2);</span><br><span class="line"> </span><br><span class="line">        String title = <span class="string">"日常消费刷卡发票记录"</span>;</span><br><span class="line"> </span><br><span class="line">        Map&lt;String, <span class="keyword">short</span>[]&gt; mergedRegion = <span class="keyword">new</span> HashMap&lt;String, <span class="keyword">short</span>[]&gt;();</span><br><span class="line">        mergedRegion.put(<span class="string">"通用标题名称合并"</span>, <span class="keyword">new</span> <span class="keyword">short</span>[] &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>&#125;);</span><br><span class="line"> </span><br><span class="line">        ExportExcel&lt;InvoiceOrder&gt; ex = <span class="keyword">new</span> ExportExcel&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 声明一个工作薄</span></span><br><span class="line">        HSSFWorkbook workbook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">        <span class="comment">// 生成一个标题样式</span></span><br><span class="line">        HSSFCellStyle headerStyle = ex.cellStyle(workbook);</span><br><span class="line">        <span class="comment">// 生成一个内容样式</span></span><br><span class="line">        HSSFCellStyle textStyle = ex.cellStyle(workbook);</span><br><span class="line">        <span class="comment">// 生成标题字体</span></span><br><span class="line">        ex.setFont(workbook, headerStyle, (<span class="keyword">short</span>) <span class="number">10</span>, HSSFFont.BOLDWEIGHT_NORMAL);</span><br><span class="line">        <span class="comment">// 生成内容字体</span></span><br><span class="line">        ex.setFont(workbook, textStyle, HSSFFont.BOLDWEIGHT_NORMAL);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            OutputStream out = response.getOutputStream();</span><br><span class="line">            <span class="comment">// 导出文件名称添加当前时间</span></span><br><span class="line">            String date = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">            <span class="comment">//防止乱码</span></span><br><span class="line"><span class="comment">//            response.addHeader("Access-Control-Expose-Headers", "Content-Type,Content-Disposition");</span></span><br><span class="line"><span class="comment">//            response.addHeader("Content-Disposition",</span></span><br><span class="line"><span class="comment">//                    "attachment;filename=" + URLEncoder.encode(title, "GBK") + date</span></span><br><span class="line"><span class="comment">//                            + ".xls");</span></span><br><span class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment; filename="</span> + <span class="keyword">new</span> String((title+<span class="string">".xls"</span>).getBytes(<span class="string">"GB2312"</span>),<span class="string">"ISO8859-1"</span>));</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            list.forEach(m -&gt; &#123;</span><br><span class="line">                ExcelModel excelModel = <span class="keyword">new</span> ExcelModel();</span><br><span class="line">                excelModel.setWorkbook(workbook);</span><br><span class="line">                excelModel.setTitle(title);</span><br><span class="line">                excelModel.setFields((String[]) m.get(<span class="string">"fields"</span>));</span><br><span class="line">                excelModel.setHeader((String[]) m.get(<span class="string">"header"</span>));</span><br><span class="line">                excelModel.setHeaderRow(<span class="number">2</span>);</span><br><span class="line">                excelModel.setMergedRegion(mergedRegion);</span><br><span class="line">                excelModel.setHeaderStyle(headerStyle);</span><br><span class="line">                excelModel.setTextStyle(textStyle);</span><br><span class="line">                excelModel.setTitles((String) m.get(<span class="string">"sheetTitle"</span>));</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 生成一页表格</span></span><br><span class="line">                HSSFSheet sheet = workbook.createSheet((String) m.get(<span class="string">"sheetTitle"</span>));</span><br><span class="line">                excelModel.setSheet(sheet);</span><br><span class="line">                ex.exportExcel(excelModel, (Collection&lt;InvoiceOrder&gt;) m.get(<span class="string">"data"</span>));</span><br><span class="line">            &#125;);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                workbook.write(out);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"导出成功"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            map.put(<span class="string">"state"</span>, <span class="string">"1"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性名称</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>url 的路径值</td>
</tr>
<tr>
<td>tags</td>
<td>如果设置这个值，value 的值会被覆盖</td>
</tr>
<tr>
<td>description</td>
<td>对 API 资源的描述</td>
</tr>
<tr>
<td>produces</td>
<td>For example, “application/json, application/xml”</td>
</tr>
<tr>
<td>consumes</td>
<td>For example, “application/json, application/xml”</td>
</tr>
<tr>
<td>protocols</td>
<td>Possible values: http, https, ws, wss</td>
</tr>
<tr>
<td>authorizations</td>
<td>高级特性认证时配置</td>
</tr>
<tr>
<td>hidden</td>
<td>配置为 true 将在文档中隐藏</td>
</tr>
<tr>
<td>response</td>
<td>返回的对象</td>
</tr>
<tr>
<td>responseContainer</td>
<td>这些对象是有效的 “List”, “Set” or “Map”，其他无效</td>
</tr>
<tr>
<td>httpMethod</td>
<td>“GET”、”HEAD”、”POST”、”PUT”、”DELETE”、”OPTIONS” and “PATCH”</td>
</tr>
<tr>
<td>code</td>
<td>http 的状态码 默认 200</td>
</tr>
<tr>
<td>extensions</td>
<td>扩展属性</td>
</tr>
</tbody></table>
<p><strong>@ApiImplicitParams</strong> 和 <strong>@ApiImplicitParam</strong> 的使用</p>
<p><strong>@ApiImplicitParams</strong> 用于描述方法的返回信息，和 <strong>@ApiImplicitParam</strong> 注解配合使用；<strong>@ApiImplicitParam</strong> 用来描述具体某一个参数的信息，包括参数的名称、类型、限制等信息。</p>
<hr>
<h3 id="5、启动项目，进入API列表，localhost-swagger-ui-html"><a href="#5、启动项目，进入API列表，localhost-swagger-ui-html" class="headerlink" title="5、启动项目，进入API列表，localhost/swagger-ui.html#"></a>5、启动项目，进入API列表，localhost/swagger-ui.html#</h3><img src="http://photo.wushaopei.com/qiniu19.png" width="80%">

<p>完整<strong>springBoot</strong> 整合 <strong>Swagger</strong> 代码 <strong>GitHub</strong> 链接地址：</p>
<p><strong>注意问题：</strong></p>
<p>出现以下问题时，要检查<strong>SwaggerConfig</strong> 中配置的路径是否正确；</p>
<img src="http://photo.wushaopei.com/qiniu20.png" width="80%">

<p>即：</p>
<img src="http://photo.wushaopei.com/qiniu21.png" width="80%">

<h3 id="6、Swagger常用注解"><a href="#6、Swagger常用注解" class="headerlink" title="6、Swagger常用注解"></a>6、Swagger常用注解</h3><table>
<thead>
<tr>
<th>作用范围</th>
<th>API</th>
<th>使用位置</th>
</tr>
</thead>
<tbody><tr>
<td>协议集描述</td>
<td>@Api</td>
<td>用于 Controller 类上</td>
</tr>
<tr>
<td>协议描述</td>
<td>@ApiOperation</td>
<td>用在 Controller 的方法上</td>
</tr>
<tr>
<td>非对象参数集</td>
<td>@ApiImplicitParams</td>
<td>用在 Controller 的方法上</td>
</tr>
<tr>
<td>非对象参数描述</td>
<td>@ApiImplicitParam</td>
<td>用在 @ApiImplicitParams 的方法里边</td>
</tr>
<tr>
<td>响应集</td>
<td>@ApiResponses</td>
<td>用在 Controller 的方法上</td>
</tr>
<tr>
<td>响应信息参数</td>
<td>@ApiResponse</td>
<td>用在 @ApiResponses 里边</td>
</tr>
<tr>
<td>描述返回对象的意义</td>
<td>@ApiModel</td>
<td>用在返回对象类上</td>
</tr>
<tr>
<td>对象属性</td>
<td>@ApiModelProperty</td>
<td>用在出入参数对象的字段上</td>
</tr>
</tbody></table>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/springBoot-swaggerui" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot整合篇</category>
      </categories>
  </entry>
  <entry>
    <title>mybatis 入门（二）Mybatis 的基本构成-构建SqlSessionFactory</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%8C%EF%BC%89Mybatis-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%84%E6%88%90-%E6%9E%84%E5%BB%BASqlSessionFactory/</url>
    <content><![CDATA[<h1 id="MyBatis-的基本构成"><a href="#MyBatis-的基本构成" class="headerlink" title="MyBatis 的基本构成"></a>MyBatis 的基本构成</h1><p>认识MyBatis，从它的表面想象，即基本构成进行了解。</p>
<h2 id="关于MyBatis的核心组件："><a href="#关于MyBatis的核心组件：" class="headerlink" title="关于MyBatis的核心组件："></a>关于MyBatis的核心组件：</h2><p><strong>SqlSessionFactoryBuilder(构造器)：</strong> 它会根据配置信息或者代码来生成SqlSessionfactory（工厂接口）。</p>
<p><strong>SqlSessionFactory：</strong> 依靠工厂来生成SqlSession(会话)。</p>
<p><strong>SqlSession：</strong> 是一个既可以发送SQL去执行并返回结果，也可以获取Mapper的接口。</p>
<p>*<em>SQL Mapper： *</em> 它是MyBatis新设计的组件，它是由一个Java接口和XML文件（或注解）构成的，需要给出对应的SQL和映射规则。它负责发送SQL去执行，并返回结果。</p>
<img src="http://photo.wushaopei.com/qiniu265.png" width="80%">

<p>上图是MyBatis核心构建之间的关联图。</p>
<h2 id="构建SqlSessionFactory"><a href="#构建SqlSessionFactory" class="headerlink" title="构建SqlSessionFactory"></a>构建SqlSessionFactory</h2><h3 id="概述介绍"><a href="#概述介绍" class="headerlink" title="概述介绍"></a>概述介绍</h3><p>每个MyBatis 的应用都是以SqlSessionFactoy 的实例为中心的。通过SqlSessionFactoryBuilder可以获得SqlSessionFactory。</p>
<img src="http://photo.wushaopei.com/qiniu266.png" width="80%">

<p>必须注意的一点是，SqlSessionFactory是一个工厂接口二不是现实类，它的任务是创建SqlSession.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an &#123;<span class="doctag">@link</span> SqlSession&#125; out of a connection or a DataSource *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlSessionFactory</span> </span>&#123;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(<span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(Connection connection)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(TransactionIsolationLevel level)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType, <span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level)</span></span>;</span><br><span class="line">  <span class="function">SqlSession <span class="title">openSession</span><span class="params">(ExecutorType execType, Connection connection)</span></span>;</span><br><span class="line">  <span class="function">Configuration <span class="title">getConfiguration</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=red>SqlSession类似是一个JDBC的Connection对象呢。</font></p>
<p>MyBatis提供 了<strong>两种模式去创建SqlSessionFactory</strong>：</p>
<pre><code>*  一种是XML配置的方式，这是笔者推荐的方式；

*  另一种是代码实现的方式。</code></pre><p>能够使用配置文件的时候，我们要尽量使用配置文件。</p>
<p>有<strong>以下两点好处：</strong></p>
<ul>
<li>避免硬编码；</li>
<li>方便后期配置人员进行修改、维护，避免重复编译代码</li>
</ul>
<h3 id="SqlSessionFactory的两个实现类"><a href="#SqlSessionFactory的两个实现类" class="headerlink" title="SqlSessionFactory的两个实现类"></a>SqlSessionFactory的两个实现类</h3><p>MyBatis中提供了两个SqlSessionFactory的实现类，DefaultSqlSession 和 SqlSessionManager。目前使用的是DefaultSqlSessionFactory.</p>
<p><strong>主要关系图如下：</strong></p>
<img src="http://photo.wushaopei.com/qiniu267.png" width="80%">



<h3 id="Configuration-类"><a href="#Configuration-类" class="headerlink" title="Configuration 类"></a>Configuration 类</h3><p>Configuration类全限定名为org.apache.ibatis.session.Configuration，它在MyBatis中将以一个Configuration类对象的形式存在，而 <code>这个对象将存在于整个MyBatis应用的生命期中</code>，以便重复读取和使用。</p>
<p><strong>注意：</strong> ①我们解析配置的XML文件都保存在Configuration类对象中；</p>
<p>​        ②Configuration类对象存在于内存中</p>
<h2 id="SqlSessionFactory的两种实现方式"><a href="#SqlSessionFactory的两种实现方式" class="headerlink" title="SqlSessionFactory的两种实现方式"></a>SqlSessionFactory的两种实现方式</h2><h3 id="使用XML方式构建"><a href="#使用XML方式构建" class="headerlink" title="使用XML方式构建"></a>使用XML方式构建</h3><p>这里我们配置一个建议的XML，包含获取数据库连接实例的数据源（DataSource)、决定事务范围和控制方式的事务管理器（TransactionManager)和映射器（SQL  Mapper)。XML配置文件的内容后面会详细探讨，这里先给出一个简单的示例：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">  PUBLIC <span class="string">"-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="line">  <span class="string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;environments <span class="keyword">default</span>=<span class="string">"development"</span>&gt;</span><br><span class="line">    &lt;environment id=<span class="string">"development"</span>&gt;</span><br><span class="line">      &lt;transactionManager type=<span class="string">"JDBC"</span>/&gt;</span><br><span class="line">      &lt;dataSource type=<span class="string">"POOLED"</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">"driver"</span> value=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;amp;serverTimezone=UTC"</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">"username"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span>/&gt;</span><br><span class="line">      &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">  &lt;/environments&gt;</span><br><span class="line">  &lt;mappers&gt;</span><br><span class="line">    &lt;mapper resource=<span class="string">"com/webcode/cn/mapper/UserMapper.xml"</span>/&gt;</span><br><span class="line">  &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>对上面的配置做一下说明：</p>
<p>这里配置了一个别名user，它代表com.webcode.cn.entity.User,这样我们就可以在MyBatis上下文中引用它了。</p>
<ul>
<li>我们配置了环境内容，它默认使用<strong>id</strong>是development的环境配置，包含以下两方面的内容：</li>
</ul>
<p>（1）采用JDBC的事务管理模式</p>
<p>（2）数据库的连接信息</p>
<ul>
<li>配置映射器</li>
</ul>
<p>这里在创建SqlSessionFactory时引入了一个XML，它的作用是提供SQL和SQL对POJO的映射规则定义，它包含了映射器里面的信息。MyBatis将解析这个XML，来为我们生成映射器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取指定的资源</span></span><br><span class="line">InputStream is = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line"><span class="comment">// 通过sqlSessionFactoryBuilder创建SqlSessionFactory</span></span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</span><br></pre></td></tr></table></figure>

<p>这里我们创建了一个XML文件输入流，用SqlSessionFactoryBuilder读取XML的信息来创建SqlSessionFactory的对象。</p>
<p>MyBatis的解析程序会将 mybatis-config.xml文件配置的信息解析到Configuration类对象里面，然后利用SqlSessionFactoryBuilder读取这个对象为我们创建SqlSessionFactory</p>
<p><code>详见代码： TestSqlSessionFactory.java</code></p>
<h3 id="使用代码方式构建"><a href="#使用代码方式构建" class="headerlink" title="使用代码方式构建"></a>使用代码方式构建</h3><p>前面说过，除了使用XML配置的方式创建代码外，也可以使用Java编码来实现，不过并不推荐这个方式，因为修改环境的时候，我们不得不重新编译代码，这样不利于维护。</p>
<p>​    不过，在这里我们为了比较两者的区别与实用性，会对该构建方式进行一个示例实现与分析。</p>
<p>与XML配置构建方式相同的地方在于，MyBatis依旧为我们提供好要使用的对象的类和方法，我们只需要在合适的地方对它进行调用即可。</p>
<p>​    首先，需要构建Configuration类对象。然后，往对象里面注册我们构建SqlSessionFactory所需要的信息即可。</p>
<p>​    具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取指定的资源</span></span><br><span class="line">		PooledDataSource dataSource = <span class="keyword">new</span> PooledDataSource();</span><br><span class="line">		dataSource.setDriver(<span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">		dataSource.setUrl(<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8&amp;serverTimezone=UTC"</span>);</span><br><span class="line">		dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">		dataSource.setPassword(<span class="string">"root"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//创建数据库事务方式</span></span><br><span class="line">		TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">		<span class="comment">// 创建数据库运行环境</span></span><br><span class="line">		Environment environment = <span class="keyword">new</span> Environment(<span class="string">"development"</span>, transactionFactory, dataSource);</span><br><span class="line">		<span class="comment">// 构建Configuration对象</span></span><br><span class="line">		Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line">		<span class="comment">// 加入一个映射器</span></span><br><span class="line">		configuration.addMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br><span class="line">		System.out.println( sqlSessionFactory );</span><br><span class="line">		<span class="comment">// 相当于 以前的Connection对象，每次用来都用关闭</span></span><br><span class="line">		SqlSession openSession = sqlSessionFactory.openSession();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//			selectOne方法用来执行select查询语句，并返回一个对象</span></span><br><span class="line">			<span class="comment">// 放名称空间+id</span></span><br><span class="line">			UserMapper userMapper = openSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;				<span class="comment">// </span></span><br><span class="line">			User user = userMapper.selectUserById(<span class="number">1</span>);</span><br><span class="line">			System.out.println( user );</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			openSession.close();<span class="comment">//释放资源</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>具体分析一下上述代码都做了些什么：</p>
<ul>
<li>初始化了一个数据库连接池</li>
<li>定义了JDBC的数据库事务管理方式</li>
<li>用数据库连接池和事务管理方式创建了一个数据库运行环境，并命名为 development</li>
<li>创建了一个Configuration类对象，并把数据库运行环境注册给它</li>
<li>注册了一个user的别名</li>
<li>加入一个映射器</li>
<li>用SqlSessionFactoryBuilder通过Configuration 对象创建SqlSessionFactory</li>
</ul>
<p>由以上分析可以看出，用代码方式实现和用XML方式只是换了个方法实现而已，其本质并无不同。其中采用代码方式一般是在需要加入自己特性的时候才会用到。</p>
<p>这里唯一需要注意的一点是，通过XML配置实现和代码实现的映射器是不同的，前者使用的是JavaBean，而后者使用UserMapper.java 。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>jdbc(五)普通增删改查、通用增删改查</title>
    <url>/2020/03/10/jdbc(%E4%BA%94)%E6%99%AE%E9%80%9A%E5%A2%9E%E5%88%A0%E6%94%B9%E3%80%81%E9%80%9A%E7%94%A8%E5%A2%9E%E5%88%A0%E6%94%B9/</url>
    <content><![CDATA[<h3 id="普通的增删查改"><a href="#普通的增删查改" class="headerlink" title="普通的增删查改"></a>普通的增删查改</h3><h4 id="创建一个类customer"><a href="#创建一个类customer" class="headerlink" title="创建一个类customer"></a>创建一个类customer</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String email;</span><br><span class="line">	<span class="keyword">private</span> Date birth;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(<span class="keyword">int</span> id, String name, String email, Date birth)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">		<span class="keyword">this</span>.email = email;</span><br><span class="line">		<span class="keyword">this</span>.birth = birth;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建jdbc连接，并封装为方法"><a href="#创建jdbc连接，并封装为方法" class="headerlink" title="创建jdbc连接，并封装为方法"></a><strong>创建jdbc连接，并封装为方法</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*	 * 获取数据库的连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 数据库的连接</span></span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			is = JDBCUtils.class.getClassLoader().getResourceAsStream("sqlDriver.properties");</span><br><span class="line">			Properties ps = <span class="keyword">new</span> Properties();</span><br><span class="line">			ps.load(is);</span><br><span class="line">			String user = ps.getProperty(<span class="string">"user"</span>);</span><br><span class="line">			String password = ps.getProperty(<span class="string">"password"</span>);</span><br><span class="line">			String driverClass = ps.getProperty(<span class="string">"driverClass"</span>);</span><br><span class="line">			String url = ps.getProperty(<span class="string">"url"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 创建Driver对象</span></span><br><span class="line">			Class clazz = Class.forName(driverClass);</span><br><span class="line">			Object obj = clazz.newInstance();</span><br><span class="line">			Driver driver = (Driver) obj;</span><br><span class="line">			<span class="comment">// 注册驱动</span></span><br><span class="line">			DriverManager.registerDriver(driver);</span><br><span class="line">			connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					is.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> connection;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在操作完成后要进行连接的关闭"><a href="#在操作完成后要进行连接的关闭" class="headerlink" title="在操作完成后要进行连接的关闭"></a><strong>在操作完成后要进行连接的关闭</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			connection.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ps.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection connection, PreparedStatement ps, ResultSet rs)</span> </span>&#123;</span><br><span class="line">	close(connection,ps);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(rs != <span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			rs.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="增删查改操作"><a href="#增删查改操作" class="headerlink" title="增删查改操作"></a><strong>增删查改操作</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 对数据库的  增 ，删，改，查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRUDTest</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 从数据库中查找一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> </span><br><span class="line">		Customer customer = getCustomerById();</span><br><span class="line">		System.out.println(customer);</span><br><span class="line">		</span><br><span class="line">		List&lt;Customer&gt; customers = getCustomers();</span><br><span class="line">		<span class="keyword">for</span> (Customer customer2 : customers) &#123;</span><br><span class="line">			System.out.println(customer2);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 查询多条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Customer&gt; <span class="title">getCustomers</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"select * from customers"</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 2.预编译  -- 如果没有占位符可以不填充数据</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery(); <span class="comment">// 查找的结果都已经放到ResultSet中了</span></span><br><span class="line"> </span><br><span class="line">		List&lt;Customer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">while</span>(rs.next())&#123;</span><br><span class="line">			<span class="comment">//获取数据</span></span><br><span class="line">			<span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">			String name = rs.getString(<span class="string">"name"</span>);</span><br><span class="line">			String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">			Date birth = rs.getDate(<span class="string">"birth"</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//将每条数据放入集合中</span></span><br><span class="line">			list.add(<span class="keyword">new</span> Customer(id, name, email, birth));</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 6.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 查询一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Customer <span class="title">getCustomerById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"select * from customers where id = ?"</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		ps.setInt(<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery(); <span class="comment">// 查找的结果都已经放到ResultSet中了</span></span><br><span class="line"> </span><br><span class="line">		Customer customer = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 5.取数据</span></span><br><span class="line">		<span class="keyword">if</span> (rs.next()) &#123; <span class="comment">// 如果有数据就返回true,否则返回false</span></span><br><span class="line">			<span class="comment">// 获取列上值的第一种方式</span></span><br><span class="line">			<span class="comment">// int id = rs.getInt(1); //根据列的索引获取对应的列上的值</span></span><br><span class="line">			<span class="comment">// String name = rs.getString(2);</span></span><br><span class="line">			<span class="comment">// String email = rs.getString(3);</span></span><br><span class="line">			<span class="comment">// Date date = rs.getDate(4);</span></span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 获取列上值的第二种方式</span></span><br><span class="line">			<span class="keyword">int</span> id = rs.getInt(<span class="string">"id"</span>);</span><br><span class="line">			String name = rs.getString(<span class="string">"name"</span>);</span><br><span class="line">			String email = rs.getString(<span class="string">"email"</span>);</span><br><span class="line">			Date birth = rs.getDate(<span class="string">"birth"</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 考虑将数据进行封装</span></span><br><span class="line">			customer = <span class="keyword">new</span> Customer(id, name, email, birth);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 输出获取到的内容</span></span><br><span class="line">			System.out.println(id + <span class="string">" "</span> + name + <span class="string">" "</span> + email + <span class="string">" "</span> + birth);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 6.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		<span class="keyword">return</span> customer;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 向数据库中插入一条数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 1 ： 连接数据库</span></span><br><span class="line">			connection = JDBCUtils.getConnection();</span><br><span class="line">			<span class="comment">// sql语句</span></span><br><span class="line">			String sql = <span class="string">"INSERT INTO customers(NAME,email,birth) "</span> + <span class="string">"VALUES(?,?,?);"</span>;</span><br><span class="line">			<span class="comment">// 2.预编译</span></span><br><span class="line">			ps = connection.prepareStatement(sql);</span><br><span class="line">			<span class="comment">// 3.设置内容</span></span><br><span class="line">			ps.setString(<span class="number">1</span>, <span class="string">"强哥"</span>); <span class="comment">// 第一个参数：第几个问号 第二个参数：内容</span></span><br><span class="line">			ps.setString(<span class="number">2</span>, <span class="string">"qiangge@qq.com"</span>);</span><br><span class="line">			<span class="comment">// 获取一个sql下的Date</span></span><br><span class="line">			Date date = <span class="keyword">new</span> Date(<span class="keyword">new</span> java.util.Date().getTime());</span><br><span class="line">			ps.setDate(<span class="number">3</span>, date);</span><br><span class="line">			<span class="comment">// 4.执行sql语句</span></span><br><span class="line">			ps.execute(); <span class="comment">// 如果是查询语句返回true</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 5.关闭资源</span></span><br><span class="line">			JDBCUtils.close(connection, ps);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 删除一条件数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1. 获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">		String sql = <span class="string">"DELETE FROM customers WHERE id = ?"</span>;</span><br><span class="line">		<span class="comment">// 2. 预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		ps.setInt(<span class="number">1</span>, <span class="number">19</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 4.执行sql语句</span></span><br><span class="line">		<span class="keyword">int</span> executeUpdate = ps.executeUpdate();</span><br><span class="line">		System.out.println(executeUpdate + <span class="string">"条受到影响"</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 5.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 修改一条件数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> </span><br><span class="line">		Connection connection = <span class="keyword">null</span>;</span><br><span class="line">		PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			connection = JDBCUtils.getConnection();</span><br><span class="line"> </span><br><span class="line">			String sql = <span class="string">"UPDATE customers SET NAME = ? WHERE id = ?"</span>;</span><br><span class="line">			ps = connection.prepareStatement(sql);</span><br><span class="line"> </span><br><span class="line">			ps.setString(<span class="number">1</span>, <span class="string">"成哥"</span>);</span><br><span class="line">			ps.setInt(<span class="number">2</span>, <span class="number">18</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">int</span> executeUpdate = ps.executeUpdate();</span><br><span class="line">			System.out.println(executeUpdate + <span class="string">"条数据受到影响"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			JDBCUtils.close(connection, ps);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通用增删查改"><a href="#通用增删查改" class="headerlink" title="通用增删查改"></a><strong>通用增删查改</strong></h3><h4 id="创建类-User-java"><a href="#创建类-User-java" class="headerlink" title="创建类 User.java"></a><strong>创建类 User.java</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String address;</span><br><span class="line">	<span class="keyword">private</span> String phone;</span><br></pre></td></tr></table></figure>

<p><strong>创建通用连接方案 - 通用增删改</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 通用的增删改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">UID</span><span class="params">(String sql,Object ...objects)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 1. 获取数据库的连接</span></span><br><span class="line">	Connection connection = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 2. 预编译</span></span><br><span class="line">	PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 4.执行sql语句</span></span><br><span class="line">	<span class="keyword">int</span> executeUpdate = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		connection = JDBCUtils.getConnection();</span><br><span class="line">		ps = connection.prepareStatement(sql);</span><br><span class="line">		<span class="comment">// 3.填充数据</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objects.length; i++) &#123; <span class="comment">// i 表示索引</span></span><br><span class="line">			ps.setObject(i + <span class="number">1</span>, objects[i]); <span class="comment">// i + 1表示的是第几个占位符</span></span><br><span class="line">		&#125;</span><br><span class="line">		executeUpdate = ps.executeUpdate();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">		<span class="comment">// 5.关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> executeUpdate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试代码："><a href="#测试代码：" class="headerlink" title="测试代码："></a><strong>测试代码：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 测试通用的增删改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span></span>&#123;</span><br><span class="line">	String sql = <span class="string">"INSERT INTO customers(NAME,email,birth) VALUES(?,?,?)"</span>;</span><br><span class="line">	Date date = <span class="keyword">new</span> java.sql.Date(<span class="keyword">new</span> java.util.Date().getTime());</span><br><span class="line">	<span class="keyword">int</span> uid = JDBCUtils.UID(sql, <span class="string">"强哥"</span>,<span class="string">"qiangge@qq.com"</span>,date);</span><br><span class="line">	System.out.println(uid + <span class="string">"条数据受到影响"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通用查找（一条或多条）"><a href="#通用查找（一条或多条）" class="headerlink" title="通用查找（一条或多条）"></a><strong>通用查找（一条或多条）</strong></h4><h5 id="只查一条数据："><a href="#只查一条数据：" class="headerlink" title="只查一条数据："></a><strong>只查一条数据：</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 通用的查找 （只有一条数据）</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * Class&lt;T&gt; clazz : 运行时类的对象</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getObject</span><span class="params">(Class&lt;T&gt; clazz,String sql,Object ...objects)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3.填充数据</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">			ps.setObject(i + <span class="number">1</span>, objects[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery();</span><br><span class="line">		</span><br><span class="line">		ResultSetMetaData md = rs.getMetaData(); <span class="comment">//获取元数据。</span></span><br><span class="line">		<span class="comment">//获取列的数量</span></span><br><span class="line">		<span class="keyword">int</span> columnCount = md.getColumnCount();</span><br><span class="line">		<span class="comment">//创建对象</span></span><br><span class="line">		T t = clazz.newInstance();</span><br><span class="line">		<span class="keyword">while</span>(rs.next())&#123; <span class="comment">//遍历每一条数据</span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * 第一个问题 ： 如何获取到表的列数</span></span><br><span class="line"><span class="comment">			 * 第二个问题 ： 需要知道类中的属性</span></span><br><span class="line"><span class="comment">			 * 第三个问题 ： 对象中属性的名字怎么来</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">				<span class="comment">//获取某列的列名（如果有别名获取的是别名）</span></span><br><span class="line">				String columnLabel = md.getColumnLabel(i + <span class="number">1</span>); </span><br><span class="line">				 <span class="comment">//通过列名获取列中的数据。</span></span><br><span class="line">				Object value = rs.getObject(columnLabel);</span><br><span class="line"> </span><br><span class="line">				<span class="comment">//封装</span></span><br><span class="line">				<span class="comment">//通过反射 - 给对象中的属性进行赋值</span></span><br><span class="line">				<span class="comment">//将表中的列名当作类中的属性名。如果列名和属性名不一样，可以通过别名的方式（别名 = 属性名）</span></span><br><span class="line">				<span class="comment">//通过列名就获取到了类中的对应的属性</span></span><br><span class="line">				Field declaredField = clazz.getDeclaredField(columnLabel);</span><br><span class="line">				declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * 第一个参数 ： 是给哪个对象进行赋值</span></span><br><span class="line"><span class="comment">				 * 第二个参数 ： 属性值</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				declaredField.set(t, value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> t;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查多条数据："><a href="#查多条数据：" class="headerlink" title="查多条数据："></a><strong>查多条数据：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 通用的查找 （返回多条数据）</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getObjects</span><span class="params">(Class&lt;T&gt; clazz,String sql,Object ...objects)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1.获取数据库的连接</span></span><br><span class="line">		Connection connection = JDBCUtils.getConnection();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.预编译</span></span><br><span class="line">		PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3.填充数据</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">			ps.setObject(i + <span class="number">1</span>, objects[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4.执行sql语句</span></span><br><span class="line">		ResultSet rs = ps.executeQuery();</span><br><span class="line">		</span><br><span class="line">		ResultSetMetaData md = rs.getMetaData(); <span class="comment">//获取元数据。</span></span><br><span class="line">		<span class="comment">//获取列的数量</span></span><br><span class="line">		<span class="keyword">int</span> columnCount = md.getColumnCount();</span><br><span class="line">		<span class="comment">//创建一个集合</span></span><br><span class="line">		List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span>(rs.next())&#123; <span class="comment">//遍历每一条数据</span></span><br><span class="line">			<span class="comment">//创建对象</span></span><br><span class="line">			T t = clazz.newInstance();</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * 第一个问题 ： 如何获取到表的列数</span></span><br><span class="line"><span class="comment">			 * 第二个问题 ： 需要知道类中的属性</span></span><br><span class="line"><span class="comment">			 * 第三个问题 ： 对象中属性的名字怎么来</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">				<span class="comment">//获取某列的列名（如果有别名获取的是别名）</span></span><br><span class="line">				String columnLabel = md.getColumnLabel(i + <span class="number">1</span>); </span><br><span class="line">				 <span class="comment">//通过列名获取列中的数据。</span></span><br><span class="line">				Object value = rs.getObject(columnLabel);</span><br><span class="line"> </span><br><span class="line">				<span class="comment">//封装</span></span><br><span class="line">				<span class="comment">//通过反射 - 给对象中的属性进行赋值</span></span><br><span class="line">				<span class="comment">//将表中的列名当作类中的属性名。如果列名和属性名不一样，可以通过别名的方式（别名 = 属性名）</span></span><br><span class="line">				<span class="comment">//通过列名就获取到了类中的对应的属性</span></span><br><span class="line">				Field declaredField = clazz.getDeclaredField(columnLabel);</span><br><span class="line">				declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * 第一个参数 ： 是给哪个对象进行赋值</span></span><br><span class="line"><span class="comment">				 * 第二个参数 ： 属性值</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				declaredField.set(t, value);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//将对象放入到集合中</span></span><br><span class="line">			list.add(t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//关闭资源</span></span><br><span class="line">		JDBCUtils.close(connection, ps, rs);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试代码：-1"><a href="#测试代码：-1" class="headerlink" title="测试代码："></a><strong>测试代码：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">       String sql = <span class="string">"select id,name,email,birth from customers where id = ?"</span>;</span><br><span class="line">Customer customer = getObject(Customer<span class="class">.<span class="keyword">class</span>, <span class="title">sql</span>, 5)</span>;</span><br><span class="line">System.out.println(customer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sql = <span class="string">"select * from users where id = ?"</span>;</span><br><span class="line">User object = getObject(User<span class="class">.<span class="keyword">class</span>, <span class="title">sql</span>, 1)</span>;</span><br><span class="line">System.out.println(object);</span><br><span class="line"></span><br><span class="line">sql = <span class="string">"select * from users"</span>;</span><br><span class="line">List&lt;User&gt; users = getObjects(User<span class="class">.<span class="keyword">class</span>, <span class="title">sql</span>)</span>;</span><br><span class="line"><span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">	System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>jdbc</category>
      </categories>
      <tags>
        <tag>jdbc增删改查</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(四)GC垃圾回收</title>
    <url>/2020/03/22/JVM%EF%BC%88%E5%9B%9B%EF%BC%89GC%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
    <content><![CDATA[<h2 id="GC是什么"><a href="#GC是什么" class="headerlink" title="GC是什么"></a><strong>GC是什么</strong></h2><p> <strong>定义： 分代收集算法</strong></p>
<ul>
<li>次数上频繁收集Young区</li>
<li>次数上较少收集Old区</li>
<li>基本不动Perm区</li>
</ul>
<h2 id="GC算法总体概述"><a href="#GC算法总体概述" class="headerlink" title="GC算法总体概述"></a><strong>GC算法总体概述</strong></h2><img src="http://photo.wushaopei.com/qiniu169.png" width="80%">

<p>​    JVM在进行GC时，并非每次都对上面三个内存区域一起回收的，大部分时候回收的都是指新生代。</p>
<p>​    因此GC按照回收的区域又分了两种类型，一种是普通GC（minor GC），一种是全局GC（major GC or Full GC）</p>
<p><font color=blue>Minor GC和Full GC的区别</font></p>
<p>​    <font color=blue>普通GC（minor GC）</font>：只针对新生代区域的GC,指发生在新生代的垃圾收集动作，因为大多数Java对象存活率都不高，所以Minor GC非常频繁，一般回收速度也比较快。</p>
<p>​    <font color=blue>全局GC（major GC or Full GC）</font>：指发生在老年代的垃圾收集动作，出现了Major GC，经常会伴随至少一次的Minor GC（但并不是绝对的）。Major GC的速度一般要比Minor GC慢上10倍以上</p>
<h2 id="四种算法"><a href="#四种算法" class="headerlink" title="四种算法"></a><strong>四种算法</strong></h2><h3 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h3><img src="http://photo.wushaopei.com/qiniu170.png" width="80%">

<h4 id="Code演示："><a href="#Code演示：" class="headerlink" title="Code演示："></a><strong>Code</strong>演示：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.jvm;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**<span class="doctag">@Description</span>:-verbose:gc*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefCountGC</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">byte</span>[] bigSize = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>];<span class="comment">//这个成员属性唯一的作用就是占用一点内存</span></span><br><span class="line">  Object instance = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    RefCountGC objectA = <span class="keyword">new</span> RefCountGC();</span><br><span class="line">    RefCountGC objectB = <span class="keyword">new</span> RefCountGC();</span><br><span class="line">    objectA.instance = objectB;</span><br><span class="line">    objectB.instance = objectA;</span><br><span class="line">    objectA = <span class="keyword">null</span>;</span><br><span class="line">    objectB = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    System.gc();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复制算法-Copying"><a href="#复制算法-Copying" class="headerlink" title="复制算法(Copying)"></a>复制算法(Copying)</h3><h4 id="定义："><a href="#定义：" class="headerlink" title="定义："></a><strong>定义</strong>：</h4><p>​    年轻代中使用的是Minor GC，这种GC算法采用的是复制算法(Copying) </p>
<h4 id="原理："><a href="#原理：" class="headerlink" title="原理："></a><strong>原理</strong>：</h4><img src="http://photo.wushaopei.com/qiniu171.png" width="80%">

<p>​    Minor GC会把Eden中的所有活的对象都移到Survivor区域中，如果Survivor区中放不下，那么剩下的活的对象就被移到Old  generation中，<font color=red>也即一旦收集后，Eden是就变成空的了。</font></p>
<p>​    当对象在 Eden ( 包括一个 Survivor 区域，这里假设是 from 区域 ) 出生后，在经过一次 Minor GC 后，如果对象还存活，并且能够被另外一块 Survivor 区域所容纳( 上面已经假设为 from 区域，这里应为 to 区域，即 to 区域有足够的内存空间来存储 Eden 和 from 区域中存活的对象 )，则使用<font color=red>复制算法</font>将这些仍然还存活的对象复制到另外一块 Survivor 区域 ( 即 to 区域 ) 中，然后清理所使用过的 Eden 以及 Survivor 区域 ( 即 from 区域 )，并且将这些对象的年龄设置为1，以后对象在 Survivor 区每熬过一次 Minor GC，就将对象的年龄 + 1，当对象的年龄达到某个值时 ( 默认是 15 岁，通过-XX:MaxTenuringThreshold 来设定参数)，这些对象就会成为老年代。</p>
<p><code>-XX:MaxTenuringThreshold</code> — 设置对象在新生代中存活的次数</p>
<h4 id="动态演示："><a href="#动态演示：" class="headerlink" title="动态演示："></a><strong>动态演示：</strong></h4><p>​     在GC开始的时候，对象只会存在于Eden区和名为“From”的Survivor区，Survivor区“To”是空的。紧接着进行GC，Eden区中所有存活的对象都会被复制到“To”，而在“From”区中，仍存活的对象会根据他们的年龄值来决定去向。年龄达到一定值(年龄阈值，可以通过-XX:MaxTenuringThreshold来设置)的对象会被移动到年老代中，没有达到阈值的对象会被复制到“To”区域。<font color=red>经过这次GC后，Eden区和From区已经被清空。这个时候，“From”和“To”会交换他们的角色，也就是新的“To”就是上次GC前的“From”，新的“From”就是上次GC前的“To”。</font>不管怎样，都会保证名为To的Survivor区域是空的。Minor GC会一直重复这样的过程，直到“To”区被填满，“To”区被填满之后，会将所有对象移动到年老代中。<br><img src="http://photo.wushaopei.com/qiniu172.png" width="80%"></p>
<p>​    因为Eden区对象一般存活率较低，一般的，使用两块10%的内存作为空闲和活动区间，而另外80%的内存，则是用来给新建对象分配内存的。一旦发生GC，将10%的from活动区间与另外80%中存活的eden对象转移到10%的to空闲区间，接下来，将之前90%的内存全部释放，以此类推。 </p>
<h4 id="动态："><a href="#动态：" class="headerlink" title="动态："></a><strong>动态：</strong></h4><img src="http://photo.wushaopei.com/qiniu173.gif" width="80%">

<h4 id="劣势："><a href="#劣势：" class="headerlink" title="劣势："></a>劣势：</h4><p><code>复制算法它的缺点也是相当明显的。</code></p>
<ol>
<li>它浪费了一半的内存，这太要命了。</li>
<li>如果对象的存活率很高，我们可以极端一点，假设是100%存活，那么我们需要将所有对象都复制一遍，并将所有引用地址重置一遍。复制这一工作所花费的时间，在对象存活率达到一定程度时，将会变的不可忽视。 所以从以上描述不难看出，复制算法要想使用，<font color=blue>最起码对象的存活率要非常低才行</font>，而且最重要的是，我们必须要克服50%内存的浪费。</li>
</ol>
<h3 id="标记清除-Mark-Sweep"><a href="#标记清除-Mark-Sweep" class="headerlink" title="标记清除(Mark-Sweep)"></a>标记清除(Mark-Sweep)</h3><h4 id="定义：-1"><a href="#定义：-1" class="headerlink" title="定义："></a>定义：</h4><p>​    老年代一般是由标记清除或者是标记清除与标记整理的混合实现 </p>
<h4 id="原理：-1"><a href="#原理：-1" class="headerlink" title="原理："></a>原理：</h4><img src="http://photo.wushaopei.com/qiniu173.png" width="80%">

<p>​    当堆中的有效内存空间（available memory）被耗尽的时候，就会停止整个程序（也被称为stop the world），然后进行两项工作，第一项则是标记，第二项则是清除。</p>
<p> <strong>标记</strong>：从引用根节点开始标记所有被引用的对象。标记的过程其实就是遍历所有的GC Roots，然后将所有GC Roots可达的对象      标记为存活的对象。<br> <strong>清除：</strong>遍历整个堆，把未标记的对象清除。<br> <font color=red><strong>缺点：</strong>此算法需要暂停整个应用，会产生内存碎片</font></p>
<p>​    用通俗的话解释一下标记/清除算法，就是当程序运行期间，若可以使用的内存被耗尽的时候，GC线程就会被触发并将程序暂停，随后将依旧存活的对象标记一遍，最终再将堆中所有没被标记的对象全部清除掉，接下来便让程序恢复运行。</p>
<h4 id="动态演示"><a href="#动态演示" class="headerlink" title="动态演示"></a>动态演示</h4><p><strong>动图：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu174.gif" width="80%">

<ul>
<li>回收时,对需要存活的对象进行标记</li>
<li>回收不是绿色的对象</li>
</ul>
<h4 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h4><ol>
<li>首先，它的缺点就是效率比较低（递归与全堆对象遍历），而且在进行GC的时候，需要停止应用程序，这会导致用户体验非常差劲</li>
<li>其次，主要的缺点则是这种方式清理出来的空闲内存是不连续的，这点不难理解，我们的死亡对象都是随即的出现在内存的各个角落的，现在把它们清除之后，内存的布局自然会乱七八糟。而为了应付这一点，JVM就不得不维持一个内存的空闲列表，这又是一种开销。而且在分配数组对象的时候，寻找连续的内存空间会不太好找。</li>
</ol>
<img src="http://photo.wushaopei.com/qiniu174.png" width="80%">

<h3 id="标记压缩-Mark-Compact"><a href="#标记压缩-Mark-Compact" class="headerlink" title="标记压缩(Mark-Compact)"></a>标记压缩(Mark-Compact)</h3><h4 id="定义：-2"><a href="#定义：-2" class="headerlink" title="定义："></a>定义：</h4><p>​    <strong>老年代</strong>一般是由标记清除或者是标记清除与标记整理的混合实现 </p>
<h4 id="原理：-2"><a href="#原理：-2" class="headerlink" title="原理："></a>原理：</h4><img src="http://photo.wushaopei.com/qiniu175.png" width="80%">

<p>​    在整理压缩阶段，不再对标记的对像做回收，而是通过所有存活对像都向一端移动，然后直接清除边界以外的内存。<br>可以看到，标记的存活对象将会被整理，按照内存地址依次排列，而未被标记的内存会被清理掉。如此一来，当我们需要给新对象分配内存时，JVM只需要持有一个内存的起始地址即可，这比维护一个空闲列表显然少了许多开销。</p>
<p>​    标记/整理算法不仅可以弥补标记/清除算法当中，内存区域分散的缺点，也消除了复制算法当中，内存减半的高额代价</p>
<h4 id="劣势-1"><a href="#劣势-1" class="headerlink" title="劣势"></a>劣势</h4><p>​    <strong>标记/整理</strong>算法唯一的缺点就是效率也不高，不仅要标记所有存活对象，还要整理所有存活对象的引用地址。从效率上来说，<strong>标记/整理</strong>算法要低于复制算法。</p>
<h3 id="标记清除压缩-Mark-Sweep-Compact"><a href="#标记清除压缩-Mark-Sweep-Compact" class="headerlink" title="标记清除压缩(Mark-Sweep-Compact)"></a>标记清除压缩(Mark-Sweep-Compact)</h3><h4 id="原理：-3"><a href="#原理：-3" class="headerlink" title="原理："></a>原理：</h4><pre><code> 1. Mark-Sweep 和 Mark-Compact的结合
2. 和Mark-Sweep一致，当进行多次GC后才Compact.</code></pre><h4 id="目的："><a href="#目的：" class="headerlink" title="目的："></a>目的：</h4><p>​    减少移动对象的成本</p>
<h4 id="动态演示：-1"><a href="#动态演示：-1" class="headerlink" title="动态演示："></a>动态演示：</h4><img src="http://photo.wushaopei.com/qiniu175.gif" width="80%">



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p><strong>内存效率：</strong>    复制算法 &gt; 标记清除算法 &gt; 标记整理算法（<font color=red>此处的效率只是简单的对比时间复杂度，实际情况不一定如此</font>）。<br>内存整齐度：复制算法 = 标记整理算法 &gt; 标记清除算法。<br>内存利用率：标记整理算法 = 标记清除算法 &gt; 复制算法。</p>
<p>可以看出，效率上来说，复制算法是当之无愧的老大，但是却浪费了太多内存，而为了尽量兼顾上面所提到的三个指标，标记/整理算法相对来说更平滑一些，但效率上依然不尽如人意，它比复制算法多了一个标记的阶段，又比标记/清除多了一个整理内存的过程</p>
<h2 id="难道就没有一种最优算法吗？-猜猜看，下面还有"><a href="#难道就没有一种最优算法吗？-猜猜看，下面还有" class="headerlink" title="难道就没有一种最优算法吗？ 猜猜看，下面还有"></a><strong>难道就没有一种最优算法吗？ 猜猜看，下面还有</strong></h2><p>回答：无，没有最好的算法，只有最合适的算法。==========&gt;<font color=red>分代收集算法</font>。</p>
<p><font color=red>年轻代(Young Gen)  </font></p>
<p><font color=red>年轻代特点是区域相对老年代较小，对像存活率低。</font></p>
<p>这种情况复制算法的回收整理，速度是最快的。复制算法的效率只和当前存活对像大小有关，因而很适用于年轻代的回收。而复制算法内存利用率不高的问题，通过hotspot中的两个survivor的设计得到缓解。</p>
<p><font color=red>老年代(Tenure Gen)</font></p>
<p><font color=red>老年代的特点是区域较大，对像存活率高。</font></p>
<p>这种情况，存在大量存活率高的对像，复制算法明显变得不合适。一般是由标记清除或者是标记清除与标记整理的混合实现。</p>
<p><font color=red>Mark阶段的开销与存活对像的数量成正比</font>，这点上说来，对于老年代，标记清除或者标记整理有一些不符，但可以通过多核/线程利用，对并发、并行的形式提标记效率。</p>
<p><font color=red>Sweep阶段的开销与所管理区域的大小形正相关</font>，但Sweep“就地处决”的特点，回收的过程没有对像的移动。使其相对其它有对像移动步骤的回收算法，仍然是效率最好的。但是需要解决内存碎片问题。</p>
<p><font color=red>Compact阶段的开销与存活对像的数据成开比</font>，如上一条所描述，对于大量对像的移动是很大开销的，做为老年代的第一选择并不合适。</p>
<p>基于上面的考虑，<font color=red>老年代一般是由标记清除或者是标记清除与标记整理的混合实现。</font>以hotspot中的CMS回收器为例，CMS是基于Mark-Sweep实现的，对于对像的回收效率很高，而对于碎片问题，CMS采用基于Mark-Compact算法的Serial Old回收器做为补偿措施：当内存回收不佳（碎片导致的Concurrent Mode Failure时），将采用Serial Old执行Full GC以达到对老年代内存的整理。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>JVM</category>
        <category>Heap堆</category>
      </categories>
      <tags>
        <tag>虚拟机</tag>
        <tag>Heap堆</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-原理篇（三）SqlSession运行过程</title>
    <url>/2020/04/30/mybatis-%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%88%E4%B8%89%EF%BC%89SqlSession%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="SqlSession-运行过程"><a href="#SqlSession-运行过程" class="headerlink" title="SqlSession 运行过程"></a>SqlSession 运行过程</h2><p>​    SqlSession 的运行过程是MyBatis 中最难理解的部分。</p>
<p>​    SqlSession 是一个接口，通过构建 SqlSessionFactory 就可以拿到 SqlSession 了。 SqlSession 中给出了查询、插入、更新、删除的方法，在旧版本的 MyBatis 或 ibatis 中常常使用这些接口方法，而在新版的 MyBatis中我们使用的更多的是 Mapper。</p>
<p><code>开始分析</code></p>
<p>我们在使用Mapper时，一般是在 配置文件中指定好 Mapper 接口文件和 XML 文件的路径，然后使用如下代码获取代理对象：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>然后调用SqlSession 接口中的方法即可执行相关的 SQL 语句，下面就来具体分析一下这一执行过程。</p>
<h3 id="getMapper（）方法实现逻辑"><a href="#getMapper（）方法实现逻辑" class="headerlink" title="getMapper（）方法实现逻辑"></a>getMapper（）方法实现逻辑</h3><ul>
<li>SqlSession 类是一个接口，接口类的方法被调用时实际调用的是其实现子类，而 SqlSession 有  DefaultSqlSession  、SqlSessionManager 两个实现类，MyBatis 默认调用 DefaultSqlSession 实现类；</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> configuration.&lt;T&gt;getMapper(type, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里调用了 Configuration的getMapper 方法；</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> mapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从方法体中可以看到，getMapper 方法中调用了 MapperRegistry 类的方法 getMapper；</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is not known to the MapperRegistry."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>我们在写 XML 配置文件时注册了 Mapper，被注册的 Mapper 就被维护在 MapperRegistry 的一个 HashMap 中，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt;();</span><br></pre></td></tr></table></figure>

<p>map 的 key  是Class 类，value 是对应的一个代理工厂 MapperProxyFactory，用来生产对应的代理类，如果 key 没有对应的 value，会抛出异常，告诉我们并没有去注册这个 Mapper，这时候就需要去检查配置文件了。</p>
<p>进入前面的 newInstance() 方法去看看;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">   <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>从上述代码中，可以得知， newInstance 方法中的 MapperProxy类是一个代理类，具体代理方式通过该类是否实现 InvocationHandler 可以得知：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6424540398559729838L</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperProxy</span><span class="params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sqlSession = sqlSession;</span><br><span class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">    <span class="keyword">this</span>.methodCache = methodCache;</span><br><span class="line">  &#125;</span><br><span class="line">  。。。。。。。</span><br></pre></td></tr></table></figure>

<p>从 MapperProxy 类实现了 InvocationHandler 接口可以确定，它是 基于 JDK 动态代理的。</p>
<ul>
<li>这里进入 <code>return newInstance(mapperProxy);</code>  的 newInstance 方法，</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"> <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>从上述代码可以得知，调用 Proxy.newProxyInstance 方法产生代理对象。</p>
<p>由上述的分析，我们可以知道，Mapper 映射是通过 动态代理来实现的。</p>
<h3 id="映射器的动态代理"><a href="#映射器的动态代理" class="headerlink" title="映射器的动态代理"></a>映射器的动态代理</h3><p>Mapper 映射是通过动态代理来实现的，其具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Lasse Voss</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxyFactory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们可以看到动态代理对接口的绑定，它的作用就是生成动态代理对象（占位）。而代理的方法则被放到了 MapperProxy 类中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6424540398559729838L</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperProxy</span><span class="params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sqlSession = sqlSession;</span><br><span class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">    <span class="keyword">this</span>.methodCache = methodCache;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> MapperMethod <span class="title">cachedMapperMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">    MapperMethod mapperMethod = methodCache.get(method);</span><br><span class="line">    <span class="keyword">if</span> (mapperMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">      mapperMethod = <span class="keyword">new</span> MapperMethod(mapperInterface, method, sqlSession.getConfiguration());</span><br><span class="line">      methodCache.put(method, mapperMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mapperMethod;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面运用了 invoke 方法，一旦 mapper 是一个代理对象，那么它就会运行到 invoke 方法里面，invoke 首先判断它是否是一个类，显然这里 Mapper 是一个接口不是类，所以判定失败。那么就会生成 MapperMethod 对象，它是通过 cachedMapperMethod 方法对其初始化的，然后执行execute 方法，把 sqlSession 和当前运行的参数传递进去。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">switch</span> (command.getType()) &#123;</span><br><span class="line">      <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">    	Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SELECT:</span><br><span class="line">        <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123;</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Mapper method '"</span> + command.getName() </span><br><span class="line">          + <span class="string">" attempted to return null from a method with a primitive return type ("</span> + method.getReturnType() + <span class="string">")."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">...............</span><br><span class="line">    <span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">executeForMany</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    List&lt;E&gt; result;</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    <span class="keyword">if</span> (method.hasRowBounds()) &#123;</span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">      result = sqlSession.&lt;E&gt;selectList(command.getName(), param, rowBounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = sqlSession.&lt;E&gt;selectList(command.getName(), param);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// issue #510 Collections &amp; arrays support</span></span><br><span class="line">    <span class="keyword">if</span> (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (method.getReturnType().isArray()) &#123;</span><br><span class="line">        <span class="keyword">return</span> convertToArray(result);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> convertToDeclaredCollection(sqlSession.getConfiguration(), result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">	....</span><br></pre></td></tr></table></figure>

<p>​    从上述源码中可以看出，MapperMethod 采用命令模式运行，根据上下文跳转，它可能跳转到许多方法中。</p>
<p>​    通过 executeForMany 方法，我们可以看到它的实现方法是，在最后通过 sqlSession 对象去运行对象的 SQL。</p>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><p>​     MyBatis 之所以只用 Mapper 接口便能够运行 SQL，因为映射器的 XML 文件的命名空间对应的便是这个接口的全路径，那么它根据全路径和方法名便能够绑定起来，通过动态代理技术，让这个接口跑起来。</p>
<p>​    而后采用命令模式，最后还是使用 SqlSession 接口的方法使得它能够执行查询，有了这层封装我们便可以使用接口编程，让编程更简单。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>mybatis原理</tag>
        <tag>SqlSession</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 入门（六）实例</title>
    <url>/2020/04/03/mybatis-%E5%85%A5%E9%97%A8%EF%BC%88%E5%85%AD%EF%BC%89%E5%AE%9E%E4%BE%8B/</url>
    <content><![CDATA[<p>这里做一个实例，它可以使我们熟悉MyBatis 主要组件的用法。我们需要满足MyBatis各个组件的生命周期。首先需要生成SqlSessionFactory单例，然后让它生成SqlSession，进而拿到映射器来完成我们的业务逻辑。</p>
<p>​    确定文件所需要放置的路径，以便在上下文中读取配置文件。</p>
<img src="http://photo.wushaopei.com/qiniu274.png" width="40%">

<p>各个实例文件的作用，如表所示：</p>
<table>
<thead>
<tr>
<th align="center">文件</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">User.java</td>
<td align="center">POJO类，符合javaBean的规范</td>
</tr>
<tr>
<td align="center">UserMapper.java</td>
<td align="center">映射器</td>
</tr>
<tr>
<td align="center">UserMapper.xml</td>
<td align="center">映射器配置文件</td>
</tr>
<tr>
<td align="center">SqlSessionFactoryUtil.java</td>
<td align="center">构建SqlSessionFactory,并创建SqlSession</td>
</tr>
<tr>
<td align="center">testMain.java</td>
<td align="center">运行MyBatis入门程序的入口，包含main方法</td>
</tr>
<tr>
<td align="center">log4j.properties</td>
<td align="center">配置log4j的属性文件</td>
</tr>
<tr>
<td align="center">mybatis-config.xml</td>
<td align="center">MyBatis的配置文件</td>
</tr>
</tbody></table>
<p>首先配置log4j 的配置文件，具体代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># Global logging configuration</span><br><span class="line">log4j.rootLogger=DEBUG, stdout</span><br><span class="line"># Console output...</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%<span class="number">5</span>p [%t] - %m%n</span><br></pre></td></tr></table></figure>

<p>其次，构建SessionFactory，这里主要配置MyBatis 的数据库连接、事务管理等等。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3333/mybatis?characterEncoding=utf8<span class="symbol">&amp;amp;</span>serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/webcode/cn/mapper/UserMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最后，构建SqlSessionFactory，并且给出创建SqlSession的方法，这里我们利用配置文件 mybatis-config.xml 完成 SqlSessionFactory的构建。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Level;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SqlSessionFactoryUtil.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月7日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryUtil</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// SqlSessionFactory对象</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 类线程锁</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class CLASS_LOCK = SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 私有化构造参数 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtil</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构建SqlSessionFactory </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">initSqlSessionFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">		String resource = <span class="string">"mybatis-config.xml"</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">		&#125;<span class="keyword">catch</span> (IOException ex)&#123;</span><br><span class="line">			Logger.getLogger(SqlSessionFactoryUtil<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()).<span class="title">log</span>(<span class="title">Level</span>.<span class="title">SEVERE</span>,<span class="title">null</span>,<span class="title">ex</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">synchronized</span>(CLASS_LOCK)&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 打开 SqlSession </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title">openSqlSession</span> <span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">			initSqlSessionFactory();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如生命周期中的描述一样，我们希望SqlSessionFactory 对于一个数据库而言只有一个实例，所以我们希望它是单例的。</p>
<p><strong>SqlSessionFactory 单例的实现：</strong> </p>
<p>​    主要通过方法initSqlSessionFactory实现。首先，将构造方法私有化，避免使用者通过构造器多次创建对象。然后对类SqlSessionFactoryUtil进行加锁，避免多线程环境中可能存在的多次初始化对象的问题。</p>
<p>​    给出一个公共的静态方法对外开放，让其返回唯一单例。当多线程环境下，initSqlSessionFactory方法会因为添加了线程锁而避免类对象被多次初始化。</p>
<p>定义一个POJO类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> User.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月5日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String lastName;</span><br><span class="line">	<span class="keyword">private</span> Integer sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写映射器文件，如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">  PUBLIC <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line">  <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  		namespace名称空间</span><br><span class="line">  		取值一般有两种情况：</span><br><span class="line">  			一种情况是：使用javaBean的全类名</span><br><span class="line">  			二种情况是：使用Mapper接口的全类名</span><br><span class="line">   --&gt;</span><br><span class="line"> &lt;mapper namespace=<span class="string">"com.webcode.cn.mapper.UserMapper"</span>&gt; </span><br><span class="line"> &lt;!--   &lt;mapper namespace=<span class="string">"com.webcode.cn.entity.User"</span>&gt;	--&gt;</span><br><span class="line">  &lt;!-- </span><br><span class="line">  	select标签用来配置一个select语句</span><br><span class="line">  		id 用来配置一个唯一的标识</span><br><span class="line">  		resultType 是查询完之后一条记录对应转换成为的javaBean对象</span><br><span class="line">  		#&#123;id&#125;是点位符</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;select id=<span class="string">"selectUserById"</span> resultType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">    	select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line">  &lt;!-- 查询全部的User对象 --&gt;</span><br><span class="line">  &lt;select id=<span class="string">"queryUsers"</span> resultType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">  		select id,last_name lastName,sex from t_user</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;!--   parameterType 参数类型（可选） --&gt;</span><br><span class="line">  &lt;insert id=<span class="string">"saveUser"</span> parameterType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">  		<span class="function">insert into <span class="title">t_user</span><span class="params">(`last_name`,`sex`)</span> <span class="title">values</span><span class="params">(#&#123;lastName&#125;,#&#123;sex&#125;)</span></span></span><br><span class="line"><span class="function">  &lt;/insert&gt;</span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">  &lt;!--   根据id删除一个用户 --&gt;</span></span><br><span class="line"><span class="function">  &lt;delete id</span>=<span class="string">"deleteUserById"</span> parameterType=<span class="string">"int"</span>&gt;</span><br><span class="line">  		delete from t_user where id = #&#123;id&#125;</span><br><span class="line">  &lt;/delete&gt;</span><br><span class="line">  </span><br><span class="line">   &lt;update id=<span class="string">"updateUser"</span> parameterType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">  		update t_user set last_name = #&#123;lastName&#125;,sex = #&#123;sex&#125; where id = #&#123;id&#125;</span><br><span class="line">  &lt;/update&gt;</span><br><span class="line">  </span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<p>这里定义了五条SQL，它们的作用有五个。</p>
<ul>
<li>根据Id查询用户</li>
<li>查询所有的用户</li>
<li>插入用户</li>
<li>删除用户</li>
<li>根据用户ID修改用户</li>
</ul>
<p>定义一个Mapper接口，接口的方法名和XML映射文件的id保持一致，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserMapper.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月5日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">selectUserById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUsers</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">saveUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们根据提供的方法和映射器，根据映射规则使用SQL进行对User的CRUD操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.cn.testMain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.webcode.cn.util.SqlSessionFactoryUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> testMain.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月7日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span> <span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">			UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			User user = <span class="keyword">new</span> User();</span><br><span class="line">			user.setLastName(<span class="string">"tom"</span>);</span><br><span class="line">			user.setSex(<span class="number">1</span>);</span><br><span class="line">			userMapper.saveUser(user);</span><br><span class="line">			userMapper.deleteUserById(<span class="number">1</span>);</span><br><span class="line">			userMapper.updateUser(<span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"jetty"</span>,<span class="number">1</span>));</span><br><span class="line">			sqlSession.commit();			</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			System.err.println(ex.getMessage());</span><br><span class="line">			sqlSession.rollback();</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSession.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用Java Application的形式启动运行testMain.java,打印结果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Logging initialized using <span class="string">'class org.apache.ibatis.logging.log4j.Log4jImpl'</span> adapter.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection <span class="number">1449263511</span>.</span><br><span class="line">DEBUG [main] - Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_user</span><span class="params">(`last_name`,`sex`)</span> <span class="title">values</span><span class="params">(?,?)</span> </span></span><br><span class="line"><span class="function">DEBUG [main] - </span>==&gt; Parameters: tom(String), <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">1</span></span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: delete from t_user where id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">0</span></span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: update t_user set last_name = ?,sex = ? where id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: jetty(String), <span class="number">1</span>(Integer), <span class="number">2</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==    Updates: <span class="number">1</span></span><br><span class="line">DEBUG [main] - Committing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">56620197</span>]</span><br><span class="line">DEBUG [main] - Returned connection <span class="number">1449263511</span> to pool.</span><br></pre></td></tr></table></figure>

<p>这里Log4j为我们打印出来Mybatis的运行轨迹，以及最为重要的运行的SQL和参数。我们可以根据这些信息对发生异常的情况进行分析排错。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>入门</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-原理篇（二）构建SqlSessionFactory过程</title>
    <url>/2020/04/30/mybatis-%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%88%E4%BA%8C%EF%BC%89%E6%9E%84%E5%BB%BASqlSessionFactory%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="构建-SqlSessionFactory-过程"><a href="#构建-SqlSessionFactory-过程" class="headerlink" title="构建 SqlSessionFactory 过程"></a>构建 SqlSessionFactory 过程</h2><pre><code>SqlSessionFactory 是 MyBatis 的核心类之一，其最重要哦的功能就是提供创建 MyBatis 的核心接口 SqlSession, 所以我们需要先创建 SqlSessionFactory ，为此我们需要提供配置文件和相关的参数。而 MyBatis 是一个复杂的系统，采用构造模式去 创建 SqlSessionFactory，我们可以通过 SqlSessionFactoryBuilder 去构建。构建分为两步。</code></pre><p>​    第一步，通过 org.apache.ibatis.builder.xml.XMLConfigBuilder 解析配置的 XML 文件，读出配置参数，并将读取的数据存入这个 org.apache.ibatis.session.Configuration 类中。注意，MyBatis 几乎所有的配置都是存在这里的。</p>
<p>​    第二步，使用Configuration对象去创建SqlSessionFactory 。MyBatis中的 SqlSessionFactory是一个接口，而不是实现类，为此 MyBatis 提供了一个默认的 SqlSessionFactory 实现类，我们一般都会使用它 org.apache.ibatis.session.default.DefaultSqlSessionFactory。注意，在大部分情况下我们都没有必要自己去创建新的 SqlSessionFactory 的实现类。</p>
<h3 id="构建-Configuration"><a href="#构建-Configuration" class="headerlink" title="构建 Configuration"></a>构建 Configuration</h3><p>在 SqlSessionFactory 构建中， Configuration 是最重要的，它的作用如下 。</p>
<ul>
<li>读入配置文件，包括基础配置的 XML 文件和映射器的 XML 文件</li>
<li>初始化基础配置，比如 MyBatis 的别名等，一些重要的类对象，例如，插件、映射器、 ObjectFactory 和 typeHandler 对象。</li>
<li>提供单例，为后续创建 SessionFactory 服务并提供配置的参数。</li>
<li>执行一些重要的对象方法，初始化配置信息。</li>
</ul>
<p>以上的第一第二两点我们可以从源码中去发现并解读：</p>
<p>已知，创建一个 SqlSessionFactory 的 过程如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br></pre></td></tr></table></figure>

<p>点击进入SqlSessionFactoryBuilder 类中，默认调用如下的 build(inputStream)方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> build(inputStream, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法具体调用的实现返回 Factory 的类方法为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(InputStream inputStream, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">      <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error building SqlSession."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        inputStream.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// Intentionally ignore. Prefer previous error.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在前面的分析中，我们知道了 Configuration 是通过 XMLConfigBuilder 去构建的。在获得 XMLConfigBuilder 实例对象后会执行 build 方法，而在该方法中则会先用 XMLConfigBuiler 实例调用 parser.parse()方法，并将该方法的结果中获取的一些参数用来创建 Session ，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSqlSessionFactory</span> <span class="keyword">implements</span> <span class="title">SqlSessionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DefaultSqlSessionFactory</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.configuration = configuration;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SqlSession <span class="title">openSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> openSessionFromDataSource(configuration.getDefaultExecutorType(), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  。。。。。。。。。。</span><br></pre></td></tr></table></figure>

<p>在上述的源码中，通过从传入的 Configuration 中获取 getDefaultExecutorType() 的参数配置，从而实现创建 SqlSession ；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SqlSession <span class="title">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span> </span>&#123;</span><br><span class="line">    Transaction tx = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> Environment environment = configuration.getEnvironment();</span><br><span class="line">      <span class="keyword">final</span> TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">      <span class="keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error opening session.  Cause: "</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>以上是其中一个 创建 SqlSession 的 openSession（）方法，该方法通过Configuration 、level（事务相关参数）、autoCommit （是否开启事务）来创建 连接会话并配置会话的事务属性。</p>
<p>parser.parse() 方法配置 Configuration :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> build(parser.parse());</span><br></pre></td></tr></table></figure>

<p>进入parse()方法中, 我们可以看到 这里 通过evalNode（path）传入了路径为 “/configuration”的配置信息；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Configuration <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Each XMLConfigBuilder can only be used once."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed = <span class="keyword">true</span>;</span><br><span class="line">  parseConfiguration(parser.evalNode(<span class="string">"/configuration"</span>));</span><br><span class="line">  <span class="keyword">return</span> configuration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="读取XML配置文件信息"><a href="#读取XML配置文件信息" class="headerlink" title="读取XML配置文件信息"></a>读取XML配置文件信息</h4><p>进入 evalNode(String expression)方法读取配置信息；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> XNode <span class="title">evalNode</span><span class="params">(Object root, String expression)</span> </span>&#123;</span><br><span class="line">    Node node = (Node) evaluate(expression, root, XPathConstants.NODE);</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> XNode(<span class="keyword">this</span>, node, variables);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Object <span class="title">evaluate</span><span class="params">(String expression, Object root, QName returnType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> xpath.evaluate(expression, root, returnType);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error evaluating XPath.  Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>通过上述的源码，我们可以知道 MyBatis 中如何读取到配置参数的方法，该方法通过 XPath 在 XML 文档中查找特定信息，并进行封装经处理后通过 parseConfiguration (XNode root) 方法配置到要创建的 SqlSessionFactory 中；</p>
<h4 id="初始化配置与重要对象"><a href="#初始化配置与重要对象" class="headerlink" title="初始化配置与重要对象"></a>初始化配置与重要对象</h4><p>进入其中的  parseConfiguration(XNode root) 方法中；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConfiguration</span><span class="params">(XNode root)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Properties settings = settingsAsPropertiess(root.evalNode(<span class="string">"settings"</span>));</span><br><span class="line">    <span class="comment">//issue #117 read properties first</span></span><br><span class="line">    propertiesElement(root.evalNode(<span class="string">"properties"</span>));</span><br><span class="line">    loadCustomVfs(settings);</span><br><span class="line">    typeAliasesElement(root.evalNode(<span class="string">"typeAliases"</span>));</span><br><span class="line">    pluginElement(root.evalNode(<span class="string">"plugins"</span>));</span><br><span class="line">    objectFactoryElement(root.evalNode(<span class="string">"objectFactory"</span>));</span><br><span class="line">    objectWrapperFactoryElement(root.evalNode(<span class="string">"objectWrapperFactory"</span>));</span><br><span class="line">    reflectorFactoryElement(root.evalNode(<span class="string">"reflectorFactory"</span>));</span><br><span class="line">    settingsElement(settings);</span><br><span class="line">    <span class="comment">// read it after objectFactory and objectWrapperFactory issue #631</span></span><br><span class="line">    environmentsElement(root.evalNode(<span class="string">"environments"</span>));</span><br><span class="line">    databaseIdProviderElement(root.evalNode(<span class="string">"databaseIdProvider"</span>));</span><br><span class="line">    typeHandlerElement(root.evalNode(<span class="string">"typeHandlers"</span>));</span><br><span class="line">    mapperElement(root.evalNode(<span class="string">"mappers"</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error parsing SQL Mapper Configuration. Cause: "</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在以上的 源码中通过读取到的数据初始化基础配置和重要的类对象，比如Mybatis 别名、映射器、ObjectFactory 和 typeHandler 对象等 ；参数列表如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>properties</td>
<td>全局参数</td>
</tr>
<tr>
<td>settings</td>
<td>设置</td>
</tr>
<tr>
<td>typeAliases</td>
<td>别名</td>
</tr>
<tr>
<td>typeHandler</td>
<td>类型处理器</td>
</tr>
<tr>
<td>ObjectFactory</td>
<td>对象</td>
</tr>
<tr>
<td>plugin</td>
<td>插件</td>
</tr>
<tr>
<td>environment</td>
<td>环境</td>
</tr>
<tr>
<td>DatabaseIdProvider</td>
<td>数据库标识</td>
</tr>
<tr>
<td>Mapper</td>
<td>映射器</td>
</tr>
</tbody></table>
<h4 id="Configuration-提供单例"><a href="#Configuration-提供单例" class="headerlink" title="Configuration 提供单例"></a>Configuration 提供单例</h4><blockquote>
<p>为后续创建 SessionFactory 服务并提供配置参数 </p>
</blockquote>
<p>在 SqlSessionFactory接口的实现类 DefaultSqlSessionFactory 类中 将 Configuration 单例化，从而为后续创建 SessionFactory 服务并提供配置参数。 </p>
<p>具体参考 DefaultSqlSessionFactory.java 类中对 Configuration 的实例化。</p>
<h3 id="映射器的内部组成"><a href="#映射器的内部组成" class="headerlink" title="映射器的内部组成"></a>映射器的内部组成</h3><ul>
<li>MappedStatement，他保存映射器的节点(select | insert | delete | update)，和SQL 语句、缓存、resultMap、parameterType、resultType</li>
<li>SqlSource，它是提供 BoundSql 对象的地方，他是 MappedStatement 的一个属性</li>
<li>BoundSql，他是建立 SQL 和参数的地方。3个常用属性：SQL、parameterObject、parameterMappings</li>
</ul>
<p>对于参数和SQL主要适用对象是 BoundSql 对象。</p>
<ul>
<li>parameterObject 是参数本身，我们可以传递POJO、Map、简单对象、@Param等</li>
<li>传递简单对象（int/String/float/double），mybatis会将其转换成为包装对象。比如我们传递一个 int 他会把参数转换成 Integer 对象</li>
<li>如果传递的是 POJO 或者 Map 那么 parameterObject  就是你传入的 POJO 或者 Map不变。</li>
<li>传递多个参数，没有使用 @Param 那么 mybatis会把 parameterObject  变为一个 Map&lt;String,  Object&gt;  对象，其键值的关系是按照顺序来的，类似于{“1”:p1,”2”:p2…,”param1”:p1,”param2”:p2…}，所以在编写SQL的时候可以使用#{param1}  或 #{1} 去引用参数</li>
<li>传递多个参数，并使用 @Param 注解， mybatis会把 parameterObject  变为一个 Map&lt;String,  Object&gt; 对象，只是把键值换成了 @Param 注解的值。比如，@Param(“key1”) String  p1, @Param(“key2”) String p2，那么这个 parameterObject   对象就是{“key1”:p1,”key2”:p2}</li>
</ul>
<h3 id="构建-SqlSessionFactory"><a href="#构建-SqlSessionFactory" class="headerlink" title="构建 SqlSessionFactory"></a>构建 SqlSessionFactory</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputstream)</span><br></pre></td></tr></table></figure>

<pre><code>MyBatis 会根据 Configuration  的配置读取所配置的信息，构建 SqlSessionFactory 对象。</code></pre><h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>mybatis原理</tag>
        <tag>Configuration</tag>
        <tag>SqlSessionFactory</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-原理篇（一）前置知识点： 反射与动态代理</title>
    <url>/2020/04/30/mybatis-%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%88%E4%B8%80%EF%BC%89%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A-%E5%8F%8D%E5%B0%84%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h2 id="MyBatis-重要结构："><a href="#MyBatis-重要结构：" class="headerlink" title="MyBatis 重要结构："></a>MyBatis 重要结构：</h2><p>​    MyBatis 的运行分为两大部分，第一部分是读取配置文件缓存到 Configuration 对象用以创建 SqlSessionFactory，第二部分是 SqlSession 的执行过程。相对而言， SqlSessionFactory 的创建比较容易理解，而 SqlSession的执行过程就比较复杂了。</p>
<p>​    无论是哪一部分，都或多或少的涉及到了 反射技术和动态代理技术，这里会先将反射和动态代理技术进行简单扼要的举例分析。</p>
<h2 id="反射技术"><a href="#反射技术" class="headerlink" title="反射技术"></a>反射技术</h2><p>在 Java 中，反射技术已经应用到了方方面面，并且根据 jdk 版本的不断更新，其性能不断优化， Java  的可配置性等性能得到了巨大的提高。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ReflectService.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年4月30日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 服务方法</span></span><br><span class="line"><span class="comment">	 * @param name -- 姓名</span></span><br><span class="line"><span class="comment">	 * */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"hello"</span> + name);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 测试入口</span></span><br><span class="line"><span class="comment">	 * @param args</span></span><br><span class="line"><span class="comment">	 * */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		<span class="comment">// 通过反射创建 ReflectService 对象</span></span><br><span class="line">		Object service = Class.forName(ReflectService<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()).<span class="title">newInstance</span>()</span>;</span><br><span class="line">		<span class="comment">// 获取服务方法 -- sayHello</span></span><br><span class="line">		Method method = service.getClass().getMethod(<span class="string">"sayHello"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 反射调用方法</span></span><br><span class="line">		method.invoke(service, <span class="string">"zhangsan"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这段代码通过反射技术去创建 ReflectService 对象，获取方法后通过反射调用。</p>
<p>​    反射调用的最大好处是配置性大大提高，就如同 SpringIOC容器一样，我们可以给很多配置设置参数，使得 Java 应用程序能够顺利运行起来，大大提高了 Java 灵活性和可配置性，降低模块之间的耦合。</p>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>​    在 MyBatis 中，映射器对应的接口 Mapper 接口，其本身不是一个包含具体业务逻辑的实体类。那么，在使用 Mapper 实现映射调用 映射器 .xml 文件关联 CRUD 时是不能由它自己去执行的。</p>
<p>​    下面上一个截图：</p>
<img src="http://photo.wushaopei.com/qiniu561.png" width="60%">

<p>​    由上面的图中，可以看出， userMapper 在执行过程中存在 MapperProxy ；再结合前面 Mapper 接口不能自己实现具体功能的问题。可以假设， 该 Mapper 接口产生了代理类，而该代理类由 MyBatis 为我们创建出来，也就是说 该功能的实现是基于动态代理（在运行时创建代理类）模式的使用。</p>
<h4 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h4><p><strong>什么是代理模式？</strong></p>
<blockquote>
<p>所谓的 代理模式，就是代理模式给某一个对象提供一个代理对象,并由代理对象控制对原对象的引用。 </p>
</blockquote>
<p>通俗一点的理解，就是 买火车票不一定在火车站买，也可以去代售点。这里的火车站对代售点的授权相当于给代售点开放了一个接口，代售点在实现接口功能后，可以由代售点去调用具体的 买票、退票、取票功能。而这过程中，买票的人只需要关注代售点是否还有票等问题，不需要去关心火车站在哪里或者乘客有多少的问题。</p>
<p><strong>为什么使用代理模式？</strong></p>
<blockquote>
<p>通过代理，一方面可以控制如何访问真正的服务对象，提供额外服务。另一方面有机会通过重写一些类来满足特定的需要。比如客服代理工程师与客户进行业务交互，可以根据客服本身的职能将某些服务提供给客户，而这部分需求并不需要经过工程师的裁决或决定。</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu562.png" width="60%">

<p>​    常见的动态代理有两种，一种是 JDK 反射机制提供的代理，另一种是 CGLIB 代理。<code>在 JDK 提供的代理，我们必须要提供接口；而 CGLIB 则不需要提供接口。</code></p>
<h3 id="JDK-动态代理"><a href="#JDK-动态代理" class="headerlink" title="JDK 动态代理"></a>JDK 动态代理</h3><p>​    JDK 的动态代理，是由 JDK 的 java.lang.reflect.* 包提供支持的，我们需要完成这么几个步骤。</p>
<ul>
<li>编写服务类和接口，这个是真正的服务提供者，在 JDK 代理中接口是必须的</li>
<li>编写代理类，提供绑定和代理方法。</li>
</ul>
<p>​     JDK 的代理最大的缺点是需要提供接口，而 MyBatis 的 Mapper 就是一个接口，它采用的就是JDK 的动态代理。我们先提供一个服务接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，写一个实现类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.err.println(<span class="string">"hello"</span> + name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们写一个代理类，提供真实对象的绑定和代理方法。代理类的要求是实现 InvocationHandler 接口的代理方法，当一个对象被绑定后，执行其方法的时候就会进入到代理方法里，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 真是服务对象</span></span><br><span class="line"><span class="comment">	 * */</span></span><br><span class="line">	<span class="keyword">private</span> Object target;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 绑定委托对象并返回一个代理类</span></span><br><span class="line"><span class="comment">	 * @param target </span></span><br><span class="line"><span class="comment">	 * @return </span></span><br><span class="line"><span class="comment">	 * */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">bind</span><span class="params">(Object target)</span></span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">this</span>.target = target;</span><br><span class="line">		<span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), <span class="keyword">this</span>); <span class="comment">//  jdk 代理需要提供接口</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 通过代理对象调用方法首先进入这个方法</span></span><br><span class="line"><span class="comment">	 * @param proxy -- 代理对象</span></span><br><span class="line"><span class="comment">	 * @param method -- 调用方法</span></span><br><span class="line"><span class="comment">	 * @param args -- 方法的参数</span></span><br><span class="line"><span class="comment">	 * */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		</span><br><span class="line">		System.err.println(<span class="string">"####### 我是JDK动态代理 ######"</span>);</span><br><span class="line">		Object result = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">// 反射方法前调用</span></span><br><span class="line">		System.err.println(<span class="string">"我准备说 hello . "</span>);</span><br><span class="line">		<span class="comment">// 执行方法，相当于调用 HelloServiceImpl 类的 sayHello 方法</span></span><br><span class="line">		result = method.invoke(target, args);</span><br><span class="line">		<span class="comment">// 反射方法后调用 </span></span><br><span class="line">		System.err.println(<span class="string">"我说过 hello 了"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> result;		</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分析重要代码段：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>

<p>​    上面这段代码让 JDK 产生一个代理对象。这个代理对象有三个参数： 第一个参数 target.getClass().getClassLoader() 是类加载器，第二个参数 target.getClass().getInterface() 是接口（代理对象挂在哪个接口下），第三个参数 this 代表当前 HelloServiceProxy 类，换句话说是使用 HelloServiceProxy 的代理方法作为对象的代理执行者。</p>
<p>​    一旦绑定后，在进入代理对象方法调用的时候就会到 HelloServiceProxy 的代理方法上，代理方法有三个参数：  第一个 proxy 是代理对象，第二个是当前调用的那个方法，第三个是方法的参数。比方说，现在 HelloServiceImpl 对象（obj）用 bind 方法绑定后，返回其占位，我们再调用 proxy.sayHello(“张三”)，那么它就会进入到 HelloServiceProxy 的invoke() 方法。而 invoke 参数中第一个便是代理对象 proxy , 方法便是 sayHello , 参数是张三。</p>
<p>​    我们已经用 HelloServiceProxy 类的属性 target 保存了真实的服务对象，那么我们可以通过反射技术调度真实对象的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">result = method.invoke(target, args);</span><br></pre></td></tr></table></figure>

<p>​    这里我们演示了 JDK 动态代理的实现，并且在调用方法前后都可以加入我们想要的东西。 MyBatis 在使用 Mapper的时候也是这样做的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		</span><br><span class="line">		HelloServiceProxy HelloHandler = <span class="keyword">new</span> HelloServiceProxy();</span><br><span class="line">		HelloService proxy = (HelloService)HelloHandler.bind(<span class="keyword">new</span> HelloServiceImpl());</span><br><span class="line">		</span><br><span class="line">		proxy.sayHello(<span class="string">"张三"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>执行 main 方法，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">####### 我是JDK动态代理 ######</span><br><span class="line">我准备说 hello . </span><br><span class="line">hello张三</span><br><span class="line">我说过 hello 了</span><br></pre></td></tr></table></figure>

<h3 id="CGLIB-动态代理"><a href="#CGLIB-动态代理" class="headerlink" title="CGLIB 动态代理"></a>CGLIB 动态代理</h3><p>​    JDK 提供的动态代理存在一个缺陷，就是你必须提供接口才可以使用，为了克服这个缺陷，我们可以使用开源框架—— CGLIB ，它是一种流行的动态代理。</p>
<p>​    CGLIB  动态代理是针对代理的类, 动态生成一个子类, 然后子类覆盖代理类中的方法, 如果是private或是final类修饰的方法,则不会被重写。 </p>
<p>​    CGLIB是一个功能强大，高性能的代码生成包。它为没有实现接口的类提供代理，为JDK的动态代理提供了很好的补充。通常可以使用Java的动态代理创建代理，但当要代理的类没有实现接口或者为了更好的性能，CGLIB是一个好的选择。</p>
<p>CGLIB作为一个开源项目，其代码托管在github，地址为：<a href="https://github.com/cglib/cglib" target="_blank" rel="noopener">https://github.com/cglib/cglib</a></p>
<h5 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h5><p>需要代理的类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Engineer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 可以被代理</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"工程师正在吃饭"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// final 方法不会被生成的字类覆盖</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"工程师正在工作"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private 方法不会被生成的字类覆盖</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"this engineer is playing game"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>CGLIB 代理类:</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CglibProxy</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"###   before invocation"</span>);</span><br><span class="line">        Object result = method.invoke(target, objects);</span><br><span class="line">        System.out.println(<span class="string">"###   end invocation"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProxy</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        <span class="comment">// 设置需要代理的对象</span></span><br><span class="line">        enhancer.setSuperclass(target.getClass());</span><br><span class="line">        <span class="comment">// 设置代理人</span></span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> CglibProxy(target));</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试方法:</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibMainTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 生成 Cglib 代理类</span></span><br><span class="line">        Engineer engineerProxy = (Engineer) CglibProxy.getProxy(<span class="keyword">new</span> Engineer());</span><br><span class="line">        <span class="comment">// 调用相关方法</span></span><br><span class="line">        engineerProxy.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行结果:</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">###   before invocation</span><br><span class="line">工程师正在吃饭</span><br><span class="line">###   end invocation</span><br></pre></td></tr></table></figure>

<p>在 MyBatis 中通常在延迟加载的时候才会用到 CGLIB 的动态代理。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>mybatis原理</tag>
        <tag>反射</tag>
        <tag>动态代理</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（九）参数</title>
    <url>/2020/04/23/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%B9%9D%EF%BC%89%E5%8F%82%E6%95%B0/</url>
    <content><![CDATA[<h3 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h3><p>之前见到的所有语句都使用了简单的参数形式。但实际上，参数是 MyBatis 非常强大的元素。对于大多数简单的使用场景，你都不需要使用复杂的参数，比如： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserById"</span> <span class="attr">resultMap</span>=<span class="string">"userResultMap"</span>&gt;</span></span><br><span class="line">   	select id,last_name,sex from t_user where id = #&#123;id&#125;</span><br><span class="line"> <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面的这个示例说明了一个非常简单的命名参数映射。鉴于参数类型（parameterType）会被自动设置为 <code>int</code>，这个参数可以随意命名。原始类型或简单数据类型（比如 <code>Integer</code> 和 <code>String</code>）因为没有其它属性，会用它们的值来作为参数。 然而，如果传入一个复杂的对象，行为就会有点不一样了。比如： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--   parameterType 参数类型（可选） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"saveUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span></span><br><span class="line">		insert into t_user(id,`last_name`,`sex`) values(#&#123;id&#125;,#&#123;lastName&#125;,#&#123;sex&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​           如果 User 类型的参数对象传递到了语句中，会查找 id、username 和 password           属性，然后将它们的值传入预处理语句的参数中。         </p>
<p>​           对传递语句参数来说，这种方式真是干脆利落。不过参数映射的功能远不止于此。         </p>
<p>​           首先，和 MyBatis 的其它部分一样，参数也可以指定一个特殊的数据类型。         </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br></pre></td></tr></table></figure>

<p>和 MyBatis 的其它部分一样，几乎总是可以根据参数对象的类型确定 javaType，除非该对象是一个 <code>HashMap</code>。这个时候，你需要显式指定 <code>javaType</code> 来确保正确的类型处理器（<code>TypeHandler</code>）被使用。 </p>
<p>提示 JDBC 要求，如果一个列允许使用 null 值，并且会使用值为 null 的参数，就必须要指定 JDBC 类型（jdbcType）。阅读 <code>PreparedStatement.setNull()</code>的 JavaDoc 来获取更多信息。         </p>
<p>​           要更进一步地自定义类型处理方式，可以指定一个特殊的类型处理器类（或别名），比如：         </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#&#123;age,javaType=int,jdbcType=NUMERIC,typeHandler=MyTypeHandler&#125;</span><br></pre></td></tr></table></figure>

<p>参数的配置好像越来越繁琐了，但实际上，很少需要如此繁琐的配置。</p>
<p>对于数值类型，还可以设置 <code>numericScale</code> 指定小数点后保留的位数。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#&#123;height,javaType=double,jdbcType=NUMERIC,numericScale=2&#125;</span><br></pre></td></tr></table></figure>

<p>最后，mode 属性允许你指定 <code>IN</code>，<code>OUT</code> 或 <code>INOUT</code> 参数。如果参数的 <code>mode</code> 为 <code>OUT</code> 或 <code>INOUT</code>，将会修改参数对象的属性值，以便作为输出参数返回。 如果 <code>mode</code> 为 <code>OUT</code>（或 <code>INOUT</code>），而且 <code>jdbcType</code> 为 <code>CURSOR</code>（也就是 Oracle 的 REFCURSOR），你必须指定一个 <code>resultMap</code> 引用来将结果集 <code>ResultMap</code> 映射到参数的类型上。要注意这里的 <code>javaType</code> 属性是可选的，如果留空并且 jdbcType 是 <code>CURSOR</code>，它会被自动地被设为 <code>ResultMap</code>。 </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#&#123;department, mode=OUT, jdbcType=CURSOR, javaType=ResultSet, resultMap=departmentResultMap&#125;</span><br></pre></td></tr></table></figure>

<p>MyBatis 也支持很多高级的数据类型，比如结构体（structs），但是当使用 out 参数时，你必须显式设置类型的名称。比如（再次提示，在实际中要像这样不能换行）： </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#&#123;middleInitial, mode=OUT, jdbcType=STRUCT, jdbcTypeName=MY_TYPE, resultMap=departmentResultMap&#125;</span><br></pre></td></tr></table></figure>

<p>尽管上面这些选项很强大，但大多时候，你只须简单指定属性名，顶多要为可能为空的列指定 <code>jdbcType</code>，其他的事情交给 MyBatis 自己去推断就行了。 </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#&#123;firstName&#125;</span><br><span class="line">#&#123;middleInitial,jdbcType=VARCHAR&#125;</span><br><span class="line">#&#123;lastName&#125;</span><br></pre></td></tr></table></figure>

<h3 id="特殊字符串替换和处理（-和"><a href="#特殊字符串替换和处理（-和" class="headerlink" title="特殊字符串替换和处理（# 和 $ )"></a>特殊字符串替换和处理（# 和 $ )</h3><p>在 MyBatis 中，我们常常传递字符串，我们设置的参数 #（name）在大部分的情况下 MyBatis 会用创建预编译的语句，然后 MyBatis 为它设值，而有时候我们需要的是传递 SQL 语句的本身，而不是 SQL 所需要的参数。例如，在一些动态表格（有时候经常遇到根据不同的条件产生不同的动态列）中，我们要传递 SQL 的列名，根据某些列进行排序，或者传递列名给 SQL 都是比较常见的场景，这是 MyBatis 都给与了支持。</p>
<p>​    例如，在程序中传递变量 columns=”col1 , col2, col3 …” 给 SQL ，让其组装成为 SQL 语句。案例如下： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">select $&#123;last_name&#125; from t_user</span><br></pre></td></tr></table></figure>

<p>注意一点： 这种传递列名 columns 的方式不需要像处理普通参数一样把它设为 “ col1 , col2 , col3 ….” ，直接使用 <code>${ param}</code> 就行.</p>
<p>​    这样 MyBatis 就不会帮我们转移 columns ，而是直接传递做字符串原样输出，然后和配置的sql语句做字符串拼接。</p>
<p>​    只是这样是对 SQL 而言是不安全的，用这种方式接受用户的输入，并用作语句参数是不安全的，会导致潜在的 SQL 注入攻击。因此，要么不允许用户输入这些字段，要么自行转义并检验这些参数。 </p>
<h4 id="占位符"><a href="#占位符" class="headerlink" title="占位符  #{}"></a>占位符  #{}</h4><p>在使用 <code>${}</code> 不安全的情况下，可以使用 #{} 来实现参数的传递。 </p>
<p>​    默认情况下，使用 <code>#{}</code> 参数语法时，MyBatis 会创建 <code>PreparedStatement</code> 参数占位符，并通过占位符安全地设置参数（就像使用 ? 一样）。 这样做更安全，更迅速，通常也是首选做法，不过有时你就是想直接在 SQL 语句中直接插入一个不转义的字符串。 比如 ORDER BY 子句，这时候你可以： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">ORDER BY $&#123;columnName&#125;</span><br></pre></td></tr></table></figure>

<p>这样，MyBatis 就不会修改或转义该字符串了。</p>
<p>​           举个例子，如果你想 <code>select</code> 一个表任意一列的数据时，可以这样写：           </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;select id=<span class="string">"selectUserByName"</span> resultType=<span class="string">"com.webcode.cn.entity.User"</span> parameterType=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span><br><span class="line">   	select id,last_name lastName,sex from t_user where last_name = #&#123;lastName&#125; and sex = #&#123;sex&#125;</span><br><span class="line"> &lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p>调用代码为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User u = userMapper.selectUserByName(<span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"tom"</span>,<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<p>执行后打印的 SQL 语句如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection <span class="number">1392906938</span>.</span><br><span class="line">DEBUG [main] - Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">530612</span>ba]</span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: select id,last_name lastName,sex from t_user where last_name = ? and sex = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: tom(String), <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==      Total: <span class="number">1</span></span><br><span class="line">User(id=<span class="number">3</span>, lastName=tom, sex=<span class="number">1</span>)</span><br><span class="line">DEBUG [main] - Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">530612</span>ba]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">530612</span>ba]</span><br><span class="line">DEBUG [main] - Returned connection <span class="number">1392906938</span> to pool.</span><br></pre></td></tr></table></figure>

<p>而在使用 <code>${}</code> 传递参数时，这里使用错误且不存在的 <code>sex</code>,</p>
<p>传递的参数为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User u = userMapper.selectUserByName(<span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"'tom' or 1 = 1 "</span>,<span class="number">11</span>)); <span class="comment">// sex 只有 1 和 0</span></span><br></pre></td></tr></table></figure>

<p>SQL 语句使用 <code>${}</code> 修饰</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span></span><br><span class="line"> 		update t_user set last_name = #&#123;lastName&#125;,sex = #&#123;sex&#125; where id = #&#123;id&#125;</span><br><span class="line"> <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可能会发生如下结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Created connection <span class="number">876926621</span>.</span><br><span class="line">DEBUG [main] - Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">3444</span>d69d]</span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: select id,last_name lastName,sex from t_user where last_name = <span class="string">'tom'</span> or <span class="number">1</span> = <span class="number">1</span> and sex = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: <span class="number">11</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;==      Total: <span class="number">1</span></span><br><span class="line">User(id=<span class="number">3</span>, lastName=tom, sex=<span class="number">1</span>)</span><br><span class="line">DEBUG [main] - Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">3444</span>d69d]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">3444</span>d69d]</span><br><span class="line">DEBUG [main] - Returned connection <span class="number">876926621</span> to pool.</span><br></pre></td></tr></table></figure>

<p>利用了sql注入漏洞骗过了口令从而查询成功。在 <strong>用户名正确</strong> 的前提下，<strong>sex</strong> 不管输入什么都能成功登录。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>参数</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-动态SQL</title>
    <url>/2020/04/28/mybatis-%E5%8A%A8%E6%80%81SQL/</url>
    <content><![CDATA[<h2 id="动态-SQL"><a href="#动态-SQL" class="headerlink" title="动态 SQL"></a>动态 SQL</h2><p>动态 SQL 是 MyBatis 的强大特性之一。如果你使用过 JDBC 或其它类似的框架，你应该能理解根据不同条件拼接 SQL  语句有多痛苦，例如拼接时要确保不能忘记添加必要的空格，还要注意去掉列表最后一个列名的逗号。利用动态 SQL，可以彻底摆脱这种痛苦。</p>
<p>使用动态 SQL 并非一件易事，但借助可用于任何 SQL 映射语句中的强大的动态 SQL 语言，MyBatis 显著地提升了这一特性的易用性。</p>
<p>如果你之前用过 JSTL 或任何基于类 XML 语言的文本处理器，你对动态 SQL 元素可能会感觉似曾相识。在 MyBatis  之前的版本中，需要花时间了解大量的元素。借助功能强大的基于 OGNL 的表达式，MyBatis 3  替换了之前的大部分元素，大大精简了元素种类，现在要学习的元素种类比原来的一半还要少。</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>MyBatis 的动态 SQL 包括以下几种元素，如下表所示：</p>
<table>
<thead>
<tr>
<th align="center">元素</th>
<th align="center">作用</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">if</td>
<td align="center">判断语句</td>
<td align="center">单条件分支判断</td>
</tr>
<tr>
<td align="center">choose(when、otherwise)</td>
<td align="center">相当于 Java 中的 case when 语句</td>
<td align="center">多条件分支判断</td>
</tr>
<tr>
<td align="center">trim(where、set)</td>
<td align="center">辅助元素</td>
<td align="center">用于处理一些 SQL 拼装问题</td>
</tr>
<tr>
<td align="center">foreach</td>
<td align="center">循环语句</td>
<td align="center">在 in 语句等列举条件常用</td>
</tr>
</tbody></table>
<p>以下是这些动态元素的用法。</p>
<h3 id="if-元素"><a href="#if-元素" class="headerlink" title="if 元素"></a>if 元素</h3><p>说明：    <strong>if语句</strong>，可以动态的根据你的值来决定，是否需要动态的添加查询条件。</p>
<p>使用动态 SQL 最常见情景是根据条件包含 where 子句的一部分。比如： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据用户的lastName属性和sex属性查询用户信息&lt;br/&gt;</span></span><br><span class="line"><span class="comment">	 * 	前提条件是lastName属性和sex属性值都合法。&lt;br/&gt;</span></span><br><span class="line"><span class="comment">	 * 	如果lastName属性和sex属性哪个不合法，就不要加入查询条件</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	 <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUserByNameAndSex</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置信息：</strong> </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">&lt;!-- 动态 SQL  --&gt;</span><br><span class="line">&lt;select id="queryUserByNameAndSex" resultType="com.webcode.cn.entity.User"&gt;</span><br><span class="line">	<span class="keyword">select</span> </span><br><span class="line">		<span class="keyword">id</span>,last_name lastName,sex </span><br><span class="line">	<span class="keyword">from</span> </span><br><span class="line">		t_user </span><br><span class="line">	<span class="keyword">where</span> </span><br><span class="line">	&lt;!<span class="comment">-- 做if判断 --&gt;</span></span><br><span class="line">	&lt;<span class="keyword">if</span> <span class="keyword">test</span>=<span class="string">"lastName != null"</span>&gt;</span><br><span class="line">		last_name <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>,<span class="comment">#&#123;lastName&#125;,'%') </span></span><br><span class="line">	&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">	&lt;<span class="keyword">if</span> <span class="keyword">test</span>=<span class="string">"sex == 0 || sex == 1"</span>&gt;</span><br><span class="line">		<span class="keyword">and</span> sex = <span class="comment">#&#123;sex&#125;</span></span><br><span class="line">	&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>

<p>以上这句话的含义就是当我们将参数 lastName、sex  传递进入到映射器中，采取构造对 lastName 的模糊查询，以及对 sex 的精确查询。如果这个参数为空，就不要去构造这个条件，显然这样的场景在我们实际的工作中是十分常见的。通过 MyBatis 的条件语句我们可以节省许多拼接 SQL的工作，把精力集中在 XML 的维护上。</p>
<p><strong>测试代码：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">SqlSession sqlSession2 = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">	UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	userMapper.queryUserByNameAndSex(<span class="keyword">new</span> User(<span class="keyword">null</span>,<span class="string">"j"</span>,<span class="number">1</span>)).forEach(System.out::println);</span><br><span class="line">	</span><br><span class="line">	sqlSession2.commit();			</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">	System.err.println(ex.getMessage());</span><br><span class="line">	sqlSession.rollback();</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Logging initialized using &#39;class org.apache.ibatis.logging.log4j.Log4jImpl&#39; adapter.</span><br><span class="line"> INFO [main] - 定制属性： &#123;someProperty&#x3D;100&#125;</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection 1783047508.</span><br><span class="line">DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@6a472554]</span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt;  Preparing: select id,last_name lastName,sex from t_user where last_name like concat(&#39;%&#39;,?,&#39;%&#39;) and sex &#x3D; ? </span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt; Parameters: j(String), 1(Integer)</span><br><span class="line">DEBUG [main] - &lt;&#x3D;&#x3D;      Total: 2</span><br><span class="line">User(id&#x3D;1, lastName&#x3D;jetty, sex&#x3D;1)</span><br><span class="line">User(id&#x3D;5, lastName&#x3D;jete, sex&#x3D;1)</span><br><span class="line">DEBUG [main] - Resetting autocommit to true on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@6a472554]</span><br><span class="line">null</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@6a472554]</span><br><span class="line">DEBUG [main] - Returned connection 1783047508 to pool.</span><br></pre></td></tr></table></figure>

<h3 id="choose、when、otherwise-元素"><a href="#choose、when、otherwise-元素" class="headerlink" title="choose、when、otherwise 元素"></a>choose、when、otherwise 元素</h3><p>说明：choose when otherwise 可以执行多路选择判断，但是只会有一个分支会被执行。</p>
<p>类似switch case 语句</p>
<p><strong>方法：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据user对象的属性进行查询&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * 	1、如果lastName值有效（非空），则做模糊查询&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *  2、sex属性如果有效，就做性别查询&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *  3、使用默认条件查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUsersByNameOrSexChoose</span><span class="params">(User user)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>配置信息：</strong> </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">&lt;select id="queryUsersByNameOrSexChoose" resultType="com.webcode.cn.entity.User"&gt;</span><br><span class="line">	<span class="keyword">select</span></span><br><span class="line">		<span class="keyword">id</span>,last_name lastName,sex </span><br><span class="line">	<span class="keyword">from</span> </span><br><span class="line">		t_user</span><br><span class="line">	&lt;<span class="keyword">where</span>&gt;</span><br><span class="line">		&lt;<span class="keyword">choose</span>&gt;</span><br><span class="line">			&lt;<span class="keyword">when</span> <span class="keyword">test</span>=<span class="string">"lastName != null"</span>&gt;</span><br><span class="line">				last_name <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>,<span class="comment">#&#123;lastName&#125;,'%')</span></span><br><span class="line">			&lt;/<span class="keyword">when</span>&gt;</span><br><span class="line">			&lt;<span class="keyword">when</span> <span class="keyword">test</span>=<span class="string">"sex == 1 || sex == 0"</span>&gt; &lt;!<span class="comment">-- test的属性用于条件判断的语句中，它的作用相当于判断真假。在大部分的场景中我们都是用它判断空和非空 --&gt;</span></span><br><span class="line">				sex = <span class="comment">#&#123;sex&#125;</span></span><br><span class="line">			&lt;/<span class="keyword">when</span>&gt;</span><br><span class="line">			&lt;otherwise&gt;</span><br><span class="line">				<span class="number">1</span> = <span class="number">1</span></span><br><span class="line">			&lt;/otherwise&gt;</span><br><span class="line">		&lt;/<span class="keyword">choose</span>&gt;</span><br><span class="line">	&lt;/<span class="keyword">where</span>&gt;</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>分析上述动态 SQL ：</strong> </p>
<ul>
<li>当传过去的 lastName 不为空且 sex 为空时，则使用 lastName 作为条件进行模糊查询</li>
<li>当传过去的 lastName 为空且 sex 不为空时，使用 sex 作为条件进行精确查询</li>
<li>当传过去的 lastName 都为空，则使用 <code>&lt;otherwise&gt;</code>  中的 条件执行查询</li>
</ul>
<p><strong>测试代码：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SqlSession session = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	UserMapper mapper = session.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	mapper.queryUsersByNameOrSexChoose(<span class="keyword">new</span> User(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">1</span>)).forEach(System.out::println);</span><br><span class="line">	</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	session.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样MyBatis 就会根据参数的设置进行判断来动态组装 SQL ，以满足不同业务的要求，远比 Hibernate 和 JDBC 大量判断 Java 代码要清晰 和 明确得多。</p>
<h3 id="trim、where、set-元素"><a href="#trim、where、set-元素" class="headerlink" title="trim、where、set 元素"></a>trim、where、set 元素</h3><h4 id="where-语句"><a href="#where-语句" class="headerlink" title="where 语句"></a>where 语句</h4><p>说明：where语句，可以帮我们在多个动态语句中，有效的去掉前面的多余的and  或 or 之类的多余关键字</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryUserByNameAndSex"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span></span><br><span class="line">	select </span><br><span class="line">		id,last_name lastName,sex </span><br><span class="line">	from </span><br><span class="line">		t_user </span><br><span class="line">	<span class="comment">&lt;!-- where标签可以动态判断里面有没有内容。如果没有内容。就没有where关键字，有内容就有where关键字，并且可以去掉里面包含的多余的and或or关键字 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 做if判断 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"lastName != null"</span>&gt;</span></span><br><span class="line">			last_name like concat('%',#&#123;lastName&#125;,'%') </span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sex == 0 || sex == 1"</span>&gt;</span></span><br><span class="line">			and sex = #&#123;sex&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">where</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    在上述映射器的 配置中，当 where 元素里面的条件成立的时候，才会加入 where 这个 SQL 关键字到组装的 SQL 里面，否则就不加入。</p>
<h4 id="trim-语句"><a href="#trim-语句" class="headerlink" title="trim 语句"></a>trim 语句</h4><p>​    有时候我们要去掉一些特殊的 SQL 语法，比如常见的 and 、or。而使用 trim 元素可以达到我们预期的效果，</p>
<p>使用说明：<font color="blue">trim</font> 可以动态在包含的语句前面和后面添加内容。也可以去掉前面或者后面给定的内容</p>
<p>​        <font color="blue">prefix</font>  前面添加内容</p>
<p>​        <font color="blue">suffix</font>  后面添加内容</p>
<p>​        <font color="blue">suffixOverrides</font>  去掉的后面内容</p>
<p>​        <font color="blue">prefixOverrides</font>  去掉的前面内容</p>
<p>方法代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryUserByNameAndSexTrim</span><span class="params">(User user)</span></span>;</span><br></pre></td></tr></table></figure>

<p>配置信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;select id&#x3D;&quot;queryUserByNameAndSexTrim&quot; resultType&#x3D;&quot;com.webcode.cn.entity.User&quot;&gt;</span><br><span class="line">	select </span><br><span class="line">		id,last_name lastName,sex </span><br><span class="line">	from </span><br><span class="line">		t_user </span><br><span class="line">	&lt;!-- </span><br><span class="line">		trim 语句可以去掉包含内容的前面或后台的指定内容</span><br><span class="line">			prefixOverrides&#x3D;&quot;and&quot; 	去掉前缀add</span><br><span class="line">			suffixOverrides&#x3D;&quot;and&quot;	去掉后缀add</span><br><span class="line">			prefix					在内容前面添加where</span><br><span class="line">			suffix&#x3D;&quot;&quot;				在内容后面添加</span><br><span class="line">	--&gt;</span><br><span class="line">	&lt;trim prefixOverrides&#x3D;&quot;and&quot; suffixOverrides&#x3D;&quot;and&quot; prefix&#x3D;&quot;where&quot; &gt;</span><br><span class="line">		&lt;!-- 做if判断 --&gt;</span><br><span class="line">		&lt;if test&#x3D;&quot;lastName !&#x3D; null&quot;&gt;</span><br><span class="line">			last_name like concat(&#39;%&#39;,#&#123;lastName&#125;,&#39;%&#39;) and </span><br><span class="line">		&lt;&#x2F;if&gt;</span><br><span class="line">		&lt;if test&#x3D;&quot;sex &#x3D;&#x3D; 0 || sex &#x3D;&#x3D; 1&quot;&gt;</span><br><span class="line">			sex &#x3D; #&#123;sex&#125;</span><br><span class="line">		&lt;&#x2F;if&gt;</span><br><span class="line">	&lt;&#x2F;trim&gt; </span><br><span class="line">&lt;&#x2F;select&gt;</span><br></pre></td></tr></table></figure>

<p>​    trim 元素意味着我们需要去掉一些特殊的字符串， prefix 代表的是语句的前缀，而 prefixOverrides 代表的是你需要去掉的那种字符串。上面的写法基本与 where 是等效的。</p>
<h4 id="set-语句"><a href="#set-语句" class="headerlink" title="set 语句"></a>set 语句</h4><p>删除条件后的逗号</p>
<p><strong>方法：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新user</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>配置信息：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.atguigu.pojo.User"</span>&gt;</span></span><br><span class="line">	update </span><br><span class="line">		t_user </span><br><span class="line">	<span class="comment">&lt;!-- set可以删除条件后的逗号 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"lastName != null"</span>&gt;</span></span><br><span class="line">			last_name = #&#123;lastName&#125; , </span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sex == 1 || sex == 0"</span>&gt;</span></span><br><span class="line">			sex = #&#123;sex&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">	where </span><br><span class="line">		id = #&#123;id&#125; </span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    在上述的代码中， set 元素遇到了逗号，它会把对应的逗号去掉，如果我们自己编写那将是多少次的判断呢？当我们只想获取某个名称的用户时，我们只需要传递用户名称 lastName 即可，而不需要再传递用户的 性别 sex 。 MyBatis 会根据参数的规则进行动态 SQL 组装，这样便能满足要求，同时避免了全部字段更新的麻烦。</p>
<p>​    同样的，以上的    <code>&lt;set/&gt;</code> 语句也可以转变为对应的 trim 元素，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"SET"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span>...<span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>测试代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		UserMapper mapper = session.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		</span><br><span class="line">		mapper.updateUser(<span class="keyword">new</span> User(<span class="number">4</span>, <span class="string">"ccc"</span>, <span class="number">10</span>));</span><br><span class="line">		</span><br><span class="line">		session.commit();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h3><p>动态 SQL 的另一个常见使用场景是对集合进行遍历（尤其是在构建 IN 条件语句的时候）。比如： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryUsersByIds"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.pojo.User"</span>&gt;</span></span><br><span class="line">	select </span><br><span class="line">		id,last_name lastName,sex</span><br><span class="line">	from </span><br><span class="line">		t_user</span><br><span class="line">	where</span><br><span class="line">		id in </span><br><span class="line">	<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">		foreach是做遍历操作</span></span><br><span class="line"><span class="comment">			collection属性是遍历的集合</span></span><br><span class="line"><span class="comment">			open是遍历之前要添加的内容</span></span><br><span class="line"><span class="comment">			close是遍历之后要添加的内容</span></span><br><span class="line"><span class="comment">			separator是每遍历的元素中间要加的内容</span></span><br><span class="line"><span class="comment">			item 是当前正在遍历的内容</span></span><br><span class="line"><span class="comment">			</span></span><br><span class="line"><span class="comment">	 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"list"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">item</span>=<span class="string">"i"</span>&gt;</span></span><br><span class="line">		#&#123;i&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><em>foreach</em> 元素的功能非常强大，它允许你指定一个集合，声明可以在元素体内使用的集合项（item）和索引（index）变量。它也允许你指定开头与结尾的字符串以及集合项迭代之间的分隔符。这个元素也不会错误地添加多余的分隔符，看它多智能！</p>
<p><code>提示</code> 你可以将任何可迭代对象（如 List、Set 等）、Map 对象或者数组对象作为集合参数传递给 <em>foreach</em>。当使用可迭代对象或者数组时，index 是当前迭代的序号，item 的值是本次迭代获取到的元素。当使用 Map 对象（或者 Map.Entry 对象的集合）时，index 是键，item 是值。</p>
<p>至此，我们已经完成了与 XML 配置及映射文件相关的讨论。下一章将详细探讨 Java API，以便你能充分利用已经创建的映射配置。</p>
<h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><p>要在带注解的映射器接口类中使用动态 SQL，可以使用 <em>script</em> 元素。比如: </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Update</span>(&#123;<span class="string">"&lt;script&gt;"</span>,</span><br><span class="line">  <span class="string">"update Author"</span>,</span><br><span class="line">  <span class="string">"  &lt;set&gt;"</span>,</span><br><span class="line">  <span class="string">"    &lt;if test='username != null'&gt;username=#&#123;username&#125;,&lt;/if&gt;"</span>,</span><br><span class="line">  <span class="string">"    &lt;if test='password != null'&gt;password=#&#123;password&#125;,&lt;/if&gt;"</span>,</span><br><span class="line">  <span class="string">"    &lt;if test='email != null'&gt;email=#&#123;email&#125;,&lt;/if&gt;"</span>,</span><br><span class="line">  <span class="string">"    &lt;if test='bio != null'&gt;bio=#&#123;bio&#125;&lt;/if&gt;"</span>,</span><br><span class="line">  <span class="string">"  &lt;/set&gt;"</span>,</span><br><span class="line">  <span class="string">"where id=#&#123;id&#125;"</span>,</span><br><span class="line">  <span class="string">"&lt;/script&gt;"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateAuthorValues</span><span class="params">(Author author)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><p><code>bind</code> 元素允许你在 OGNL 表达式以外创建一个变量，并将其绑定到当前的上下文。比如： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;select id&#x3D;&quot;selectBlogsLike&quot; resultType&#x3D;&quot;Blog&quot;&gt;</span><br><span class="line">  &lt;bind name&#x3D;&quot;pattern&quot; value&#x3D;&quot;&#39;%&#39; + _parameter.getTitle() + &#39;%&#39;&quot; &#x2F;&gt;</span><br><span class="line">  SELECT * FROM BLOG</span><br><span class="line">  WHERE title LIKE #&#123;pattern&#125;</span><br><span class="line">&lt;&#x2F;select&gt;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>动态 SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-映射器（七）insert元素-概述</title>
    <url>/2020/04/23/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E4%B8%83%EF%BC%89insert%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>insert 元素，相对于 select 元素而言要简单许多。MyBatis 会在执行插入之后哦返回一个整数，以表示你进行操作后插入的记录数。 insert 元素配置详解如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">"insertAuthor"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">parameterType</span>=<span class="string">"domain.blog.Author"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">flushCache</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">statementType</span>=<span class="string">"PREPARED"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keyProperty</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keyColumn</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">  <span class="attr">useGeneratedKeys</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">  <span class="attr">timeout</span>=<span class="string">"20"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置列表：</strong></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>在命名空间中唯一的标识符，可以被用来引用这条语句。</td>
</tr>
<tr>
<td>parameterType</td>
<td>将会传入这条语句的参数的类全限定名或别名。这个属性是可选的，因为 MyBatis 可以通过类型处理器（TypeHandler）推断出具体传入语句的参数，默认值为未设置（unset）。</td>
</tr>
<tr>
<td>parameterMap</td>
<td>用于引用外部 parameterMap 的属性，目前已被废弃。请使用行内参数映射和 parameterType 属性。</td>
</tr>
<tr>
<td><code>flushCache</code></td>
<td>将其设置为 true 后，只要语句被调用，都会导致本地缓存和二级缓存被清空，默认值：（对 insert、update 和 delete 语句）true。</td>
</tr>
<tr>
<td>timeout</td>
<td>这个设置是在抛出异常之前，驱动程序等待数据库返回请求结果的秒数。默认值为未设置（unset）（依赖数据库驱动）。</td>
</tr>
<tr>
<td>statementType</td>
<td>可选 STATEMENT，PREPARED 或 CALLABLE。这会让 MyBatis 分别使用 Statement，PreparedStatement 或 CallableStatement，默认值：PREPARED。</td>
</tr>
<tr>
<td>useGeneratedKeys</td>
<td>（仅适用于 insert 和 update）这会令 MyBatis 使用 JDBC 的 getGeneratedKeys 方法来取出由数据库内部生成的主键（比如：像 MySQL 和 SQL Server 这样的关系型数据库管理系统的自动递增字段），默认值：false。</td>
</tr>
<tr>
<td>keyProperty</td>
<td>（仅适用于 insert 和 update）指定能够唯一识别对象的属性，MyBatis 会使用 getGeneratedKeys 的返回值或 insert 语句的 selectKey 子元素设置它的值，默认值：未设置（<code>unset</code>）。如果生成列不止一个，可以用逗号分隔多个属性名称。</td>
</tr>
<tr>
<td>keyColumn</td>
<td>（仅适用于 insert 和 update）设置生成键值在表中的列名，在某些数据库（像 PostgreSQL）中，当主键列不是表中的第一列的时候，是必须设置的。如果生成列不止一个，可以用逗号分隔多个属性名称。</td>
</tr>
<tr>
<td>databaseId</td>
<td>如果配置了数据库厂商标识（databaseIdProvider），MyBatis 会加载所有不带 databaseId 或匹配当前 databaseId 的语句；如果带和不带的语句都有，则不带的会被忽略。 ****</td>
</tr>
</tbody></table>
<p><strong>元素插入案例,插入一个用户 user：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--   parameterType 参数类型（可选） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"saveUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.webcode.cn.entity.User"</span>&gt;</span></span><br><span class="line">		insert into t_user(`last_name`,`sex`) values(#&#123;lastName&#125;,#&#123;sex&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="主键回填和自定义"><a href="#主键回填和自定义" class="headerlink" title="主键回填和自定义"></a><strong>主键回填和自定义</strong></h3><p>显示中有许多我们需要处理的问题，例如，主键自增字段； MySQL 里面的主键需要根据一些特殊的规则去生成，在插入后我们往往需要获得这个主键，以便于未来的操作，而MyBatis提供了实现的方法。</p>
<p>首先我们可以使用 keyProperty 属性指定哪个是主键字段，同时使用 useGeneratedKeys 属性告诉MyBatis 这个主键是否使用数据库内置策略生成。</p>
<p>我们的例子中 t_user 表就是指定了 id 列为自增字段。因为我们建立 POJO ，它能提供 setter 和 getter 方法，这样便能够使用 MyBatis 的主键回填功能了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!--   parameterType 参数类型（可选）</span><br><span class="line">			useGeneratedKeys=<span class="string">"true"</span>		使用（或返回）数据库生成的主键</span><br><span class="line">			keyProperty=<span class="string">"id"</span>	把数据库返回的主键值注入到bean对象的id属性中</span><br><span class="line">	 --&gt;</span><br><span class="line">  &lt;insert id=<span class="string">"saveUser"</span> parameterType=<span class="string">"com.webcode.cn.entity.User"</span> useGeneratedKeys=<span class="string">"true"</span> keyProperty=<span class="string">"id"</span>&gt;</span><br><span class="line">  		<span class="function">insert into <span class="title">t_user</span><span class="params">(`last_name`,`sex`)</span> <span class="title">values</span><span class="params">(#&#123;lastName&#125;,#&#123;sex&#125;)</span></span></span><br><span class="line"><span class="function">  &lt;/insert&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这里我们传入 user 对象就无需设置 id 的值， MyBatis 会用数据库的设置进行处理。这样做的好处是在 MyBatis 插入的时候，它会回填 JavaBean 的 id  值。我们进行调试，在插入后，它自动填充主键，方便以后使用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span> <span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">		SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">			UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			User user = <span class="keyword">new</span> User();</span><br><span class="line">			user.setLastName(<span class="string">"tom"</span>);</span><br><span class="line">			user.setSex(<span class="number">1</span>);</span><br><span class="line">			userMapper.saveUser(user);</span><br><span class="line">			System.out.println(user.getId());</span><br><span class="line">			sqlSession.commit();			</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			System.err.println(ex.getMessage());</span><br><span class="line">			sqlSession.rollback();</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSession.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用DEBUG进行调试，查看返回的 id 值；</p>
<img src="http://photo.wushaopei.com/qiniu477.jpg " width="80%">

<h3 id="selectKey"><a href="#selectKey" class="headerlink" title="selectKey"></a>selectKey</h3><p>实际工作往往不是我们想象的那么简单，需要根据一些特殊的关系设置主键 id 的值。假设我们取消表 t_user 的 id  自增的规则，我们的要求是： 如果表 t_user 没有记录，则我们需要设置 id=1 , 否则我们就取最大 id 加 2，来设置新的主键，对于一些特殊要求， MyBatis 也提供了应对方法。</p>
<p>​    这个时候我们可以使用 selectKey 元素进行处理，操作方法如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--   parameterType 参数类型（可选） --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"saveUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.webcode.cn.entity.User"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">      	<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">  			selectKey标签可以定义一些查询语句，这些语句可以选择性地在大标签的sql语句之前或之后执行</span></span><br><span class="line"><span class="comment">  			我们希望，通过执行一个查询，把最后一次生成的id返回。</span></span><br><span class="line"><span class="comment">  				order属性配置执行的顺序</span></span><br><span class="line"><span class="comment">  					BEFORE		之前</span></span><br><span class="line"><span class="comment">  					AFTER		之后</span></span><br><span class="line"><span class="comment">  				keyProperty="id"	把数据库返回的主键值注入到bean对象的id属性中</span></span><br><span class="line"><span class="comment">  				resultType="int"	设置selectKey查询之后返回的类型是什么 int 表示Integer类型</span></span><br><span class="line"><span class="comment">  		 --&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">selectKey</span>   <span class="attr">keyProperty</span>=<span class="string">"id"</span>   <span class="attr">resultType</span>=<span class="string">"int"</span>   <span class="attr">order</span>=<span class="string">"BEFORE"</span>   <span class="attr">statementType</span>=<span class="string">"PREPARED"</span>&gt;</span></span><br><span class="line">  			 select if(max(id) is null, 1, max(id) + 2) as newId from t_user</span><br><span class="line">  		<span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span>	</span><br><span class="line">  		insert into t_user(id,`last_name`,`sex`) values(#&#123;id&#125;,#&#123;lastName&#125;,#&#123;sex&#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>去除主键自增后的执行结果：</p>
<img src="http://photo.wushaopei.com/qiniu478.jpg " width="80%">

<p>这样我们就能定义自己的规则来生成主键了，MyBatis 的灵活性也得以体现。</p>
<h3 id="selectKey-元素的属性"><a href="#selectKey-元素的属性" class="headerlink" title="selectKey 元素的属性"></a>selectKey 元素的属性</h3><table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>keyProperty</code></td>
<td><code>selectKey</code> 语句结果应该被设置到的目标属性。如果生成列不止一个，可以用逗号分隔多个属性名称。</td>
</tr>
<tr>
<td><code>keyColumn</code></td>
<td>返回结果集中生成列属性的列名。如果生成列不止一个，可以用逗号分隔多个属性名称。</td>
</tr>
<tr>
<td><code>resultType</code></td>
<td>结果的类型。通常 MyBatis 可以推断出来，但是为了更加准确，写上也不会有什么问题。MyBatis允许将任何简单类型用作主键的类型，包括字符串。如果生成列不止一个，则可以使用包含期望属性的Object 或 Map。</td>
</tr>
<tr>
<td><code>order</code></td>
<td>可以设置为 <code>BEFORE</code> 或 <code>AFTER</code>。如果设置为  <code>BEFORE</code>，那么它首先会生成主键，设置 <code>keyProperty</code> 再执行插入语句。如果设置为 <code>AFTER</code>，那么先执行插入语句，然后是 <code>selectKey</code> 中的语句 - 这和 Oracle  数据库的行为相似，在插入语句内部可能有嵌入索引调用。</td>
</tr>
<tr>
<td><code>statementType</code></td>
<td>和前面一样，MyBatis 支持 <code>STATEMENT</code>，<code>PREPARED</code> 和 <code>CALLABLE</code>  类型的映射语句，分别代表 <code>Statement</code>, <code>PreparedStatement</code> 和                 <code>CallableStatement</code> 类型。</td>
</tr>
</tbody></table>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>insert元素</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 映射器（十三）缓存cache</title>
    <url>/2020/04/28/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%E7%BC%93%E5%AD%98cache/</url>
    <content><![CDATA[<h2 id="缓存-cache"><a href="#缓存-cache" class="headerlink" title="缓存 cache"></a>缓存 cache</h2><p><strong>缓存：</strong>所谓是指把一些经常访问的数据保存到一个调整的缓冲区中。保存在高速缓冲区中的数据叫缓存。因此具备快速读取和使用的特点，如果缓存命中率高，那么就可以极大地提高系统的性能。如果缓存命中率很低，那么缓存就不存在使用的意义了，所以使用缓存的关键在于存储内容访问的命中率。</p>
<h3 id="系统缓存（一级缓存和二级缓存）"><a href="#系统缓存（一级缓存和二级缓存）" class="headerlink" title="系统缓存（一级缓存和二级缓存）"></a>系统缓存（一级缓存和二级缓存）</h3><p>​    MyBatis 对缓存提供支持，但是在没有配置的默认的情况拿下，它只开启一级缓存（以及缓存只是相对于同一个 SqlSession 而言）。</p>
<p>​    所以在参数和 SQL 完全一样的情况下，我们使用同一个 SqlSession 对象调用同一个 Mapper 的方法，往往只执行一次 SQL ，因为使用 SqlSession 第一次查询后， MyBatis 会将其放在缓存中，以后再查询的时候，如果 没有声明需要刷新，并且缓存没超时的情况下， SqlSession 都只会取出当前缓存的数据，而不会再次发送 SQL 到数据库。</p>
<p>​    代码案例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">SqlSession sqlSession2 = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">	UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	System.err.println(userMapper.selectUserById(<span class="number">3</span>)); </span><br><span class="line">	</span><br><span class="line">	System.err.println(<span class="string">"使用同一个 sqlSession 再执行一次"</span>);</span><br><span class="line">	</span><br><span class="line">	System.err.println(userMapper.selectUserById(<span class="number">3</span>)); </span><br><span class="line">	</span><br><span class="line">	sqlSession.commit();	</span><br><span class="line">	System.err.println(<span class="string">"创建一个新的 sqlSession 再执行一次"</span>);</span><br><span class="line">	</span><br><span class="line">	sqlSession2 = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">	UserMapper userMapper2 = sqlSession2.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	System.err.println(userMapper2.selectUserById(<span class="number">3</span>)); </span><br><span class="line"></span><br><span class="line">	sqlSession2.commit();			</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">	System.err.println(ex.getMessage());</span><br><span class="line">	sqlSession.rollback();</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们一共创建了两个 SqlSession 对象，第一次执行了两次查询，第二个执行了一次查询，让我们看看其运行的结果。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Logging initialized using &#39;class org.apache.ibatis.logging.log4j.Log4jImpl&#39; adapter.</span><br><span class="line"> INFO [main] - 定制属性： &#123;someProperty&#x3D;100&#125;</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection 852445367.</span><br><span class="line">DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@32cf48b7]</span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt;  Preparing: select id,last_name lastName,sex from t_user where id &#x3D; ? </span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt; Parameters: 3(Integer)</span><br><span class="line">DEBUG [main] - &lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">User(id&#x3D;3, lastName&#x3D;tom, sex&#x3D;1)</span><br><span class="line">使用同一个 sqlSession 再执行一次</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">User(id&#x3D;3, lastName&#x3D;tom, sex&#x3D;1)</span><br><span class="line">创建一个新的 sqlSession 再执行一次</span><br><span class="line">DEBUG [main] - Created connection 1226204845.</span><br><span class="line">DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@491666ad]</span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt;  Preparing: select id,last_name lastName,sex from t_user where id &#x3D; ? </span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt; Parameters: 3(Integer)</span><br><span class="line">DEBUG [main] - &lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">User(id&#x3D;3, lastName&#x3D;tom, sex&#x3D;1)</span><br><span class="line">DEBUG [main] - Resetting autocommit to true on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@32cf48b7]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@32cf48b7]</span><br><span class="line">DEBUG [main] - Returned connection 852445367 to pool.</span><br></pre></td></tr></table></figure>

<p>从执行结果可以看出，第一个 SqlSession 实际只发生过一次查询，而第二次查询就从缓存中取出来了，也就是 SqlSession 层面的一级缓存，它在各个 SqlSession 是相互隔离的。</p>
<p>​    为了解决多个 SqlSession 中缓存数据相互隔离的问题，可以通过配置二级缓存的方式，使得缓存能够在 SqlSessionFactory 层面上能够提供个各个 SqlSession 对象共享。</p>
<p>​    默认情况下，只启用了本地的会话缓存，它仅仅对一个会话中的数据进行缓存。 要启用全局的二级缓存，只需要在你的 SQL 映射文件中添加一行： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>基本上就是这样。这个简单语句的效果如下:         </p>
<ul>
<li>映射语句文件中的所有 select 语句的结果将会被缓存。</li>
<li>映射语句文件中的所有 insert、update 和 delete 语句会刷新缓存。</li>
<li>缓存会使用最近最少使用算法（LRU, Least Recently Used）算法来清除不需要的缓存。</li>
<li>缓存不会定时进行刷新（也就是说，没有刷新间隔）。</li>
<li>缓存会保存列表或对象（无论查询方法返回哪种）的 1024 个引用。</li>
<li>缓存会被视为读/写缓存，这意味着获取到的对象并不是共享的，可以安全地被调用者修改，而不干扰其他调用者或线程所做的潜在修改。</li>
</ul>
<p><code>提示</code> 缓存只作用于 cache 标签所在的映射文件中的语句。如果你混合使用 Java API 和 XML 映射文件，在共用接口中的语句将不会被默认缓存。你需要使用 @CacheNamespaceRef 注解指定缓存作用域。     </p>
<p>这些属性可以通过 cache 元素的属性来修改。比如： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span></span></span><br><span class="line"><span class="tag">  <span class="attr">eviction</span>=<span class="string">"FIFO"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">flushInterval</span>=<span class="string">"60000"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">size</span>=<span class="string">"512"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">readOnly</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>​           这个更高级的配置创建了一个 FIFO 缓存，每隔 60 秒刷新，最多可以存储结果对象或列表的 512 个引用，而且返回的对象被认为是只读的，因此对它们进行修改可能会在不同线程中的调用者产生冲突。      </p>
<p><strong>注意：</strong></p>
<p>​    添加    <code>&lt;cache/&gt;</code> 二级缓存配置后，需要对要返回的 POJO 对象实现 Serializable 接口，否则它就会抛出异常。</p>
<p><strong>eviction</strong> ,代表缓存回收策略；</p>
<p>可用的清除策略有：         </p>
<ul>
<li><code>LRU</code> – 最近最少使用：移除最长时间不被使用的对象。           </li>
<li><code>FIFO</code> – 先进先出：按对象进入缓存的顺序来移除它们。           </li>
<li><code>SOFT</code> – 软引用：基于垃圾回收器状态和软引用规则移除对象。           </li>
<li><code>WEAK</code> – 弱引用：更积极地基于垃圾收集器状态和弱引用规则移除对象。           </li>
</ul>
<p>默认的清除策略是 LRU。</p>
<p><code>flushInterval</code>（刷新间隔）属性可以被设置为任意的正整数，设置的值应该是一个以毫秒为单位的合理时间量。默认情况是不设置，也就是没有刷新间隔，缓存仅仅会在调用语句时刷新。         </p>
<p><code>size</code>（引用数目）属性可以被设置为任意正整数，要注意欲缓存对象的大小和运行环境中可用的内存资源。默认值是 1024。         </p>
<p><code>readOnly</code>（只读）属性可以被设置为 true 或 false。只读的缓存会给所有调用者返回缓存对象的相同实例。因此这些对象不能被修改。这就提供了可观的性能提升。而可读写的缓存会（通过序列化）返回缓存对象的拷贝。速度上会慢一些，但是更安全，因此默认值是 false。         </p>
<p><code>提示</code> 二级缓存是事务性的。这意味着，当 SqlSession 完成并提交时，或是完成并回滚，但没有执行 flushCache=true 的 insert/delete/update 语句时，缓存会获得更新。 </p>
<h4 id="二级缓存的使用："><a href="#二级缓存的使用：" class="headerlink" title="二级缓存的使用："></a>二级缓存的使用：</h4><p>myBatis的二级缓存默认是不开启的。</p>
<ul>
<li>我们需要在mybatis的核心配置文件中配置setting选项</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 开启二级缓存 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在Mapper的配置文件中加入cache标签。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 表示使用二级缓存 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cache</span>&gt;</span><span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>需要被二级缓存的对象必须要实现java的序列化接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    。。。。。。。。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>useCache=false的演示和说明</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">		userCache 设置是否使用二级缓存，默认是true，使用</span></span><br><span class="line"><span class="comment">		false 表示不使用二级缓存</span></span><br><span class="line"><span class="comment">	 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryUserById"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.cn.entity.User"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">useCache</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">	select id,last_name lastName,sex from t_user where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>flushCache=”false”的演示和说明</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--  flushCache是设置是否要清空缓存</span></span><br><span class="line"><span class="comment">		默认是true，表示清空</span></span><br><span class="line"><span class="comment">		false表示不清空缓存</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.webcode.cn.entity.User"</span> <span class="attr">flushCache</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line"> 		update t_user set last_name = #&#123;lastName&#125;,sex = #&#123;sex&#125; where id = #&#123;id&#125;</span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义缓存："><a href="#自定义缓存：" class="headerlink" title="自定义缓存："></a>自定义缓存：</h2><p>除了上述自定义缓存的方式，你也可以通过实现你自己的缓存，或为其他第三方缓存方案创建适配器，来完全覆盖缓存行为。 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">type</span>=<span class="string">"com.domain.something.MyCustomCache"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个示例展示了如何使用一个自定义的缓存实现。type 属性指定的类必须实现 org.apache.ibatis.cache.Cache 接口，且提供一个接受 String 参数作为 id 的构造器。 这个接口是 MyBatis 框架中许多复杂的接口之一，但是行为却非常简单。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">getId</span><span class="params">()</span></span>; <span class="comment">// 获取缓存编号</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>;	<span class="comment">// 获取缓存对象大小</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span></span>;  <span class="comment">// 保存key值缓存对象</span></span><br><span class="line">  <span class="function">Object <span class="title">getObject</span><span class="params">(Object key)</span></span>;   <span class="comment">//通过 key 获取缓存对象</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">hasKey</span><span class="params">(Object key)</span></span>;   <span class="comment">// </span></span><br><span class="line">  <span class="function">Object <span class="title">removeObject</span><span class="params">(Object key)</span></span>; <span class="comment">// 通过 key 删除缓存对象</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;  <span class="comment">// 清空缓存</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了对你的缓存进行配置，只需要简单地在你的缓存实现中添加公有的 JavaBean 属性，然后通过 cache 元素传递属性值，例如，下面的例子将在你的缓存实现上调用一个名为 <code>setCacheFile(String file)</code> 的方法： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">type</span>=<span class="string">"com.domain.something.MyCustomCache"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheFile"</span> <span class="attr">value</span>=<span class="string">"/tmp/my-custom-cache.tmp"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​           你可以使用所有简单类型作为 JavaBean 属性的类型，MyBatis 会进行转换。 你也可以使用占位符（如 <code>${cache.file}</code>），以便替换成在<a href="https://mybatis.org/mybatis-3/zh/configuration.html#properties" target="_blank" rel="noopener">配置文件属性</a>中定义的值。         </p>
<p>​           从版本 3.4.2 开始，MyBatis 已经支持在所有属性设置完毕之后，调用一个初始化方法。如果想要使用这个特性，请在你的自定义缓存类里实现<code>org.apache.ibatis.builder.InitializingObject</code> 接口。         </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public interface InitializingObject &#123;</span><br><span class="line">  void initialize() throws Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>提示</code> 上一节中对缓存的配置（如清除策略、可读或可读写等），不能应用于自定义缓存。         </p>
<p>​      请注意，缓存的配置和缓存实例会被绑定到 SQL 映射文件的命名空间中。因此，同一命名空间中的所有语句和缓存将通过命名空间绑定在一起。每条语句可以自定义与缓存交互的方式，或将它们完全排除于缓存之外，这可以通过在每条语句上使用两个简单属性来达成。默认情况下，语句会这样来配置：         </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"false"</span> <span class="attr">useCache</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>鉴于这是默认行为，显然你永远不应该以这样的方式显式配置一条语句。但如果你想改变默认的行为，只需要设置 flushCache 和 useCache 属性。比如，某些情况下你可能希望特定 select 语句的结果排除于缓存之外，或希望一条 select 语句清空缓存。类似地，你可能希望某些  update 语句执行时不要刷新缓存。 </p>
<h4 id="cache-ref"><a href="#cache-ref" class="headerlink" title="cache-ref"></a>cache-ref</h4><p>对某一命名空间的语句，只会使用该命名空间的缓存进行缓存或刷新。 但你可能会想要在多个命名空间中共享相同的缓存配置和实例。要实现这种需求，你可以使用 cache-ref 元素来引用另一个缓存。 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache-ref</span> <span class="attr">namespace</span>=<span class="string">"com.someone.application.data.SomeMapper"</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="自定义二级缓存案例"><a href="#自定义二级缓存案例" class="headerlink" title="自定义二级缓存案例"></a>自定义二级缓存案例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyCache</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> cache.size();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"保存缓存"</span>);</span><br><span class="line">		cache.put(key, value);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"获取缓存"</span>);</span><br><span class="line">		<span class="keyword">return</span> cache.get(key);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">removeObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> cache.remove(key);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		cache.clear();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ReadWriteLock <span class="title">getReadWriteLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (getId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Cache instances require an ID."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Cache)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Cache otherCache = (Cache) o;</span><br><span class="line">		<span class="keyword">return</span> getId().equals(otherCache.getId());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (getId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Cache instances require an ID."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getId().hashCode();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>缓存cache</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（二）设置</title>
    <url>/2020/04/13/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BA%8C%EF%BC%89%E8%AE%BE%E7%BD%AE/</url>
    <content><![CDATA[<p>设置（setting) 在MyBatis 中是最复杂的配置，同时也是最为重要的配置内容之一，它会改变MyBatis 运行时的行为。及时不配置 settings, MyBatis 也可以正常的工作。</p>
<table>
<thead>
<tr>
<th><strong>设置参数</strong></th>
<th><strong>描述</strong></th>
<th><strong>有效值</strong></th>
<th><strong>默认值</strong></th>
</tr>
</thead>
<tbody><tr>
<td>cacheEnabled</td>
<td>该配置影响的所有映射器中配置的缓存的全局开关。</td>
<td>true | false</td>
<td>true</td>
</tr>
<tr>
<td>lazyLoadingEnabled</td>
<td>延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置fetchType属性来覆盖该项的开关状态。</td>
<td>true | false</td>
<td>false</td>
</tr>
<tr>
<td>aggressiveLazyLoading</td>
<td>当启用时，对任意延迟属性的调用会使带有延迟加载属性的对象完整加载；反之，每种属性将会按需加载。</td>
<td>true | false</td>
<td>true</td>
</tr>
<tr>
<td>multipleResultSetsEnabled</td>
<td>是否允许单一语句返回多结果集（需要兼容驱动）。</td>
<td>true | false</td>
<td>true</td>
</tr>
<tr>
<td>useColumnLabel</td>
<td>使用列标签代替列名。不同的驱动在这方面会有不同的表现， 具体可参考相关驱动文档或通过测试这两种不同的模式来观察所用驱动的结果。</td>
<td>true | false</td>
<td>true</td>
</tr>
<tr>
<td>useGeneratedKeys</td>
<td>允许 JDBC 支持自动生成主键，需要驱动兼容。 如果设置为 true 则这个设置强制使用自动生成主键，尽管一些驱动不能兼容但仍可正常工作（比如 Derby）。</td>
<td>true | false</td>
<td>False</td>
</tr>
<tr>
<td>autoMappingBehavior</td>
<td>指定 MyBatis 应如何自动映射列到字段或属性。 NONE 表示取消自动映射；PARTIAL 只会自动映射没有定义嵌套结果集映射的结果集。 FULL 会自动映射任意复杂的结果集（无论是否嵌套）。</td>
<td>NONE, PARTIAL, FULL</td>
<td>PARTIAL</td>
</tr>
<tr>
<td>autoMappingUnknownColumnBehavior</td>
<td>Specify the behavior when detects an unknown column (or unknown property type) of automatic mapping target.· NONE: Do nothing· WARNING: Output warning log (The log level of’org.apache.ibatis.session.AutoMappingUnknownColumnBehavior’must be set to WARN)· FAILING: Fail mapping (Throw SqlSessionException)</td>
<td>NONE, WARNING, FAILING</td>
<td>NONE</td>
</tr>
<tr>
<td>defaultExecutorType</td>
<td>配置默认的执行器。SIMPLE 就是普通的执行器；REUSE 执行器会重用预处理语句（prepared statements）； BATCH 执行器将重用语句并执行批量更新。</td>
<td>SIMPLE REUSE BATCH</td>
<td>SIMPLE</td>
</tr>
<tr>
<td>defaultStatementTimeout</td>
<td>设置超时时间，它决定驱动等待数据库响应的秒数。</td>
<td>Any positive integer</td>
<td>Not Set (null)</td>
</tr>
<tr>
<td>defaultFetchSize</td>
<td>Sets the driver a hint as to control fetching size for return results. This parameter value can be override by a query setting.</td>
<td>Any positive integer</td>
<td>Not Set (null)</td>
</tr>
<tr>
<td>safeRowBoundsEnabled</td>
<td>允许在嵌套语句中使用分页（RowBounds）。 If allow, set the false.</td>
<td>true | false</td>
<td>False</td>
</tr>
<tr>
<td>safeResultHandlerEnabled</td>
<td>允许在嵌套语句中使用分页（ResultHandler）。 If allow, set the false.</td>
<td>true | false</td>
<td>True</td>
</tr>
<tr>
<td>mapUnderscoreToCamelCase</td>
<td>是否开启自动驼峰命名规则（camel case）映射，即从经典数据库列名 A_COLUMN 到经典 Java 属性名 aColumn 的类似映射。</td>
<td>true | false</td>
<td>False</td>
</tr>
<tr>
<td>localCacheScope</td>
<td>MyBatis 利用本地缓存机制（Local Cache）防止循环引用（circular references）和加速重复嵌套查询。 默认值为 SESSION，这种情况下会缓存一个会话中执行的所有查询。 若设置值为 STATEMENT，本地会话仅用在语句执行上，对相同 SqlSession 的不同调用将不会共享数据。</td>
<td>SESSION | STATEMENT</td>
<td>SESSION</td>
</tr>
<tr>
<td>jdbcTypeForNull</td>
<td>当没有为参数提供特定的 JDBC 类型时，为空值指定 JDBC 类型。 某些驱动需要指定列的 JDBC 类型，多数情况直接用一般类型即可，比如 NULL、VARCHAR 或 OTHER。</td>
<td>JdbcType enumeration. Most common are: NULL, VARCHAR and OTHER</td>
<td>OTHER</td>
</tr>
<tr>
<td>lazyLoadTriggerMethods</td>
<td>指定哪个对象的方法触发一次延迟加载。</td>
<td>A method name list separated by commas</td>
<td>equals,clone,hashCode,toString</td>
</tr>
<tr>
<td>defaultScriptingLanguage</td>
<td>指定动态 SQL 生成的默认语言。</td>
<td>A type alias or fully qualified class name.</td>
<td>org.apache.ibatis.scripting.xmltags.XMLDynamicLanguageDriver</td>
</tr>
<tr>
<td>callSettersOnNulls</td>
<td>指定当结果集中值为 null 的时候是否调用映射对象的 setter（map 对象时为 put）方法，这对于有 Map.keySet() 依赖或 null 值初始化的时候是有用的。注意基本类型（int、boolean等）是不能设置成 null 的。</td>
<td>true | false</td>
<td>false</td>
</tr>
<tr>
<td>logPrefix</td>
<td>指定 MyBatis 增加到日志名称的前缀。</td>
<td>Any String</td>
<td>Not set</td>
</tr>
<tr>
<td>logImpl</td>
<td>指定 MyBatis 所用日志的具体实现，未指定时将自动查找。</td>
<td>SLF4J | LOG4J | LOG4J2 | JDK_LOGGING | COMMONS_LOGGING | STDOUT_LOGGING | NO_LOGGING</td>
<td>Not set</td>
</tr>
<tr>
<td>proxyFactory</td>
<td>指定 Mybatis 创建具有延迟加载能力的对象所用到的代理工具。</td>
<td>CGLIB | JAVASSIST</td>
<td>JAVASSIST (MyBatis 3.3 or above)</td>
</tr>
<tr>
<td>vfsImpl</td>
<td>Specifies VFS implementations  ( 指定 VFS 的实现 )</td>
<td>Fully qualified class names of custom VFS implementation separated by commas.</td>
<td>Not set</td>
</tr>
<tr>
<td>useActualParamName</td>
<td>允许使用方法签名中的名称作为语句参数名称。 为了使用该特性，你的项目必须采用 Java 8 编译，并且加上 <code>-parameters</code> 选项。（新增于 3.4.1）</td>
<td>true | false</td>
<td>true</td>
</tr>
</tbody></table>
<p>一个配置完整的 settings 元素的示例如下： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"multipleResultSetsEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useColumnLabel"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useGeneratedKeys"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"autoMappingBehavior"</span> <span class="attr">value</span>=<span class="string">"PARTIAL"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"autoMappingUnknownColumnBehavior"</span> <span class="attr">value</span>=<span class="string">"WARNING"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultExecutorType"</span> <span class="attr">value</span>=<span class="string">"SIMPLE"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultStatementTimeout"</span> <span class="attr">value</span>=<span class="string">"25"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultFetchSize"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"safeRowBoundsEnabled"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"localCacheScope"</span> <span class="attr">value</span>=<span class="string">"SESSION"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"jdbcTypeForNull"</span> <span class="attr">value</span>=<span class="string">"OTHER"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadTriggerMethods"</span> <span class="attr">value</span>=<span class="string">"equals,clone,hashCode,toString"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在大部分时候我们都不需要去配置它，或者只需要配置少数几项即可</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>设置</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis 配置（四）typeHandler 类型处理器</title>
    <url>/2020/04/16/mybatis-%E9%85%8D%E7%BD%AE%EF%BC%88%E5%9B%9B%EF%BC%89typeHandler-%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8-%E7%B3%BB%E7%BB%9F%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[<p>MyBatis 在设置预处理语句（PreparedStatement）中的参数或从结果集中取出一个值时， 都会用类型处理器将获取到的值以合适的方式转换成 Java 类型。下表描述了一些默认的类型处理器。 </p>
<p>提示 从 3.4.5 开始，MyBatis 默认支持 JSR-310（日期和时间 API） 。 </p>
<table>
<thead>
<tr>
<th><strong>类型处理器</strong></th>
<th><strong>Java 类型</strong></th>
<th><strong>JDBC 类型</strong></th>
</tr>
</thead>
<tbody><tr>
<td>BooleanTypeHandler</td>
<td>java.lang.Boolean, boolean</td>
<td>数据库兼容的 BOOLEAN</td>
</tr>
<tr>
<td>ByteTypeHandler</td>
<td>java.lang.Byte, byte</td>
<td>数据库兼容的 NUMERIC 或 BYTE</td>
</tr>
<tr>
<td>ShortTypeHandler</td>
<td>java.lang.Short, short</td>
<td>数据库兼容的 NUMERIC 或 SHORT INTEGER</td>
</tr>
<tr>
<td>IntegerTypeHandler</td>
<td>java.lang.Integer, int</td>
<td>数据库兼容的 NUMERIC 或 INTEGER</td>
</tr>
<tr>
<td>LongTypeHandler</td>
<td>java.lang.Long, long</td>
<td>数据库兼容的 NUMERIC 或 LONG INTEGER</td>
</tr>
<tr>
<td>FloatTypeHandler</td>
<td>java.lang.Float, float</td>
<td>数据库兼容的 NUMERIC 或 FLOAT</td>
</tr>
<tr>
<td>DoubleTypeHandler</td>
<td>java.lang.Double, double</td>
<td>数据库兼容的 NUMERIC 或 DOUBLE</td>
</tr>
<tr>
<td>BigDecimalTypeHandler</td>
<td>java.math.BigDecimal</td>
<td>数据库兼容的 NUMERIC 或 DECIMAL</td>
</tr>
<tr>
<td>StringTypeHandler</td>
<td>java.lang.String</td>
<td>CHAR, VARCHAR</td>
</tr>
<tr>
<td>ClobReaderTypeHandler</td>
<td>java.io.Reader</td>
<td>-</td>
</tr>
<tr>
<td>ClobTypeHandler</td>
<td>java.lang.String</td>
<td>CLOB, LONGVARCHAR</td>
</tr>
<tr>
<td>NStringTypeHandler</td>
<td>java.lang.String</td>
<td>NVARCHAR, NCHAR</td>
</tr>
<tr>
<td>NClobTypeHandler</td>
<td>java.lang.String</td>
<td>NCLOB</td>
</tr>
<tr>
<td>BlobInputStreamTypeHandler</td>
<td>java.io.InputStream</td>
<td>-</td>
</tr>
<tr>
<td>ByteArrayTypeHandler</td>
<td>byte[]</td>
<td>数据库兼容的字节流类型</td>
</tr>
<tr>
<td>BlobTypeHandler</td>
<td>byte[]</td>
<td>BLOB, LONGVARBINARY</td>
</tr>
<tr>
<td>DateTypeHandler</td>
<td>java.util.Date</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>DateOnlyTypeHandler</td>
<td>java.util.Date</td>
<td>DATE</td>
</tr>
<tr>
<td>TimeOnlyTypeHandler</td>
<td>java.util.Date</td>
<td>TIME</td>
</tr>
<tr>
<td>SqlTimestampTypeHandler</td>
<td>java.sql.Timestamp</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>SqlDateTypeHandler</td>
<td>java.sql.Date</td>
<td>DATE</td>
</tr>
<tr>
<td>SqlTimeTypeHandler</td>
<td>java.sql.Time</td>
<td>TIME</td>
</tr>
<tr>
<td>ObjectTypeHandler</td>
<td>Any</td>
<td>OTHER 或未指定类型</td>
</tr>
<tr>
<td>EnumTypeHandler</td>
<td>Enumeration Type</td>
<td>VARCHAR-任何兼容的字符串类型，存储枚举的名称（而不是索引）</td>
</tr>
<tr>
<td>EnumOrdinalTypeHandler</td>
<td>Enumeration Type</td>
<td>任何兼容的 NUMERIC 或 DOUBLE 类型，存储枚举的索引（而不是名称）。</td>
</tr>
</tbody></table>
<p>你可以重写已有的类型处理器或创建你自己的类型处理器来处理不支持的或非标准的类型。 具体做法为：实现 <code>org.apache.ibatis.type.TypeHandler</code> 接口， 或继承一个很便利的类 <code>org.apache.ibatis.type.BaseTypeHandler</code>， 并且可以（可选地）将它映射到一个 JDBC 类型。比如： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ExampleTypeHandler.java</span></span><br><span class="line"><span class="meta">@MappedJdbcTypes</span>(JdbcType.VARCHAR)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleTypeHandler</span> <span class="keyword">extends</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, String parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    ps.setString(i, parameter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">"org.mybatis.example.ExampleTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​           使用上述的类型处理器将会覆盖已有的处理 Java String 类型的属性以及VARCHAR 类型的参数和结果的类型处理器。要注意 MyBatis 不会通过检测数据库元信息来决定使用哪种类型，所以你必须在参数和结果映射中指明字段是 VARCHAR 类型， 以使其能够绑定到正确的类型处理器上。这是因为 MyBatis 直到语句被执行时才清楚数据类型。         </p>
<p>​           通过类型处理器的泛型，MyBatis 可以得知该类型处理器处理的 Java 类型，不过这种行为可以通过两种方法改变：         </p>
<ul>
<li>在类型处理器的配置元素（typeHandler 元素）上增加一个  <code>javaType</code> 属性（比如：<code>javaType=&quot;String&quot;</code>）；             </li>
<li>在类型处理器的类上增加一个 <code>@MappedTypes</code> 注解指定与其关联的 Java 类型列表。 如果在 <code>javaType</code> 属性中也同时指定，则注解上的配置将被忽略。           </li>
</ul>
<p>可以通过两种方式来指定关联的 JDBC 类型：</p>
<ul>
<li>在类型处理器的配置元素上增加一个 <code>jdbcType</code>   属性（比如：<code>jdbcType=&quot;VARCHAR&quot;</code>）；           </li>
<li>在类型处理器的类上增加一个 <code>@MappedJdbcTypes</code> 注解指定与其关联的 JDBC 类型列表。             如果在 <code>jdbcType</code> 属性中也同时指定，则注解上的配置将被忽略。           </li>
</ul>
<p>当在 <code>ResultMap</code> 中决定使用哪种类型处理器时，此时 Java类型是已知的（从结果类型中获得），但是 JDBC 类型是未知的。因此 Mybatis 使用 <code>javaType=[Java 类型], jdbcType=null</code>  的组合来选择一个类型处理器。这意味着使用 <code>@MappedJdbcTypes</code>   注解可以<em>限制</em>类型处理器的作用范围，并且可以确保，除非显式地设置，否则类型处理器在 <code>ResultMap</code> 中将不会生效。如果希望能在 <code>ResultMap</code> 中隐式地使用类型处理器，那么设置 <code>@MappedJdbcTypes</code> 注解的 <code>includeNullJdbcType=true</code> 即可。 然而从 Mybatis 3.4.0 开始，如果某个 Java 类型<strong>只有一个</strong>注册的类型处理器，即使没有设置 <code>includeNullJdbcType=true</code>，那么这个类型处理器也会是 <code>ResultMap</code> 使用 Java类型时的默认处理器。         </p>
<p>最后，可以让 MyBatis 帮你查找类型处理器：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"org.mybatis.example"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意在使用自动发现功能的时候，只能通过注解方式来指定 JDBC 的类型。</p>
<p>你可以创建能够处理多个类的泛型类型处理器。为了使用泛型类型处理器，需要增加一个接受该类的 class 作为参数的构造器，这样 MyBatis 会在构造一个类型处理器实例的时候传入一个具体的类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//GenericTypeHandler.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericTypeHandler</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">MyObject</span>&gt; <span class="keyword">extends</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Class&lt;E&gt; type;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">GenericTypeHandler</span><span class="params">(Class&lt;E&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Type argument cannot be null"</span>);</span><br><span class="line">    <span class="keyword">this</span>.type = type;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p><code>EnumTypeHandler</code> 和 <code>EnumOrdinalTypeHandler</code> 都是泛型类型处理器，我们将会在接下来的部分详细探讨。 </p>
<h3 id="处理枚举类型"><a href="#处理枚举类型" class="headerlink" title="处理枚举类型"></a>处理枚举类型</h3><p>若想映射枚举类型 <code>Enum</code>，则需要从 <code>EnumTypeHandler</code> 或者 <code>EnumOrdinalTypeHandler</code> 中选择一个来使用。</p>
<p>比如说我们想存储取近似值时用到的舍入模式。默认情况下，MyBatis 会利用 <code>EnumTypeHandler</code> 来把 <code>Enum</code> 值转换成对应的名字。</p>
<p>注意 <code>EnumTypeHandler</code> 在某种意义上来说是比较特别的，其它的处理器只针对某个特定的类，而它不同，它会处理任意继承了   <code>Enum</code> 的类。</p>
<p>不过，我们可能不想存储名字，相反我们的 DBA 会坚持使用整形值代码。那也一样简单：在配置文件中把  <code>EnumOrdinalTypeHandler</code> 加到 <code>typeHandlers</code> 中即可，这样每个 <code>RoundingMode</code> 将通过他们的序数值来映射成对应的整形数值。         </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span> <span class="attr">javaType</span>=<span class="string">"java.math.RoundingMode"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但要是你想在一个地方将 <code>Enum</code> 映射成字符串，在另外一个地方映射成整形值呢？</p>
<p>​           自动映射器（auto-mapper）会自动地选用 <code>EnumOrdinalTypeHandler</code> 来处理枚举类型，           所以如果我们想用普通的 <code>EnumTypeHandler</code>，就必须要显式地为那些 SQL 语句设置要使用的类型处理器。         </p>
<p>（下一节才开始介绍映射器文件，如果你是首次阅读该文档，你可能需要先跳过这里，过会再来看。）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">    <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"org.apache.ibatis.submitted.rounding.Mapper"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"org.apache.ibatis.submitted.rounding.User"</span> <span class="attr">id</span>=<span class="string">"usermap"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"funkyNumber"</span> <span class="attr">property</span>=<span class="string">"funkyNumber"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"roundingMode"</span> <span class="attr">property</span>=<span class="string">"roundingMode"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">resultMap</span>=<span class="string">"usermap"</span>&gt;</span></span><br><span class="line">		select * from users</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span>&gt;</span></span><br><span class="line">	    insert into users (id, name, funkyNumber, roundingMode) values (</span><br><span class="line">	    	#&#123;id&#125;, #&#123;name&#125;, #&#123;funkyNumber&#125;, #&#123;roundingMode&#125;</span><br><span class="line">	    )</span><br><span class="line">	<span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"org.apache.ibatis.submitted.rounding.User"</span> <span class="attr">id</span>=<span class="string">"usermap2"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"funkyNumber"</span> <span class="attr">property</span>=<span class="string">"funkyNumber"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"roundingMode"</span> <span class="attr">property</span>=<span class="string">"roundingMode"</span> <span class="attr">typeHandler</span>=<span class="string">"org.apache.ibatis.type.EnumTypeHandler"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser2"</span> <span class="attr">resultMap</span>=<span class="string">"usermap2"</span>&gt;</span></span><br><span class="line">		select * from users2</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert2"</span>&gt;</span></span><br><span class="line">	    insert into users2 (id, name, funkyNumber, roundingMode) values (</span><br><span class="line">	    	#&#123;id&#125;, #&#123;name&#125;, #&#123;funkyNumber&#125;, #&#123;roundingMode, typeHandler=org.apache.ibatis.type.EnumTypeHandler&#125;</span><br><span class="line">	    )</span><br><span class="line">	<span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意，这里的 select 语句必须指定 <code>resultMap</code> 而不是 <code>resultType</code>。 </p>
<p><strong>转载自： <a href="https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers</a></strong></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>配置</tag>
        <tag>typeHandler 类型处理器</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十六）JUC-线程调度-线程池-实现线程池的四种方式与实现原理</title>
    <url>/2020/04/22/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%E5%85%AD%EF%BC%89JUC-%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6-%E7%BA%BF%E7%A8%8B%E6%B1%A0-%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h3 id="分析四种线程池的创建的底层实现："><a href="#分析四种线程池的创建的底层实现：" class="headerlink" title="分析四种线程池的创建的底层实现："></a>分析四种线程池的创建的底层实现：</h3><img src="http://photo.wushaopei.com/qiniu464.png" width="60%">

<p>由上图中可知，四种线程其实都是有Executors来调用相应构造器实现创建的 </p>
<img src="http://photo.wushaopei.com/qiniu465.png" width="60%">

<p>由上图可知，<strong>newCachedThreadPool()</strong>创建可缓存的线程池底层实际还是调用<strong>ThreadPoolExecutor</strong>类的构造器返回的实例对象实现的。 </p>
<img src="http://photo.wushaopei.com/qiniu466.png" width="60%">

<p><strong>newFixedThreadPool（）</strong>创建定长线程池的底层也是由<strong>ThreadPoolExecutor</strong>类的构造器返回的实例对象实现的。 </p>
<img src="http://photo.wushaopei.com/qiniu467.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu468.png" width="60%">

<p>由上述两个图可知，newScheduledThreadPool（）创建定长且可定时的线程池的底层是由ScheduledThreadPoolExecutor类的构造器创建实例实现的；而ScheduledThreadPoolExecutor又继承了ThreadPoolExecutor类<br><img src="http://photo.wushaopei.com/qiniu469.png" width="60%"></p>
<p><strong>newSingleThreadExecutor</strong>（）创建单线程线程池的底层也是由ThreadPoolExecutor类的构造器返回的实例对象实现的。 </p>
<h3 id="代码实例演示线程池的实现："><a href="#代码实例演示线程池的实现：" class="headerlink" title="代码实例演示线程池的实现："></a>代码实例演示线程池的实现：</h3><h4 id="newCachedThreadPool-实现可缓存线程池："><a href="#newCachedThreadPool-实现可缓存线程池：" class="headerlink" title="newCachedThreadPool()实现可缓存线程池："></a>newCachedThreadPool()实现可缓存线程池：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService e = Executors.newCachedThreadPool();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">            e.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    log.info(<span class="string">"task:&#123;&#125;"</span> ,index);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        e.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">22:59:26.711 [pool-1-thread-2] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:1</span><br><span class="line">22:59:26.711 [pool-1-thread-3] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:2</span><br><span class="line">22:59:26.711 [pool-1-thread-6] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:5</span><br><span class="line">22:59:26.711 [pool-1-thread-9] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:8</span><br><span class="line">22:59:26.711 [pool-1-thread-8] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:7</span><br><span class="line">22:59:26.711 [pool-1-thread-1] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:0</span><br><span class="line">22:59:26.711 [pool-1-thread-7] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:6</span><br><span class="line">22:59:26.711 [pool-1-thread-10] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:9</span><br><span class="line">22:59:26.711 [pool-1-thread-4] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:3</span><br><span class="line">22:59:26.711 [pool-1-thread-5] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample1 - task:4</span><br><span class="line"> </span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h4 id="newFixedThreadPool-实现定长线程池："><a href="#newFixedThreadPool-实现定长线程池：" class="headerlink" title="newFixedThreadPool()实现定长线程池："></a>newFixedThreadPool()实现定长线程池：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        ExecutorService e = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">            e.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    log.info(<span class="string">"task:&#123;&#125;"</span> ,index);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        e.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.958</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.958</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.958</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.964</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.964</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">5</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.964</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.964</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">6</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.964</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">8</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.964</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">7</span></span><br><span class="line"><span class="number">23</span>:<span class="number">02</span>:<span class="number">02.964</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample2 - task:<span class="number">9</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="newSingleThreadExecutor（）创建单线程线程池："><a href="#newSingleThreadExecutor（）创建单线程线程池：" class="headerlink" title="newSingleThreadExecutor（）创建单线程线程池："></a>newSingleThreadExecutor（）创建单线程线程池：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ExecutorService e = Executors.newSingleThreadExecutor();</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.663</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">5</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">6</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">7</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">8</span></span><br><span class="line"><span class="number">23</span>:<span class="number">04</span>:<span class="number">33.670</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample3 - task:<span class="number">9</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，单线程线程池中，线程任务的执行是有序的。 </p>
<h4 id="newScheduledThreadPool（）创建定长的线程池："><a href="#newScheduledThreadPool（）创建定长的线程池：" class="headerlink" title="newScheduledThreadPool（）创建定长的线程池："></a>newScheduledThreadPool（）创建定长的线程池：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ScheduledExecutorService executorService = Executors.newScheduledThreadPool(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.452</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.452</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.452</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.452</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.459</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">6</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.459</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">7</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.459</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">8</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.459</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">9</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.452</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">51.459</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] INFO com.mmall.concurrency.example.threadPool.ThreadPoolExample4 - task:<span class="number">5</span></span><br></pre></td></tr></table></figure>

<h4 id="newScheduledThreadPool（）创建定长且可定时的线程池："><a href="#newScheduledThreadPool（）创建定长且可定时的线程池：" class="headerlink" title="newScheduledThreadPool（）创建定长且可定时的线程池："></a>newScheduledThreadPool（）创建定长且可定时的线程池：</h4><p>单次执行定时任务： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">executorService.schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"schedule run"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="number">3</span>, TimeUnit.SECONDS);  <span class="comment">//定时执行，3秒后执行任务</span></span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">15</span>:<span class="number">13.526</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br></pre></td></tr></table></figure>

<p>延迟多次执行定时任务： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">executorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"schedule run"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="number">1</span>,<span class="number">3</span>, TimeUnit.SECONDS);  <span class="comment">// 以指定的延迟去执行任务，每隔3秒执行一次任务</span></span><br></pre></td></tr></table></figure>

<p>执行并打印结果： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">16</span>:<span class="number">22.111</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br><span class="line"><span class="number">23</span>:<span class="number">16</span>:<span class="number">25.110</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br><span class="line"><span class="number">23</span>:<span class="number">16</span>:<span class="number">28.110</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br><span class="line"><span class="number">23</span>:<span class="number">16</span>:<span class="number">31.109</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br><span class="line"><span class="number">23</span>:<span class="number">16</span>:<span class="number">34.109</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br><span class="line"><span class="number">23</span>:<span class="number">16</span>:<span class="number">37.109</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br><span class="line"><span class="number">23</span>:<span class="number">16</span>:<span class="number">40.109</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] WARN com.mmall.concurrency.example.threadPool.ThreadPoolExample5 - schedule run</span><br></pre></td></tr></table></figure>

<h3 id="线程池-合理配置"><a href="#线程池-合理配置" class="headerlink" title="线程池 - 合理配置"></a>线程池 - 合理配置</h3><blockquote>
<ul>
<li>CPU密集型任务，就需要尽量压榨CPU，参考值可以设为 NCPU + 1</li>
<li>IO密集型任务，参考值可以设置为2*NCPU</li>
</ul>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>实现多线程的四种方式</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（二十）J-U-C-AQS-ReentrantReadWriteLock、StampedLock、Condition</title>
    <url>/2020/04/14/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%E5%8D%81%EF%BC%89J-U-C-AQS-ReentrantReadWriteLock%E3%80%81StampedLock%E3%80%81Condition/</url>
    <content><![CDATA[<h3 id="ReentrantReadWriteLock实例代码演示："><a href="#ReentrantReadWriteLock实例代码演示：" class="headerlink" title="ReentrantReadWriteLock实例代码演示："></a>ReentrantReadWriteLock实例代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockExample3</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Data&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock readLock = lock.readLock();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock writeLock = lock.writeLock();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Data <span class="title">get</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">        readLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> map.get(key);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getAllKeys</span><span class="params">()</span></span>&#123;</span><br><span class="line">        readLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> map.keySet();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Data <span class="title">put</span><span class="params">(String key,Data value)</span></span>&#123;</span><br><span class="line">        writeLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> map.put(key,value);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Data</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*<em>说明： *</em>一个类里面封装了一个内部的map，这个map不需要把所有的方法都暴露给别人，它们要做的事情完全都通过我提供的方法来使用。而我提供一些单独的方法来给外部使用，使用的时候为了避免发生并发的问题，可以加上ReentrantReadWriteLock来实现在读和写的时候分别加锁。只有在没有读写锁的时候才能进行相应的插入操作或读操作。</p>
<p>​    这里实现的是悲观读取。</p>
<p>​    在进行新的插入操作时，必须要当前执行的插入或读操作完成后才能继续执行。</p>
<p>​    如果发生写入很多，而读取很少的时候，使用ReentrantReadWriteLock类就可能会遭遇饥饿。所谓饥饿，就是代码中的</p>
<img src="http://photo.wushaopei.com/qiniu329.png" width="60%">

<p>写锁一直想执行，但是大量的读操作就会导致写操作永远都无法执行，一直在等待，而不知道什么时候能真正的去执行这个写操作。 </p>
<h3 id="另一种锁：StampedLock"><a href="#另一种锁：StampedLock" class="headerlink" title="另一种锁：StampedLock"></a>另一种锁：StampedLock</h3><p>StampedLock控制锁有3中模式，分别是：写、读、乐观读（重点）</p>
<p>一个StampedLock的状态是有版本和模式两个部分组成，锁获取的方法是返回一个数字作为票据（stamped）。它用相应的锁状态来表示并控制相关锁的访问。数字0表示没有写锁被访问；读锁被分为悲观锁和乐观锁；所谓乐观读是写的操作很多，读的操作很少的情况下，我们可以认为写入和读取同时发生的几率很少，因此不悲观的使用完全读取锁定，程序可以采取查看</p>
<p>读取资料之后，是否遭到写入执行的变更，再采取后续的措施。这一个相应的改进可以大幅度提高程序的吞吐量。</p>
<h3 id="StampedLock实例代码演示："><a href="#StampedLock实例代码演示：" class="headerlink" title="StampedLock实例代码演示："></a>StampedLock实例代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockExample4</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">double</span> x, y;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> StampedLock sl = <span class="keyword">new</span> StampedLock();</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">move</span><span class="params">(<span class="keyword">double</span> deltaX, <span class="keyword">double</span> deltaY)</span> </span>&#123; <span class="comment">// an exclusively locked method</span></span><br><span class="line">            <span class="keyword">long</span> stamp = sl.writeLock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                x += deltaX;</span><br><span class="line">                y += deltaY;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                sl.unlockWrite(stamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//下面看看乐观读锁案例</span></span><br><span class="line">        <span class="function"><span class="keyword">double</span> <span class="title">distanceFromOrigin</span><span class="params">()</span> </span>&#123; <span class="comment">// A read-only method</span></span><br><span class="line">            <span class="keyword">long</span> stamp = sl.tryOptimisticRead(); <span class="comment">//获得一个乐观读锁</span></span><br><span class="line">            <span class="keyword">double</span> currentX = x, currentY = y;  <span class="comment">//将两个字段读入本地局部变量</span></span><br><span class="line">            <span class="keyword">if</span> (!sl.validate(stamp)) &#123; <span class="comment">//检查发出乐观读锁后同时是否有其他写锁发生？</span></span><br><span class="line">                stamp = sl.readLock();  <span class="comment">//如果没有，我们再次获得一个读悲观锁</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    currentX = x; <span class="comment">// 将两个字段读入本地局部变量</span></span><br><span class="line">                    currentY = y; <span class="comment">// 将两个字段读入本地局部变量</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sl.unlockRead(stamp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Math.sqrt(currentX * currentX + currentY * currentY);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//下面是悲观读锁案例</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">moveIfAtOrigin</span><span class="params">(<span class="keyword">double</span> newX, <span class="keyword">double</span> newY)</span> </span>&#123; <span class="comment">// upgrade</span></span><br><span class="line">            <span class="comment">// Could instead start with optimistic, not read mode</span></span><br><span class="line">            <span class="keyword">long</span> stamp = sl.readLock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (x == <span class="number">0.0</span> &amp;&amp; y == <span class="number">0.0</span>) &#123; <span class="comment">//循环，检查当前状态是否符合</span></span><br><span class="line">                    <span class="keyword">long</span> ws = sl.tryConvertToWriteLock(stamp); <span class="comment">//将读锁转为写锁</span></span><br><span class="line">                    <span class="keyword">if</span> (ws != <span class="number">0L</span>) &#123; <span class="comment">//这是确认转为写锁是否成功</span></span><br><span class="line">                        stamp = ws; <span class="comment">//如果成功 替换票据</span></span><br><span class="line">                        x = newX; <span class="comment">//进行状态改变</span></span><br><span class="line">                        y = newY;  <span class="comment">//进行状态改变</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">//如果不能成功转换为写锁</span></span><br><span class="line">                        sl.unlockRead(stamp);  <span class="comment">//我们显式释放读锁</span></span><br><span class="line">                        stamp = sl.writeLock();  <span class="comment">//显式直接进行写锁 然后再通过循环再试</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                sl.unlock(stamp); <span class="comment">//释放读锁或写锁</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="StampedLock实例代码演示：-1"><a href="#StampedLock实例代码演示：-1" class="headerlink" title="StampedLock实例代码演示："></a>StampedLock实例代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockExample5</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count );</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">long</span> stamped = lock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            count ++;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="代码演示Condition的作用："><a href="#代码演示Condition的作用：" class="headerlink" title="代码演示Condition的作用："></a>代码演示Condition的作用：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> </span><br><span class="line">    ReentrantLock reentrantLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    Condition condition = reentrantLock.newCondition();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reentrantLock.lock();</span><br><span class="line">            log.info(<span class="string">"wait signal"</span>);<span class="comment">// 1</span></span><br><span class="line">            condition.await();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"get signal"</span>);<span class="comment">//  4</span></span><br><span class="line">        reentrantLock.unlock();</span><br><span class="line"> </span><br><span class="line">    &#125;).start();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        log.info(<span class="string">"get lock"</span>);<span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        condition.signalAll();</span><br><span class="line">        log.info(<span class="string">"send signal"</span>); <span class="comment">//   3</span></span><br><span class="line">        reentrantLock.unlock();</span><br><span class="line">    &#125;).start();</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">33.234</span> [Thread-<span class="number">0</span>] INFO com.mmall.concurrency.example.lock.LockExample6 - wait signal</span><br><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">33.238</span> [Thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.lock.LockExample6 - get lock</span><br><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">36.238</span> [Thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.lock.LockExample6 - send signal</span><br><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">36.238</span> [Thread-<span class="number">0</span>] INFO com.mmall.concurrency.example.lock.LockExample6 - get signal</span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>结果分析：</strong> </p>
<p>首先，我们定义了一个ReentrantLock的实例，从实例中取出了一个Condition，也就是reentrantLock.newCondition();操作；</p>
<p>在main方法中，我们声明了两个线程Thread方法，按顺序命名为T1和T2.</p>
<p>在T1中，使用reentrantLock.lock()方法将线程T1加入到了AQS的等待队列里面，接着线程T1输出了“wait signal”日志信息，紧接着T1中调用了condition.await()方法，这时就将T1从AQS的等待队列中移除了，该操作对应了锁的释放。</p>
<img src="http://photo.wushaopei.com/qiniu330.png" width="80%">

<p>接着，它就加入到了condition的等待队列中去了，等待这该线程需要的序号。这里对应了AQS原理图中的Condidtion queue,如上图。</p>
<p>线程T2因为线程T1释放锁的关系被唤醒，并判断它是否可以取到锁，于是获取锁，也加入到了，AQS的Sync queue等待队列中，当执行取锁任务后，就继续执行后续的日志打印“get lock”操作，线程T2在执行打印完成后，接着执行condition.signalAll()方法，紧接着就输出了后续的日志打印操作“send signal ”发送信号操作，</p>
<p>而此时condition线程队列中有线程T1的一个节点，于是它就被取出来加入到了AQS的等待队列里面去。注意：此时线程T1并没有被唤醒，只是加入到了AQS服务里面的Sync queue队列里面。</p>
<p>当线程T2的signaAll()发送信号的方法执行完成以后，调用了reentrantLock.unlock()方法，就释放了锁。此时在AQS的Sync queue队列中只有线程T1的线程，而AQS按照线程从头到尾的顺序唤醒了T1线程。于是线程T1继续开始执行，继续执行的时候就得到了最后的线程输出，即“get signal”日志的打印。</p>
<p>通过以上代码执行的结果以及对执行过程的分析，可以看得出来，Condition也是多线程间协调通讯的工具类。使得某个或某个线程一直等待条件（unlock()），只有当该条件具备，这些等待的线程才会被唤醒。以上案例中，唤醒所具备的条件就是等待的信号，包含signal和signalAll这两个方法，分别用于唤醒一个或多个等待的线程。这些被唤醒的线程会重新按顺序获得锁，并执行相应的业务操作。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>AQS</tag>
        <tag>可重入锁</tag>
        <tag>ReentrantLock</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十三）线程安全策略-同步容器</title>
    <url>/2020/04/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8/</url>
    <content><![CDATA[<h2 id="线程安全的同步容器："><a href="#线程安全的同步容器：" class="headerlink" title="线程安全的同步容器："></a><strong>线程安全的同步容器：</strong></h2><blockquote>
<p>ArrayList - &gt; Vecotr , Stack</p>
<p>HashMap - &gt; HashTable (key 、value 不能为 null)</p>
<p>Collections.synchronizedXXX(List、Set、Map)</p>
</blockquote>
<ul>
<li>在多线程环境下，要使用ArrayList时，可以使用Vector、Stack替代</li>
<li>在多线程环境下，要使用HashMap时，可以使用HashTable替代</li>
<li>HashTable底层实现使用synchronized进行修饰，同步锁的存在保证了线程的安全。</li>
</ul>
<h3 id="Vector线程安全测试："><a href="#Vector线程安全测试：" class="headerlink" title="Vector线程安全测试："></a>Vector线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VectorExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;Integer&gt; list = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">35</span>:<span class="number">31.360</span> [main] INFO com.mmall.concurrency.example.syncContainer.VectorExample1 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度为5000，说明了Vector的add操作在多线程并发环境下是线程安全的。 </p>
<p><strong>注意</strong>：即使是线程安全的Vector也可能发生<strong>线程不安全</strong>的情况，如下演示 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VectorExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;Integer&gt; vector = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++ )&#123;</span><br><span class="line">                vector.add(i);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            Thread thread1 = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; vector.size() ; i++)&#123;</span><br><span class="line">                        vector.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            Thread thread2 = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; vector.size() ; i++)&#123;</span><br><span class="line">                        vector.get(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            thread1.start();</span><br><span class="line">            thread2.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu285.png" width="60%">

<p>如图，vector的多线程操作发生了异常，全都集中在执行get()操作时，一直发生数组索引越界的异常问题。</p>
<p><strong>原因分析：</strong>vector 是一个线程同步容器，所有的remove操作都是有synchronized修饰的，get操作也是有synchronized修饰的，如图：</p>
<img src="http://photo.wushaopei.com/qiniu286.png" width="60%">



<img src="http://photo.wushaopei.com/qiniu287.png" width="60%">

<blockquote>
<p>在Vector中由于有synchronized同步锁机制，保证了当前两个线程即thread1 和 thread2 是属于两个独立的同步线程；但是，在实际执行代码的过程中，当thread1执行了remove（）删除操作时，thread2正好也执行到了get()方法，两者由于相对独立且同步，所以当thread1删除了某个索引的值时，thread2依旧会去get()获取那个索引位的值，但这时候对应的值已经被删除了，所以java会抛出索引越界的异常来提示用户，当前所要get()的值是不存在的。</p>
</blockquote>
<h3 id="将HashMap替换成Hashtable实现线程安全："><a href="#将HashMap替换成Hashtable实现线程安全：" class="headerlink" title="将HashMap替换成Hashtable实现线程安全："></a>将HashMap替换成Hashtable实现线程安全：</h3><p><strong>代码演示：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashTableExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">08.814</span> [main] INFO com.mmall.concurrency.example.syncContainer.HashTableExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为5000，说明了<strong>HashTable</strong>的<strong>put</strong>操作在多线程并发环境下是<strong>线程安全</strong>的。</p>
<p>*<em>源码查看： *</em></p>
<img src="http://photo.wushaopei.com/qiniu288.png" width="60%">

<p>由上图可知，<strong>HashTable</strong>的<strong>put</strong>、<strong>remove</strong>等方法的<strong>底层实现</strong>都是使用<strong>synchronized</strong>修饰的，是<strong>线程安全</strong>的。 </p>
<h3 id="synchronizedList测试线程安全："><a href="#synchronizedList测试线程安全：" class="headerlink" title="synchronizedList测试线程安全："></a>synchronizedList测试线程安全：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionsExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = Collections.synchronizedList(Lists.newArrayList());</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">20</span>:<span class="number">59.015</span> [main] INFO com.mmall.concurrency.example.syncContainer.CollectionsExample2 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知<strong>：size的</strong>长度<strong>为5000</strong>，说明了<strong>synchronizedSet</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h3 id="synchronizedSet测试线程安全："><a href="#synchronizedSet测试线程安全：" class="headerlink" title="synchronizedSet测试线程安全："></a>synchronizedSet测试线程安全：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionsExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = Collections.synchronizedSet(Sets.newHashSet());</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">20</span>:<span class="number">59.015</span> [main] INFO com.mmall.concurrency.example.syncContainer.CollectionsExample2 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知<strong>：size的</strong>长度<strong>为5000</strong>，说明了<strong>synchronizedSet</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h3 id="synchronizedMap测试线程安全："><a href="#synchronizedMap测试线程安全：" class="headerlink" title="synchronizedMap测试线程安全："></a>synchronizedMap测试线程安全：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMapExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> HashMap&lt;Integer,Integer&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">         map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">23</span>:<span class="number">13.660</span> [main] INFO com.mmall.concurrency.example.syncContainer.CollectionsExample13 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：<strong>size</strong>的长度为<strong>5000</strong>，说明了<strong>synchronizedMap</strong>的<strong>put操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>线程不安全类</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十二）线程安全策略-线程不安全类与写法</title>
    <url>/2020/04/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E7%B1%BB%E4%B8%8E%E5%86%99%E6%B3%95/</url>
    <content><![CDATA[<h1 id="线程不安全类"><a href="#线程不安全类" class="headerlink" title="线程不安全类"></a>线程不安全类</h1><p><strong>线程不安全的类：</strong>如果一个类的对象同时可以被多个线程访问，如果你不做特殊的同步处理。那么，它就容易表现出线程不安全的现象。</p>
<blockquote>
<p><strong>如：</strong>抛出异常、逻辑处理错误等等。</p>
</blockquote>
<p>这种类就成为<strong>线程不安全</strong>的类。</p>
<h2 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StringBuilder - &gt; StringBuffer</span><br></pre></td></tr></table></figure>

<h3 id="StringBuilder-线程安全代码演示："><a href="#StringBuilder-线程安全代码演示：" class="headerlink" title="StringBuilder 线程安全代码演示："></a><strong>StringBuilder</strong> 线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.commonUnsafe;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> StringExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 12:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringExample1</span> </span>&#123;</span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,stringBuilder.length());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        stringBuilder.append(<span class="string">"1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果线程安全的话，打印结果应该为5000！ </p>
</blockquote>
<p><strong>执行打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">48</span>:<span class="number">15.598</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.StringExample1 - size:<span class="number">4937</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由打印结果可知，<strong>size的值小于5000</strong>，意味着<strong>StringBuilder</strong>是线程<strong>不安全</strong>的类。 </p>
<h3 id="StringBuffer-线程安全代码演示："><a href="#StringBuffer-线程安全代码演示：" class="headerlink" title="StringBuffer 线程安全代码演示："></a><strong>StringBuffer</strong> 线程安全代码演示：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br></pre></td></tr></table></figure>

<p><strong>执行打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">51</span>:<span class="number">06.859</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.StringExample2 - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由打印结果可知，size的值<strong>等于5000</strong>，意味着<strong>StringBuffer</strong>是<strong>线程安全</strong>的类。 </p>
<h3 id="StringBuffer和StringBuilder线程分析："><a href="#StringBuffer和StringBuilder线程分析：" class="headerlink" title="StringBuffer和StringBuilder线程分析："></a>StringBuffer和StringBuilder线程分析：</h3><img src="http://photo.wushaopei.com/qiniu278.png" width="60%">

<p>由截图可知，<strong>StringBuffer</strong>的底层实现方法都添加<strong>synchronized</strong>同步锁，是<strong>线程安全的</strong>。</p>
<img src="http://photo.wushaopei.com/qiniu279.png" width="60%">

<p>而<strong>StringBuilder</strong>底层的方法没有添加<strong>synchronized</strong>同步锁，<strong>存在线程安全</strong>的问题。 </p>
<h3 id="为什么java要同时提供StringBuilder和StringBuffer两个类？"><a href="#为什么java要同时提供StringBuilder和StringBuffer两个类？" class="headerlink" title="为什么java要同时提供StringBuilder和StringBuffer两个类？"></a>为什么java要同时提供<strong>StringBuilder</strong>和<strong>StringBuffer</strong>两个类？</h3><p>之所以java同时提供StringBuilder和StringBuffer两个线程安全和不安全的类，是因为在StringBuffer中，使用synchronized锁机制会导致同时只有一个线程可以操作该对象，对性能和效率有损耗。StringBuffer只有在多线程并发且声明为成员变量时使用就可以保证线程的安全；而在业务层逻辑方法中声明StringBuilder局部变量时，由于存在堆栈封闭的关系，同一时间内只会有一个线程调用该类变量，所以不存在线程安全的问题。</p>
<h2 id="日期转换的类"><a href="#日期转换的类" class="headerlink" title="日期转换的类"></a>日期转换的类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SimpleDateFormat - &gt; JodaTimie</span><br></pre></td></tr></table></figure>



<h3 id="SimpleDateFormat类线程安全测试："><a href="#SimpleDateFormat类线程安全测试：" class="headerlink" title="SimpleDateFormat类线程安全测试："></a>SimpleDateFormat类线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateFormatExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            simpleDateFormat.parse(<span class="string">"20191101"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            log.error(<span class="string">"parse exception"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">25</span>:<span class="number">08.453</span> [pool-<span class="number">1</span>-thread-<span class="number">162</span>] ERROR com.mmall.concurrency.example.commonUnsafe.DateFormatExample1 - parse exception</span><br><span class="line">java.lang.NumberFormatException: multiple points</span><br><span class="line">	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:<span class="number">1890</span>)</span><br><span class="line">	at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:<span class="number">110</span>)</span><br><span class="line">	....................</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.update(DateFormatExample1.java:<span class="number">51</span>)</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.lambda$main$<span class="number">0</span>(DateFormatExample1.java:<span class="number">37</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line"><span class="number">14</span>:<span class="number">25</span>:<span class="number">08.446</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] ERROR com.mmall.concurrency.example.commonUnsafe.DateFormatExample1 - parse exception</span><br><span class="line">java.lang.NumberFormatException: For input string: <span class="string">".20192019E"</span></span><br><span class="line">	at java.lang.NumberFormatException.forInputString(NumberFormatException.java:<span class="number">65</span>)</span><br><span class="line">	at java.lang.Long.parseLong(Long.java:<span class="number">578</span>)</span><br><span class="line">	..........</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.update(DateFormatExample1.java:<span class="number">51</span>)</span><br><span class="line">	at com.mmall.concurrency.example.commonUnsafe.DateFormatExample1.lambda$main$<span class="number">0</span>(DateFormatExample1.java:<span class="number">37</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">	............</span><br></pre></td></tr></table></figure>

<p>由执行结果可知，<strong>SimpleDateFormat</strong>在进行并发执行时抛出了大量异常，这说明了<strong>SimpleDateFormat</strong>类的线程是不安全的。<strong>SimpleDateFormat</strong>声明的实例<strong>不能直接以成员变量的形式声明</strong>来被多线程使用。 </p>
<h3 id="正确使用SimpleDateFormat类，应该以局部变量的方式声明该类的实例："><a href="#正确使用SimpleDateFormat类，应该以局部变量的方式声明该类的实例：" class="headerlink" title="正确使用SimpleDateFormat类，应该以局部变量的方式声明该类的实例："></a>正确使用SimpleDateFormat类，应该以<strong>局部变量的方式</strong>声明该类的实例：</h3><p>代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">        simpleDateFormat.parse(<span class="string">"20191101"</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.error(<span class="string">"parse exception"</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果没有抛出异常：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//空行</span></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>注意： **多线程并发使用SimpleDateFormat类时，一定要在方法中以</strong>局部变量的方式声明**该类的实例。从而避免线程安全的问题。 </p>
<h3 id="JodaTimie类线程安全测试："><a href="#JodaTimie类线程安全测试：" class="headerlink" title="JodaTimie类线程安全测试："></a>JodaTimie类线程安全测试：</h3><p><strong>导入依赖：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>代码段：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//声明DateTimeFormatter实例</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> DateTimeFormatter dateTimeFormatter = DateTimeFormat.forPattern(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line"><span class="comment">//获取当前线程次序</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> count = i;</span><br><span class="line"><span class="comment">//传递线程次序</span></span><br><span class="line">update(count);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//update方法中日志输出线程执行结果</span></span><br><span class="line">log.info(<span class="string">"&#123;&#125;, &#123;&#125;"</span>,i,DateTime.parse(<span class="string">"20191101"</span>,dateTimeFormatter).toDate());</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu280.png" width="60%">

<p><strong>由执行结果可知，</strong>虽然DateTimeFormatter 实例结果是乱序输出的，但是执行线程总数是完全符合要求的，所以DateTimeFormatter的线程是安全的。 </p>
<h2 id="集合类"><a href="#集合类" class="headerlink" title="集合类"></a>集合类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ArrayList , HashSet , HashMap 等 Collections</span><br></pre></td></tr></table></figure>

<h3 id="ArrayList线程安全测试："><a href="#ArrayList线程安全测试：" class="headerlink" title="ArrayList线程安全测试："></a>ArrayList线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayListExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">02</span>:<span class="number">53.644</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.ArrayListExample - size:<span class="number">4892</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度不为5000，说明了ArrayList的<strong>add操作</strong>在多线程并发环境下是<strong>线程不安全</strong>的。 </p>
<h3 id="HashSet线程安全测试："><a href="#HashSet线程安全测试：" class="headerlink" title="HashSet线程安全测试："></a>HashSet线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;Integer&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//获取当前线程次序</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> count = i;</span><br><span class="line"><span class="comment">//传递线程次序</span></span><br><span class="line">update(count);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//update方法中日志输出线程执行结果</span></span><br><span class="line">log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">    set.add(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">23.554</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.HashSetExample - size:<span class="number">4864</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度不为5000，说明了<strong>HashSet</strong>的<strong>add操作</strong>在多线程并发环境下也是<strong>线程不安全</strong>的。 </p>
<h3 id="HashMap线程安全测试："><a href="#HashMap线程安全测试：" class="headerlink" title="HashMap线程安全测试："></a>HashMap线程安全测试：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> HashMap&lt;Integer,Integer&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//获取当前线程次序</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> count = i;</span><br><span class="line"><span class="comment">//传递线程次序</span></span><br><span class="line">update(count);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//update方法中日志输出线程执行结果</span></span><br><span class="line">log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">   map.put(i,i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行并打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">16</span>:<span class="number">26.117</span> [main] INFO com.mmall.concurrency.example.commonUnsafe.HashMapExample - size:<span class="number">4870</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知，size的长度<strong>不为5000</strong>，说明了<strong>HashMap</strong>的<strong>add操作</strong>在多线程并发环境下也是<strong>线程不安全</strong>的。 </p>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><blockquote>
<p>先检查再执行： if(condition(a)) { handle(a) ; } </p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>线程不安全类</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（八）线程安全性-内存可见性-synchronized、volatile</title>
    <url>/2020/03/28/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%85%AB%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E5%86%85%E5%AD%98%E5%8F%AF%E8%A7%81%E6%80%A7-synchronized%E3%80%81volatile/</url>
    <content><![CDATA[<p>说明： <strong>多线程的内存可见性涉及到多线程间的数据争用，也涉及到了多线程间的数据可见性</strong> </p>
<h2 id="共享变量在线程间的可见性"><a href="#共享变量在线程间的可见性" class="headerlink" title="共享变量在线程间的可见性"></a>共享变量在线程间的可见性</h2><h3 id="内存可见性介绍："><a href="#内存可见性介绍：" class="headerlink" title="内存可见性介绍："></a>内存可见性介绍：</h3><p><strong>可见性：</strong> 一个线程对共享变量值的修改，能够及时地被其他线程看到。</p>
<p><strong>共享变量：</strong>如果一个变量在多个线程的工作内存中都存在副本，那么这个变量就是这几个线程的共享变量。</p>
<h3 id="Java内存模型（JMM）"><a href="#Java内存模型（JMM）" class="headerlink" title="Java内存模型（JMM）"></a>Java内存模型（JMM）</h3><p><strong>Java内存模型（Java Memory Model）</strong>描述了Java程序中各种变量（线程共享变量）的访问规则，以及在JVM中将变量存储到内存和从内存中读取出变量这样的底层细节。 </p>
<h4 id="在内存模型中："><a href="#在内存模型中：" class="headerlink" title="在内存模型中："></a><strong>在内存模型中：</strong></h4><blockquote>
<p>所有的变量都存储在主内存中；</p>
<p>每个线程都有自己独立的工作内存，里面保存该线程使用到的变量的副本（主内存中该变量的一份拷贝）</p>
</blockquote>
<h4 id="内存模型图："><a href="#内存模型图：" class="headerlink" title="内存模型图："></a><strong>内存模型图：</strong></h4><img src="http://photo.wushaopei.com/qiniu244.png" width="80%">

<h4 id="JMM线程操作内存的两条基本的规定："><a href="#JMM线程操作内存的两条基本的规定：" class="headerlink" title="JMM线程操作内存的两条基本的规定："></a><strong>JMM线程操作内存的两条基本的规定：</strong></h4><blockquote>
<p>第一条关于线程与主内存：线程对共享变量的所有操作都必须在自己的工作内存中进行，不能直接从主内存中读写</p>
<p>第二条关于线程间工作内存：不同线程之间无法直接访问其他线程工作内存中的变量，线程间变量值的传递需要经过主内存来完成。</p>
</blockquote>
<h3 id="共享变量可见性实现的原理："><a href="#共享变量可见性实现的原理：" class="headerlink" title="共享变量可见性实现的原理："></a>共享变量可见性实现的原理：</h3><p>线程1对共享变量的修改要想被线程2及时看到，必须要经过如下<strong>2个步骤</strong>：</p>
<ul>
<li>把工作内存1中更新过的共享变量刷新到主内存中</li>
<li>把住内存中最新的共享变量的值更新到工作内存2中</li>
</ul>
<h4 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a><strong>流程图：</strong></h4><img src="http://photo.wushaopei.com/qiniu245.png" width="80%">



<h2 id="synchronized实现可见性"><a href="#synchronized实现可见性" class="headerlink" title="synchronized实现可见性"></a>synchronized实现可见性</h2><p>由前面可以知道，要<strong>实现共享变量的可见性，必须保证两点</strong>：</p>
<ul>
<li>线程修改后的共享变量值能够及时从工作内存刷新到主内存中；</li>
<li>其他线程能够及时把共享变量的最新值从住内存更新到自己的工作内存中</li>
</ul>
<h3 id="可见性的实现方式"><a href="#可见性的实现方式" class="headerlink" title="可见性的实现方式"></a>可见性的实现方式</h3><p><strong>【1】Java</strong>语言层面支持的<strong>可见性实现方式</strong>： </p>
<blockquote>
<ul>
<li><strong>synchronized</strong></li>
<li><strong>volatile</strong></li>
</ul>
</blockquote>
<p><strong>【2】synchronized能够实现</strong>的 两个功能<strong>：</strong> </p>
<blockquote>
<ul>
<li>原子性（同步）</li>
<li>可见性</li>
</ul>
</blockquote>
<p><strong>【3】JMM关于synchronized 的两条规定：</strong> </p>
<blockquote>
<ul>
<li>线程解锁前，必须把共享变量的最新值刷新到主内存中；</li>
<li>线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新读取最新的值（<strong>注意：加锁与解锁需要的是同一把锁）</strong></li>
</ul>
</blockquote>
<p><strong>线程解锁前对共享变量的修改在下次加锁时对其他线程可见</strong> </p>
<p><strong>【4】线程执行互斥代码的过程：</strong> </p>
<blockquote>
<ol>
<li>获得互斥锁</li>
<li>清空工作内存</li>
<li>从主内存拷贝变量的最新副本到工作内存</li>
<li>执行代码</li>
<li>将更改后的共享变量的值刷新到主内存</li>
<li>释放互斥锁</li>
</ol>
</blockquote>
<p>【5】<strong>指令重排序的概念以及类型</strong> </p>
<p><strong>重排序：代码书写的顺序与实际执行的顺序不同，指令重排序是编译器或处理器为了提高程序性能而做的优化</strong></p>
<blockquote>
<ol>
<li>编译器优化的重排序（编译器优化）</li>
<li>指令集并行重排序（处理器优化）</li>
<li>内存系统的重排序（处理器优化）</li>
</ol>
</blockquote>
<p>示例：<strong>指令重排序 可能 造成的结果</strong></p>
<p>​         <img src="http://photo.wushaopei.com/qiniu246.png" width="80%"></p>
<p>【6】   <strong>as-if-serial</strong> </p>
<p><strong>as-if-serial：无论如何重排序，程序执行的结果应该与代码顺序执行的结果一致（Java编译器、运行时和处理器都会保证Java在单线程下遵循</strong>   <strong>as-if-serial 语义）</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> num1 = <span class="number">1</span>;           <span class="comment">//第1行代码</span></span><br><span class="line"><span class="keyword">int</span> num2 = <span class="number">2</span>;           <span class="comment">//第2行代码</span></span><br><span class="line"><span class="keyword">int</span> sum = num1 + num2 ; <span class="comment">//第3行代码</span></span><br></pre></td></tr></table></figure>

<p><strong>单线程： 第1、2行的顺序可以重排，但第3行不能</strong></p>
<p><strong>重排序不会给单线程带来内存可见性问题</strong></p>
<p><strong>多线程中程序交错执行时，重排序可能会造成内存可见性问题</strong></p>
<h3 id="synchronized实现可见性代码"><a href="#synchronized实现可见性代码" class="headerlink" title="synchronized实现可见性代码"></a><strong>synchronized实现可见性代码</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> mkw.demo.syn;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedDemo</span> </span>&#123;</span><br><span class="line">	<span class="comment">//共享变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ready = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">1</span>;   </span><br><span class="line">    <span class="comment">//写操作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	ready = <span class="keyword">true</span>;	      				 <span class="comment">//1.1				</span></span><br><span class="line">    	number = <span class="number">2</span>;		                    <span class="comment">//1.2			    </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读操作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span></span>&#123;			   	 </span><br><span class="line">    	<span class="keyword">if</span>(ready)&#123;						     <span class="comment">//2.1</span></span><br><span class="line">    		result = number*<span class="number">3</span>;	 	<span class="comment">//2.2</span></span><br><span class="line">    	&#125;   	</span><br><span class="line">    	System.out.println(<span class="string">"result的值为："</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//内部线程类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//根据构造方法中传入的flag参数，确定线程执行读操作还是写操作</span></span><br><span class="line">    	<span class="keyword">private</span> <span class="keyword">boolean</span> flag;</span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="title">ReadWriteThread</span><span class="params">(<span class="keyword">boolean</span> flag)</span></span>&#123;</span><br><span class="line">    		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">    	&#125;</span><br><span class="line">        <span class="meta">@Override</span>                                                                    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span>(flag)&#123;</span><br><span class="line">        		<span class="comment">//构造方法中传入true，执行写操作</span></span><br><span class="line">        		write();</span><br><span class="line">        	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        		<span class="comment">//构造方法中传入false，执行读操作</span></span><br><span class="line">        		read();</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line">    	SynchronizedDemo synDemo = <span class="keyword">new</span> SynchronizedDemo();</span><br><span class="line">    	<span class="comment">//启动线程执行写操作</span></span><br><span class="line">    	synDemo .<span class="keyword">new</span> ReadWriteThread(<span class="keyword">true</span>).start();</span><br><span class="line">    	<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="comment">//启动线程执行读操作</span></span><br><span class="line">    	synDemo.<span class="keyword">new</span> ReadWriteThread(<span class="keyword">false</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="synchronized实现可见性分析："><a href="#synchronized实现可见性分析：" class="headerlink" title="synchronized实现可见性分析："></a>synchronized实现可见性分析：</h3><p>【1】<strong>没有进行重排序</strong> </p>
<p>执行结果:result的值为3 </p>
<p>​         <img src="http://photo.wushaopei.com/qiniu247.png" width="80%"></p>
<p>【2】<strong>进行重排序</strong></p>
<p>​    执行结果:result的值为0</p>
<p>​         <img src="http://photo.wushaopei.com/qiniu248.png" width="80%"></p>
<p>【3】<strong>分析：导致共享变量在线程间不可见的原因</strong></p>
<blockquote>
<ol>
<li>线程的交叉执行</li>
<li>重排序结合线程交叉执行</li>
<li>共享变量更新后的值没有在工作内存与主内存间及时更新</li>
</ol>
</blockquote>
<p>【4】 安全代码： </p>
<p>​         <img src="http://photo.wushaopei.com/qiniu249.png" width="80%"></p>
<p>【5】synchronized 实现内存可见性的解决方案：</p>
<blockquote>
<ol>
<li>添加了synchronized 的地方相当于加了一把锁，被添加锁的地方，在一定时间内只能当前线程释放锁，其他线程才有机会进入其中执行代码；</li>
<li>synchronized  使得 同步的情况下，共享变量在被第二次调用前便被同步到了主内存，实现了共享变量的即时更新</li>
</ol>
</blockquote>
<p>​         <img src="http://photo.wushaopei.com/qiniu250.png" width="80%"></p>
<p><strong>重点：</strong> 为啥synchronized原子性可以避免线程交叉执行：因为synchronized加锁在对象上，执行read方法的线程1获得了对象锁，那线程2不能获得对象锁也就不能执行write方法，因为要执行write方法需要获得锁。但是线程1可以继续执行write方法，因为write方法和read方法可以使用同一把锁，synchronized锁可以重入</p>
<h3 id="synchronized实现可见性结果分析："><a href="#synchronized实现可见性结果分析：" class="headerlink" title="synchronized实现可见性结果分析："></a>synchronized实现可见性结果分析：</h3><p>此处<strong>执行结果为6</strong>的情况进行分析：  </p>
<ol>
<li>synchronized完美保证共享变量的可见性  </li>
<li>但是不加此关键字，并不意味着就不能实现可见性 </li>
</ol>
<p>​         <img src="http://photo.wushaopei.com/qiniu251.png" width="80%"></p>
<p>【1】为何不加synchronized也会执行可见性，主内存及时更新被获取最新值”？</p>
<p>原因有很多个</p>
<p>①即使没有加synchronized，也可能是可见的，在大多数情况都是可见的，因为编译器优化了，会揣摩程序的意图，程序运行很多次，只会有很少的情况不可见。</p>
<p>②因为当时定义说加synchronized一定会可见性，而不加也没说一定不会，只是有可能不会，因为现在Java做了一些优化：尽量实现可见性；但是不能保证每次都成功，只是成功概率比较大99%，但还是有1%的情况会失败。所以处于安全考虑，尽量加synchronized关键字100%成功。</p>
<p>【2】有时候依然不存在线程交叉情况，但还是会先执行第二个线程，因为第一个线程把CPU让位出来，所以为了避免这种情况，可以在第一个线程后附上代码：sleep(1000);1秒之后才有机会执行线程2。</p>
<p>【3】synchronized+sleep();黄金搭档。</p>
<h2 id="volatile实现可见性"><a href="#volatile实现可见性" class="headerlink" title="volatile实现可见性"></a>volatile实现可见性</h2><h3 id="volatile能够保证可见性"><a href="#volatile能够保证可见性" class="headerlink" title="volatile能够保证可见性"></a>volatile能够保证可见性</h3><h4 id="volatile关键字："><a href="#volatile关键字：" class="headerlink" title="volatile关键字："></a><strong>volatile关键字：</strong></h4><blockquote>
<ul>
<li>能够保证volatile变量的可见性</li>
<li>不能保证volatile变量复合操作的原子性</li>
</ul>
</blockquote>
<h4 id="volatile-如何实现内存可见性："><a href="#volatile-如何实现内存可见性：" class="headerlink" title="volatile 如何实现内存可见性："></a><strong>volatile 如何实现内存可见性：</strong></h4><p>深入来说：通过加入内存屏障和禁止重排序优化来实现的。</p>
<ul>
<li>对volatile变量执行写操作时，会在写操作后加入一条store屏障指令</li>
<li>对volatile变量执行读操作时，会在读操作前后加入一条load屏障指令</li>
</ul>
<h4 id="执行引擎对-volatile-的操作："><a href="#执行引擎对-volatile-的操作：" class="headerlink" title="执行引擎对 volatile 的操作："></a><strong>执行引擎对 volatile 的操作：</strong></h4><blockquote>
<p>通俗地讲：volatile变量在每次被线程访问时，都强迫从主内存中重读该变量的值，而当该变量发生变化时，又会强迫线程将最新的值刷新到主内存。这样任何时刻，不同的线程总能看到该变量的最新值。 </p>
</blockquote>
<h4 id="线程-读、-写-volatile-变量的过程"><a href="#线程-读、-写-volatile-变量的过程" class="headerlink" title="线程 读、 写 volatile 变量的过程"></a><strong>线程 读、 写 volatile 变量的过程</strong></h4><p>【1】线程写volatile变量的过程： </p>
<blockquote>
<ol>
<li>改变线程工作的内存中volatile变量副本的值</li>
<li>将改变后的副本的值从工作内存刷新到主内存</li>
</ol>
</blockquote>
<p>【2】线程读volatile变量的过程： </p>
<blockquote>
<ol>
<li>从主内存中读取volatile变量的最新值到线程的工作内存中</li>
<li>从工作内存中读取volatile变量的副本</li>
</ol>
</blockquote>
<h4 id="volatile不能保证volatile变量复合操作的原子性："><a href="#volatile不能保证volatile变量复合操作的原子性：" class="headerlink" title="volatile不能保证volatile变量复合操作的原子性："></a><strong>volatile不能保证volatile变量复合操作的原子性：</strong></h4><p>​         <img src="http://photo.wushaopei.com/qiniu252.png" width="80%"></p>
<h4 id="代码案例："><a href="#代码案例：" class="headerlink" title="代码案例："></a>代码案例：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileDemo</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.number;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">100</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		lock.lock();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.number++;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">final</span> VolatileDemo volDemo = <span class="keyword">new</span> VolatileDemo();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">500</span> ; i++)&#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">				</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					volDemo.increase();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;).start();</span><br><span class="line">		&#125;		</span><br><span class="line">		<span class="comment">//如果还有子线程在运行，主线程就让出CPU资源，</span></span><br><span class="line">		<span class="comment">//直到所有的子线程都运行完了，主线程再继续往下执行</span></span><br><span class="line">		<span class="keyword">while</span>(Thread.activeCount() &gt; <span class="number">1</span>)&#123;</span><br><span class="line">			Thread.yield();</span><br><span class="line">		&#125;		</span><br><span class="line">		System.out.println(<span class="string">"number : "</span> + volDemo.getNumber());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//如果还有子线程在运行，主线程就让出CPU资源</span></span><br><span class="line"><span class="comment">//直到所有的子线程都运行完了，主线程再继续往下执行</span></span><br><span class="line"><span class="keyword">while</span>(Thread.activeCount()&gt;<span class="number">1</span>)&#123;</span><br><span class="line">        Thread.yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>理论来讲，最后的值应该是500，但是因为num++;不是原子操作，且volatile关键字又没有原子性，所以偶尔会出现&lt;500的情况。 </p>
<h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>num++不是原子操作，原子操作意为（所谓原子操作是指不会被线程调度机制打断的操作；这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch  –百科），volatile能保证可见性，但是在多线程调度时 num++ 被拆分为  </p>
<blockquote>
<p>1）从主存中读取num值；</p>
<p> 2) i = num + 1;</p>
<p> 3) 写回i 到主存的num</p>
</blockquote>
<h4 id="基于-number-5-的分析："><a href="#基于-number-5-的分析：" class="headerlink" title="基于 number = 5 的分析："></a><strong>基于 number = 5 的分析：</strong></h4><blockquote>
<p>1、线程A读取到的number 为 5；</p>
<p>2、线程B读取到的number 为 5；</p>
<p>3、线程B 执行加1 操作， number ++</p>
<p>4、线程B写入最新的 number 为 3 中的  5+ 1 = 6;</p>
<p>5、线程A 执行加 1 操作没有向主内存读取共享变量，故 依旧是 由 原始变量  number = 5 开始 加 1 操作，即 此时 number  = 5+ 1 ；</p>
<p>6、线程 A 写入最新的 number  值 ，此时内存中的 只是 将 线程B 的 6 改成了 线程 A 的6 ，实际上只是同值的 覆盖，而非 递增</p>
</blockquote>
<h4 id="安全性解决方案："><a href="#安全性解决方案：" class="headerlink" title="安全性解决方案："></a><strong>安全性解决方案：</strong></h4><p>保证number自增操作的原子性：</p>
<blockquote>
<ul>
<li>使用synchronized关键字</li>
<li>使用ReentrantLock（java.until.concurrent.locks包下）</li>
<li>使用AtomicInteger (vava.util.concurrent.atomic包下)</li>
</ul>
</blockquote>
<h3 id="保证-number-变量在线程中的原子性"><a href="#保证-number-变量在线程中的原子性" class="headerlink" title="保证 number 变量在线程中的原子性"></a>保证 number 变量在线程中的原子性</h3><h4 id="【1】用synchronized-保证-number-变量在线程中的原子性"><a href="#【1】用synchronized-保证-number-变量在线程中的原子性" class="headerlink" title="【1】用synchronized 保证 number 变量在线程中的原子性"></a>【1】用synchronized 保证 number 变量在线程中的原子性</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Thread.sleep(<span class="number">100</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">this</span>.number++;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【2】用ReentrantLock-实现number-变量在线程中的原子性"><a href="#【2】用ReentrantLock-实现number-变量在线程中的原子性" class="headerlink" title="【2】用ReentrantLock 实现number 变量在线程中的原子性"></a>【2】用ReentrantLock 实现number 变量在线程中的原子性</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Thread.sleep(<span class="number">100</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">	lock.lock();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.number++;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		lock.unlock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="volatile适用场合"><a href="#volatile适用场合" class="headerlink" title="volatile适用场合"></a>volatile适用场合</h3><p><strong>要在多线程中安全的使用volatile变量，必须同时满足：</strong></p>
<p>a）对变量的写入操作不依赖其当前值</p>
<blockquote>
<p>   不满足：number++、count=count*5等</p>
<p>​    满足：boolean变量、记录温度变化的变量等</p>
</blockquote>
<p>b）该变量没有包含在具有其他变量的不变式中 </p>
<blockquote>
<p>不满足：不变式low&lt;up </p>
</blockquote>
<h3 id="synchronized和volatile比较"><a href="#synchronized和volatile比较" class="headerlink" title="synchronized和volatile比较"></a>synchronized和volatile比较</h3><blockquote>
<p>a）volatile不需要加锁，比synchronized更轻便，不会阻塞线程</p>
<p>b）从内存可见性的角度来讲，volatile的读相当于加锁，volatile的写相当于解锁</p>
<p>c）synchronized既能保证可见性，又能保证原子性，而volatile只能保证可见性，无法保证原子性</p>
</blockquote>
<h4 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h4><p>【1】对于64位(long、double)变量的读写可能不是原子操作:<br>.Java内存模型允许JVM将没有被volatile修饰的64位数据类型的读写操作划分为两次32位的读写操作来进行</p>
<p>导致问题:有可能会出现读取到”半个变量”的情况<br>解决方法:加volatile关键字</p>
<p>【2】问:即使没有保证可见性的措施,很多时候共享变量依然能够在主内存和工作内存见得到及时的更新?</p>
<p>答:一般只有在短时间内高并发的情况下才会出现变量得不到及时更新的情况,因为CPU在执行时会很快的刷新缓存,所以一般情况下很难看到这种问题.</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>内存可见性</tag>
        <tag>synchronized</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十四）线程安全策略-并发容器及安全共享策略总结</title>
    <url>/2020/04/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E5%9B%9B%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E5%8F%8A%E5%AE%89%E5%85%A8%E5%85%B1%E4%BA%AB%E7%AD%96%E7%95%A5%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h2 id="并发容器及安全共享策略总结"><a href="#并发容器及安全共享策略总结" class="headerlink" title="并发容器及安全共享策略总结"></a>并发容器及安全共享策略总结</h2><blockquote>
<p>ArrayList  - &gt;  CopyOnWriteArrayList</p>
<p>HashSet 、TreeSet - &gt; CopyOnWriteArraySet ConcurrentSkipListSet</p>
<p>HashMap 、 TreeMap - &gt; ConcurrentHashMap ConcurrentSkipListMap</p>
</blockquote>
<h3 id="用CopyOnWriteArrayList-替代ArrayList"><a href="#用CopyOnWriteArrayList-替代ArrayList" class="headerlink" title="用CopyOnWriteArrayList 替代ArrayList"></a>用CopyOnWriteArrayList 替代ArrayList</h3><h4 id="使用原理："><a href="#使用原理：" class="headerlink" title="使用原理："></a><strong>使用原理：</strong></h4><blockquote>
<p>写操作时复制，当有新元素添加到CopyOnWriteArrayList时，会从原有数组里面拷贝一份出来，在新的数组上用写操作，写完之后把原来的数组指向新的数组，CopyOnWriteArrayList的整个add（）操作都是在锁的保护下进行的，主要是为了避免在多线程情况下复制出多个副本出来把数据搞乱，导致最终返回的数据结果不是我们所期待的。</p>
</blockquote>
<h4 id="适用场景："><a href="#适用场景：" class="headerlink" title="适用场景："></a><strong>适用场景：</strong></h4><p><code>CopyOnWriteArrayList适合读多写少的场景。</code></p>
<h4 id="CopyOnWriteArrayList的设计思想："><a href="#CopyOnWriteArrayList的设计思想：" class="headerlink" title="CopyOnWriteArrayList的设计思想："></a><strong>CopyOnWriteArrayList的设计思想：</strong></h4><blockquote>
<p>第一点：读写分离，让读和写分开；</p>
<p>第二点：最终一致性，因为在copy的过程需要一些时间，而最终一致性保证了数据是对的；</p>
<p>第三点：使用时另外开辟空间，通过这种方式解决掉并发冲突。</p>
<p>CopyOnWriteArrayList读操作时是在原数组上读的，不需要加锁；而写操作的时候需要加锁，以避免产生多个副本出来，影响最终的数据结果。</p>
</blockquote>
<h4 id="代码演示验证CopyOnWriteArrayList的写操作线程安全性："><a href="#代码演示验证CopyOnWriteArrayList的写操作线程安全性：" class="headerlink" title="代码演示验证CopyOnWriteArrayList的写操作线程安全性："></a>代码演示验证CopyOnWriteArrayList的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArrayListExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">50</span>:<span class="number">23.972</span> [main] INFO com.mmall.concurrency.CopyOnWriteArrayListExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000，</strong>说明了<strong>CopyOnWriteArrayList</strong>的add操作在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h3 id="HashSet-、TreeSet-gt-CopyOnWriteArraySet-ConcurrentSkipListSet"><a href="#HashSet-、TreeSet-gt-CopyOnWriteArraySet-ConcurrentSkipListSet" class="headerlink" title="HashSet 、TreeSet - &gt; CopyOnWriteArraySet  ConcurrentSkipListSet"></a>HashSet 、TreeSet - &gt; CopyOnWriteArraySet  ConcurrentSkipListSet</h3><h4 id="代码演示验证CopyOnWriteArraySet的写操作线程安全性："><a href="#代码演示验证CopyOnWriteArraySet的写操作线程安全性：" class="headerlink" title="代码演示验证CopyOnWriteArraySet的写操作线程安全性："></a>代码演示验证CopyOnWriteArraySet的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArraySetExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行测试打印结果："><a href="#执行测试打印结果：" class="headerlink" title="执行测试打印结果："></a><strong>执行测试打印结果：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">56</span>:<span class="number">40.047</span> [main] INFO com.mmall.concurrency.example.concurrent.CopyOnWriteArraySetExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000</strong>，说明了<strong>CopyOnWriteArraySet</strong>的add操作在多线程并发环境下<strong>是线程安全</strong>的。 </p>
<h4 id="代码演示验证ConcurrentSkipListSet的写操作线程安全性："><a href="#代码演示验证ConcurrentSkipListSet的写操作线程安全性：" class="headerlink" title="代码演示验证ConcurrentSkipListSet的写操作线程安全性："></a>代码演示验证ConcurrentSkipListSet的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSkipListSetExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> ConcurrentSkipListSet&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,set.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行测试打印结果：-1"><a href="#执行测试打印结果：-1" class="headerlink" title="执行测试打印结果："></a><strong>执行测试打印结果：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">58</span>:<span class="number">05.936</span> [main] INFO com.mmall.concurrency.example.concurrent.ConcurrentSkipListSetExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为5000，说明了<strong>ConcurrentSkipListSet</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。</p>
<p>这里的线程安全仅限于做add操作时，如果是做remove操作，还需要其他锁机制保障线程安全。</p>
<h3 id="HashMap-、-TreeMap-gt-ConcurrentHashMap-ConcurrentSkipListMap"><a href="#HashMap-、-TreeMap-gt-ConcurrentHashMap-ConcurrentSkipListMap" class="headerlink" title="HashMap 、 TreeMap - &gt; ConcurrentHashMap ConcurrentSkipListMap"></a>HashMap 、 TreeMap - &gt; ConcurrentHashMap ConcurrentSkipListMap</h3><p><code>对并发要求比较高的时候，建议使用ConcurrentSkipListMap</code></p>
<h4 id="代码演示验证ConcurrentHashMap的写操作线程安全性："><a href="#代码演示验证ConcurrentHashMap的写操作线程安全性：" class="headerlink" title="代码演示验证ConcurrentHashMap的写操作线程安全性："></a>代码演示验证ConcurrentHashMap的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMapExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">04</span>:<span class="number">16.524</span> [main] INFO com.mmall.concurrency.example.concurrent.ConcurrentHashMapExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000</strong>，说明了<strong>ConcurrentHashMap</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全</strong>的。 </p>
<h4 id="代码演示验证ConcurrentSkipListMap的写操作线程安全性："><a href="#代码演示验证ConcurrentSkipListMap的写操作线程安全性：" class="headerlink" title="代码演示验证ConcurrentSkipListMap的写操作线程安全性："></a>代码演示验证ConcurrentSkipListMap的写操作线程安全性：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSkipListMapExample</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> ConcurrentSkipListMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> count = i;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"size:&#123;&#125;"</span>,map.size());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">update</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        map.put(i,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行测试打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">06</span>:<span class="number">13.842</span> [main] INFO com.mmall.concurrency.example.concurrent.ConcurrentSkipListMapExample - size:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>由结果可知：size的长度为<strong>5000</strong>，说明了<strong>ConcurrentSkipListMap</strong>的<strong>add操作</strong>在多线程并发环境下是<strong>线程安全的</strong>。 </p>
<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><img src="http://photo.wushaopei.com/qiniu291.png" width="60%">

<h3 id="安全共享对象策略-总结："><a href="#安全共享对象策略-总结：" class="headerlink" title="安全共享对象策略 - 总结："></a>安全共享对象策略 - 总结：</h3><ul>
<li><strong>线程限制：</strong> 一个被线程限制的对象，由线程独占，并且只能被占有它的线程修改</li>
<li><strong>共享只读：</strong> 一个共享只读的对象，在没有额外同步的情况下，可以被多个线程并发访问，但是任何线程都不能修改它</li>
<li><strong>线程安全对象：</strong> 一个线程安全的对象或者容器，在内部通过同步机制来保证线程安全，所以其他线程无需额外的同步就可以通过公共接口随意访问它</li>
<li><strong>被守护对象：</strong> 被守护对象只能通过获取特定的锁来访问</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>并发容器</tag>
        <tag>安全共享策略</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（十一）线程安全策略-线程封闭</title>
    <url>/2020/04/03/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-%E7%BA%BF%E7%A8%8B%E5%B0%81%E9%97%AD/</url>
    <content><![CDATA[<h2 id="线程封闭"><a href="#线程封闭" class="headerlink" title="线程封闭"></a>线程封闭</h2><p><strong>目的：</strong><code>避免并发，除了设置不可变对象，还有线程封闭。</code></p>
<h3 id="什么是线程封闭"><a href="#什么是线程封闭" class="headerlink" title="什么是线程封闭"></a>什么是线程封闭</h3><p><strong>所谓线程封闭</strong>，就是把对象锁定到一个线程里，只有这个线程可以看到对象，那么，这个对象就算不是线程安全的，也不会出现线程安全的问题了。因为它只能在一个线程内访问。 </p>
<h3 id="线程封闭共有三种："><a href="#线程封闭共有三种：" class="headerlink" title="线程封闭共有三种："></a>线程封闭共有三种：</h3><h4 id="第一种线程封闭："><a href="#第一种线程封闭：" class="headerlink" title="第一种线程封闭："></a><strong>第一种线程封闭：</strong></h4><blockquote>
<p> <strong>Ad-hoc 线程封闭 ： 程序控制实现，最糟糕，忽略</strong> </p>
</blockquote>
<h4 id="第二种线程封闭："><a href="#第二种线程封闭：" class="headerlink" title="第二种线程封闭："></a><strong>第二种线程封闭：</strong></h4><blockquote>
<p>  <strong>堆栈封闭：局部变量，无并发问题</strong></p>
</blockquote>
<p>多个线程访问一个方法的时候，局部变量都会被拷贝一份到线程的栈中，所以<strong>局部变量</strong>是不会被多个线程所共享的，因此也就不会出现并发问题。</p>
<p><strong>全局的变量</strong>容易出现并发问题。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在一个方法内定义局部变量来完成各种操作，就是属于堆栈封闭的范畴。</span><br></pre></td></tr></table></figure>

<h4 id="第三种线程封闭："><a href="#第三种线程封闭：" class="headerlink" title="第三种线程封闭："></a><strong>第三种线程封闭：</strong></h4><p> <strong>ThreadLocal</strong>线程封闭：特别好的封闭方法</p>
<p><strong>原因：</strong></p>
<blockquote>
<p> <strong>ThreadLocal</strong>内部维护了一个<strong>map</strong>，<strong>map</strong>的<strong>key</strong>是每一个线程的名称，而<strong>map</strong>的值就是我们要封闭的对象，每个<strong>map</strong>中的对象都对应了一个线程中的值，也就是<strong>ThreadLocal</strong>利用<strong>map</strong>实现了线程封闭。 </p>
</blockquote>
<h3 id="ThreadLocal线程封闭——代码演示："><a href="#ThreadLocal线程封闭——代码演示：" class="headerlink" title="ThreadLocal线程封闭——代码演示："></a>ThreadLocal线程封闭——代码演示：</h3><h4 id="RequestHolder"><a href="#RequestHolder" class="headerlink" title="RequestHolder"></a>RequestHolder</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.threadLocal;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> RequestHolder</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 11:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestHolder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; requestHolder = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//在接口未实际处理之前，在filter中将值添加到ThreadLocal中，等到url被调用处理时，再从ThreadLocal中取出相应的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        requestHolder.set(id);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">getId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> requestHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//在接口真正处理完之后进行处理</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>&#123;</span><br><span class="line">        requestHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Fitler-："><a href="#Fitler-：" class="headerlink" title="Fitler ："></a><strong>Fitler ：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.example.threadLocal.RequestHolder;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> HttpFilter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 11:18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">        RequestHolder.add(Thread.currentThread().getId());</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="HttpFilter-java"><a href="#HttpFilter-java" class="headerlink" title="HttpFilter.java"></a>HttpFilter.java</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">    log.info(<span class="string">"do filter,&#123;&#125; - &#123;&#125;"</span>,Thread.currentThread().getId(),request.getServletPath());</span><br><span class="line">    RequestHolder.add(Thread.currentThread().getId());</span><br><span class="line">    filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置Filter-将HttpFilter添加到容器"><a href="#配置Filter-将HttpFilter添加到容器" class="headerlink" title="配置Filter,将HttpFilter添加到容器"></a>配置Filter,将HttpFilter添加到容器</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencyApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(ConcurrencyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">httpFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">      FilterRegistrationBean&lt;Filter&gt; registrationBean = <span class="keyword">new</span> FilterRegistrationBean&lt;&gt;();</span><br><span class="line">      registrationBean.setFilter(<span class="keyword">new</span> HttpFilter());</span><br><span class="line">      registrationBean.addUrlPatterns(<span class="string">"/threadLocal/*"</span>);</span><br><span class="line">      <span class="keyword">return</span> registrationBean;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Handler适配器实现接口实现前后的拦截、过滤操作："><a href="#Handler适配器实现接口实现前后的拦截、过滤操作：" class="headerlink" title="Handler适配器实现接口实现前后的拦截、过滤操作："></a><strong>Handler适配器实现接口实现前后的拦截、过滤操作：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.example.threadLocal.RequestHolder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> HttpInterceptor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/1 11:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"preHandle"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//接口执行完成后删除ThreadLocal线程变量</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RequestHolder.remove();</span><br><span class="line">        log.info(<span class="string">"afterCompletion"</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在启动器中将HttpInterceptor-的Bean配置到容器中："><a href="#在启动器中将HttpInterceptor-的Bean配置到容器中：" class="headerlink" title="在启动器中将HttpInterceptor 的Bean配置到容器中："></a>在启动器中将HttpInterceptor 的Bean配置到容器中：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencyApplication</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span></span>&#123;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">   registry.addInterceptor(<span class="keyword">new</span> HttpInterceptor()).addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">创建ThreadLocal测试接口：</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/threadLocal"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalController</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RequestHolder.getId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>启动并执行测试接口：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.757</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] o.s.web.servlet.DispatcherServlet        : Initializing Servlet <span class="string">'dispatcherServlet'</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.763</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] o.s.web.servlet.DispatcherServlet        : Completed initialization in <span class="number">6</span> ms</span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.769</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] com.mmall.concurrency.HttpFilter         : <span class="keyword">do</span> filter,<span class="number">30</span> , /threadLocal/test</span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.779</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] com.mmall.concurrency.HttpInterceptor    : preHandle</span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">19</span>:<span class="number">08.852</span>  INFO <span class="number">23868</span> --- [p-nio-<span class="number">80</span>-exec-<span class="number">2</span>] com.mmall.concurrency.HttpInterceptor    : afterCompletio</span><br></pre></td></tr></table></figure>

<p>由执行结果可知，使用<strong>ThreadLocal</strong>实现了线程封闭，以为着<strong>ThreadLocal</strong>是线程安全的。 </p>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><h4 id="实现流程："><a href="#实现流程：" class="headerlink" title="实现流程："></a><strong>实现流程：</strong></h4><blockquote>
<p>当请求进来的时候，通过Filter将线程ID存储到了ThreadLocal里面，当接口被处理调用的时候，就可以从ThreadLocal里去取出线程ID，当接口处理完后，再通过HttpInterception适配器中的afterCompletion方法将线程ID给移除掉。 </p>
</blockquote>
<h4 id="分析：-1"><a href="#分析：-1" class="headerlink" title="分析："></a><strong>分析：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">这里在使用ThreadLocal的时候，定义了三个方法，分别是从ThreaadLocal里面放数据、移除数据、获取数据，放数据一般是通过Filter来放数据，先拦截住接口，在拦截器里面把数据放进去，数据处理完之后在Interceptor里面将数据移除出去，避免内存泄露。</span><br></pre></td></tr></table></figure>

<h4 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a><strong>扩展：</strong></h4><p><strong>线程封闭技术的常见应用：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">数据库连接对应JDBC的Connection对象，Connection对象在实现时并没有对线程安全做太多的处理，在相应的JDBC规范里也没有要求Connection对象一定是线程安全的，实际上在服务器应用程序中线程从连接池获取了一个Connection对象，使用完之后再将对象返回给连接池，由于大多数请求都是采用单线程同步的方式处理的，在Connection对象返回之前，连接池不会将它分配给其他线程，因此这种管理模式在请求时隐含的将对象封闭在线程里面。我们使用Connnection对象虽然本身不是线程安全的，但是通过线程封闭也做到了线程安全。</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>synchronized</tag>
        <tag>不可变对象</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络（二）当你在浏览器地址栏输入一个URL后回车，将会发生的事情？</title>
    <url>/2020/03/09/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89-%E5%BD%93%E4%BD%A0%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9C%B0%E5%9D%80%E6%A0%8F%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAURL%E5%90%8E%E5%9B%9E%E8%BD%A6%EF%BC%8C%E5%B0%86%E4%BC%9A%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85%EF%BC%9F/</url>
    <content><![CDATA[<p>​    当我们在浏览器的地址栏输入<a href="https://www.cnblogs.com/，然后回车，回车到看到页面到底发生了什么呢？" target="_blank" rel="noopener">https://www.cnblogs.com/，然后回车，回车到看到页面到底发生了什么呢？</a></p>
<p>​    <strong>域名解析 –&gt; 发起TCP的3次握手 –&gt; 建立TCP连接后发起http请求 –&gt;  服务器响应http请求，浏览器得到html代码 –&gt; 浏览器解析html代码，并请求html代码中的资源（如js、css、图片等）  –&gt; 浏览器对页面进行渲染呈现给用户</strong></p>
<h2 id="一、域名解析"><a href="#一、域名解析" class="headerlink" title="一、域名解析"></a>一、域名解析</h2><p>​    首先Chrome浏览器会解析<a href="https://www.cnblogs.com/这个域名对应的IP地址。怎么解析到对应的IP地址？" target="_blank" rel="noopener">https://www.cnblogs.com/这个域名对应的IP地址。怎么解析到对应的IP地址？</a></p>
<ol>
<li><p>Chrome浏览器会首先搜索浏览器的DNS缓存（缓存时间比较短，TTL默认是1000，且只能容纳1000条缓存），看自身的缓存中是否有<a href="https://www.cnblogs.com/对应的条目，而且没有过期，如果有且没有过期则解析到此结束。" target="_blank" rel="noopener">https://www.cnblogs.com/对应的条目，而且没有过期，如果有且没有过期则解析到此结束。</a></p>
<p>注：我们怎么查看浏览器的DNS缓存？可以使用 chrome://net-internals/#dns 来进行查看</p>
</li>
<li><p>如果浏览器自身的缓存里面没有找到对应的条目，那么Chrome会搜索操作系统的DNS缓存,如果找到且没有过期则停止搜索解析到此结束。</p>
<p>注：怎么查看操作系统的DNS缓存，以Windows系统为例，可以在命令行下使用 ipconfig /displaydns 来进行查看</p>
</li>
<li><p>如果在Windows系统的DNS缓存也没有找到，那么尝试读取hosts文件（位于C:\Windows\System32\drivers\etc），看看这里面有没有该域名对应的IP地址，如果有则解析成功。</p>
</li>
<li><p>如果在hosts文件中也没有找到对应的条目，浏览器就会发起一个DNS的系统调用，就会向本地配置的首选DNS服务器（一般是电信运营商提供的，也可以使用像Google提供的DNS服务器）发起域名解析请求（通过的是UDP协议向DNS的53端口发起请求，这个请求是<strong>递归的请求</strong>，也就是运营商的DNS服务器必须得提供给我们该域名的IP地址），运营商的DNS服务器首先查找自身的缓存，找到对应的条目，且没有过期，则解析成功。如果没有找到对应的条目，则有运营商的DNS代我们的浏览器发起<strong>迭代DNS解析请求</strong>，它首先是会找根域的DNS的IP地址（这个DNS服务器都内置13台根域的DNS的IP地址），找打根域的DNS地址，就会向其发起请求（请问<a href="https://www.cnblogs.com/这个域名的IP地址是多少啊？），根域发现这是一个顶级域com域的一个域名，于是就告诉运营商的DNS我不知道这个域名的IP地址，但是我知道com域的IP地址，你去找它去，于是运营商的DNS就得到了com域的IP地址，又向com域的IP地址发起了请求（请问https://www.cnblogs.com/这个域名的IP地址是多少?）,com域这台服务器告诉运营商的DNS我不知道https://www.cnblogs.com/这个域名的IP地址，但是我知道https://www.cnblogs.com/这个域的DNS地址，你去找它去，于是运营商的DNS又向https://www.cnblogs.com/这个域名的DNS地址（这个一般就是由域名注册商提供的，像万网，新网等）发起请求（请问https://www.cnblogs.com/这个域名的IP地址是多少？），这个时候cnblogs.com域的DNS服务器一查，果真在我这里，于是就把找到的结果发送给运营商的DNS服务器，这个时候运营商的DNS服务器就拿到了https://www.cnblogs.com/这个域名对应的IP地址，并返回给Windows系统内核，内核又把结果返回给浏览器，终于浏览器拿到了https://www.cnblogs.com/对应的IP地址，该进行一步的动作了。" target="_blank" rel="noopener">https://www.cnblogs.com/这个域名的IP地址是多少啊？），根域发现这是一个顶级域com域的一个域名，于是就告诉运营商的DNS我不知道这个域名的IP地址，但是我知道com域的IP地址，你去找它去，于是运营商的DNS就得到了com域的IP地址，又向com域的IP地址发起了请求（请问https://www.cnblogs.com/这个域名的IP地址是多少?）,com域这台服务器告诉运营商的DNS我不知道https://www.cnblogs.com/这个域名的IP地址，但是我知道https://www.cnblogs.com/这个域的DNS地址，你去找它去，于是运营商的DNS又向https://www.cnblogs.com/这个域名的DNS地址（这个一般就是由域名注册商提供的，像万网，新网等）发起请求（请问https://www.cnblogs.com/这个域名的IP地址是多少？），这个时候cnblogs.com域的DNS服务器一查，果真在我这里，于是就把找到的结果发送给运营商的DNS服务器，这个时候运营商的DNS服务器就拿到了https://www.cnblogs.com/这个域名对应的IP地址，并返回给Windows系统内核，内核又把结果返回给浏览器，终于浏览器拿到了https://www.cnblogs.com/对应的IP地址，该进行一步的动作了。</a> </p>
<p>DNS递归解析图如下所示： </p>
</li>
</ol>
<img src="http://photo.wushaopei.com/qiniu96.png" width="60%">

<p>​    DNS迭代解析图如下所示： </p>
<img src="http://photo.wushaopei.com/qiniu97.png" width="60%">

<p>注：一般情况下是不会进行以下步骤的，如果经过以上的4个步骤，还没有解析成功，那么会进行如下步骤：</p>
<ol>
<li>操作系统就会查找NetBIOS name  Cache（NetBIOS名称缓存，就存在客户端电脑中的），那这个缓存有什么东西呢？凡是最近一段时间内和我成功通讯的计算机的计算机名和Ip地址，就都会存在这个缓存里面。什么情况下该步能解析成功呢？就是该名称正好是几分钟前和我成功通信过，那么这一步就可以成功解析。</li>
<li>如果第5步也没有成功，那会查询WINS 服务器（是NETBIOS名称和IP地址对应的服务器）</li>
<li>如果第6步也没有查询成功，那么客户端就要进行广播查找</li>
<li>如果第7步也没有成功，那么客户端就读取LMHOSTS文件（和HOSTS文件同一个目录下，写法也一样）</li>
</ol>
<p>如果第八步还没有解析成功，那么这次解析失败，那就无法跟目标计算机进行通信。只要这八步中有一步可以解析成功，那就可以成功和目标计算机进行通信。</p>
<h2 id="二、发起TCP的3次握手"><a href="#二、发起TCP的3次握手" class="headerlink" title="二、发起TCP的3次握手"></a>二、发起TCP的3次握手</h2><p>拿到域名对应的IP地址之后，User-Agent（一般是指浏览器）会以一个随机端口（1024 &lt; 端口 &lt;  65535）向服务器的WEB程序（常用的有tomcat,nginx等）80端口发起TCP的连接请求。这个连接请求（原始的http请求经过TCP/IP4层模型的层层封包）到达服务器端后（这中间通过各种路由设备，局域网内除外），进入到网卡，然后是进入到内核的TCP/IP协议栈（用于识别该连接请求，解封包，一层一层的剥开），还有可能要经过Netfilter防火墙（属于内核的模块）的过滤，最终到达WEB程序，最终建立了TCP/IP的连接。如下图：</p>
<img src="http://photo.wushaopei.com/qiniu98.png" width="60%">

<p>注：<a href="http://www.cnblogs.com/wupeixuan/p/8639469.html" target="_blank" rel="noopener">TCP三次握手详解</a> </p>
<h2 id="三、建立TCP连接后发起http请求"><a href="#三、建立TCP连接后发起http请求" class="headerlink" title="三、建立TCP连接后发起http请求"></a>三、建立TCP连接后发起http请求</h2><p>​    HTTP请求报文的方法是get方式，如果浏览器存储了该域名下的Cookies，那么会把Cookies放入HTTP请求头里发给服务器。</p>
<p>下面是Chrome发起的http请求报文头部信息:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: www.cnblogs.com</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">62.0</span><span class="number">.3202</span><span class="number">.75</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,image/apng,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Referer: http://www.cnblogs.com/wupeixuan/</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br></pre></td></tr></table></figure>

<h2 id="四、服务器端响应http请求，浏览器得到html代码"><a href="#四、服务器端响应http请求，浏览器得到html代码" class="headerlink" title="四、服务器端响应http请求，浏览器得到html代码"></a>四、服务器端响应http请求，浏览器得到html代码</h2><p>​    服务器端WEB程序接收到http请求以后，就开始处理该请求，处理之后就返回给浏览器html文件。</p>
<p>用Chrome浏览器看到的响应头信息：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Date: Sun, <span class="number">08</span> Apr <span class="number">2018</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">00</span> GMT</span><br><span class="line">Content-Type: text/html; charset=utf-<span class="number">8</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Cache-Control: <span class="keyword">public</span>, max-age=<span class="number">29</span></span><br><span class="line">Expires: Sun, <span class="number">08</span> Apr <span class="number">2018</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">29</span> GMT</span><br><span class="line">Last-Modified: Sun, <span class="number">08</span> Apr <span class="number">2018</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">59</span> GMT</span><br><span class="line">X-UA-Compatible: IE=<span class="number">10</span></span><br><span class="line">Content-Encoding: gzip</span><br></pre></td></tr></table></figure>

<h2 id="五、浏览器解析html代码，并请求html代码中的资源"><a href="#五、浏览器解析html代码，并请求html代码中的资源" class="headerlink" title="五、浏览器解析html代码，并请求html代码中的资源"></a>五、浏览器解析html代码，并请求html代码中的资源</h2><p>​    浏览器拿到index.html文件后，就开始解析其中的html代码，遇到js/css/image等静态资源时，就向服务器端去请求下载（会使用多线程下载，每个浏览器的线程数不一样），这个时候就用上keep-alive特性了，建立一次HTTP连接，可以请求多个资源，下载资源的顺序就是按照代码里的顺序，但是由于每个资源大小不一样，而浏览器又多线程请求请求资源，所以从下图看出，这里显示的顺序并不一定是代码里面的顺序。</p>
<p>​    浏览器在请求静态资源时（在未过期的情况下），向服务器端发起一个http请求（询问自从上一次修改时间到现在有没有对资源进行修改），如果服务器端返回304状态码（告诉浏览器服务器端没有修改），那么浏览器会直接读取本地的该资源的缓存文件。</p>
<img src="http://photo.wushaopei.com/qiniu99.png" width="60%">

<h2 id="六、浏览器对页面进行渲染呈现给用户"><a href="#六、浏览器对页面进行渲染呈现给用户" class="headerlink" title="六、浏览器对页面进行渲染呈现给用户"></a>六、浏览器对页面进行渲染呈现给用户</h2><p>最后，Chrome浏览器利用自己内部的工作机制，把请求到的静态资源和html代码进行渲染，渲染之后呈现给用户。</p>
<p><strong>注：</strong> <strong>本文转载自</strong> <a href="https://www.cnblogs.com/wupeixuan/p/8747918.html" target="_blank" rel="noopener">https://www.cnblogs.com/wupeixuan/p/8747918.html</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络（一）-深入理解NIO</title>
    <url>/2020/03/09/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3NIO/</url>
    <content><![CDATA[<p><strong>目录概览</strong>：</p>
<ul>
<li>​    NIO 网络编程模型</li>
<li>​    NIO 网络编程详解</li>
<li>​    NIO 网络编程实战</li>
<li>​    NIO 网络编程缺陷</li>
</ul>
<h2 id="一、NIO网络编程模型"><a href="#一、NIO网络编程模型" class="headerlink" title="一、NIO网络编程模型"></a>一、NIO网络编程模型</h2><h3 id="1、编程模型定义"><a href="#1、编程模型定义" class="headerlink" title="1、编程模型定义"></a>1、编程模型定义</h3><p><strong>NIO :</strong>  又叫<strong>Non-blocking I/O</strong>或<strong>New I/O</strong>;全新的输入输出标准库；</p>
<p>​            做为原始<strong>I/O</strong>的补充，为了高性能和高并发的场景使用。</p>
<p><strong>模型：</strong>对事物共性的抽象；</p>
<p><strong>编程模型：</strong>对编程共性的抽象；</p>
<h3 id="2、BIO网络模型"><a href="#2、BIO网络模型" class="headerlink" title="2、BIO网络模型"></a>2、BIO网络模型</h3><img src="http://photo.wushaopei.com/qiniu74.png" width="60%">

<ul>
<li>服务端启动，开始建立监听客户端的连接请求；</li>
<li>客户端启动，向服务器端发起建立连接请求；</li>
<li>服务器在收到客户端的请求后，将会创建一个新的线程；</li>
<li>服务端新创建的线程会与客户端建立socket连接，用于响应客户端的请求，通知客户端连接建立成功，你随时可以给我发送数据。</li>
<li>服务器端处理完客户端的请求之后，就会处于等待状态，等待客户端再次发起请求</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu75.png" width="60%">

<p>服务端为每一个客户端建一个线程，一旦客户端请求过多，服务端线程数量也会增多，服务端压力增大。 </p>
<h3 id="3、BIO网络模型缺点"><a href="#3、BIO网络模型缺点" class="headerlink" title="3、BIO网络模型缺点"></a>3、BIO网络模型缺点</h3><ul>
<li><strong>阻塞式I/O模型</strong>，会导致服务器端的业务线程会因阻塞IO的问题一直阻塞等待客户端发起请求，如果客户端不发起请求，服务端的业务线程会一直存在，就会耗费大量系统资源</li>
<li><strong>弹性伸缩能力差</strong>：服务器端的线程数与客户端的个数呈1比1的关系</li>
<li><strong>多线程耗资源</strong> ： 每一个线程都会对CPU的调度资源进行占用，一旦占用而不释放，则会导致资源的紧缺、甚至系统服务的异常宕机</li>
</ul>
<h3 id="4、NIO网络模型猜想"><a href="#4、NIO网络模型猜想" class="headerlink" title="4、NIO网络模型猜想"></a>4、NIO网络模型猜想</h3><p><strong>基于非阻塞 I/O ， 设计应对高并发场景编程模型</strong> </p>
<img src="http://photo.wushaopei.com/qiniu76.png" width="60%">

<p>图解分析：<strong>NIO架构中，客户端的个数与服务器端的线程数呈M:1的关系</strong> </p>
<h3 id="5、NIO-网络模型"><a href="#5、NIO-网络模型" class="headerlink" title="5、NIO 网络模型"></a>5、NIO 网络模型</h3><img src="http://photo.wushaopei.com/qiniu77.png" width="60%">

<p><strong>第一步</strong>：注册连接并提供服务：Selector 中初始化注册并建立连接事件，提供给Client建立连接的服务；client通过Selector连接与AcceptorHandler 发送创建客户端的连接，并又AcceptorHandler方法返回响应结果；同时该AcceptorHandler方法向Selector中注册可读事件（Client连接客户端成功后）</p>
<p><strong>第二步</strong>：提供服务：client 发送请求，Selector中对注册状态及客户端可读性验证，正常情况下，已通过第一步，所以直接连接到处理器进行读写操作，根据需求执行业务逻辑，并响应给客户；</p>
<p><strong>第三步</strong> ：客户端连接可读，在向client响应客户端请求后，注册连接可读事件到Selector 中，所注册的是具体执行业务的Handler</p>
<h3 id="6、NIO网络模型优化"><a href="#6、NIO网络模型优化" class="headerlink" title="6、NIO网络模型优化"></a>6、NIO网络模型优化</h3><ol>
<li><strong>非阻塞IO模型</strong>，服务器端提供一个单线程的selector来统一管理所有客户端接入的连接，并负责监听每个连接所关心的事件</li>
<li><strong>弹性伸缩能力加强</strong>，服务器端一个线程处理所有客户端的连接请求，客户端的个数与服务器端的线程数呈M比1的关系</li>
<li><strong>单线程节省资源</strong>,避免了线程的频繁创建和销毁，同时也避免了多个线程之间上下文的切换，提高了执行效率</li>
</ol>
<h2 id="二、NIO网络编程详解"><a href="#二、NIO网络编程详解" class="headerlink" title="二、NIO网络编程详解"></a>二、NIO网络编程详解</h2><p><strong>NIO核心</strong></p>
<ul>
<li><strong>Channel：通道</strong></li>
<li><strong>Buffer ： 缓冲区</strong></li>
<li><strong>Selector : 选择器 或 多路复用器</strong></li>
</ul>
<h3 id="1、NIO核心类之Channel"><a href="#1、NIO核心类之Channel" class="headerlink" title="1、NIO核心类之Channel"></a>1、NIO核心类之Channel</h3><blockquote>
<p><strong>Channel</strong> 具有<strong>双向性、非阻塞性、操作唯一性。</strong></p>
</blockquote>
<p>channel是信息传输的通道，是jdk NIO中对输入输出方法的另一种抽象，类比IO中的流，与流不同之处在于，channel具有双向性，而流是单向传输的，一个流必须是InputStream或OutputStream的子类，而通道可以用于读写或二者同时进行。channel可以工作在非阻塞模式下，构成NIO的基础。在NIO中，操作channel的唯一方式是使用buffer，通过buffer操作channel，实现数据块的传输。</p>
<p><strong>channel的实现：</strong> </p>
<blockquote>
<ol>
<li>文件类：FileChannel，用于对文件的读写</li>
<li>UDP类：DatagramChannel， 用于UDP的数据读写</li>
<li>TCP类：ServerSocketChannel/SocketChannel，用于TCP的数据读写</li>
</ol>
</blockquote>
<p><strong>Socket的使用：</strong> </p>
<p><strong>服务端：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 监听窗口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">8000</span>);</span><br><span class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="comment">// 2. 接受请求、建立链接</span></span><br><span class="line">			Socket socket = serverSocket.accept();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 3.数据交换</span></span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> BIOServerHandler(socket)).start();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 *  4. 关闭资源</span></span><br><span class="line"><span class="comment">		 * */</span></span><br><span class="line">		serverSocket.close();</span><br></pre></td></tr></table></figure>

<p><strong>客户端：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  1.建立链接</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>,<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  获取输入输出流</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">InputStream inputStream = socket.getInputStream();</span><br><span class="line">OutputStream outputStream = socket.getOutputStream();</span><br></pre></td></tr></table></figure>

<p><strong>Channel的使用：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段1: 服务器端通过服务端socket创建channel</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段2: 服务器端通绑定端口</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">serverSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8000</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段3: 服务器端监听客户端链接，建立socketChannel链接</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">SocketChannel socketChannel = serverSocketChannel.accept(<span class="string">"127.0.0.1"</span>,<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  代码片段4: 客户端链接远程主机及端口</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">SocketChannel socketChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">""</span>))</span><br></pre></td></tr></table></figure>

<h3 id="2、NIO核心类之Buffer"><a href="#2、NIO核心类之Buffer" class="headerlink" title="2、NIO核心类之Buffer"></a>2、NIO核心类之Buffer</h3><p><strong>Buffer</strong>：缓冲区，它提供唯一与channel进行交互的方式，作用是读写channel中的数据。Buffer从本质上说是一块内存区域，它是一块可以写入数据，读取数据的内存。</p>
<p><strong>Buffer的属性</strong></p>
<blockquote>
<p><strong>Capacity</strong>：分配的buffer容量，一旦写入的最大字节数超过这个容量，需要将其清空之后，才能继续往里面写数据</p>
<p><strong>Position</strong>：当前操作的位置，初始值为0，最大值：容量值-1</p>
<p><strong>Limit</strong>：上限，写模式下等于Capacity，读模式下等于最多能读取的数据</p>
<p><strong>Mark</strong>：标记，记录mark的位置，调用reset方法时position会回到mark的位置</p>
</blockquote>
<p><strong>Buffer的使用：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 初始化长度为10的byte类型 buffer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ByteBuffer.allocate(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu78.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 向byteBuffer中写入三个字节</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.put(<span class="string">"abc"</span>.getBytes(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu79.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将byteBuffer从写模式切换成读模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.flip():</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu80.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将b先调用get方法读取下一个字节</span></span><br><span class="line"><span class="comment"> * 再调用reset方法将position重置到mark位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.get():</span><br><span class="line">byteBuffer.reset();</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu81.png" width="60%">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 调用clear方法，将所有属性重置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">byteBuffer.clear();</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu82.png" width="60%">

<h3 id="3、NIO核心类之Selector"><a href="#3、NIO核心类之Selector" class="headerlink" title="3、NIO核心类之Selector"></a>3、NIO核心类之Selector</h3><p><strong>Selector 选择器/多路复用器</strong></p>
<p><strong>作用</strong>：I/O就绪选择</p>
<p><strong>地位</strong>：NIO网络编程的基础</p>
<p><strong>SelectionKey 选择键</strong></p>
<blockquote>
<p>四种就绪状态常量：<strong>连接就绪、接受就绪、读就绪、写就绪</strong></p>
</blockquote>
<p><strong>Selector的使用：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 代码片段1:创建 Selector </span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"> Selector  selector =  Selector.open();</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 代码片段2：将channel注册到selector上，监听读取就绪事件</span></span><br><span class="line"><span class="comment"> * */</span> </span><br><span class="line"> SelectionKey selectionKey = channel.register(SelectionKey.OP_READ);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * 代码片段3：阻塞等待channel有就绪事件发生</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line"> <span class="keyword">int</span> selectNum = selector.select();</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * 代码片段4：获取发生就绪事件的channel集合</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line"> Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br></pre></td></tr></table></figure>



<p><strong>最重要的应该就是代码片段3：</strong> 在这一步对就绪事件进行监听，如果一直不通过，就一直阻塞等待，直到有就绪事件发生，并注册通过检测有效，方才放行 </p>
<h3 id="4、NIO编程实现步骤"><a href="#4、NIO编程实现步骤" class="headerlink" title="4、NIO编程实现步骤"></a>4、NIO编程实现步骤</h3><blockquote>
<p>第一步：创建Selector</p>
<p>第二步：创建ServerSocketChannel，并绑定监听端口</p>
<p>第三步：将Channel设置为非阻塞模式</p>
<p>第四步：将Channel注册到Selector上，监听连接事件</p>
<p>第五步：循环调用Selector的select方法，检测就绪情况</p>
<p>第六步：调用selectedKeys方法获取就绪channel集合</p>
<p>第七步：判断就绪事件种类，调用业务处理方法</p>
<p>第八步：根据业务需要决定是否再次注册监听事件，重复执行第三步操作</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化开发（二）BC代码讲解</title>
    <url>/2020/03/24/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89BC%E4%BB%A3%E7%A0%81%E8%AE%B2%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="代码结构包目录图："><a href="#代码结构包目录图：" class="headerlink" title="代码结构包目录图："></a>代码结构包目录图：</h2><img src="http://photo.wushaopei.com/qiniu217.png" width="80%">

<h2 id="代码分块："><a href="#代码分块：" class="headerlink" title="代码分块："></a>代码分块：</h2><ol>
<li>api - bundle </li>
<li>bc-common   </li>
<li>bc-model-bundle</li>
<li>service 层： bc-service- * - *   （包括bc-jobdata-service-bundle）</li>
</ol>
<p>​        bc-service 开头的是整个BC的逻辑层代码</p>
<ol start="5">
<li><p>bc-simulator-bundle  （修改simulator 用的）</p>
</li>
<li><p>jar 层</p>
<p>包含四个模块的功能：</p>
<pre><code>bc-workflow-bundle

secsgem

plcconnector

rvconnector</code></pre></li>
<li><p>日志层  </p>
<p>osgi-logger-common</p>
<p>osgi-loglistener</p>
</li>
<li><p>数据转换层</p>
<p>oee-datatransmitter-bundle</p>
<p>mes-datatransmitter-bundle</p>
<p>eq-datatransmitter-bundle</p>
<p>edc-datatransmitter-bundle</p>
</li>
</ol>
<p>​        secs-datatransmitter-bundle</p>
<p>​    fdc-datatransmitter-bundle</p>
<img src="http://photo.wushaopei.com/qiniu221.png" width="80%">

<p>   这一层的功能模块只做数据转换处理，转换完成后；数据会先经过bc-workflow-bundle，之后再转到bc-service- * -bundle 这一层，最终会在service层中根据 bc-model-bundle 中给定的模型将数据进行包装处理成bean形式的数据后存储起来（主要在bc-service-line-bundle中处理）。</p>
<ol start="9">
<li><p>view 层 （客户端）</p>
<p>client-common-bundle</p>
<p>client-service-bundle</p>
</li>
</ol>
<p>在客户端主要是通过http协议对请求进行解析，在项目中内嵌了 jetty 容器，所以项目不需要打包放到tomcat中，客户端的页面资源则需要放置到 tomcat 的webapp目录下才能访问。</p>
<h2 id="api-bundle"><a href="#api-bundle" class="headerlink" title="api - bundle"></a>api - bundle</h2><h3 id="基本原则："><a href="#基本原则：" class="headerlink" title="基本原则："></a><strong>基本原则：</strong></h3><ol>
<li><h4 id="Port的获取"><a href="#Port的获取" class="headerlink" title="Port的获取"></a><strong>Port的获取</strong></h4></li>
</ol>
<p>一条线上可能有多个设备，每个设备上有unit，每个unit或设备上有job。如果要找PORT，就直接找PortDAO。</p>
<p>Port通过属性和EQP关联起来，****</p>
<ol start="2">
<li><h4 id="捞取数据"><a href="#捞取数据" class="headerlink" title="捞取数据"></a><strong>捞取数据</strong></h4></li>
</ol>
<p>有一部分数据是从DB捞的，有一部分是从实时运行中捞的数据；从DB上捞的数据也就是我们做的BC工具里面的数据，我们都是放在 Data 中的。</p>
<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p> 凡是以BC * 开头的参数都是可以从Data中获取数据的，例如： BcPort、BcEquiment、BcUnit等。</p>
<p>这些数据都是在DB里面捞的，这些数据都是在我们 set Off 之前，key 的数据库里面的数据。</p>
<h4 id="应用："><a href="#应用：" class="headerlink" title="应用："></a>应用：</h4><p>如果要查找Port的一些属性，比如： Port属于哪个设备、哪条线，都可以通过 getData 去取里面的属性就可以了。</p>
<img src="http://photo.wushaopei.com/qiniu218.png" width="80%">

<h3 id="数据实体对应关系"><a href="#数据实体对应关系" class="headerlink" title="数据实体对应关系"></a>数据实体对应关系</h3><p><strong>DB对应实体：</strong>  </p>
<p>BcPort、BcEquiment 等Bc开头的实体都对应数据库的表，主要放在 com.glorysoft.bc.db.entity包</p>
<p><strong>逻辑层对应实体：</strong><br>放置在com.glorysoft.bc.entity包下</p>
<h3 id="接口的两种类型："><a href="#接口的两种类型：" class="headerlink" title="接口的两种类型："></a>接口的两种类型：</h3><ol>
<li>外部系统调用BC逻辑的接口；</li>
<li>BC逻辑处理完了给外部发送消息的接口</li>
</ol>
<h4 id="BC调用外部的接口包有："><a href="#BC调用外部的接口包有：" class="headerlink" title="BC调用外部的接口包有："></a>BC调用外部的接口包有：</h4><p>​    com.glorysoft.bc.api.client</p>
<p>​    com.glorysoft.bc.api.connection</p>
<p>​    com.glorysoft.bc.api.dao</p>
<p>​    com.glorysoft.bc.api.eqtransmitter</p>
<p>​    com.glorysoft.bc.api.host </p>
<h4 id="外部调用BC接口的包："><a href="#外部调用BC接口的包：" class="headerlink" title="外部调用BC接口的包："></a>外部调用BC接口的包：</h4><p>​    com.glorysoft.bc.api.line</p>
<p>​    com.glorysoft.bc.api.linespecial</p>
<p>​    com.glorysoft.bc.api.linksignal</p>
<p>​    com.glorysoft.bc.api.machine</p>
<p>​    com.glorysoft.bc.api.material</p>
<p>​    com.glorysoft.bc.api.mes</p>
<p>​    com.glorysoft.bc.api.mesevent</p>
<p>​    com.glorysoft.bc.api.port</p>
<p>​    com.glorysoft.bc.api.service</p>
<h2 id="bc-model-bundle"><a href="#bc-model-bundle" class="headerlink" title="bc-model-bundle"></a>bc-model-bundle</h2><p>前面我们知道了，API对实体的定义方式以及接口的开放类型。但那些主要还是为了给bc-model类做准备。</p>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><h4 id="EQP"><a href="#EQP" class="headerlink" title="EQP"></a>EQP</h4><hr>
<p>比如我们在API中只定义了一个EQP的对象，那么在 model 启动之后，如果这条线配了四个设备，那么在model中就会有四个EQP的实体；这些实体存在于 model 中的Dao中；如下图：</p>
<img src="http://photo.wushaopei.com/qiniu219.png" width="80%">

<p>在EquipmentDaoImpl 类中，存在一个 Map&lt;String,Equipment&gt;的集合类。如果一条线中存在有四个设备，那么这个 equipmentmap 中就有四个Equipment 。</p>
<h5 id="更多的接口开放："><a href="#更多的接口开放：" class="headerlink" title="更多的接口开放："></a>更多的接口开放：</h5><p>除了map 这一个用于存放 EQP的集合容器外，该接口类中还开放了多个给外部调用的接口，比如load（） 、getEquipmentByNo()等；</p>
<img src="http://photo.wushaopei.com/qiniu220.png" width="80%">



<h4 id="JOB"><a href="#JOB" class="headerlink" title="JOB"></a>JOB</h4><hr>
<p>在捞取数据时，不一定就要去DB中取，也可能仅仅是从Redis中去获取。</p>
<p>以下是 JobDaoImpl(Job对外开放的接口)的读数据的接口reload（）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动是读取Job Data From File</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018年1月18日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Job&gt; <span class="title">reload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Map&lt;String, Job&gt; map = <span class="keyword">new</span> HashMap&lt;String, Job&gt;();</span><br><span class="line">	Set&lt;String&gt; keys = RedisHelper.getKeys(redisPrefix + <span class="string">"*"</span>);</span><br><span class="line">	<span class="keyword">if</span> (keys != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">				<span class="keyword">byte</span>[] a = RedisHelper.get(key.getBytes());</span><br><span class="line">				<span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">					Job job = (Job) SerializeUtils.deSerialize(a);</span><br><span class="line">					<span class="keyword">if</span> (job != <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="keyword">if</span>(<span class="keyword">this</span>.serverName.equals(job.getLineId()) || job.isCrossLine())</span><br><span class="line">						&#123;</span><br><span class="line">							String jobNo = job.getCassetteSeqNo() + <span class="string">"_"</span> + job.getJobSeqNo();</span><br><span class="line">							map.put(jobNo, job);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="comment">// 2017-4-5 序列化失败则直接从Redis中删除</span></span><br><span class="line">						RedisHelper.del(key);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">			BCLogService.traceError(LogTag.Exception, BundleNameDefine.BC_MODEL_NAME, <span class="string">"JobDaoImpl-reload"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>当所有的卡夹都全部被取出后，checkout结束后就会抛一个状态出来，这个时候我们就会把内存里面的数据包括Redis里面的数据全部删掉，该删除操作会调用JobDaoImpl中的deleteJob（） 接口。</p>
<p><strong>内存问题-指南</strong> </p>
<p>如果程序存在内存的问题，要查看是否有glass的数据没有及时清除、残留而导致的。</p>
<h3 id="Dao的封装"><a href="#Dao的封装" class="headerlink" title="Dao的封装"></a>Dao的封装</h3><img src="http://photo.wushaopei.com/qiniu222.png" width="80%">

<p>如图所示，所有对外提供的Dao接口类都在LineModelServiceImpl类中进行了整合，可以直接通过LineModelServiceImpl类获取所要调用的对外接口。</p>
<h3 id="增量数据"><a href="#增量数据" class="headerlink" title="增量数据"></a>增量数据</h3><p>如果针对某一个实体要增加属性，只需要直接对相应的实体进行修改就行了。这里以Equipment为例，假如我们要给EQP添加一个状态 status ，可以直接在 Equipment.java中直接添加</p>
<img src="http://photo.wushaopei.com/qiniu223.png" width="80%">

<p>在pojo中添加后，就不需要对 model 层进行修改了。</p>
<h2 id="bc-service-bundle"><a href="#bc-service-bundle" class="headerlink" title="bc-service- * - bundle"></a>bc-service- * - bundle</h2><h3 id="bc-service-machine-bundle"><a href="#bc-service-machine-bundle" class="headerlink" title="bc-service-machine-bundle"></a>bc-service-machine-bundle</h3><h4 id="对OSGI的实现"><a href="#对OSGI的实现" class="headerlink" title="对OSGI的实现"></a>对OSGI的实现</h4><p>业务层中每个bundle必须实现一个OSGI提供的接口 - BundleActivator ,并实现该类的方法。</p>
<img src="http://photo.wushaopei.com/qiniu224.png" width="80%">

<p>重写的方法为 start() 和 stop() 这两个方法，其中的 getContext() 和 getExecutor () 两个方法是用于获取上下文和配置所用的。</p>
<h4 id="start-BundleContext-context"><a href="#start-BundleContext-context" class="headerlink" title="start(BundleContext context)"></a>start(BundleContext context)</h4><img src="http://photo.wushaopei.com/qiniu225.png" width="80%">

<p>在包启动过程中，会启动 bundleContext = context，同时获取上下文的数据。</p>
<h5 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h5><img src="http://photo.wushaopei.com/qiniu227.png" width="80%">

<p>在 <strong>bc-service- * -bundle</strong> 中声明了服务之后，如 AlarmServiceImpl等之后如果不进行注册，就无法被外界访问到。这一步很重要，这里通过 registerService（） 方法将服务注册到OSGI，从而实现了接口的对外开放。</p>
<h5 id="服务监听"><a href="#服务监听" class="headerlink" title="服务监听"></a>服务监听</h5><img src="http://photo.wushaopei.com/qiniu228.png" width="80%">

<p>这里主要是对服务进行监听，其监听机制是动态添加服务，即 addService（）进行添加服务，每次启动都会将服务添加到 ServiceHolder中去。</p>
<h5 id="服务的调用"><a href="#服务的调用" class="headerlink" title="服务的调用"></a>服务的调用</h5><p>在其他的逻辑层代码中，只需要通过 ServiceHolder就可以调用到对应的服务了。</p>
<h4 id="stop-BundleContext-context"><a href="#stop-BundleContext-context" class="headerlink" title="stop(BundleContext context)"></a>stop(BundleContext context)</h4><img src="http://photo.wushaopei.com/qiniu226.png" width="80%">

<p>在关闭的时候会调用类中的    alarmService.unregister(); 方法。</p>
<p><strong>以上两者可以理解为，启动时对资源进行获取和占用，关闭时需要对资源进行释放。</strong></p>
<h3 id="bc-service-recipe-bundle"><a href="#bc-service-recipe-bundle" class="headerlink" title="bc-service-recipe-bundle"></a>bc-service-recipe-bundle</h3><h4 id="涉及的业务逻辑有："><a href="#涉及的业务逻辑有：" class="headerlink" title="涉及的业务逻辑有："></a>涉及的业务逻辑有：</h4><ol>
<li>有三层timeout;</li>
<li>有三层recipe检查、MES检查、BC检查</li>
<li>以及多个方向： 如MES到BC，BC到设备，最后设备回回来，设备回回来还要和MES请求，mes再回给设备。</li>
</ol>
<h2 id="datatransmitter-bundle"><a href="#datatransmitter-bundle" class="headerlink" title="*-datatransmitter-bundle"></a>*-datatransmitter-bundle</h2><h3 id="edc-datatransmitter-bundle"><a href="#edc-datatransmitter-bundle" class="headerlink" title="edc-datatransmitter-bundle"></a>edc-datatransmitter-bundle</h3><p>当前模块主要做数据转换操作，①把model层数据转成 secs 消息或plc的消息；②把plc或secs收过来的消息转成model数据</p>
<h3 id="plc-datatransmitter-bundle"><a href="#plc-datatransmitter-bundle" class="headerlink" title="plc-datatransmitter-bundle"></a>plc-datatransmitter-bundle</h3><h4 id="消息入口"><a href="#消息入口" class="headerlink" title="消息入口"></a>消息入口</h4><p>在PLC数据处理模块中，有一个重要的类-PLCMessageDispatcher，该类实现了PLCEventDispatcher接口。在PLC模块中定义的消息处理的handler类都必须在这个类中进行注册或者说添加到handler的管理之中。具体如下：</p>
<img src="http://photo.wushaopei.com/qiniu229.png" width="80%">

<p>所有被添加到PLCMessageDispatcher中的handler都会在启动后被自动注册到中央控制器里。</p>
<img src="http://photo.wushaopei.com/qiniu230.png" width="80%">

<h4 id="数据转化"><a href="#数据转化" class="headerlink" title="数据转化"></a>数据转化</h4><h5 id="PLCMessage转为Model数据（从设备到BC的数据转换）："><a href="#PLCMessage转为Model数据（从设备到BC的数据转换）：" class="headerlink" title="PLCMessage转为Model数据（从设备到BC的数据转换）："></a>PLCMessage转为Model数据（从设备到BC的数据转换）：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunModeChangeReportBlockHandler</span> <span class="keyword">extends</span> <span class="title">MessageHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ITEM_RUNMODE = <span class="string">"RunMode"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RunModeChangeReportBlockHandler</span><span class="params">(Object sender)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(sender);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(PLCMessage msg)</span> </span>&#123;</span><br><span class="line">        TraceData trace = <span class="keyword">this</span>.getTraceData(msg);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			trace.setFlowTriggerCondi(<span class="string">"RunModeReport"</span>);</span><br><span class="line">			trace.setTrxName(<span class="string">"RunModeChangeReportBlock"</span>);</span><br><span class="line">			Equipment equipment = <span class="keyword">new</span> Equipment();</span><br><span class="line">			String value = msg.getItemValue(ITEM_RUNMODE);</span><br><span class="line">			EnumData mode = <span class="keyword">this</span>.convert2EnumData(msg, ITEM_RUNMODE, value); </span><br><span class="line">			equipment.setRunMode(mode);</span><br><span class="line">			ClientCommand clientCommand = <span class="keyword">new</span> ClientCommand();</span><br><span class="line">            trace.setcCmd(clientCommand);  </span><br><span class="line">			List&lt;Unit&gt; unitList = <span class="keyword">new</span> ArrayList&lt;Unit&gt;();</span><br><span class="line">			ServiceHolder.getBCService().process(trace, equipment, unitList);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            BCLogService.traceError(LogTag.Exception, BundleNameDefine.EQ_BUNDLE_NAME, trace.toBasicLogString(LogDirection.EQP_BCS),</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以RunModeChangeReportBlockHandler为例，需要将java传过来的实体 PLCMessage 转为对应的Model实体。</p>
<p>在这里，数据的一部分转化要先转换为TraceData已提供给执行过程中进行跟踪交互所使用。</p>
<p>然后再根据 Equitment 的实体转为相应的实体数据，这一步在不同的handler中要根据具体的handler 的业务和数据参数的具体情况来确定。</p>
<p><strong>当前handler的数据转换</strong>在这个handler中，先将msg转为EQP实体，并获取到 ITEM_RUNMODE ,通过trace中获取data数据来完成 EQP实体的数据封装和转换。</p>
<h5 id="从BC向设备发数据的转换"><a href="#从BC向设备发数据的转换" class="headerlink" title="从BC向设备发数据的转换"></a>从BC向设备发数据的转换</h5><p>比如我们BC如果要给设备发一个CIMMessage数据，那么我们需要做什么操作呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CIMMessageCommandSvrImpl</span> <span class="keyword">implements</span> <span class="title">CIMMessageCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String cimblockName = <span class="string">"CIMMessageSetCommandBlock"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String cimItemMessageID = <span class="string">"CIMMessageID"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String cimItemMessage = <span class="string">"CIMMessage"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CleanCIMMessageBlock = <span class="string">"CIMMessageClearCommandBlock"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cimMessageSetCommand</span><span class="params">(TraceData trace, CIMMessage message, String[] eqps)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"> 			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; eqps.length; i++) &#123;</span><br><span class="line">				PLCMessage msg = <span class="keyword">new</span> PLCMessage();</span><br><span class="line">				msg.setEQPName(eqps[i]);</span><br><span class="line">				msg.setName(cimblockName);</span><br><span class="line">				<span class="keyword">int</span> msgId = message.getMessageId();</span><br><span class="line">				<span class="keyword">if</span> (msgId == <span class="number">0</span>) &#123;</span><br><span class="line">				    msgId = ServiceHolder.getLineModeService().getCimMessageDao().generateCimMessageId();</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				msg.setItem(cimItemMessageID, String.valueOf(msgId));</span><br><span class="line">				msg.setItem(cimItemMessage, message.getMessageText());</span><br><span class="line">				msg.setItem(<span class="string">"TouchPanelNo"</span>, String.valueOf(message.getTouchPanelNo()));</span><br><span class="line">				</span><br><span class="line">				ConnectionManager.getConnContext().sendMessage(trace, msg);</span><br><span class="line">			&#125;</span><br><span class="line">			message.setMessageStatus(<span class="string">"SET"</span>);</span><br><span class="line">			trace.setWorkflowTraceData(<span class="number">1</span>, message);</span><br><span class="line">			trace.setWorkflowTraceData(<span class="number">2</span>, eqps);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		    BCLogService.traceError(LogTag.Exception, BundleNameDefine.EQ_BUNDLE_NAME, trace.toBasicLogString(LogDirection.BCS_EQP), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>此时，我们的初始数据是以Model 实体的形式存在，如果要发送数据给设备，需要将数据转换为相应的PLCMessage类型的数据。</p>
<p><strong>具体的方式如下：</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PLCMessage msg &#x3D; new PLCMessage();</span><br><span class="line">		msg.setEQPName(eqps[i]);</span><br><span class="line">		msg.setName(cimblockName);</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>在进行数据的转换完成后，再调用相应的sendMessage（）方法将数据发送即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ConnectionManager.getConnContext().sendMessage(trace, msg);</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>以上两种数据的转换方式适用于所有的 datatransmitter 数据转换层 模块。</p>
<h2 id="db-service-bundle"><a href="#db-service-bundle" class="headerlink" title="db-service-bundle"></a>db-service-bundle</h2><p>持久层，这里主要是根据DB的列与实体类进行映射。在底层使用了一个插件来实现映射关系，不需要手动进行修改。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上是插件的依赖驱动部分，位于db模块的 pom.xml中。</p>
<p>该模块中不需要进行太多的手动代码修改或增删，其 mapper.xml文件都是根据插件自动逆向工程生成的。</p>
<h2 id="client-service-bundle"><a href="#client-service-bundle" class="headerlink" title="client-service-bundle"></a>client-service-bundle</h2><p>在 client-service-bundle 这个模块中，它也需要对 Workflow 以及 model进行监听。</p>
<img src="http://photo.wushaopei.com/qiniu231.png" width="80%">

<h4 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Add httpservice servlet</span></span><br><span class="line">servletServerThread = <span class="keyword">new</span> ServletServerThread();</span><br><span class="line"><span class="comment">// servletServerThread.setResourceConfig(jerseyConfig);</span></span><br><span class="line">httpServer = <span class="keyword">new</span> Thread(servletServerThread);</span><br><span class="line">httpServer.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add websocket servlet</span></span><br><span class="line">Thread webSocketServer = <span class="keyword">new</span> Thread(<span class="keyword">new</span> WebSocketServletThread());</span><br><span class="line">webSocketServer.start();</span><br></pre></td></tr></table></figure>

<p>这里需要启动 httpservice \ websocket </p>
<h5 id="httpServer配置"><a href="#httpServer配置" class="headerlink" title="httpServer配置"></a>httpServer配置</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletServerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>  Server httpServer;</span><br><span class="line">	<span class="keyword">private</span>  ResourceConfig resourceConfig;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> hostPort = <span class="number">8081</span>;</span><br><span class="line">    ……</span><br></pre></td></tr></table></figure>

<p>这里的HttpService 的端口号是写死的。</p>
<h5 id="webSocket配置"><a href="#webSocket配置" class="headerlink" title="webSocket配置"></a>webSocket配置</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketServletThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> hostPort = <span class="number">8085</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Server wsserver;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>这里的WebSocket 的端口号也是写死的。</p>
<h2 id="重点：启动器-felix"><a href="#重点：启动器-felix" class="headerlink" title="重点：启动器 - felix"></a>重点：启动器 - felix</h2><p>启动类的模块是 felixlaunch</p>
<h3 id="启动规则："><a href="#启动规则：" class="headerlink" title="启动规则："></a>启动规则：</h3><p> 该项目是基于OSGI平台搭建的，其启动也必须基于OSGI平台来实现，具体的启动步骤为：</p>
<p>​    1. 启动OSGI平台；</p>
<p>​    2. 由OSGI平台加载项目的bundle；</p>
<h4 id="启动的主要对象："><a href="#启动的主要对象：" class="headerlink" title="启动的主要对象："></a>启动的主要对象：</h4><img src="http://photo.wushaopei.com/qiniu232.png" width="80%">

<h4 id="启动流程："><a href="#启动流程：" class="headerlink" title="启动流程："></a>启动流程：</h4><p>默认先加载 conf 目录下的 config.propertiees 配置文件，主要加载的内容为下图中所示的</p>
<p>felix.auto.start.1 开始的所有file文件的jar包</p>
<img src="http://photo.wushaopei.com/qiniu233.png" width="80%">

<p>并且根据配置文件默认加载指定目录下的bundle，如下图所示：</p>
<img src="http://photo.wushaopei.com/qiniu234.png" width="80%">

<h5 id="jar启动顺序："><a href="#jar启动顺序：" class="headerlink" title="jar启动顺序："></a>jar启动顺序：</h5><p>​    先启动model 层，再启动service层，再启动数据转换层。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="DB层配置"><a href="#DB层配置" class="headerlink" title="DB层配置"></a>DB层配置</h4><p>这里包括DB和Redis 的配置文件，即 mybatis-config.xml 、redis.properties 两个配置文件。</p>
<h4 id="线启动配置"><a href="#线启动配置" class="headerlink" title="线启动配置"></a>线启动配置</h4><p>该配置文件为startup.properties ，需要修改的主要为 serverName ，即要启动的那条线的线名。</p>
<h3 id="Workflows"><a href="#Workflows" class="headerlink" title="Workflows"></a>Workflows</h3><h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>自动化开发（五）Specification-04-Data Communication</title>
    <url>/2020/04/08/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%94%EF%BC%89Specification-04-Data%20Communication/</url>
    <content><![CDATA[<h1 id="04-Data-Communication"><a href="#04-Data-Communication" class="headerlink" title="04. Data Communication"></a>04. Data Communication</h1><p>PLC存储器的数据区域分为两个区域，即 <strong>Local Area</strong>  和 <strong>Master Area</strong> 。<strong>Local Area</strong> 用于从 <strong>Local  PLC</strong>  向 <strong>Master PLC</strong> 发送数据，而 <strong>Master Area</strong> 用于从  <strong>Master PLC</strong> 向 <strong>Local PLC</strong> 传输数据。每个区域的项目根据报告或命令的特征分为几个类型，每个项目类型如下所示。</p>
<ul>
<li>Local Area <ul>
<li>Status :  表示设备、端口、PLC当前状态的项。 </li>
<li>Event :    表示设备生成的事件的项 </li>
<li>Request :  设备请求对BC做任何动作的许可。</li>
<li>Command Reply : 设备响应主PLC的命令 (BC)</li>
</ul>
</li>
<li>Master Area <ul>
<li>Status :  表示BC和主PLC状态的项。</li>
<li>Command : 可以发送到本地PLC的项</li>
<li>Event Reply : 从设备中针对事件进行回复的项。 </li>
<li>Request Reply：根据设备的要求进行回复的项目 </li>
</ul>
</li>
</ul>
<h2 id="04-01-Link-Relay-Link-Register-Relation"><a href="#04-01-Link-Relay-Link-Register-Relation" class="headerlink" title="04.01. Link Relay, Link Register Relation"></a>04.01. Link Relay, Link Register Relation</h2><ul>
<li>当事件发生或某些数据发生变化时，本地PLC必须将数据写入特定的Word Area <strong>(W区)</strong>，然后打开相关的本地Bit Area<strong>(B区)</strong>触发事件 </li>
<li>当Bit Area的数据发生变化时，主PLC应读取相关的Word Area 区域，然后打开自己的Bit Area进行应答，应答对应于本地继电器。 </li>
<li>当主PLC的响应是OK时，本地PLC关闭其Bit Area。 </li>
<li>当本地PLC的Bit Area断开时，主PLC断开与本地PLC的Bit Area相对应的Bit Area </li>
</ul>
<h2 id="04-02-EQP-Event-Report-Timing-Chart"><a href="#04-02-EQP-Event-Report-Timing-Chart" class="headerlink" title="04.02. EQP Event Report Timing Chart"></a>04.02. EQP Event Report Timing Chart</h2><h3 id="04-02-01-Event-Report-Timing-Chart-Local-to-Master"><a href="#04-02-01-Event-Report-Timing-Chart-Local-to-Master" class="headerlink" title="04.02.01. Event Report Timing Chart (Local to Master)"></a>04.02.01. Event Report Timing Chart (Local to Master)</h3><img src="http://photo.wushaopei.com/qiniu277.png" width="80%">

<p>如图，是机台报到BC 的流程。</p>
<p>第一步，Local 会先写Word Area ，然后Bit on  起来。</p>
<p>第二步，BC 监测到Local 的BIT  on 起来后，会在对应的Word 去读取数据（Data Reading)，读取完数据后会进行处理。处理完成好，会进行 Reply  on 起来回复。</p>
<p>第三步，机台收到回复后，机台的 Event Report 会 off 。BC 收到机台的 off 后，BC的 Event Report Reply 也会 off.</p>
<p>以上就是一个事件的完整流程。</p>
<p>关于CIM MODE ：</p>
<p>CIM MODE 如果是开着的，那么就按照正常流程去走即可；</p>
<p>如果CIM MODE是关掉的，就不会有Local On BIT 和  Master 检测 Bit 变化的那一步，机台的Report 会一直off ，但是数据还是要写入到 Word Area 的。</p>
<p>为什么要这么做？</p>
<p>在机台、机况等比较重要的状态，包括 port 信息等，如果该流程是在CIM MODE  off 的状态下执行的，它实时的更新到Word Area ，在它开启之后，或者BC 重启之后，会重新捞一遍数据。我们会给他更新到最新的状况，而不是说现场发生了什么我们还不知道。</p>
<h3 id="04-02-02-Request-Timing-Chart-Local-to-Master"><a href="#04-02-02-Request-Timing-Chart-Local-to-Master" class="headerlink" title="04.02.02. Request Timing Chart (Local to Master)"></a>04.02.02. Request Timing Chart (Local to Master)</h3><img src="http://photo.wushaopei.com/qiniu292.png" width="80%">

<p>① 将数据输入Word Area (W区)后，本地PLC打开Bit Area(B区)。 </p>
<p>② Local PLC加载计时器检查超时。(T1:4秒)-本地PLC在此期间不报告任何使用此Bit Area的其他事件。 </p>
<p>③主PLC读取数据，然后打开Bit Area(B区)。</p>
<p>④ 本地PLC读取主PLC的数据并关闭Bit Area(事件位)，然后继续下一步动作 </p>
<p>⑤主PLC关闭Bit Area(事件应答)，定时器复位后。主PLC在T2时间内扫描本地PLC的链路。如果超时，主PLC处理错误例程(T2超时时间为2秒)</p>
<ul>
<li>EQ厂商提供T1定时器数值设定功能。(默认值= 4秒) </li>
<li>本地PLC在Word Area 中保存一次设置的报表数据，直到生成新的报表数据。 </li>
</ul>
<p><strong>流程：</strong> </p>
<p>① 机台将数据写入到W区，也就是Data中，然后Bit Area on 起来</p>
<p>② BC 收到机台 on 起来的消息，会先去读 机台的 W区；并进行逻辑运算、数据处理，将处理结果写入BC的 W区（Return Code）,然后Bit 也 on 起来</p>
<p>③ 机台收到BC on 起来的消息，就去读BC的 W Area ，读取完成后就将Bit  off</p>
<p>④ BC 收到 机台 Bit Are off ,也进行 off。</p>
<h3 id="04-02-03-Consecutive-Event-Report-Timing-Chart-Local-to-Master"><a href="#04-02-03-Consecutive-Event-Report-Timing-Chart-Local-to-Master" class="headerlink" title="04.02.03. Consecutive Event Report Timing Chart (Local to Master)"></a>04.02.03. Consecutive Event Report Timing Chart (Local to Master)</h3><img src="http://photo.wushaopei.com/qiniu293.png" width="80%">

<p>​    当本地PLC有多个连续数据要使用一个事件位(如Alarm或Job)报告给主PLC时，上述时序图指定了数据报告事件的过程。</p>
<p>① 如果本地PLC有数据(命名数据A)要报告给主PLC，则在缓冲区中设置数据A </p>
<p>② 如果本地PLC目前没有其他先前的数据报告给主PLC，则移动数据到缓冲区中设置一个连接寄存器区域并报告给主PLC。</p>
<p>③ 如果本地PLC有新的数据(命名数据B)报告给主PLC，本地PLC在缓冲区中设置数据B。如果此时有之前的数据(即数据A)正在报告给master，本地PLC等待，直到数据报告过程结束</p>
<p>④ 主PLC关闭Bit Area(事件应答)后，本地PLC等待0.5秒(T3:0.5秒)，然后本地PLC将数据B移动到链路字区，并报告给主PLC </p>
<ul>
<li>EQ厂商提供T3定时器值设定功能。(默认值= 0.5秒) </li>
</ul>
<h2 id="04-03-BC-Command-Reply-Timing-Chart"><a href="#04-03-BC-Command-Reply-Timing-Chart" class="headerlink" title="04.03. BC Command Reply Timing Chart"></a>04.03. BC Command Reply Timing Chart</h2><h3 id="04-03-01-BC-Command-Timing-Chart-Master-to-Local"><a href="#04-03-01-BC-Command-Timing-Chart-Master-to-Local" class="headerlink" title="04.03.01. BC Command Timing Chart (Master to Local)"></a>04.03.01. BC Command Timing Chart (Master to Local)</h3><p>BC Notice Area is related to Equipment Command Reply Area （BC通知区与设备命令应答区相关）</p>
 <img src="http://photo.wushaopei.com/qiniu294.png" width="80%">

<p>①将数据设置到主PLC的Word Area 区域后，主PLC再打开Bit Area(命令) </p>
<p>②主PLC加载定时器检查超时。(T1: 4秒) </p>
<p>③本地PLC读取主区域的数据。读取后，本地PLC打开本地PLC的Bit Area(命令应答) </p>
<p>④主PLC在命令应答时关闭Bit Area(命令)。如果在T1超时内本地PLC没有打开应答位，则主PLC处理错误例程 </p>
<p>⑤本地PLC关闭Bit Area(命令应答)，定时器复位后。本地PLC在T2时间内扫描主PLC的Bit Area。如果超时(T2)发生，本地PLC处理错误例程。 </p>
<ul>
<li>EQ厂商提供T2定时器数值设定功能。(默认值= 2秒) </li>
</ul>
<h2 id="04-04-Time-Out-Error"><a href="#04-04-Time-Out-Error" class="headerlink" title="04.04. Time Out Error"></a>04.04. Time Out Error</h2><h3 id="04-04-01-T1-Time-Out-Master-↔-Local"><a href="#04-04-01-T1-Time-Out-Master-↔-Local" class="headerlink" title="04.04.01. T1 Time Out (Master ↔ Local)"></a>04.04.01. T1 Time Out (Master ↔ Local)</h3> <img src="http://photo.wushaopei.com/qiniu295.png" width="80%">

<p>① 将数据输入Word Area 后，本地或主PLC打开Bit Area(事件或命令位) </p>
<p>② 本地或主PLC加载定时器检查超时。(T1:4秒)如果伙伴的响应不存在，则本地或主PLC超时。 </p>
<p>③ 在定时器复位后，关闭连接继电器(事件或命令位)。 </p>
<h3 id="04-04-02-T2-Time-Out-Master-↔-Local"><a href="#04-04-02-T2-Time-Out-Master-↔-Local" class="headerlink" title="04.04.02. T2 Time Out (Master ↔ Local)"></a>04.04.02. T2 Time Out (Master ↔ Local)</h3> <img src="http://photo.wushaopei.com/qiniu296.png" width="80%">

<p>① 将数据读入链路字后（W区），打开链路中继(命令或事件应答Bit区)</p>
<p>② 加载计时器来检查超时 。(T2:2分钟)。如果伙伴的响应不存在，则本地或主PLC进行超时。 </p>
<p>③ 在定时器复位后，关闭连接继电器(事件或命令应答位) </p>
<h3 id="04-04-03-T3-Delay-Time-Master-↔-Local"><a href="#04-04-03-T3-Delay-Time-Master-↔-Local" class="headerlink" title="04.04.03. T3 Delay Time (Master ↔ Local)"></a>04.04.03. T3 Delay Time (Master ↔ Local)</h3>  <img src="http://photo.wushaopei.com/qiniu297.png" width="80%">

<p>① 主PLC关闭Bit Area(事件应答)后，本地PLC等待0.5秒(T3:0.5秒)，然后本地PLC将数据B移动到链路字区，并报告给主PLC </p>
<ul>
<li>EQ厂商提供T3定时器值设定功能。(默认值= 0.5秒) </li>
</ul>
<h3 id="04-04-04-Tn-Time"><a href="#04-04-04-Tn-Time" class="headerlink" title="04.04.04. Tn Time"></a>04.04.04. Tn Time</h3><ul>
<li><p>Event Report Timing Chart (Local to Master) us Bar</p>
<img src="http://photo.wushaopei.com/qiniu298.png" width="80%">

</li>
</ul>
<p>① 将数据设置到链接寄存器(W区)后。本地PLC开启Bit Area(事件位) </p>
<p>② 当数据写入链接寄存器时。Bit Area(事件报告位)必须延迟0.2秒才能打开。Tn定时器的最大值是1秒。 </p>
<h2 id="04-05-Data-Expression"><a href="#04-05-Data-Expression" class="headerlink" title="04.05. Data Expression"></a>04.05. Data Expression</h2><h3 id="04-05-01-ASCII-Type"><a href="#04-05-01-ASCII-Type" class="headerlink" title="04.05.01. ASCII Type"></a>04.05.01. ASCII Type</h3><ul>
<li>使用8位ASCII码。 </li>
<li>用ASCII类型的空白(H20)值填充空值。 </li>
<li>字内字符间顺序:低字节→高字节顺序 </li>
<li>词序:低词序→高词序 </li>
<li>字符和数字数据格式:标准字符格式 </li>
</ul>
<img src="http://photo.wushaopei.com/qiniu299.png" width="80%">

<p><strong>Example：</strong>   </p>
<ul>
<li>Character data：(Ex.) ‘R’ → H2052 </li>
<li>Character data：(Ex.) ‘I1’ → H3149 (H4931 is an error) </li>
<li>Character data：(Ex.) ‘123’ → H3231 2033 </li>
<li>Character data：(Ex.) ‘2AA00101 ‘ → H4132 3041 3130 3130 2020 2020 </li>
</ul>
<h3 id="04-05-02-Numeric-Type"><a href="#04-05-02-Numeric-Type" class="headerlink" title="04.05.02. Numeric Type"></a>04.05.02. Numeric Type</h3><img src="http://photo.wushaopei.com/qiniu621.png" width="80%">

<ul>
<li>In case of signed format, negative value should be described with two’s complement. </li>
<li>The abbreviation = EXP Type, the calculation method reference as blow. <ul>
<li>http：//zh.wikipedia.org/wiki/%E4%BA%8C%E8%A3%9C%E6%95%B8</li>
<li>http：//en.wikipedia.org/wiki/Two’s_complement</li>
</ul>
</li>
</ul>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>自动化开发（四）Specification-03-Terms Definition</title>
    <url>/2020/04/07/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E5%9B%9B%EF%BC%89Specification-03-Terms-Definition/</url>
    <content><![CDATA[<h2 id="03-01-Common-（所有）"><a href="#03-01-Common-（所有）" class="headerlink" title="03.01 Common （所有）"></a><strong>03.01 Common （所有）</strong></h2><h3 id="03-01-01-Job"><a href="#03-01-01-Job" class="headerlink" title="03.01.01 Job"></a>03.01.01 Job</h3><p>​    这项工作意味着对玻璃、切割和切屑等材料进行特定的加工。 </p>
<h4 id="理解："><a href="#理解：" class="headerlink" title="理解："></a>理解：</h4><p>​    所有的玻璃就叫做Job，玻璃分很多种，有大版和切割后的glass、cut和chip等等。</p>
<p>在Array未切割前就是<strong>Glass</strong>；到了CF后会进行切割，切割后就是<strong>cut</strong>（一个glass切成四个中等的板），切割成更小的就是<strong>chip</strong>(一个glass切成8片或16片).</p>
<h3 id="03-01-02-Recipe-ID-制成ID"><a href="#03-01-02-Recipe-ID-制成ID" class="headerlink" title="03.01.02 Recipe ID (制成ID)"></a>03.01.02 Recipe ID (制成ID)</h3><p><strong>举例理解：</strong>  比如现在要生产一个55寸的液晶显示器，那么每一个机台需要使用什么样的制成（包含温度、时间，或者烘烤时间、物料的使用等都包含在Recipe中）。制成的设置是在机台里进行设定的。</p>
<p><strong>Recipe ID 的构成</strong>，这个ID称为配方ID(配方ID由。0<del>9, A</del>Z, A~Z(除:I, O, I, O))和特殊符号:” _ “，空格(ASCII=20)。 </p>
<p><strong>Example：</strong>  </p>
<blockquote>
<p>OK of Recipe Number = PPID_Rec_001 </p>
<p>NG of Recipe Number = PPID@Recipe-O01 ← Can’t use -, @, i,O symbol </p>
<p>NG of Recipe Number = PPID□Rec_001 ← Can’t use □ (space) in middle  </p>
<p>NG of Recipe Number = □PPIDRec_001 ← Can’t use □ (space) in front</p>
</blockquote>
<h3 id="03-01-03-PPID"><a href="#03-01-03-PPID" class="headerlink" title="03.01.03. PPID"></a>03.01.03. PPID</h3><p><strong>PPID</strong>由每个本地配方ID的组合组成，最大字符总长度为ASCII 50个字符。PPID和配方ID关系规则是指设备运行场景。 </p>
<p>(例A1B2C3 ~ ~)</p>
<p><strong>通俗点：</strong> PPID 为线上的每个机台的  Recipe ID 的集合。</p>
<p><strong>示例</strong> ： 当前有三个机台，分别为 Recp_001、Recp_002、Recp_003，那么，他的PPID就是这三个Recipe ID 的集合了。</p>
<h2 id="03-02-Job"><a href="#03-02-Job" class="headerlink" title="03.02. Job"></a>03.02. Job</h2><h3 id="03-02-01-Substrate-Type"><a href="#03-02-01-Substrate-Type" class="headerlink" title="03.02.01. Substrate Type"></a>03.02.01. Substrate Type</h3><p>在从事底层的Job中，它包括4种类型:Glass，cut，chip和Casssette 。</p>
<h3 id="03-02-02-Glass-ID"><a href="#03-02-02-Glass-ID" class="headerlink" title="03.02.02. Glass ID"></a>03.02.02. Glass ID</h3><p>每个Glass有一个Glass ID, Glass ID是唯一的，每一片玻璃只能有一个Glass ID, 全场唯一，以后也不会有重复的。</p>
<p>Glass ID 如果切成小板，则会对每个小板标记为01、02这样的标记作为区分。</p>
<img src="http://photo.wushaopei.com/qiniu270.png" width="80%">

<p>如图所示，假设当前Glass ID 为 glass_A，那么对应的每一块小板为glass_A01、glass_A02、glass_A03这样依次序号进行递增。</p>
<h3 id="03-02-03-Cut-ID"><a href="#03-02-03-Cut-ID" class="headerlink" title="03.02.03. Cut ID"></a>03.02.03. Cut ID</h3><p>​    经过第一次切割操作，玻璃变成了一个多芯片。 </p>
<p>​    即，第一次切割操作的ID。</p>
<img src="http://photo.wushaopei.com/qiniu271.png" width="80%">



<h3 id="03-02-04-Chip-ID"><a href="#03-02-04-Chip-ID" class="headerlink" title="03.02.04. Chip ID"></a>03.02.04. Chip ID</h3><p>经过第二次切割操作后，glass 变成更小的一块，称为chip (它也被称为细胞或面板)。它的ID被称为Chip ID (TFT芯片ID最多由20个字符组成;CF芯片ID最多由20个字符组成)。示例请参考线路运行场景 </p>
<img src="http://photo.wushaopei.com/qiniu272.png" width="80%">



<h3 id="重点："><a href="#重点：" class="headerlink" title="重点："></a>重点：</h3><p>现实生产中很少根据Glass ID 去定位问题。一般都是根据Cassette Sequence NO 和Job Sequeence NO 去定位到一片玻璃和它对应的资料。</p>
<p><strong>DB 数据：</strong>  在DB中进行数据存储时也是根据这两个参数进行存储的。</p>
<h3 id="03-02-05-Cassette-Sequence-No"><a href="#03-02-05-Cassette-Sequence-No" class="headerlink" title="03.02.05. Cassette Sequence No"></a>03.02.05. Cassette Sequence No</h3><p>Cassette Sequence No  代表的是 Cassette 的ID 。每上一个新的 Cassette，就会把 Cassette Sequence 进行加一。最小的是0，当第一个 Cassette 上机后变成 1 ，后面的根据上机的Cassette一次增加 1 。Cassette Sequence No 最高会有一个限定的值，比如1000，当到达这个值时，会从0开始计数。</p>
<h3 id="03-02-06-Job-Sequence-No"><a href="#03-02-06-Job-Sequence-No" class="headerlink" title="03.02.06. Job Sequence No"></a>03.02.06. Job Sequence No</h3><p> Job Sequence 的意思是Cassette 的层数，或者说当前是第几层。</p>
<img src="http://photo.wushaopei.com/qiniu273.png" width="80%">

<p>如上图所示，右边的就是Cassette ，该Cassette 分为两个Slot , 从 Slot1 到 Slot2 ,共有56层（插槽） Slot 1 中是 Job Sequence Number 1<del>28， Slot 2 是 Job Sequence Number 29</del>56。</p>
<p><strong>重点：</strong> 根据 Cassette Sequence No 我们可以知道该片Glass 在哪个Cassette中，根据    Job Sequence Number 我们可以知道该片Glass 在 Cassette中的哪个位置。</p>
<p><code>一个slot 层中只能有一片玻璃。</code></p>
<h3 id="03-02-07-Chip-Position-芯片定位"><a href="#03-02-07-Chip-Position-芯片定位" class="headerlink" title="03.02.07. Chip Position(芯片定位)"></a>03.02.07. Chip Position(芯片定位)</h3><p>它主要是指切割前面板在玻璃中的具体位置。在第一次或第二次切割后，人们可以通过这个值知道每个芯片在玻璃中的原始位置 </p>
<img src="http://photo.wushaopei.com/qiniu275.png" width="80%">

<p>如图中所示，TFT 是Array切割的玻璃，而CF是CF切割的玻璃，最终这两块对应玻璃是会合到一起的。在合到一起后再进行切割。</p>
<p>​    切割之前，需要在Cell厂进行画框，并使用框胶等进行固定。一般切割为16块芯片，这是根据Chip Position来确定切割的数量的。</p>
<img src="http://photo.wushaopei.com/qiniu276.png" width="80%">



<h3 id="03-02-08-Job-Type"><a href="#03-02-08-Job-Type" class="headerlink" title="03.02.08. Job Type"></a>03.02.08. Job Type</h3><p> Job Type 是用来区分 cassette 或 glass 的种类。 它由Normal 、Dummy 等组成。通常，glass 是根据其工作类型来分类的。 </p>
<h3 id="03-02-09-Job-Judge"><a href="#03-02-09-Job-Judge" class="headerlink" title="03.02.09. Job Judge"></a>03.02.09. Job Judge</h3><p>它表示对 Job 信息的判断 .  可能的结果包括： OK, NG, Reject, Rework等。 </p>
<h3 id="03-02-10-OXR-Information"><a href="#03-02-10-OXR-Information" class="headerlink" title="03.02.10. OXR Information"></a>03.02.10. OXR Information</h3><p>OXR信息用于识别每个芯片的判断结果，记录在检测设备中。OXR信息有R, L, O (OK)， X (NG)和F (Down Grade)状态。 </p>
<h3 id="03-02-11-Job-Grade"><a href="#03-02-11-Job-Grade" class="headerlink" title="03.02.11. Job Grade"></a>03.02.11. Job Grade</h3><p>​    等级是用来识别每个玻璃的判定结果，记 录在检验设备上。 </p>
<p>​    等级有OK, NG, RP, PC, MD, CD, ID, DR, RW等</p>
<h3 id="03-02-12-Tracking-Data"><a href="#03-02-12-Tracking-Data" class="headerlink" title="03.02.12. Tracking Data"></a>03.02.12. Tracking Data</h3><p>​    跟踪用于记录玻璃工艺流程的数据，在PLC地图中定义该项目。 </p>
<p>示例： 比如，一条线上有多个相同制成的，如当前线上有两台切割机，功能相同的，而当前的glass只需要经过其中一个切割机。在Tracking Data 中，数据是以二进制进行存储的一串数据。</p>
<p>​    当glass经过左边的切割机时，我们可以给它（切割机）定义一个bit ,就在Tracking Data中写 1 ，如果是右边的切割机就写 0 。</p>
<p>​    这整个操作是有机台告诉我们信息，然后我们来作记录。</p>
<h2 id="03-03-Equipment"><a href="#03-03-Equipment" class="headerlink" title="03.03. Equipment"></a>03.03. Equipment</h2><h3 id="03-03-01-Inline-Mode"><a href="#03-03-01-Inline-Mode" class="headerlink" title="03.03.01. Inline Mode"></a>03.03.01. Inline Mode</h3><p>Inline Mode 分上下游两种，一种是upstream Inline ，另一种是 downstream Inline 。如果Inline的信号都是 on 的情况下，才能实现相互的流片操作。该操作主要是设备之间的。</p>
<p>内联模式仅与作业转移相关，仅在上游设备和下游设备之间必要。 </p>
<p>当有多个接口时，所有的接口都切换成内联关闭来报告BC内联。</p>
<p>​    </p>
<p><code>该Mode 会被上报到BC，并由BC进行记录。</code></p>
<h3 id="03-03-02-CIM-Mode"><a href="#03-03-02-CIM-Mode" class="headerlink" title="03.03.02. CIM Mode"></a>03.03.02. CIM Mode</h3><p>CIM模式是指定设备与BC之间的通信关系。一般情况下，在CIM OFF模式下，本地PLC应该忽略主PLC的命令。 </p>
<p>设备变更CIM模式需要用户账号控制;设备中的玻璃不影响CIM模式的改变。当CIM模式关闭时，需要报告警告，直到CIM模式更改为On，然后重置警告。 </p>
<p>在CIM关闭模式下，设备应保持当前的word数据，并不用更新，不需要将事件位更改为on。 </p>
<p>触摸屏需要在主窗体中显示CIM的开/关状态，在任何页面中都要改变disp的状态。</p>
<p>当CIM模式从CIM关到CIM开时，设备从BC开始调整时间 。</p>
<hr>
<p><strong>通俗点：</strong>  </p>
<p>​    <code>CIM Mode 只有两种状态，不是on 就是 off。 CIM Mode 开的时候，机台一定要把数据报给BC；关的时候，机台要把数据写到Word Area , 但是不 on Bit .</code></p>
<p>​    关于CIM MODE 状态切换的方式：共有两种方式</p>
<p>​    第一种方式，机台可以自己切换 on / off，在机台的 Touch panel 上有相应的切换按钮可以进行切换操作。在切换完成之后会报给BC 。</p>
<p>​    另一种方式，BC 的 OPI 上也会下命令给机台来切 CIM ON  或  CIM OFF .</p>
<h3 id="03-03-03-Equipment-Status"><a href="#03-03-03-Equipment-Status" class="headerlink" title="03.03.03. Equipment Status"></a>03.03.03. Equipment Status</h3><p>Equipment Status 显示设备当前的运行状态。它由Setup, Stop, Pause, Idle and Run构成 .</p>
<p><code>机台变化后，会先把数据写到 Word Area , 然后再把 Bit on 起来。</code></p>
<p>​    各个状态之间的切换是有顺序的，不能直接从 Setup 切换到 Run。</p>
<h3 id="03-03-04-Unit-Status"><a href="#03-03-04-Unit-Status" class="headerlink" title="03.03.04. Unit Status"></a>03.03.04. Unit Status</h3><p> Unit Status 显示单元的当前操作状态。 Unit Status 的类型和定义与 Equipment Status 的类型和定义相同。 </p>
<h3 id="03-03-05-Alarm-Status"><a href="#03-03-05-Alarm-Status" class="headerlink" title="03.03.05. Alarm Status"></a>03.03.05. Alarm Status</h3><p>每个Alarm可以在两种状态之一:设置和清除。如果设备发生警报 ，称为Alarm Set， 一旦警报被cleared ， 然后它被称为警报Clear 。</p>
<h3 id="03-03-06-Alarm-ID"><a href="#03-03-06-Alarm-ID" class="headerlink" title="03.03.06. Alarm ID"></a>03.03.06. Alarm ID</h3><p>Alarm 标识符</p>
<h3 id="03-03-07-Alarm-Level"><a href="#03-03-07-Alarm-Level" class="headerlink" title="03.03.07. Alarm Level"></a>03.03.07. Alarm Level</h3><p>它显示了警报的级别。它由 Warming 和 Error 组成 。  </p>
<p>Warming 只是起到提示作用，而 Error 的出现可能导致宕机。</p>
<h3 id="03-03-08-Processing-Time"><a href="#03-03-08-Processing-Time" class="headerlink" title="03.03.08. Processing Time"></a>03.03.08. Processing Time</h3><p>它是设备或单元中一项工作的实际处理时间。它不包括在上游设备和下游设备之间转移所花费的时间。设备包括工艺数据报告中的这一项。 </p>
<p>工艺时间的计算，由设备供应商要求并与CSOT工程师讨论确认。</p>
<h3 id="03-03-09-VCR-No"><a href="#03-03-09-VCR-No" class="headerlink" title="03.03.09. VCR No."></a>03.03.09. VCR No.</h3><p>VCR No用于区分设备中唯一的VCR。如果只有一台录像机，VCR No始终为’ 1 ‘，其他报告依次为’ 2 ‘、’ 3 ‘、’ 4 ‘…等</p>
<p>VCR No. 是用来扫码的，玻璃上有二维码，二维码记录的是 Glass 的Glass ID, 玻璃经过有VCR 的机台的时候，会在玻璃上固定的点位去扫二维码，读到 Glass ID 和 前面机台带下来的数据进行校验。</p>
<p>如果不一样就会报警。</p>
<p>但有些机台可能会有多个VCR ，所以要使用VCR No. 进行标识。</p>
<h3 id="03-03-10-Ionizer-Fan-No"><a href="#03-03-10-Ionizer-Fan-No" class="headerlink" title="03.03.10. Ionizer-Fan No."></a>03.03.10. Ionizer-Fan No.</h3><p>Ionizer-Fan (I-Fan)没有。用于区分设备中唯一的离子风机。如果只有一个I-Fan, I-Fan No总是“1”。，另一份报告按“2”、“3”、“4”顺序排列。</p>
<p>所有配备离子风扇的必须报告到BC的启用/禁用状态。</p>
<h2 id="03-04-Port"><a href="#03-04-Port" class="headerlink" title="03.04. Port"></a>03.04. Port</h2><h3 id="03-04-01-Port-Type"><a href="#03-04-01-Port-Type" class="headerlink" title="03.04.01. Port Type"></a>03.04.01. Port Type</h3><p>它将根据当前装入的磁带的预期操作对 Port 进行分类端口;在端口上装载的 Cassette 是将作业输入到Inline ，还是输出 Job Inline 后的 Job 在该行中完成其进程，或在临时行中缓冲作业。 </p>
<p>有4种类型:Loading Port, Unloading Port, Both Port and Buffer Port 。</p>
<p>（1） 有玻璃的 Cassette只能上 Loading Port、Both Port（通用，无玻璃的Cassette也能用） </p>
<p>（2） Unloading Port 是用来上空 Cassette 收玻璃用的</p>
<p>（3） Buffer Port 是 Port Type 的安全区，主要设置在整条线的中间或者某个重要制成的前面，用来防止重要制成的塞片。</p>
<p>示例：可能某些制成要做很长时间，而导致前面的玻璃停留很长时间甚至流不动。</p>
<h3 id="03-04-02-Port-Mode"><a href="#03-04-02-Port-Mode" class="headerlink" title="03.04.02. Port Mode"></a>03.04.02. Port Mode</h3><p>它是根据已包含或将在端口上的磁带中排序的作业判断对端口进行分类。 </p>
<h3 id="03-04-03-Port-Transfer-Mode"><a href="#03-04-03-Port-Transfer-Mode" class="headerlink" title="03.04.03. Port Transfer Mode"></a>03.04.03. Port Transfer Mode</h3><p>它表明类型的AMHS机器连接端口在传输磁带到/从端口。 </p>
<h3 id="03-04-04-Port-Enable-Mode"><a href="#03-04-04-Port-Enable-Mode" class="headerlink" title="03.04.04. Port Enable Mode"></a>03.04.04. Port Enable Mode</h3><p>它表示端口是否可以使用。如果端口的这种模式被更改为 “禁用” 模式’，设备不处理的磁带上的端口。操作员可以在设备屏幕上更改其值。</p>
<p>这是Port 的开关，关掉 后，会导致Port 不能用。</p>
<h3 id="03-04-05-Port-Status"><a href="#03-04-05-Port-Status" class="headerlink" title="03.04.05. Port Status"></a>03.04.05. Port Status</h3><p>它是用来表示一个端口是否可用来装载Cassette，或者Cassette装载已完成到一个端口，或者一个端口是否可用来卸载Cassette。 </p>
<p>一般搭配 Cassette Status 一起使用。</p>
<h3 id="03-04-06-Port-Grade"><a href="#03-04-06-Port-Grade" class="headerlink" title="03.04.06. Port Grade"></a>03.04.06. Port Grade</h3><p>Port 等级设置结果报告。检查后，出货标准为玻璃放Cassette</p>
<h3 id="03-04-07-Cassette-Status"><a href="#03-04-07-Cassette-Status" class="headerlink" title="03.04.07. Cassette Status"></a>03.04.07. Cassette Status</h3><p>它指示端口上磁带的处理状态。 </p>
<h3 id="03-04-08-Cassette-ID"><a href="#03-04-08-Cassette-ID" class="headerlink" title="03.04.08. Cassette ID"></a>03.04.08. Cassette ID</h3><p>特定的ID被分配给单独的磁带，称为盒式磁带ID。它可以被读取条形码阅读器(BCR)，可由触摸屏上的特殊操作员进行修改。(磁带ID最多包含10个字符，PP BOX ID最多包含10个字符，密盒ID最多包含10个字符。) </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>转载：别让自己“墙了自己”</title>
    <url>/2020/04/29/%E8%BD%AC%E8%BD%BD%EF%BC%9A%E5%88%AB%E8%AE%A9%E8%87%AA%E5%B7%B1%E2%80%9C%E5%A2%99%E4%BA%86%E8%87%AA%E5%B7%B1%E2%80%9D/</url>
    <content><![CDATA[<p>乘着中午有闲暇，上 coolshell 看了一下耗子哥最近发表的文章，故事生动，也发人深省，故转载之。当然，转载的原因还是因为coolshell 不提供分享的功能，那就只能手动滑稽，百度一番，顺便给 hexo-next 添加分享功能，一举两得。</p>
<img src="http://photo.wushaopei.com/00CE12A3.jpg" width="80%">

<p> 这一两周与几个朋友聊天，有年轻的90后，也有大叔级的70后，这些人在我看来都是很有能力的人，但是一些喜好过于强烈，让我不经意地回顾了我工作20年来身边的人，有发展得好的，也有发展的不好的，有些人是很可惜的，因为限制他们的不是其它人，也不是环境，而是自己，所以，很想写下这篇文章。（注：这篇文章可能会是一篇说教的文章，所以，可能会让你看着犯困，所以，我会尽量地短一些，而且尽可能多讲故事，少道理，这里的故事，全是真实发生的）</p>
<h4 id="几个故事"><a href="#几个故事" class="headerlink" title="几个故事"></a>几个故事</h4><p>2019年年初，我面试了一个很年轻的小伙子（93/94年出生），这个小伙子特别有灵性，也很聪明，计算机专业出身，也很喜欢技术，基础和学习能力也很好。在我这20年来认识的人中，如果他能呆在北京、上海、深圳这样的城市，我保证不出三年，他会成为他们同龄人中非常出色的技术人员，如果有个好的舞台有一个好的团队带他，他的未来会非常成功。然而，这个小伙子有两大喜好：1）只愿（或是说被迫）呆在一个毫无IT的环境的三/四线城市，2）对技术有非常大的偏好，只喜欢Go语言，非常不喜欢其它的语言，比如：Java（离开Java的世界，基本上离开了做架构的世界（<strong>相关解释见文末</strong>））。</p>
<p>他的这两个喜好，足以让一个未来会很优秀的人毁掉，因为，这个时代没有限制他，他的能力也没有限制他，但是他的意识完完全全地限制了他。</p>
<ul>
<li>他把自己最宝贵的青春放在了很烂的项目上，就算能用一些新的技术，他也只能算是自娱自乐，在实验室中玩玩具罢了。</li>
<li>他把自己的技术栈封闭起来，而直接放弃了这个时代最具工业化的技术Java，对于一个好的程序员来说，同时掌握几门语言和技术完全是没什么问题，但是自己封闭了自己的视野。</li>
</ul>
<p>实在是非常可惜，我本来是可以为他介绍到一些很不错的公司的，但是他这样的习性，等于自己把自己未来的门给关上了，虽然我跟他长谈过，但是我也没有办法叫醒不想醒的人……</p>
<ul>
<li>视野、环境和舞台，对一个人的限制是非常大的。井蛙不知道大海，被空间维度所限制；夏虫不知道冬天，是被时间维度所限制；圈养的动物没有斗志，是被自己意识所限制。</li>
<li>偏见和不开放，对一个人的限制是真正有毁灭性的。主动让自己成为一个瞎子和聋子，主动把自己的能力阉割掉，这是一件令人痛心的事。想想大清的闭关锁国是如何让亚洲第一的北洋水师给毁掉的……</li>
</ul>
<p>我还有个同学，他的技术并不差，就算呆在昆明这种很落后的地方，他也非常地好学，学习英文，学习各种新技术，对技术没有任何的偏好，喜欢C/C++/Java/Python/Shell，同样喜欢前端Javascript，对基础知识非常地踏实，他在技术上没有限制自己的潜力，有什么就学什么。后来，我带他玩Docker/Go/K8S……分布式架构，他也上手的很快……像他这样的人，技术能力完全没得说，比我还大一岁，44岁了，还是一样的天天追代码细节，看Youtube的各种大会，翻github里的各种issue和pull  request……</p>
<p>我同学这人，拥有了成为一个技术牛人几乎所有的条件：基础知识过硬，细节扎得深，面很广，学习能力强，有英文能力，逻辑思维能力不错，非常的自律，执行力也很强，抓得住重点……然而，只有一个小问题，就是没有到大公司历练过，我三番五次叫他从昆明出来，但是最终他都呆在昆明这个城市没有出来，因为有所谓的家庭约束。然而，我身边还有好些人，把自己家从北京搬到上海，从上海搬到深圳，从厦门搬到深圳……这样的人大有人在……像他这样的能力，在哪个公司都会是主力和骨干，对于一个公司的主力和骨干来说，家庭上的这些问题都是小问题都是有很多解的……</p>
<p>另外，我这个同学还是一个比较悲观的人，任何事情都是先想到不好的事，他关注负面的东西会胜于正面的东西，而且他还有一定的社交恐惧，怕与人相处和交流，时间越长越害怕，甚至有时候直接跟我说，“我就是不想改变”这样的话……其实，我以前也是一个很害怕与人交流的人，面试的时候，我根本不敢正眼看面试官一眼，也不知道与人怎么交流。但是，我与他不一样，我努力克服，不断地面试，与人面对面的交流，到一线技术客服接用户的电话，在公司里做分享，慢慢地到外面分享……3-5年就完全克服掉了。</p>
<p>其实，很多事情，完全是有解的，也没有必要担心，自己的心理障碍也是可以克服的，重点就是自己愿不愿意，只要愿意完成了一半，接下来就是不断的摸爬滚打坚持了。</p>
<ul>
<li>不限制自己的人，会穷举各种方法来解决问题，限制自己的人，只会找各式各样的问题或借口。</li>
<li>不限制自己的人，会努力改变自己的问题和缺陷，限制自己的人，会放任自己。</li>
</ul>
<h4 id="另外几个故事"><a href="#另外几个故事" class="headerlink" title="另外几个故事"></a>另外几个故事</h4><p>我还有另外几个故事（活到四十多，能看到好多人十几年的发展过程，感觉有点上帝视角了）</p>
<p>我还有一个以前团队里的一个小伙，人是很聪明，但就完全就是野路子，他对技术没有什么偏好，一个PHP程序员，做那个Discuz!论坛，公司被并购了，转成Java，开始研究Java的各种细节，对技术从来没有什么偏见，有什么就玩什么，每做一个项目，就算是一样的他都要用新的技术做一遍，然后跟着我做云计算，我教他TCP，教他C/C++，后来一起玩Docker/Go，等等，反正是一点就通，他是我见过学习能力最强的人。但是，有一个事他一直与我的想法不一样，就是我希望他先把软件设计好，再写代码，他非常不能理解，他习惯于直接动手开干，然后有什么问题就整什么问题，我也很难教育他。</p>
<p>有一天，他电话面了一下Facebook，电话面了15分钟后对方就放弃了，他受到了严重的打击。然后，他就开始找菲利宾人练英文口语了，我也让他做算法题，然后，他才发现，一道连算法都不是的纯编程题都提交几次都过不了，等他做完了Leetcode最初的那151道题后，整个人都改变了，写代码前认认真真地在纸上把程序的状态，处理时序以及可能遇到的一些条件先罗列出来，然后，进行逻辑设计后，再写，从此，他就开启他更大的天地了。我后来把他推荐给了微软，先在中国的Bing，在中国升好2-3级，然后去了美国的Azure，现在听说他准备要跟  k8s 的 co-founder <a href="https://github.com/brendandburns" target="_blank" rel="noopener">Brendan Burns</a> 混了（虽然，他现在还在印度人手下，但是，我真的不知道他未来能玩多大，因为今年他才33岁，而且非常聪明）</p>
<p>他以前是把自己封闭起来的，我叫他出来，他也不出来，后来因为一些办公室政治的原因不得不来找我，于是我就带着他玩了两年，跟他讲了很多外面的世界是怎么玩的，他这个人也是一个相当不善于社交的人，但是心是开放的，愿意接受新的东西，虽然对技术也有一定偏见，比如不喜欢Windows，但是也不会不喜欢到完全封闭。后来我跟他说，微软的技术相当的强的，你看到的技术只是表面，深层次的东西都是相通的，直到他到了微软后发现各种牛逼的东西，对微软系统的技术的态度也有了改变，而且我让他跟我说很多微软那边的事，我发现，他对技术了解的维度已经是越来越高级的了……</p>
<p>还是我以前团队的一个小伙，他是一个前端，他说前端的东西没什么意思，想来找我做后端，我也一点点带他……后来，我说，你如果想要玩得好，你必需来北京，无论现在你觉得过得有多好，你都要放弃掉，然后，尽最大可能出去经历一下世界最顶尖的公司，我甚至跟他说，如果他女朋友不跟来的话，就先分开一段时间，先自己立业，他来北京的时候，他之前的同事都等着看他的笑话，我说，那些人连想都不敢想，不必管他们。于是，他去了Amazon，再过了一年去了西雅图，我跟他说，接下来就是去AWS，然后，如果有足够的野心，用自己的年轻这个资本去硅谷创业公司赌一把……未来他怎么样我不知道，但至少他没有限制自己，他的未来不会有封顶……</p>
<p>也是我的同学，我跟他在大学是上下铺，后来他去了人民大学读计算机博士，大学的时候做国产数据库kingbase，然后去了一家外企，天天被派到用户那边做数据分析，后来，他想回科研单位做国产数据库，我说，别啊，你的技术比我好太多，还有博士理论加持，你不去国外顶尖公司玩玩，你不知道自己有多强的，于是他跟公司申请去了国外做核心，后来因为Hadoop的原因，公司的产品最终成为了历史，于是我说，你来了美国么，你一定要去AWS，于是他就去了AWS的Aurora团队，成为了AWS明星级产品的中坚力量，天天在改MySQL的核心源码，干了两年，正在晋升  Principal Software Engineer ……</p>
<p>这里我到不是说出国有多牛，也许你只关注能挣多少钱，但是我想说，他们之所以能有这样的际遇，除了他们本来就有实力，还更因为他们从来不给自己设制什么限制，就是那种“艺多不压身”，有什么就学什么，有更高的就去向更高的迈进，其它的像家庭什么的问题其实都是会有解的，真的不必担心太多……</p>
<h4 id="别限制了自己"><a href="#别限制了自己" class="headerlink" title="别限制了自己"></a>别限制了自己</h4><p>上面的这些故事，也许你能看得懂，也许你看得不一定能懂，这里，让我来做个总结吧</p>
<ul>
<li><strong>做有价值的事</strong>。这个世界对计算机人才的要求是供不应求的，所以，不要让自己为自己找各式各样的借口，让自己活在“玩玩具”、“搬砖”和“使蛮力加班”的境地。其实，我发现这世界上有能力的人并不少，但是有品味的人的确很少。<strong>所谓的有价值，就是，别人愿付高价的，高技术门槛的，有创造力的，有颠覆性的</strong>……</li>
<li><strong>扩大自己的眼界，开放自己的内心</strong>。人要变得开放，千万不要做一个狭隘的民族主义者，做一个开放的人，把目光放在全人类这个维度，不断地把自己融入到世界上，而不是把自己封闭起来，这里，<strong>你的英文语言能力对你能不能融入世界是起决定性的作用</strong>。开放自己的心态，正视自己的缺点，你才可能往前迈进。<strong>你的视野决定了你的知不知道要去哪，你的开放决定了你想不想去</strong>。</li>
<li><strong>站在更高的维度</strong>。面的维度会超过点的维点，空间的维度会超过面的维度，在更高维度上思考和学习，你会获得更多。<strong>整天在焦虑那些低维度的事（比如自己的薪水、工作的地点、稳不稳定、有没有户口……），只会让你变得越来越平庸，只要你站在更高的维度（比如：   眼界有没有扩大、可能性是不是更多、竞争力是不是更强、能不能解决更大更难的问题、能创造多大的价值……），时间会让你明白那些低维度的东西全都不是事儿</strong>。技术学习上也一样，站在学习编程语法特性的维度和站在学习编程范式、设计模式的维度是两种完全不一样的学习方式。</li>
<li><strong>精于计算得失</strong>。很多人其实不是很懂计算。绝大多数人都是在算计自己会失去多少，而不会算会得到多少。而一般的人也总是在算短期内会失去什么，优秀则总是会算我投入后未来会有什么样的回报，前者在算计今天，目光短浅，而后者则是舍在今天，得在明天，计算的是未来。<strong>精于计算得失的，就懂得什么是投资，不懂的只会投机。对于赚钱，你可以投机，但是对于自己最好还是投资。</strong></li>
<li><strong>勇于跳出传统的束缚</strong>。有时候，跳出传统并不是一件很容易的事，因为大多数人都会对未知有恐惧的心理。比如：我看到很多人才都被大公司垄断了，其实，有能力的人都不需要加入大公司，有能力的人是少数，这些少数的人应该是所有的公司share着用的，这样一来，对于所有的人都是利益最大化的。这样的事现在也有，比如：律师、设计师……。但是，绝大多数有能力的技术人员是不敢走出这步。我在2015年到2016年实践过一年半，有过这些实践，做“鸡”的比“二奶”好多了，收入也好很多很多（不好意思开车了）……</li>
</ul>
<p>庄子说过几句话——</p>
<blockquote>
<p>井蛙不可以语于海者，拘于虚也；//空间局限</p>
<p>夏虫不可以语于冰者，笃于时也；//时间局限</p>
<p>曲士不可以语于道者，束于教也。//认识局限</p>
</blockquote>
<p>别自己墙了自己，人最可悲的就是自己限制自己，想都不敢想，共勉！</p>
<p>————————————————————</p>
<p><strong>注：这篇文章就是要劝大家更为开放，让自己有更多的可能性，能到更高的层次，做更有价值的事，成为更强更好的人……当然，如果你觉得你只想做一个平凡人，也和本文并不冲突……另外你也不要觉得这篇文章是让你要成为一个精英，但你一定要去摸高……这篇文章是告诉你一种面对人生的思考方式，在这种思考方式下，你会有更多的可能性，更大的场景……而不是直接把自己归到“平常人”，把自己“墙”了！</strong></p>
<p>注：我以为用Java适合做架构这事应该是常识了，但是评论中有很多人非常反对这个事。那我解释一下吧：首先，小型的项目用什么语言都行，爱用什么用什么。但是，真正的企业级架构就不一样了，其中并不仅仅只是RESTful   API或RPC，还有各种配套设施和控制系统，比如：应用网关，服务发现、配置中心、健康检查、服务监控、服务治理（熔断、限流、幂等、重试、隔离、事务补偿）、Tracing监控、SOA/ESB、CQRS、EDA……这些东西在非Java的技术栈体系内，很难看到全貌，<strong>Java强大的生态环境，就是让你把注意力放到更高层次的架构和业务上来的</strong>。（千万不要觉得，整几个服务RPC一下，加个缓存，加个队列，就能叫架构，那只是系统集成罢了）</p>
<p>（全文完）</p>
]]></content>
      <categories>
        <category>励志</category>
        <category>鸡汤</category>
      </categories>
      <tags>
        <tag>突破现状</tag>
      </tags>
  </entry>
  <entry>
    <title>集合扩容机制(一)Collection-List</title>
    <url>/2020/03/13/%E9%9B%86%E5%90%88%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6(%E4%B8%80)Collection-List/</url>
    <content><![CDATA[<p>​    Java 中提供了很多的集合类，包括，collection的子接口list、set，以及map等。由于它们的底层构成不同，以及数据的构造为单列、多列、可重复、不可重复，导致其扩容机制也不尽相同。 </p>
<h1 id="List"><a href="#List" class="headerlink" title="List"></a>List</h1><h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a><strong>ArrayList</strong></h2><p>案例： 获取ArrayList 容量大小的方法： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getArrayListCapacity</span><span class="params">(ArrayList&lt;?&gt; arrayList)</span> </span>&#123;</span><br><span class="line">	Class&lt;ArrayList&gt; arrayListClass = ArrayList<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Field field = arrayListClass.getDeclaredField(<span class="string">"elementData"</span>);</span><br><span class="line">		field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">		Object[] objects = (Object[])field.get(arrayList);</span><br><span class="line">		<span class="keyword">return</span> objects.length;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ArrayList以数组的形式存储。ArrayList中与容量有关的构造器有两个，<strong>代码如下：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs an empty list with an initial capacity of ten.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由以上代码可知，ArrayList 的容量扩容包含有 ArrayList(int initialCapacity) ，另一个则是 ArrayList() ；</p>
<p>第一个构造器在初始创建时以形参将容量大小进行定义，由外部自定义；第二个构造器没有传入参数，使用默认初始化的容量大小；<strong>详细解析如下：</strong></p>
<p><strong>第一个有参构造器：自定长度在后面，这里先看无参有默认容量长度的构造器怎么实现的扩容？</strong></p>
<p><strong>第二个无参构造器：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs an empty list with an initial capacity of ten.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代码测试：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">catapicity</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	objects.add(<span class="string">"a"</span>);</span><br><span class="line">	objects.add(<span class="string">"b"</span>);</span><br><span class="line">	objects.add(<span class="string">"c"</span>);</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 增加一个值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">9</span> ; i ++ )&#123;</span><br><span class="line">		objects.add(i);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line">	<span class="comment">// 增加一个值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10</span> ; i &lt;<span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">		objects.add(i);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line">	<span class="comment">// 增加一个值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">15</span> ; i &lt; <span class="number">20</span> ; i ++ )&#123;</span><br><span class="line">		objects.add(i);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line"></span><br><span class="line">	objects.add(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">	System.out.println(objects.size() + <span class="string">" "</span> + getArrayListCapacity(objects));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在上述单元测试中，创建了一个无参构造的ArrayList 集合，并对其进行元素的添加，以满足对元素添加过程中容量大小的扩张规则。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">长度:  <span class="number">3</span> 容量： <span class="number">10</span></span><br><span class="line">长度:  <span class="number">12</span> 容量： <span class="number">15</span></span><br><span class="line">长度:  <span class="number">17</span> 容量： <span class="number">22</span></span><br><span class="line">长度:  <span class="number">22</span> 容量： <span class="number">22</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">29</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">35.260</span>  INFO <span class="number">28488</span> --- [       Thread-<span class="number">2</span>] o.s.w.c.s</span><br></pre></td></tr></table></figure>

<p><strong>上述是单元测试结果，在这里做一番分析：</strong></p>
<p>在以上的代码中，默认使用ArrayList的初始化容量长度，在ArrayList中，默认初始化容量是 10 ,</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Default initial capacity.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>从测试结果可以看到，当元素的长度为3时，其容量为默认的值 10 ； 当添加的元素超过初始容量后，即 12 &gt; 10  时，集合进行了自动扩容，添加每一个元素都会调用  ensureCapacityInternal(int minCapacity)  方法，在该方法中比较长度是否达到当前容量的边缘，将比较的结果 覆盖原来的 minCapacity 参数，该值用于保存当前的容器元素长度；如单元测试中，当元素个数超过默认的 值 10 时，会调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);</span><br></pre></td></tr></table></figure>

<p>方法，并接着调用  <code>ensureExplicitCapacity(minCapacity);</code>方法，该方法会对当前集合长度与最大容量值进行比较，并调用 <code>grow(minCapacity)</code> 方法进行位移扩容： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现ArrayList 集合扩容的代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Increases the capacity to ensure that it can hold at least the</span></span><br><span class="line"><span class="comment">  * number of elements specified by the minimum capacity argument.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> minCapacity the desired minimum capacity</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// overflow-conscious code</span></span><br><span class="line">     <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">     <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">     <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">         newCapacity = minCapacity;</span><br><span class="line">     <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">         newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">     <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">     elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在集合长度超过初始值或当前最大值时，在   <strong>grow(int minCapacity)</strong> 方法中，进行了扩容，该扩容如代码所示， 声明当前集合的最大容量为 <strong>oldCapacity</strong> ， 新增的长度为 <strong>oldCapacity</strong> 右位移一位数，当容量为 10 时，二进制为  “<strong>8020</strong>” &gt;&gt; 1 右移后为 “<strong>0401</strong>” ，十进制值为 <strong>5</strong> ，此时将 <strong>oldCapacity</strong> + 位移后的值 即   <strong>10 + 5 = 15</strong> 。 </p>
<p>此时完成扩容，<strong>newCapacity  = 15</strong> 就是 ArrayList 扩容后的最新容量大小。</p>
<p>根据扩容规则可知，容量的递增可预计为  <strong>0 、10、15、22、33、49</strong>，以此类推。</p>
<p>注意： <strong>这里对新的容量 newCapacity 和 当前元素长度进行比较，如果元素添加的比较多，超过当次位移扩容的容量大小，则会 直接使用  hugeCapacity 方法进行扩容，</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">      <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">          Integer.MAX_VALUE :</span><br><span class="line">          MAX_ARRAY_SIZE;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>第一个有参构造器：</strong> </p>
<p><strong>单元测试：</strong></p>
<p><strong>① 当声明的容量小于默认初始值10 时，会在超过初始容量10 后进行扩容，</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">catapicity</span><span class="params">()</span></span>&#123;</span><br><span class="line">		ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">		objects.add(<span class="string">"a"</span>);</span><br><span class="line">		objects.add(<span class="string">"b"</span>);</span><br><span class="line">		objects.add(<span class="string">"c"</span>);</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">2</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">3</span>; i &lt;<span class="number">5</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">6</span> ; i &lt; <span class="number">10</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">长度:  <span class="number">3</span> 容量： <span class="number">5</span></span><br><span class="line">长度:  <span class="number">5</span> 容量： <span class="number">5</span></span><br><span class="line">长度:  <span class="number">7</span> 容量： <span class="number">7</span></span><br><span class="line">长度:  <span class="number">11</span> 容量： <span class="number">15</span></span><br><span class="line">长度:  <span class="number">15</span> 容量： <span class="number">15</span></span><br><span class="line">长度:  <span class="number">19</span> 容量： <span class="number">22</span></span><br></pre></td></tr></table></figure>

<p><strong>②超过初始化容量的元素增加：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">catapicity</span><span class="params">()</span></span>&#123;</span><br><span class="line">		ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">13</span>);</span><br><span class="line"><span class="comment">//		objects.add("a");</span></span><br><span class="line"><span class="comment">//		objects.add("b");</span></span><br><span class="line"><span class="comment">//		objects.add("c");</span></span><br><span class="line"><span class="comment">//		System.out.println("长度:  "+objects.size() + " 容量： " + getArrayListCapacity(objects));</span></span><br><span class="line"> </span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">3</span>; i &lt;<span class="number">5</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="comment">// 增加一个值</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">6</span> ; i &lt; <span class="number">10</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">11</span> ; i &lt; <span class="number">15</span> ; i ++ )&#123;</span><br><span class="line">			objects.add(i);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"长度:  "</span>+objects.size() + <span class="string">" 容量： "</span> + getArrayListCapacity(objects));</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">长度:  15 容量： 19</span><br><span class="line">长度:  17 容量： 19</span><br><span class="line">长度:  21 容量： 28</span><br><span class="line">长度:  25 容量： 28</span><br><span class="line">长度:  29 容量： 42</span><br></pre></td></tr></table></figure>

<p>超过初试容量后，<strong>第一次扩容</strong>会直接使用当前集合长度作为 <strong>oldCapacity</strong> 进行扩容</p>
<h2 id="2、LinkedList"><a href="#2、LinkedList" class="headerlink" title="2、LinkedList"></a><strong>2、LinkedList</strong></h2><p>链表结构，且是是双向链表， 不涉及扩容的问题。</p>
<h2 id="3、Vector"><a href="#3、Vector" class="headerlink" title="3、Vector"></a><strong>3、Vector</strong></h2><p>Vector与ArrayList一样，是存储在数组结构中。  与扩容机制相关的构造器有三个,分别是</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Vector(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> capacityIncrement)，</span><br><span class="line">Vector(<span class="keyword">int</span> initialCapacity)</span><br><span class="line">Vector()</span><br></pre></td></tr></table></figure>

<p>  其实这后两个最终都是调用了第一个构造器，不过是使用了不同的默认参数，initialCapacity是初始容量，默认是10，capacityIncrement 是每次扩容时候的递增数量，如果该数值不等于0则每次扩容的时候是原来的二倍，如果该数值大于0，则每次增长的数量等于该数值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> newCapacity = oldCapacity + ((capacityIncrement &gt; <span class="number">0</span>) ?</span><br><span class="line">                                 capacityIncrement : oldCapacity);</span><br><span class="line">）。</span><br></pre></td></tr></table></figure>

<p><strong>比如：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Vector&lt;String&gt; v = <span class="keyword">new</span> Vector&lt;String&gt;(); <span class="comment">// 10 20 ,40 80 ，160，320 的速度递增</span></span><br><span class="line"></span><br><span class="line">Vector&lt;String&gt; v2 = <span class="keyword">new</span> Vector&lt;&gt;(<span class="number">5</span>,<span class="number">3</span>);<span class="comment">// 5 8 11 14 17 ，20，23 的速度递增。</span></span><br></pre></td></tr></table></figure>

<p>他的加载因子也是10</p>
<h2 id="4、Stack"><a href="#4、Stack" class="headerlink" title="4、Stack"></a><strong>4、Stack</strong></h2><p>  继承于Vector，所以他的扩容机制等同于Vector的默认情况，也就是2倍速度扩容，加载因子为1</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>容器-集合</category>
      </categories>
      <tags>
        <tag>集合 扩容机制 List</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化开发（八）Specification-笔记</title>
    <url>/2020/04/13/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E5%85%AB%EF%BC%89Specification-%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="1、EQP-Event-Report-Timing-Chart"><a href="#1、EQP-Event-Report-Timing-Chart" class="headerlink" title="1、EQP Event Report Timing Chart"></a>1、EQP Event Report Timing Chart</h2><h3 id="1-1、EQP-Event-Report-Timing-Chart-（设备上报）"><a href="#1-1、EQP-Event-Report-Timing-Chart-（设备上报）" class="headerlink" title="1.1、EQP Event Report Timing Chart （设备上报）"></a>1.1、EQP Event Report Timing Chart （设备上报）</h3><img src="http://photo.wushaopei.com/qiniu277.png" width="80%">

<p>如图，是机台报到BC 的流程。</p>
<p>第一步，Local 会先写Word Area ，然后Bit on  起来。</p>
<p>第二步，BC 监测到Local 的BIT  on 起来后，会在对应的Word 去读取数据（Data Reading)，读取完数据后会进行处理。处理完成好，会进行 Reply  on 起来回复。</p>
<p>第三步，机台收到回复后，机台的 Event Report 会 off 。BC 收到机台的 off 后，BC的 Event Report Reply 也会 off.</p>
<h3 id="1-2、Request-Timing-Chart-Local-to-Master-（设备请求）"><a href="#1-2、Request-Timing-Chart-Local-to-Master-（设备请求）" class="headerlink" title="1.2、Request Timing Chart (Local to Master)（设备请求）"></a>1.2、Request Timing Chart (Local to Master)（设备请求）</h3><img src="http://photo.wushaopei.com/qiniu292.png" width="80%">

<p><strong>流程：</strong> </p>
<p>① 机台将数据写入到W区，也就是Data中，然后Bit Area on 起来</p>
<p>② BC 收到机台 on 起来的消息，会先去读 机台的 W区；并进行逻辑运算、数据处理，将处理结果写入BC的 W区（Return Code）,然后Bit 也 on 起来</p>
<p>③ 机台收到BC on 起来的消息，就去读BC的 W Area ，读取完成后就将Bit  off</p>
<p>④ BC 收到 机台 Bit Are off ,也进行 off。</p>
<h3 id="1-3-Consecutive-Event-Report-Timing-Chart-Local-to-Master-（连续上报事件）"><a href="#1-3-Consecutive-Event-Report-Timing-Chart-Local-to-Master-（连续上报事件）" class="headerlink" title="1.3 Consecutive Event Report Timing Chart (Local to Master) （连续上报事件）"></a>1.3 Consecutive Event Report Timing Chart (Local to Master) （连续上报事件）</h3><img src="http://photo.wushaopei.com/qiniu293.png" width="80%">

<p>​        当本地PLC有多个连续数据要使用一个事件位(如Alarm或Job)报告给主PLC时，上述时序图指定了数据报告事件的过程。</p>
<p>① 如果本地PLC有数据(命名数据A)要报告给主PLC，则在缓冲区中设置数据A </p>
<p>② 如果本地PLC目前没有其他先前的数据报告给主PLC，则移动数据到缓冲区中设置一个连接寄存器区域并报告给主PLC。</p>
<p>③ 如果本地PLC有新的数据(命名数据B)报告给主PLC，本地PLC在缓冲区中设置数据B。如果此时有之前的数据(即数据A)正在报告给master，本地PLC等待，直到数据报告过程结束</p>
<p>④ 主PLC关闭Bit Area(事件应答)后，本地PLC等待0.5秒(T3:0.5秒)，然后本地PLC将数据B移动到链路字区，并报告给主PLC </p>
<ul>
<li>EQ厂商提供T3定时器值设定功能。(默认值= 0.5秒) </li>
</ul>
<h2 id="2-BC-Command-Reply-Timing-Chart"><a href="#2-BC-Command-Reply-Timing-Chart" class="headerlink" title="2.  BC Command Reply Timing Chart"></a>2.  BC Command Reply Timing Chart</h2><h3 id="2-1-BC-Command-Timing-Chart-Master-to-Local"><a href="#2-1-BC-Command-Timing-Chart-Master-to-Local" class="headerlink" title="2.1. BC Command Timing Chart (Master to Local)"></a>2.1. BC Command Timing Chart (Master to Local)</h3><img src="http://photo.wushaopei.com/qiniu294.png" width="80%">

<p>①将数据设置到主PLC的Word Area 区域后，主PLC再打开Bit Area(命令) </p>
<p>②主PLC加载定时器检查超时。(T1: 4秒) </p>
<p>③本地PLC读取主区域的数据。读取后，本地PLC打开本地PLC的Bit Area(命令应答) </p>
<p>④主PLC在命令应答时关闭Bit Area(命令)。如果在T1超时内本地PLC没有打开应答位，则主PLC处理错误例程 </p>
<p>⑤本地PLC关闭Bit Area(命令应答)，定时器复位后。本地PLC在T2时间内扫描主PLC的Bit Area。如果超时(T2)发生，本地PLC处理错误例程。 </p>
<ul>
<li>EQ厂商提供T2定时器数值设定功能。(默认值= 2秒) </li>
</ul>
<h2 id="TimeOut"><a href="#TimeOut" class="headerlink" title="TimeOut"></a>TimeOut</h2><h3 id="T1-Time-Out-Master-↔-Local"><a href="#T1-Time-Out-Master-↔-Local" class="headerlink" title="T1 Time Out (Master ↔ Local)"></a>T1 Time Out (Master ↔ Local)</h3> <img src="http://photo.wushaopei.com/qiniu295.png" width="80%">

<p>① 将数据输入Word Area 后，本地或主PLC打开Bit Area(事件或命令位) </p>
<p>② 本地或主PLC加载定时器检查超时。(T1:4秒)如果伙伴的响应不存在，则本地或主PLC超时。 </p>
<p>③ 在定时器复位后，关闭连接继电器(事件或命令位)。 </p>
<h3 id="T2-Time-Out-Master-↔-Local"><a href="#T2-Time-Out-Master-↔-Local" class="headerlink" title="T2 Time Out (Master ↔ Local)"></a>T2 Time Out (Master ↔ Local)</h3> <img src="http://photo.wushaopei.com/qiniu296.png" width="80%">

<p>① 将数据读入链路字后（W区），打开链路中继(命令或事件应答Bit区)</p>
<p>② 加载计时器来检查超时 。(T2:2秒)。如果伙伴的响应不存在，则本地或主PLC进行超时。 </p>
<p>③ 在定时器复位后，关闭连接继电器(事件或命令应答位) </p>
<h3 id="T3-Delay-Time-Master-↔-Local"><a href="#T3-Delay-Time-Master-↔-Local" class="headerlink" title="T3 Delay Time (Master ↔ Local)"></a>T3 Delay Time (Master ↔ Local)</h3>  <img src="http://photo.wushaopei.com/qiniu297.png" width="80%">

<p>① 主PLC关闭Bit Area(事件应答)后，本地PLC等待0.5秒(T3:0.5秒)，然后本地PLC将数据B移动到链路字区，并报告给主PLC </p>
<ul>
<li>EQ厂商提供T3定时器值设定功能。(默认值= 0.5秒) </li>
</ul>
<h3 id="Tn-Time"><a href="#Tn-Time" class="headerlink" title="Tn Time"></a>Tn Time</h3><ul>
<li><p>Event Report Timing Chart (Local to Master) us Bar</p>
<img src="http://photo.wushaopei.com/qiniu298.png" width="80%">

</li>
</ul>
<p>① 将数据设置到 W 区(W区)后。本地PLC开启Bit Area(事件位) </p>
<p>② 当数据写入 W 区时。Bit Area(事件报告位)必须延迟0.2秒才能打开。Tn定时器的最大值是1秒。 </p>
<hr>
<h3 id="上卡流程："><a href="#上卡流程：" class="headerlink" title="上卡流程："></a>上卡流程：</h3><img src="http://photo.wushaopei.com/qiniu549.png" width="80%">

<p>在没有 Cassette 的时候， Port 会启动并发出请求。</p>
<p>1、没Cassette时（No Cassette Exist），port发送请求命令要一个卡夹（Load Request）；</p>
<p>2、拿到卡夹后（Load Complete），等待BC校验卡夹数据（Wait For Cassette Data）；</p>
<p>3、BC校验数据成功时，BC发送消息给设备（Cassette Map Data Download Complete）；</p>
<p>4、设备等待开始（Wait For Start Command）；</p>
<p>5、BC发送启动命令给设备（Start Command），设备等待制程（Waiting For Processing）；</p>
<p>6、BC给设备下开始命令（Process Start）设备正在制程（In Processing）；</p>
<p>7、正常制成 （Normal Complete），设备制程完成（Process Complete）；</p>
<p>8、等待T5 Time时间（1-8秒），port请求发送退卡指令（Unload Request）；</p>
<p>9、退卡完成（Unload Complete）</p>
<hr>
<hr>
<img src="http://photo.wushaopei.com/qiniu655.png" width="90%">

<blockquote>
<h3 id="当设备状态由Idle-变为-Setup的时候-设备会触发哪些事件上报给BC"><a href="#当设备状态由Idle-变为-Setup的时候-设备会触发哪些事件上报给BC" class="headerlink" title="当设备状态由Idle 变为 Setup的时候 设备会触发哪些事件上报给BC"></a>当设备状态由Idle 变为 Setup的时候 设备会触发哪些事件上报给BC</h3><p>如果设备状态改变为 setup，设备应提前报警.  上报： AlarmStatusChangeReport:报警状态上报。</p>
<h3 id="设备超过-no-processing-time-时间，会发生什么？"><a href="#设备超过-no-processing-time-时间，会发生什么？" class="headerlink" title="设备超过  no processing time 时间，会发生什么？"></a>设备超过  no processing time 时间，会发生什么？</h3><p>设备是空转时，如果设备超过 no processing time 时间，则设备应报告 Idle。(无处理时间=0:不检查无处理时间)(默认值:Tact Time * 2) </p>
<p>Tack Time:  设备上片到出片的时间为一次 Tack Time.</p>
<h3 id="请简述Send-Wait-Time-Out-Report功能逻辑"><a href="#请简述Send-Wait-Time-Out-Report功能逻辑" class="headerlink" title="请简述Send Wait Time Out Report功能逻辑"></a>请简述Send Wait Time Out Report功能逻辑</h3><p>​    当上游设备将玻璃转移到下游设备，但下游设备没有开始接收上游设备的玻璃，当超过发送等待计时时间，则上游设备需要向BC报告此事件。</p>
</blockquote>
<hr>
<h3 id="一个设备有哪些-Common-Event，并对各个Event做简单功能说明"><a href="#一个设备有哪些-Common-Event，并对各个Event做简单功能说明" class="headerlink" title="一个设备有哪些 Common Event，并对各个Event做简单功能说明"></a>一个设备有哪些 Common Event，并对各个Event做简单功能说明</h3><img src="http://photo.wushaopei.com/qiniu656.png" width="90%">

<p>如上图，不限于上图中的数量；</p>
<blockquote>
<p><strong>设备间进出</strong> </p>
<ul>
<li><strong>Receive Job Data Event</strong>         当设备从上游设备接收作业时，应报告此事件</li>
<li><strong>Send Out Job Data Event</strong>       当设备向下游设备发送作业时，应报告此事件。</li>
</ul>
<p><strong>设备内部 unit 进出</strong></p>
<ul>
<li><strong>Store Job Data Event</strong>         当设备将 Job 存储到一个unit 或 cassette 时，应使用 port 和 unit ID 报告此事件。</li>
<li><strong>Fetch Out Job Data Event</strong>    当 EQP 从一个 unit 或 cassette 中取出 Job 时，应使用 Port 和 unit ID 报告该 Event 。</li>
</ul>
<p><strong>其他操作</strong></p>
<ul>
<li><strong>Remove Job Event Mode</strong>    当 Job Data 刚刚从 EQP 中删除时，将报告已删除 Job的 Job Data .</li>
<li><strong>Job Count Report</strong>               实时操作，作业计数是报告整个设备的作业计数(不包括卡带)。</li>
</ul>
<p>常用的 参数： </p>
<ul>
<li>Unit or Port：用于区分从单元或端口取出的产品。 </li>
<li>Unit No： 单元的单元号。如果设备有槽位，设备应更新槽位号</li>
<li>Port No： 工作取的磁带的端口号。设备应更新槽位号。</li>
<li>Slot No： Slot No. 如果单位没有槽位，这个项目应该被清除。</li>
</ul>
</blockquote>
<hr>
<img src="http://photo.wushaopei.com/qiniu657.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu658.png" width="90%">

<hr>
<img src="http://photo.wushaopei.com/qiniu659.png" width="90%">

<blockquote>
<h3 id="请简述CIM-Message功能与设备相关的操作联动"><a href="#请简述CIM-Message功能与设备相关的操作联动" class="headerlink" title="请简述CIM Message功能与设备相关的操作联动"></a>请简述CIM Message功能与设备相关的操作联动</h3><p><strong>声明：</strong>CIM报文用于通知特定设备的操作员特定信息。当接收到CIM报文时，设备必须将其显示给操作员，并在本地保存历史数据。 </p>
<ul>
<li>CIM Message Set Command：往设备发一条消息，然后显示。</li>
<li>CIM Message Clear Command：发消息后，让设备把发送的消息清除</li>
<li>CIM Message Confirm Report：发消息后向设备手动确认</li>
<li>Display Least 5 CIM Message：屏幕显示5个Message</li>
<li>Display Least 20 History CIM Message：至少保留20条历史记录的Message</li>
</ul>
</blockquote>
]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>04.深入浅出索引（上）</title>
    <url>/2020/04/23/04-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%B4%A2%E5%BC%95%EF%BC%88%E4%B8%8A%EF%BC%89/</url>
    <content><![CDATA[<!DOCTYPE html>
<html>

  <body>
      <div id=app>
                     <div data-v-87ffcada="" class="article"> 
                      <div data-v-87ffcada="" class="main main-app"> 
                       <div data-v-87ffcada="" class="breadcrumb breadcrumb pd"> 
                       </div> 
                       <h1 data-v-87ffcada="" class="article-title pd"> 04 | 深入浅出索引（上） </h1> 
                       <div data-v-87ffcada="" class="article-info pd"> 
                        <span data-v-87ffcada="">2018-11-21</span> 
                        <span data-v-87ffcada="">林晓斌</span>
                       </div> 
                       <div data-v-87ffcada="" class="article-content typo common-content pd"> 
                        <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/a6/d6/a60c994bf629abe46076f77db6ff24d6.jpg" /> 
                        <div data-v-87ffcada="" id="article-content" class="">
                         <div class="text"> 
                             <p>提到数据库索引，我想你并不陌生，在日常工作中会经常接触到。比如某一个SQL查询比较慢，分析完原因之后，你可能就会说“给某个字段加个索引吧”之类的解决方案。但到底什么是索引，索引又是如何工作的呢？今天就让我们一起来聊聊这个话题吧。</p><p>数据库索引的内容比较多，我分成了上下两篇文章。索引是数据库系统里面最重要的概念之一，所以我希望你能够耐心看完。在后面的实战文章中，我也会经常引用这两篇文章中提到的知识点，加深你对数据库索引的理解。</p><p>一句话简单来说，<span class="orange">索引的出现其实就是为了提高数据查询的效率，就像书的目录一样。</span>一本500页的书，如果你想快速找到其中的某一个知识点，在不借助目录的情况下，那我估计你可得找一会儿。同样，对于数据库的表而言，索引其实就是它的“目录”。</p><h1>索引的常见模型</h1><p>索引的出现是为了提高查询效率，但是实现索引的方式却有很多种，所以这里也就引入了索引模型的概念。可以用于提高读写效率的数据结构很多，这里我先给你介绍三种常见、也比较简单的数据结构，它们分别是哈希表、有序数组和搜索树。</p><p>下面我主要从使用的角度，为你简单分析一下这三种模型的区别。</p><p>哈希表是一种以键-值（key-value）存储数据的结构，我们只要输入待查找的值即key，就可以找到其对应的值即Value。哈希的思路很简单，把值放在数组里，用一个哈希函数把key换算成一个确定的位置，然后把value放在数组的这个位置。</p><!-- [[[read_end]]] --><p>不可避免地，多个key值经过哈希函数的换算，会出现同一个值的情况。处理这种情况的一种方法是，拉出一个链表。</p><p>假设，你现在维护着一个身份证信息和姓名的表，需要根据身份证号查找对应的名字，这时对应的哈希索引的示意图如下所示：</p><p><img src="https://static001.geekbang.org/resource/image/0c/57/0c62b601afda86fe5d0fe57346ace957.png" alt=""></p><center><span class="reference">图1 哈希表示意图</span></center><p>图中，User2和User4根据身份证号算出来的值都是N，但没关系，后面还跟了一个链表。假设，这时候你要查ID_card_n2对应的名字是什么，处理步骤就是：首先，将ID_card_n2通过哈希函数算出N；然后，按顺序遍历，找到User2。</p><p>需要注意的是，图中四个ID_card_n的值并不是递增的，这样做的好处是增加新的User时速度会很快，只需要往后追加。但缺点是，因为不是有序的，所以哈希索引做区间查询的速度是很慢的。</p><p>你可以设想下，如果你现在要找身份证号在[ID_card_X, ID_card_Y]这个区间的所有用户，就必须全部扫描一遍了。</p><p>所以，<strong>哈希表这种结构适用于只有等值查询的场景</strong>，比如Memcached及其他一些NoSQL引擎。</p><p>而<strong>有序数组在等值查询和范围查询场景中的性能就都非常优秀</strong>。还是上面这个根据身份证号查名字的例子，如果我们使用有序数组来实现的话，示意图如下所示：</p><p><img src="https://static001.geekbang.org/resource/image/bf/49/bfc907a92f99cadf5493cf0afac9ca49.png" alt=""></p><center><span class="reference">图2 有序数组示意图</span></center><p>这里我们假设身份证号没有重复，这个数组就是按照身份证号递增的顺序保存的。这时候如果你要查ID_card_n2对应的名字，用二分法就可以快速得到，这个时间复杂度是O(log(N))。</p><p>同时很显然，这个索引结构支持范围查询。你要查身份证号在[ID_card_X, ID_card_Y]区间的User，可以先用二分法找到ID_card_X（如果不存在ID_card_X，就找到大于ID_card_X的第一个User），然后向右遍历，直到查到第一个大于ID_card_Y的身份证号，退出循环。</p><p>如果仅仅看查询效率，有序数组就是最好的数据结构了。但是，在需要更新数据的时候就麻烦了，你往中间插入一个记录就必须得挪动后面所有的记录，成本太高。</p><p>所以，<strong>有序数组索引只适用于静态存储引擎</strong>，比如你要保存的是2017年某个城市的所有人口信息，这类不会再修改的数据。</p><p>二叉搜索树也是课本里的经典数据结构了。还是上面根据身份证号查名字的例子，如果我们用二叉搜索树来实现的话，示意图如下所示：</p><p><img src="https://static001.geekbang.org/resource/image/04/68/04fb9d24065635a6a637c25ba9ddde68.png" alt=""></p><center><span class="reference">图3 二叉搜索树示意图</span></center><p>二叉搜索树的特点是：每个节点的左儿子小于父节点，父节点又小于右儿子。这样如果你要查ID_card_n2的话，按照图中的搜索顺序就是按照UserA -&gt; UserC -&gt; UserF -&gt; User2这个路径得到。这个时间复杂度是O(log(N))。</p><p>当然为了维持O(log(N))的查询复杂度，你就需要保持这棵树是平衡二叉树。为了做这个保证，更新的时间复杂度也是O(log(N))。</p><p>树可以有二叉，也可以有多叉。多叉树就是每个节点有多个儿子，儿子之间的大小保证从左到右递增。二叉树是搜索效率最高的，但是实际上大多数的数据库存储却并不使用二叉树。其原因是，索引不止存在内存中，还要写到磁盘上。</p><p>你可以想象一下一棵100万节点的平衡二叉树，树高20。一次查询可能需要访问20个数据块。在机械硬盘时代，从磁盘随机读一个数据块需要10 ms左右的寻址时间。也就是说，对于一个100万行的表，如果使用二叉树来存储，单独访问一个行可能需要20个10 ms的时间，这个查询可真够慢的。</p><p>为了让一个查询尽量少地读磁盘，就必须让查询过程访问尽量少的数据块。那么，我们就不应该使用二叉树，而是要使用“N叉”树。这里，“N叉”树中的“N”取决于数据块的大小。</p><p>以InnoDB的一个整数字段索引为例，这个N差不多是1200。这棵树高是4的时候，就可以存1200的3次方个值，这已经17亿了。考虑到树根的数据块总是在内存中的，一个10亿行的表上一个整数字段的索引，查找一个值最多只需要访问3次磁盘。其实，树的第二层也有很大概率在内存中，那么访问磁盘的平均次数就更少了。</p><p>N叉树由于在读写上的性能优点，以及适配磁盘的访问模式，已经被广泛应用在数据库引擎中了。</p><p>不管是哈希还是有序数组，或者N叉树，它们都是不断迭代、不断优化的产物或者解决方案。数据库技术发展到今天，跳表、LSM树等数据结构也被用于引擎设计中，这里我就不再一一展开了。</p><p>你心里要有个概念，数据库底层存储的核心就是基于这些数据模型的。每碰到一个新数据库，我们需要先关注它的数据模型，这样才能从理论上分析出这个数据库的适用场景。</p><p>截止到这里，我用了半篇文章的篇幅和你介绍了不同的数据结构，以及它们的适用场景，你可能会觉得有些枯燥。但是，我建议你还是要多花一些时间来理解这部分内容，毕竟这是数据库处理数据的核心概念之一，在分析问题的时候会经常用到。当你理解了索引的模型后，就会发现在分析问题的时候会有一个更清晰的视角，体会到引擎设计的精妙之处。</p><p>现在，我们一起进入相对偏实战的内容吧。</p><p>在MySQL中，索引是在存储引擎层实现的，所以并没有统一的索引标准，即不同存储引擎的索引的工作方式并不一样。而即使多个存储引擎支持同一种类型的索引，其底层的实现也可能不同。由于InnoDB存储引擎在MySQL数据库中使用最为广泛，所以下面我就以InnoDB为例，和你分析一下其中的索引模型。</p><h1>InnoDB 的索引模型</h1><p>在InnoDB中，表都是根据主键顺序以索引的形式存放的，这种存储方式的表称为索引组织表。又因为前面我们提到的，InnoDB使用了B+树索引模型，所以数据都是存储在B+树中的。</p><p>每一个索引在InnoDB里面对应一棵B+树。</p><p>假设，我们有一个主键列为ID的表，表中有字段k，并且在k上有索引。</p><p>这个表的建表语句是：</p><pre><code>mysql&gt; create table T(
id int primary key, 
k int not null, 
name varchar(16),
index (k))engine=InnoDB;
</code></pre><p>表中R1~R5的(ID,k)值分别为(100,1)、(200,2)、(300,3)、(500,5)和(600,6)，两棵树的示例示意图如下。</p><p><img src="https://static001.geekbang.org/resource/image/dc/8d/dcda101051f28502bd5c4402b292e38d.png" alt=""></p><center><span class="reference">图4 InnoDB的索引组织结构</span></center><p>从图中不难看出，根据叶子节点的内容，索引类型分为主键索引和非主键索引。</p><p>主键索引的叶子节点存的是整行数据。在InnoDB里，主键索引也被称为聚簇索引（clustered index）。</p><p>非主键索引的叶子节点内容是主键的值。在InnoDB里，非主键索引也被称为二级索引（secondary index）。</p><p>根据上面的索引结构说明，我们来讨论一个问题：<strong>基于主键索引和普通索引的查询有什么区别？</strong></p><ul>
<li>如果语句是select * from T where ID=500，即主键查询方式，则只需要搜索ID这棵B+树；</li>
<li>如果语句是select * from T where k=5，即普通索引查询方式，则需要先搜索k索引树，得到ID的值为500，再到ID索引树搜索一次。这个过程称为回表。</li>
</ul><p>也就是说，基于非主键索引的查询需要多扫描一棵索引树。因此，我们在应用中应该尽量使用主键查询。</p><h1>索引维护</h1><p>B+树为了维护索引有序性，在插入新值的时候需要做必要的维护。以上面这个图为例，如果插入新的行ID值为700，则只需要在R5的记录后面插入一个新记录。如果新插入的ID值为400，就相对麻烦了，需要逻辑上挪动后面的数据，空出位置。</p><p>而更糟的情况是，如果R5所在的数据页已经满了，根据B+树的算法，这时候需要申请一个新的数据页，然后挪动部分数据过去。这个过程称为页分裂。在这种情况下，性能自然会受影响。</p><p>除了性能外，页分裂操作还影响数据页的利用率。原本放在一个页的数据，现在分到两个页中，整体空间利用率降低大约50%。</p><p>当然有分裂就有合并。当相邻两个页由于删除了数据，利用率很低之后，会将数据页做合并。合并的过程，可以认为是分裂过程的逆过程。</p><p>基于上面的索引维护过程说明，我们来讨论一个案例：</p><blockquote>
<p>你可能在一些建表规范里面见到过类似的描述，要求建表语句里一定要有自增主键。当然事无绝对，我们来分析一下哪些场景下应该使用自增主键，而哪些场景下不应该。</p>
</blockquote><p>自增主键是指自增列上定义的主键，在建表语句中一般是这么定义的： NOT NULL PRIMARY KEY AUTO_INCREMENT。</p><p>插入新记录的时候可以不指定ID的值，系统会获取当前ID最大值加1作为下一条记录的ID值。</p><p>也就是说，自增主键的插入数据模式，正符合了我们前面提到的递增插入的场景。每次插入一条新记录，都是追加操作，都不涉及到挪动其他记录，也不会触发叶子节点的分裂。</p><p>而有业务逻辑的字段做主键，则往往不容易保证有序插入，这样写数据成本相对较高。</p><p>除了考虑性能外，我们还可以从存储空间的角度来看。假设你的表中确实有一个唯一字段，比如字符串类型的身份证号，那应该用身份证号做主键，还是用自增字段做主键呢？</p><p>由于每个非主键索引的叶子节点上都是主键的值。如果用身份证号做主键，那么每个二级索引的叶子节点占用约20个字节，而如果用整型做主键，则只要4个字节，如果是长整型（bigint）则是8个字节。</p><p><strong>显然，主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小。</strong></p><p>所以，从性能和存储空间方面考量，自增主键往往是更合理的选择。</p><p>有没有什么场景适合用业务字段直接做主键的呢？还是有的。比如，有些业务的场景需求是这样的：</p><ol>
<li>
<p>只有一个索引；</p>
</li>
<li>
<p>该索引必须是唯一索引。</p>
</li>
</ol><p>你一定看出来了，这就是典型的KV场景。</p><p>由于没有其他索引，所以也就不用考虑其他索引的叶子节点大小的问题。</p><p>这时候我们就要优先考虑上一段提到的“尽量使用主键查询”原则，直接将这个索引设置为主键，可以避免每次查询需要搜索两棵树。</p><h1>小结</h1><p>今天，我跟你分析了数据库引擎可用的数据结构，介绍了InnoDB采用的B+树结构，以及为什么InnoDB要这么选择。B+树能够很好地配合磁盘的读写特性，减少单次查询的磁盘访问次数。</p><p>由于InnoDB是索引组织表，一般情况下我会建议你创建一个自增主键，这样非主键索引占用的空间最小。但事无绝对，我也跟你讨论了使用业务逻辑字段做主键的应用场景。</p><p>最后，我给你留下一个问题吧。对于上面例子中的InnoDB表T，如果你要重建索引 k，你的两个SQL语句可以这么写：</p><pre><code>alter table T drop index k;
alter table T add index(k);
</code></pre><p>如果你要重建主键索引，也可以这么写：</p><pre><code>alter table T drop primary key;
alter table T add primary key(id);
</code></pre><p>我的问题是，对于上面这两个重建索引的作法，说出你的理解。如果有不合适的，为什么，更好的方法是什么？</p><p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾给出我的参考答案。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>我在上一篇文章末尾给你留下的问题是：如何避免长事务对业务的影响？</p><p>这个问题，我们可以从应用开发端和数据库端来看。</p><p><strong>首先，从应用开发端来看：</strong></p><ol>
<li>
<p>确认是否使用了set autocommit=0。这个确认工作可以在测试环境中开展，把MySQL的general_log开起来，然后随便跑一个业务逻辑，通过general_log的日志来确认。一般框架如果会设置这个值，也就会提供参数来控制行为，你的目标就是把它改成1。</p>
</li>
<li>
<p>确认是否有不必要的只读事务。有些框架会习惯不管什么语句先用begin/commit框起来。我见过有些是业务并没有这个需要，但是也把好几个select语句放到了事务中。这种只读事务可以去掉。</p>
</li>
<li>
<p>业务连接数据库的时候，根据业务本身的预估，通过SET MAX_EXECUTION_TIME命令，来控制每个语句执行的最长时间，避免单个语句意外执行太长时间。（为什么会意外？在后续的文章中会提到这类案例）</p>
</li>
</ol><p><strong>其次，从数据库端来看：</strong></p><ol>
<li>
<p>监控 information_schema.Innodb_trx表，设置长事务阈值，超过就报警/或者kill；</p>
</li>
<li>
<p>Percona的pt-kill这个工具不错，推荐使用；</p>
</li>
<li>
<p>在业务功能测试阶段要求输出所有的general_log，分析日志行为提前发现问题；</p>
</li>
<li>
<p>如果使用的是MySQL  5.6或者更新版本，把innodb_undo_tablespaces设置成2（或更大的值）。如果真的出现大事务导致回滚段过大，这样设置后清理起来更方便。</p>
</li>
</ol>
                         </div>
                        </div> 
                       </div> 
                       <!----> 
                       <!---->
                      </div>
                     </div>
      </div>
   </body>
   </html>



<p>本文为转载自 “ 极客时间 ”，发布在此是为了方便自己随时阅读，如有涉及版权问题，请留言提示删除。    </p>
]]></content>
      <categories>
        <category>极客时间</category>
        <category>MySQL实战45讲</category>
      </categories>
      <tags>
        <tag>索引</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot功能（一）集成JavaMail实现邮箱认证</title>
    <url>/2020/03/08/SpringBoot%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%80%EF%BC%89%E9%9B%86%E6%88%90JavaMail%E5%AE%9E%E7%8E%B0%E9%82%AE%E7%AE%B1%E8%AE%A4%E8%AF%81/</url>
    <content><![CDATA[<h2 id="一、JavaMail"><a href="#一、JavaMail" class="headerlink" title="一、JavaMail"></a>一、JavaMail</h2><h3 id="1、什么是JavaMail？"><a href="#1、什么是JavaMail？" class="headerlink" title="1、什么是JavaMail？"></a>1、什么是JavaMail？</h3><p><strong>JavaMail</strong> ，顾名思义，提供给开发者处理 电子邮件相关的编程接口。它是<strong>Sun</strong>发布的用来处理<strong>email</strong>的<strong>API</strong>。它可以方便的执行一些常用的邮件传输。我们可以基于<strong>JavaMaiil</strong>开发出类似于 <strong>Microsoft Outlook</strong>的应用程序。 </p>
<h3 id="2、关于要使用JavaMail的原因？"><a href="#2、关于要使用JavaMail的原因？" class="headerlink" title="2、关于要使用JavaMail的原因？"></a>2、关于要使用JavaMail的原因？</h3><p>基于现在WEB开发中对JavaMail的需求，<strong>例如：</strong> </p>
<blockquote>
<p>(1) 用户注册后，网站发送一封激活邮件验证；</p>
</blockquote>
<blockquote>
<p>(2) 用户过生日，系统发送生日祝福邮件；</p>
</blockquote>
<blockquote>
<p>(3) 将最新活动和优惠以邮件的形式告知会员等等……..</p>
</blockquote>
<p>以上的需求都需要通过编程语言实现发送邮件功能，而JavaMail便能满足这一需求。 </p>
<h3 id="3、电子邮箱及邮件服务器"><a href="#3、电子邮箱及邮件服务器" class="headerlink" title="3、电子邮箱及邮件服务器"></a>3、电子邮箱及邮件服务器</h3><p>什么是<strong>电子邮箱</strong>？ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">电子邮箱（E-mail 地址） 需要在邮件服务器上进行申请，确切的说，电子邮箱其实就是用户在邮件服务器上申请的一个账户，用户在邮件服务器上申请了一个账号后，邮件服务器就会为这个账号分配一定的空间，用户从而可以使用这个账号以及空间，发送电子邮件和保存别人发送过来的电子邮件。</span><br></pre></td></tr></table></figure>

<p>什么是<strong>邮箱服务器</strong>？ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">服务器指的是一台电脑安装了一个服务器软件，那么这台电脑就可以称为是WEB服务器，那么同样的一台电脑安装了邮件服务器软件，那么这台电脑称为是邮件服务器。</span><br></pre></td></tr></table></figure>

<p>基于互联网的<strong>电子邮件</strong>功能： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">要在Internet上提供电子邮件功能，必须有专门的电子邮件服务器，例如目前网络上提供邮件服务的厂商：新浪、搜狐、网易等等他们都有自己的邮件服务器。</span><br></pre></td></tr></table></figure>

<h3 id="4、邮件收发协议"><a href="#4、邮件收发协议" class="headerlink" title="4、邮件收发协议"></a>4、邮件收发协议</h3><p>（1）SMTP协议（发送邮件）</p>
<p> <strong>简单邮件传输协议 (Simple Mail Transfer Protocol, SMTP)</strong> 是在<a href="https://baike.baidu.com/item/Internet" target="_blank" rel="noopener">Internet</a>传输<a href="https://baike.baidu.com/item/email" target="_blank" rel="noopener">email</a>的<a href="https://baike.baidu.com/item/%E4%BA%8B%E5%AE%9E%E6%A0%87%E5%87%86" target="_blank" rel="noopener">事实标准</a>。（百度百科）</p>
<blockquote>
<p><strong>SMTP</strong>是一个相对简单的基于文本的<strong>协议</strong>。在其之上指定了一条消息的一个或多个接收者（在大多数情况下被确认是存在的），然后<strong>消息文本</strong>会被传输。可以很简单地通过<strong>telnet</strong>程序来测试一个<strong>SMTP服务器</strong>。SMTP使用TCP端口25。要为一个给定的域名决定一个SMTP服务器，需要使用<strong>MX (Mail eXchange) DNS</strong>。（百度百科）</p>
</blockquote>
<p>用户脸上邮件服务器后，要想给它发送一封电子邮件，需要遵循一定的通讯规则，SMTP协议就是用于定义这种规则的。因此，通常我们也把处理用户SMTP请求（邮件发送请求）的邮件服务器称之为SMTP服务器。 </p>
<p>（2）POP3协议（接收邮件）  </p>
<p><strong>POP3</strong>，全名为“Post Office Protocol - Version 3”，即“<a href="https://baike.baidu.com/item/%E9%82%AE%E5%B1%80%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">邮局协议</a>版本3”。是<a href="https://baike.baidu.com/item/TCP%2FIP" target="_blank" rel="noopener">TCP/IP</a>协议族中的一员，由<a href="https://baike.baidu.com/item/RFC" target="_blank" rel="noopener">RFC</a>1939 定义。本协议主要用于支持使用客户端远程管理在<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8/100571" target="_blank" rel="noopener">服务器</a>上的电子邮件。提供了<a href="https://baike.baidu.com/item/SSL" target="_blank" rel="noopener">SSL</a>加密的POP3协议被称为POP3S。（百度百科） </p>
<blockquote>
<p><strong>POP</strong> 协议支持“离线”邮件处理。其具体过程是：<strong>邮件发送到服务器上</strong>，电子邮件客户端调用邮件客户机程序以<strong>连接服务器</strong>，并下载所有未阅读的<strong>电子邮件</strong>。这种<strong>离线访问模式</strong>是一种存储转发服务，将邮件从邮件服务器端送到个人终端机器上，一般是PC机或 MAC。一旦邮件发送到 PC 机或MAC上，邮件服务器上的邮件将会被删除。但目前的<strong>POP3</strong>邮件服务器大都可以“只下载邮件，服务器端并不删除”，也就是改进的<strong>POP3协议</strong>。（百度百科）</p>
</blockquote>
<p>同样，用户若<strong>想从邮件服务器管理的电子邮件中接受一封电子邮件的话，他连上邮件服务器后，也需要遵循一定的通讯格式</strong>，POP3协议用于定义这种通讯格式。 </p>
<p>（3）邮件收发过程的介绍： </p>
<img src="http://photo.wushaopei.com/qiniu47.png" width="70%">

<blockquote>
<p><strong>邮件的发送、接受，在客户端软件中，由SMTP服务器进行发送操作，接受是由POP3服务器进行接收。</strong></p>
<p>1、 邮件发送协议-SMTP，默认端口号25</p>
<p>​       用于把用户邮件从一个服务器转到下一个服务器</p>
<p>2、 邮件接收协议-POP3，默认端口号110</p>
<p>​       用于支持使用客户端远程管理在服务器上的电子邮件</p>
</blockquote>
<h2 id="二、邮件发送代码实现"><a href="#二、邮件发送代码实现" class="headerlink" title="二、邮件发送代码实现"></a>二、邮件发送代码实现</h2><h3 id="1、环境搭建"><a href="#1、环境搭建" class="headerlink" title="1、环境搭建"></a>1、环境搭建</h3><p>（1）创建数据库和表 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;NewTable&#96; (</span><br><span class="line">&#96;uid&#96;  int(11) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">&#96;username&#96;  varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;password&#96;  varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;nickname&#96;  varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;email&#96;  varchar(30) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">&#96;state&#96;  int(11) NULL DEFAULT NULL ,</span><br><span class="line">&#96;code&#96;  varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ,</span><br><span class="line">PRIMARY KEY (&#96;uid&#96;)</span><br><span class="line">)</span><br><span class="line">ENGINE&#x3D;InnoDB</span><br><span class="line">DEFAULT CHARACTER SET&#x3D;utf8 COLLATE&#x3D;utf8_general_ci</span><br><span class="line">AUTO_INCREMENT&#x3D;22</span><br><span class="line">ROW_FORMAT&#x3D;DYNAMIC</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>（2）创建一个springboot工程，创建相应的包，并配置相应的pom.xml依赖 </p>
<img src="http://photo.wushaopei.com/qiniu48.png" width="60%">

<p>  (3) pom.xml </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--&lt;version&gt;5.1.41&lt;/version&gt; --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- lombok 简化 java 代码 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--郵箱發送--&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（4）创建User类并配置application.yml </p>
<p><strong>User类：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span>  Integer uid;</span><br><span class="line">    <span class="keyword">private</span>  String username;</span><br><span class="line">    <span class="keyword">private</span>  String password;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Integer state;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>application.yml</strong> </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">80</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://localhost:3333/regist_web?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;autoReconnect=true&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">root</span></span><br><span class="line">    <span class="meta">driver-class-name</span>:  <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">mybatis</span>:<span class="string"></span></span><br><span class="line">  <span class="meta">mapper-locations</span>: <span class="string">classpath*:/mybatis/mappers/*Mapper.xml</span></span><br><span class="line">  <span class="meta">type-aliases-package</span>: <span class="string">com.entities</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#邮件配置(发件人）</span></span><br><span class="line"><span class="attr">email</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">host</span>: <span class="string">smtp.163.com</span></span><br><span class="line">  <span class="attr">username</span>: <span class="string">1***9746***@163.com</span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">1***9746**</span></span><br><span class="line">  <span class="attr">senderName</span>: <span class="string">1***9746***@163.com</span></span><br></pre></td></tr></table></figure>

<p>（5）设计注册页面 </p>
<p><strong>index.html</strong> </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"jquery-1.11.3.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户注册的页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/get/getParam/user"</span> <span class="attr">method</span>=<span class="string">"get"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"600"</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>昵称<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"nickname"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>邮箱<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"email"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"2"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注册"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（6）Handler ：创建接口，接收form 表单数据并进行封装，并经过dao 层 添加到对应的数据库表中 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping</span> (<span class="string">"/get/getParam/user"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getParam</span><span class="params">(@RequestParam(<span class="string">"username"</span>)</span>String  username,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"password"</span>)</span>String  password,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"nickname"</span>)</span>String  nickname,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"email"</span>)</span>String  email,</span></span><br><span class="line"><span class="function">                           HttpServletRequest request</span></span><br><span class="line"><span class="function">                           )  </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            request.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>(username.equals(<span class="string">""</span>) &amp;&amp; password.equals(<span class="string">""</span>) &amp;&amp; nickname.equals(<span class="string">""</span>) &amp;&amp; email.equals(<span class="string">""</span>))&#123;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">return</span>  <span class="string">"请不要留空"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">//封装数据</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUsername(username);</span><br><span class="line">        user.setPassword(password);</span><br><span class="line">        user.setNickname(nickname);</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        user.setState(<span class="number">0</span>);<span class="comment">// 0 ： 未激活 1： 已经激活</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//使用 UUID 随机生成激活码</span></span><br><span class="line">        String code = UUIDUtils.getUUID()+ UUIDUtils.getUUID();</span><br><span class="line">        user.setCode(code);</span><br><span class="line"> </span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//调用业务层处理数据</span></span><br><span class="line">        userService.addUser(user);</span><br><span class="line"> </span><br><span class="line">        map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">        map.put(<span class="string">"message"</span>, <span class="string">"發送成功"</span>);</span><br><span class="line">        <span class="comment">//页面跳转</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">            map.put(<span class="string">"state"</span>,<span class="string">"1"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"發送失敗"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span>  <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>（7）创建一个UUIDUtils 工具类，使用UUID随机生成激活码 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UUIDUtils  生成随机字符串工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/8 13:52</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UUIDUtils</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">"-"</span>,<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（8）创建邮箱参数实体EmailConfig.java和发送邮件工具类MailUtils.java</p>
<p><strong>EmailConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.utils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> EmailConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/7/25 10:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"email"</span>, ignoreUnknownFields = <span class="keyword">false</span>)</span><br><span class="line"><span class="comment">//@PropertySource("classpath:/application.yml")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String senderName;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSenderName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSenderName</span><span class="params">(String senderName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.senderName = senderName;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"EmailConfig&#123;"</span> +</span><br><span class="line">                <span class="string">"host='"</span> + host + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", senderName='"</span> + senderName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MailUtils.java</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.utils;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mysql.cj.Session;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.JavaMailSenderImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mail.javamail.MimeMessageHelper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.mail.MessagingException;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MailUtils</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/9/8 14:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailUtils</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailConfig emailConfig;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MailUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送邮件的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> to :给谁发邮件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> code : 邮件的激活码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> subject ： 主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span> text  : 内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">sendMail</span><span class="params">(String toEmail, String code,<span class="keyword">final</span> String subject,<span class="keyword">final</span> String text)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//1、创建邮件对象</span></span><br><span class="line">            JavaMailSenderImpl javaMailSender = <span class="keyword">new</span> JavaMailSenderImpl();</span><br><span class="line">            <span class="comment">//2、发邮件人邮箱</span></span><br><span class="line">            javaMailSender.setUsername(emailConfig.getUsername());</span><br><span class="line">            <span class="comment">//3、发邮件人邮箱密码（默认使用客户端的授权码）</span></span><br><span class="line">            javaMailSender.setPassword(emailConfig.getPassword());</span><br><span class="line">            <span class="comment">//4、设置邮件服务器主机名  SMTP服务器地址</span></span><br><span class="line">            javaMailSender.setHost(emailConfig.getHost());</span><br><span class="line">            <span class="comment">//5、SMTP服务器: 默认端口</span></span><br><span class="line">            javaMailSender.setPort(<span class="number">25</span>);</span><br><span class="line">            <span class="comment">//6、//发送邮件协议名称</span></span><br><span class="line">            javaMailSender.setProtocol(<span class="string">"smtp"</span>);</span><br><span class="line">            <span class="comment">//7、编码格式</span></span><br><span class="line">            javaMailSender.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//8、创建连接对象，连接到邮箱服务器</span></span><br><span class="line">            Properties mailProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">            <span class="comment">//发送服务器需要身份验证,要采用指定用户名密码的方式去认证</span></span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.auth"</span>, <span class="keyword">true</span>);</span><br><span class="line">            mailProperties.put(<span class="string">"mail.smtp.starttls.enable"</span>, <span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//9、添加连接对象到邮件对象中</span></span><br><span class="line">            javaMailSender.setJavaMailProperties(mailProperties);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//10、创建</span></span><br><span class="line">            <span class="comment">//可以发送几封邮件:可以这里 for循环多次</span></span><br><span class="line">                MimeMessage mimeMessage = getMimeMessage(toEmail,subject,text, javaMailSender);</span><br><span class="line">                <span class="comment">//11、发送邮件</span></span><br><span class="line">                javaMailSender.send(mimeMessage);</span><br><span class="line">                logger.info(<span class="string">"发送 第"</span>+ count + <span class="string">"封邮件"</span> );</span><br><span class="line">                count ++;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            logger.info(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发往 "</span>+toEmail+<span class="string">" 邮件发送异常"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//声明一个Message对象(代表一封邮件),从session中创建</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MimeMessage <span class="title">getMimeMessage</span><span class="params">(String toEmail,String subject,String text, JavaMailSenderImpl javaMailSender)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        MimeMessage mimeMessage = javaMailSender.createMimeMessage();</span><br><span class="line"> </span><br><span class="line">        MimeMessageHelper mimeMessageHelper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage, <span class="keyword">true</span>, <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">//发件人</span></span><br><span class="line">        mimeMessageHelper.setFrom(emailConfig.getSenderName());</span><br><span class="line">        <span class="comment">//收件人  : 可以发送给多个收件人，该方法有一个重载的 数组形参</span></span><br><span class="line">        mimeMessageHelper.setTo(toEmail);</span><br><span class="line"><span class="comment">//        mimeMessage.setContent();</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//邮件主题</span></span><br><span class="line">        mimeMessageHelper.setSubject(subject);</span><br><span class="line">        <span class="comment">//邮件内容</span></span><br><span class="line">        mimeMessageHelper.setText(text, <span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> mimeMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（9）在（5）中的接口接收注册参数并写入数据库后，进行激活邮件的发送 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//调用业务层处理数据</span></span><br><span class="line">userService.addUser(user);</span><br></pre></td></tr></table></figure>

<p><strong>UserServiceimpl.java</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将数据存入到数据库</span></span><br><span class="line">	Integer integer = userMapper.addUser(user);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//发送一封激活邮件</span></span><br><span class="line">	mailUtils.sendMail(<span class="string">"18620307785@163.com"</span>,user.getCode(),<span class="string">"来自邮箱测试接口邮件"</span>,<span class="string">"&lt;h1&gt;来自wto网站激活邮件，激活请点击以下链接：&lt;/h1&gt;&lt;h3&gt;&lt;a href='http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"'&gt;http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"&lt;/a&gt;&lt;/h3&gt;"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> integer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整 业务层代码：</p>
<p><strong>UserService.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;User&gt; <span class="title">getAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Integer <span class="title">addUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">User <span class="title">findByCode</span><span class="params">(String code)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>UserServiceImpl.java</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MailUtils mailUtils;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> userMapper.selectAll();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">//将数据存入到数据库</span></span><br><span class="line">		Integer integer = userMapper.addUser(user);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">//发送一封激活邮件</span></span><br><span class="line">		mailUtils.sendMail(<span class="string">"18620307785@163.com"</span>,user.getCode(),<span class="string">"来自邮箱测试接口邮件"</span>,<span class="string">"&lt;h1&gt;来自wto网站激活邮件，激活请点击以下链接：&lt;/h1&gt;&lt;h3&gt;&lt;a href='http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"'&gt;http://wj7ei8.natappfree.cc/regist_web/activateServlet?code="</span>+user.getCode()+<span class="string">"&lt;/a&gt;&lt;/h3&gt;"</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> integer;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">findByCode</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> userMapper.findByCode(code);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		userMapper.updateUser(user);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（10）UserMapper.java 和 UserMapper.xml </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function">List&lt;User&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Integer <span class="title">addUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function">User <span class="title">findByCode</span><span class="params">(@Param(<span class="string">"code"</span>)</span> String code)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">	select *</span><br><span class="line">	from</span><br><span class="line">	user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"addUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.entities.User"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">keyProperty</span>=<span class="string">"id"</span> &gt;</span></span><br><span class="line">	INSERT INTO user (</span><br><span class="line">		username,</span><br><span class="line">		password,</span><br><span class="line">		nickname,</span><br><span class="line">		email,</span><br><span class="line">		state,</span><br><span class="line">		code</span><br><span class="line">	)</span><br><span class="line">	VALUES</span><br><span class="line">		(</span><br><span class="line">			#&#123;username&#125;,</span><br><span class="line">			#&#123;password&#125;,</span><br><span class="line">			#&#123;nickname&#125;,</span><br><span class="line">			#&#123;email&#125;,</span><br><span class="line">			#&#123;state&#125;,</span><br><span class="line">			#&#123;code&#125;</span><br><span class="line">		)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByCode"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">resultType</span>=<span class="string">"com.entities.User"</span>&gt;</span></span><br><span class="line">	SELECT</span><br><span class="line">		*</span><br><span class="line">	FROM</span><br><span class="line">		user u</span><br><span class="line">	WHERE</span><br><span class="line">		u. CODE = #&#123;code&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.entities.User"</span>&gt;</span></span><br><span class="line">	UPDATE user</span><br><span class="line">	<span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"set"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null"</span>&gt;</span></span><br><span class="line">			username=#&#123;username&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span></span><br><span class="line">			password=#&#123;password&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickname != null"</span>&gt;</span></span><br><span class="line">			nickname=#&#123;nickname&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"email!=null"</span>&gt;</span></span><br><span class="line">			email=#&#123;email&#125;,</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">			state=#&#123;state&#125;,</span><br><span class="line">			code=#&#123;code&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">	WHERE uid=#&#123;uid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（11）创建用户激活接口： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 用户激活的 接口</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/regist_web/activateServlet"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">activateServlet</span><span class="params">(@RequestParam(<span class="string">"code"</span>)</span>String  code,</span></span><br><span class="line"><span class="function">                           HttpServletRequest request,HttpServletResponse response)  </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            User user = userService.findByCode(code);</span><br><span class="line">            <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">//已经查询到，修改用户的状态</span></span><br><span class="line">                user.setState(<span class="number">1</span>);<span class="comment">//已经激活</span></span><br><span class="line">                user.setCode(<span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">//激活后修改用户的激活码及状态</span></span><br><span class="line">                userService.updateUser(user);</span><br><span class="line">                map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">                map.put(<span class="string">"message"</span>, <span class="string">"您的激活码已激活!请去登录"</span>);</span><br><span class="line"> </span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//根据激活码没有查询到该用户</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">                map.put(<span class="string">"state"</span>,<span class="string">"0"</span>);</span><br><span class="line">                map.put(<span class="string">"message"</span>, <span class="string">"您的激活码有误!请重新激活"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            map.put(<span class="string">"state"</span>,<span class="string">"1"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"發送失敗"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结：</strong> </p>
<blockquote>
<p>发送激活邮件正文，正文内容使用 html 的语法进行修饰，用户邮箱POP3接受到邮件后会自动根据标签及样式进行解析。</p>
<p>激活邮件的原理：</p>
<p>发送邮件给用户，用户根据接收到的邮件的连接点击并跳转到对应的controller请求接口执行code验证码查询到用户，并根据当前激活码的作用对用户执行激活账户、业务等操作！！！</p>
</blockquote>
<p><a href="https://gitee.com/wushaopei/springboot-plus/tree/master/spring-boot-JSP-email" target="_blank" rel="noopener">码云</a></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot功能篇</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot原理（一）自启动原理</title>
    <url>/2020/03/07/SpringBoot%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89%E8%87%AA%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a><strong>引言</strong></h3><p>​    不论在工作中，亦或是求职面试，Spring Boot 已经成为我们必知必会的技能项。除了比较老旧的政府项目或金融项目依旧使用如 SSM 或 SSH 做单体框架开发项目外，如今的各行各业基于项目的快速开发与发布、迭代更新，都在逐渐替换使用 Spring Boot 框架，而逐步摒弃配置沉重和效率低下的 Spring 启动框架。</p>
<p>​    使用一门新的技术，立足于对它足够了解的基础上，能够让你更加得心应手的去进行应用、开发。SpringBoot 的精髓 “自动配置原理” 不仅仅是在面试过程中才用的上；在工作中如果能深入理解Spring Boot 的自动配置原理，我们就可以根据自己的需求自定义一个 started 满足开发的需求，让开发更加便捷与高效。</p>
<p>​    Spring Boot的出现，得益于“习惯优于配置”的理念，没有繁琐的配置、难以集成的内容（大多数流行第三方技术都被集成），这是基于Spring 4.x提供的按条件配置Bean的能力。</p>
<p><strong>本篇博文主要针对三个方面进行分析、讲解；这三个方面分别是：</strong></p>
<blockquote>
<h5 id="Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？"><a href="#Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？" class="headerlink" title="Spring Boot 与 Spring 的差别与优点？以及与Spring MVC 的关系？"></a>Spring Boot 与 Spring 的差别与优点？以及与Spring MVC 的关系？</h5><p>Spring Boot 主启动类的启动机制<br>Spring Boot 的自动配置原理是怎么实现的？<br>根据自动配置原理自定义一个 个性的 started ？</p>
</blockquote>
<h3 id="1、Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？"><a href="#1、Spring-Boot-与-Spring-的差别与优点？以及与Spring-MVC-的关系？" class="headerlink" title="1、Spring Boot 与 Spring 的差别与优点？以及与Spring MVC 的关系？"></a>1、<strong>Spring Boot</strong> 与 <strong>Spring</strong> 的差别与优点？以及与Spring MVC 的关系？</h3><h4 id="1-1-Spring-Boot-和-Spring-MVC-的关系？"><a href="#1-1-Spring-Boot-和-Spring-MVC-的关系？" class="headerlink" title="1.1 Spring Boot 和 Spring MVC 的关系？"></a>1.1 Spring Boot 和 Spring MVC 的关系？</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Spring MVC 是基于Spring 的MVC框架；</span><br><span class="line"></span><br><span class="line">而Spring Boot 是基于Spring 配置的开发工具框架，使用注解更加简洁和适应快速开发。</span><br></pre></td></tr></table></figure>

<h4 id="1-2-Spring-Boot-的优势"><a href="#1-2-Spring-Boot-的优势" class="headerlink" title="1.2 Spring Boot 的优势"></a>1.2 Spring Boot 的优势</h4><p><strong>简单来说：</strong>Spring boot 简化了使用 Spring 的难度，简省了繁重的配置，提供了各种启动器，开发者能快速上手。</p>
<p><strong>（1）编码更简单</strong></p>
<pre><code>Spring 框架由于超重量级的 XML，annotation 配置，使得系统变得很笨重，难以维护
SpringBoot 采用约点大于配置的方法，直接引入依赖，即可实现代码的开发</code></pre><p><strong>（2）配置更简单</strong></p>
<img src="http://photo.wushaopei.com/qiniu29.png" width="60%">

<p><strong>Xml</strong>文件使用<strong>javaConfig</strong>代替，<strong>XML</strong>中<strong>bean</strong>的创建，使用@<strong>bean</strong>代替后可以直接注入。</p>
<p>配置文件变少很多，只保留 <strong>application</strong>.<strong>yml</strong></p>
<p><strong>（3）部署更简单</strong> </p>
<img src="http://photo.wushaopei.com/qiniu30.png" width="60%">

<p><strong>（4）监控更简单</strong> </p>
<blockquote>
<ul>
<li>Spring-boot-start-actuator:</li>
<li>可以查看属性配置</li>
<li>线程工作状态</li>
<li>环境变量</li>
<li>JVM性能监控</li>
</ul>
</blockquote>
<h3 id="2、Spring-Boot-主启动类的启动机制"><a href="#2、Spring-Boot-主启动类的启动机制" class="headerlink" title="2、Spring Boot 主启动类的启动机制"></a>2、<strong>Spring Boot</strong> 主启动类的启动机制</h3><p><strong>关于程序的入口问题：</strong></p>
<p>在使用<strong>SSM</strong>或<strong>SSH</strong>以及原生的<strong>Servlet</strong> 作为架构的项目中，项目的入口都不是 <strong>main</strong> 方法，<strong>main</strong> 方法更多的是作为 <strong>HelloWorld</strong> 练习或 测试时使用。其程序的入口基本都是<strong>handler</strong> 中对外暴露的每个接口：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;listarea&quot;,method &#x3D; RequestMethod.GET)</span><br><span class="line">  private Map&lt;String,Object&gt; listArea()&#123;</span><br><span class="line">      HashMap&lt;String, Object&gt; modelMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">      List&lt;Area&gt; list &#x3D; areaService.getAreaList();</span><br><span class="line">      modelMap.put(&quot;areaList&quot;,list);</span><br><span class="line">      ArrayList arrayList &#x3D; new ArrayList();</span><br><span class="line">      return  modelMap;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>外部通过对接口地址的调用，从而实现交互获取数据、进行页面渲染和展示。</p>
<p>但是，在使用了 <strong>Spring Boot</strong> 后， <strong>Main</strong> 方法又成为了程序的入口；</p>
<p>使用过<strong>springBoot</strong>进行项目打包和部署启动的都知道， <strong>SpringBoot</strong> 打包成 <strong>jar</strong> 包后，可以不需要部署到<strong>Tomcat</strong> 上而直接用命令启动，<strong>如下</strong>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar xxx.jar</span><br></pre></td></tr></table></figure>

<p>这是因为<strong>Spring Boot</strong> 的<strong>jar</strong> 在启动时，程序经过 主启动类中的<strong>main</strong> 方法进行启动的；<strong>主启动</strong>类代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里为项目创建一个接口，并分别在接口和主启动类<strong>main</strong>方法上打断点， </p>
<img src="http://photo.wushaopei.com/qiniu31.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu32.png" width="60%">

<p>在<strong>Spring Boot</strong> 项目中每次调用接口前都会先启动 主启动类，这里对主启动类的 <strong>main</strong> 方法入口进行分析；</p>
<p>在上图中，主启动类启动后会进入<strong>main</strong> 方法中，并在方法中由 <strong>SpringApplication</strong> 调用 <strong>run （）</strong>方法，方法中形参传入当前类的 <strong>class</strong> 对象以及<strong>main</strong> 方法的 <strong>args</strong>  参数。</p>
<p>下一步进入 <strong>run()</strong> 方法中，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Object source, String... args)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> run(<span class="keyword">new</span> Object[]&#123;source&#125;, args);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu33.png" width="60%">

<p>由截图可知，传入的<strong>class</strong> 对象被用来创建 <strong>SpringApplication</strong>实例对象，并由生成的实例调用 <strong>run （args）</strong> 方法做启动操作，方法形参为 <strong>args</strong> 参数。</p>
<p><strong>①创建 SpringApplication 实例，进行初始化对象：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> SpringApplication ( Object... sources)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(Object... sources)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">this</span>.bannerMode = Mode.CONSOLE;</span><br><span class="line">      <span class="keyword">this</span>.logStartupInfo = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.addCommandLineProperties = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.headless = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.registerShutdownHook = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.additionalProfiles = <span class="keyword">new</span> HashSet();</span><br><span class="line">      <span class="keyword">this</span>.initialize(sources);   <span class="comment">// 初始化启动类</span></span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在 该构造函数的 方法体中，对当前类进行了初始化， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Object[] sources)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">if</span> (sources != <span class="keyword">null</span> &amp;&amp; sources.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">this</span>.sources.addAll(Arrays.asList(sources));   <span class="comment">// 添加启动类 DemoApplication.class 到 set 集合中，以备后用</span></span><br><span class="line">         </span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">this</span>.webEnvironment = <span class="keyword">this</span>.deduceWebEnvironment();  <span class="comment">// 重点：检测当前是否为 web 环境      </span></span><br><span class="line">                                                     <span class="keyword">this</span>.setInitializers(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">  </span><br><span class="line">     <span class="keyword">this</span>.setListeners(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationListener<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">this</span>.mainApplicationClass = <span class="keyword">this</span>.deduceMainApplicationClass();</span><br><span class="line">    </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu34.png" width="60%">

<p>上图中的 webEnvironment 用于检测当前环境是否为 web 环境，如果是，则返回true.</p>
<p>具体如何判断当前环境是否为 web 环境，后面再做分析.</p>
<p><strong>获取初始化器：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu35.png" width="60%">

<p>在确定是否为web环境后，会根据 <strong>ApplicationContextInitializer</strong>.<strong>class</strong> 获取<strong>工厂实例参数</strong>从而<strong>设置初始化器的参数</strong>；</p>
<p>随后 用<strong>setListeners</strong> 设置监听器</p>
<img src="http://photo.wushaopei.com/qiniu36.png" width="60%">

<p>判断并获取主启动类的类型，通过获取jvm运行时的栈（StackTraceElement[]）中的多个加载的类，判断类中方法是否符合  <strong>main</strong> 方法 的类即为当前启动类，</p>
<img src="http://photo.wushaopei.com/qiniu37.png" width="60%">

<p>   到这里，<strong>SpringApplication</strong> 的初始化过程就执行完毕了；此时的<strong>SpringApplication</strong> 实例的启动需要调用<strong>run()</strong> 方法来实现，下一节进行分析；</p>
<p>以下是初始化过程的重要环节的关系图：    </p>
<img src="http://photo.wushaopei.com/qiniu38.png" width="60%">

<p>判断当前环境是否为 web 环境： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.webEnvironment = <span class="keyword">this</span>.deduceWebEnvironment();  <span class="comment">// 重点：检测当前是否为 web 环境</span></span><br></pre></td></tr></table></figure>

<p>我们进入 deduceWebEnvironment（）方法去看一看， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deduceWebEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    String[] var1 = WEB_ENVIRONMENT_CLASSES;</span><br><span class="line">    <span class="keyword">int</span> var2 = var1.length;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> var3 = <span class="number">0</span>; var3 &lt; var2; ++var3) &#123;</span><br><span class="line">        </span><br><span class="line">        String className = var1[var3];</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, (ClassLoader)<span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由源码可知， deduceWebEnvironment 中对 私有变量 <strong>WEB_ENVIRONMENT_CLASSES</strong>进行了循环，继续查看它所代表的是什么？ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] WEB_ENVIRONMENT_CLASSES = <span class="keyword">new</span> String[]&#123;<span class="string">"javax.servlet.Servlet"</span>, <span class="string">"org.springframework.web.context.ConfigurableWebApplicationContext"</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>该私有变量数组有两个参数构成，第一个参数是 “javax.servlet.Servlet”，第二个参数是  “ConfigurableWebApplicationContext”，这里对“ConfigurableWebApplicationContext”进行分析： </p>
<img src="http://photo.wushaopei.com/qiniu39.png" width="60%">

<p>进入ConfigurableWebApplicationContext类中，我们看到该类继承自 WebApplicationContext 和 ConfigurableApplicationContext两个类，再往下看：</p>
<img src="http://photo.wushaopei.com/qiniu40.png" width="60%">

<p>我们看到 WebApplicationContext 继承自 ApplicationContext 类，而我们知道 ApplicationContext 是可以用来创建IOC 容器的对象的，如： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicatioonContext context = <span class="keyword">new</span> ClasspathXmlApplicationContext();</span><br></pre></td></tr></table></figure>

<p>该ApplicationContext类是所有IOC 容器对象的顶级接口</p>
<p>阶段小结：<strong>ConfigurableWebApplicationContext</strong> 是 <strong>web</strong> 环境下可以配置的IOC 容器。</p>
<p>那么拿到该类的全类名有什么用呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ClassUtils.isPresent(className, (ClassLoader)<span class="keyword">null</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPresent</span><span class="params">(String className, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        forName(className, classLoader);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 deduceWebEnvironment 方法中调用了 isPresent 方法，而在isPresent方法中有调用 forName ,将全类名 className 作为形参传入 forName中，此处的 classLoader 是null值。</p>
<p>这里进入 ClassUtils的forName（）方法中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String name, ClassLoader classLoader) <span class="keyword">throws</span> ClassNotFoundException, LinkageError &#123;</span><br><span class="line">    </span><br><span class="line">        Assert.notNull(name, <span class="string">"Name must not be null"</span>);</span><br><span class="line">    </span><br><span class="line">        Class&lt;?&gt; clazz = resolvePrimitiveClassName(name);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            clazz = (Class)commonClassCache.get(name);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Class elementClass;</span><br><span class="line">            String elementName;</span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(<span class="string">"[]"</span>)) &#123;</span><br><span class="line">                elementName = name.substring(<span class="number">0</span>, name.length() - <span class="string">"[]"</span>.length());</span><br><span class="line">                elementClass = forName(elementName, classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(elementClass, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">"[L"</span>) &amp;&amp; name.endsWith(<span class="string">";"</span>)) &#123;</span><br><span class="line">                elementName = name.substring(<span class="string">"[L"</span>.length(), name.length() - <span class="number">1</span>);</span><br><span class="line">                elementClass = forName(elementName, classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(elementClass, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">"["</span>)) &#123;</span><br><span class="line">                elementName = name.substring(<span class="string">"["</span>.length());</span><br><span class="line">                elementClass = forName(elementName, classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(elementClass, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ClassLoader clToUse = classLoader;</span><br><span class="line">                <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clToUse = getDefaultClassLoader();</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> clToUse != <span class="keyword">null</span> ? clToUse.loadClass(name) : Class.forName(name);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var9) &#123;</span><br><span class="line">                    <span class="keyword">int</span> lastDotIndex = name.lastIndexOf(<span class="number">46</span>);</span><br><span class="line">                    <span class="keyword">if</span> (lastDotIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                        String innerClassName = name.substring(<span class="number">0</span>, lastDotIndex) + <span class="string">'$'</span> + name.substring(lastDotIndex + <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> clToUse != <span class="keyword">null</span> ? clToUse.loadClass(innerClassName) : Class.forName(innerClassName);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ClassNotFoundException var8) &#123;</span><br><span class="line">                            ;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">throw</span> var9;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中的   Class&lt;?&gt; clazz = resolvePrimitiveClassName(name); 根据全类名获取class 字节码文件对象；在获取到的class 对象不为null 的情况下，clazz = (Class)commonClassCache.get(name); 获取常用类缓存中是否也存在该class对象；</p>
<p>如果两次获取的 clazz 都不为null是存在的，那么就直接返回：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br></pre></td></tr></table></figure>

<p>由此我们可以知道,<strong>isPresent</strong>()方法的作用，是为了查看当前环境中有没有指定的工程项目的类。</p>
<p>从这里，我们可以做出总结，<strong>deduceWebEnvironment</strong> () 方法中通过判断 “<strong>WEB_ENVIRONMENT_CLASSES</strong>”数组中声明的两个类能否在当前环境中找到，如果能，说明当前环境为web 环境。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] WEB_ENVIRONMENT_CLASSES = <span class="keyword">new</span> String[]&#123;<span class="string">"javax.servlet.Servlet"</span>, <span class="string">"org.springframework.web.context.ConfigurableWebApplicationContext"</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>② <strong>SpringApplication</strong>实例的启动过程：</p>
<p>在获取到SpringApplication的实例并初始化完成后，其启动使用<strong>run()</strong> 方法实现，</p>
<img src="http://photo.wushaopei.com/qiniu41.png" width="80%">

<p>进入 run(args）方法中， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">        FailureAnalyzers analyzers = <span class="keyword">null</span>;   <span class="comment">// 失败分析器</span></span><br><span class="line">        <span class="keyword">this</span>.configureHeadlessProperty();    <span class="comment">// 读取property 文件</span></span><br><span class="line">        SpringApplicationRunListeners listeners = <span class="keyword">this</span>.getRunListeners(args); <span class="comment">// 加载监听器</span></span><br><span class="line">        listeners.starting();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);       <span class="comment">// 应用参数</span></span><br><span class="line">            ConfigurableEnvironment environment = <span class="keyword">this</span>.prepareEnvironment(listeners, applicationArguments);                   <span class="comment">// 配置文件参数（有默认值，可读取自定义配置文件），用于配置当前环境</span></span><br><span class="line">            Banner printedBanner = <span class="keyword">this</span>.printBanner(environment);   <span class="comment">// banner的自定义机制</span></span><br><span class="line">            context = <span class="keyword">this</span>.createApplicationContext();              <span class="comment">// 创建可配置的 IOC 容器</span></span><br><span class="line">            <span class="keyword">new</span> FailureAnalyzers(context);                          <span class="comment">// 传入配置好的 IOC 容器 创建失败分析器对象</span></span><br><span class="line">            <span class="keyword">this</span>.prepareContext(context, environment, listeners, applicationArguments, printedBanner);                              <span class="comment">// 传入失败分析器，环境参数、监听器、banner 配置等进行刷新</span></span><br><span class="line">            <span class="keyword">this</span>.refreshContext(context);                          <span class="comment">// 根据ioc 刷新上下文容器，并打印日志 ，此时TOMCAT / JETTY 容器会被启动</span></span><br><span class="line">            <span class="keyword">this</span>.afterRefresh(context, applicationArguments);      <span class="comment">// 映射 dispatcherServlet 等</span></span><br><span class="line">            listeners.finished(context, (Throwable)<span class="keyword">null</span>);          <span class="comment">// 监听IOC容器上下文</span></span><br><span class="line">            stopWatch.stop();                                       <span class="comment">// 计时结束</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">                (<span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)).logStarted(<span class="keyword">this</span>.getApplicationLog(), stopWatch);</span><br><span class="line">            &#125; <span class="comment">// 停止打印日志</span></span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> context;        <span class="comment">// 返回启动成功的结果，以及返回启动消耗的时间</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handleRunFailure(context, listeners, (FailureAnalyzers)analyzers, var9);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var9);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里先从  stopWatch 开始说，在run（） 方法中，一开始创建了 StopWatch的对象实例，并调用 start() 进行启动， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">stopWatch.start();</span><br><span class="line">    </span><br><span class="line">。。。。</span><br><span class="line">stopWatch.stop();</span><br></pre></td></tr></table></figure>

<p>这里的 stopWatch 是一个观察用的表，springboot项目启动后返回的启动花费了多少秒、分的时间就是由 stopWatch() 来提供的。 </p>
<img src="http://photo.wushaopei.com/qiniu42.png" width="80%">

<p>总结： 在public ConfigurableApplicationContext run(String… args)方法中，最终返回的是自定义配置的IOC容器。</p>
<p>到这里，SpringBoot 的主启动类 Main 方法的初始化和启动过程就结束了。</p>
<p>③ 包扫描；</p>
<p>我们知道 Spring 中IOC通过 依赖注入和控制反转将被调用者Bean的创建交给<strong>Spring</strong> 代理生成，并注入到IOC容器中；而在<strong>SpringBoot</strong>中， 接口的调用必须基于<strong>SpringBoot</strong> 主启动类的同级包或子包范围内；</p>
<p>规范化的开发中需要指定好 <strong>Handler</strong> 和 <strong>dao</strong> 层的包位置，分别指定的包扫描方式为：</p>
<p><strong>控制器与业务层 :</strong></p>
<p><strong>自动扫描：</strong>  主要针对 <strong>@Controller、@Service</strong> 标注的类，该类所在包必须为主启动类所在包的子包；</p>
<p><strong>手动指定扫描：</strong>在主启动类上使用<strong>@CompomentScan(“com.mmall.handler”)</strong> 注解</p>
<p><strong>持久层：</strong> </p>
<p>方式一：使用@MapperScan</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@MapperScan(&quot;com.mmall.demo.dao&quot;)标记在主启动类上</span><br></pre></td></tr></table></figure>

<p>方式二： 使用@Mapper </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmpMapper</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">     ......................</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot原理篇</category>
      </categories>
  </entry>
  <entry>
    <title>bootstrap 入门（二）案例：浏览器博物馆</title>
    <url>/2020/04/18/bootstrap-%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8D%9A%E7%89%A9%E9%A6%86/</url>
    <content><![CDATA[<h2 id="案例：浏览器博物馆"><a href="#案例：浏览器博物馆" class="headerlink" title="案例：浏览器博物馆"></a>案例：浏览器博物馆</h2><h3 id="素材准备："><a href="#素材准备：" class="headerlink" title="素材准备："></a>素材准备：</h3>  <img src="http://photo.wushaopei.com/qiniu400.png" width="1000%">

<h4 id="案例介绍："><a href="#案例介绍：" class="headerlink" title="案例介绍："></a><strong>案例介绍：</strong></h4><ul>
<li><p>顶部导航</p>
<img src="http://photo.wushaopei.com/qiniu395.png" width="90%">
</li>
<li><p>滚动图片</p>
<img src="http://photo.wushaopei.com/qiniu396.png" width="90%">
</li>
<li><p>列表展示</p>
<img src="http://photo.wushaopei.com/qiniu397.png" width="90%">
</li>
<li><p>tab</p>
<img src="http://photo.wushaopei.com/qiniu398.png" width="90%">
</li>
<li><p>底部版权</p>
<img src="http://photo.wushaopei.com/qiniu399.png" width="90%">

</li>
</ul>
<h4 id="添加支持：js需要新增下载几个文件"><a href="#添加支持：js需要新增下载几个文件" class="headerlink" title="添加支持：js需要新增下载几个文件"></a><strong>添加支持：</strong>js需要新增下载几个文件</h4><ul>
<li>html5shiv.js 解决ie浏览器对html5支持问题 </li>
<li>respond.min.js 解决ie8对css3的media query支持问题 </li>
<li>模板改中文 lang=”zh-CN” </li>
<li>jquery-1.11.1.min.map </li>
</ul>
<h3 id="导入官方模板："><a href="#导入官方模板：" class="headerlink" title="导入官方模板："></a>导入官方模板：</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Required meta tags --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap CSS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"</span> <span class="attr">integrity</span>=<span class="string">"sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Optional JavaScript --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- jQuery first, then Popper.js, then Bootstrap JS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.slim.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="导航及下拉菜单制作"><a href="#导航及下拉菜单制作" class="headerlink" title="导航及下拉菜单制作"></a>导航及下拉菜单制作</h3><p>导航条依赖 JavaScript,响应式导航条依赖折叠（collapse） 插件class导航条的设置</p>
<p><strong>class 导航条的设置</strong> </p>
<ul>
<li>navbar 这是一个导航条</li>
<li>navbar-default 默认导航条 白色的 -inverse 黑色</li>
<li>navbar-fixed-top 让导航条固定</li>
<li>container 导航条居中</li>
<li>container-fluid : 自适应显示</li>
</ul>
<h3 id="导航条组件"><a href="#导航条组件" class="headerlink" title="导航条组件"></a>导航条组件</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-default"</span> <span class="attr">role</span>=<span class="string">"navigation"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar-header"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"navbar-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">data-target</span>=<span class="string">"#example-navbar-collapse"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>切换导航<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>菜鸟教程<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse"</span> <span class="attr">id</span>=<span class="string">"example-navbar-collapse"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>iOS<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>SVN<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">                    Java <span class="tag">&lt;<span class="name">b</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>jmeter<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>EJB<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Jasper Report<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"divider"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>分离的链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"divider"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>另一个分离的链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu402.png" width="90%">

<p>该组件要包裹在 <code>&lt;div class=&quot;container&quot;/&gt;</code> 标签内。</p>
<h4 id="根据需求修改："><a href="#根据需求修改：" class="headerlink" title="根据需求修改："></a>根据需求修改：</h4><h5 id="底色为黑色"><a href="#底色为黑色" class="headerlink" title="底色为黑色"></a>底色为黑色</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">创建一个带有黑色背景白色文本的反色的导航栏，只需要简单地向 .navbar class 添加 .navbar-inverse class 即可</span><br></pre></td></tr></table></figure>

<h5 id="固定到页面顶部"><a href="#固定到页面顶部" class="headerlink" title="固定到页面顶部"></a>固定到页面顶部</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">想要让导航栏固定在页面的顶部，请向 .navbar class 添加 class .navbar-fixed-top</span><br></pre></td></tr></table></figure>

<h5 id="固定到底部"><a href="#固定到底部" class="headerlink" title="固定到底部"></a>固定到底部</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">想要让导航栏固定在页面的底部，请向 .navbar class 添加 class .navbar-fixed-bottom</span><br></pre></td></tr></table></figure>

<h5 id="组件对齐方式"><a href="#组件对齐方式" class="headerlink" title="组件对齐方式"></a>组件对齐方式</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">使用实用工具 class .navbar-left 或 .navbar-right 向左或向右对齐导航栏中的 导航链接、表单、按钮或文本 这些组件</span><br></pre></td></tr></table></figure>

<h5 id="下拉菜单"><a href="#下拉菜单" class="headerlink" title="下拉菜单"></a>下拉菜单</h5><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">	 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">	         特点 <span class="tag">&lt;<span class="name">b</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">	 <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	 <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></span><br><span class="line">		 <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Chrome<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Firefox<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Safari<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Opera<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>IE<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	 <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意： 可以仅仅通过 data 属性 API 就能使用所有的Bootstrap 插件，无需写一行 JavaScript 代码。这是 Bootstrap 中的一等 API, 也就是你的首选方式。</p>
<h3 id="滚动图片广告"><a href="#滚动图片广告" class="headerlink" title="滚动图片广告"></a>滚动图片广告</h3><ol>
<li>Carousel是一个用于轮播内容的组件，也就是我们经常用到的滚动广告，或者滚动图片（bootstrap对于组件的实现是用data属性来实现的） </li>
<li>Carousel基本结构如下图：<code>&lt;ol&gt;&lt;/ol&gt;</code>对应轮播图下面的小点点；ol下面的div对应轮播组件内容，而组件内容中的div可通过p、h来，设置图片文字，<code>&lt;a class=&quot;btn 其他按钮类名&quot;&gt;</code>来设置有超链接的按钮，如：下载；div下面的两个<code>&lt;a&gt;</code>对应轮播的用于鼠标切换的左右按钮 ol中的<code>data-slid-to=“0”</code>表示index（即缩影）为从0开始，这里<code>&lt;li&gt;</code>的个数及li中data-slid-to=“”的编号与下面轮播内容的个数相对应 </li>
</ol>
<h4 id="Carousel轮播组件模板"><a href="#Carousel轮播组件模板" class="headerlink" title="Carousel轮播组件模板"></a>Carousel轮播组件模板</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;div id=<span class="string">"myCarousel"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"carousel slide"</span>&gt;</span><br><span class="line">    &lt;!-- 轮播（Carousel）指标 --&gt;</span><br><span class="line">    &lt;ol <span class="class"><span class="keyword">class</span></span>=<span class="string">"carousel-indicators"</span>&gt;</span><br><span class="line">        &lt;li data-target="#myCarousel" data-slide-to="0" class="active"&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li data-target="#myCarousel" data-slide-to="1"&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li data-target="#myCarousel" data-slide-to="2"&gt;&lt;/li&gt;</span><br><span class="line">    &lt;/ol&gt;   </span><br><span class="line">    &lt;!-- 轮播（Carousel）项目 --&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"carousel-inner"</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"item active"</span>&gt;</span><br><span class="line">            &lt;img src=<span class="string">"/wp-content/uploads/2014/07/slide1.png"</span> alt=<span class="string">"First slide"</span>&gt;</span><br><span class="line">            &lt;div class="carousel-caption"&gt;标题 1&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"item"</span>&gt;</span><br><span class="line">            &lt;img src=<span class="string">"/wp-content/uploads/2014/07/slide2.png"</span> alt=<span class="string">"Second slide"</span>&gt;</span><br><span class="line">            &lt;div class="carousel-caption"&gt;标题 2&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"item"</span>&gt;</span><br><span class="line">            &lt;img src=<span class="string">"/wp-content/uploads/2014/07/slide3.png"</span> alt=<span class="string">"Third slide"</span>&gt;</span><br><span class="line">            &lt;div class="carousel-caption"&gt;标题 3&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;!-- 轮播（Carousel）导航 --&gt;</span><br><span class="line">    &lt;a <span class="class"><span class="keyword">class</span></span>=<span class="string">"left carousel-control"</span> href=<span class="string">"#myCarousel"</span> role=<span class="string">"button"</span> data-slide=<span class="string">"prev"</span>&gt;</span><br><span class="line">        &lt;span class="glyphicon glyphicon-chevron-left" aria-hidden="true"&gt;&lt;/span&gt;</span><br><span class="line">        &lt;span class="sr-only"&gt;Previous&lt;/span&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">    &lt;a <span class="class"><span class="keyword">class</span></span>=<span class="string">"right carousel-control"</span> href=<span class="string">"#myCarousel"</span> role=<span class="string">"button"</span> data-slide=<span class="string">"next"</span>&gt;</span><br><span class="line">        &lt;span class="glyphicon glyphicon-chevron-right" aria-hidden="true"&gt;&lt;/span&gt;</span><br><span class="line">        &lt;span class="sr-only"&gt;Next&lt;/span&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h4 id="数据填充结果："><a href="#数据填充结果：" class="headerlink" title="数据填充结果："></a>数据填充结果：</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"myCarousel"</span> <span class="attr">class</span>=<span class="string">"carousel slide"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 轮播（Carousel）指标 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ol</span> <span class="attr">class</span>=<span class="string">"carousel-indicators"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-target</span>=<span class="string">"#myCarousel"</span> <span class="attr">data-slide-to</span>=<span class="string">"0"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-target</span>=<span class="string">"#myCarousel"</span> <span class="attr">data-slide-to</span>=<span class="string">"1"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-target</span>=<span class="string">"#myCarousel"</span> <span class="attr">data-slide-to</span>=<span class="string">"2"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ol</span>&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!-- 轮播（Carousel）项目 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"carousel-inner"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item active"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/images/chrome-big.jpg"</span> <span class="attr">alt</span>=<span class="string">"First slide"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">            	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"carousel-caption"</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Chrome<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">p</span>&gt;</span>Google Chrome，又称Google浏览器，是一个由Google（谷歌）公司开发的网页浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            		<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary"</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         	    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/images/firefox-big.jpg"</span> <span class="attr">alt</span>=<span class="string">"Second slide"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">           	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"carousel-caption"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Firefox<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">p</span>&gt;</span>Mozilla Firefox，中文名通常称为“火狐”或“火狐浏览器”，是一个开源网页浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">           		<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary"</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/images/ie-big.jpg"</span> <span class="attr">alt</span>=<span class="string">"Third slide"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">           	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"carousel-caption"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">h1</span>&gt;</span>IE<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">p</span>&gt;</span>Internet Explorer，简称 IE，是微软公司推出的一款网页浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">           		<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary"</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/images/safari-big.jpg"</span> <span class="attr">alt</span>=<span class="string">"Third slide"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">           	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"carousel-caption"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Safari<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">p</span>&gt;</span>Safari，是苹果计算机的最新操作系统Mac OS X中的浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">           		<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary"</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/images/opera-big.jpg"</span> <span class="attr">alt</span>=<span class="string">"Third slide"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">           	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"carousel-caption"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Opera<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">p</span>&gt;</span>Opera浏览器，是一款挪威Opera Software ASA公司制作的支持多页面标签式浏览的网络浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">           		<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary"</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span>	  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 轮播（Carousel）导航 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"left carousel-control"</span> <span class="attr">href</span>=<span class="string">"#myCarousel"</span> <span class="attr">role</span>=<span class="string">"button"</span> <span class="attr">data-slide</span>=<span class="string">"prev"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-chevron-left"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"right carousel-control"</span> <span class="attr">href</span>=<span class="string">"#myCarousel"</span> <span class="attr">role</span>=<span class="string">"button"</span> <span class="attr">data-slide</span>=<span class="string">"next"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-chevron-right"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="样式处理："><a href="#样式处理：" class="headerlink" title="样式处理："></a>样式处理：</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 限制轮播组件的高度、默认背景色、</span></span><br><span class="line">		.carousel &#123;</span><br><span class="line">			height: <span class="number">500</span>px;</span><br><span class="line">			background-color: #000;</span><br><span class="line">			margin-bottom: <span class="number">60</span>px;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 限制轮播图片的高度、默认背景色</span></span><br><span class="line">		.carousel .item&#123;</span><br><span class="line">			height: <span class="number">500</span>px;</span><br><span class="line">			background-color: #000;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 轮播图片的缩放、填满</span></span><br><span class="line">		.carousel .img&#123;</span><br><span class="line">			width: <span class="number">100</span>%; <span class="comment">//  设置宽度100%，让图片自动缩放填满页面</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 轮播图片内文字样式</span></span><br><span class="line">		.carousel-caption p &#123;</span><br><span class="line">			margin-bottom: <span class="number">20</span>px;</span><br><span class="line">			font-size:<span class="number">20</span>px;</span><br><span class="line">			line-height: <span class="number">1.8</span>;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p><strong>最终效果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu401.png" width="90%">

<h3 id="栅格系统布局"><a href="#栅格系统布局" class="headerlink" title="栅格系统布局"></a>栅格系统布局</h3><p>模板引入：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">      One of three columns</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">      One of three columns</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">      One of three columns</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>布局分析：</strong></p>
<ul>
<li>行（row）必须含在.container（固定宽度）或.cotainer-fluid（100%宽度）中 </li>
<li>使用.col-md-*栅格类，就可以创建一个基本的栅格系统，在手机和平板设备上一开始是堆叠在一起的，在桌面（&gt;970px）屏幕设备上变为水平排列。 </li>
</ul>
<h4 id="数据填充结果：-1"><a href="#数据填充结果：-1" class="headerlink" title="数据填充结果："></a>数据填充结果：</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"summary-container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">	  	<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"img-circle"</span> <span class="attr">src</span>=<span class="string">"/images/chrome-logo-small.jpg"</span> <span class="attr">alt</span>=<span class="string">"First slide"</span>&gt;</span></span><br><span class="line">	 	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Chrome<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">	 	<span class="tag">&lt;<span class="name">p</span>&gt;</span>Google Chrome，又称Google浏览器，是一个由Google（谷歌）公司开发的网页浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">         	<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">href</span>=<span class="string">""</span>  <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">   		<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"img-circle"</span> <span class="attr">src</span>=<span class="string">"/images/firefox-logo-small.jpg"</span> <span class="attr">alt</span>=<span class="string">"Second slide"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Firefox<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>Mozilla Firefox，中文名通常称为“火狐”或“火狐浏览器”，是一个开源网页浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"img-circle"</span> <span class="attr">src</span>=<span class="string">"/images/safari-logo-small.jpg"</span> <span class="attr">alt</span>=<span class="string">"Third slide"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Safari<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>Safari，是苹果计算机的最新操作系统Mac OS X中的浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">         	<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">href</span>=<span class="string">""</span>  <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>点我下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>样式处理：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 让三栏布局居中显示  */</span></span><br><span class="line">#summary-container .col-md-4&#123;</span><br><span class="line">	text-align: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="标签页"><a href="#标签页" class="headerlink" title="标签页"></a>标签页</h3><p>标签页：可以放置很多的内容，又可以节省页面空间。其基本结构：标签页放在栅格的container内用横线将标签页与栅格分开 </p>
<p>标签</p>
<p><code>&lt;ul class=&quot;nav nav-tabs&quot; role=&quot;tablist&quot;&gt; &lt;li&gt;&lt;a hre=&quot;#下方的id&quot; role=&quot;tab&quot; data-toggle=&quot;tab&quot;&gt;&lt;/a&gt;&lt;/li&gt; ... &lt;/ul&gt;</code></p>
<p> 那么点击标签打开相应内容设置如下： </p>
<p>标签内容</p>
<p> <code>&lt;div class=&quot;tab-content&quot;&gt; &lt;div class=&quot;tab-pane&quot; id=&quot;&quot;&gt;...&lt;/div&gt;（此处的id与上面标签的a href=“”对应） ... &lt;/div&gt;</code></p>
<p>标签内容的排版也可以用栅格，使其错落有致，可自己为标题，文字设置颜色，字体大小； .container .row是指container类下的row类</p>
<p> <a href="http://img1.sycdn.imooc.com/554d7c660001a78412000530-120-68.jpg" target="_blank" rel="noopener">http://img1.sycdn.imooc.com/554d7c660001a78412000530-120-68.jpg</a> </p>
<p><strong>标签页代码：</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"tab-list"</span> <span class="attr">class</span>=<span class="string">"nav nav-tabs"</span> <span class="attr">role</span>=<span class="string">"tablist"</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#tab-chrome"</span> <span class="attr">role</span>=<span class="string">"tab"</span> <span class="attr">data-toggle</span>=<span class="string">"tab"</span>&gt;</span>Chrome<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#tab-firefox"</span> <span class="attr">role</span>=<span class="string">"tab"</span> <span class="attr">data-toggle</span>=<span class="string">"tab"</span>&gt;</span>Firefox<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#tab-safari"</span> <span class="attr">role</span>=<span class="string">"tab"</span> <span class="attr">data-toggle</span>=<span class="string">"tab"</span>&gt;</span>Safari<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#tab-opera"</span> <span class="attr">role</span>=<span class="string">"tab"</span> <span class="attr">data-toggle</span>=<span class="string">"tab"</span>&gt;</span>Opera<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#tab-ie"</span> <span class="attr">role</span>=<span class="string">"tab"</span> <span class="attr">data-toggle</span>=<span class="string">"tab"</span>&gt;</span>IE<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"myTabContent"</span> <span class="attr">class</span>=<span class="string">"tab-content"</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tab-pane fade in active"</span> <span class="attr">id</span>=<span class="string">"tab-chrome"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row feature"</span> <span class="attr">id</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"feature-heading"</span>&gt;</span>Google Chrome <span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>使用最广的浏览器<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"lead"</span>&gt;</span>Google Chrome，又称Google浏览器，是一个由Google（谷歌）公司开发的网页浏览器。</span><br><span class="line">                       该浏览器是基于其他开源软件所撰写，包括WebKit，目标是提升稳定性、速度和安全性，并创造出简单且有效率的使用者界面。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-5"</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"feature-image img-responsive"</span> <span class="attr">src</span>=<span class="string">"/images/chrome-logo.jpg"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">alt</span>=<span class="string">"Chrome"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tab-pane "</span> <span class="attr">id</span>=<span class="string">"tab-firefox"</span>&gt;</span></span><br><span class="line">	       <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row feature"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-5"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"feature-image img-responsive"</span> <span class="attr">src</span>=<span class="string">"/images/firefox-logo.jpg"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">alt</span>=<span class="string">"Firefox"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"feature-heading"</span>&gt;</span>Mozilla Firefox <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>美丽的狐狸<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"lead"</span>&gt;</span>Mozilla Firefox，中文名通常称为“火狐”或“火狐浏览器”，是一个开源网页浏览器，</span><br><span class="line">                        使用Gecko引擎（非ie内核），支持多种操作系统如Windows、Mac和linux。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tab-pane "</span> <span class="attr">id</span>=<span class="string">"tab-safari"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row feature"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"feature-heading"</span>&gt;</span>Safari <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>Mac用户首选<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"lead"</span>&gt;</span>Safari，是苹果计算机的最新操作系统Mac OS X中的浏览器，使用了KDE的KHTML作为浏览器的运算核心。</span><br><span class="line">                        Safari在2003年1月7日首度发行测试版，并成为Mac OS X v10.3与之后的默认浏览器，也是iPhone与IPAD和iPod touch的指定浏览器。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-5"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"feature-image img-responsive"</span> <span class="attr">src</span>=<span class="string">"/images/safari-logo.jpg"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">alt</span>=<span class="string">"Safari"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tab-pane"</span> <span class="attr">id</span>=<span class="string">"tab-opera"</span>&gt;</span>			</span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row feature"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-5"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"feature-image img-responsive"</span> <span class="attr">src</span>=<span class="string">"/images/opera-logo.jpg"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">alt</span>=<span class="string">"Opera"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"feature-heading"</span>&gt;</span>Opera <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>小众但易用<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"lead"</span>&gt;</span>Opera浏览器，是一款挪威Opera Software ASA公司制作的支持多页面标签式浏览的网络浏览器。</span><br><span class="line">                        是跨平台浏览器可以在Windows、Mac和Linux三个操作系统平台上运行。.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tab-pane"</span> <span class="attr">id</span>=<span class="string">"tab-ie"</span>&gt;</span></span><br><span class="line">	    	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row feature"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"feature-heading"</span>&gt;</span>IE <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>你懂的<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"lead"</span>&gt;</span>Internet Explorer，原称Microsoft Internet Explorer(6版本以前)和Windows Internet</span><br><span class="line">                        Explorer(7，8，9，10版本)，</span><br><span class="line">                        简称IE，是美国微软公司推出的一款网页浏览器。它采用的排版引擎(俗称内核)为Trident。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-5"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"feature-image img-responsive"</span> <span class="attr">src</span>=<span class="string">"/images/ie-logo.jpg"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">alt</span>=<span class="string">"IE"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">		</span><br><span class="line"><span class="javascript">		$(<span class="string">"#example-navbar-collapse .dropdown-menu a"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> href = $(<span class="keyword">this</span>).attr(<span class="string">"href"</span>);</span></span><br><span class="line">			</span><br><span class="line"><span class="javascript">			$(<span class="string">"#tab-list a[href='"</span>+ href +<span class="string">"']"</span>).tab(<span class="string">'show'</span>);</span></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>这里要注意几个点：</strong></p>
<p>点击标签名通过对应的 id  去 show 展开标签内容，要注意每个标签页的id必须正确；其次，在菜单下拉组中也要进行相应的 id 的配置；</p>
<p><strong>关键：</strong> 动态展示标签页需要通过 js 代码来实现。</p>
<h4 id="弹出模态框："><a href="#弹出模态框：" class="headerlink" title="弹出模态框："></a>弹出模态框：</h4><p>对弹出框启动项添加data-toggle=”modal”(组件名称);data-target=”弹出框的ID”。 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Modal --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal fade"</span> <span class="attr">id</span>=<span class="string">"exampleModal"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span> <span class="attr">aria-labelledby</span>=<span class="string">"exampleModalLabel"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></span><br><span class="line">		      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></span><br><span class="line">		        <span class="tag">&lt;<span class="name">h5</span> <span class="attr">class</span>=<span class="string">"modal-title"</span> <span class="attr">id</span>=<span class="string">"exampleModalLabel"</span>&gt;</span>关于<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">		        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span></span><br><span class="line">		          <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">		        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">		      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">		        <span class="tag">&lt;<span class="name">p</span>&gt;</span>慕课网隶属于北京慕课科技中心(有限合伙)，是一家从事互联网免费教学的网络教育公司。秉承“开拓、创新、公平、分享”的精神，</span><br><span class="line">                        将互联网特性全面的应用在教育领域，致力于为教育机构及求学者打造一站式互动在线教育品牌。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-footer"</span>&gt;</span></span><br><span class="line">		        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-secondary"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>Close<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">		      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>设置id :</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#exampleModal"</span> &gt;</span>关于<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>mybatis-映射器（十二）resultMap结果映射集 - 级联</title>
    <url>/2020/04/28/mybatis-%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89resultMap%E7%BB%93%E6%9E%9C%E6%98%A0%E5%B0%84%E9%9B%86-%E7%BA%A7%E8%81%94/</url>
    <content><![CDATA[<h3 id="案例表结构设计："><a href="#案例表结构设计：" class="headerlink" title="案例表结构设计："></a>案例表结构设计：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET FOREIGN_KEY_CHECKS&#x3D;0;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for t_role</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;t_role&#96;;</span><br><span class="line">CREATE TABLE &#96;t_role&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL,</span><br><span class="line">  &#96;role_name&#96; varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;gbk;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of t_role</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO &#96;t_role&#96; VALUES (&#39;1&#39;, &#39;用户&#39;);</span><br><span class="line">INSERT INTO &#96;t_role&#96; VALUES (&#39;2&#39;, &#39;管理员&#39;);</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for t_user</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;t_user&#96;;</span><br><span class="line">CREATE TABLE &#96;t_user&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL,</span><br><span class="line">  &#96;last_name&#96; varchar(50) DEFAULT NULL,</span><br><span class="line">  &#96;sex&#96; int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;gbk;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of t_user</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO &#96;t_user&#96; VALUES (&#39;1&#39;, &#39;jetty&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;t_user&#96; VALUES (&#39;2&#39;, &#39;kai&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;t_user&#96; VALUES (&#39;3&#39;, &#39;tom&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;t_user&#96; VALUES (&#39;4&#39;, &#39;lili&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;t_user&#96; VALUES (&#39;5&#39;, &#39;jete&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;t_user&#96; VALUES (&#39;6&#39;, &#39;kk&#39;, &#39;0&#39;);</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for t_user_role</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;t_user_role&#96;;</span><br><span class="line">CREATE TABLE &#96;t_user_role&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL,</span><br><span class="line">  &#96;user_id&#96; int(11) NOT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;gbk;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of t_user_role</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO &#96;t_user_role&#96; VALUES (&#39;1&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;t_user_role&#96; VALUES (&#39;2&#39;, &#39;2&#39;);</span><br><span class="line">INSERT INTO &#96;t_user_role&#96; VALUES (&#39;1&#39;, &#39;3&#39;);</span><br><span class="line">INSERT INTO &#96;t_user_role&#96; VALUES (&#39;1&#39;, &#39;4&#39;);</span><br><span class="line">INSERT INTO &#96;t_user_role&#96; VALUES (&#39;2&#39;, &#39;5&#39;);</span><br><span class="line">INSERT INTO &#96;t_user_role&#96; VALUES (&#39;2&#39;, &#39;6&#39;);</span><br></pre></td></tr></table></figure>

<h3 id="级联关系的定义"><a href="#级联关系的定义" class="headerlink" title="级联关系的定义"></a>级联关系的定义</h3><p>在数据库中包含着一对多、一对一的关系，比方说一个角色可以分配给多个用户，也可以只分配给一个用户。有时候我们希望角色信息和用户信息一起显示出来，这个是很常见的场景，所以会经常遇见这样的 SQL ，代码如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	r.*, u.*</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	t_role r</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> t_user_role ur <span class="keyword">ON</span> r.id = ur.id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> t_user u <span class="keyword">ON</span> ur.user_id = u.id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	r.id = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>​    这里的查询是把角色和用户的信息都查询出来，我们希望的是在角色的信息中多一个属性，即 List<User> userList 这样取出 Role 的同时也可以访问到它下面的用户了。我们把这样的情况叫做级联。</p>
<p>​    在级联中存在3 中对应关系。</p>
<p>​    <strong>其一， 一对多的关系</strong>，如角色与用户的关系。举个通俗的例子，一家软件公司存在许多软件工程师，公司和软件工程师就是一对多的关系。</p>
<p>​    <strong>其二，一对一的关系。</strong> 例如每个软件工程师都有一个编号（ID) ，这就是它在软件公司的标识，它与工程师是一对一的关系。</p>
<p>​    <strong>其三，多对多的关系。</strong> 例如，有些公司一个角色可以对应多个用户，但是一个用户也可以兼任多个角色。通俗而言，一个人可以既是总经理，同时也是技术总监，而技术总监这个职位可以对应多个人，这就是多对多的关系。</p>
<p>​    所以在 MyBatis 中级联分为这么 3 种： association、collection 和 discriminator，下面分别介绍下：</p>
<ul>
<li>association : 代表一对一关系，比如中国公民和身份证是一对一的关系；</li>
<li>collection : 代表一对多关系，比如班级和学生是一对多的关系，一个班级可以有多个学生；</li>
<li>discriminator，是鉴别去，它可以根据选择采用哪个类作为实例，允许你根据特定的调价年轻关联不同的结果集。比如，人有男人和女人。你可以实例化一个人的对象，但是要根据情况用男人类或者用女人类去实例化。</li>
</ul>
<img src="http://photo.wushaopei.com/479.png" width="80%">

<h3 id="association-一对一级联"><a href="#association-一对一级联" class="headerlink" title="association 一对一级联"></a>association 一对一级联</h3><p>​    银行保险柜的钥匙与锁，在不考虑备用钥匙的情况下，一把锁只能对应一把钥匙。我们这里使用锁与钥匙的关系来构建一对一级联的案例。</p>
<p>​    这里需要先建立一个 锁Lock 表和 钥匙 key 表 ，以及对应的 POJO 对象。那么在 Key 的 POJO 我们应该又一个类型为 LockBean 的属性 Lock，这样便形成了级联。</p>
<h4 id="数据库清单如下："><a href="#数据库清单如下：" class="headerlink" title="数据库清单如下："></a>数据库清单如下：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 一对一数据表</span><br><span class="line">## 创建锁表</span><br><span class="line">create table t_lock(</span><br><span class="line">	&#96;id&#96; int primary key auto_increment,</span><br><span class="line">	&#96;name&#96; varchar(50)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">## 创建钥匙表</span><br><span class="line">create table t_key(</span><br><span class="line">	&#96;id&#96; int primary key auto_increment,</span><br><span class="line">	&#96;name&#96; varchar(50),</span><br><span class="line">	&#96;lock_id&#96; int ,</span><br><span class="line">	foreign key(&#96;lock_id&#96;) references t_lock(&#96;id&#96;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">## 插入初始化数据</span><br><span class="line">insert into t_lock(&#96;name&#96;) values(&#39;阿里巴巴&#39;);</span><br><span class="line">insert into t_lock(&#96;name&#96;) values(&#39;华为&#39;);</span><br><span class="line">insert into t_lock(&#96;name&#96;) values(&#39;联想&#39;);</span><br><span class="line"></span><br><span class="line">insert into t_key(&#96;name&#96;,&#96;lock_id&#96;) values(&#39;马云&#39;,1);</span><br><span class="line">insert into t_key(&#96;name&#96;,&#96;lock_id&#96;) values(&#39;任正非&#39;,2);</span><br><span class="line">insert into t_key(&#96;name&#96;,&#96;lock_id&#96;) values(&#39;柳传志&#39;,3);</span><br></pre></td></tr></table></figure>

<h4 id="POJO清单如下："><a href="#POJO清单如下：" class="headerlink" title="POJO清单如下："></a>POJO清单如下：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lock</span> </span>&#123;	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Lock</span><span class="params">(Integer id, String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String name;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Key</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Key</span><span class="params">(Integer id, String name,Lock lock)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">		<span class="keyword">this</span>.lock = lock;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> Lock lock;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这时候我们需要建立 Key 的映射器 KeyMapper.xml 。而在 KeyMapper.xml 中我们提供了一个 queryKeyByIdForSample 的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyMapper</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Key <span class="title">queryKeyByIdForSample</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>queryKeyByIdForSample 方法中引入了 一个结果映射集： queryKeyByIdForSample_resultMap </p>
<h4 id="普通的一对一关联"><a href="#普通的一对一关联" class="headerlink" title="普通的一对一关联"></a>普通的一对一关联</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">  		namespace名称空间</span></span><br><span class="line"><span class="comment">  		取值一般有两种情况：</span></span><br><span class="line"><span class="comment">  			一种情况是：使用javaBean的全类名</span></span><br><span class="line"><span class="comment">  			二种情况是：使用Mapper接口的全类名</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.webcode.association.mapper.KeyMapper"</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">		resultMap可以自定义结果集</span></span><br><span class="line"><span class="comment">			type属性设置你要封装成为什么类型返回</span></span><br><span class="line"><span class="comment">			id属性给resultMap集合集起一个唯一的标识</span></span><br><span class="line"><span class="comment">	 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"com.webcode.association.entity.Key"</span> <span class="attr">id</span>=<span class="string">"queryKeyByIdForSample_resultMap"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- id标签负责把数据库的主键列。转到对象的id属性中</span></span><br><span class="line"><span class="comment">				column是列名</span></span><br><span class="line"><span class="comment">				property是属性名</span></span><br><span class="line"><span class="comment">				把列名的值，注入到property属性指向的属性中</span></span><br><span class="line"><span class="comment">		 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 非主键列使用result标签 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">			级联映射</span></span><br><span class="line"><span class="comment">				一级一级的关联</span></span><br><span class="line"><span class="comment">		 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"lock_id"</span> <span class="attr">property</span>=<span class="string">"lock.id"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"lock_name"</span> <span class="attr">property</span>=<span class="string">"lock.name"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span> </span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 	public Key queryKeyByIdForSample(Integer id); --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryKeyByIdForSample"</span> <span class="attr">resultMap</span>=<span class="string">"queryKeyByIdForSample_resultMap"</span>&gt;</span></span><br><span class="line">		select </span><br><span class="line">			t_key.* ,t_lock.name lock_name</span><br><span class="line">		from </span><br><span class="line">			t_key left join t_lock</span><br><span class="line">		on </span><br><span class="line">			t_key.lock_id = t_lock.id</span><br><span class="line">		where </span><br><span class="line">			t_key.id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    除了以上这种普通的直接在 resultMap 中进行配置的一对一关联，还有本节主要讲解的重点，使用你 <strong>&lt;association</strong> <strong>/</strong>&gt; 标签来实现嵌套结果集映射配置。</p>
<h3 id="lt-association-gt-嵌套结果集映射配置"><a href="#lt-association-gt-嵌套结果集映射配置" class="headerlink" title="&lt;association /&gt;嵌套结果集映射配置"></a><strong>&lt;association</strong> /&gt;嵌套结果集映射配置</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"com.webcode.association.entity.Key"</span> <span class="attr">id</span>=<span class="string">"queryKeyByIdForSample_association_resultMap"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 非主键列使用result标签 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- association标签可以把查询的结果映射成为一个子对象</span></span><br><span class="line"><span class="comment">			property="lock"	你要映射哪个子对象</span></span><br><span class="line"><span class="comment">			javaType 是说明你要映射出来的子对象是什么类型</span></span><br><span class="line"><span class="comment">	 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"lock"</span> <span class="attr">javaType</span>=<span class="string">"com.webcode.association.entity.Lock"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- id给主键进行配置 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"lock_id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- result给非主键列进行配置 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"lock_name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">association</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 	public Key queryKeyByIdForSample(Integer id); --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryKeyByIdForSample"</span> <span class="attr">resultMap</span>=<span class="string">"queryKeyByIdForSample_association_resultMap"</span>&gt;</span></span><br><span class="line">	select </span><br><span class="line">		t_key.* ,t_lock.name lock_name</span><br><span class="line">	from </span><br><span class="line">		t_key left join t_lock</span><br><span class="line">	on </span><br><span class="line">		t_key.lock_id = t_lock.id</span><br><span class="line">	where </span><br><span class="line">		t_key.id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    在上面的代码中，通过一次关联，并且是一次性在 <code>&lt;/association&gt;</code> 标签中将  Lock 进行关联处理问题。这里对于嵌套的另一张表的数据需要在 <code>&lt;/association&gt;</code> 标签中正对每一个  column 进行配置 对应的 property 。 在 Select 中直接通过 引用指定的 resultMap 的 id 来对已经处理好的映射集进行调用。</p>
<p>​    resultMap 中使用   <code>&lt;/association&gt;</code>  处理关联表的操作除了以上的一步的方式操作以外，还可以使用分两步操作的方式，具体代码如下：</p>
<h4 id="lt-association-gt-定义分步（立即）查询"><a href="#lt-association-gt-定义分步（立即）查询" class="headerlink" title="&lt;association /&gt;定义分步（立即）查询"></a><strong>&lt;association /</strong>&gt;定义分步（立即）查询</h4><p>KeyMapper接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyMapper</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 分两次查，只查key</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Key <span class="title">queryKeyByIdForTwoStep</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LockMapper接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LockMapper</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 只查锁</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Lock <span class="title">queryLockById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LockMapper配置信息：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.webcode.mapper.LockMapper"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 	public Lock queryLockById(Integer id);</span></span><br><span class="line"><span class="comment">			第二次查，只查锁的情况</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryLockById"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.pojo.Lock"</span>&gt;</span></span><br><span class="line">		select id,name from t_lock where id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>KeyMapper的配置信息：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;resultMap type=<span class="string">"com.webcode.pojo.Key"</span> id=<span class="string">"queryKeyByIdForTwoStep_resultMap"</span>&gt;</span><br><span class="line">		&lt;id column=<span class="string">"id"</span> property=<span class="string">"id"</span>/&gt;</span><br><span class="line">		&lt;result column=<span class="string">"name"</span> property=<span class="string">"name"</span>/&gt;</span><br><span class="line">		&lt;!-- </span><br><span class="line">			association需要配置当前的这个子对象是使用一次查询得到</span><br><span class="line">				property=<span class="string">"lock"</span>	表示当前要配置哪个子对象</span><br><span class="line">				select表示你要使用哪个查询来得到这个子对象(需要一个参数)</span><br><span class="line">				column表示你要将原查询结果的哪个列做为参数传递给下一个查询使用。</span><br><span class="line">		 --&gt;</span><br><span class="line">		&lt;association property=<span class="string">"lock"</span> column=<span class="string">"lock_id"</span></span><br><span class="line">			select=<span class="string">"com.webcode.mapper.LockMapper.queryLockById"</span>/&gt;</span><br><span class="line">	&lt;/resultMap&gt;</span><br><span class="line">	&lt;!-- 	分两次查，只查key</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Key <span class="title">queryKeyByIdForTwoStep</span><span class="params">(Integer id)</span></span>; --&gt;</span><br><span class="line">	&lt;select id=<span class="string">"queryKeyByIdForTwoStep"</span> resultMap=<span class="string">"queryKeyByIdForTwoStep_resultMap"</span>&gt;</span><br><span class="line">		select id,name,lock_id from t_key where id = #&#123;id&#125;</span><br><span class="line">	&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的分布查询中，通过了一次关联，分两步查询的方式来处理问题。其中 select 元素由指定的 SQL 去查询， 而 column 则指定传递给 select 语句的参数。这里是 Key 对象的 id 。 当取出 Key 的时候， MyBatis 就会知道用下面的 SQL 取出我们需要的 级联信息。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">com.webcode.mapper.LockMapper.queryLockById</span><br></pre></td></tr></table></figure>

<p>其中参数是 Key 的 id 值，通过 column 配置，如果是多个参数，则用逗号分隔。以下对代码进行测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">		SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">			KeyMapper keyMapper = sqlSession.getMapper(KeyMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//			Key key = keyMapper.queryKeyByIdForSample(1);</span></span><br><span class="line">			Key key = keyMapper.queryKeyByIdForTwoStep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">			System.out.println(key);</span><br><span class="line">			sqlSession.commit();			</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">			System.err.println(ex.getMessage());</span><br><span class="line">			sqlSession.rollback();</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">				sqlSession.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>运行程序打印：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Logging initialized using <span class="string">'class org.apache.ibatis.logging.log4j.Log4jImpl'</span> adapter.</span><br><span class="line"> INFO [main] - 定制属性： &#123;someProperty=<span class="number">100</span>&#125;</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection <span class="number">1848415041</span>.</span><br><span class="line">DEBUG [main] - Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">6e2</span>c9341]</span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: select id,name,lock_id from t_key where id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - ====&gt;  Preparing: select id,name from t_lock where id = ? </span><br><span class="line">DEBUG [main] - ====&gt; Parameters: <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG [main] - &lt;====      Total: <span class="number">1</span></span><br><span class="line">DEBUG [main] - &lt;==      Total: <span class="number">1</span></span><br><span class="line">Key(id=<span class="number">1</span>, name=马云, lock=Lock(id=<span class="number">1</span>, name=阿里巴巴))</span><br><span class="line">DEBUG [main] - Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">6e2</span>c9341]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">6e2</span>c9341]</span><br><span class="line">DEBUG [main] - Returned connection <span class="number">1848415041</span> to pool.</span><br></pre></td></tr></table></figure>

<p>​    从执行结果可以看到，在整个执行过程中，它先查询出 t_key 的信息，然后根据其 id 查询出 t_lock 的信息，而参数是 Key 对象的 id 值。这样当我们查找到了 Key 对象的时候，便能把其对应的 Lock 的信息也同时取到，这便是一对一的级联。</p>
<h3 id="collection-一对多级联"><a href="#collection-一对多级联" class="headerlink" title="collection 一对多级联"></a>collection 一对多级联</h3><p>​    这是一个一对多的级联，一个班级钟可能有多个学生。这里有一个级联，这是一对多的关系。一对多的级联我们使用的是 collection .</p>
<p>​    这里我们建立两个 POJO 来记录 学生和班级，班级使用 Clazz 来标识，学生使用 Student 来标识。具体代码如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"student"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(Integer id, String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"clazz"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Clazz</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Clazz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Clazz</span><span class="params">(Integer id, String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Student&gt; stus;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    Clazz 中包含一 个   <code>List&lt;Student&gt;</code> 属性用来保存 学生信息。 这里使用 collection 级联来进行配置映射结果集，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"com.webcode.collection.entity.Clazz"</span> <span class="attr">id</span>=<span class="string">"queryClazzByIdForSimple_resultMap"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">			collection标签用来映射子集合=====&gt;&gt;&gt;&gt;private List&lt;Student&gt; stus;</span></span><br><span class="line"><span class="comment">				property属性你要映射哪个属性</span></span><br><span class="line"><span class="comment">				ofType属性配置集合中每个元素的具体类型</span></span><br><span class="line"><span class="comment">		 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"stus"</span> <span class="attr">ofType</span>=<span class="string">"com.webcode.collection.entity.Student"</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- id标签用来配置主键列，可以去重 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"stu_id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"stu_name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 	public Clazz queryClazzByIdForSimple(Integer id); --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryClazzByIdForSimple"</span> <span class="attr">resultMap</span>=<span class="string">"queryClazzByIdForSimple_resultMap"</span>&gt;</span></span><br><span class="line">		select </span><br><span class="line">			t_clazz.*,t_student.id stu_id,t_student.name stu_name,t_student.clazz_id</span><br><span class="line">		from </span><br><span class="line">			t_clazz left join t_student</span><br><span class="line">		on </span><br><span class="line">			t_clazz.id = t_student.clazz_id</span><br><span class="line">		where </span><br><span class="line">			t_clazz.id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ClazzMapper接口方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一次全部查询出来</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Clazz <span class="title">queryClazzByIdForSimple</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">	ClazzMapper clazzMapper = sqlSession.getMapper(ClazzMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">	Clazz clazz = clazzMapper.queryClazzByIdForSimple(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	System.out.println(clazz);</span><br><span class="line">	sqlSession.commit();			</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">	System.err.println(ex.getMessage());</span><br><span class="line">	sqlSession.rollback();</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>)&#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;sqlSession = SqlSessionFactoryUtil.openSqlSession();</span><br><span class="line">	ClazzMapper clazzMapper = sqlSession.getMapper(ClazzMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">	Clazz clazz = clazzMapper.queryClazzByIdForSimple(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><strong>执行获得测试结果：</strong>  </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">DEBUG [main] - Logging initialized using 'class org.apache.ibatis.logging.log4j.Log4jImpl' adapter.</span><br><span class="line"> INFO [main] - 定制属性： &#123;someProperty=100&#125;</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection 124407148.</span><br><span class="line">DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@76a4d6c]</span><br><span class="line">DEBUG [main] - ==&gt;  Preparing: select t_clazz.*,t_student.id stu_id,t_student.name stu_name,t_student.clazz_id from t_clazz left join t_student on t_clazz.id = t_student.clazz_id where t_clazz.id = ? </span><br><span class="line">DEBUG [main] - ==&gt; Parameters: 1(Integer)</span><br><span class="line">DEBUG [main] - <span class="tag">&lt;<span class="name">==</span>      <span class="attr">Total:</span> <span class="attr">3</span></span></span><br><span class="line"><span class="tag"><span class="attr">Clazz</span>(<span class="attr">id</span>=<span class="string">1,</span> <span class="attr">name</span>=<span class="string">javaEE20170228,</span> <span class="attr">stus</span>=<span class="string">[Student(id</span>=<span class="string">1,</span> <span class="attr">name</span>=<span class="string">stu0228_1),</span> <span class="attr">Student</span>(<span class="attr">id</span>=<span class="string">2,</span> <span class="attr">name</span>=<span class="string">stu0228_2),</span> <span class="attr">Student</span>(<span class="attr">id</span>=<span class="string">3,</span> <span class="attr">name</span>=<span class="string">stu0228_3)])</span></span></span><br><span class="line"><span class="tag"><span class="attr">DEBUG</span> [<span class="attr">main</span>] <span class="attr">-</span> <span class="attr">Resetting</span> <span class="attr">autocommit</span> <span class="attr">to</span> <span class="attr">true</span> <span class="attr">on</span> <span class="attr">JDBC</span> <span class="attr">Connection</span> [<span class="attr">com.mysql.cj.jdbc.ConnectionImpl</span>@<span class="attr">76a4d6c</span>]</span></span><br><span class="line"><span class="tag"><span class="attr">DEBUG</span> [<span class="attr">main</span>] <span class="attr">-</span> <span class="attr">Closing</span> <span class="attr">JDBC</span> <span class="attr">Connection</span> [<span class="attr">com.mysql.cj.jdbc.ConnectionImpl</span>@<span class="attr">76a4d6c</span>]</span></span><br><span class="line"><span class="tag"><span class="attr">DEBUG</span> [<span class="attr">main</span>] <span class="attr">-</span> <span class="attr">Returned</span> <span class="attr">connection</span> <span class="attr">124407148</span> <span class="attr">to</span> <span class="attr">pool.</span></span></span><br></pre></td></tr></table></figure>

<p>我们成功打印出来班级 Clazz 中学生的信息 stus ， 这里通过班级的 id （即 clazz_id)去查询到对应的学生的信息。从而获得当前班级中所有的学生的信息。</p>
<h4 id="一对多，分步查询懒加载"><a href="#一对多，分步查询懒加载" class="headerlink" title="一对多，分步查询懒加载"></a><strong>一对多，分步查询懒加载</strong></h4><p><strong>映射器配置关系：</strong> </p>
<p>ClazzMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"com.webcode.collection.entity.Clazz"</span> <span class="attr">id</span>=<span class="string">"queryClazzByIdForTwoStep_resultMap"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">		collection映射子的集合属性</span></span><br><span class="line"><span class="comment">			property="stus"	设置当前要配置（封装）哪个集合</span></span><br><span class="line"><span class="comment">			select属性配置使用哪个查询得到这个集合</span></span><br><span class="line"><span class="comment">			column属性将某个列做为查询语句的参数使用</span></span><br><span class="line"><span class="comment">	 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"stus"</span> <span class="attr">column</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">select</span>=<span class="string">"com.webcode.association.mapper.StudentMapper.queryStudentByClazzId"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 	public Clazz queryClazzByIdForTwoStep(Integer id); --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryClazzByIdForTwoStep"</span> <span class="attr">resultMap</span>=<span class="string">"queryClazzByIdForTwoStep_resultMap"</span>&gt;</span></span><br><span class="line">	select id,name from t_clazz where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>StudentMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 	public List&lt;Student&gt; queryStudentByClazzId(Integer clazzId); --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryStudentByClazzId"</span> <span class="attr">resultType</span>=<span class="string">"com.webcode.collection.entity.Student"</span>&gt;</span></span><br><span class="line">	select id,name from t_student where clazz_id = #&#123;clazzId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>对应Mapper映射调用接口：</strong></p>
<p>ClazzMapper接口方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClazzMapper</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 分两次查，这边只查班级</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Clazz <span class="title">queryClazzByIdForTwoStep</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StudentMapper接口方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentMapper</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 只查学生，</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Student&gt; <span class="title">queryStudentByClazzId</span><span class="params">(Integer clazzId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行测试："><a href="#执行测试：" class="headerlink" title="执行测试："></a>执行测试：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">	DEBUG [main] - Logging initialized using &#39;class org.apache.ibatis.logging.log4j.Log4jImpl&#39; adapter.</span><br><span class="line"> INFO [main] - 定制属性： &#123;someProperty&#x3D;100&#125;</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - PooledDataSource forcefully closed&#x2F;removed all connections.</span><br><span class="line">DEBUG [main] - Opening JDBC Connection</span><br><span class="line">DEBUG [main] - Created connection 852445367.</span><br><span class="line">DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@32cf48b7]</span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt;  Preparing: select id,name from t_clazz where id &#x3D; ? </span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&#x3D;&#x3D;&gt;  Preparing: select id,name from t_student where clazz_id &#x3D; ? </span><br><span class="line">DEBUG [main] - &#x3D;&#x3D;&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">DEBUG [main] - &lt;&#x3D;&#x3D;&#x3D;&#x3D;      Total: 3</span><br><span class="line">DEBUG [main] - &lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">Clazz(id&#x3D;1, name&#x3D;javaEE20170228, stus&#x3D;[Student(id&#x3D;1, name&#x3D;stu0228_1), Student(id&#x3D;2, name&#x3D;stu0228_2), Student(id&#x3D;3, name&#x3D;stu0228_3)])</span><br><span class="line">DEBUG [main] - Resetting autocommit to true on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@32cf48b7]</span><br><span class="line">DEBUG [main] - Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@32cf48b7]</span><br><span class="line">DEBUG [main] - Returned connection 852445367 to pool.</span><br></pre></td></tr></table></figure>

<p>从执行结果打印的 SQL 语句可以看出，该查询一共执行了两次查询操作，先根据传入 id 查询到对应的 班级 Clazz 信息，再根据 班级 id 作为参数去查询对应的 Student 信息，Student 有个 clazz_id 与班级的 id 进行匹配。</p>
<h3 id="延迟加载"><a href="#延迟加载" class="headerlink" title="延迟加载"></a>延迟加载</h3><p>延迟加载在一定程序上可以减少很多没有必要的查询。给数据库服务器提升性能上的优化。</p>
<p>要启用延迟加载，需要在mybatis-config.xml配置文件中，添加如下两个全局的settings配置。</p>
<img src="http://photo.wushaopei.com/qiniu480.jpg " width="80%">

<p><strong>配置：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 自动开启驼峰命名 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 打开延迟加载的开关 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 将积极加载改为消极加载 按需加载 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"aggressiveLazyLoading"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>·]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>映射器</tag>
        <tag>resultMap结果映射集</tag>
        <tag>级联</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（七）线程安全性-原子性-synchronized</title>
    <url>/2020/03/27/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%83%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E5%8E%9F%E5%AD%90%E6%80%A7-synchronized/</url>
    <content><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Java中<strong>原子性</strong>的实现是 <strong>加锁</strong>；而<strong>加锁的方式</strong>有两种：<strong>synchronized 、Lock</strong> </p>
<p><strong>区别：</strong> </p>
<blockquote>
<p><strong>synchronized</strong> : 依赖JVM</p>
<p><strong>Lock :</strong> 依赖特殊的CPU指令，代码实现，ReentrantLock</p>
</blockquote>
<h2 id="原子性-synchronized"><a href="#原子性-synchronized" class="headerlink" title="原子性 - synchronized"></a>原子性 - synchronized</h2><h3 id="synchronized-的使用："><a href="#synchronized-的使用：" class="headerlink" title="synchronized  的使用："></a>synchronized  的使用：</h3><blockquote>
<ul>
<li>修饰代码块： 大括号括起来的代码，作用于调用的对象</li>
<li>修饰方法：整个方法，作用于调用的对象</li>
<li>修饰静态方法：整个静态方法，作用于所有对象</li>
<li>修饰类：括号括起来的部分，作用于所有对象</li>
</ul>
</blockquote>
<p><strong>同步操作：</strong>  </p>
<blockquote>
<p>  修饰代码块也叫同步代码块</p>
<p>  修饰方法也叫同步方法</p>
</blockquote>
<h3 id="synchronized关键字代码演示："><a href="#synchronized关键字代码演示：" class="headerlink" title="synchronized关键字代码演示："></a>synchronized关键字代码演示：</h3><h4 id="同一对象的两个线程调用同步代码块："><a href="#同一对象的两个线程调用同步代码块：" class="headerlink" title="同一对象的两个线程调用同步代码块："></a>同一对象的两个线程调用同步代码块：</h4><h5 id="执行test1-同步方法"><a href="#执行test1-同步方法" class="headerlink" title="执行test1()同步方法"></a><strong>执行test1()同步方法</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.sync;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SynchronizedExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 14:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个代码块</span></span><br><span class="line">    <span class="comment">//作用的对象是调用的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">                log.info(<span class="string">"test1 - &#123;&#125;"</span>,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            log.info(<span class="string">"test - &#123;&#125;"</span>,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SynchronizedExample1 example1 = <span class="keyword">new</span> SynchronizedExample1();</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//在不使用线程池的情况下，本身就是同步执行，synchronized修饰意义不大，</span></span><br><span class="line">        <span class="comment">//使用线程池后，存在两条线程，同时执行代码，在没有synchronized修饰时是并发异步的执行，交替穿插打印结果</span></span><br><span class="line">        <span class="comment">//使用synchronized修饰后，由于锁定的是当前对象example1，所以只有第一个线程执行完，第二个线程才会执行</span></span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example1.test2();</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example1.test2();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行test1（）同步方法，结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.164</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">21</span>:<span class="number">22.168</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 由结果可知，先执行完线程1的test1-0到test1-9，再执行线程2的test0到test9</p>
</blockquote>
<h5 id="执行test2-同步方法"><a href="#执行test2-同步方法" class="headerlink" title="执行test2()同步方法"></a><strong>执行test2()同步方法</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example1.test2();</span><br><span class="line">&#125;);</span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example1.test2();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>运行test2()方法,打印结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.003</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">24</span>:<span class="number">17.008</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 - <span class="number">2</span></span><br></pre></td></tr></table></figure>



<h4 id="不同对象调用同步代码块："><a href="#不同对象调用同步代码块：" class="headerlink" title="不同对象调用同步代码块："></a><strong>不同对象调用同步代码块：</strong></h4><h5 id="执行test1-同步方法，"><a href="#执行test1-同步方法，" class="headerlink" title="执行test1()同步方法，"></a><strong>执行test1()同步方法，</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            log.info(<span class="string">"test1 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SynchronizedExample1 example1 = <span class="keyword">new</span> SynchronizedExample1();</span><br><span class="line">    SynchronizedExample1 example2 = <span class="keyword">new</span> SynchronizedExample1();</span><br><span class="line">    ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">   </span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">        example1.test1(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    executorService.execute(()-&gt;&#123;</span><br><span class="line">        example2.test1(<span class="number">2</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.315</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.315</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.320</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">2</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">31</span>:<span class="number">42.321</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test1 <span class="number">1</span> - <span class="number">9</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 由结果可知，两个不同的对象调用同步代码块时，它们的结果是互相不影响的。</p>
</blockquote>
<h5 id="执行test2-同步方法，"><a href="#执行test2-同步方法，" class="headerlink" title="执行test2()同步方法，"></a><strong>执行test2()同步方法，</strong></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//修饰一个方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">        log.info(<span class="string">"test2 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example1.test2(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">executorService.execute(()-&gt;&#123;</span><br><span class="line">    example2.test2(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.704</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.704</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">1</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">14.708</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample1 - test2 <span class="number">2</span> - <span class="number">9</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>有结果可知，两个不同的对象调用同步方法时，它们的结果是互相不影响的。 </p>
</blockquote>
<h3 id="静态同步方法、静态同步代码块："><a href="#静态同步方法、静态同步代码块：" class="headerlink" title="静态同步方法、静态同步代码块："></a><strong>静态同步方法、静态同步代码块：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.sync;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SynchronizedExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 14:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个代码块</span></span><br><span class="line">    <span class="comment">//作用的对象是调用的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">         <span class="keyword">synchronized</span>  (SynchronizedExample2<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">                log.info(<span class="string">"test1 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//修饰一个静态方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">(<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            log.info(<span class="string">"test2 &#123;&#125; - &#123;&#125;"</span>,j,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SynchronizedExample2 example1 = <span class="keyword">new</span> SynchronizedExample2();</span><br><span class="line">        SynchronizedExample2 example2 = <span class="keyword">new</span> SynchronizedExample2();</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example1.test2(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            example2.test2(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>静态同步代码块测试结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.930</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">1</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">46</span>:<span class="number">52.935</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test1 <span class="number">2</span> - <span class="number">9</span></span><br></pre></td></tr></table></figure>

<p><strong>静态同步方法测试结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.042</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">1</span> - <span class="number">9</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.046</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">2</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">3</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">4</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">5</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">6</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">7</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">8</span></span><br><span class="line"><span class="number">14</span>:<span class="number">43</span>:<span class="number">19.047</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.mmall.concurrency.example.sync.SynchronizedExample2 - test2 <span class="number">2</span> - <span class="number">9</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="对并发执行增加操作线程使用synchronized修饰："><a href="#对并发执行增加操作线程使用synchronized修饰：" class="headerlink" title="对并发执行增加操作线程使用synchronized修饰："></a>对并发执行增加操作线程使用synchronized修饰：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountExample3</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//同步方法锁 --- synchronized</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">49</span>:<span class="number">18.636</span> [main] INFO com.mmall.concurrency.example.count.CountExample3 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>由执行结果可知，count符合执行的要求，说明当前程序是线程安全的 </p>
</blockquote>
<h3 id="原子性-对比"><a href="#原子性-对比" class="headerlink" title="原子性  - 对比"></a>原子性  - 对比</h3><blockquote>
<p><strong>synchronized</strong> : 不可中断锁，适合竞争不激烈，可读性好</p>
</blockquote>
<blockquote>
<p><strong>Lock</strong> : 可中断锁，多样化同步，竞争激烈时能维持常态</p>
</blockquote>
<blockquote>
<p><strong>Atomic</strong> ： 竞争激烈时能维持常态，比Lock性能好；只能同步一个值</p>
</blockquote>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>synchronized</tag>
        <tag>原子性</tag>
      </tags>
  </entry>
  <entry>
    <title>并发编程（六）线程安全性-原子性-atomic</title>
    <url>/2020/03/27/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E5%85%AD%EF%BC%89%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7-%E5%8E%9F%E5%AD%90%E6%80%A7-atomic/</url>
    <content><![CDATA[<h2 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>​    <strong>当某个线程访问某个类时，不管运行时环境采用何种调度方式或者这些锦城南将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类是线程安全的</strong>。 </p>
<h3 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h3><blockquote>
<p> <strong>原子性</strong>：提供了互斥访问，同一时刻只能有一个线程来对它进行操作</p>
<p> <strong>可见性</strong>：一个线程对主内存的修改可以及时的被其他线程观察到</p>
<p> <strong>有序性</strong>：一个线程观察其他线程中的指令执行顺序，由于指令 重排序的存在，该观察结果一般杂乱无序</p>
</blockquote>
<h2 id="原子性-Atomic包"><a href="#原子性-Atomic包" class="headerlink" title="原子性-Atomic包"></a>原子性-Atomic包</h2><p><strong>Atomic包下的类可以 实现线程并发的原子性，主要的类有：</strong> </p>
<p><strong>① AtomicXXX : CAS 、Unsafe.compareAndSwapInt</strong></p>
<p><strong>② AtomicLong、LongAdder</strong></p>
<p><strong>③ AtomicReference、AtomicIntegerFieldUpdater、AtomicStampReference</strong></p>
<h3 id="AtomicXXX-案例实测"><a href="#AtomicXXX-案例实测" class="headerlink" title="AtomicXXX 案例实测"></a><strong>AtomicXXX</strong> 案例实测</h3><p>使用Atomic确保线程并发的原子性，代码演示： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.count;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.NoThreadSafe;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> CountExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/30 17:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@NoThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count.get());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">17:14:59.658 [main] INFO com.mmall.concurrency.example.count.CountExample2 - count:5000</span><br><span class="line"> </span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>由结果可知，无论执行多少次，count都是5000的值，说明了Atomic可以确保线程的安全性。</p>
<p><font color=red>原理解析：</font></p>
<p>这里对add（）方法所做的修改，即将count++改为count.incrementAndGet()是保证线程安全的主要原因！</p>
<p>从<strong>源码</strong>进行分析：</p>
<p>点击计入incrementAndGet( )类中：<br><img src="http://photo.wushaopei.com/qiniu238.png" width="80%"></p>
<p>由源码可知，incrementAndGet()方法里使用了一个叫unsafe的类，该类实现了一个getAndAddInt()的方法， </p>
<img src="http://photo.wushaopei.com/qiniu239.png" width="80%">

<p>进入getAndAddInt方法进一步分析： </p>
<img src="http://photo.wushaopei.com/qiniu240.png" width="80%">

<p>由源码可知，getAndAddInt方法内部调用了do-while循环结构，在while循环条件中，调用了compareAndSwapInt()方法，这是一个重点，进一步查看该方法： </p>
<img src="http://photo.wushaopei.com/qiniu241.png" width="80%">

<p>​    由图中源码可知，该方法被native所修饰，这是代表是java底层的方法，而不是通过java去实现的。</p>
<p>分析getAndAddInt()方法源码：</p>
<img src="http://photo.wushaopei.com/qiniu242.png" width="80%">

<p>​    这里传过来的var1对象值相当于案例中的 count 值，其中的var2 值则是当前的值。</p>
<p>compareAndSwapInt()方法的作用是，在count值时，var2=2和var5=2的值相同时，将他的值更新为后面的var5+var4的值。这里的var5是从底层取的。</p>
<p><strong>安全原则示例</strong>： 当var2=2，var4=4,进入do作用域中，调用this.getIntVolatile()方法进行修改，然后进入while循环，此时会对var2和var5进行判断，var2是上一次修改后被返回的校验字段，而var5则是对应保存在底层的校验字段，单线程执行时，每一次var5都会在执行compareAndSwapInt()方法后进行变更，即每一次var4+var5都会++；</p>
<p><strong>重点：</strong> 当程序并发请求，当前线程执行var2=2时,有其他线程抢夺CPU执行权执行了一次<code>compareAndSwapInt()</code> 方法后，当前线程再获得锁进入执行  <code>compareAndSwapInt()</code> 方法后var5发生改变，被替换为 <code>var4+var5(2+1=3)</code> 的值，var2=2和var5=3(此时底层取的是3)是不同的值，校验不通过。此时var2的值会重新从 count中取值，当var2取值为3后，再与var5=3进行比较，比较通过后，再对var4+var5进行执行，结果为3+1=4 ; 逻辑依次循环判断，不断对底层值进行覆盖，从而保证执行线程的安全。</p>
<h3 id="AtomicLong、LongAdder-案例实测"><a href="#AtomicLong、LongAdder-案例实测" class="headerlink" title="AtomicLong、LongAdder 案例实测"></a><strong>AtomicLong、LongAdder</strong> 案例实测</h3><h4 id="AtomicLong代码实例："><a href="#AtomicLong代码实例：" class="headerlink" title="AtomicLong代码实例："></a><strong>AtomicLong代码实例：</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AtomicLong count = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">30</span>:<span class="number">44.260</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample2 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="LongAdder代码实例："><a href="#LongAdder代码实例：" class="headerlink" title="LongAdder代码实例："></a>LongAdder代码实例：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.LongAdder;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample3</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//请求总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 同时并发执行的线程数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LongAdder count = <span class="keyword">new</span> LongAdder();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">"exception"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        count.increment();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">32</span>:<span class="number">09.818</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample3 - count:<span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>知识点：</strong> </p>
<blockquote>
<p>对于普通类型的long、double变量，JVM允许将64位的读操作或写操作拆成两个32位的操作。 </p>
</blockquote>
<h4 id="LongAdder的实现是基于什么思想？"><a href="#LongAdder的实现是基于什么思想？" class="headerlink" title="LongAdder的实现是基于什么思想？"></a><strong>LongAdder的实现是基于什么思想？</strong></h4><p>LongAdder的核心是将核心数据分离；比如LongAdder内部的value分离成为一个数组，每个线程访问时通过hash等算法映射到其中一个数字进行计数，而最终的计数结果则为这个数组的求和累加，其中热点单元的数据会被分离为多个单元的shell，每个shell独自维护内部的值，当前对象的值由所有shell累计而成。这样的话，热点就进行了有效的分离并提高了并行度，这样一来LongAdder相当于在AtomicLong的基础上将单点的更新压力分散到各个节点上，在低并发的时候通过对base的值进行更新可以很好的保障和Atomic的性能基本一致，而在高并发的时候则通过分散提高了性能。</p>
<p>注意：实际在处理并发更新统计时，优先使用LongAdder。并发要求低时使用AtomicLong，效率高。</p>
<h3 id="AtomicReference代码实例"><a href="#AtomicReference代码实例" class="headerlink" title="AtomicReference代码实例"></a>AtomicReference代码实例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample4</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> AtomicReference&lt;Integer&gt; count = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        count.compareAndSet(<span class="number">0</span>,<span class="number">2</span>); <span class="comment">// 2</span></span><br><span class="line">        count.compareAndSet(<span class="number">0</span>,<span class="number">1</span>); <span class="comment">// no</span></span><br><span class="line">        count.compareAndSet(<span class="number">1</span>,<span class="number">3</span>); <span class="comment">// no</span></span><br><span class="line">        count.compareAndSet(<span class="number">2</span>,<span class="number">4</span>); <span class="comment">// 4</span></span><br><span class="line">        count.compareAndSet(<span class="number">3</span>,<span class="number">5</span>); <span class="comment">// no</span></span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count.get());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">55</span>:<span class="number">53.811</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample4 - count:<span class="number">4</span></span><br><span class="line"> </span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="AtomicIntegerFieldUpdater代码实例"><a href="#AtomicIntegerFieldUpdater代码实例" class="headerlink" title="AtomicIntegerFieldUpdater代码实例"></a><strong>AtomicIntegerFieldUpdater</strong>代码实例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AtomicExample1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/10/31 10:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicExample5</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">100</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicExample5 example5 = <span class="keyword">new</span> AtomicExample5();</span><br><span class="line"> </span><br><span class="line">    private static AtomicIntegerFieldUpdater&lt;AtomicExample5&gt; updater = AtomicIntegerFieldUpdater.newUpdater(AtomicExample5.class,"count");</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (updater.compareAndSet(example5,<span class="number">100</span>,<span class="number">120</span>))&#123;</span><br><span class="line">            log.info(<span class="string">"update success 1, &#123;&#125;"</span>,example5.getCount());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (updater.compareAndSet(example5,<span class="number">100</span>,<span class="number">120</span>))&#123;</span><br><span class="line">            log.info(<span class="string">"update success 2, &#123;&#125;"</span>,example5.getCount());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">"update failed,&#123;&#125;"</span>,example5.getCount());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">11:02:48.170 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update success 1, 120</span><br><span class="line">11:02:48.177 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update failed,120</span><br><span class="line"> </span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p><strong>分析执行结果：</strong> </p>
<blockquote>
<p>AtomicIntegerFieldUpdater的核心是根据原子性去更新某个类的实例，当前案例修改的是AtomicExample5 类的example5 的某一个字段 count;这里要求count 必须被volatile进行修饰；执行第一个compareAndSet方法时，compareAndSet方法中是将第二个变量100修改为第三个变量120,此时example5通过getCount()更新成了120；再执行第二个compareAndSet方法时，example5与100校验不相同，不执行当前compareAndSet方法，所以没有日志打印，流程进入到else中，打印 “update failed ，120 ”。</p>
</blockquote>
<h3 id="AtomicStampReference：CAS的ABA问题"><a href="#AtomicStampReference：CAS的ABA问题" class="headerlink" title="AtomicStampReference：CAS的ABA问题"></a>AtomicStampReference：CAS的ABA问题</h3><p><strong>关于ABA问题：</strong> </p>
<blockquote>
<p>ABA问题是指在CAS操作的时候，其他线程将变量的值A改成了B，但是又改回了A，本线程使用期望值A与当前变量进行比较的时候，发现A变量没有变，于是CAS就将A值进行了交换操作，这个时候，其实该值已经被其他线程改变过，这与设计思想是不符合的。</p>
<p>因此，ABA问题的解决思路是：每次变量更新的时候，把变量的版本号加一，那么之前那个A改成B，再改成A，就会变成A变成1版本，改成B变成2版本，再改回A变成3版本，这个时候只要变量被某一个线程修改过，该变量对应的版本号就会发生过递增变化。从而解决了ABA问题。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.mmall.concurrency.example.atomic;</span><br><span class="line"> </span><br><span class="line">import com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line">import lombok.Getter;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"> </span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line">import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"> </span><br><span class="line">&#x2F;**</span><br><span class="line"> * @ClassName AtomicExample1</span><br><span class="line"> * @Description TODO</span><br><span class="line"> * @Author wushaopei</span><br><span class="line"> * @Date 2019&#x2F;10&#x2F;31 10:23</span><br><span class="line"> * @Version 1.0</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class AtomicExample6 &#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F;请求总数</span><br><span class="line">    public static int clientTotal &#x3D; 5000;</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal &#x3D; 200;</span><br><span class="line"> </span><br><span class="line">    public static AtomicBoolean isHappened &#x3D; new AtomicBoolean(false);</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        ExecutorService executorService &#x3D; Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore &#x3D; new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch &#x3D; new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i &#x3D; 0 ; i &lt; clientTotal ; i++)&#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    test();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;catch (Exception e)&#123;</span><br><span class="line">                    log.error(&quot;exception&quot;,e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;isHappened:&#123;&#125;&quot;,isHappened.get());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private static void test()&#123;</span><br><span class="line">        if (isHappened.compareAndSet(false,true))&#123;</span><br><span class="line">            log.info(&quot;execute&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">25</span>:<span class="number">55.399</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - execute</span><br><span class="line"><span class="number">11</span>:<span class="number">25</span>:<span class="number">55.429</span> [main] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - isHappened:<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>结果分析：<strong>为什么声明了5000次线程，却只执行了一次？</strong> </p>
<blockquote>
<p>因为AtomicBoolean的compareAndSet具有原子性，它可以保证从false变成true只有一次，之后的4999次在compareAndSet的判断当前值为true后，不会再执行变成true的操作。 </p>
</blockquote>
<p><strong>使用场景</strong>： 让某一段代码只执行一次，而不会发生重复。 </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>Java并发编程</category>
      </categories>
      <tags>
        <tag>原子性</tag>
        <tag>atomic</tag>
      </tags>
  </entry>
  <entry>
    <title>集合扩容机制(二)Collection-Map</title>
    <url>/2020/03/13/%E9%9B%86%E5%90%88%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6(%E4%BA%8C)Collection-Map/</url>
    <content><![CDATA[<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><hr>
<p>获取Map集合容量大小的方法： </p>
<p><strong>思路</strong>：利用反射获取<strong>hashmap</strong>里的<strong>threshold</strong>（扩容上限）除以 负载因子 就得到容器大小了。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getHashMapCapacity</span><span class="params">(HashMap&lt;?,?&gt; hashMap)</span> </span>&#123;</span><br><span class="line">		Class&lt;HashMap&gt; hashMapClass = HashMap<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// threshold是hashmap对象里的一个私有变量，若hashmap的size超过该数值，则扩容。这是通过反射获取该值</span></span><br><span class="line">			Field field = hashMapClass.getDeclaredField(<span class="string">"threshold"</span>);</span><br><span class="line">			<span class="comment">//setAccessible设置为true可以开启对似有变量的访问</span></span><br><span class="line">			field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">int</span> threshold = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> ((<span class="keyword">int</span>) field.get(hashMap) != threshold) &#123;</span><br><span class="line">				threshold = (<span class="keyword">int</span>) field.get(hashMap);</span><br><span class="line">				<span class="comment">// 默认的负载因子是0.75,也就是说实际容量是/0.75</span></span><br><span class="line">				<span class="keyword">double</span> v = (<span class="keyword">int</span>) field.get(hashMap) / <span class="number">0.75</span>;</span><br><span class="line"><span class="comment">//				System.out.println((int) field.get(hashMap) / 0.75);</span></span><br><span class="line">				System.out.println(<span class="string">"扩张容量： "</span> + threshold + <span class="string">" 实际容量： "</span>+ (<span class="keyword">int</span>)v);</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">return</span> threshold;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HashMap-的扩容机制："><a href="#HashMap-的扩容机制：" class="headerlink" title="HashMap 的扩容机制："></a><strong>HashMap 的扩容机制：</strong></h3><hr>
<p><strong>在HashMap 中，与容量有关的构造器有三个：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<h4 id="这里先对-public-HashMap-）做单元测试，并进行分析"><a href="#这里先对-public-HashMap-）做单元测试，并进行分析" class="headerlink" title="这里先对  public HashMap( ）做单元测试，并进行分析"></a><strong>这里先对  public HashMap( ）做单元测试，并进行分析</strong></h4><hr>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mapCapacity</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里添加是个元素</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">		map.put(String.valueOf(i),i);</span><br><span class="line">	&#125;</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line">	<span class="comment">// 这里添加2个元素</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">11</span>; i &lt; <span class="number">13</span>; i++)&#123;</span><br><span class="line">		map.put(String.valueOf(i),i);</span><br><span class="line">	&#125;</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里添加30个元素</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">31</span>; i &lt; <span class="number">60</span>; i++)&#123;</span><br><span class="line">		map.put(String.valueOf(i),i);</span><br><span class="line">	&#125;</span><br><span class="line">	getHashMapCapacity(map);</span><br><span class="line">	System.out.println( <span class="string">"   已占用容量"</span> + map.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>单元测试结果：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DemoApplicationTests      : Started DemoApplicationTests in <span class="number">3.717</span> seconds (JVM running <span class="keyword">for</span> <span class="number">4.477</span>)</span><br><span class="line">   已占用容量<span class="number">0</span></span><br><span class="line">扩张容量： <span class="number">12</span> 实际容量： <span class="number">16</span>    已占用容量<span class="number">11</span></span><br><span class="line">扩张容量： <span class="number">24</span> 实际容量： <span class="number">32</span>    已占用容量<span class="number">13</span></span><br><span class="line">扩张容量： <span class="number">48</span> 实际容量： <span class="number">64</span>    已占用容量<span class="number">42</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">29</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">05.433</span>  INFO <span class="number">29660</span> --- [       Thread-<span class="number">2</span>] o.s.w.c.s.GenericWebApplicationContext   : Closing org.springframework.web.context.support.GenericWebApplicationContext<span class="meta">@ffaa</span>6af: startup date [Wed Jan <span class="number">29</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">02</span> CST <span class="number">2020</span>]; root of context hierarchy</span><br></pre></td></tr></table></figure>

<p>​    在这里先对单元测试结果进行<strong>分析</strong>：</p>
<p>​    首先我们先看一下，单元测试中，创建了一个默认无参的HashMap，此时第一次打印 集合实例的 容量值，得到的结果是 “已占用容量 0”，这里对代码进行分析：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">            <span class="keyword">if</span> ((<span class="keyword">int</span>) field.get(hashMap) != threshold) &#123;</span><br><span class="line">				threshold = (<span class="keyword">int</span>) field.get(hashMap);</span><br><span class="line">				<span class="comment">// 默认的负载因子是0.75,也就是说实际容量是/0.75</span></span><br><span class="line">				<span class="keyword">double</span> v = (<span class="keyword">int</span>) field.get(hashMap) / <span class="number">0.75</span>;</span><br><span class="line"><span class="comment">//				System.out.println((int) field.get(hashMap) / 0.75);</span></span><br><span class="line">				System.out.println(<span class="string">"扩张容量： "</span> + threshold + <span class="string">" 实际容量： "</span>+ (<span class="keyword">int</span>)v);</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>

<p>​    这里是通过反射获取 <strong>HashMap</strong> 字节码对象从而得到运行时的构造器或方法实例及相应的属性的值， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Field field = hashMapClass.getDeclaredField(<span class="string">"threshold"</span>);</span><br></pre></td></tr></table></figure>

<p>​    以上的一条代码便是获取 <strong>“threshold ”</strong> 私有属性的方法，这里看一看该变量在 <strong>HashMap</strong>   中的含义： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The next size value at which to resize (capacity * load factor).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">   */</span> </span><br><span class="line">  <span class="comment">// (The javadoc description is true upon serialization.   (序列化时，javadoc描述为真。</span></span><br><span class="line">  <span class="comment">// Additionally, if the table array has not been allocated, this  此外，如果还没有分配表数组，则执行此操作</span></span><br><span class="line">  <span class="comment">// field holds the initial array capacity, or zero signifying  字段持有初始数组容量，或表示为零</span></span><br><span class="line">  <span class="comment">// DEFAULT_INITIAL_CAPACITY.)  DEFAULT_INITIAL_CAPACITY)。</span></span><br><span class="line">  <span class="keyword">int</span> threshold;</span><br></pre></td></tr></table></figure>

<p>​    由注释我们可以知道，当前字段在 HashMap 用于存储 <strong>key</strong> 字段元素的长度，当初始化一个无参构造时，在没有对其进行分配元素的情况下，该字段是不会被分配值的，默认值表示值为 <strong>0</strong> 或 为<strong>初始化</strong>长度   <strong>DEFAULT_INITIAL_CAPACITY 。</strong>  </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The default initial capacity - MUST be a power of two.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br></pre></td></tr></table></figure>

<p>以上是HashMap中的源码部分对 默认初始容量的定义： 默认长度为 16 。</p>
<p>以上是为了说明一个问题，在默认定义HashMap 集合容量且没有添加元素到容器中的情况下， 其容量值 可能是0 ，也可能是初始容量16.</p>
<p><strong>第一条打印结果分析完毕。</strong></p>
<p><strong>以下对HashMap 的 扩容机制进行一番分析，这里会基于单元测试后面的三条打印结果进行分析：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">扩张容量： 12 实际容量： 16    已占用容量11</span><br><span class="line">扩张容量： 24 实际容量： 32    已占用容量13</span><br><span class="line">扩张容量： 48 实际容量： 64    已占用容量42</span><br></pre></td></tr></table></figure>

<p>从打印的结果，我们可以看到，第一次打印结果中，集合的实际容量为  <strong>16</strong> ，而根据 <strong>HashMap</strong> 的加载因子来计算，当添加的元素达到长度 <strong>0.75</strong> 时会进行一次扩容。这里从<strong>源码方面</strong>进行分析： </p>
<h4 id="此处要搞清楚为什么加载因子是0-75？"><a href="#此处要搞清楚为什么加载因子是0-75？" class="headerlink" title="此处要搞清楚为什么加载因子是0.75？"></a><strong>此处要搞清楚为什么加载因子是0.75？</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Constructs an empty &lt;tt&gt;HashMap&lt;/tt&gt; with the default initial capacity</span></span><br><span class="line"><span class="comment">    * (16) and the default load factor (0.75).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在以上源码中，空参构造中，不会对容量大小进行自定义声明，而是使用默认值 <strong>16</strong> ，方法中的成员变量 <strong>this.loadFactor</strong> 代表当前集合的加载因子，即满足一定条件进行容量扩张。其中的 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DEFAULT_LOAD_FACTOR 在源码中的位置：</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The load factor used when none specified in constructor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure>

<p>这里解决了<strong>加载因子为什么是 0.75</strong> 的问题，不过，在<strong>HashMap</strong>提供的构造器中，<strong>加载因子也是可以自定义</strong>的，就在这里给分析一下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs an empty &lt;tt&gt;HashMap&lt;/tt&gt; with the specified initial</span></span><br><span class="line"><span class="comment">     * capacity and load factor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  initialCapacity the initial capacity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  loadFactor      the load factor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity is negative</span></span><br><span class="line"><span class="comment">     *         or the load factor is nonpositive</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                               initialCapacity);</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">            initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                               loadFactor);</span><br><span class="line">        <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">        <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>有上述源码可以知道， map的容量与加载因子可以同时被自定义声明，在<strong>构造函数</strong>中会对<strong>容量</strong>的<strong>合法性</strong>进行校验.</p>
<h4 id="在这里我们提出一个问题：HashMap中容量的最大值是什么？"><a href="#在这里我们提出一个问题：HashMap中容量的最大值是什么？" class="headerlink" title="在这里我们提出一个问题：HashMap中容量的最大值是什么？"></a><strong>在这里我们提出一个问题：HashMap中容量的最大值是什么？</strong></h4><p>我们看看源码中的这一句， </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">initialCapacity = MAXIMUM_CAPACITY;</span><br></pre></td></tr></table></figure>

<p>当容量大于<strong>HashMap</strong> 定义的私有变量 <strong>MAXIMUM_CAPACITY</strong> 时， </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">将  MAXIMUM_CAPACITY  赋值给  initialCapacity</span><br></pre></td></tr></table></figure>

<p>在HashMap 中对 <strong>MAXIMUM_CAPACITY</strong> 的值定义的大小是： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The maximum capacity, used if a higher value is implicitly specified</span></span><br><span class="line"><span class="comment"> * by either of the constructors with arguments.</span></span><br><span class="line"><span class="comment"> * MUST be a power of two &lt;= 1&lt;&lt;30.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br></pre></td></tr></table></figure>

<p>从这里可以知道，<strong>hashmap</strong>的最大容量是 <strong>2的30次方。</strong> </p>
<h4 id="Hashmap-的-扩容机制"><a href="#Hashmap-的-扩容机制" class="headerlink" title="Hashmap 的 扩容机制"></a><strong>Hashmap 的 扩容机制</strong></h4><p>在 HashMap 在扩容的过程中有几个问题要注意：</p>
<ol>
<li><strong>key 值不可重复与 value 值不可重复的问题？</strong></li>
<li><strong>容量长度的扩容机制？</strong></li>
</ol>
<p>在这里就不对第一个问题进行过多赘述，可以参考 笔者的另一篇博文，</p>
<p><strong>从源码看： hashset如何保证值不会被重复的</strong>  在该博文中对key值和value值不可重复做了详尽的分析。</p>
<p>添加元素到HashMap 集合中，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">      <span class="comment">// 这里添加是个元素</span></span><br><span class="line">  	<span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">	map.put(String.valueOf(i),i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入 <strong>put ()</strong>方法中，进行新元素的添加： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Associates the specified value with the specified key in this map.</span></span><br><span class="line"><span class="comment"> * If the map previously contained a mapping for the key, the old</span></span><br><span class="line"><span class="comment"> * value is replaced.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value value to be associated with the specified key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span></span><br><span class="line"><span class="comment"> *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment"> *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span></span><br><span class="line"><span class="comment"> *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述源码中，会对传入的<strong>key</strong> 进行值重复的校验，具体使用 <strong>key</strong> 进行<strong>hash</strong>运算获取在 当前 集合中的 <strong>hash</strong> 值，如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>put</strong>  方法中，对元素 <code>key-value</code> 添加到集合容器的操作是在 <code>putVal（）</code> 方法中实现的，并且在该方法中调用 <code>resize</code> () 方法对集合容量长度进行扩容。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implements Map.put and related methods</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hash hash for key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value the value to put</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> onlyIfAbsent if true, don't change existing value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> evict if false, the table is in creation mode.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> previous value, or null if none</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<strong>DEBUG分析</strong>查看 putVal方法中的 参数，当前 map 集合的长度为 8 ，有八个key ，每个 key 对应一个value </p>
<img src="http://photo.wushaopei.com/qiniu122.png" width="60%">

<p>根据源码我们可以知道，hashmap的底层是由数组和链表构成的，如上图中，<code>Node&lt;K，V&gt;[] ta</code> 代表当前map集合的底层结构，该结构由一个<code>Node</code> （链表）类型的数组构成。每个新添加的 <code>key-value</code> 会以一个  <code>Node&lt;K，V&gt;</code> 的链表节点的形式被添加到 集合 tab 中 。</p>
<p>在添加元素的时候会调用 <code>resize（）</code>方法，并在<code>resize（）</code> 方法中将新的集合数据存储到 <code>table</code> 私有变量中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The table, initialized on first use, and resized as</span></span><br><span class="line"><span class="comment"> * necessary. When allocated, length is always a power of two.</span></span><br><span class="line"><span class="comment"> * (We also tolerate length zero in some operations to allow</span></span><br><span class="line"><span class="comment"> * bootstrapping mechanics that are currently not needed.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br></pre></td></tr></table></figure>

<p>以下是<strong>resize（）</strong> 的代码： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes or doubles table size.  If null, allocates in</span></span><br><span class="line"><span class="comment">     * accord with initial capacity target held in field threshold.</span></span><br><span class="line"><span class="comment">     * Otherwise, because we are using power-of-two expansion, the</span></span><br><span class="line"><span class="comment">     * elements from each bin must either stay at same index, or move</span></span><br><span class="line"><span class="comment">     * with a power of two offset in the new table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the table</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">        <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">        <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">        <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                threshold = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span> oldTab;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                     oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">                newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">            newCap = oldThr;</span><br><span class="line">        <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">            newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">            newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">            newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                      (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">        &#125;</span><br><span class="line">        threshold = newThr;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">            Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">        table = newTab;</span><br><span class="line">        <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e;</span><br><span class="line">                <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                        newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                        ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                    <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                        Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                        Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                        Node&lt;K,V&gt; next;</span><br><span class="line">                        <span class="keyword">do</span> &#123;</span><br><span class="line">                            next = e.next;</span><br><span class="line">                            <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                    loHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = e;</span><br><span class="line">                                loTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                    hiHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = e;</span><br><span class="line">                                hiTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                            newTab[j] = loHead;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                            newTab[j + oldCap] = hiHead;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newTab;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在以上源码中，关于扩容部分的代码是： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">               oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">          newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br></pre></td></tr></table></figure>

<p><strong>HashMap</strong> 中对当前的容量值使用左位移的方式， <strong>oldCap &lt;&lt; 1</strong> ，将<strong>集合容量扩张</strong>为当前的<strong>2</strong> 的<strong>N次幂。此时，我们可以知道HashMap</strong> 的扩容是新容量为当前的  2的N次方.</p>
<h4 id="HashMap-集合进行扩容的时机是？"><a href="#HashMap-集合进行扩容的时机是？" class="headerlink" title="HashMap 集合进行扩容的时机是？"></a><strong>HashMap 集合进行扩容的时机是？</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">    newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">              (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>前提：</strong> 当前集合集合的链表数组中必须有值的情况下，才会触发扩容机制。</p>
<p>当前的集合元素长度达到了 当前给定集合的容量的<code>0.75</code>倍时，该链表数组进行自增左位移，默认为<code>2的N次幂</code>。</p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>容器-集合</category>
      </categories>
  </entry>
  <entry>
    <title>自动化开发（七）Specification-07-Port Management</title>
    <url>/2020/04/13/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%83%EF%BC%89Specification-07-Port%20Management/</url>
    <content><![CDATA[<h2 id="07-Port-Management"><a href="#07-Port-Management" class="headerlink" title="07. Port Management"></a>07. Port Management</h2><h3 id="07-01-Port-Operation-Mode-Management"><a href="#07-01-Port-Operation-Mode-Management" class="headerlink" title="07.01. Port Operation Mode Management"></a>07.01. Port Operation Mode Management</h3><h4 id="07-01-01-CST-Operation-Mode"><a href="#07-01-01-CST-Operation-Mode" class="headerlink" title="07.01.01. CST Operation Mode"></a>07.01.01. CST Operation Mode</h4><p>根据玻璃类型指示装载机当前的工作方式。 CST操作模式仅适用于特定的设备(仅适用于阵列，CF)。 </p>
<ul>
<li>Kind to Kind Mode (CF/Cell Default)： Glass/chip  按产品(种类)类型装入盒内。它不考虑 glasses 的FIFO顺序。卸载 cassette 满时，卸载报告卸载请求事件。 </li>
<li>Cassette To Cassette Mode(Array Default)： Glass/chip 将储存在相同的槽卸载磁带作为加载磁带。如果卸载机有金属丝盒，玻璃/芯片可以存储到另一个卸载盒槽。工作数据表设备写入。 </li>
</ul>
<h5 id="07-01-01-01-PLC-MAP"><a href="#07-01-01-01-PLC-MAP" class="headerlink" title="07.01.01.01. PLC MAP"></a>07.01.01.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu520.png" width="80%">

<h5 id="07-01-01-02-Communication-Scenario"><a href="#07-01-01-02-Communication-Scenario" class="headerlink" title="07.01.01.02. Communication Scenario"></a>07.01.01.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu521.png" width="80%">

<h4 id="07-01-02-Partial-Full-Mode"><a href="#07-01-02-Partial-Full-Mode" class="headerlink" title="07.01.02. Partial Full Mode"></a>07.01.02. Partial Full Mode</h4><p>Unloader  应该提供部分Full Mode Enable/Disable function。 </p>
<ul>
<li>Enable：  <ul>
<li>When Cassette Status = Process Complete，从 port 卸下全部 Cassette  或部分 Cassette 时，设备需要打开部分全开标志。</li>
<li>Unloader port 可以 load 部分 cassette 或 空 cassette </li>
</ul>
</li>
<li>Disable：  <ul>
<li>When Cassette Status = Process Complete, 所有Cassette 或者 部分 Cassette 从 port  卸载, equipment doesn’t need to turn on Partial Full Flag.</li>
<li>卸载 port 可以 load 空 cassette. </li>
</ul>
</li>
</ul>
<h5 id="07-01-02-01-PLC-MAP"><a href="#07-01-02-01-PLC-MAP" class="headerlink" title="07.01.02.01. PLC MAP"></a>07.01.02.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu522.png" width="80%">

<h5 id="07-01-02-02-Communication-Scenario"><a href="#07-01-02-02-Communication-Scenario" class="headerlink" title="07.01.02.02. Communication Scenario"></a>07.01.02.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu523.png" width="80%">



<h3 id="07-02-Port-Function-Management"><a href="#07-02-Port-Function-Management" class="headerlink" title="07.02. Port Function Management"></a>07.02. Port Function Management</h3><h4 id="07-02-01-Port-Type-Change"><a href="#07-02-01-Port-Type-Change" class="headerlink" title="07.02.01. Port Type Change"></a>07.02.01. Port Type Change</h4><p>它是根据当前加载在 Port 上的 Casstte 的预期操作对 Port 进行分类: 加载在 Port 上的 Cassette 是否将 Job 输入到 Inline , 或在 Job 以行方式完成后，从 Inline  方式输出作业 ,  或在临时行中缓冲作业 .</p>
<p>如果端口上有磁带，则不能更改端口的端口类型。 设备制造商应该提供这一功能。如果端口类型改变，设备应该报告端口的 ‘Load Request’   事件 .</p>
<p>There are 4 kinds of port types, loader, un-loader, both and buffer.  根据端口的类型，端口模式与端口类型相关。 </p>
<ul>
<li><p>Loading Port： 用于从装入端口的 cassette 中取出 Job 并将其输入到 Inline 中。 </p>
</li>
<li><p>Unloading Port： 用于将完成其过程的 Job 存储到 cassette 中 ,  把 cassette  从 Inline  取出来</p>
</li>
<li><p>Both Port： 用于从装入 Port 的 cassette  中取出 Job 并将其输入到 Inline 中，也用于将完成其处理过程的作业存储到 cassette  中，并将 cassette  从 Inline  中取出 </p>
</li>
<li><p>Buffer Port：To be used to buffer Job in Inline </p>
<ul>
<li>Buffer Type： 指示此 Port 仅用于缓冲目的。可混合多种类型的玻璃。 </li>
<li>Loader in Buffer Type： 指示此缓冲端口可用于 Glass Inline  输入，如Loading Port。 </li>
<li>Un-Loader in Buffer Type： 指示此缓冲端口可用于 Glass Inline 输出，如Unloading Port。 </li>
</ul>
<h5 id="07-02-01-01-PLC-MAP"><a href="#07-02-01-01-PLC-MAP" class="headerlink" title="07.02.01.01. PLC MAP"></a>07.02.01.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu524.png" width="80%">

</li>
</ul>
<h5 id="07-02-01-02-Communication-Scenario"><a href="#07-02-01-02-Communication-Scenario" class="headerlink" title="07.02.01.02. Communication Scenario"></a>07.02.01.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu525.png" width="80%">



<h4 id="07-02-02-Port-Mode-Change"><a href="#07-02-02-Port-Mode-Change" class="headerlink" title="07.02.02. Port Mode Change"></a>07.02.02. Port Mode Change</h4><p>它是根据端口盒中所包含的眼镜的操作方式对端口进行分类。</p>
<p>显示玻璃类型或判断信息。基于端口类型的含义有一些不同。</p>
<p>如果端口上有盒式磁带，则端口的端口模式不能更改。设备制造商应该提供这一功能。如果端口模式改变，设备应报告端口的“负载请求”事件。(自动换口模式设备除外)</p>
<img src="http://photo.wushaopei.com/qiniu526.png" width="80%">

<ul>
<li><p>Loading Port： 指示装载在 Port 上的 Cassette 中所包含的 Glass 类型</p>
<ul>
<li><p>TFT Mode： 表示此端口用于处理TFT玻璃。 </p>
</li>
<li><p>CF Mode：表示此 Port 用于处理CF Glasses。 </p>
</li>
<li><p>Dummy Mode：指示此 Port 用于将 Dummy Glasses 加工成 Inline</p>
</li>
<li><p>MQC Mode：表示此 Port 用于将MQC glassses 加工成 Inline。 </p>
</li>
<li><p>HT Mode：Indicates that all glasses in this Port would enter HT Chamber in CVD for  </p>
<p>processing</p>
</li>
<li><p>LT Mode：Indicates that all glasses in this Port would enter LT Chamber in CVD for  </p>
<p>processing</p>
</li>
<li><p>ENG Mode：Indicates that this Port is for processing MQC Glasses into Inline. </p>
</li>
<li><p>IGZO Mode：Indicates that this Port is for processing IGZO Glasses into Inline </p>
</li>
<li><p>ILC Mode：Indicates that all glasses in this Port would enter the equipment in ILC mode  for processing</p>
</li>
<li><p>FLC模式:表示该端口的所有眼镜进入FLC模式进行处理 </p>
</li>
<li><p>Through Dummy Mode：Indicates that this Port is for processing Through Dummy  </p>
<p>Glasses into Inline. </p>
</li>
<li><p>Thickness Dummy Mode：Indicates this Port is to fetch Thickness Dummy Glasses into Inline.</p>
</li>
<li><p>UV Mask Mode：表示此端口用于将  UV Mask Glasses  Inline 加工。 </p>
</li>
<li><p>Mismatch Mode：用于处理 Array/ CF line 的排序 ，表示此端口用于处理VCR读不匹配的 Glass。 </p>
</li>
</ul>
</li>
<li><p>Both Port： 这个端口用于 loading 和 un-loading 这两种类型。 </p>
<ul>
<li>TFT Mode： 指示此端口用于 loading 和 un-loading TFT玻璃。 </li>
<li>CF Mode：表示此端口用于 loading 和 un-loading CF 玻璃。 </li>
<li>Dummy Mode：表示此端口用于 loading 和 un-loading Dummy Glasses。</li>
<li>MQC Mode： 表示此端口用于 loading 和 un-loading MQC Dummy Glasses。</li>
<li>HT Mode： 指示此端口用于 loading 和 un-loading，将进入CVD中的HT室进行处理。</li>
<li>LT Mode： 表示此端口为加载，卸载时将进入CVD中的LT室进行处理。 </li>
<li>ENG Mode： 说明此端口用于MQC玻璃的装卸加工。 </li>
<li>IGZO Mode： 表示此端口用于装载和卸载加工IGZO玻璃。 </li>
<li>ILC Mode：表示此装卸口将进入设备的ILC模式进行处理。 </li>
<li>FLC Mode：表示此装卸口将进入设备FLC模式进行处理。 </li>
</ul>
<p>设备仅根据端口类型使用一种端口模式:加载器、卸载器和缓冲区。</p>
<p>例如，卸载器可能有正常，返工，修理或NG端口和缓冲区可能有加载，卸载，虚拟，刮，返工或缓冲区。</p>
</li>
</ul>
<h5 id="07-02-02-01-PLC-MAP"><a href="#07-02-02-01-PLC-MAP" class="headerlink" title="07.02.02.01. PLC MAP"></a>07.02.02.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu527.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu528.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu529.png" width="80%">

<h5 id="07-02-02-02-Communication-Scenario"><a href="#07-02-02-02-Communication-Scenario" class="headerlink" title="07.02.02.02. Communication Scenario"></a>07.02.02.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu530.png" width="80%">

<h4 id="07-02-03-Port-Transfer-Mode-Change"><a href="#07-02-03-Port-Transfer-Mode-Change" class="headerlink" title="07.02.03. Port Transfer Mode Change"></a>07.02.03. Port Transfer Mode Change</h4><p>它指出了在端口和AMHS之间传输磁带的方式。有3种模式 : AGV模式，MGV模式和STK内联模式。AGV模式包括RGV模式。</p>
<p>AGV模式应该能够通过操作员按下的按钮切换到MGV模式。</p>
<p>如果端口上有盒式磁带，则端口的端口传输模式不能改变。</p>
<p>设备制造商应该提供这一功能。如果端口传输模式改变，设备应报告端口的“负载请求”事件。</p>
<ul>
<li>MGV Mode： 与 MGV 的 Port 接口</li>
<li>AGV Mode： 与 AGV 的 Port 接口</li>
<li>Stocker Inline Mode：与 储料器的 Port 接口</li>
</ul>
<h5 id="07-02-03-01-PLC-MAP"><a href="#07-02-03-01-PLC-MAP" class="headerlink" title="07.02.03.01. PLC MAP"></a>07.02.03.01. PLC MAP</h5><h6 id="07-02-03-01-01-Local-PLC-–-Link-Register-W-Area"><a href="#07-02-03-01-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="07.02.03.01.01. Local PLC – Link Register (W Area)"></a>07.02.03.01.01. Local PLC – Link Register (W Area)</h6><img src="http://photo.wushaopei.com/qiniu531.png" width="80%">

<h5 id="07-02-03-02-Communication-Scenario"><a href="#07-02-03-02-Communication-Scenario" class="headerlink" title="07.02.03.02. Communication Scenario"></a>07.02.03.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu532.png" width="80%">

<h4 id="07-02-04-Port-Enable-Mode-Change"><a href="#07-02-04-Port-Enable-Mode-Change" class="headerlink" title="07.02.04. Port Enable Mode Change"></a>07.02.04. Port Enable Mode Change</h4><p>端口启用模式意味着将使用该端口。只有当端口上没有磁带时，端口Enabled / Disabled 更改才可用(即 load request status,)。一旦端口状态被设置为禁用，就不应该允许或更改与端口相关的端口模式或磁带状态。</p>
<p>如果端口上有盒式磁带，则端口的端口启用模式不能更改。</p>
<p>设备制造商应该提供这一功能。如果端口启用模式从禁用模式更改为启用模式，设备应报告端口的“负载请求”事件。</p>
<ul>
<li>Enabled Mode： 可以使用此端口。 </li>
<li>Disabled Mode： 此端口无法使用。操作员或其他人员禁止使用此端口 </li>
</ul>
<h5 id="07-02-04-01-PLC-MAP"><a href="#07-02-04-01-PLC-MAP" class="headerlink" title="07.02.04.01. PLC MAP"></a>07.02.04.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu533.png" width="80%">

<h5 id="07-02-04-02-Communication-Scenario"><a href="#07-02-04-02-Communication-Scenario" class="headerlink" title="07.02.04.02. Communication Scenario"></a>07.02.04.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu534.png" width="80%">

<h4 id="07-02-05-Cassette-on-Port-Q-Time-Change"><a href="#07-02-05-Cassette-on-Port-Q-Time-Change" class="headerlink" title="07.02.05. Cassette on Port Q Time Change"></a>07.02.05. Cassette on Port Q Time Change</h4><p>所有有负载端口的设备应提供端口Q时间功能的磁带。如果卡带等待处理状态超过设置Q时间，设备应自动取消此卡带并发出警告。Q时间应该在触摸屏上设置。 </p>
<p>当Q时间值发生变化时，设备应向BC报告。</p>
<p>若Q时间值为0，则表示设备不自动取消卡带，即使卡带已超过Q时间设置。</p>
<h5 id="07-02-05-01-PLC-MAP"><a href="#07-02-05-01-PLC-MAP" class="headerlink" title="07.02.05.01. PLC MAP"></a>07.02.05.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu535.png" width="80%">

<h5 id="07-02-05-02-Communication-Scenario"><a href="#07-02-05-02-Communication-Scenario" class="headerlink" title="07.02.05.02. Communication Scenario"></a>07.02.05.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu536.png" width="80%">

<h4 id="07-02-06-Cassette-on-Port-Q-Time-Change-Command"><a href="#07-02-06-Cassette-on-Port-Q-Time-Change-Command" class="headerlink" title="07.02.06. Cassette on Port Q Time Change Command"></a>07.02.06. Cassette on Port Q Time Change Command</h4><p>BC也可以设置卡带对Q口时间的值。当设备接收到此事件时，应将Q时间值更改为，并将回复结果改为BC。 </p>
<ul>
<li><p>OK：重新计数卡带的端口Q时间。 </p>
</li>
<li><p>NG：保持原始磁带在Q端口的时间。</p>
<p> 如果设备回复OK，设备需要在端口Q上再次自动触发卡带时间改变事件 </p>
</li>
</ul>
<h5 id="07-02-06-01-PLC-MAP"><a href="#07-02-06-01-PLC-MAP" class="headerlink" title="07.02.06.01. PLC MAP"></a>07.02.06.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu537.png" width="80%">

<h5 id="07-02-06-02-Communication-Scenario"><a href="#07-02-06-02-Communication-Scenario" class="headerlink" title="07.02.06.02. Communication Scenario"></a>07.02.06.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu538.png" width="80%">

<h4 id="07-02-07-Port-Down"><a href="#07-02-07-Port-Down" class="headerlink" title="07.02.07. Port Down"></a>07.02.07. Port Down</h4><p>​    当端口有错误不能使用时，设备应触发此功能到BC。 </p>
<ul>
<li><p>Normal：Port is OK </p>
</li>
<li><p>Down： 发生错误时端口不能使用。 </p>
<p>For Array/CF： 当一个端口出现错误不能使用时，设备也应同时将“端口下的真实状态”更新到BC。 </p>
</li>
</ul>
<h5 id="07-02-07-01-PLC-MAP"><a href="#07-02-07-01-PLC-MAP" class="headerlink" title="07.02.07.01. PLC MAP"></a>07.02.07.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu539.png" width="80%">

<h5 id="07-02-07-02-Communication-Scenario"><a href="#07-02-07-02-Communication-Scenario" class="headerlink" title="07.02.07.02. Communication Scenario"></a>07.02.07.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu540.png" width="80%">

<h4 id="07-02-08-Port-Type-Change-Command"><a href="#07-02-08-Port-Type-Change-Command" class="headerlink" title="07.02.08. Port Type Change Command"></a>07.02.08. Port Type Change Command</h4><p>BC还可以设置端口类型的改变。当设备收到此命令时，应将结果回复到BC并更改端口类型。如果端口上有盒式磁带，则不能更改端口的端口类型。 </p>
<ul>
<li><p>OK：更改端口类型 </p>
</li>
<li><p>NG：不能更改端口的端口类型 </p>
<p> 如果设备回复OK，设备需要在端口类型改变事件上再次自动触发盒式磁带。 </p>
</li>
</ul>
<h5 id="07-02-08-01-PLC-MAP"><a href="#07-02-08-01-PLC-MAP" class="headerlink" title="07.02.08.01. PLC MAP"></a>07.02.08.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu541.png" width="80%">

<h5 id="07-02-08-02-Communication-Scenario"><a href="#07-02-08-02-Communication-Scenario" class="headerlink" title="07.02.08.02. Communication Scenario"></a>07.02.08.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu542.png" width="80%">

<h4 id="07-02-09-Port-Mode-Change-Command"><a href="#07-02-09-Port-Mode-Change-Command" class="headerlink" title="07.02.09. Port Mode Change Command"></a>07.02.09. Port Mode Change Command</h4><p>还可以设置BC端口模式的改变。当设备收到此命令时，应将结果回复到BC并改变端口模式。如果端口上有磁带，则端口的端口模式无法更改 </p>
<ul>
<li><p>OK ：更改端口的端口模式。 </p>
</li>
<li><p>NG ：不能改变端口的端口模式</p>
<p>如果设备回复OK，设备需要再次自动触发端口模式改变事件 </p>
</li>
</ul>
<h5 id="07-02-09-01-PLC-MAP"><a href="#07-02-09-01-PLC-MAP" class="headerlink" title="07.02.09.01. PLC MAP"></a>07.02.09.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu543.png" width="80%">

<h5 id="07-02-09-02-Communication-Scenario"><a href="#07-02-09-02-Communication-Scenario" class="headerlink" title="07.02.09.02. Communication Scenario"></a>07.02.09.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu544.png" width="80%">

<h4 id="07-02-10-Port-Transfer-Mode-Change-Command"><a href="#07-02-10-Port-Transfer-Mode-Change-Command" class="headerlink" title="07.02.10. Port Transfer Mode Change Command"></a>07.02.10. Port Transfer Mode Change Command</h4><p>BC还可以设置端口传输模式的改变。当设备收到此命令时，应将应答结果返回给BC，并改变端口传输模式。如果端口上有磁带，则端口的端口传输模式不能改变。</p>
<ul>
<li><p>OK： 改变端口的传输方式。 </p>
</li>
<li><p>NG :  无法更改端口的传输模式。 </p>
<p>如果设备回复OK，设备需要再次自动触发端口传输模式更改事件。 </p>
</li>
</ul>
<h5 id="07-02-10-01-PLC-MAP"><a href="#07-02-10-01-PLC-MAP" class="headerlink" title="07.02.10.01. PLC MAP"></a>07.02.10.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu545.png" width="80%">

<h5 id="07-02-10-02-Communication-Scenario"><a href="#07-02-10-02-Communication-Scenario" class="headerlink" title="07.02.10.02. Communication Scenario"></a>07.02.10.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu546.png" width="80%">

<h4 id="07-02-11-Port-Enable-Mode-Change-Command"><a href="#07-02-11-Port-Enable-Mode-Change-Command" class="headerlink" title="07.02.11. Port Enable Mode Change Command"></a>07.02.11. Port Enable Mode Change Command</h4><p>BC还可以设置端口类型的改变。当设备收到此命令时，应将应答结果返回给BC并更改端口启用模式。如果端口上有磁带，则该端口无法更改。 </p>
<ul>
<li><p>OK： 改变端口的启用端口 </p>
</li>
<li><p>NG： 不能更改端口的启用端口 </p>
<p>如果设备回复OK，设备需要再次自动触发端口使能模式改变事件 </p>
</li>
</ul>
<h5 id="07-02-11-01-PLC-MAP"><a href="#07-02-11-01-PLC-MAP" class="headerlink" title="07.02.11.01. PLC MAP"></a>07.02.11.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu547.png" width="80%">

<h5 id="07-02-11-02-Communication-Scenario"><a href="#07-02-11-02-Communication-Scenario" class="headerlink" title="07.02.11.02. Communication Scenario"></a>07.02.11.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu548.png" width="80%">

<h3 id="07-03-Port-amp-Cassette-Status-Management"><a href="#07-03-Port-amp-Cassette-Status-Management" class="headerlink" title="07.03. Port &amp; Cassette Status Management"></a>07.03. Port &amp; Cassette Status Management</h3><h4 id="07-03-01-Item-Define"><a href="#07-03-01-Item-Define" class="headerlink" title="07.03.01. Item Define"></a>07.03.01. Item Define</h4><h5 id="07-03-01-01-Port-Status"><a href="#07-03-01-01-Port-Status" class="headerlink" title="07.03.01.01. Port Status"></a>07.03.01.01. Port Status</h5><p>Cassette 状态有4种类型; load request，load complete，Unload Request 和 Unload Complete。 </p>
<ul>
<li>Load Request： 端口可以接收盒式磁带，正在等待装入盒式磁带。在触发事件时，应自动增加端口的盒序号。在PLC的R口块中，CST状态下LDRQ后撤，设备将自动将ZR口区数据全部清除，避免残留影响下次下载盒式数据。 </li>
<li>Load Complete： 一盒磁带已装上了端口。 </li>
<li>Unload Request：一盒磁带正等着卸下来。 </li>
<li>Unload Complete： 一盒磁带已经卸载了，端口上没有磁带了。 </li>
</ul>
<h5 id="07-03-01-02-Cassette-Status"><a href="#07-03-01-02-Cassette-Status" class="headerlink" title="07.03.01.02. Cassette Status"></a>07.03.01.02. Cassette Status</h5><p>​    卡带状态与操作者或设备本身的工艺操作有关。 </p>
<ul>
<li>No Cassette Exist： 端口上没有盒式磁带。 </li>
<li>Waiting for Cassette Data： 磁带当前被装入端口，等待主PLC或操作员的磁带映射数据。设备应报告这一事件后，夹紧盒式磁带和(如果端口有BCR)读取盒式磁带ID和(如果端口有映射单元)感应每个插槽的工作的存在。 </li>
<li>Waiting for Start Command： Cassette Map 已成功接收，正在等待主PLC或操作员的启动命令 </li>
<li>Waiting for Processing <ul>
<li>Loading Port： 开始命令已成功接收，并等待作业取出开始 </li>
<li>Unloading Port： 已成功接收到Start命令，正在等待将Start插入到磁带中的作业。 </li>
</ul>
</li>
<li>In Processing <ul>
<li>Loading Port： 应该先更改为“正在处理中”，然后将T5报告  “Fetch out Job Data”  事件延迟到BC </li>
<li>Unloading Port：应先更改为  “In Processing”  ，然后将T5报告 “Store Job Data”  事件延迟到BC。 </li>
<li>Buffer Port：接收到BC的Start命令后，将更改为“In Processing”，然后需要延迟T5报告“Store Job Data”或“Fetch Out Job Data”事件到BC。 </li>
<li>T5定时器默认值为1秒;范围 1~8秒 </li>
</ul>
</li>
<li>Process Completed： 过程中的盒式磁带已完成(最后一次玻璃存储在盒式磁带后)或取消，或中止，需要延迟T5定时器才能改变到过程完成状态。 </li>
<li>Process Paused： 盒式磁带的处理已被BC或操作员(EQ)暂停 </li>
<li>Re-Map： 操作员在BC OPI改变盒式磁带状态从正在处理重新映射，等待操作员重新选择和下载盒式磁带映射数据。 </li>
</ul>
<h5 id="07-03-01-03-Cassette-Sequence-No"><a href="#07-03-01-03-Cassette-Sequence-No" class="headerlink" title="07.03.01.03. Cassette Sequence No"></a>07.03.01.03. Cassette Sequence No</h5><p>Cassette Sequence No 是表示盒式磁带的虚构序列号。当该端口的端口状态更改为“Load Request”时，它应该被增加。 </p>
<h5 id="07-03-01-04-Operator-ID"><a href="#07-03-01-04-Operator-ID" class="headerlink" title="07.03.01.04. Operator ID"></a>07.03.01.04. Operator ID</h5><p>每个在线的操作员都有唯一的ID。设备必须为操作员ID输入提供屏幕。 </p>
<h5 id="07-03-01-05-Cassette-ID"><a href="#07-03-01-05-Cassette-ID" class="headerlink" title="07.03.01.05. Cassette ID"></a>07.03.01.05. Cassette ID</h5><p>如果端口有一个BCR，那么它必须更新项目。BCR夹紧后读取卡带ID。 </p>
<h5 id="07-03-01-06-Job-Count-in-Cassette"><a href="#07-03-01-06-Job-Count-in-Cassette" class="headerlink" title="07.03.01.06. Job Count in Cassette"></a>07.03.01.06. Job Count in Cassette</h5><p>盒式磁带中的作业计数是盒式磁带在端口装载时的作业计数。当映射单元感知到每个槽中存在作业时，应该更新它。如果工作计数有任何变化，及时报告设备。 </p>
<h5 id="07-03-01-07-Job-Existence"><a href="#07-03-01-07-Job-Existence" class="headerlink" title="07.03.01.07. Job Existence"></a>07.03.01.07. Job Existence</h5><p>如果映射单元感知到每个槽中作业的存在，则应针对每个槽对其进行更新并实时刷新。 </p>
<h5 id="07-03-01-08-Complete-Cassette-Dat"><a href="#07-03-01-08-Complete-Cassette-Dat" class="headerlink" title="07.03.01.08. Complete Cassette Dat"></a>07.03.01.08. Complete Cassette Dat</h5><p>它用来表示磁带是如何完成的。 </p>
<ul>
<li>Normal Complete： 磁带已正常完成 </li>
<li>Operator Forced To Cancel： 在工序开始前，操作员已经取消了Cassette </li>
<li>Operator Forced To Abort： 在正常的程序完成之前，操作员已经中止了磁带 </li>
<li>BC Forced to Cancel： 在流程开始前，Cassette 已被BC取消。 </li>
<li>BC Forced to Abort： 在正常工艺完成之前，卡带已被BC终止。 </li>
<li>EQ Auto Cancel： Cassette 在开机前已被EQ自动取消。 </li>
<li>EQ Auto Abort： 在正常工艺完成之前，Cassette 已被EQ自动中止。 </li>
</ul>
<h4 id="07-03-02-Port-amp-Cassette-Status-Change"><a href="#07-03-02-Port-amp-Cassette-Status-Change" class="headerlink" title="07.03.02. Port &amp; Cassette Status Change"></a>07.03.02. Port &amp; Cassette Status Change</h4><h5 id="07-03-02-01-Normal-Scenario"><a href="#07-03-02-01-Normal-Scenario" class="headerlink" title="07.03.02.01. Normal Scenario"></a>07.03.02.01. Normal Scenario</h5><img src="http://photo.wushaopei.com/qiniu549.png" width="80%">

<h5 id="07-03-02-02-Re-Map-Scenario"><a href="#07-03-02-02-Re-Map-Scenario" class="headerlink" title="07.03.02.02. Re-Map Scenario"></a>07.03.02.02. Re-Map Scenario</h5><img src="http://photo.wushaopei.com/qiniu550.png" width="80%">

<h4 id="07-03-03-PLC-MAP"><a href="#07-03-03-PLC-MAP" class="headerlink" title="07.03.03. PLC MAP"></a>07.03.03. PLC MAP</h4><h5 id="07-03-03-01-Local-PLC-–-Link-Register-W-Area"><a href="#07-03-03-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="07.03.03.01. Local PLC – Link Register (W Area)"></a>07.03.03.01. Local PLC – Link Register (W Area)</h5><img src="http://photo.wushaopei.com/qiniu551.png" width="80%">

<h5 id="07-03-03-02-Local-PLC-–-Link-Relay-B-Area"><a href="#07-03-03-02-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="07.03.03.02. Local PLC – Link Relay (B Area)"></a>07.03.03.02. Local PLC – Link Relay (B Area)</h5><img src="http://photo.wushaopei.com/qiniu552.png" width="80%">

<h5 id="07-03-03-03-Master-PLC-–-Link-Relay-B-Area"><a href="#07-03-03-03-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="07.03.03.03. Master PLC – Link Relay (B Area)"></a>07.03.03.03. Master PLC – Link Relay (B Area)</h5><img src="http://photo.wushaopei.com/qiniu553.png" width="80%">

<h4 id="07-03-04-Communication-Scenario"><a href="#07-03-04-Communication-Scenario" class="headerlink" title="07.03.04. Communication Scenario"></a>07.03.04. Communication Scenario</h4><h5 id="07-03-04-01-Cassette-Normal-Scenario"><a href="#07-03-04-01-Cassette-Normal-Scenario" class="headerlink" title="07.03.04.01. Cassette Normal Scenario"></a>07.03.04.01. Cassette Normal Scenario</h5><p>设备应有T4定时器，用于设置进程完成回复和UR事件之间的时间范围(如果是源盒式磁带自动转换为目标盒式磁带，则为UC事件); </p>
<p>在等待过程中的盒状态，在第一次取玻璃之前，设备必须向BC报告第一次玻璃检查。当BC回复OK时，第一个杯子就可以取了。 </p>
<p>在取第一个玻璃之前，设备必须与BC确认。如果BC回复NG，设备取消卡带。 </p>
<img src="http://photo.wushaopei.com/qiniu554.png" width="80%">

<h5 id="07-03-04-02-Cassette-Cancel-Scenario"><a href="#07-03-04-02-Cassette-Cancel-Scenario" class="headerlink" title="07.03.04.02. Cassette Cancel Scenario"></a>07.03.04.02. Cassette Cancel Scenario</h5><img src="http://photo.wushaopei.com/qiniu555.png" width="80%">

<h5 id="07-03-04-03-Cassette-Cancel-Scenario-–-After-waiting-for-start-command"><a href="#07-03-04-03-Cassette-Cancel-Scenario-–-After-waiting-for-start-command" class="headerlink" title="07.03.04.03. Cassette Cancel Scenario – After waiting for start command"></a>07.03.04.03. Cassette Cancel Scenario – After waiting for start command</h5><p>​         <img src="http://photo.wushaopei.com/qiniu556.png" width="80%"></p>
<h5 id="07-03-04-04-Cassette-Cancel-Scenario-–-After-waiting-for-processing"><a href="#07-03-04-04-Cassette-Cancel-Scenario-–-After-waiting-for-processing" class="headerlink" title="07.03.04.04. Cassette Cancel Scenario – After waiting for processing"></a>07.03.04.04. Cassette Cancel Scenario – After waiting for processing</h5><p>​         <img src="http://photo.wushaopei.com/qiniu557.png" width="80%"></p>
<h5 id="07-03-04-05-Cassette-Abort-Scenario"><a href="#07-03-04-05-Cassette-Abort-Scenario" class="headerlink" title="07.03.04.05. Cassette Abort Scenario"></a>07.03.04.05. Cassette Abort Scenario</h5><p>​         <img src="http://photo.wushaopei.com/qiniu558.png" width="80%"></p>
<h5 id="07-03-04-06-Empty-Cassette-Scenario"><a href="#07-03-04-06-Empty-Cassette-Scenario" class="headerlink" title="07.03.04.06. Empty Cassette Scenario"></a>07.03.04.06. Empty Cassette Scenario</h5><p>​         <img src="http://photo.wushaopei.com/qiniu559.png" width="80%"></p>
<h5 id="07-03-04-07-EMP-Mode-Change-Scenario"><a href="#07-03-04-07-EMP-Mode-Change-Scenario" class="headerlink" title="07.03.04.07. EMP Mode Change Scenario"></a>07.03.04.07. EMP Mode Change Scenario</h5><p>​         <img src="http://photo.wushaopei.com/qiniu560.png" width="80%"></p>
<p>07.03.04.08. Event Report Interval Time Scenario </p>
<p>​         <img src="http://photo.wushaopei.com/qiniu608.png" width="80%"></p>
<p>(1).     在端口状态 “Load Complete ” 和卡带状态 “ Waiting for Cassette Data ”之间，应延迟1秒，此时(名称:LC等待CST数据时间)可在触摸屏上设置。 </p>
<p>(2).     在 “Cassette Map Download”  和卡带状态  “Waiting for Start Command”之间，应延迟1秒。此时(名称:CST下载等待启动时间)可在触摸屏上设置。 </p>
<p>(3).   在卡带控制指令  “Cassette Process Start”  和卡带状态  “Waiting for Processing” 之间，应延迟1秒。此时(名称:进程启动等待进程时间)可在触摸屏上设置。 </p>
<p>(4).   在卡带状态 “Waiting for Processing”   和卡带状态  “In Processing”  之间，应等待第一次玻璃检查结果事件来改变卡带状态。当最后一块玻璃从盒的装载口离开时，最后一块玻璃标志的工作数据应自动打开。 </p>
<p>(5).  在卡带状态变为  “Process Completed” 前，设备应更新卡带各槽位和ZR区域的作业数据 </p>
<p>(6).   在卡带状态  “Process Completed”  与bit的BC应答之间，应延迟T6时间。这个时间可以在触摸屏上设置。默认值为0，表示不延迟 </p>
<p>(7).   在卡带状态  “Process Completed”  和端口状态 “Unload Request” 之间，应延迟T5时间。T5时间可以在触摸屏上设置。 </p>
<p>(8).   在端口状态 “Unload Complete” 和卡带状态  “No Cassette Exist” 之间，应延迟1秒。此时(名称:UC到No CST存在时间)可在触摸屏上设置。 </p>
<p>(9).    在卡带状态  “No Cassette Exist”  和端口状态  “Load Request” 之间，应延迟1秒。此时(名称:从无CST到LR时间)可在触摸屏上设置。 </p>
<h5 id="07-03-04-09-Cassette-Process-Completed-Interval-Time-Scenario"><a href="#07-03-04-09-Cassette-Process-Completed-Interval-Time-Scenario" class="headerlink" title="07.03.04.09. Cassette Process Completed Interval Time Scenario"></a>07.03.04.09. Cassette Process Completed Interval Time Scenario</h5><p>​         <img src="http://photo.wushaopei.com/qiniu609.png" width="80%"></p>
<p>(1).  在01号卡带和02号卡带之间完成卡带加工的间隔时间至少为6秒。设备应提供触摸屏或PC上的设置。默认值是6秒。 </p>
<p>(2).  当端口01和端口02的卡带同时完成时，设备应报告一个端口并保持至少6秒，然后再报告另一个端口，无论端口类型。 </p>
<h3 id="07-04-Cassette-Control-Command"><a href="#07-04-Cassette-Control-Command" class="headerlink" title="07.04. Cassette Control Command"></a>07.04. Cassette Control Command</h3><h4 id="07-04-01-Command-Define-"><a href="#07-04-01-Command-Define-" class="headerlink" title="07.04.01. Command Define "></a>07.04.01. Command Define </h4><p>​    盒式磁带控制指令用于控制设备如何处理端口上的盒式磁带。 </p>
<ul>
<li><p>Cassette Map Download : 当设备请求一个端口的盒式磁带映射数据时，BC应将数据下载到设备。BC将盒式映射数据写入已请求该数据的设备的本地PLC中。此时，BC向设备发送此命令。设备可根据卡带图数据对卡带进行处理 </p>
</li>
<li><p>Cassette Process Start： 如果从BC接收的盒式磁带映射数据正常，设备应向BC请求盒式磁带进程启动命令。当从BC收到此命令时，设备可以启动卡带。 </p>
</li>
<li><p>Cassette Process Start By Count： 有些设备需要特定的工作数量才能启动。此命令用于这些类型，并包含要启动的作业数量。操作与卡带进程启动命令相同。</p>
</li>
<li><p>Cassette Process Pause： 卡带可以暂停。如果接收到此命令，设备必须暂停进程。如果机器人(或传送带)当前正在提取或存储作业到磁带，则在设备将磁带状态切换为暂停之前，应完成提取或存储操作。 </p>
</li>
<li><p>Cassette Process Resume： 如果磁带进程暂停，设备可以通过此命令重新启动进程。 </p>
</li>
<li><p>Cassette Process Cancel： 如果磁带没有被处理，BC可以取消该过程。BC使用这个命令。设备将卡带从端口上松开。 </p>
</li>
<li><p>Cassette Process Abort： 如果正在处理磁带，BC可以使用此命令终止进程。如果机器人(或传送带)当前正在提取或存储作业到磁带，则在设备将磁带状态切换到abort之前，应完成提取或存储操作。 </p>
</li>
<li><p>Cassette Reload/Load： 当端口状态= “ 3:Unload Request “，卡带状态= “ 7:Process Completed “时，BC/OP可以将Reload命令设置为设备，如果设备接受命令，则端口状态变为” 4:Unload Complete “，卡带状态变为7:No Cassette Exist “。 </p>
<p>端口状态将更改为“4:卸载完成”，盒式磁带状态将更改为“1:不存在盒式磁带”</p>
<p>端口状态变为“1:Load Request”，卡带状态变为“1:No Cassette Exist”，等待BC/OP将Load命令设置到设备。</p>
</li>
<li><p>Cassette Re-Map：用于重新选择使用的函数。设备应将卡带状态更改为“重新映射”，并等待BC重新下载新的卡带映射数据到设备。 </p>
</li>
</ul>
<h4 id="07-04-02-Cassette-Map-Data"><a href="#07-04-02-Cassette-Map-Data" class="headerlink" title="07.04.02. Cassette Map Data"></a>07.04.02. Cassette Map Data</h4><p>它是盒式磁带中每个插槽的工作数据。BC可以将要求盒式映射数据的设备的数据写入本地PLC。 </p>
<h4 id="07-04-03-Cassette-Control-Command-Return-Code"><a href="#07-04-03-Cassette-Control-Command-Return-Code" class="headerlink" title="07.04.03. Cassette Control Command Return Code"></a>07.04.03. Cassette Control Command Return Code</h4><p>它是BC的盒式磁带控制命令的返回代码。设备必须根据命令返回代码进行应答。 </p>
<p><strong>※ Note：</strong> </p>
<p>Return Code Description：  </p>
<p>1：Command OK,  意思是设备接受指令</p>
<p>2:   Command Error（命令错误），意思是BC命令错误，需要警告，设备不能自动取消/中止卡带。它应该再次等待BC下载命令，直到操作员或BC手动取消。 </p>
<p>3：CSTID is Invalid （CSTID是无效的(包括密盒ID)），这意味着CSTID的BCR读取是非法的，需要发出警告，设备不能自动取消/终止盒式磁带。它应该等待操作符或BC取消。 </p>
<p>4：Recipe Mismatch（配方不匹配），意味着配方ID的作业数据不能在设备中使用，需要报警，设备不能自动取消/中止卡带。它应该等待操作符或BC取消。设备应按配方ID检查模式，配方自动切换模式检查配方ID。 </p>
<p>5： Slot Information Mismatch （槽信息不匹配），即设备作业存在内容与BC下载的作业存在内容不一致，需要发出警告，设备不能自动取消卡带。它应该等待操作符或BC取消。</p>
<p>(如果没有地图传感器就不要检查)</p>
<p>6：Job Type Mismatch（作业类型不匹配），即作业类型的作业数据与端口模式不同。设备需要提供作业类型不匹配的自动取消启用/禁用按钮。如果启用，卡带应自动取消，如果禁用，设备应发出警告并等待操作员或BC取消 </p>
<p>7：Cassette Setting Code Mismatch (BEOL), 仅对于Cell，其设备卡带设置代码与BC下载的卡带设置代码不同，需要发出警告，设备不能自动取消卡带。它应该等待操作符或BC取消。 </p>
<p>8：Already Received（已经收到），意思是设备多次收到来自BC的相同指令，需要发出警告，设备不能自动取消卡带。它应该等待操作符或BC取消。 </p>
<p>9：Other Error（其他错误）,  它的意思是BC下载命令，设备检查后，它的其他错误发生，它需要提出警告，设备不能自动取消卡带。它应该等待操作符或BC取消。 </p>
<p>10：Product Type Mismatch（产品类型不匹配 ）, 它的意思是设备最后的产品类型不同于BC下载的产品类型。设备需要提供产品类型不匹配自动取消启用/禁用按钮。如果启用，卡带应自动取消，如果禁用，设备应发出警告并等待操作员或BC取消。  </p>
<p>11：Group Index Mismatch （组索引不匹配），仅用于单元格，如果此功能启用，设备不能混合不同的组索引 glass 。 </p>
<p>12：Product ID Mismatch （产品ID不匹配 ），仅对于Cell，如果此功能启用，设备不能混合不同的产品id glasses.</p>
<h4 id="07-04-04-PLC-MAP"><a href="#07-04-04-PLC-MAP" class="headerlink" title="07.04.04. PLC MAP"></a>07.04.04. PLC MAP</h4><h5 id="07-04-04-01-Local-PLC-–-Link-Register-W-Area"><a href="#07-04-04-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="07.04.04.01. Local PLC – Link Register (W Area)"></a>07.04.04.01. Local PLC – Link Register (W Area)</h5><p>​         <img src="http://photo.wushaopei.com/qiniu615.png" width="80%"></p>
<h5 id="07-04-04-02-Local-PLC-–-Link-Relay-B-Area"><a href="#07-04-04-02-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="07.04.04.02. Local PLC – Link Relay (B Area)"></a>07.04.04.02. Local PLC – Link Relay (B Area)</h5><p>​         <img src="http://photo.wushaopei.com/qiniu616.png" width="80%"></p>
<p>​         <img src="http://photo.wushaopei.com/qiniu617.png" width="80%"></p>
<h5 id="07-04-04-04-Master-PLC-–-Link-Relay-B-Area"><a href="#07-04-04-04-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="07.04.04.04. Master PLC – Link Relay (B Area)"></a>07.04.04.04. Master PLC – Link Relay (B Area)</h5><p>​         <img src="http://photo.wushaopei.com/qiniu618.png" width="80%"></p>
<h4 id="07-04-05-Local-PLC-–-File-Register-R-ZR-Area"><a href="#07-04-05-Local-PLC-–-File-Register-R-ZR-Area" class="headerlink" title="07.04.05. Local PLC – File Register (R/ZR Area)"></a>07.04.05. Local PLC – File Register (R/ZR Area)</h4><p>此标准盒式磁带映射数据为28槽盒式磁带，其它类型盒式磁带参照PLC地址映射。 </p>
<p>设备应根据玻璃取出/存储在卡带槽中，以更新与ZR区域有关的全部工作数据。</p>
<h5 id="07-04-05-01-Standard-Cassette-Map-Data"><a href="#07-04-05-01-Standard-Cassette-Map-Data" class="headerlink" title="07.04.05.01. Standard Cassette Map Data"></a>07.04.05.01. Standard Cassette Map Data</h5><p>​         <img src="http://photo.wushaopei.com/qiniu619.png" width="80%"></p>
<p>​         <img src="http://photo.wushaopei.com/qiniu620.png" width="80%"></p>
<h3 id="07-05-First-Glass-Check"><a href="#07-05-First-Glass-Check" class="headerlink" title="07.05. First Glass Check"></a>07.05. First Glass Check</h3><p> Loading Port 或 Both Port 收到 Cassette Control Command 后，Cassette Status 变为“Wait for Process”，在第一次从Cassette 带取出 Glass 前，EQP 需向BC报告“First Glass Check ” event 。BC会将检查结果回复给设备。如果结果为“OK”，则可立即从 Cassette 中取出第一块 Glass ;如果结果为“NG”，设备需要自动取消 Cassette 。如果BC没有回复结果，说明T1超时，设备需要重新自动重试。重试计数默认值为3，每次重试间隔时间默认值为30秒。retry count 和 retry count 可以在 Touch Panel 上修改。如果已达到重试计数但BC仍不回复 EQP 结果，设备需要自动取消 Cassette .</p>
<h4 id="07-05-01-PLC-MAP"><a href="#07-05-01-PLC-MAP" class="headerlink" title="07.05.01. PLC MAP"></a>07.05.01. PLC MAP</h4><img src="http://photo.wushaopei.com/qiniu660.png" width="80%">

<h4 id="07-05-02-Communication-Scenario"><a href="#07-05-02-Communication-Scenario" class="headerlink" title="07.05.02. Communication Scenario"></a>07.05.02. Communication Scenario</h4><img src="http://photo.wushaopei.com/qiniu661.png" width="80%">



<h3 id="07-06-Changer-Plan-Request-Report"><a href="#07-06-Changer-Plan-Request-Report" class="headerlink" title="07.06. Changer Plan Request Report"></a>07.06. Changer Plan Request Report</h3><p>仅适用于Changer Mode 使用。</p>
<p>当 source cassette 加载到 loading port 时，设备应自动向BC请求 “ Changer Plan ”。BC将对设备的更换计划进行回复。BC答复后，设备应按照更换计划要求CST到 unloading port ，然后 transfer Job 到指定的 target cassette 。</p>
<p>当更换计划完成，但 source cassette  仍有 job 时，设备应再次向BC请求“ Changer Plan ”，直到 source cassette 为空(所有 job 已取出)。</p>
<ul>
<li>Casette Map Flag： <ul>
<li>0 No Require (Cassette Map Empty)： Changer Plan Status = No Plan, set this flag = 0. </li>
<li>1 Require (Cassette Map Exist)：Changer Plan Status = Start, set this flag = 1</li>
</ul>
</li>
</ul>
<h4 id="07-06-01-PLC-MAP"><a href="#07-06-01-PLC-MAP" class="headerlink" title="07.06.01. PLC MAP"></a>07.06.01. PLC MAP</h4><img src="http://photo.wushaopei.com/qiniu662.png" width="80%">

<h4 id="07-06-02-Communication-Scenario"><a href="#07-06-02-Communication-Scenario" class="headerlink" title="07.06.02. Communication Scenario"></a>07.06.02. Communication Scenario</h4><img src="http://photo.wushaopei.com/qiniu663.png" width="80%">



<h3 id="07-07-Changer-Plan-Status-Report"><a href="#07-07-Changer-Plan-Status-Report" class="headerlink" title="07.07. Changer Plan Status Report"></a>07.07. Changer Plan Status Report</h3><p>仅适用于换模使用。 </p>
<p>在切换模式下，设备应向BC报告 “Changer Plan Status ” 如下: </p>
<ul>
<li>Plan Status：  <ul>
<li>0 No Plan： 设备不执行 “Changer Plan”; </li>
<li>1 Start： 设备启动执行  “Changer Plan”;  </li>
<li>2 End： 设备已经完成 “Changer Plan”;  </li>
<li>3 Ready：设备获得 “Changer Plan”  并准备执行  “Changer Plan”. </li>
</ul>
</li>
</ul>
<h4 id="07-07-01-PLC-MAP"><a href="#07-07-01-PLC-MAP" class="headerlink" title="07.07.01. PLC MAP"></a>07.07.01. PLC MAP</h4><img src="http://photo.wushaopei.com/qiniu664.png" width="80%">

<h4 id="07-07-02-Communication-Scenario"><a href="#07-07-02-Communication-Scenario" class="headerlink" title="07.07.02. Communication Scenario"></a>07.07.02. Communication Scenario</h4><img src="http://photo.wushaopei.com/qiniu665.png" width="80%">















































]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>解析 XML文件</title>
    <url>/2020/03/20/%E8%A7%A3%E6%9E%90-XML%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<img src="http://photo.wushaopei.com/qiniu138.png" width="100%">

<h2 id="java解析和生成xml"><a href="#java解析和生成xml" class="headerlink" title="java解析和生成xml"></a>java解析和生成xml</h2><h3 id="初次邂逅xml"><a href="#初次邂逅xml" class="headerlink" title="初次邂逅xml"></a>初次邂逅xml</h3><p> <strong>xml：</strong>可扩展<a href="https://baike.baidu.com/item/%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80" target="_blank" rel="noopener">标记语言</a>，<a href="https://baike.baidu.com/item/%E6%A0%87%E5%87%86%E9%80%9A%E7%94%A8%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/6805073" target="_blank" rel="noopener">标准通用标记语言</a>的子集，是一种用于标记电子文件使其具有结构性的<a href="https://baike.baidu.com/item/%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/5964436" target="_blank" rel="noopener">标记语言</a>。</p>
<p> <strong>表现：</strong>以 .xml 为文件扩展名的文件</p>
<p> <strong>存储：</strong>树形结构 </p>
<p><code>XML是一种类似于HTML的标记语言，XML是用来描述数据的，XML的标记不是在XML中预定义的，你必须定义自己的标记，XML使用文档类型定义(DTD)或者模式(Schema)来描述数据，XML使用DTD或者Schema后就是自描述的语言</code></p>
<h3 id="XML和HTML"><a href="#XML和HTML" class="headerlink" title="XML和HTML"></a><strong>XML和HTML</strong></h3><p><strong>XML扩展性比HTML强</strong> </p>
<blockquote>
<p>XML（Extensible Markup Languages）是扩展标记语言的英语缩写，他可以创建个性化的标记语言，可以称之为元语言。XML的标记语言可以自定义，这样可以提供更多的数据操作，而不像HTML一样，只能局限于按一定的格式在终端显示出来。HTML的功能只有浏览器放入显示和打印，仅仅适合静态网页的要求。</p>
</blockquote>
<p><strong>XML的语法比HTML严格</strong> </p>
<blockquote>
<p>由于XML的扩展性强，它需要稳定的基础规则来支持扩展。它的严格规则为：</p>
<p>①起始和结束的标签相匹配</p>
<p>②嵌套标签不能相互嵌套</p>
<p>③区分大小写</p>
</blockquote>
<p>相对应XML的严格规则，HTML语言并没有规定标签的绝对位置，也不区分大小写，而这些全部由浏览器来完成识别和更正。 </p>
<p><strong>XML与HTML互补</strong> </p>
<blockquote>
<p>XML可以获得应用之间的相应信息，提供终端的多项处理要求，也能被其他的解析器和工具所使用，在现阶段，XML可以转化成相应的HTML，来适应当前浏览器的需求。 </p>
</blockquote>
<h3 id="xml文件结构图："><a href="#xml文件结构图：" class="headerlink" title="xml文件结构图："></a><strong>xml文件结构图：</strong></h3><img src="http://photo.wushaopei.com/qiniu139.png" width="100%">



<h3 id="为什么用使用XML"><a href="#为什么用使用XML" class="headerlink" title="为什么用使用XML"></a><strong>为什么用使用XML</strong></h3><blockquote>
<p>思考1：不同应用程序之间的通信      </p>
<p>思考2：不同平台间的通信      </p>
<p>思考3：不同平台间的数据共享 </p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu140.png" width="100%">

<p><strong>场景： e.g. MSN中存储用户的聊天记录</strong></p>
<ol>
<li>xml文件是一个倒着的树状结构。 </li>
<li>xml文件中，节点名称区分大小写。<??>里面放的是版本信息，编码。 </li>
<li>xml文件作用： </li>
</ol>
<blockquote>
<ul>
<li>不同应用程序之间通信、传输信息(订票程序和支付程序)</li>
<li>不同系统间的通信(例：Windows系统和IOS系统)</li>
<li>不同平台间的数据共享(手机端和PC端)</li>
</ul>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu141.png" width="100%">

<blockquote>
<p>不同APP之间的通信，不同的平台间的通信，不同平台间的数据共享。XML文件主要用于存储以及传输信息。 通过xml文件存储小型数据。 即使用相同的xml文件将不同的应用或服务联系起来。 </p>
</blockquote>
<p><strong>xml 文件：</strong> </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">invoiceOrderStore</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InvoiceOrder</span> <span class="attr">id</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">invoiceOrder</span>&gt;</span>001<span class="tag">&lt;/<span class="name">invoiceOrder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyName</span>&gt;</span>冰与火之歌1<span class="tag">&lt;/<span class="name">companyName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">taxNumber</span>&gt;</span>冰与火之歌1<span class="tag">&lt;/<span class="name">taxNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountBank</span>&gt;</span>冰与火之歌1<span class="tag">&lt;/<span class="name">accountBank</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyAddress</span>&gt;</span>乔治马丁1<span class="tag">&lt;/<span class="name">companyAddress</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bankNumber</span>&gt;</span>20141<span class="tag">&lt;/<span class="name">bankNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyTelephone</span>&gt;</span>891<span class="tag">&lt;/<span class="name">companyTelephone</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountName</span>&gt;</span>891<span class="tag">&lt;/<span class="name">accountName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">InvoiceOrder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InvoiceOrder</span> <span class="attr">id</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">invoiceOrder</span>&gt;</span>002<span class="tag">&lt;/<span class="name">invoiceOrder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyName</span>&gt;</span>冰与火之歌2<span class="tag">&lt;/<span class="name">companyName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">taxNumber</span>&gt;</span>冰与火之歌2<span class="tag">&lt;/<span class="name">taxNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountBank</span>&gt;</span>冰与火之歌2<span class="tag">&lt;/<span class="name">accountBank</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyAddress</span>&gt;</span>乔治马丁2<span class="tag">&lt;/<span class="name">companyAddress</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bankNumber</span>&gt;</span>20142<span class="tag">&lt;/<span class="name">bankNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyTelephone</span>&gt;</span>892<span class="tag">&lt;/<span class="name">companyTelephone</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountName</span>&gt;</span>892<span class="tag">&lt;/<span class="name">accountName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">InvoiceOrder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InvoiceOrder</span> <span class="attr">id</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">invoiceOrder</span>&gt;</span>003<span class="tag">&lt;/<span class="name">invoiceOrder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyName</span>&gt;</span>冰与火之歌3<span class="tag">&lt;/<span class="name">companyName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">taxNumber</span>&gt;</span>冰与火之歌3<span class="tag">&lt;/<span class="name">taxNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountBank</span>&gt;</span>冰与火之歌3<span class="tag">&lt;/<span class="name">accountBank</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyAddress</span>&gt;</span>乔治马丁3<span class="tag">&lt;/<span class="name">companyAddress</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bankNumber</span>&gt;</span>20143<span class="tag">&lt;/<span class="name">bankNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">companyTelephone</span>&gt;</span>893<span class="tag">&lt;/<span class="name">companyTelephone</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">accountName</span>&gt;</span>893<span class="tag">&lt;/<span class="name">accountName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">InvoiceOrder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">invoiceOrderStore</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="解析XML的几种方式："><a href="#解析XML的几种方式：" class="headerlink" title="解析XML的几种方式："></a>解析XML的几种方式：</h2><h3 id="在Java程序中如何获取xml文件的内容"><a href="#在Java程序中如何获取xml文件的内容" class="headerlink" title="在Java程序中如何获取xml文件的内容"></a>在Java程序中如何获取xml文件的内容</h3><blockquote>
<p>在Java程序中读取xml文件的过程也称为—-解析xml文件 </p>
</blockquote>
<h3 id="解析的目的："><a href="#解析的目的：" class="headerlink" title="解析的目的："></a><strong>解析的目的：</strong></h3><blockquote>
<p> 获取节点名、节点值、属性名、属性值 </p>
</blockquote>
<h3 id="四种解析方式"><a href="#四种解析方式" class="headerlink" title="四种解析方式"></a>四种解析方式</h3><blockquote>
<p><strong>DOM</strong>  ,  <strong>SAX</strong> ,  (前两者Java官方提供的)</p>
<p><strong>DOM4J</strong>  ,  <strong>JDOM</strong>（后两者其它组织提供的）</p>
</blockquote>
<h3 id="实体Bean"><a href="#实体Bean" class="headerlink" title="实体Bean"></a>实体Bean</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvoiceOrder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Integer id ;</span><br><span class="line">    <span class="keyword">private</span> String invoiceOrder;</span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line">    <span class="keyword">private</span> String taxNumber;</span><br><span class="line">    <span class="keyword">private</span> String accountBank;</span><br><span class="line">    <span class="keyword">private</span> String companyAddress;</span><br><span class="line">    <span class="keyword">private</span> String bankNumber;</span><br><span class="line">    <span class="keyword">private</span> String companyTelephone;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="基于DOM解析器转化XML文档并解析："><a href="#基于DOM解析器转化XML文档并解析：" class="headerlink" title="基于DOM解析器转化XML文档并解析："></a>基于DOM解析器转化XML文档并解析：</h2><p><strong>说明：</strong> </p>
<p>​    <strong>DOM解析器</strong>把<strong>XML</strong>文档转化为一个包含其内容的树，并可以对树进行遍历。用<strong>DOM</strong>解析模型的优点是编程容易，开发人员只需要调用建树的指令，然后利用<strong>navigation</strong> <strong>APIs</strong>访问所需的树节点来完成任务。可以很容易的添加和修改树中的元素。然而由于使用<strong>DOM</strong>解析器的时候需要处理整个<strong>XML</strong>文档，所以对性能和内存的要求比较高，尤其是遇到很大的<strong>XML</strong>文件的时候。由于它的遍历能力，<strong>DOM</strong>解析器常用于<strong>XML</strong>文档需要频繁的改变的服务中。</p>
<p><strong>常见的节点类型：</strong> </p>
<table>
<thead>
<tr>
<th>节点类型</th>
<th>NodeType</th>
<th>Named Constant</th>
<th>nodeName的返回值</th>
<th>nodeValue的返回值</th>
</tr>
</thead>
<tbody><tr>
<td>Element</td>
<td>1</td>
<td>ELEMENT_NODE</td>
<td>element name</td>
<td>null</td>
</tr>
<tr>
<td>Attr</td>
<td>2</td>
<td>ATTRIBUTE_NODE</td>
<td>属性名称</td>
<td>属性值</td>
</tr>
<tr>
<td>Text</td>
<td>3</td>
<td>TEXT_NODE</td>
<td>#text</td>
<td>节点内容</td>
</tr>
</tbody></table>
<p><strong>案例代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.*;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>  用DOM方式读取xml文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> shaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 10:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadxmlByDom</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;InvoiceOrder&gt; invoiceOrderss = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; contents = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getDoXml</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 定义工厂API 使应用程序能够从XML文档获取生成DOM对象树的解析器</span></span><br><span class="line">        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">        <span class="comment">// 获取此类的实例之后，将可以从各种输入源解析XML</span></span><br><span class="line">        DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">        <span class="comment">// builder.parse(this.getClass().getResourceAsStream("/" + fileName));</span></span><br><span class="line">        <span class="comment">// Document接口表示整个HTML或XML文档，从概念上讲，它是文档树的根，并提供对文档数据的基本访问</span></span><br><span class="line">        Document document = builder.parse(<span class="keyword">this</span>.getClass().getResourceAsStream(</span><br><span class="line">                <span class="string">"/"</span> + fileName));</span><br><span class="line">        <span class="comment">// 获取根节点</span></span><br><span class="line">        Element root = document.getDocumentElement();</span><br><span class="line">        System.out.println(root.getNodeName());</span><br><span class="line"> </span><br><span class="line">        invoiceOrderss = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//读取database节点NodeList接口提供对节点的有序集合的抽象</span></span><br><span class="line">        NodeList nodeList = root.getElementsByTagName(<span class="string">"InvoiceOrder"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) &#123;</span><br><span class="line"> </span><br><span class="line">            InvoiceOrder invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 获取一个节点</span></span><br><span class="line">            Node node = nodeList.item(i);</span><br><span class="line">            <span class="comment">// 获取该节点所有属性</span></span><br><span class="line">            NamedNodeMap attributes = node.getAttributes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; attributes.getLength(); j++) &#123;</span><br><span class="line">                Node attribute = attributes.item(j);</span><br><span class="line">                System.out.println(attribute.getNodeName() + <span class="string">":"</span></span><br><span class="line">                        + attribute.getNodeValue());</span><br><span class="line">                invoiceOrder.setId(Integer.parseInt(attribute.getNodeValue()));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//获取所有子节点数据</span></span><br><span class="line">            NodeList childNodes = node.getChildNodes();</span><br><span class="line">            System.out.println(childNodes.getLength());</span><br><span class="line">           contents = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;childNodes.getLength();j+=<span class="number">2</span>)&#123;</span><br><span class="line">                Node item = childNodes.item(j);</span><br><span class="line">                String content = item.getFirstChild().getTextContent();</span><br><span class="line">                contents.add(content);</span><br><span class="line"><span class="comment">//                System.out.println(content);</span></span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span>(contents.size()&gt;=<span class="number">8</span>)&#123;</span><br><span class="line"> </span><br><span class="line">                invoiceOrder.setInvoiceOrder(contents.get(<span class="number">0</span>));</span><br><span class="line">                invoiceOrder.setCompanyName(contents.get(<span class="number">1</span>));</span><br><span class="line">                invoiceOrder.setTaxNumber(contents.get(<span class="number">2</span>));</span><br><span class="line">                invoiceOrder.setAccountBank(contents.get(<span class="number">3</span>));</span><br><span class="line">                invoiceOrder.setCompanyAddress(contents.get(<span class="number">4</span>));</span><br><span class="line">                invoiceOrder.setBankNumber(contents.get(<span class="number">5</span>));</span><br><span class="line">                invoiceOrder.setCompanyTelephone(contents.get(<span class="number">6</span>));</span><br><span class="line">                invoiceOrder.setAccountName(contents.get(<span class="number">7</span>));</span><br><span class="line">                invoiceOrderss.add(invoiceOrder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invoiceOrderss;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;InvoiceOrder&gt; doXml = <span class="keyword">new</span> ReadxmlByDom().getDoXml(<span class="string">"invoiceOrder.xml"</span>);</span><br><span class="line">            <span class="keyword">for</span> (InvoiceOrder invoiceOrder : doXml) &#123;</span><br><span class="line">                System.out.println(invoiceOrder.toString());</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中"><a href="#使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中" class="headerlink" title="使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中"></a>使用SAX方式解析XML与将解析的内容及xml结构形式保存至Java对象中</h2><h3 id="使用SAX方式解析XML"><a href="#使用SAX方式解析XML" class="headerlink" title="使用SAX方式解析XML"></a>使用SAX方式解析XML</h3><p><strong>说明：</strong> </p>
<blockquote>
<p>AX解析器采用了基于事件的模型，它在解析XML文档的时候可以触发一系列的事件，当发现给定的tag的时候，它可以激活一个回调方法，告诉该方法制定的标签已经找到。SAX对内存的要求通常会比较低，因为它让开发人员自己来决定所要处理的tag.特别是当开发人员只需要处理文档中所包含的部分数据时，SAX这种扩展能力得到了更好的体现。但用SAX解析器的时候编码工作会比较困难，而且很难同时访问同一个文档中的多处不同数据。</p>
</blockquote>
<p><strong>SAX解析原理：</strong> </p>
<p><code>通过自己创建的Handler处理类，去逐个分析遇到的每一个节点，从外层到里层</code></p>
<p><strong>startElement   endElement</strong> :</p>
<blockquote>
<p>1.通过SAXParserFactory的静态newInstance()方法获取SAXParserFactory实例factory<br>2.通过SAXParserFactory实例的newSAXParser（）方法返回SAXParser实例parser<br>3.创建一个类继承DefaultHandler，重写其中的一些方法进行业务处理并创建这个类的实例handler</p>
</blockquote>
<p><strong>SAX解析XML文件的结点属性：</strong> </p>
<blockquote>
<p>重写startElement(String uri, String localName, String qName,Attributes attributes)方法，</p>
<p>获取属性名 : attributes.getValue(index);</p>
<p>获取属性值 ：attributes.getValue(index);</p>
</blockquote>
<p><strong>AX解析XML的速度比DOM的块</strong>.</p>
<p>SAX的解析XML的解析器，需要<strong>重写startElement(</strong>)开始解析的方法and endElemaent()方法 结束解析的方法and characters()方法<br><strong>重写charaters()</strong>方法时，String(byte[] bytes,int offset,int length)的构造方法进行数组的传递 再去除解析时多余空格</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!value.trim().equals(<span class="string">""</span>))&#123;</span><br><span class="line"> </span><br><span class="line">  System.out.println(value);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>案例代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 用SAX解析xml文件时需要的handler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> shaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 14:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SAXParseHandler</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> List&lt;InvoiceOrder&gt; list;         <span class="comment">//存放解析到的invoiceOrder数组</span></span><br><span class="line">    <span class="keyword">private</span> InvoiceOrder invoiceOrder;               <span class="comment">//存放当前解析的invoiceOrder</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String content = <span class="keyword">null</span>;   <span class="comment">//存放当前节点值</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Integer count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始解析xml文档时调用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.startDocument();</span><br><span class="line">        System.out.println(<span class="string">"开始解析xml文件"</span>);</span><br><span class="line">        list = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档解析完成后调用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.endDocument();</span><br><span class="line">        System.out.println(<span class="string">"xml文件解析完毕"</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始解析节点时调用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.startElement(uri, localName, qName, attributes);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//当节点名为invoiceOrder时,获取invoiceOrder的属性id</span></span><br><span class="line">        <span class="keyword">if</span>(qName.equals(<span class="string">"InvoiceOrder"</span>))&#123;</span><br><span class="line">            invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line">            String id = attributes.getValue(<span class="string">"id"</span>);<span class="comment">//System.out.println("id值为"+id);</span></span><br><span class="line">            invoiceOrder.setId(Integer.parseInt(id));</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//xml解析张数</span></span><br><span class="line">            count ++ ;</span><br><span class="line">            System.out.println( count + <span class="string">"--- 次"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *节点解析完毕时调用此方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *<span class="doctag">@param</span> qName 节点名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.endElement(uri, localName, qName);</span><br><span class="line">        <span class="keyword">if</span>(qName.equals(<span class="string">"invoiceOrder"</span>))&#123;</span><br><span class="line">            invoiceOrder.setInvoiceOrder(content);</span><br><span class="line">            System.out.println(<span class="string">"发票单号"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"companyName"</span>))&#123;</span><br><span class="line">            invoiceOrder.setCompanyName(content);</span><br><span class="line">              System.out.println(<span class="string">"公司名"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"taxNumber"</span>))&#123;</span><br><span class="line">            invoiceOrder.setTaxNumber(content);</span><br><span class="line">              System.out.println(<span class="string">"金额"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"accountBank"</span>))&#123;</span><br><span class="line">            invoiceOrder.setAccountBank(content);</span><br><span class="line">              System.out.println(<span class="string">"开户行"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"companyAddress"</span>))&#123;</span><br><span class="line">            invoiceOrder.setCompanyAddress(content);</span><br><span class="line">              System.out.println(<span class="string">"公司地址"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"bankNumber"</span>))&#123;</span><br><span class="line">            invoiceOrder.setBankNumber(content);</span><br><span class="line">              System.out.println(<span class="string">"账号"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"companyTelephone"</span>))&#123;</span><br><span class="line">            invoiceOrder.setCompanyTelephone(content);</span><br><span class="line">              System.out.println(<span class="string">"公司电话"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"accountName"</span>))&#123;</span><br><span class="line">            invoiceOrder.setAccountName(content);</span><br><span class="line">              System.out.println(<span class="string">"账户类型"</span>+<span class="string">"---"</span>+content);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(qName.equals(<span class="string">"invoiceOrder"</span>))&#123;         <span class="comment">//当结束当前invoiceOrder解析时,将该invoiceOrder添加到数组后置为空，方便下一次invoiceOrder赋值</span></span><br><span class="line">            list.add(invoiceOrder);</span><br><span class="line">            invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此方法用来获取节点的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span>[] ch, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">super</span>.characters(ch, start, length);</span><br><span class="line"> </span><br><span class="line">        content = <span class="keyword">new</span> String(ch, start, length);</span><br><span class="line">        <span class="comment">//收集不为空白的节点值</span></span><br><span class="line"><span class="comment">//      if(!content.trim().equals(""))&#123;</span></span><br><span class="line"><span class="comment">//          System.out.println("节点值为："+content);</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">()</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParser;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>  SAX方式解析XML</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 14:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadXmlBySAX</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> SAXParserFactory sParserFactory = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> SAXParser parser = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SAXParserFactory sParserFactory = SAXParserFactory.newInstance();</span><br><span class="line">        SAXParser parser = sParserFactory.newSAXParser();</span><br><span class="line"> </span><br><span class="line">        SAXParseHandler handler = <span class="keyword">new</span> SAXParseHandler();</span><br><span class="line">        parser.parse(fileName, handler);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> handler.getInvoiceOrders();</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            invoiceOrders = <span class="keyword">new</span> ReadXmlBySAX().getInvoiceOrders(<span class="string">"src/main/resources/invoiceOrder.xml"</span>);</span><br><span class="line">            <span class="keyword">for</span>(InvoiceOrder invoiceOrder: invoiceOrders)&#123;</span><br><span class="line">                System.out.println(invoiceOrder);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="将解析的内容及xml结构形式保存至Java对象中"><a href="#将解析的内容及xml结构形式保存至Java对象中" class="headerlink" title="将解析的内容及xml结构形式保存至Java对象中"></a>将解析的内容及xml结构形式保存至Java对象中</h3><p><strong>SAX解析：</strong>  </p>
<blockquote>
<p>1、获取一个SAXParserFactory的实例:SAXParserFactory factory = SAXParserFactory.newInstance();</p>
<p>2、通过factory获取SAXParser实例：SAXParser parser = factory.newSAXParser();</p>
<p>3、创建SAXParserHandler对象：SAXParserHandler handler = new SAXParserHandler();</p>
<p>4、将xml文件和解析方式handler加载到SAXParser实例：parser.parse(“books.xml”,handler);</p>
</blockquote>
<p>​    解析的时候，是     <code>startElement-characters-endElement ， characters</code>解析完一个属性，就到  <code>endElement</code>，然后又解析一个属性又到  <code>endElement</code>,最后解析完全部属性，到  <code>endElement</code>又到  <code>startElement</code>开始下一个节点。</p>
<p>​    <code>ArrayList</code> 保存对象 <code>ArrayList&lt;Book&gt; BookList=new ArrayList&lt;Book&gt;();</code></p>
<p>​    <code>BookList.add（book）;book=null;</code> 后继续遍历</p>
<p>​    <code>public void startElement(String uri, String localName, String qName,Attributes attributes) throws SAXException// qName</code>是String类型节点名称；attributes是Attributes类型的实例，属性的意思；</p>
<h2 id="用JDOM方式读取xml文件"><a href="#用JDOM方式读取xml文件" class="headerlink" title="用JDOM方式读取xml文件"></a>用JDOM方式读取xml文件</h2><h3 id="说明："><a href="#说明：" class="headerlink" title="说明："></a><strong>说明：</strong></h3><p>​    JDOM仅使用具体类而不使用接口。API大量使用了Collections类；JDOM自身不包含解析器。它通常使用SAX2解析器来解析和验证输入XML文档（尽管它还可以将以前构造的DOM表示作为输入）。它包含一些转换器以将JDOM表示输出成SAX2事件流、DOM模型或XML文本文档。JDOM是在Apache许可证变体下发布的开放源码。</p>
<h3 id="JDOM解析文件步骤"><a href="#JDOM解析文件步骤" class="headerlink" title="JDOM解析文件步骤"></a><strong>JDOM解析文件步骤</strong></h3><p>准备：导入jar包<br>    1.创建一个SAXBuilder对象<br>              <code>SAXBuilder saxbuilder=newSAXBuilder();</code></p>
<p>​    2.创建输入流，将xml文件加载到输入流中<br>            <code>Inputstream in=new FileInputstream(&quot;xxx.xml&quot;);</code></p>
<p>​    3.通过SAXBuilder的Build方法将输入流加载到saxb中获取dom对象<br>            <code>Document doc = saxbuilder.build(in);</code></p>
<p>​    4.通过document对象获取xml文件的根结点<br>           <code>Element rootElement =doc.getRootElement();</code></p>
<p>​    5.获取根结点下的子节点的List集合</p>
<h3 id="案例代码："><a href="#案例代码：" class="headerlink" title="案例代码："></a><strong>案例代码：</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Attribute;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Document;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Element;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.JDOMException;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.input.SAXBuilder;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 用JDOM方式读取xml文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 15:14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadXMLByJDom</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> List&lt;InvoiceOrder&gt; invoiceOrders = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> InvoiceOrder invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        SAXBuilder saxBuilder = <span class="keyword">new</span> SAXBuilder();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document document = saxBuilder.build(<span class="keyword">new</span> FileInputStream(fileName));</span><br><span class="line">            <span class="comment">//获取根节点bookstore</span></span><br><span class="line">            Element rootElement = document.getRootElement();</span><br><span class="line">            <span class="comment">//获取根节点的子节点，返回子节点的数组</span></span><br><span class="line">            List&lt;Element&gt; bookList = rootElement.getChildren();</span><br><span class="line">            invoiceOrders = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Element bookElement : bookList) &#123;</span><br><span class="line">                invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line">                <span class="comment">//获取bookElement的属性</span></span><br><span class="line">                List&lt;Attribute&gt; bookAttributes = bookElement.getAttributes();</span><br><span class="line">                <span class="keyword">for</span> (Attribute attribute : bookAttributes) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (attribute.getName().equals(<span class="string">"id"</span>)) &#123;</span><br><span class="line">                        String id = attribute.getValue(); <span class="comment">//System.out.println(id);</span></span><br><span class="line">                        invoiceOrder.setId(Integer.parseInt(id));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//获取bookElement的子节点</span></span><br><span class="line">                List&lt;Element&gt; children = bookElement.getChildren();</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">for</span> (Element child : children) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (child.getName().equals(<span class="string">"invoiceOrder"</span>)) &#123;</span><br><span class="line">                        String invoiceOrderid = child.getValue();</span><br><span class="line">                        invoiceOrder.setInvoiceOrder(invoiceOrderid);</span><br><span class="line"><span class="comment">//                        System.out.println("发票单号"+"---"+invoiceOrderid);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"companyName"</span>)) &#123;</span><br><span class="line">                        String companyName = child.getValue();</span><br><span class="line">                        invoiceOrder.setCompanyName(companyName);</span><br><span class="line"><span class="comment">//                        System.out.println("公司名"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"taxNumber"</span>)) &#123;</span><br><span class="line">                        String taxNumber = child.getValue();</span><br><span class="line">                        invoiceOrder.setTaxNumber(taxNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("金额"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"accountBank"</span>)) &#123;</span><br><span class="line">                        String accountBank = child.getValue();</span><br><span class="line">                        invoiceOrder.setAccountBank(accountBank);</span><br><span class="line"><span class="comment">//                        System.out.println("开户行"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"companyAddress"</span>)) &#123;</span><br><span class="line">                        String companyAddress = child.getValue();</span><br><span class="line">                        invoiceOrder.setCompanyAddress(companyAddress);</span><br><span class="line"><span class="comment">//                        System.out.println("公司地址"+"---"+content);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"bankNumber"</span>)) &#123;</span><br><span class="line">                        String bankNumber = child.getValue();</span><br><span class="line">                        invoiceOrder.setBankNumber(bankNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("账号"+"---"+bankNumber);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"companyTelephone"</span>)) &#123;</span><br><span class="line">                        String companyTelephone = child.getValue();</span><br><span class="line">                        invoiceOrder.setCompanyTelephone(companyTelephone);</span><br><span class="line"><span class="comment">//                        System.out.println("公司电话"+"---"+companyTelephone);</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equals(<span class="string">"accountName"</span>)) &#123;</span><br><span class="line">                        String accountName = child.getValue();</span><br><span class="line">                        invoiceOrder.setAccountName(accountName);</span><br><span class="line"><span class="comment">//                        System.out.println("账户类型"+"---"+accountName);</span></span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                invoiceOrders.add(invoiceOrder);</span><br><span class="line">                invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JDOMException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> invoiceOrders;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">           String fileName = <span class="string">"src/main/resources/invoiceOrder.xml"</span>;</span><br><span class="line">        List&lt;InvoiceOrder&gt; invoiceOrders= <span class="keyword">new</span> ReadXMLByJDom().getInvoiceOrders(fileName);</span><br><span class="line">        <span class="keyword">for</span>(InvoiceOrder invoiceOrder : invoiceOrders)&#123;</span><br><span class="line">            System.out.println(invoiceOrder);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="用DOM4J方法读取xml文件"><a href="#用DOM4J方法读取xml文件" class="headerlink" title="用DOM4J方法读取xml文件"></a>用DOM4J方法读取xml文件</h3><h4 id="说明：-1"><a href="#说明：-1" class="headerlink" title="说明："></a><strong>说明：</strong></h4><p>​    DOM4J使用接口和抽象基本类方法。DOM4J大量使用了API中的Collections类，但是在许多情况下，它还提供一些替代方法以允许更好的性能或更直接的编码方法。直接好处是，虽然DOM4J付出了更复杂 的API的代价，但是它提供了比JDOM大得多的灵活性。 DOM4J性能最好，连Sun的JAXM也在用DOM4J.目前许多开源项目中大量采用DOM4J， 例如大名鼎鼎的Hibernate也用DOM4J来读取XML配置文件。</p>
<p><strong>案例代码：</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.poiutis.xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.poiutis.model.InvoiceOrder;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Attribute;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Element;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> 用DOM4J方法读取xml文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/8/1 15:34</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadXMLByDom4j</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> List&lt;InvoiceOrder&gt; invoiceOrders = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> InvoiceOrder invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InvoiceOrder&gt; <span class="title">getInvoiceOrders</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document document = reader.read(file);</span><br><span class="line">            Element bookstore = document.getRootElement();</span><br><span class="line">            Iterator storeit = bookstore.elementIterator();</span><br><span class="line"> </span><br><span class="line">            invoiceOrders = <span class="keyword">new</span> ArrayList&lt;InvoiceOrder&gt;();</span><br><span class="line">            <span class="keyword">while</span> (storeit.hasNext()) &#123;</span><br><span class="line"> </span><br><span class="line">                invoiceOrder = <span class="keyword">new</span> InvoiceOrder();</span><br><span class="line">                Element bookElement = (Element) storeit.next();</span><br><span class="line">                <span class="comment">//遍历bookElement的属性</span></span><br><span class="line">                List&lt;Attribute&gt; attributes = bookElement.attributes();</span><br><span class="line">                <span class="keyword">for</span> (Attribute attribute : attributes) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (attribute.getName().equals(<span class="string">"id"</span>)) &#123;</span><br><span class="line">                        String id = attribute.getValue();<span class="comment">//System.out.println(id);</span></span><br><span class="line">                        invoiceOrder.setId(Integer.parseInt(id));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                Iterator bookit = bookElement.elementIterator();</span><br><span class="line">                <span class="keyword">while</span> (bookit.hasNext()) &#123;</span><br><span class="line">                    Element child = (Element) bookit.next();</span><br><span class="line"><span class="comment">//                    String nodeName = child.getName();</span></span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">if</span>(child.getName().equals(<span class="string">"invoiceOrder"</span>))&#123;</span><br><span class="line">                        String invoiceOrderid = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setInvoiceOrder(invoiceOrderid);</span><br><span class="line"><span class="comment">//                        System.out.println("发票单号"+"---"+invoiceOrderid);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"companyName"</span>))&#123;</span><br><span class="line">                        String companyName = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setCompanyName(companyName);</span><br><span class="line"><span class="comment">//                        System.out.println("公司名"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"taxNumber"</span>))&#123;</span><br><span class="line">                        String taxNumber = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setTaxNumber(taxNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("金额"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"accountBank"</span>))&#123;</span><br><span class="line">                        String accountBank = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setAccountBank(accountBank);</span><br><span class="line"><span class="comment">//                        System.out.println("开户行"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"companyAddress"</span>))&#123;</span><br><span class="line">                        String companyAddress = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setCompanyAddress(companyAddress);</span><br><span class="line"><span class="comment">//                        System.out.println("公司地址"+"---"+content);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"bankNumber"</span>))&#123;</span><br><span class="line">                        String bankNumber = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setBankNumber(bankNumber);</span><br><span class="line"><span class="comment">//                        System.out.println("账号"+"---"+bankNumber);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"companyTelephone"</span>))&#123;</span><br><span class="line">                        String companyTelephone = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setCompanyTelephone(companyTelephone);</span><br><span class="line"><span class="comment">//                        System.out.println("公司电话"+"---"+companyTelephone);</span></span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.getName().equals(<span class="string">"accountName"</span>))&#123;</span><br><span class="line">                        String accountName = child.getStringValue();</span><br><span class="line">                        invoiceOrder.setAccountName(accountName);</span><br><span class="line"><span class="comment">//                        System.out.println("账户类型"+"---"+accountName);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                invoiceOrders.add(invoiceOrder);</span><br><span class="line">                invoiceOrder = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line"> </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> invoiceOrders;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">          File file = <span class="keyword">new</span> File(<span class="string">"src/main/resources/invoiceOrder.xml"</span>);</span><br><span class="line">        List&lt;InvoiceOrder&gt; invoiceOrders = <span class="keyword">new</span> ReadXMLByDom4j().getInvoiceOrders(file);</span><br><span class="line">        <span class="keyword">for</span> (InvoiceOrder invoiceOrder : invoiceOrders) &#123;</span><br><span class="line">            System.out.println(invoiceOrder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p> ]]></content>
      <categories>
        <category>JavaWeb</category>
      </categories>
  </entry>
  <entry>
    <title>SpringBoot原理（二）自动配置原理</title>
    <url>/2020/03/13/SpringBoot%E5%8E%9F%E7%90%86%EF%BC%88%E4%BA%8C%EF%BC%89%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="Spring-Boot-的自动配置原理"><a href="#Spring-Boot-的自动配置原理" class="headerlink" title="Spring Boot 的自动配置原理"></a><strong>Spring Boot</strong> 的自动配置原理</h2><p>本节主要分析Spring Boot 的自动配置原理，主要通过源码进行分析。首先引入一段代码，来开始我们的<strong>原理解析步骤：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述是主启动类的代码，我们从中可以看到在类名前面添加了一个注解<strong>@SpringBootApplication</strong>；在前面的<strong>SpringBoot</strong> 的自启动配置一文中，我们可以得知，在主启动类中，<strong>main</strong>方法中的 <strong>SpringApplication.run(DemoApplication.class,args)；</strong>是对主启动类进行初始化并启动<strong>IOC</strong>容器进行配置bean的管理。</p>
<p>在这里，我们可以发现，<strong>SpringBoot</strong> 中比 <strong>Spring</strong> 要优秀的一点 <strong>自动配置</strong> 的特性并没有表现在main方法中，从代码中，我们可以看出，也许 <strong>@SpringBootApplication</strong> 这一个注解会与<strong>SpringBoot</strong> 的自动配置有关，本文将从这方面下手，根据源码进行分析。</p>
<p>使用过<strong>Spring Boot</strong> 的我们都知道，<strong>SpringBoot</strong> 中有一个全局配置文件： application.properties 或 <strong>application.yml</strong>。</p>
<p>我们在项目开发过程中对程序配置的 端口、数据库等属性都可以在这个文件中进行配置，最常见的配置有： server.port 、logging.level.* 等等，然而我们实际用到的往往只是很少的一部分，那么这些属性是否有据可依呢？答案是肯定的，这些属性都可以在官方文档中查找到：</p>
<p><a href="https://docs.spring.io/spring-boot/docs/2.1.0.RELEASE/reference/htmlsingle/#common-application-properties" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/2.1.0.RELEASE/reference/htmlsingle/#common-application-properties</a></p>
<p>在<strong>Appendix A. Common application properties</strong>小节下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># ===================================================================</span><br><span class="line"># COMMON SPRING BOOT PROPERTIES</span><br><span class="line">#</span><br><span class="line"># This sample file is provided as a guideline. Do NOT copy it in its</span><br><span class="line"># entirety to your own application.               ^^^</span><br><span class="line"># ===================================================================</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"># ----------------------------------------</span><br><span class="line"># CORE PROPERTIES</span><br><span class="line"># ----------------------------------------</span><br><span class="line">debug=false # Enable debug logs.</span><br><span class="line">trace=false # Enable trace logs.</span><br><span class="line"> </span><br><span class="line"># LOGGING</span><br><span class="line">logging.config= # Location of the logging configuration file. For instance, `classpath:logback.xml` for Logback.</span><br><span class="line">logging.exception-conversion-word=%wEx # Conversion word used when logging exceptions.</span><br><span class="line">logging.file= # Log file name (for instance, `myapp.log`). Names can be an exact location or relative to the current directory.</span><br><span class="line">logging.file.max-history=0 # Maximum of archive log files to keep. Only supported with the default logback setup.</span><br><span class="line">logging.file.max-size=10MB # Maximum log file size. Only supported with the default logback setup.</span><br><span class="line">logging.group.*= # Log groups to quickly change multiple loggers at the same time. For instance, `logging.level.db=org.hibernate,org.springframework.jdbc`.</span><br><span class="line">logging.level.*= # Log levels severity mapping. For instance, `logging.level.org.springframework=DEBUG`.</span><br><span class="line">logging.path= # Location of the log file. For instance, `/var/log`.</span><br><span class="line">logging.pattern.console= # Appender pattern for output to the console. Supported only with the default Logback setup.</span><br><span class="line">logging.pattern.dateformat=yyyy-MM-dd HH:mm:ss.SSS # Appender pattern for log date format. Supported only with the default Logback setup.</span><br><span class="line">logging.pattern.file= # Appender pattern for output to a file. Supported only with the default Logback setup.</span><br><span class="line">logging.pattern.level=%5p # Appender pattern for log level. Supported only with the default Logback setup.</span><br><span class="line">logging.register-shutdown-hook=false # Register a shutdown hook for the logging system when it is initialized.</span><br><span class="line"> </span><br><span class="line"># AOP</span><br><span class="line">spring.aop.auto=true # Add @EnableAspectJAutoProxy.</span><br><span class="line">spring.aop.proxy-target-class=true # Whether subclass-based (CGLIB) proxies are to be created (true), as opposed to standard Java interface-based proxies (false).</span><br></pre></td></tr></table></figure>

<p>我们对自动配置大胆做个猜测，在<strong>Spring Boot</strong> 中有个机制，它将通过<strong>pom</strong>.<strong>xml</strong> 依赖加载到的诸如 <strong>mybatis</strong>、<strong>mysql</strong>、<strong>activemq</strong>等的jar 包创建对应的 <strong>bean</strong>，然后将bean放到容器中，并通过在 <strong>application.properties</strong> 或 <strong>application.yml</strong> 文件中进行配置属性参数映射到对应的 <strong>bean</strong> 中的属性上，从而实现如mysql 的<font color=red>数据库链接地址、密码、用户名</font>的配置等操作。</p>
<p>那么，在这里我们针对猜测的自动配置过程提出三个关键性问题，分别是：</p>
<ol>
<li>SpringBoot 中怎么将引入的依赖包的类<font color=red>创建bean</bean>并加入到容器中的？</li>
<li>springboot 中怎么获取到配置文件 application.properties 或application.yml 中的属性参数？</li>
<li>springboot 怎么将获取到的配置文件参数映射到bean中的属性上？</li>
</ol>
<h3 id="配置加载依赖并创建bean加入到容器中："><a href="#配置加载依赖并创建bean加入到容器中：" class="headerlink" title="配置加载依赖并创建bean加入到容器中："></a><strong>配置加载依赖并创建bean加入到容器中：</strong></h3><h4 id="引入-jar"><a href="#引入-jar" class="headerlink" title="引入 jar"></a>引入 jar</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">    <span class="comment">&lt;!--mybatis 开发包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--springboot web模块支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--druid 的数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th align="right"><strong>spring-boot-starter-web</strong></th>
<th align="left">包自动帮我们引入了web模块开发需要的相关jar包，</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>mybatis-spring-boot-starter</strong></td>
<td align="left">帮我们引入了dao开发相关的jar包。</td>
</tr>
<tr>
<td align="right"><strong>spring-boot-starter-xxx</strong></td>
<td align="left">是官方提供的starter，xxx-spring-boot-starter是第三方提供的starter。</td>
</tr>
</tbody></table>
<p><strong>如下图中：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu113.png" width="60%">

<p>从以下的截图可以看出在这个mybatis-spring-boot-starter 中，并没有任何源码，只有一个pom文件，它的作用就是帮我们引入了相关jar包。 </p>
<img src="http://photo.wushaopei.com/qiniu114.png" width="60%">

<p>在这里我们看一下SpringBoot 中数据源的配置方案： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">     driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">     url: jdbc:mysql:<span class="comment">//localhost:3333/aiicp-gxzx?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;autoReconnect=true&amp;serverTimezone=UTC</span></span><br><span class="line">     username: root</span><br><span class="line">     password: root</span><br><span class="line">     type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">     dbcp2:</span><br><span class="line">       min-idle: <span class="number">5</span></span><br><span class="line">       initial-size: <span class="number">5</span></span><br><span class="line">       max-total: <span class="number">5</span></span><br><span class="line">       max-wait-millis: <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p>在这里，<strong>starter</strong>机制帮我们完成了项目起步所需要的相关jar包。我们知道，传统的<strong>spring</strong>应用中需要在 <strong>application.xml</strong> 中配置很多<strong>bean</strong>的，比如 <strong>dataSource</strong> 的配置，<strong>transactionManager</strong>的配置…… <strong>springboot</strong>是如何帮我们完成这些<strong>bean</strong>的配置的呢？</p>
<blockquote>
<p> —— 自动配置</p>
</blockquote>
<h4 id="基于java代码的bean的配置"><a href="#基于java代码的bean的配置" class="headerlink" title="基于java代码的bean的配置"></a>基于java代码的bean的配置</h4><p>​    以mybatis为例，引入的mybatis 包不只有一个pom.xml文件， 还有一个关键性的包：mybatis-spring-boot-autoconfigure这个包 </p>
<img src="http://photo.wushaopei.com/qiniu115.png" width="60%">

<p>从mybatis-spring-boot-autoconfigure包下的文件名我们可以知道<strong>MybatisAutoConfiguration</strong>类是<strong>自动配置</strong>的核心文件;我们进入该文件看看， </p>
<img src="http://photo.wushaopei.com/qiniu116.png" width="60%">

<p>从截图中我们可以看到，类名和方法名前分别添加了<strong>@Configuration 、@Bean两个注解，了解Spring的都知道，这两个注解一起使用就可以创建一个基于java代码的配置类，可以用来替代相应的xml配置文件。</strong></p>
<p><strong>@Configuration注解的类可以看作是能生产让Spring IoC容器管理的Bean实例的工厂。</strong></p>
<p><strong>@Bean注解告诉Spring，一个带有@Bean的注解方法将返回一个对象，该对象应该被注册到spring容器中。</strong></p>
<h5 id="传统的基于xml的bean配置方法如下："><a href="#传统的基于xml的bean配置方法如下：" class="headerlink" title="传统的基于xml的bean配置方法如下："></a>传统的基于xml的bean配置方法如下：</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"car"</span> <span class="attr">class</span>=<span class="string">"com.mmall.Car"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"wheel"</span> <span class="attr">ref</span> = <span class="string">"wheel"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"wheel"</span> <span class="attr">class</span>=<span class="string">"com.mmall.Wheel"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="相当于用基于java代码的配置方式："><a href="#相当于用基于java代码的配置方式：" class="headerlink" title="相当于用基于java代码的配置方式："></a>相当于用基于java代码的配置方式：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Conf</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">car</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        Car car = <span class="keyword">new</span> Car();  </span><br><span class="line">        car.setWheel(wheel());  </span><br><span class="line">        <span class="keyword">return</span> car;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="meta">@Bean</span>   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Wheel <span class="title">wheel</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Wheel();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此，我们可以知道，上面的 <strong>MybatisAutoConfiguration</strong>这个类，自动帮我们生成了<strong>SqlSessionFactory</strong> 这些 <strong>Mybatis</strong> 的重要实例并叫个<strong>spring</strong>容器管理，从而完成<strong>bean</strong>的自动注册。 </p>
<h4 id="springboot-特有的常见条件依赖注解："><a href="#springboot-特有的常见条件依赖注解：" class="headerlink" title="springboot 特有的常见条件依赖注解："></a><strong>springboot</strong> 特有的常见条件依赖注解：</h4><table>
<thead>
<tr>
<th>@ConditionalOnBean</th>
<th>仅在当前上下文中存在某个bean时，才会实例化这个Bean</th>
</tr>
</thead>
<tbody><tr>
<td>@ConditionalOnClass</td>
<td>某个class位于类路径上，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnExpression</td>
<td>当表达式为true的时候，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnMissingBean</td>
<td>仅在当前上下文中不存在某个bean时，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnMissingClass</td>
<td>某个class在类路径上不存在的时候，才会实例化这个Bean</td>
</tr>
<tr>
<td>@ConditionalOnNotWebApplication</td>
<td>不是web应用时才会实例化这个Bean</td>
</tr>
<tr>
<td>@AutoConfigureAfter</td>
<td>在某个bean完成自动配置后实例化这个bean</td>
</tr>
<tr>
<td>@AutoConfigureBefore</td>
<td>在某个bean完成自动配置前实例化这个bean</td>
</tr>
</tbody></table>
<p>​    到这里，我们知道了，要想完成Mybatis的自动配置，需要在类路径中存在 <code>SqlSessionFactory.class、SqlSessionFactoryBean.class</code> 这两个类，同时也需要有DataSource这个bean存在且已经自动注册到容器中。</p>
<p>​    根据 <em><code>MybatisAutoConfiguration</code></em> 的名称我们可以得知，在<code>Springboot</code> 中，引入自动配置的DataSource的包的名称应该是 <code>DataSourceAutoConfiguration</code>;</p>
<p>​    通过查看该包所在目录我们知道这个包又属于spring-boot-autoconfigure-2.0.4.RELEASE.jar这个包，自动配置这个包帮们引入了<code>jdbc、kafka、logging、mongo**、**quartz</code>等包。很多包需要我们引入相应jar后自动配置才生效。 </p>
<img src="http://photo.wushaopei.com/qiniu117.png" width="60%">

<h3 id="获取到配置文件-application-properties-或application-yml-中的参数"><a href="#获取到配置文件-application-properties-或application-yml-中的参数" class="headerlink" title="获取到配置文件 application.properties 或application.yml 中的参数"></a><strong>获取到配置文件 application.properties 或application.yml 中的参数</strong></h3><h4 id="Bean-参数的获取"><a href="#Bean-参数的获取" class="headerlink" title="Bean 参数的获取"></a><strong>Bean 参数的获取</strong></h4><p>在这里，我们要解决的是怎么从 <code>.properties或yml</code>文件中获取参数，让<code>springboot</code>知道配置文件中有哪些参数？</p>
<p>在<code>DataSourceAutoConfiguration</code>类里面，我们注意到使用了<code>EnableConfigurationProperties</code>这个注解。在该注解中引入了 <code>DataSourceProperties.class</code> 这个字节码文件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123;DataSource<span class="class">.<span class="keyword">class</span>, <span class="title">EmbeddedDatabaseType</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(</span>&#123;DataSourceProperties<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(</span>&#123;DataSourcePoolMetadataProvidersConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">DataSourceInitializationConfiguration</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">DataSourceAutoConfiguration</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击进入查看，DataSourceProperties中封装了数据源的各个属性，且使用了注解ConfigurationProperties指定了配置文件的前缀。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(</span><br><span class="line">    prefix = <span class="string">"spring.datasource"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProperties</span> <span class="keyword">implements</span> <span class="title">BeanClassLoaderAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> generateUniqueName;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends DataSource&gt; type;</span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String jndiName;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@EnableConfigurationProperties与@ConfigurationProperties这两个注解有什么用呢？我们先看一个例子： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo_started;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanClassLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> PropertiesBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/1/31 20:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"spring.datasource"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">//省略getter、setter...</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PropertiesBean&#123;"</span> +</span><br><span class="line">                <span class="string">"url='"</span> + url + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo_started;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SpringbootMybatisDemoApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/1/31 20:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.example"</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootMybatisDemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//SpringApplication.run(SpringbootMybatisDemoApplication.class, args);</span></span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(SpringbootMybatisDemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        <span class="comment">//获取yml配置转换后的bean</span></span><br><span class="line">        System.out.println(<span class="string">"----------------------"</span>+context.getBean(PropertiesBean<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行结果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu118.png" width="60%">

<p>从运行结果可以看出<code>@ConfigurationProperties与@EnableConfigurationPropertie</code>的作用就是：</p>
<p><code>@ConfigurationProperties</code>注解的作用是把yml或者properties配置文件转化为bean。</p>
<p><code>@EnableConfigurationProperties</code>注解的作用是使<code>@ConfigurationProperties</code>注解生效。如果只配置<code>@ConfigurationProperties</code>注解，在spring容器中是获取不到<code>yml或者properties</code>配置文件转化的bean的。</p>
<p>通过这种方式，把<code>yml或者properties</code>配置参数转化为bean，这些bean又是如何被发现与加载的？</p>
<h4 id="发现bean-并进行加载"><a href="#发现bean-并进行加载" class="headerlink" title="发现bean 并进行加载"></a><strong>发现bean 并进行加载</strong></h4><p>到了这里，我们解决了两个问题，知道了通过pom.xml加载到程序中的jar包是怎么被Springboot进行自动配置，也知道了Springboot中是怎么读取并使用 .properties或 .yml 文件的参数的。接下来我们需要将两者进行关联，参数Bean是怎么被发现，并加载到容器中与自动配置的bean进行关联映射的？</p>
<h4 id="Bean的发现"><a href="#Bean的发现" class="headerlink" title="Bean的发现"></a>Bean的发现</h4><p>从前面<strong>Springboot</strong>的自启动机制中可以知道，<strong>Springboot</strong> 默认扫描启动类所在的包下的主类与子类的所有组件，但并没有包括依赖包中的类，那么依赖包中的<strong>bean</strong>是如何被发现和加载的？ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mmall;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在前面说过，<strong>SpringBoot</strong> 的自动配置是由<strong>@SpringBootApplication</strong>这个注解起得作用，具体的实现原理我们点进去看一下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringBootConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.TypeExcludeFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.FilterType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan.Filter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AliasFor;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(</span><br><span class="line">    excludeFilters = &#123;<span class="meta">@Filter</span>(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;TypeExcludeFilter<span class="class">.<span class="keyword">class</span>&#125;</span></span><br><span class="line"><span class="class">), @<span class="title">Filter</span>(</span></span><br><span class="line"><span class="class">    <span class="title">type</span> </span>= FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;AutoConfigurationExcludeFilter<span class="class">.<span class="keyword">class</span>&#125;</span></span><br><span class="line"><span class="class">)&#125;</span></span><br><span class="line"><span class="class">)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">SpringBootApplication</span> </span>&#123;</span><br><span class="line"> ........   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在SpringBootApplication注解类中，实际上重要的只有三个Annotation：</p>
<blockquote>
<p>@Configuration（@SpringBootConfiguration里面还是应用了@Configuration）</p>
<p>@EnableAutoConfiguration</p>
<p>@ComponentScan</p>
</blockquote>
<table>
<thead>
<tr>
<th>@Configuration</th>
<th>作用上面我们已经知道了，被注解的类将成为一个bean配置类。</th>
</tr>
</thead>
<tbody><tr>
<td>@ComponentScan</td>
<td>的作用就是自动扫描并加载符合条件的组件，比如@Component和@Repository等，最终将这些bean定义加载到spring容器中。</td>
</tr>
<tr>
<td>@Repository等，</td>
<td>最终将这些bean定义加载到spring容器中。</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>这个注解的功能很重要，借助@Import的支持，收集和注册依赖包中相关的bean定义。</td>
</tr>
</tbody></table>
<p>这里进入到 <code>@EnableAutoConfiguration</code> 注解中看看： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;AutoConfigurationImportSelector<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableAutoConfiguration</span> </span>&#123;</span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = <span class="string">"spring.boot.enableautoconfiguration"</span>;</span><br><span class="line"> </span><br><span class="line">    Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"> </span><br><span class="line">    String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上源码，<code>@EnableAutoConfiguration</code>注解引入了<code>@AutoConfigurationPackage</code>和<code>@Import</code>这两个注解。<code>@AutoConfigurationPackage</code>的作用就是自动配置的包，<code>@Import</code>导入需要自动配置的组件。 </p>
<p>进入@<strong>AutoConfigurationPackage</strong>，发现也是引入了@<strong>Import</strong>注解 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;Registrar<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">AutoConfigurationPackage</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点进去 @<strong>Import</strong> 引用的 <strong>Registrar.class</strong> 的<strong>Registrar</strong>类去看看： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Order</span>(-<span class="number">2147483648</span>)</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Registrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">DeterminableImports</span> </span>&#123;</span><br><span class="line">        Registrar() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">            AutoConfigurationPackages.register(registry, (<span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata)).getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上述源码我们可以解决一个小困惑，如下： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata)).getPackageName()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>AutoConfigurationPackages翻译成人话，就是 自动配置的包。PackageImport()方法代表配置的原数据</p>
</blockquote>
<p>​    这两句代码的作用是用来加载启动类所在的包下的主类与子类的所有组件注册到<strong>spring</strong> 容器，这就是前文所说的<strong>springboot</strong>默认扫描启动类所在的包下的主类与子类的所有组件。</p>
<p>​    这里进入<strong>AutoConfigurationPackages</strong> 包去看看，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AnnotationMetadata</span> <span class="keyword">extends</span> <span class="title">ClassMetadata</span>, <span class="title">AnnotatedTypeMetadata</span> </span>&#123;</span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">getAnnotationTypes</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">getMetaAnnotationTypes</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasAnnotation</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasMetaAnnotation</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasAnnotatedMethods</span><span class="params">(String var1)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Set&lt;MethodMetadata&gt; <span class="title">getAnnotatedMethods</span><span class="params">(String var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单介绍一下，AnnotationMetadata 有两种重要的实现方案，一种基于 Java 反射，另一种基于 ASM 框架。</p>
<p>两种实现方案适用于不同场景。StandardAnnotationMetadata基于 Java 反射，需要加载类文件。而 AnnotationMetadataReadingVisitor 基于 ASM 框架无需提前加载类，所以适用于 Spring 应用扫描指定范围内模式注解时使用。</p>
<p>下面是metadata 的相关接口和类的关系图：</p>
<img src="http://photo.wushaopei.com/qiniu119.png" width="60%">

<p>获取并返回包名，PackageImport </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageImport</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String packageName;</span><br><span class="line"> </span><br><span class="line">        PackageImport(AnnotationMetadata metadata) &#123;</span><br><span class="line">            <span class="keyword">this</span>.packageName = ClassUtils.getPackageName(metadata.getClassName());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.packageName.hashCode();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> obj != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.getClass() == obj.getClass() ? <span class="keyword">this</span>.packageName.equals(((AutoConfigurationPackages.PackageImport)obj).packageName) : <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPackageName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.packageName;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Package Import "</span> + <span class="keyword">this</span>.packageName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>根据元数据中返回的类名获取其所在的包目录，将该包目录返回给容器，用于自定义扫描包或默认配置扫描。 </p>
<p>回到原来的问题上，搜集并注册到spring 容器的那些bean来自哪里？</p>
<p>​    进入<code>@EnableAutoConfiguration</code>注解的<code>EnableAutoConfigurationImportSelector</code> 类中去看看，该类继承了A<code>utoConfigurationImportSelector</code> 类，进入该类进行看下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableAutoConfigurationImportSelector</span> <span class="keyword">extends</span> <span class="title">AutoConfigurationImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnableAutoConfigurationImportSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">        return this.getClass().equals(EnableAutoConfigurationImportSelector.class) ? ((Boolean)this.getEnvironment().getProperty("spring.boot.enableautoconfiguration", Boolean.class, true)).booleanValue() : true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">EnvironmentAware</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] NO_IMPORTS = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(AutoConfigurationImportSelector<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    ...............</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoConfigurationImportSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">                AnnotationAttributes attributes = <span class="keyword">this</span>.getAttributes(annotationMetadata);</span><br><span class="line">                List&lt;String&gt; configurations = <span class="keyword">this</span>.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">                configurations = <span class="keyword">this</span>.removeDuplicates(configurations);</span><br><span class="line">                configurations = <span class="keyword">this</span>.sort(configurations, autoConfigurationMetadata);</span><br><span class="line">                Set&lt;String&gt; exclusions = <span class="keyword">this</span>.getExclusions(annotationMetadata, attributes);</span><br><span class="line">                <span class="keyword">this</span>.checkExcludedClasses(configurations, exclusions);</span><br><span class="line">                configurations.removeAll(exclusions);</span><br><span class="line">                configurations = <span class="keyword">this</span>.filter(configurations, autoConfigurationMetadata);</span><br><span class="line">                <span class="keyword">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">                <span class="keyword">return</span> (String[])configurations.toArray(<span class="keyword">new</span> String[configurations.size()]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">..............</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AnnotationAttributes <span class="title">getAttributes</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">        String name = <span class="keyword">this</span>.getAnnotationClass().getName();</span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(name, <span class="keyword">true</span>));</span><br><span class="line">        Assert.notNull(attributes, <span class="string">"No auto-configuration attributes found. Is "</span> + metadata.getClassName() + <span class="string">" annotated with "</span> + ClassUtils.getShortName(name) + <span class="string">"?"</span>);</span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getAnnotationClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> EnableAutoConfiguration<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(<span class="keyword">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="keyword">this</span>.getBeanClassLoader());</span><br><span class="line">        Assert.notEmpty(configurations, <span class="string">"No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct."</span>);</span><br><span class="line">        <span class="keyword">return</span> configurations;</span><br><span class="line">    &#125;</span><br><span class="line">.........</span><br></pre></td></tr></table></figure>

<p>​        在 <code>selectImports</code> 方法中，<code>SpringFactoriesLoader.loadFactoryNames</code> 方法扫描所有具有<code>META-INF/spring.factories</code>的jar包。spring-boot-autoconfigure-x.x.x.x.jar里就有一个这样的spring.factories文件。</p>
<p>​    注意：在启动 动<code>loadFactoryNames（）</code>方法前，<code>SpringFactoriesLoader.loadFactoryNames</code>方法调用<code>loadSpringFactories</code>方法从所有的jar包中读取<code>META-INF/spring.factories</code>文件信息。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">loadFactories</span><span class="params">(Class&lt;T&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(factoryClass, <span class="string">"'factoryClass' must not be null"</span>);</span><br><span class="line">        ClassLoader classLoaderToUse = classLoader;</span><br><span class="line">        <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            classLoaderToUse = SpringFactoriesLoader<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        List&lt;String&gt; factoryNames = loadFactoryNames(factoryClass, classLoaderToUse);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"Loaded ["</span> + factoryClass.getName() + <span class="string">"] names: "</span> + factoryNames);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        List&lt;T&gt; result = <span class="keyword">new</span> ArrayList(factoryNames.size());</span><br><span class="line">        Iterator var5 = factoryNames.iterator();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">            String factoryName = (String)var5.next();</span><br><span class="line">            result.add(instantiateFactory(factoryName, factoryClass, classLoaderToUse));</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        AnnotationAwareOrderComparator.sort(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>loadFactories</strong>会将加载到的<strong>jar</strong>中的类加载并保存，以提供<strong>loadFactoryNames</strong>中进行配置添加到执行序列 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        String factoryClassName = factoryClass.getName();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Enumeration&lt;URL&gt; urls = classLoader != <span class="keyword">null</span> ? classLoader.getResources(<span class="string">"META-INF/spring.factories"</span>) : ClassLoader.getSystemResources(<span class="string">"META-INF/spring.factories"</span>);</span><br><span class="line">            ArrayList result = <span class="keyword">new</span> ArrayList();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">while</span>(urls.hasMoreElements()) &#123;</span><br><span class="line">                URL url = (URL)urls.nextElement();</span><br><span class="line">                Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(url));</span><br><span class="line">                String factoryClassNames = properties.getProperty(factoryClassName);</span><br><span class="line">                result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var8) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load ["</span> + factoryClass.getName() + <span class="string">"] factories from location ["</span> + <span class="string">"META-INF/spring.factories"</span> + <span class="string">"]"</span>, var8);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>spring.factories</code>文件也是一组一组的<code>key=value</code>的形式，其中一个<code>key</code>是<code>EnableAutoConfiguration</code>类的全类名，而它的<code>value</code>是一个<code>xxxxAutoConfiguration</code>的类名的列表，这些类名以逗号分隔，如下图所示： </p>
<img src="http://photo.wushaopei.com/qiniu120.png" width="90%">

<p>​     这个      <code>@EnableAutoConfiguration</code>注解通过<code>@SpringBootApplication</code>被间接的标记在了Spring Boot的启动类上。在 <code>SpringApplication.run(...)</code>的内部就会执行<code>selectImports()</code>方法，找到所有JavaConfig自动配置类的全限定名对应的class，然后将所有自动配置类加载到Spring容器中。</p>
<p>​    其中有一个key为   <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>的值定义了需要自动配置的bean，通过读取这个配置获取一组 <code>@Configuration</code>类。</p>
<p>​    注意：每个xxxAutoConfiguration都是一个基于java的bean配置类。实际上，这些<code>xxxAutoConfiguratio</code>不是所有都会被加载，会根据  <code>xxxAutoConfiguration</code>上的<code>@ConditionalOnClass</code>等条件判断是否加载。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">instantiateFactory</span><span class="params">(String instanceClassName, Class&lt;T&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; instanceClass = ClassUtils.forName(instanceClassName, classLoader);</span><br><span class="line">            <span class="keyword">if</span> (!factoryClass.isAssignableFrom(instanceClass)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Class ["</span> + instanceClassName + <span class="string">"] is not assignable to ["</span> + factoryClass.getName() + <span class="string">"]"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Constructor&lt;?&gt; constructor = instanceClass.getDeclaredConstructor();</span><br><span class="line">                ReflectionUtils.makeAccessible(constructor);</span><br><span class="line">                <span class="keyword">return</span> constructor.newInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to instantiate factory class: "</span> + factoryClass.getName(), var5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p> 如上代码段，通过反射机制将<strong>spring.factories</strong>中<strong>@Configuration</strong>类实例化为对应的<strong>java</strong>实列。到此我们已经知道怎么发现要自动配置的<strong>bean</strong>了，最后一步就是怎么样将这些<strong>bean</strong>加载到<strong>spring</strong>容器。 </p>
<h4 id="bean的加载"><a href="#bean的加载" class="headerlink" title="bean的加载"></a>bean的加载</h4><p>如果要让一个普通类交给Spring容器管理，通常有以下方法：</p>
<ol>
<li>使用 @Configuration与@Bean 注解</li>
<li>使用@Controller @Service @Repository @Component 注解标注该类，然后启用@ComponentScan自动扫描</li>
<li>使用@Import 方法</li>
</ol>
<p><strong>springboot</strong>中使用了<strong>@Import</strong> 方法</p>
<p><strong>@EnableAutoConfiguration</strong>注解中使用<code>@Import({AutoConfigurationImportSelector.class})</code>注解，<strong>AutoConfigurationImportSelector</strong>实现了<strong>DeferredImportSelector</strong>接口，</p>
<p><strong>DeferredImportSelector</strong>接口继承了<strong>ImportSelector</strong>接口，<strong>ImportSelector</strong>接口只有一个<strong>selectImports</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span></span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">            AnnotationAttributes attributes = <span class="keyword">this</span>.getAttributes(annotationMetadata);</span><br><span class="line">            List configurations = <span class="keyword">this</span>.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">            configurations = <span class="keyword">this</span>.removeDuplicates(configurations);</span><br><span class="line">            Set exclusions = <span class="keyword">this</span>.getExclusions(annotationMetadata, attributes);</span><br><span class="line">            <span class="keyword">this</span>.checkExcludedClasses(configurations, exclusions);</span><br><span class="line">            configurations.removeAll(exclusions);</span><br><span class="line">            configurations = <span class="keyword">this</span>.filter(configurations, autoConfigurationMetadata);</span><br><span class="line">            <span class="keyword">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">            <span class="keyword">return</span> StringUtils.toStringArray(configurations);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeferredImportSelector</span> <span class="keyword">extends</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> Class&lt;? extends DeferredImportSelector.Group&gt; getImportGroup() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Group</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    String[] selectImports(AnnotationMetadata var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 我们先通过一个简单例子看看<strong>@Import</strong>注解是如何将<strong>bean</strong>导入到<strong>spring</strong>容器的。 </p>
<h5 id="新建一个bean"><a href="#新建一个bean" class="headerlink" title="新建一个bean"></a>新建一个bean</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSelecter</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"com.mmall.demo.model.User"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建一个UserSelecter类继承ImportSelector接口并实现selectImports方法"><a href="#创建一个UserSelecter类继承ImportSelector接口并实现selectImports方法" class="headerlink" title="创建一个UserSelecter类继承ImportSelector接口并实现selectImports方法"></a>创建一个<strong>UserSelecter</strong>类继承<strong>ImportSelector</strong>接口并实现<strong>selectImports</strong>方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSelecter</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"com.mmall.demo.model.User"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建ImportConfig类，使用-Configuration、-Import-ItpscSelector-class-注解。"><a href="#创建ImportConfig类，使用-Configuration、-Import-ItpscSelector-class-注解。" class="headerlink" title="创建ImportConfig类，使用@Configuration、@Import(ItpscSelector.class)注解。"></a>创建ImportConfig类，使用@Configuration、@Import(ItpscSelector.class)注解。</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(UserSelecter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ImportConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="从容器获取bean"><a href="#从容器获取bean" class="headerlink" title="从容器获取bean"></a>从容器获取bean</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectImport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext(ImportConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String[] beanDefinitionNames = ctx.getBeanDefinitionNames();</span><br><span class="line">		<span class="keyword">for</span> (String name : beanDefinitionNames) &#123;</span><br><span class="line">			System.out.println(name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">59.283</span>  INFO <span class="number">17128</span> --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@<span class="number">6240651f</span>: startup date [Sat Feb <span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">59</span> CST <span class="number">2020</span>]; root of context hierarchy</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">importConfig</span><br><span class="line">com.mmall.demo.model.User</span><br><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">59.309</span>  INFO <span class="number">17128</span> --- [       Thread-<span class="number">2</span>] o.s.w.c.s.GenericWebApplicationContext   : Closing org.springframework.web.context.support.GenericWebApplicationContext@<span class="number">53</span>ce1329: startup date [Sat Feb <span class="number">01</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">55</span> CST <span class="number">2020</span>]; root of context hierarchy</span><br></pre></td></tr></table></figure>

<p>从结果可以看出：<strong>selectImports</strong>方法返回一组<strong>bean</strong>，<strong>@EnableAutoConfiguration</strong>注解借助<strong>@Import</strong>注解将这组<strong>bean</strong>注入到<strong>spring</strong>容器中，<strong>springboot</strong>正式通过这种机制来完成<strong>bean</strong>的注入的。 </p>
<p><strong>总结：</strong> </p>
<blockquote>
<p>Spring Boot启动的时候会通过@EnableAutoConfiguration注解找到META-INF/spring.factories配置文件中的所有自动配置类，并对其进行加载，而这些自动配置类都是以AutoConfiguration结尾来命名的，它实际上就是一个JavaConfig形式的Spring容器配置类，它能通过以Properties结尾命名的类中取得在全局配置文件中配置的属性如：server.port，而XxxxProperties类是通过@ConfigurationProperties注解与全局配置文件中对应的属性进行绑定的。</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu121.png" width="90%">

<p>图片来自于王福强老师的博客：<a href="https://afoo.me/posts/2015-07-09-how-spring-boot-works.html" target="_blank" rel="noopener">https://afoo.me/posts/2015-07-09-how-spring-boot-works.html</a>  </p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>]]></content>
      <categories>
        <category>springboot原理篇</category>
      </categories>
  </entry>
  <entry>
    <title>微信小程序（二）微信小程序的基础组件</title>
    <url>/2020/05/13/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%88%E4%BA%8C%EF%BC%89%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/</url>
    <content><![CDATA[<h2 id="微信小程序基础组件"><a href="#微信小程序基础组件" class="headerlink" title="微信小程序基础组件"></a>微信小程序基础组件</h2><h3 id="小程序的flex-布局"><a href="#小程序的flex-布局" class="headerlink" title="小程序的flex 布局"></a>小程序的flex 布局</h3><p>小程序的 flex 布局</p>
<ul>
<li>小程序建议使用 flex 布局进行排版</li>
<li>flex 就是一个盒装弹性布局</li>
<li>flex 是一个容器，所有子元素都是它的成员</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu622.png" width="40%">

<p>​    如上图所示，外面的就是一个flex （所谓的父级容器），它可以进行相应的样式设置；可以看到在大盒子flex里面有很多一块块的小块，这每一个小块都是一个块状的元素，都是他的成员，针对每个成员我们也可以对他们进行样式的设置。</p>
<ul>
<li><p>定义布局 display:flex </p>
</li>
<li><p>flex 容器的属性： </p>
</li>
<li><p>Flex-direction: 排列方向</p>
</li>
<li><p>Flex-wrap:换行规则</p>
</li>
<li><p>Justify-content: 对齐方式</p>
</li>
</ul>
<hr>
<h3 id="flex-direction-讲解"><a href="#flex-direction-讲解" class="headerlink" title="flex-direction 讲解"></a>flex-direction 讲解</h3><h4 id="flex-布局："><a href="#flex-布局：" class="headerlink" title="flex 布局："></a><strong>flex 布局：</strong></h4><blockquote>
<p>对页面的快进行排序，声明在 .container中</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span>&#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="comment">/* row : 默认从左到右排序</span></span><br><span class="line"><span class="comment">  /* row-reverse：从右到左排序 */</span></span><br><span class="line">  <span class="comment">/* column: 从上到下排序 */</span></span><br><span class="line">  <span class="comment">/* column-reverse: 从下到上排序 */</span></span><br><span class="line">  <span class="attribute">flex-direction</span>: column-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a><strong>示例：</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'a size'</span>&gt;</span>a<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'b size'</span>&gt;</span>b<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'c size'</span>&gt;</span>c<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'d size'</span>&gt;</span>d<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'e size'</span>&gt;</span>e<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**index.wxss**/</span></span><br><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line"><span class="attribute">display</span>: flex;</span><br><span class="line"><span class="attribute">flex-direction</span>: row ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.size</span> &#123;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">150</span>rpx;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">150</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.a</span>&#123;</span><br><span class="line"><span class="attribute">background-color</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.b</span>&#123;</span><br><span class="line"><span class="attribute">background-color</span>: yellow;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.c</span>&#123;</span><br><span class="line"><span class="attribute">background-color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.d</span>&#123;</span><br><span class="line"><span class="attribute">background-color</span>: green;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.e</span>&#123;</span><br><span class="line"><span class="attribute">background-color</span>:orange;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>效果：</strong></p>
<img src="http://photo.wushaopei.com/qiniu623.png" width="40%">

<hr>
<h3 id="flex-wrap-讲解"><a href="#flex-wrap-讲解" class="headerlink" title="flex-wrap 讲解"></a>flex-wrap 讲解</h3><p><strong>Flex-wrap</strong></p>
<ul>
<li>nowrap</li>
<li>wrap </li>
<li>wrap-reverse</li>
</ul>
<h4 id="①-nowrap"><a href="#①-nowrap" class="headerlink" title="① nowrap"></a>① nowrap</h4> <figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* nowrap: 默认不换行,在声明块的长度时，会对块元素进行压缩，保证当前行都能放下所有的块 */</span></span><br><span class="line"> <span class="selector-tag">flex-wrap</span>: <span class="selector-tag">nowrap</span>;</span><br></pre></td></tr></table></figure>

<p><strong>效果：</strong></p>
<img src="http://photo.wushaopei.com/qiniu624.png" width="40%">

<h4 id="②-wrap"><a href="#②-wrap" class="headerlink" title="② wrap"></a>② wrap</h4><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* wrap: 默认换行，当前行保留满足最大宽度的几个块元素，合计长度超过的部分进行换行 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">flex-wrap</span>: <span class="selector-tag">wrap</span>;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu625.png" width="40%">

<h4 id="③-wrap-reverse"><a href="#③-wrap-reverse" class="headerlink" title="③ wrap-reverse"></a>③ wrap-reverse</h4><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* wrap-reverse: 逆向换行 ,与 wrap 相反，满足宽长度的块元素从底部开始排序，超过部分放到顶部*/</span></span><br><span class="line"></span><br><span class="line"> <span class="selector-tag">flex-wrap</span>: <span class="selector-tag">wrap-reverse</span>;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu626.png" width="40%">



<h3 id="justify-content-讲解"><a href="#justify-content-讲解" class="headerlink" title="justify-content 讲解"></a>justify-content 讲解</h3><p><strong>Justify-content （对齐方式）</strong></p>
<ul>
<li>flex-start</li>
<li>flex-end</li>
<li>center</li>
<li>space-berwee</li>
<li>space-around</li>
</ul>
<h4 id="①-flex-start"><a href="#①-flex-start" class="headerlink" title="① flex-start"></a>① flex-start</h4><blockquote>
<p>​        /* flex-start:默认左对齐 */</p>
</blockquote>
<p><strong>效果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu627.png" width="40%">

<h4 id="②flex-end"><a href="#②flex-end" class="headerlink" title="②flex-end"></a>②flex-end</h4><blockquote>
<p>/* flex-end:向右对齐 <em>/***</em></p>
</blockquote>
<p><strong>效果：</strong></p>
<img src="http://photo.wushaopei.com/qiniu628.png" width="40%">

<h4 id="③center"><a href="#③center" class="headerlink" title="③center"></a>③center</h4><blockquote>
<p>/* center: 居中对齐 */</p>
</blockquote>
<p>​    <img src="http://photo.wushaopei.com/qiniu629.png" width="40%"></p>
<h4 id="④space-between"><a href="#④space-between" class="headerlink" title="④space-between"></a>④space-between</h4><blockquote>
<p>/* space-between: 在成员元素之间留空白 */</p>
</blockquote>
<p>​     <img src="http://photo.wushaopei.com/qiniu670.png" width="40%"></p>
<h4 id="⑤space-around"><a href="#⑤space-around" class="headerlink" title="⑤space-around"></a>⑤space-around</h4><blockquote>
<p>/* space-around： 在成员元素周围包裹空白 */</p>
</blockquote>
<p>​     <img src="http://photo.wushaopei.com/qiniu630.png" width="40%"></p>
<h3 id="flex-成员元素的样式设置"><a href="#flex-成员元素的样式设置" class="headerlink" title="flex 成员元素的样式设置"></a>flex 成员元素的样式设置</h3><p>Flex 容器成员的属性</p>
<ul>
<li>order:  成员之间的显示顺序</li>
<li>flex: 成员所占屏幕的比例</li>
</ul>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*  order: 通过数字对flex容器内部的成员设置显示顺序 */</span></span><br><span class="line">  <span class="selector-tag">order</span>: 1;</span><br></pre></td></tr></table></figure>

<h4 id="①-order-成员之间的显示顺序"><a href="#①-order-成员之间的显示顺序" class="headerlink" title="① order:成员之间的显示顺序"></a>① order:成员之间的显示顺序</h4><p>对多块元素进行设置 order 序号后，其在屏幕中的显示顺序按照 order 标识的数据为显示的顺序，</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**index.wxss**/</span></span><br><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: row ;</span><br><span class="line">    <span class="comment">/* flex-wrap: nowrap; */</span></span><br><span class="line">    <span class="comment">/* flex-wrap: wrap ; */</span></span><br><span class="line">    <span class="comment">/* flex-wrap: wrap-reverse; */</span></span><br><span class="line">    <span class="comment">/* justify-content: flex-start; */</span></span><br><span class="line">    <span class="comment">/* justify-content: flex-end; */</span></span><br><span class="line">    <span class="comment">/* justify-content: space-around; */</span></span><br><span class="line">    <span class="comment">/* justify-content: center; */</span></span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-class">.size</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100</span>rpx;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">150</span>rpx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.a</span>&#123;</span><br><span class="line">        <span class="attribute">background-color</span>: red;</span><br><span class="line">        <span class="attribute">order</span>: <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.b</span>&#123;</span><br><span class="line">        <span class="attribute">background-color</span>: yellow;</span><br><span class="line">        <span class="attribute">order</span>: <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.c</span>&#123;</span><br><span class="line">        <span class="attribute">background-color</span>: blue;</span><br><span class="line">        <span class="attribute">order</span>: <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.d</span>&#123;</span><br><span class="line">        <span class="attribute">background-color</span>: green;</span><br><span class="line">        <span class="attribute">order</span>: <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.e</span>&#123;</span><br><span class="line">        <span class="attribute">background-color</span>:orange;</span><br><span class="line">        <span class="attribute">order</span>: <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​     <img src="http://photo.wushaopei.com/qiniu671.png" width="40%"></p>
<h4 id="②-flex-成员所占屏幕的比例"><a href="#②-flex-成员所占屏幕的比例" class="headerlink" title="② flex:成员所占屏幕的比例"></a>② flex:成员所占屏幕的比例</h4><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* flex: 配置每个成员元素所占行级的显示比例 */</span></span><br><span class="line">  <span class="selector-tag">flex</span>: 3;</span><br></pre></td></tr></table></figure>

<p>屏幕根据flex的总和sum进行计算，每块元素占有的屏幕比为 当前 flex 长度/ sum 总和 ；</p>
<p>当声明了 flex样式后， 前面设置的 class选择器中定义的 size 宽度样式会失效</p>
<p>​     <img src="http://photo.wushaopei.com/qiniu631.png" width="40%"></p>
<hr>
<h3 id="小程序的组件介绍"><a href="#小程序的组件介绍" class="headerlink" title="小程序的组件介绍"></a>小程序的组件介绍</h3><p><strong>组件</strong></p>
<ul>
<li>多个组件构成一张视图页面</li>
<li>组件包含&lt;开始标签&gt;&lt;/结束标签&gt;</li>
<li>每个组件都包含一些公用属性</li>
</ul>
<p><strong>基础组件</strong></p>
<blockquote>
<p>框架为开发中提供了一系列基础组件，开发者可以通过组合这些基础组件进行快速开发</p>
</blockquote>
<p><strong>什么是组件</strong></p>
<ul>
<li>组件是视图层的基本组成单元</li>
<li>组件自带一些功能与微信风格的样式。</li>
<li>一个组件通常包括 开始标签 和 结束标签，属性 用来修饰这个组件，内容在两个标签之内</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tagname</span> <span class="attr">property</span>=<span class="string">”value”</span>&gt;</span></span><br><span class="line">	Content goes here ....</span><br><span class="line"><span class="tag">&lt;/<span class="name">tagname</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>： 所有组件与属性都是小写，以 连字符 - 连接</p>
<p>​     <img src="http://photo.wushaopei.com/qiniu632.png" width="40%"></p>
<p>​     <img src="http://photo.wushaopei.com/qiniu633.png" width="40%"></p>
<p>​     <img src="http://photo.wushaopei.com/qiniu634.png" width="40%"></p>
<p>​     <img src="http://photo.wushaopei.com/qiniu635.png" width="40%"></p>
<hr>
<h3 id="视图组件-view"><a href="#视图组件-view" class="headerlink" title="视图组件 view"></a>视图组件 view</h3><h4 id="view"><a href="#view" class="headerlink" title="view"></a><strong>view</strong></h4><p>​    基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>视图容器</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>hover-class</td>
<td>string</td>
<td>none</td>
<td>否</td>
<td>指定按下去的样式类。当 hover-class=”none” 时，没有点击态效果</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>hover-stop-propagation</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>指定是否阻止本节点的祖先节点出现点击态</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>hover-start-time</td>
<td>number</td>
<td>50</td>
<td>否</td>
<td>按住后多久出现点击态，单位毫秒</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>hover-stay-time</td>
<td>number</td>
<td>400</td>
<td>否</td>
<td>手指松开后点击态保留时间，单位毫秒</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip"><a href="#Bug-amp-Tip" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li>tip: 如果需要使用滚动视图，请使用 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/scroll-view.html" target="_blank" rel="noopener">scroll-view</a></li>
</ol>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/view/view.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'a size'</span> <span class="attr">hover-class</span>=<span class="string">"d"</span> <span class="attr">hover-start-time</span>=<span class="string">"1000"</span> <span class="attr">hover-stay-time</span>=<span class="string">"2000"</span>&gt;</span>a<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* pages/view/view.wxss */</span></span><br><span class="line"><span class="selector-class">.container</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">display</span>: flex;</span><br><span class="line">	<span class="attribute">flex-direction</span>: row ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.size</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100</span>rpx;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">150</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.a</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: red;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.d</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: green;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">2</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="效果："><a href="#效果：" class="headerlink" title="效果："></a><strong>效果：</strong></h4><p>​     <img src="http://photo.wushaopei.com/qiniu636.png" width="40%"></p>
<hr>
<h3 id="scroll-view-可滚动视图-纵向"><a href="#scroll-view-可滚动视图-纵向" class="headerlink" title="scroll-view 可滚动视图 纵向"></a>scroll-view 可滚动视图 纵向</h3><h4 id="scroll-view"><a href="#scroll-view" class="headerlink" title="scroll-view"></a><strong>scroll-view</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>可滚动视图区域。使用竖向滚动时，需要给<a href="https://developers.weixin.qq.com/miniprogram/dev/component/scroll-view.html" target="_blank" rel="noopener">scroll-view</a>一个固定高度，通过 WXSS 设置 height。组件属性的长度单位默认为px，<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.0</a>起支持传入单位(rpx/px)。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>scroll-x</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>允许横向滚动</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>scroll-y</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>允许纵向滚动</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>upper-threshold</td>
<td>number/string</td>
<td>50</td>
<td>否</td>
<td>距顶部/左边多远时，触发 scrolltoupper 事件</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>lower-threshold</td>
<td>number/string</td>
<td>50</td>
<td>否</td>
<td>距底部/右边多远时，触发 scrolltolower 事件</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>scroll-top</td>
<td>number/string</td>
<td></td>
<td>否</td>
<td>设置竖向滚动条位置</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>scroll-left</td>
<td>number/string</td>
<td></td>
<td>否</td>
<td>设置横向滚动条位置</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>scroll-into-view</td>
<td>string</td>
<td></td>
<td>否</td>
<td>值应为某子元素id（id不能以数字开头）。设置哪个方向可滚动，则在哪个方向滚动到该元素</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>scroll-with-animation</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>在设置滚动条位置时使用动画过渡</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>enable-back-to-top</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>iOS点击顶部状态栏、安卓双击标题栏时，滚动条返回顶部，只支持竖向</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>enable-flex</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>启用 flexbox 布局。开启后，当前节点声明了 display: flex 就会成为 flex container，并作用于其孩子节点。</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.7.3</a></td>
</tr>
<tr>
<td>scroll-anchoring</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>开启 scroll anchoring 特性，即控制滚动位置不随内容变化而抖动，仅在 iOS 下生效，安卓下可参考 CSS overflow-anchor 属性。</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.8.2</a></td>
</tr>
<tr>
<td>refresher-enabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>开启自定义下拉刷新</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>refresher-threshold</td>
<td>number</td>
<td>45</td>
<td>否</td>
<td>设置自定义下拉刷新阈值</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>refresher-default-style</td>
<td>string</td>
<td>“black”</td>
<td>否</td>
<td>设置自定义下拉刷新默认样式，支持设置 black | white | none， none 表示不使用默认样式</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>refresher-background</td>
<td>string</td>
<td>“#FFF”</td>
<td>否</td>
<td>设置自定义下拉刷新区域背景颜色</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>refresher-triggered</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>设置当前下拉刷新状态，true 表示下拉刷新已经被触发，false 表示下拉刷新未被触发</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>bindscrolltoupper</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>滚动到顶部/左边时触发</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindscrolltolower</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>滚动到底部/右边时触发</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindscroll</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>滚动时触发，event.detail = {scrollLeft, scrollTop, scrollHeight, scrollWidth, deltaX, deltaY}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindrefresherpulling</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>自定义下拉刷新控件被下拉</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>bindrefresherrefresh</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>自定义下拉刷新被触发</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>bindrefresherrestore</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>自定义下拉刷新被复位</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
<tr>
<td>bindrefresherabort</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>自定义下拉刷新被中止</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.1</a></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-1"><a href="#Bug-amp-Tip-1" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li><p>tip: 基础库 <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.0</a>以下不支持嵌套textarea、map、canvas、video 组件</p>
</li>
<li><p>tip: scroll-into-view 的优先级高于 scroll-top</p>
</li>
<li><p>tip: 在滚动 scroll-view 时会阻止页面回弹，所以在 scroll-view 中滚动，是无法触发 onPullDownRefresh</p>
</li>
<li><p>tip: 若要使用下拉刷新，请使用页面的滚动，而不是 scroll-view ，这样也能通过点击顶部状态栏回到页面顶部</p>
</li>
<li><p>tip: scroll-view 自定义下拉刷新可以结合 <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/interactive-animation.html" target="_blank" rel="noopener">WXS 事件响应</a> 开发交互动画</p>
</li>
</ol>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/scroll-view.html" target="_blank" rel="noopener">https://developers.weixin.qq.com/miniprogram/dev/component/scroll-view.html</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-y</span>=<span class="string">"true"</span> <span class="attr">style</span>=<span class="string">"height:300rpx;"</span> <span class="attr">bindscrolltoupper</span>=<span class="string">'scrolltoupper'</span> <span class="attr">bindscrolltolower</span>=<span class="string">'scrolltolower'</span> <span class="attr">upper-threshold</span>=<span class="string">'0'</span> <span class="attr">upper-threshold</span>=<span class="string">'0'</span> <span class="attr">scroll-top</span>=<span class="string">"20"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'a size'</span>&gt;</span>a<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'b size'</span>&gt;</span>b<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'c size'</span>&gt;</span>c<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'d size'</span>&gt;</span>d<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'e size'</span>&gt;</span>e<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* pages/scrollview/scrollview.wxss */</span></span><br><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.size</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">150</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.a</span>&#123;</span><br><span class="line">    <span class="attribute">background-color</span>: red;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.b</span>&#123;</span><br><span class="line">    <span class="attribute">background-color</span>: yellow;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">2</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.c</span>&#123;</span><br><span class="line">    <span class="attribute">background-color</span>: blue;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">4</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.d</span>&#123;</span><br><span class="line">    <span class="attribute">background-color</span>: green;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">3</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.e</span>&#123;</span><br><span class="line">    <span class="attribute">background-color</span>:orange;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">5</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/scrollview/scrollview.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 页面的初始数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">data: &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line">scrolltoupper:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"滚动到顶部"</span>);</span><br><span class="line">&#125;,</span><br><span class="line">scrolltolower:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"滚动到底部"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="scroll-view-可滚动视图-横向"><a href="#scroll-view-可滚动视图-横向" class="headerlink" title="scroll-view 可滚动视图 横向"></a>scroll-view 可滚动视图 横向</h3><p>设置 scroll-views 横向滚动，除了要设置 flex 布局为 white-space:nowarep </p>
<p>还有设置里面的元素为 inline-block</p>
<p>​     <img src="http://photo.wushaopei.com/qiniu637.png" width="40%"></p>
<p>设置横向滚动条 scroll-view scroll-x=”true”</p>
<ol>
<li>设置对象布局 display:flex</li>
<li>设置不换行 white-space:nowrap</li>
<li>设置宽长 250rpx</li>
<li>设置元素对象为内联对象 display : inline-block</li>
</ol>
<p>​     <img src="http://photo.wushaopei.com/qiniu638.png" width="40%"></p>
<hr>
<h3 id="可拖动-view"><a href="#可拖动-view" class="headerlink" title="可拖动 view"></a>可拖动 view</h3><p><strong>Movable-area 和 movable-view</strong></p>
<h4 id="movable-area"><a href="#movable-area" class="headerlink" title="movable-area"></a><strong>movable-area</strong></h4><p>基础库 1.2.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/movable-view.html" target="_blank" rel="noopener">movable-view</a>的可移动区域。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>scale-area</td>
<td>Boolean</td>
<td>false</td>
<td>否</td>
<td>当里面的movable-view设置为支持双指缩放时，设置此值可将缩放手势生效区域修改为整个movable-area</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
</tbody></table>
<h5 id="Bug-amp-Tip-2"><a href="#Bug-amp-Tip-2" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h5><ol>
<li><p>tip: movable-area 必须设置width和height属性，不设置默认为10px**</p>
</li>
<li><p>tip: 当movable-view小于movable-area时，movable-view的移动范围是在movable-area内；</p>
</li>
<li><p>tip: 当movable-view大于movable-area时，movable-view的移动范围必须包含movable-area（x轴方向和y轴方向分开考虑）</p>
</li>
</ol>
<h4 id="movable-view"><a href="#movable-view" class="headerlink" title="movable-view"></a><strong>movable-view</strong></h4><p>基础库 1.2.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>可移动的视图容器，在页面中可以拖拽滑动。<a href="https://developers.weixin.qq.com/miniprogram/dev/component/movable-view.html" target="_blank" rel="noopener">movable-view</a>必须在 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/movable-area.html" target="_blank" rel="noopener">movable-area</a> 组件中，并且必须是直接子节点，否则不能移动。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>direction</td>
<td>string</td>
<td>none</td>
<td>否</td>
<td>movable-view的移动方向，属性值有all、vertical、horizontal、none</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>inertia</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>movable-view是否带有惯性</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>out-of-bounds</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>超过可移动区域后，movable-view是否还可以移动</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>x</td>
<td>number</td>
<td></td>
<td>否</td>
<td>定义x轴方向的偏移，如果x的值不在可移动范围内，会自动移动到可移动范围；改变x的值会触发动画</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>y</td>
<td>number</td>
<td></td>
<td>否</td>
<td>定义y轴方向的偏移，如果y的值不在可移动范围内，会自动移动到可移动范围；改变y的值会触发动画</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>damping</td>
<td>number</td>
<td>20</td>
<td>否</td>
<td>阻尼系数，用于控制x或y改变时的动画和过界回弹的动画，值越大移动越快</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>friction</td>
<td>number</td>
<td>2</td>
<td>否</td>
<td>摩擦系数，用于控制惯性滑动的动画，值越大摩擦力越大，滑动越快停止；必须大于0，否则会被设置成默认值</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>scale</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否支持双指缩放，默认缩放手势生效区域是在movable-view内</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>scale-min</td>
<td>number</td>
<td>0.5</td>
<td>否</td>
<td>定义缩放倍数最小值</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>scale-max</td>
<td>number</td>
<td>10</td>
<td>否</td>
<td>定义缩放倍数最大值</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>scale-value</td>
<td>number</td>
<td>1</td>
<td>否</td>
<td>定义缩放倍数，取值范围为 0.5 - 10</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>animation</td>
<td>boolean</td>
<td>true</td>
<td>否</td>
<td>是否使用动画</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.1.0</a></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>拖动过程中触发的事件，event.detail = {x, y, source}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>bindscale</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>缩放过程中触发的事件，event.detail = {x, y, scale}，x和y字段在<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.1.0</a>之后支持</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>htouchmove</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>初次手指触摸后移动为横向的移动时触发，如果catch此事件，则意味着touchmove事件也被catch</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>vtouchmove</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>初次手指触摸后移动为纵向的移动时触发，如果catch此事件，则意味着touchmove事件也被catch</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
</tbody></table>
<h5 id="bindchange-返回的-source-表示产生移动的原因"><a href="#bindchange-返回的-source-表示产生移动的原因" class="headerlink" title="bindchange 返回的 source 表示产生移动的原因"></a>bindchange <strong>返回的</strong> source <strong>表示产生移动的原因</strong></h5><table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>touch</td>
<td>拖动</td>
</tr>
<tr>
<td>touch-out-of-bounds</td>
<td>超出移动范围</td>
</tr>
<tr>
<td>out-of-bounds</td>
<td>超出移动范围后的回弹</td>
</tr>
<tr>
<td>friction</td>
<td>惯性</td>
</tr>
<tr>
<td>空字符串</td>
<td>setData</td>
</tr>
</tbody></table>
<h5 id="Bug-amp-Tip-3"><a href="#Bug-amp-Tip-3" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h5><ol>
<li>tip: movable-view 必须设置width和height属性，不设置默认为10px</li>
<li>tip: movable-view 默认为绝对定位，top和left属性为0px</li>
</ol>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/movable/movable.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">movable-area</span> <span class="attr">class</span>=<span class="string">"father-size"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">movable-view</span> <span class="attr">class</span>=<span class="string">"e size"</span> <span class="attr">direction</span>=<span class="string">"all"</span> <span class="attr">inertia</span>=<span class="string">"true"</span> <span class="attr">out-of-bounds</span>=<span class="string">"true"</span> <span class="attr">x</span>=<span class="string">"50"</span> <span class="attr">y</span>=<span class="string">"100"</span> <span class="attr">damping</span>=<span class="string">"100"</span> <span class="attr">friction</span>=<span class="string">"20"</span> <span class="attr">bindchange</span>=<span class="string">"doChange"</span>&gt;</span><span class="tag">&lt;/<span class="name">movable-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">movable-area</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* pages/movable/movable.wxss */</span></span><br><span class="line"><span class="selector-class">.size</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100</span>rpx;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">150</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.father-size</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">650</span>rpx;</span><br><span class="line">    <span class="attribute">background-color</span>: silver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.e</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: yellow;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100</span>rpx;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">200</span>rpx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/movable/movable.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    doChange:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"我被拖动了"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>​     <img src="http://photo.wushaopei.com/qiniu639.png" width="40%"></p>
<hr>
<h3 id="基础组件-icon"><a href="#基础组件-icon" class="headerlink" title="基础组件 - icon"></a>基础组件 - icon</h3><p>基础组件</p>
<ul>
<li>icon 图标组件        </li>
<li>rich-text 富文本组件<br>   text 文本组件         </li>
<li>progress 进度条组件</li>
</ul>
<h4 id="icon"><a href="#icon" class="headerlink" title="icon"></a><strong>icon</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>图标。组件属性的长度单位默认为px，<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.0</a>起支持传入单位(rpx/px)。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>type</td>
<td>string</td>
<td></td>
<td>是</td>
<td>icon的类型，有效值：success, success_no_circle, info, warn, waiting, cancel, download, search, clear</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>size</td>
<td>number/string</td>
<td>23</td>
<td>否</td>
<td>icon的大小</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>color</td>
<td>string</td>
<td></td>
<td>否</td>
<td>icon的颜色，同css的color</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h5><p><a href="https://developers.weixin.qq.com/s/LK9tzcmM6QYj" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/basic/basic.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-box-img"</span> <span class="attr">type</span>=<span class="string">"success"</span> <span class="attr">size</span>=<span class="string">"93"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>成功<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于表示操作顺利完成<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-box-img"</span> <span class="attr">type</span>=<span class="string">"info"</span> <span class="attr">size</span>=<span class="string">"93"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>提示<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于表示信息提示；也常用于缺乏条件的操作拦截，提示用户所需信息<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-box-img"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">size</span>=<span class="string">"93"</span> <span class="attr">color</span>=<span class="string">"#C9C9C9"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>普通警告<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于表示操作后将引起一定后果的情况；也用于表示由于系统原因而造成的负向结果<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-box-img"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">size</span>=<span class="string">"93"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>强烈警告<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于表示由于用户原因造成的负向结果；也用于表示操作后将引起不可挽回的严重后果的情况<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-box-img"</span> <span class="attr">type</span>=<span class="string">"waiting"</span> <span class="attr">size</span>=<span class="string">"93"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>等待<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于表示等待，告知用户结果需等待<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"success_no_circle"</span> <span class="attr">size</span>=<span class="string">"23"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>多选控件图标_已选择<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于多选控件中，表示已选择该项目<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"circle"</span> <span class="attr">size</span>=<span class="string">"23"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>多选控件图标_未选择<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于多选控件中，表示该项目可被选择，但还未选择<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">size</span>=<span class="string">"23"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>错误提示<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于在表单中表示出现错误<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"success"</span> <span class="attr">size</span>=<span class="string">"23"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>单选控件图标_已选择<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于单选控件中，表示已选择该项目<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"download"</span> <span class="attr">size</span>=<span class="string">"23"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>下载<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于表示可下载<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"info_circle"</span> <span class="attr">size</span>=<span class="string">"23"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>提示<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于在表单中表示有信息提示<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"cancel"</span> <span class="attr">size</span>=<span class="string">"23"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>停止或关闭<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于在表单中，表示关闭或停止<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-small-wrp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"icon-small"</span> <span class="attr">type</span>=<span class="string">"search"</span> <span class="attr">size</span>=<span class="string">"14"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-ctn"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-title"</span>&gt;</span>搜索<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"icon-box-desc"</span>&gt;</span>用于搜索控件中，表示可搜索<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/basic/basic.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">        iconSize: [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>, <span class="number">60</span>, <span class="number">70</span>],</span><br><span class="line">        iconColor: [</span><br><span class="line">        <span class="string">'red'</span>, <span class="string">'orange'</span>, <span class="string">'yellow'</span>, <span class="string">'green'</span>, <span class="string">'rgb(0,255,255)'</span>, <span class="string">'blue'</span>, <span class="string">'purple'</span></span><br><span class="line">        ],</span><br><span class="line">        iconType: [</span><br><span class="line">        <span class="string">'success'</span>, <span class="string">'success_no_circle'</span>, <span class="string">'info'</span>, <span class="string">'warn'</span>, <span class="string">'waiting'</span>, <span class="string">'cancel'</span>, <span class="string">'download'</span>, <span class="string">'search'</span>, <span class="string">'clear'</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>​     <img src="http://photo.wushaopei.com/qiniu641.png" width="40%"></p>
<hr>
<h3 id="基础组件-text"><a href="#基础组件-text" class="headerlink" title="基础组件 - text"></a>基础组件 - text</h3><h4 id="text"><a href="#text" class="headerlink" title="text"></a><strong>text</strong></h4><p>​    基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>文本。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>selectable</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>文本是否可选</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>space</td>
<td>string</td>
<td></td>
<td>否</td>
<td>显示连续空格</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.4.0</a></td>
</tr>
<tr>
<td>decode</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否解码</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.4.0</a></td>
</tr>
</tbody></table>
<p><strong>space 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ensp</td>
<td>中文字符空格一半大小</td>
<td></td>
</tr>
<tr>
<td>emsp</td>
<td>中文字符空格大小</td>
<td></td>
</tr>
<tr>
<td>nbsp</td>
<td>根据字体设置的空格大小</td>
<td></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-4"><a href="#Bug-amp-Tip-4" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li><p>tip: decode可以解析的有   &lt; &gt; &amp; ‘    </p>
</li>
<li><p>tip: 各个操作系统的空格标准并不一致。</p>
</li>
<li><p>tip:<a href="https://developers.weixin.qq.com/miniprogram/dev/component/text.html" target="_blank" rel="noopener">text</a> 组件内只支持 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/text.html" target="_blank" rel="noopener">text</a> 嵌套。</p>
</li>
<li><p>tip: 除了文本节点以外的其他节点都无法长按选中。</p>
</li>
<li><p>bug: 基础库版本低于 2.1.0 时， <a href="https://developers.weixin.qq.com/miniprogram/dev/component/text.html" target="_blank" rel="noopener">text</a> 组件内嵌的 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/text.html" target="_blank" rel="noopener">text</a> style 设置可能不会生效。</p>
</li>
</ol>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pages/basic/basic.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span> 这是一段view 内容<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">selectable</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span> <span class="attr">space</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>这是 一 段text文本<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">space</span>=<span class="string">"&#123;&#123;false&#125;&#125;"</span> <span class="attr">decode</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span><span class="symbol">&amp;nbsp;</span> <span class="symbol">&amp;lt;</span> <span class="symbol">&amp;gt;</span> <span class="symbol">&amp;amp;</span> <span class="symbol">&amp;apos;</span> <span class="symbol">&amp;ensp;</span> <span class="symbol">&amp;emsp;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="基础组件-rich-text-富文本"><a href="#基础组件-rich-text-富文本" class="headerlink" title="基础组件 - rich-text 富文本"></a>基础组件 - rich-text 富文本</h3><h4 id="rich-text"><a href="#rich-text" class="headerlink" title="rich-text"></a><strong>rich-text</strong></h4><p>基础库 1.4.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>富文本。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>nodes</td>
<td>array/string</td>
<td>[]</td>
<td>否</td>
<td>节点列表/HTML String</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.4.0</a></td>
</tr>
<tr>
<td>space</td>
<td>string</td>
<td></td>
<td>否</td>
<td>显示连续空格</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.1</a></td>
</tr>
</tbody></table>
<p><strong>space 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ensp</td>
<td>中文字符空格一半大小</td>
<td></td>
</tr>
<tr>
<td>emsp</td>
<td>中文字符空格大小</td>
<td></td>
</tr>
<tr>
<td>nbsp</td>
<td>根据字体设置的空格大小</td>
<td></td>
</tr>
</tbody></table>
<h4 id="nodes"><a href="#nodes" class="headerlink" title="nodes"></a><strong>nodes</strong></h4><p>现支持两种节点，通过type来区分，分别是元素节点和文本节点，默认是元素节点，在富文本区域里显示的HTML节点 <em>元素节点：type = node*</em></p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>说明</strong></th>
<th><strong>类型</strong></th>
<th><strong>必填</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>标签名</td>
<td>string</td>
<td>是</td>
<td>支持部分受信任的 HTML 节点</td>
</tr>
<tr>
<td>attrs</td>
<td>属性</td>
<td>object</td>
<td>否</td>
<td>支持部分受信任的属性，遵循 Pascal 命名法</td>
</tr>
<tr>
<td>children</td>
<td>子节点列表</td>
<td>array</td>
<td>否</td>
<td>结构和 nodes 一致</td>
</tr>
</tbody></table>
<p><strong>文本节点：type = text</strong></p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>说明</strong></th>
<th><strong>类型</strong></th>
<th><strong>必填</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>text</td>
<td>文本</td>
<td>string</td>
<td>是</td>
<td>支持entities</td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-5"><a href="#Bug-amp-Tip-5" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li><p>tip: nodes 不推荐使用 String 类型，性能会有所下降。</p>
</li>
<li><p>tip: rich-text 组件内屏蔽所有节点的事件。</p>
</li>
<li><p>tip: attrs 属性不支持 id ，支持 class 。</p>
</li>
<li><p>tip: name 属性大小写不敏感。</p>
</li>
<li><p>tip: 如果使用了不受信任的HTML节点，该节点及其所有子节点将会被移除。</p>
</li>
<li><p>tip: img 标签仅支持网络图片。</p>
</li>
<li><p>tip: 如果在自定义组件中使用 rich-text 组件，那么仅自定义组件的 wxss 样式对 rich-text 中的 class 生效。</p>
</li>
</ol>
<h4 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/zPVmpim46wYQ" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pages/basic/basic.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rich-text</span> <span class="attr">nodes</span>=<span class="string">"&#123;&#123;mycontent&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">rich-text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rich-text</span> <span class="attr">nodes</span>=<span class="string">"&#123;&#123;mycontent2&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">rich-text</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/basic/basic.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">    mycontent: <span class="string">'&lt;img height="200" width="200" src="http://img3.imgtn.bdimg.com/it/u=1203208975,277667042&amp;fm=11&amp;gp=0.jpg"&gt;'</span>,</span><br><span class="line">    mycontent2: [</span><br><span class="line">        &#123;</span><br><span class="line">        name: <span class="string">"img"</span>,</span><br><span class="line">        attrs:&#123;</span><br><span class="line">        height: <span class="string">"200"</span>,</span><br><span class="line">        width: <span class="string">"200"</span>,</span><br><span class="line">        src: <span class="string">"http://img3.imgtn.bdimg.com/it/u=1203208975,277667042&amp;fm=11&amp;gp=0.jpg"</span></span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="基础组件-progress"><a href="#基础组件-progress" class="headerlink" title="基础组件 - progress"></a>基础组件 - progress</h3><h4 id="progress"><a href="#progress" class="headerlink" title="progress"></a><strong>progress</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>进度条。组件属性的长度单位默认为px，<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.0</a>起支持传入单位(rpx/px)。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>percent</td>
<td>number</td>
<td></td>
<td>否</td>
<td>百分比0~100</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>show-info</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>在进度条右侧显示百分比</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>border-radius</td>
<td>number/string</td>
<td>0</td>
<td>否</td>
<td>圆角大小</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.3.1</a></td>
</tr>
<tr>
<td>font-size</td>
<td>number/string</td>
<td>16</td>
<td>否</td>
<td>右侧百分比字体大小</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.3.1</a></td>
</tr>
<tr>
<td>stroke-width</td>
<td>number/string</td>
<td>6</td>
<td>否</td>
<td>进度条线的宽度</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>color</td>
<td>string</td>
<td>#09BB07</td>
<td>否</td>
<td>进度条颜色（请使用activeColor）</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>activeColor</td>
<td>string</td>
<td>#09BB07</td>
<td>否</td>
<td>已选择的进度条的颜色</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>backgroundColor</td>
<td>string</td>
<td>#EBEBEB</td>
<td>否</td>
<td>未选择的进度条的颜色</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>active</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>进度条从左往右的动画</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>active-mode</td>
<td>string</td>
<td>backwards</td>
<td>否</td>
<td>backwards: 动画从头播；forwards：动画从上次结束点接着播</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.7.0</a></td>
</tr>
<tr>
<td>duration</td>
<td>number</td>
<td>30</td>
<td>否</td>
<td>进度增加1%所需毫秒数</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.8.2</a></td>
</tr>
<tr>
<td>bindactiveend</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>动画完成事件</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.1</a></td>
</tr>
</tbody></table>
<h4 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/Oga4Hcmj6cYS" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"progress-box"</span>&gt;</span></span><br><span class="line">`<span class="tag">&lt;<span class="name">progress</span> <span class="attr">percent</span>=<span class="string">"20"</span> <span class="attr">show-info</span> <span class="attr">stroke-width</span>=<span class="string">"3"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"progress-box"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">progress</span> <span class="attr">percent</span>=<span class="string">"40"</span> <span class="attr">active</span> <span class="attr">stroke-width</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">icon</span> <span class="attr">class</span>=<span class="string">"progress-cancel"</span> <span class="attr">type</span>=<span class="string">"cancel"</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"progress-box"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">progress</span> <span class="attr">percent</span>=<span class="string">"60"</span> <span class="attr">active</span> <span class="attr">stroke-width</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"progress-box"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">progress</span> <span class="attr">percent</span>=<span class="string">"80"</span> <span class="attr">color</span>=<span class="string">"#10AEFF"</span> <span class="attr">active</span> <span class="attr">stroke-width</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​     <img src="http://photo.wushaopei.com/qiniu640.png" width="40%"></p>
<p>​     <img src="http://photo.wushaopei.com/qiniu642.png" width="40%"></p>
<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>微信小程序</category>
      </categories>
      <tags>
        <tag>小程序注册</tag>
        <tag>helloworld</tag>
        <tag>目录结构</tag>
        <tag>生命周期</tag>
        <tag>调试debug</tag>
        <tag>数据绑定</tag>
        <tag>模板</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化开发（六）Specification-06-Common Function</title>
    <url>/2020/04/13/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BC%80%E5%8F%91%EF%BC%88%E5%85%AD%EF%BC%89Specification-06-Common-Function/</url>
    <content><![CDATA[<h2 id="06-Common-Function"><a href="#06-Common-Function" class="headerlink" title="06. Common Function"></a>06. Common Function</h2><p>设备将需要所有事件的间隔时间分开，而接口的间隔时间是分开的,报警时的报警报告 报警文字要写清楚。</p>
<h3 id="06-01-Equipment-Monitor-Management"><a href="#06-01-Equipment-Monitor-Management" class="headerlink" title="06.01. Equipment Monitor Management"></a>06.01. Equipment Monitor Management</h3><h4 id="06-01-01-Equipment-Alive"><a href="#06-01-01-Equipment-Alive" class="headerlink" title="06.01.01. Equipment Alive"></a>06.01.01. Equipment Alive</h4><p>​    设备带电是指设备运行正常，可以由PLC控制的状态。本地PLC应定期将设备的活位改变为4秒on, 4秒off。如果设备的活位10秒不改变，则主PLC应将其作为通信断开，并生成操作员呼叫。 </p>
<h5 id="06-01-01-01-PLC-MAP"><a href="#06-01-01-01-PLC-MAP" class="headerlink" title="06.01.01.01. PLC MAP"></a>06.01.01.01. PLC MAP</h5><h6 id="06-01-01-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-01-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.01.01.01. Local PLC – Link Relay (B Area)"></a>06.01.01.01.01. Local PLC – Link Relay (B Area)</h6><img src="http://photo.wushaopei.com/qiniu308.png" width="80%">



<h5 id="06-01-01-02-Communication-Scenario"><a href="#06-01-01-02-Communication-Scenario" class="headerlink" title="06.01.01.02. Communication Scenario"></a>06.01.01.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu309.png" width="80%">

<p>以 4s on 和 4s off 去检测机台的状态，如果 10s Bit都不变化，则认为机台挂掉了。</p>
<h4 id="06-01-02-CIM-Mode"><a href="#06-01-02-CIM-Mode" class="headerlink" title="06.01.02. CIM Mode"></a>06.01.02. CIM Mode</h4><p>CIM模式是指定设备与BC之间的通信关系。有两种模式，CIM on 模式和CIM off 模式。设备应在触摸屏上提供CIM模式切换按钮。CIM模式可以改变，无论玻璃计数。 </p>
<ul>
<li>CIM on模式:BC和EQ之间通讯正常，EQ可以向BC报告所有事件。BC也可以向EQ发送任何命令 </li>
<li>CIM OFF模式:BC和EQ之间的通信出现了某种异常，EQ可以更新状态数据( Word  区域)，但不能向BC报告事件(  Bit 区域)，不包括设备状态变化报告。同时，装备也不接受BC的任何命令 </li>
</ul>
<p><strong>※注意:</strong>  </p>
<pre><code>1. CIM关闭模式，设备应接受BC设置的CIM模式改变命令来改变CIM模式。 </code></pre><p>CIM Mode ：</p>
<p>​    <strong>ON</strong>  :  机台会把数据上报到BC，BC会收</p>
<pre><code>**OOF** :  机台不会 ON Bit , 只会去写 Word ；BC 只会在 机台 Bit 变化 on 才会去读 Word </code></pre><h5 id="06-01-02-01-PLC-MAP"><a href="#06-01-02-01-PLC-MAP" class="headerlink" title="06.01.02.01. PLC MAP"></a>06.01.02.01. PLC MAP</h5><h6 id="06-01-02-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-02-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.02.01.01. Local PLC – Link Relay (B Area)"></a>06.01.02.01.01. Local PLC – Link Relay (B Area)</h6><img src="http://photo.wushaopei.com/qiniu310.png" width="80%">



<h5 id="06-01-02-02-Communication-Scenario"><a href="#06-01-02-02-Communication-Scenario" class="headerlink" title="06.01.02.02. Communication Scenario"></a>06.01.02.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu311.png" width="80%">



<h4 id="06-01-03-CIM-Mode-Change-Command"><a href="#06-01-03-CIM-Mode-Change-Command" class="headerlink" title="06.01.03. CIM Mode Change Command"></a>06.01.03. CIM Mode Change Command</h4><p>​    BC可以通过CIM模式改变命令改变CIM模式的设备，进行数据采集。如果设备应答接受，设备需要再次自动触发CIM模式事件</p>
<p><strong>※注意:</strong></p>
<p>Return Code 说明:</p>
<p>1: Accept，表示设备接受命令，需要改变CIM模式。 </p>
<p>2: Already In Desired Status，即CIM模式的指令与设备CIM相同</p>
<p>3: Equipment Reject，意思是设备不能接受指令，不能改变CIM Mode</p>
<h5 id="06-01-03-01-PLC-MAP"><a href="#06-01-03-01-PLC-MAP" class="headerlink" title="06.01.03.01. PLC MAP"></a>06.01.03.01. PLC MAP</h5><h6 id=""><a href="#" class="headerlink" title=""></a><img src="http://photo.wushaopei.com/qiniu312.png" width="80%"></h6><h5 id="06-01-03-02-Communication-Scenario"><a href="#06-01-03-02-Communication-Scenario" class="headerlink" title="06.01.03.02. Communication Scenario"></a>06.01.03.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu313.png" width="80%">



<h4 id="06-01-04-CIM-Off-Mode-Operation"><a href="#06-01-04-CIM-Off-Mode-Operation" class="headerlink" title="06.01.04. CIM Off Mode Operation"></a>06.01.04. CIM Off Mode Operation</h4><p>Loader/Un-loader/Buffer/Virtual Port（加载器/卸载器/缓冲区/虚拟端口）应提供以下作业数据项设置功能CIM-OFF模式。</p>
<p>请参阅作业数据中的PLC地图文档。</p>
<img src="http://photo.wushaopei.com/qiniu314.png" width="80%">



<h4 id="06-01-05-Inline-Mode"><a href="#06-01-05-Inline-Mode" class="headerlink" title="06.01.05. Inline Mode"></a>06.01.05. Inline Mode</h4><p>内联模式仅与作业转移有关，并且仅在上游设备和下游设备之间必要。设备应按各接口提供触摸屏上的内联模式切换按钮。内联模式包括两种模式: </p>
<ul>
<li>Upstream Inline Mode On (上游内联模式开启) :EQ可以从上游设备接收一个玻璃/芯片。下游内联信号的接口链路信号打开 </li>
<li>Upstream Inline Mode Off (上游内联模式关闭) :EQ无法从上游设备接收任何玻璃/芯片。下游内联信号的接口链路信号将关闭 </li>
<li>Downstream Inline Mode On (下游内联模式开启) :EQ可以向下游设备发送一个玻璃/芯片。上游内联信号的接口链路信号将打开。 </li>
<li>Downstream Inline Mode Off (下游内联模式关闭) :EQ不能向下游设备发送任何玻璃/芯片。上游 Inline 信号的接口链路信号将关闭。 </li>
</ul>
<p>当设备有多个接口时，只要有一组 Inline on，就需要 Inline on向BC报告，当接口全部 Inline off时，就向BC报告  Inline off。 </p>
<h5 id="06-01-05-01-PLC-MAP"><a href="#06-01-05-01-PLC-MAP" class="headerlink" title="06.01.05.01. PLC MAP"></a>06.01.05.01. PLC MAP</h5><h6 id="06-01-05-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-05-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.05.01.01. Local PLC – Link Relay (B Area)"></a>06.01.05.01.01. Local PLC – Link Relay (B Area)</h6><img src="http://photo.wushaopei.com/qiniu315.png" width="80%">

<h5 id="06-01-05-02-Communication-Scenario"><a href="#06-01-05-02-Communication-Scenario" class="headerlink" title="06.01.05.02. Communication Scenario"></a>06.01.05.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu316.png" width="80%">

<h4 id="06-01-06-Local-Alarm-Status"><a href="#06-01-06-Local-Alarm-Status" class="headerlink" title="06.01.06. Local Alarm Status"></a>06.01.06. Local Alarm Status</h4><p>​    显示整个设备有报警(错误或警告)。如果所有警报(错误或警告)都已清除，则应将其关闭 </p>
<h5 id="06-01-06-01-PLC-MAP"><a href="#06-01-06-01-PLC-MAP" class="headerlink" title="06.01.06.01. PLC MAP"></a>06.01.06.01. PLC MAP</h5><h6 id="06-01-06-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-01-06-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.01.06.01.01. Local PLC – Link Relay (B Area)"></a>06.01.06.01.01. Local PLC – Link Relay (B Area)</h6><img src="http://photo.wushaopei.com/qiniu317.png" width="80%">



<h5 id="06-01-06-02-Communication-Scenario"><a href="#06-01-06-02-Communication-Scenario" class="headerlink" title="06.01.06.02. Communication Scenario"></a>06.01.06.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu318.png" width="80%">



<h4 id="06-01-07-Equipment-Operation-Mode"><a href="#06-01-07-Equipment-Operation-Mode" class="headerlink" title="06.01.07. Equipment Operation Mode"></a>06.01.07. Equipment Operation Mode</h4><p>显示设备当前运行方式为 <strong>Auto, Semi-Auto or Manual</strong> (自动、半自动或手动)。默认状态为自动，如果设备运行模式发生变化，应向BC报告。</p>
<p>在自动或半自动模式下，作业通过接口信号从上游设备接收或发送到下游设备</p>
<h5 id="06-01-07-01-PLC-MAP"><a href="#06-01-07-01-PLC-MAP" class="headerlink" title="06.01.07.01. PLC MAP"></a>06.01.07.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu319.png" width="80%">



<h5 id="06-01-07-02-Communication-Scenario"><a href="#06-01-07-02-Communication-Scenario" class="headerlink" title="06.01.07.02. Communication Scenario"></a>06.01.07.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu320.png" width="80%">

<h3 id="06-02-BC-Monitor-Management"><a href="#06-02-BC-Monitor-Management" class="headerlink" title="06.02. BC Monitor Management"></a>06.02. BC Monitor Management</h3><h4 id="06-02-01-BC-Status"><a href="#06-02-01-BC-Status" class="headerlink" title="06.02.01. BC Status"></a>06.02.01. BC Status</h4><p>​    BC将BC状态信号改为周期性信号，周期为开4秒，关4秒。如果BC状态位10秒内没有变化，本地PLC应以其为通讯连接，并拨打操作员电话，报警电平为报警，如果信号恢复正常，请自动清除报警。</p>
<p>(Alarm Text：BC Status Check Timeout )</p>
<h5 id="06-02-01-01-PLC-MAP"><a href="#06-02-01-01-PLC-MAP" class="headerlink" title="06.02.01.01. PLC MAP"></a>06.02.01.01. PLC MAP</h5><h6 id="06-02-01-01-01-Master-PLC-–-Link-Relay-B-Area"><a href="#06-02-01-01-01-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.02.01.01.01. Master PLC – Link Relay (B Area)"></a>06.02.01.01.01. Master PLC – Link Relay (B Area)</h6><img src="http://photo.wushaopei.com/qiniu351.png" width="80%">

<h5 id="06-02-01-02-Communication-Scenario"><a href="#06-02-01-02-Communication-Scenario" class="headerlink" title="06.02.01.02. Communication Scenario"></a>06.02.01.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu352.png" width="80%">

<h3 id="06-03-Equipment-Management"><a href="#06-03-Equipment-Management" class="headerlink" title="06.03. Equipment Management"></a>06.03. Equipment Management</h3><h4 id="06-03-01-Equipment-Status"><a href="#06-03-01-Equipment-Status" class="headerlink" title="06.03.01. Equipment Status"></a>06.03.01. Equipment Status</h4><p>​    如果设备状态发生变化，必须报告相应的事件。它必须显示在设备的触摸屏上。如果设备状态改变为停止或设置，设备应提前报警，并绘制下报警图。没有直接改变设备状态的远程命令。在BC中，设备状态定义为以下五种类型之一: </p>
<ul>
<li><p>Idle :  设备不执行进程，但它已经准备好启动进程。这适用于是否有与设备相关的材料。 </p>
</li>
<li><p>Running :  设备正在执行一个进程。如果工艺完成，没有加工作业，设备又会再次闲置 </p>
</li>
<li><p>Setup :设备正在初始化模块和实用程序。设备应向BC报告  Alarm Level  = Error 。如果设备状态被操作员或BC命令更改为Setup，则报警ID应该报告给BC 65512 </p>
</li>
<li><p>Stop : 设备进程停止。设备因报警、H/W问题或其他原因停机。在此状态下，设备必须停止工作转移。设备应向BC报告报警级别=报警事件错误。如果设备状态被操作员或BC命令更改为Stop，则报警ID应为report 65513 to BC。 </p>
</li>
<li><p>Pause : 设备进程暂停。在这种状态下，设备可以立即恢复进程。设备应向BC报告报警级别=报警事件警告。如果设备状态被perator或BC命令更改为Pause，则报警ID应该报告给BC 65514。</p>
<p>如果设置状态改变，停止和暂停设备必须报告报警ID</p>
</li>
</ul>
<p><strong>※注意:</strong></p>
<ol>
<li>当 equipment/unit 状态变为Setup, Stop or Pause 时，设备应将报警事件的报警ID分开(除以BC或EQP异常或EQP正常开关…等) </li>
</ol>
<img src="http://photo.wushaopei.com/qiniu353.png" width="80%">

<img src="http://photo.wushaopei.com/qiniu354.png" width="80%">



<h4 id="06-03-02-Unit-Status"><a href="#06-03-02-Unit-Status" class="headerlink" title="06.03.02. Unit Status"></a>06.03.02. Unit Status</h4><p><strong>Unit Status</strong> 仅用于多单元设备，最大单元数为15。如果设备没有单元，所有的数据都应该设置为零，将被忽略。单元状态的类型和定义与设备状态的类型和定义相同。每个单元状态是独立的，但是设备状态可能依赖于设备内单元的状态。设备的唯一责任是<strong>根据其所在单位的状态报告正确的设备状态</strong> </p>
<h4 id="06-03-03-PLC-MAP"><a href="#06-03-03-PLC-MAP" class="headerlink" title="06.03.03. PLC MAP"></a>06.03.03. PLC MAP</h4><h5 id="06-03-03-01-Local-PLC-–-Link-Register-W-Area"><a href="#06-03-03-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="06.03.03.01. Local PLC – Link Register (W Area)"></a>06.03.03.01. Local PLC – Link Register (W Area)</h5><img src="http://photo.wushaopei.com/qiniu355.png" width="80%">

<h5 id="06-03-03-02-Local-PLC-–-Link-Relay-B-Area"><a href="#06-03-03-02-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.03.03.02. Local PLC – Link Relay (B Area)"></a>06.03.03.02. Local PLC – Link Relay (B Area)</h5><img src="http://photo.wushaopei.com/qiniu356.png" width="80%">

<h5 id="06-03-03-03-Master-PLC-–-Link-Relay-B-Area"><a href="#06-03-03-03-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.03.03.03. Master PLC – Link Relay (B Area)"></a>06.03.03.03. Master PLC – Link Relay (B Area)</h5><img src="http://photo.wushaopei.com/qiniu357.png" width="80%">



<h4 id="06-03-04-Communication-Scenari"><a href="#06-03-04-Communication-Scenari" class="headerlink" title="06.03.04. Communication Scenari"></a>06.03.04. Communication Scenari</h4><img src="http://photo.wushaopei.com/qiniu358.png" width="80%">



<h4 id="06-03-05-No-Processing-Time"><a href="#06-03-05-No-Processing-Time" class="headerlink" title="06.03.05. No Processing Time"></a>06.03.05. No Processing Time</h4><p>​    设备应在触摸屏上为每个单元和设备提供“无处理时间”定时器设置功能。设备是空转时，如果设备超过 no processing time 时间，则设备应报告 Idle。(无处理时间=0:不检查无处理时间)(默认值:Tact Time * 2) </p>
<img src="http://photo.wushaopei.com/qiniu359.png" width="80%">



<h4 id="06-03-06-Send-Wait-Time-Out-Report"><a href="#06-03-06-Send-Wait-Time-Out-Report" class="headerlink" title="06.03.06. Send Wait Time Out Report"></a>06.03.06. Send Wait Time Out Report</h4><p>​    当上游设备将玻璃转移到下游设备，但下游设备没有开始接收上游设备的玻璃，当超过发送等待计时时间，则上游设备需要向BC报告此事件。 </p>
<h5 id="06-03-06-01-PLC-MAP"><a href="#06-03-06-01-PLC-MAP" class="headerlink" title="06.03.06.01. PLC MAP"></a>06.03.06.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu360.png" width="90%">

<h5 id="06-03-06-02-Communication-Scenario"><a href="#06-03-06-02-Communication-Scenario" class="headerlink" title="06.03.06.02. Communication Scenario"></a>06.03.06.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu361.png" width="90%">

<h4 id="06-03-07-Equipment-Status-Stop-Command"><a href="#06-03-07-Equipment-Status-Stop-Command" class="headerlink" title="06.03.07. Equipment Status Stop Command"></a>06.03.07. Equipment Status Stop Command</h4><p>​    当BC收到设备报告“发送等待时间超时报告”事件时，BC会请求下游设备状态变化目标停止。</p>
<p>​    当设备状态空闲时，设备状态只能改变为停止。其他的状态应该是回复“不接受”给BC。</p>
<h5 id="06-03-07-01-PLC-MAP"><a href="#06-03-07-01-PLC-MAP" class="headerlink" title="06.03.07.01. PLC MAP"></a>06.03.07.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu362.png" width="90%">

<h5 id="06-03-07-02-Communication-Scenario"><a href="#06-03-07-02-Communication-Scenario" class="headerlink" title="06.03.07.02. Communication Scenario"></a>06.03.07.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu363.png" width="90%">



<h3 id="06-04-Alarm-Management"><a href="#06-04-Alarm-Management" class="headerlink" title="06.04. Alarm Management"></a>06.04. Alarm Management</h3><p> alarm (报警）是指设备上可能危及正在加工的人员、设备或物料的任何异常情况。 </p>
<h4 id="06-04-01-Alarm-Status"><a href="#06-04-01-Alarm-Status" class="headerlink" title="06.04.01. Alarm Status"></a>06.04.01. Alarm Status</h4><p>  报告的是警报状态。 </p>
<ul>
<li>Alarm Set： 检测到警报 </li>
<li>Alarm Clear：警报解除。 </li>
</ul>
<h4 id="06-04-02-Alarm-Unit"><a href="#06-04-02-Alarm-Unit" class="headerlink" title="06.04.02. Alarm Unit"></a>06.04.02. Alarm Unit</h4><p>  当设备报告一个警报事件时，它显示该警报与设备中的哪个单元有关。 </p>
<h4 id="06-04-03-Alarm-ID"><a href="#06-04-03-Alarm-ID" class="headerlink" title="06.04.03. Alarm ID"></a>06.04.03. Alarm ID</h4><p>所有设备制造商必须提交每台设备的报警标识清单。一个单元必须有一个唯一的警报ID，无论错误或警告警报。 </p>
<ul>
<li>0：reserved (never used)  </li>
<li>1 ~ 65500：Equipment can use </li>
<li>65501 ~ 65535：By BC Defined</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu364.png" width="90%">

<h4 id="06-04-04-Alarm-Code"><a href="#06-04-04-Alarm-Code" class="headerlink" title="06.04.04. Alarm Code"></a>06.04.04. Alarm Code</h4><ul>
<li>Bit 00：Danger for human （对人类危险 ）</li>
<li>Bit 01：Equipment error </li>
<li>Bit 02：Parameter overflow caused process error  （参数溢出导致进程错误 ）</li>
<li>Bit 03：Parameter overflow caused equipment can’t work  （参数溢出导致设备无法工作 ）</li>
<li>Bit 04：Cannot recover trouble  （无法恢复故障 ）</li>
<li>Bit 05：Equipment status warning  （设备状态警告 ）</li>
<li>Bit 06：Process reached to predefined status （进程达到预定义状态 ）</li>
<li>Bit 07：BC Caused </li>
</ul>
<h4 id="06-04-05-Alarm-Level"><a href="#06-04-05-Alarm-Level" class="headerlink" title="06.04.05. Alarm Level"></a>06.04.05. Alarm Level</h4><p>​    它显示了警报的级别。它由警告和错误组成。 </p>
<ul>
<li>Warning : 警告表示一个灯光错误。对于警告，设备应继续进行处理、蜂鸣操作，并将信息显示在触摸屏上。 </li>
<li>Error :  告警表示严重错误。当报警发生时，设备必须停止处理(某些设备可能只会导致进程暂停)，蜂鸣操作员对设备进行检查，并在触摸屏上显示信息 </li>
</ul>
<h4 id="06-04-06-Alarm-Text"><a href="#06-04-06-Alarm-Text" class="headerlink" title="06.04.06. Alarm Text"></a>06.04.06. Alarm Text</h4><p>​    它包含一个简短的文本描述的警报。 </p>
<h4 id="06-04-07-Alarm-Text-Using-Flag"><a href="#06-04-07-Alarm-Text-Using-Flag" class="headerlink" title="06.04.07. Alarm Text Using Flag"></a>06.04.07. Alarm Text Using Flag</h4><p>​    它定义了设备或BC使用的报警文本。 </p>
<h4 id="06-04-08-PLC-MAP"><a href="#06-04-08-PLC-MAP" class="headerlink" title="06.04.08. PLC MAP"></a>06.04.08. PLC MAP</h4><p>​    <img src="http://photo.wushaopei.com/qiniu365.png" width="90%"></p>
<h5 id="06-04-08-02-Local-PLC-–-Link-Relay-B-Area"><a href="#06-04-08-02-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.04.08.02. Local PLC – Link Relay (B Area)"></a>06.04.08.02. Local PLC – Link Relay (B Area)</h5><p>​    <img src="http://photo.wushaopei.com/qiniu366.png" width="90%"></p>
<h5 id="06-04-08-03-Master-PLC-–-Link-Relay-B-Area"><a href="#06-04-08-03-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.04.08.03. Master PLC – Link Relay (B Area)"></a>06.04.08.03. Master PLC – Link Relay (B Area)</h5><p>​    <img src="http://photo.wushaopei.com/qiniu367.png" width="90%"></p>
<h4 id="06-04-09-Communication-Scenario"><a href="#06-04-09-Communication-Scenario" class="headerlink" title="06.04.09. Communication Scenario"></a>06.04.09. Communication Scenario</h4><p>​    <img src="http://photo.wushaopei.com/qiniu368.png" width="90%"></p>
<h3 id="06-05-Job-Management"><a href="#06-05-Job-Management" class="headerlink" title="06.05. Job Management"></a>06.05. Job Management</h3><p>​    这项工作意味着要对玻璃、芯片等材料进行加工。每个作业都有自己独特的数据进行处理，这些数据称为作业数据，包括PPID、盒式磁带序列号、作业序列号等。作业数据从上游设备接收，主设备已准备好接收作业，应发送到下游设备，主设备已准备好发送作业。设备应保存和管理每个作业的作业数据，即使作业在内部区域之间移动。同时，设备应在触摸屏上提供各工种的作业数据信息。 </p>
<h4 id="06-05-01-Job-Data-Transfer"><a href="#06-05-01-Job-Data-Transfer" class="headerlink" title="06.05.01. Job Data Transfer"></a>06.05.01. Job Data Transfer</h4><p>如果设备向其他设备发送作业，发送作业的设备称为上游设备。如果设备从其他设备接收作业，接收作业的设备称为下游设备。设备可以有一个以上的上游设备和下游设备。为了区分哪些设备是上游设备，哪些是下游设备，对于特定的设备，上游路径号为。被使用和管理。</p>
<p>当向下游设备发送作业时，作业数据通过CC-Link IE随作业一起传输到下游设备。对于作业数据的传输，设备可以根据设备需要的作业数据数量，从“发送下游01块作业数据到”发送下游10块作业数据，再从“接收上游01块作业数据”到“接收上游10块作业数据”。</p>
<p>当上游设备即将向下游设备发送作业时，下游设备首先验证作业的作业数据。如果在作业数据中没有检测到错误，下游设备开始接收作业</p>
<p>​    <img src="http://photo.wushaopei.com/qiniu369.png" width="90%"></p>
<h5 id="06-05-01-01-PLC-MAP"><a href="#06-05-01-01-PLC-MAP" class="headerlink" title="06.05.01.01. PLC MAP"></a>06.05.01.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu370.png" width="90%"></p>
<h4 id="06-05-02-Job-Event"><a href="#06-05-02-Job-Event" class="headerlink" title="06.05.02. Job Event"></a>06.05.02. Job Event</h4><p>作业数据必须在特殊的时间上报给BC，例如从上游设备接收作业，向下游设备发送作业，从磁带或单元取出作业，将作业存储到磁带或单元中，从设备中删除作业。玻璃内部的CST，在取出时，对应的槽R数据需要取出后取出在取出的作业数据，玻璃存储到CST中，对应的槽R要填写相应的作业数据。 </p>
<p>​    <img src="http://photo.wushaopei.com/qiniu371.png" width="90%"></p>
<h5 id="06-05-02-01-Job-Event-Timing-Chart"><a href="#06-05-02-01-Job-Event-Timing-Chart" class="headerlink" title="06.05.02.01. Job Event Timing Chart"></a>06.05.02.01. Job Event Timing Chart</h5><p>​    <img src="http://photo.wushaopei.com/qiniu372.png" width="90%"></p>
<h4 id="06-05-03-Receive-Job-Data-Event"><a href="#06-05-03-Receive-Job-Data-Event" class="headerlink" title="06.05.03. Receive Job Data Event"></a>06.05.03. Receive Job Data Event</h4><p>​    当设备从上游设备接收作业时，应报告此事件。当设备报告接收到的作业事件时，包括以下项目。 </p>
<ul>
<li>Received Job :从上游设备接收到的作业的作业数据，应在作业转移数据区写入接收作业数据，接收信号关闭后，作业完全由下游设备接收。 </li>
<li>在上下游设备之间，从下游设备接收到的作业事件报告顺序应遵循物理作业转移顺序。准确的报告时间将在测试期间和测试后进行调整，如果需要的话。 </li>
</ul>
<h5 id="06-05-03-01-PLC-MAP"><a href="#06-05-03-01-PLC-MAP" class="headerlink" title="06.05.03.01. PLC MAP"></a>06.05.03.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu373.png" width="90%"></p>
<h5 id="06-05-03-02-Communication-Scenario"><a href="#06-05-03-02-Communication-Scenario" class="headerlink" title="06.05.03.02. Communication Scenario"></a>06.05.03.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu374.png" width="90%"></p>
<h4 id="06-05-04-Send-Out-Job-Data-Event"><a href="#06-05-04-Send-Out-Job-Data-Event" class="headerlink" title="06.05.04. Send Out Job Data Event"></a>06.05.04. Send Out Job Data Event</h4><p>当设备向下游设备发送作业时，应报告此事件。当设备报告发送的作业事件时，应包括以下项目 .</p>
<ul>
<li>Send Out Job  :  在链路信号上升时，工作转移信号和工作应完全转移到下游设备，EQ应在工作转移数据区写入发送的工作数据。 </li>
<li>在上游和下游设备之间，上游设备发出作业事件的报告顺序应遵循物理作业转移顺序。准确的报告时间将在测试期间和测试后进行调整，如果需要的话 </li>
</ul>
<h5 id="06-05-04-01-PLC-MAP"><a href="#06-05-04-01-PLC-MAP" class="headerlink" title="06.05.04.01. PLC MAP"></a>06.05.04.01. PLC MAP</h5><h6 id="06-05-04-01-01-Local-PLC-–-Link-Register-W-Area"><a href="#06-05-04-01-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="06.05.04.01.01. Local PLC – Link Register (W Area)"></a>06.05.04.01.01. Local PLC – Link Register (W Area)</h6><p>​    <img src="http://photo.wushaopei.com/qiniu375.png" width="90%"></p>
<h6 id="06-05-04-01-02-Local-PLC-–-Link-Relay-B-Area"><a href="#06-05-04-01-02-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.05.04.01.02. Local PLC – Link Relay (B Area)"></a>06.05.04.01.02. Local PLC – Link Relay (B Area)</h6><p>​    <img src="http://photo.wushaopei.com/qiniu376.png" width="90%"></p>
<h6 id="06-05-04-01-03-Master-PLC-–-Link-Relay-B-Area"><a href="#06-05-04-01-03-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.05.04.01.03. Master PLC – Link Relay (B Area)"></a>06.05.04.01.03. Master PLC – Link Relay (B Area)</h6><p>​    <img src="http://photo.wushaopei.com/qiniu377.png" width="90%"></p>
<h5 id="06-05-04-02-Communication-Scenario"><a href="#06-05-04-02-Communication-Scenario" class="headerlink" title="06.05.04.02. Communication Scenario"></a>06.05.04.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu378.png" width="90%"></p>
<h4 id="06-05-05-Store-Job-Data-Event"><a href="#06-05-05-Store-Job-Data-Event" class="headerlink" title="06.05.05. Store Job Data Event"></a>06.05.05. Store Job Data Event</h4><p>当设备将作业存储到一个单元或磁带时，应使用端口号和单元编号报告此事件。如果有插槽，则应报告插槽。 </p>
<ul>
<li>Store Job : 存储的作业的作业数据 </li>
<li>Unit or Port : 用于区分存储在 unit 或 port 上的产品 </li>
<li>Unit No :  本单位的单位编号。如果本机有槽位，设备应更新槽位号 </li>
<li>Port No :  作业存储的磁带的端口号。设备应更新槽号 </li>
<li>Slot No : 槽号。如果单元没有槽号，这个项目应该被清除。 </li>
</ul>
<h5 id="06-05-05-01-PLC-MAP"><a href="#06-05-05-01-PLC-MAP" class="headerlink" title="06.05.05.01. PLC MAP"></a>06.05.05.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu379.png" width="90%"></p>
<h5 id="06-05-05-02-Communication-Scenario"><a href="#06-05-05-02-Communication-Scenario" class="headerlink" title="06.05.05.02. Communication Scenario"></a>06.05.05.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu380.png" width="90%"></p>
<h4 id="06-05-06-Fetch-Out-Job-Data-Event"><a href="#06-05-06-Fetch-Out-Job-Data-Event" class="headerlink" title="06.05.06. Fetch Out Job Data Event"></a>06.05.06. Fetch Out Job Data Event</h4><p>当设备从一个单元或磁带中取出 Job 时，应使用端口号和单元编号报告该事件。如果有插槽，则应报告插槽。</p>
<p>取作业的作业数据是在从磁带或单元中取出作业时报告的。</p>
<p>在这种情况下，必须报告端口号和单元编号。</p>
<ul>
<li>Fetch Out Job：取出作业数据 的作业</li>
<li>Unit or Port：用于区分从单元或端口取出的产品。 </li>
<li>Unit No： 单元的单元号。如果设备有槽位，设备应更新槽位号</li>
<li>Port No： 工作取的磁带的端口号。设备应更新槽位号。</li>
<li>Slot No： Slot No. 如果单位没有槽位，这个项目应该被清除。 </li>
</ul>
<p><strong>※注意:</strong> </p>
<p>​    当Buffer不是单位时，不需要单位状态，只需要报告存储和提取到BC。</p>
<p>​    当缓冲区为单元时，需要报告单元状态，需要报告存储和提取到BC</p>
<h5 id="06-05-06-01-PLC-MAP"><a href="#06-05-06-01-PLC-MAP" class="headerlink" title="06.05.06.01. PLC MAP"></a>06.05.06.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu381.png" width="90%"></p>
<h5 id="06-05-06-02-Communication-Scenario"><a href="#06-05-06-02-Communication-Scenario" class="headerlink" title="06.05.06.02. Communication Scenario"></a>06.05.06.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu382.png" width="90%"></p>
<h4 id="06-05-07-Remove-Job-Event-Mode"><a href="#06-05-07-Remove-Job-Event-Mode" class="headerlink" title="06.05.07. Remove Job Event Mode"></a>06.05.07. Remove Job Event Mode</h4><p>​    当 Job Data 刚刚从设备中删除时，将报告已删除作业的作业数据。 </p>
<ul>
<li><p>Removed Job : 操作员删除的作业的作业数据。 </p>
</li>
<li><p>Unit or Port：它用于区分产品从单元或端口被移除。 </p>
</li>
<li><p>Unit No： 单元的单元号。如果本机有槽位，设备应更新槽位号 </p>
</li>
<li><p>Port No：作业被删除的磁带的端口号。设备应更新槽号 </p>
</li>
<li><p>Slot No：Slot No. 如果 unit 没有 slot ，这个item 应该被清除。 </p>
</li>
<li><p>Remove Job Flag：  </p>
<ul>
<li><p>Normal Remove：  如果删除作业标志是正常删除，设备应保持删除作业数据 </p>
</li>
<li><p>Recovery： 当删除作业标志被删除作业恢复时，设备应恢复此作业数据。 </p>
</li>
<li><p>Delete Dirty Data： 如果作业数据存在，但玻璃丢失，用户可以使用作业数据删除功能</p>
</li>
</ul>
</li>
</ul>
<p>  设备供应商应提供至少10个当前已删除的作业数据保存功能，并提供作业数据选择功能进行恢复。</p>
<p>  设备供应商应提供至少10个当前已删除的作业数据的删除保存功能，并提供作业数据选择功能进行恢复。</p>
<p>  如果设备恢复的作业数据项，如配方号、产品类型、组索引等，这些值的内容与设备本身不同，设备不能改变作业数据，应发出警告，然后等待操作员处理。</p>
<p>  如果BC没有对设备回复信号，对于正常的删除和删除脏数据，意味着在事件复位后，作业数据/计数应该被擦除;对于恢复，这意味着在事件停止后无法恢复作业数据</p>
<h5 id="06-05-07-01-Error-Recovery-and-Remove-Job"><a href="#06-05-07-01-Error-Recovery-and-Remove-Job" class="headerlink" title="06.05.07.01. Error Recovery and Remove Job"></a>06.05.07.01. Error Recovery and Remove Job</h5><p>当报警或发现作业存在与作业数据不符，需要更改或删除数据时，设备应具备以下功能: </p>
<ul>
<li><p>报警，通知操作员更正 </p>
</li>
<li><p>程序”和“作业位置显示”，以恢复上述差异故障或报警情况。 </p>
</li>
<li><p>拆卸程序应包含至少三项内容。 </p>
</li>
<li><p>Physical glass/chip removal </p>
</li>
<li><p>Report removed Job Data to BC </p>
</li>
<li><p>从触摸屏设备上删除作业 </p>
<p>设备供应商应提供详细的错误恢复场景。 </p>
</li>
</ul>
<h5 id="06-05-07-02-Error-Recovery-and-Normal-Process"><a href="#06-05-07-02-Error-Recovery-and-Normal-Process" class="headerlink" title="06.05.07.02 Error Recovery and Normal Process"></a>06.05.07.02 Error Recovery and Normal Process</h5><p>设备应提供以下功能，用于故障恢复后的正常流程 </p>
<ul>
<li>报警，通知操作员更正 </li>
<li>Before job transfer signal on : 手动将玻璃送至上游设备 </li>
<li>After job transfer signal on：通过人工操作将玻璃送至下游设备。 </li>
<li>Normal process after Error Recovery </li>
<li>Report job event to BC </li>
</ul>
<p>设备供应商应提供详细的错误恢复场景。 </p>
<h5 id="06-05-07-03-PLC-MAP"><a href="#06-05-07-03-PLC-MAP" class="headerlink" title="06.05.07.03. PLC MAP"></a>06.05.07.03. PLC MAP</h5><h6 id="06-05-07-03-01-Local-PLC-–-Link-Register-W-Area"><a href="#06-05-07-03-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="06.05.07.03.01. Local PLC – Link Register (W Area)"></a>06.05.07.03.01. Local PLC – Link Register (W Area)</h6><p>​    <img src="http://photo.wushaopei.com/qiniu419.png" width="90%"></p>
<h6 id="06-05-07-03-02-Local-PLC-–-Link-Relay-B-Area"><a href="#06-05-07-03-02-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.05.07.03.02. Local PLC – Link Relay (B Area)"></a>06.05.07.03.02. Local PLC – Link Relay (B Area)</h6><p>​    <img src="http://photo.wushaopei.com/qiniu420.png" width="90%"></p>
<h6 id="06-05-07-03-03-Master-PLC-–-Link-Relay-B-Area"><a href="#06-05-07-03-03-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.05.07.03.03. Master PLC – Link Relay (B Area)"></a>06.05.07.03.03. Master PLC – Link Relay (B Area)</h6><p>​    <img src="http://photo.wushaopei.com/qiniu421.png" width="90%"></p>
<h5 id="06-05-07-04-Communication-Scenario"><a href="#06-05-07-04-Communication-Scenario" class="headerlink" title="06.05.07.04. Communication Scenario"></a>06.05.07.04. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu422.png" width="90%"></p>
<h4 id="06-05-08-Job-Count-Report"><a href="#06-05-08-Job-Count-Report" class="headerlink" title="06.05.08. Job Count Report"></a>06.05.08. Job Count Report</h4><p>作业计数是报告整个设备的作业计数(不包括卡带)。根据作业类型，设备应区分作业是产品作业还是虚拟作业。  Normally，产品工作意味着大量的产品加工 , 但是在装配线上有两个产品工作， TFT和CF，产品工作意味着TFT玻璃加工 . 设备应根据作业类型的作业数据实时写入各类作业计数。 </p>
<ul>
<li>Total TFT Product Job Count  :  它是设备中TFT玻璃的当前计数。 </li>
<li>Total CF Product Job Count： 这是设备中CF 玻璃的当前计数。 </li>
<li>Total Dummy Job Count：这是设备中虚拟 玻璃 的数量</li>
<li>Total Through Dummy Job Count：  它是在设备中通过虚拟玻璃的计数</li>
<li>Total Thickness Dummy Job Count： 它是在设备中的虚拟玻璃厚度的计数 </li>
<li>Total UV MASK Job Count： 是在设备中UV MASK glasses 的计数</li>
<li>special requirement ： 对于一些有单位的设备，应该实时向BC报告作业数。请参阅操作场景规范的每一行。 </li>
</ul>
<h5 id="06-05-08-01-PLC-MAP"><a href="#06-05-08-01-PLC-MAP" class="headerlink" title="06.05.08.01. PLC MAP"></a>06.05.08.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu423.png" width="90%"></p>
<h5 id="06-05-08-02-Communication-Scenario"><a href="#06-05-08-02-Communication-Scenario" class="headerlink" title="06.05.08.02. Communication Scenario"></a>06.05.08.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu424.png" width="90%"></p>
<h4 id="06-05-09-Product-Type-Report"><a href="#06-05-09-Product-Type-Report" class="headerlink" title="06.05.09. Product Type Report"></a>06.05.09. Product Type Report</h4><p>每次设备从上游设备接收玻璃时 ，它应该根据工作产品类型数据实时写入Word区域的产品类型</p>
<ul>
<li>Special Requirement ： 有些设备有单元， 按每个单元报告产品类型，并实时报告给BC。请参考各线路操作方案规范。</li>
</ul>
<h5 id="06-05-09-01-PLC-MAP"><a href="#06-05-09-01-PLC-MAP" class="headerlink" title="06.05.09.01. PLC MAP"></a>06.05.09.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu425.png" width="90%"></p>
<h5 id="06-05-09-01-Communication-Scenario"><a href="#06-05-09-01-Communication-Scenario" class="headerlink" title="06.05.09.01. Communication Scenario"></a>06.05.09.01. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu426.png" width="90%"></p>
<h4 id="06-05-10-Job-Data-Shift"><a href="#06-05-10-Job-Data-Shift" class="headerlink" title="06.05.10. Job Data Shift"></a>06.05.10. Job Data Shift</h4><p>对于多工位设备，必须提供“作业数据转移”功能;这一功能意味着操作者可以将作业数据移动到另一个物理玻璃位置，但条件是从有作业数据但没有玻璃板的位置，移动到有玻璃板但没有玻璃板数据的另一个位置。此功能仅在设备状态处于“停止”状态时启用。 </p>
<p><strong>Example：</strong></p>
<p>如果设备中有两个玻璃位置异常，一个有工作数据但没有玻璃，另一个有玻璃但没有工作数据。操作人员可以通过该函数将作业数据转换到玻璃位置，并将两者结合起来 </p>
<p><strong>Condition：</strong> </p>
<p>(1). Source position：Glass not exists and Job Data existed. (Color = Red) </p>
<p>(2). Target position： Glass existed and Job Data not exist. (Color=Yellow) </p>
<p>(3). EQP should be stopped when use this function </p>
<p><strong>Step：</strong>  </p>
<p>​    <img src="http://photo.wushaopei.com/qiniu427.png" width="90%"></p>
<h4 id="06-05-11-Job-Each-Position"><a href="#06-05-11-Job-Each-Position" class="headerlink" title="06.05.11. Job Each Position"></a>06.05.11. Job Each Position</h4><p>当设备在输送、舞台、电梯、转台、缓冲槽等位置内进行作业转移时，应将设备的实际位置与卡带顺序号、作业顺序号实时上报至BC，并在设备触摸屏上显示。此外，岗位名称应由设备名称来代替。 </p>
<p>​    <img src="http://photo.wushaopei.com/qiniu428.png" width="90%"></p>
<h4 id="06-05-12-Set-Last-Glass-Command"><a href="#06-05-12-Set-Last-Glass-Command" class="headerlink" title="06.05.12. Set Last Glass Command"></a>06.05.12. Set Last Glass Command</h4><p>当出现以下特殊情况时，BC会在某些设备上指示“设置最后的玻璃命令”，通知某些玻璃被打开或关闭最后的玻璃。 </p>
<ul>
<li>Case#01： 如果带有最后一个玻璃标志的作业数据是打开的，但在某些设备中被破坏，则操作员触发“删除作业事件”到BC。BC将触发此功能到设备。 </li>
<li>Case#02：如果当前的磁带被设备或BC中断了，但是用上一个工作的玻璃标志不能从当前的磁带中取出。BC将触发此功能到设备。 </li>
</ul>
<p><strong>※ Note：</strong> </p>
<p><strong>Return Code Description：</strong>  </p>
<p>1：OK, Accepted, 意味着设备接受指令，需要打开工作数据的最后一面玻璃旗 </p>
<p>2：NG, No Matching Glass, 这意味着设备无法在每个位置找到玻璃。 </p>
<h5 id="06-05-12-01-PLC-MAP"><a href="#06-05-12-01-PLC-MAP" class="headerlink" title="06.05.12.01. PLC MAP"></a>06.05.12.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu429.png" width="90%"></p>
<p>​    <img src="http://photo.wushaopei.com/qiniu430.png" width="90%"></p>
<p>​    <img src="http://photo.wushaopei.com/qiniu431.png" width="90%"></p>
<h5 id="06-05-12-02-Communication-Scenario"><a href="#06-05-12-02-Communication-Scenario" class="headerlink" title="06.05.12.02. Communication Scenario"></a>06.05.12.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu432.png" width="90%"></p>
<h4 id="06-05-13-Job-Remove-Recovery-Command"><a href="#06-05-13-Job-Remove-Recovery-Command" class="headerlink" title="06.05.13. Job Remove Recovery Command"></a>06.05.13. Job Remove Recovery Command</h4><p>如果BC从某些设备收到删除/恢复作业事件，BC将下载作业删除/恢复信息到所有设备。 </p>
<p><strong>※ Note：</strong>  </p>
<p>Return Code Description：</p>
<p>For Indexer equipment both port： </p>
<p>1：OK, 意思是设备接受命令并从列表中删除或恢复作业数据(用于移出磁带) </p>
<p>2：NG,  这意味着设备无法在列表中找到工作数据。 </p>
<p>For other equipment : 总是回复OK到BC。 </p>
<h5 id="06-05-13-01-PLC-MAP"><a href="#06-05-13-01-PLC-MAP" class="headerlink" title="06.05.13.01. PLC MAP"></a>06.05.13.01. PLC MAP</h5><p>​    <img src="http://photo.wushaopei.com/qiniu433.png" width="90%"></p>
<h5 id="06-05-13-02-Communication-Scenario"><a href="#06-05-13-02-Communication-Scenario" class="headerlink" title="06.05.13.02. Communication Scenario"></a>06.05.13.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu434.png" width="90%"></p>
<h4 id="06-05-14-Job-Data-Edit-Report"><a href="#06-05-14-Job-Data-Edit-Report" class="headerlink" title="06.05.14. Job Data Edit Report"></a>06.05.14. Job Data Edit Report</h4><p>对于CELL , CF，它只对 Port 是 unloading port 或 两个 Port 的设备。其他设备应提供作业数据编辑功能，但修改后的设备不向BC报告新作业数据。</p>
<p>对于Cell，所有的设备都应该提供这个功能。修改后，设备应自动向BC报告新作业数据。</p>
<p>作业存储在磁带中，但操作员手册通过作业数据编辑功能改变了作业数据内容。修改后，设备应自动向BC报告新作业数据。</p>
<p>设备改造后应检查配方ID、产品类型、组索引等，如内容与设备本身不一致，设备无法保存作业数据，等待操作人员处理。</p>
<p><strong>※ Note：</strong> 所有项目的作业数据均可由操作人员在手动模式下进行修改，修改后的设备应检查是否可以使用。</p>
<p>​    <img src="http://photo.wushaopei.com/qiniu435.png" width="90%"></p>
<p>​    <img src="http://photo.wushaopei.com/qiniu436.png" width="90%"></p>
<h5 id="06-05-14-02-Communication-Scenario"><a href="#06-05-14-02-Communication-Scenario" class="headerlink" title="06.05.14.02. Communication Scenario"></a>06.05.14.02. Communication Scenario</h5><p>​    <img src="http://photo.wushaopei.com/qiniu437.png" width="90%"></p>
<h4 id="06-05-15-CST-Transfer-Event"><a href="#06-05-15-CST-Transfer-Event" class="headerlink" title="06.05.15. CST Transfer Event"></a>06.05.15. CST Transfer Event</h4><p>对于某些特殊线路，如 Array CAC线、Cell POL线，设备传输的是Cassette而不是Glass。当盒式磁带在上游设备和下游设备或单元内部设备之间传输时，设备仍需要向BC报告盒式磁带的接收/发送/存储/取出/移除事件 </p>
<h5 id="06-05-15-01-PLC-MAP"><a href="#06-05-15-01-PLC-MAP" class="headerlink" title="06.05.15.01. PLC MAP"></a>06.05.15.01. PLC MAP</h5><h6 id="06-05-15-01-01-Local-PLC-–-Link-Register-W-Area"><a href="#06-05-15-01-01-Local-PLC-–-Link-Register-W-Area" class="headerlink" title="06.05.15.01.01. Local PLC – Link Register (W Area)"></a>06.05.15.01.01. Local PLC – Link Register (W Area)</h6><p>​    <img src="http://photo.wushaopei.com/qiniu438.png" width="90%"> </p>
<img src="http://photo.wushaopei.com/qiniu439.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu440.png" width="90%">

<h4 id="06-05-15-02-Communication-Scenario"><a href="#06-05-15-02-Communication-Scenario" class="headerlink" title="06.05.15.02. Communication Scenario"></a>06.05.15.02. Communication Scenario</h4><img src="http://photo.wushaopei.com/qiniu441.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu442.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu443.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu444.png" width="90%">



<h4 id="06-05-16-Glass-Info-Change-Report"><a href="#06-05-16-Glass-Info-Change-Report" class="headerlink" title="06.05.16. Glass Info Change Report"></a>06.05.16. Glass Info Change Report</h4><p>Array TPE, CF总间距分室的日常检查槽应提供“Glass Info Change Report ”功能后，收到的工作从上游设备。</p>
<p>当从 rebot (或盒式磁带)接收玻璃时，盒式磁带序列号应由操作员手动更改(数组:5001<del>6000,CF:60000</del>61000)，工作序列号始终为1</p>
<h5 id="06-05-16-01-PLC-MAP"><a href="#06-05-16-01-PLC-MAP" class="headerlink" title="06.05.16.01. PLC MAP"></a>06.05.16.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu445.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu446.png" width="90%">

<h5 id="06-05-16-02-Communication-Scenario"><a href="#06-05-16-02-Communication-Scenario" class="headerlink" title="06.05.16.02. Communication Scenario"></a>06.05.16.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu447.png" width="80%">

<h3 id="06-06-Process-Data-Management"><a href="#06-06-Process-Data-Management" class="headerlink" title="06.06. Process Data Management"></a>06.06. Process Data Management</h3><p>该功能仅适用于工艺设备，具有加工参数值或检验结果等工艺数据。数据应与个人工作相关，并使用玻璃/芯片ID报告 </p>
<ul>
<li>Job Data：  作业数据应与发送作业的作业数据相同 </li>
<li>Processing Time：它是设备中某项工作的实际处理时间。 </li>
<li>Kind of Process Data：There are 4 kinds of process data <ul>
<li>By Glass：如果设备有工艺数据，每个玻璃/芯片的工艺数据应在作业发送到下游设备之前报告。一个本地设备应该向BC报告每个玻璃一次的工艺数据 </li>
<li>By Event： : BC发送“工艺数据请求”时，设备应报告工艺数据 </li>
<li>By Time (Accumulated Data)： 设备应报告累积的工艺数据。设备应提供累计工艺数据报告时间设定功能。 </li>
<li>By Time (Daily Check)： 设备应实时向BC报告当前数据，如每日检查项目、效用项目等 </li>
</ul>
</li>
</ul>
<h4 id="06-06-01-Default-Value"><a href="#06-06-01-Default-Value" class="headerlink" title="06.06.01. Default Value"></a>06.06.01. Default Value</h4><p>如果某些过程数据项没有“ measurement （测量）”或“ inspection (检查) ”，这些项目应按默认值报告如下: </p>
<img src="http://photo.wushaopei.com/qiniu448.png" width="90%">

<h4 id="06-06-02-By-Glass"><a href="#06-06-02-By-Glass" class="headerlink" title="06.06.02. By Glass"></a>06.06.02. By Glass</h4><p>在玻璃送至下游设备之前，设备需要按每个玻璃向BC报告“工艺数据”。</p>
<p>Special Case： 请参考操作场景说明书的每一行</p>
<ul>
<li>By File： 有些设备受PLC地址范围的限制，将工艺数据按文件改变使用(共享文件夹)向BC报告。但设备仍应使用此功能(仅使用Header - Process数据报告块，不包括Body - Process数据项块)通知BC按文件获取真实的进程数据内容。请参阅CSOT_G8.5B_EDC文件通用规范。 </li>
<li>By SECS： 有些设备受PLC地址范围的限制，工艺数据会由SECS更改后上报给BC。设备可忽略PLC功能。请参阅CSOT-18_G8.5B_Equipment SECS通用规范 </li>
</ul>
<h5 id="06-06-02-01-PLC-MAP"><a href="#06-06-02-01-PLC-MAP" class="headerlink" title="06.06.02.01. PLC MAP"></a>06.06.02.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu449.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu450.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu451.png" width="90%">

<h5 id="06-06-02-02-Communication-Scenario"><a href="#06-06-02-02-Communication-Scenario" class="headerlink" title="06.06.02.02. Communication Scenario"></a>06.06.02.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu452.png" width="90%">

<h4 id="06-06-03-By-Event"><a href="#06-06-03-By-Event" class="headerlink" title="06.06.03. By Event"></a>06.06.03. By Event</h4><h5 id="06-06-03-01-PLC-MAP"><a href="#06-06-03-01-PLC-MAP" class="headerlink" title="06.06.03.01. PLC MAP"></a>06.06.03.01. PLC MAP</h5><p>这是设备的特殊项目，如果一个设备需要报告那些项目，然后在PLC MAP 分配 </p>
<img src="http://photo.wushaopei.com/qiniu453.png" width="90%">

<h5 id="06-06-03-02-Communication-Scenario"><a href="#06-06-03-02-Communication-Scenario" class="headerlink" title="06.06.03.02. Communication Scenario"></a>06.06.03.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu454.png" width="90%">

<h4 id="06-06-04-By-Time-Accumulated-Data"><a href="#06-06-04-By-Time-Accumulated-Data" class="headerlink" title="06.06.04. By Time (Accumulated Data)"></a>06.06.04. By Time (Accumulated Data)</h4><h5 id="06-06-04-01-PLC-MAP"><a href="#06-06-04-01-PLC-MAP" class="headerlink" title="06.06.04.01. PLC MAP"></a>06.06.04.01. PLC MAP</h5><p>这是设备的特殊项目，如果一个设备需要报告那些项目，然后在PLC MAP 分配。 </p>
<img src="http://photo.wushaopei.com/qiniu455.png" width="90%">

<h5 id="06-06-04-02-Communication-Scenario"><a href="#06-06-04-02-Communication-Scenario" class="headerlink" title="06.06.04.02. Communication Scenario"></a>06.06.04.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu456.png" width="90%">

<h4 id="06-06-05-By-Time-Daily-Check"><a href="#06-06-05-By-Time-Daily-Check" class="headerlink" title="06.06.05. By Time (Daily Check)"></a>06.06.05. By Time (Daily Check)</h4><p>设备实时报告日常检查项目。 </p>
<h5 id="06-06-05-01-PLC-MAP"><a href="#06-06-05-01-PLC-MAP" class="headerlink" title="06.06.05.01. PLC MAP"></a>06.06.05.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu457.png" width="90%">

<h5 id="06-06-05-01-Communication-Scenario"><a href="#06-06-05-01-Communication-Scenario" class="headerlink" title="06.06.05.01. Communication Scenario"></a>06.06.05.01. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu458.png" width="90%">

<h3 id="06-07-APC-Data-Management"><a href="#06-07-APC-Data-Management" class="headerlink" title="06.07. APC Data Management"></a>06.07. APC Data Management</h3><p>此功能用于收集或控制跟踪数据、传感器数据(实用数据、设施数据……)或一些特殊数据 </p>
<h4 id="06-07-01-APC-Data-Report"><a href="#06-07-01-APC-Data-Report" class="headerlink" title="06.07.01. APC Data Report"></a>06.07.01. APC Data Report</h4><p>设备实时将APC数据(如跟踪数据或传感器数据或某些特殊数据收集)写入word区域。BC将读取这些数据并报告给主机。 </p>
<p>BC提供当前APC数据报告时间设置功能。 </p>
<p><strong>Trace</strong> (跟踪），传感器数据报告频率要求如下: </p>
<ul>
<li>如果 items 数少于200，必须支持4hz; </li>
<li>If the items count between 300 and 200, must support 3Hz; </li>
<li>If the items count greater than 300, must support 2Hz.  </li>
</ul>
<h5 id="06-07-01-01-PLC-MAP"><a href="#06-07-01-01-PLC-MAP" class="headerlink" title="06.07.01.01. PLC MAP"></a>06.07.01.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu470.png" width="90%">

<h4 id="06-07-02-APC-Data-Download"><a href="#06-07-02-APC-Data-Download" class="headerlink" title="06.07.02. APC Data Download"></a>06.07.02. APC Data Download</h4><p>BC would download APC Data to equipment for change some item value. When equipment  </p>
<p>receive BC of download data, should change the item of set value .</p>
<p><strong>※ Note：</strong> </p>
<p>Return Code Description：  </p>
<p>1：OK,   它的意思是设备接受命令并通过设定值来改变物品的值 </p>
<p>2：NG,  这意味着 equipment 不能接受BC的命令 </p>
<img src="http://photo.wushaopei.com/qiniu471.png" width="90%">

<h5 id="06-07-02-02-Communication-Scenario"><a href="#06-07-02-02-Communication-Scenario" class="headerlink" title="06.07.02.02. Communication Scenario"></a>06.07.02.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu472.png" width="90%">



<h4 id="06-07-03-Energy-Visualization-Management-能源可视化管理"><a href="#06-07-03-Energy-Visualization-Management-能源可视化管理" class="headerlink" title="06.07.03. Energy Visualization Management (能源可视化管理 )"></a>06.07.03. Energy Visualization Management (能源可视化管理 )</h4><p>设备应将液体、电力、燃气消耗数据按时间设定报告给BC。时间可以在触摸屏上设置，由CSOT工程师决定。 </p>
<h5 id="06-07-03-01-PLC-MAP"><a href="#06-07-03-01-PLC-MAP" class="headerlink" title="06.07.03.01. PLC MAP"></a>06.07.03.01. PLC MAP</h5><p>项目的能量可视化如下图所示，由CSOT工程师决定。 </p>
<img src="http://photo.wushaopei.com/qiniu473.png" width="90%">

<h5 id="06-07-03-02-PLC-MAP"><a href="#06-07-03-02-PLC-MAP" class="headerlink" title="06.07.03.02. PLC MAP"></a>06.07.03.02. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu474.png" width="90%">

<h5 id="06-07-03-03-Communication-Scenario"><a href="#06-07-03-03-Communication-Scenario" class="headerlink" title="06.07.03.03. Communication Scenario"></a>06.07.03.03. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu475.png" width="90%">



<h3 id="06-08-Recipe-Management"><a href="#06-08-Recipe-Management" class="headerlink" title="06.08. Recipe Management"></a>06.08. Recipe Management</h3><p>BC将通过盒式控制命令事件将作业数据下载到装入器/卸载器。该作业数据包括PPID。当作业被发送到下游设备时，PPID也通过CC-Link IE被发送到下游设备。For 收到 其他 equipment, 从 上游 设备 通过 CC-Link IE 并 送往 下游 设备 没有 任何 修改 .</p>
<ul>
<li><p>PPID示例格式:参考操作场景规范的每一行。 </p>
<img src="http://photo.wushaopei.com/qiniu476.png" width="50%">

<p>​    例如:L3设备应将PPID 3和4字符(AB)与设备配方ID进行比较。 </p>
</li>
</ul>
<h4 id="06-08-01-Auto-Recipe-Change-Mode"><a href="#06-08-01-Auto-Recipe-Change-Mode" class="headerlink" title="06.08.01. Auto Recipe Change Mode"></a>06.08.01. Auto Recipe Change Mode</h4><p>​    所有设备应提供自动配方更改功能。设备应在设备触摸屏上提供自动配方更改启用/禁用更改功能 </p>
<ul>
<li>Enable：Equipment should change Recipe ID by automatic. </li>
<li>Disable：Equipment should change Recipe ID by manual.</li>
</ul>
<h5 id="06-08-01-01-PLC-MAP"><a href="#06-08-01-01-PLC-MAP" class="headerlink" title="06.08.01.01. PLC MAP"></a>06.08.01.01. PLC MAP</h5><h6 id="06-08-01-01-01-Local-PLC-–-Link-Relay-B-Area-"><a href="#06-08-01-01-01-Local-PLC-–-Link-Relay-B-Area-" class="headerlink" title="06.08.01.01.01. Local PLC – Link Relay (B Area) "></a>06.08.01.01.01. Local PLC – Link Relay (B Area) </h6><img src="http://photo.wushaopei.com/qiniu492.png" width="80%">

<h5 id="06-08-01-02-Communication-Scenario"><a href="#06-08-01-02-Communication-Scenario" class="headerlink" title="06.08.01.02. Communication Scenario"></a>06.08.01.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu493.png" width="80%">

<h4 id="06-08-02-Current-Recipe-ID-Report"><a href="#06-08-02-Current-Recipe-ID-Report" class="headerlink" title="06.08.02. Current Recipe ID Report"></a>06.08.02. Current Recipe ID Report</h4><p>当前配方是由设备设置当前使用的配方ID。</p>
<p>当当前的配方改变时，设备应以相应的配方ID向BC报告。只有当设备中没有玻璃时，才允许当前的配方改变。设备不允许改变在设备的配方注册表中没有找到的当前配方</p>
<h5 id="06-08-02-01-PLC-MAP-debar"><a href="#06-08-02-01-PLC-MAP-debar" class="headerlink" title="06.08.02.01. PLC MAP debar"></a>06.08.02.01. PLC MAP debar</h5><img src="http://photo.wushaopei.com/qiniu494.png" width="80%">

<h5 id="06-08-02-02-Communication-Scenario"><a href="#06-08-02-02-Communication-Scenario" class="headerlink" title="06.08.02.02. Communication Scenario"></a>06.08.02.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu495.png" width="80%">

<h4 id="06-08-03-Equipment-Recipe-Validation"><a href="#06-08-03-Equipment-Recipe-Validation" class="headerlink" title="06.08.03. Equipment Recipe Validation"></a>06.08.03. Equipment Recipe Validation</h4><p>当 <code>cassette</code> 在端口加载时，在CIM状态下，BC将PPID下载到加载程序，在CIM关闭状态下，操作员在加载程序的触摸屏上输入PPID进行联机操作。</p>
<p>PPID从装载机转移到下游设备，在从上游设备接收玻璃之前，设备应验证PPID(如果启用配方检查)和相应的配方ID。</p>
<p>设备应提供 <code>Job Data Check</code>、 <code>enable/disable</code>  操作选择功能。正常情况下，机器处于 <code>enable</code> 功能;在异常处理情况下，OP选择禁用后，当玻璃从上游传输，下游接收玻璃，不需要检查配方或其他项目，如产品类型，组索引等。</p>
<p>详细规则请参阅CSOT-17_G8.5B_Equipment链路信号通用规范5.4.1作业数据检查功能。</p>
<ol>
<li><strong>Auto Recipe Change Enable Case：</strong>  </li>
</ol>
<ul>
<li>如果从上游设备接收的PPID与当前配方ID匹配，则设备可以从上游接收玻璃。 </li>
<li>如果从上游设备接收到的PPID与当前的配方ID不匹配，但在配方注册表中找到了，则设备应自动更改配方，从上游设备接收玻璃。 </li>
<li>如果从上游设备接收到的PPID与当前配方ID不匹配，且在配方注册表中未找到，则设备应发出警报，且未接收到玻璃。 </li>
<li>操作人员在设备上进行配方登记后，设备应再次检查PPID，并自动更改配方。如果从上游设备接收的PPID与当前配方ID匹配，则从上游设备接收玻璃 </li>
</ul>
<ol start="2">
<li><strong>Auto Recipe Change Disable Case：</strong>  </li>
</ol>
<ul>
<li>如果从上游设备接收的PPID与当前配方ID匹配，则设备可以从上游接收玻璃。 </li>
<li>如果从上游设备接收到的PPID与当前配方ID不匹配，则设备应发出警报，不接收玻璃。 </li>
<li>在操作员更改当前配方ID后，设备应再次检查PPID。如果从上游设备接收的PPID与当前配方ID匹配，则从上游设备接收玻璃 </li>
</ul>
<ol start="3">
<li><strong>Auto Recipe Change via Recipe ID Check Mode Case：</strong> </li>
</ol>
<ul>
<li>配方ID检查模式为禁用<code>(Disable)</code>，配方自动更改为禁用: 无论 Job Data 中的 Recipe ID 与 当前的 设备的Recipe ID 是否相同，都采取从上游设备接收玻璃并使用配方ID的电流进行处理/检测。 </li>
<li>Recipe ID Check Mode is Enable, Recipe Auto Change is Disable：  <ul>
<li>Job Data 中的 Recipe ID  与 当前设备的 Recipe ID  相同时，从上游设备接收玻璃，使用当前的 Recipe ID 进行加工/检测 </li>
<li>Job Data 中的 Recipe ID  与 当前设备的 Recipe ID 不同时，不能接收来自上游设备的玻璃并发出警报 </li>
</ul>
</li>
<li>Recipe ID Check Mode is Disable, Recipe Auto Change is Enable： <ul>
<li>Job Data 中的 Recipe ID  与 当前设备的 Recipe ID  相同时，从上游设备接收玻璃，使用当前的 Recipe ID 进行加工/检测 </li>
<li>Job Data 中的 Recipe ID  与 当前设备的 Recipe ID 不同时，应检查 Job Data 中的Recipe ID 是否可以更改: <ul>
<li>如果可以更改，则从上游设备接收玻璃，但将配方ID的当前值更改为 Job Data 中的 Recipe ID 进行加工/检测 </li>
<li>如果不能更改(包括配方表中不存在配方id)，则无法从上游设备接收玻璃并发出警报。 </li>
</ul>
</li>
</ul>
</li>
<li>Recipe ID Check Mode is Enable, Recipe Auto Change is Enable： <ul>
<li>Job Data 上的 Recipe ID 与当前的 Recipe ID 不同时 ，从上游设备接收玻璃，使用当前的 Recipe ID 进行加工/检测。 </li>
<li>Recipe ID 的作业数据与 当前Recipe ID 的不同，应检查 的 Job Data 中的Recipe ID 是否可以更改: <ul>
<li>如果可以更改，则从上游设备接收玻璃，但将当前的 Recipe ID 更改为Job Data 的Recipe ID 来加工/检测 </li>
<li>如果不能更改（包括配方表中不存在 Recipe ID ），则无法从上游设备接收玻璃并发出警报</li>
</ul>
</li>
</ul>
</li>
<li>其他情况:应结合 Job Data Check 项条件(如产品类型、产品ID、组索引启用或禁用)来判断收到的 glass 是否合格。 </li>
</ul>
<h5 id="06-08-03-01-Check-Item-Description"><a href="#06-08-03-01-Check-Item-Description" class="headerlink" title="06.08.03.01. Check Item Description"></a>06.08.03.01. Check Item Description</h5><p>当上游设备转移 Job 时，设备需要判断是否可以从上游设备接收 Job ，如下: </p>
<ul>
<li><p>Job Data Check Mode： 操作人员可在触摸屏上手动切换。 </p>
<ul>
<li><p>Enable :  设备需要检查每个条件来接收来自上游设备的作业 </p>
</li>
<li><p>Disable:  设备不检查各项情况，直接从上游设备接收作业。 </p>
<p>※ Note：如果作业数据检查模式无效，则所有检查项目将更改为无效。 </p>
</li>
</ul>
</li>
<li><p>Recipe ID Check Mode：Operators can manual change on Touch Panel </p>
<ul>
<li><p>Enable : 设备需要检查 Recipe ID 是否可以使用。同样，接收 Job ；不同，不接受 Job .</p>
</li>
<li><p>Disable : 设备不检查 Recipe ID ,直接从上游设备接收 Job ，并使用当前的 Recipe ID 进行处理</p>
</li>
</ul>
</li>
<li><p>Product Type Check Mode：Operators can manual change on Touch Panel. </p>
<ul>
<li>Enable ： 当设备中有 Glass 时， 设备不能混合不同产品类型的 Glass</li>
<li>Disable ：设备不检查产品类型，直接从上游设备接收 Job </li>
</ul>
<p>※ Note : 为避免混装产品，卸料盒应支持产品型式检查 </p>
<p>Enable/Disable function </p>
<p>※ Note : 对于CF卸载器，当产品类型检查为“Enable”时，卸载器需要检查当前产品类型的作业数据是否与已经卸载的CST中的作业数据的产品类型相同，还是空闲的CST来存储不同产品类型的作业数据。如果不同产品类型的作业数据可以存储到不使用的CST中，卸载器可以接收不同产品类型的作业数据;否则，没有CST可以存储不同产品类型的作业数据，卸载程序仍然可以接收不同产品类型的作业数据。 </p>
</li>
<li><p>Group Index Check Mode：Operators can manual change on Touch Panel. </p>
<ul>
<li>Enable : 设备需要检查 check last Group Index 是否与发送 Job Data 的上游组索引相同。相同，接收 Job ; 不同，不接收 Job.</li>
<li>Disable ：设备不检查 Group Index，直接从上游设备接收作业</li>
</ul>
</li>
<li><p>Product ID Check Moe：Operators can manual change on Touch Panel</p>
<ul>
<li>Enable : 设备需要检查上一个产品 ID 是否与上一个产品 ID 相同</li>
<li>Disable : 设备不检查产品 ID ，直接从上游设备接收 Job </li>
</ul>
</li>
<li><p>Job Duplicate Check Mode：Operators can manual change on Touch Panel. </p>
<ul>
<li><p>Enable：When receive/send out Job from/to upstream/downstream equipment, equipment need to check Cassette Sequence No and Job Sequence No same with last receive/send out of Cassette Sequence No and Job Sequence No or not. (Including equipment inside of Job). Same, can’t receive or send out the Job; different, can receive or send out the Job.</p>
</li>
<li><p>Disable :  Equipment doesn’t check Job Duplicate or not, directly receive Job from  </p>
<p>upstream equipment or send out to downstream equipment. </p>
<p>No matter check mode is enable or disable, when check Job was </p>
<p>always need to raise warning. </p>
<p>对于Cell，无论启用或禁用检查模式，当检查工作重复时，设备总是从上游设备接收玻璃，并且需要提高亏空。</p>
<p>对于电池，设备应检查10块玻璃的最后接收/发送历史记录;对于Array，CF， Equipment只是检查最后的玻璃接收/发送的历史</p>
</li>
</ul>
</li>
<li><p>COA Version Check Mode：Operators can manual change on Touch Panel. Just for CF </p>
<p>Unloader. </p>
<ul>
<li>Enable : 卸载器需要检查当前的COA版本是否与存储作业数据的COA版本相同。同样，存储作业;不同，不能存储作业 </li>
<li>Disable : 设备不检查COA版本，直接从上游设备接收作业。 </li>
</ul>
<p>※ Note： </p>
<ol>
<li><p>如果设备中没有玻璃，则不检查产品类型、组索引、产品ID和COA版本，然后直接从upstream equipment/stage 接收玻璃。</p>
</li>
<li><p>对于阵列，当设备处于强制清除模式(参见09.01.03节)时，不检查作业数据检查项。</p>
</li>
<li><p>For Cell Line Load Equipment : 负载需要记住最后一个玻璃产品类型，如果负载设备中没有玻璃，则不检查产品类型。但设备应检查新的CST玻璃产品类型与上一种玻璃产品类型，如不相同，机器不取玻璃，设备应报警并呼叫操作员。操作人员确认玻璃是否可以拿取。(更改运行不同的产品)  </p>
</li>
</ol>
</li>
</ul>
<h5 id="06-08-03-02-PLC-MAP"><a href="#06-08-03-02-PLC-MAP" class="headerlink" title="06.08.03.02. PLC MAP"></a>06.08.03.02. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu496.png" width="80%">

<h5 id="06-08-03-03-Communication-Scenari"><a href="#06-08-03-03-Communication-Scenari" class="headerlink" title="06.08.03.03. Communication Scenari"></a>06.08.03.03. Communication Scenari</h5><img src="http://photo.wushaopei.com/qiniu497.png" width="80%">



<h4 id="06-08-04-Recipe-Register-Validation-Command"><a href="#06-08-04-Recipe-Register-Validation-Command" class="headerlink" title="06.08.04. Recipe Register Validation Command"></a>06.08.04. Recipe Register Validation Command</h4><p>BC 可以向设备发送 Recipe ID 注册检查命令。如果BC发送的 Recipe ID 都已注册，那么设备应该回复OK，否则回复NG </p>
<ul>
<li><p>Auto Manual : </p>
<ul>
<li>Auto ： 通过BC自动触发此函数 </li>
<li>Manual :  在BC UI或MES查询中通过操作符触发此函数 </li>
</ul>
</li>
<li><p>Port No :  BC会将 Port No设为设备，设备需要将相同的 Port No回复给BC进行记录使用 </p>
</li>
<li><p>Recipe ID :  设备应将BC请求的 Recipe ID 回复到BC进行记录 </p>
<p>※ Note： </p>
<p>Return  Code Description:</p>
<ol>
<li>OK , 这意味着 BC 请求的 Recipe ID 存在  Recipe 表中</li>
<li>NG , 这意味着 BC 请求的 Recipe ID 不存在 Recipe 表中</li>
</ol>
</li>
</ul>
<h5 id="06-08-04-01-PLC-MAP"><a href="#06-08-04-01-PLC-MAP" class="headerlink" title="06.08.04.01. PLC MAP"></a>06.08.04.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu498.png" width="80%">

<h5 id="06-08-04-02-Communication-Scenario"><a href="#06-08-04-02-Communication-Scenario" class="headerlink" title="06.08.04.02. Communication Scenario"></a>06.08.04.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu499.png" width="80%">

<h4 id="06-08-05-Recipe-Modify-Report"><a href="#06-08-05-Recipe-Modify-Report" class="headerlink" title="06.08.05. Recipe Modify Report"></a>06.08.05. Recipe Modify Report</h4><p>When Recipe was Created or Modify or Deleted, equipment should report this event to BC. </p>
<ul>
<li>When a new Recipe is created by Engineer, Equipment should report Create to BC </li>
<li>When a Recipe is modified by Engineer, Equipment should report Modify to BC </li>
<li>When a Recipe is deleted by Engineer, Equipment should report Delete to BC. </li>
</ul>
<h5 id="06-08-05-01-PLC-MAP"><a href="#06-08-05-01-PLC-MAP" class="headerlink" title="06.08.05.01. PLC MAP"></a>06.08.05.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu500.png" width="80%">

<h5 id="06-08-05-02-Communication-Scenario"><a href="#06-08-05-02-Communication-Scenario" class="headerlink" title="06.08.05.02. Communication Scenario"></a>06.08.05.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu501.png" width="80%">

<h4 id="06-08-06-Recipe-Parameter-Request-Command"><a href="#06-08-06-Recipe-Parameter-Request-Command" class="headerlink" title="06.08.06. Recipe Parameter Request Command"></a>06.08.06. Recipe Parameter Request Command</h4><p>BC can request equipment Recipe Parameter for check MES recipe validation. When BC  </p>
<p>requests the recipe parameter to equipment, equipment should reply the recipe             parameter  value of corresponding Recipe ID.</p>
<ul>
<li>Port No： BC会将 Port No 设置为设备的，设备需要将相同的 Port No 回复给BC进行记录使用。 </li>
</ul>
<h5 id="06-08-06-01-Default-Value"><a href="#06-08-06-01-Default-Value" class="headerlink" title="06.08.06.01. Default Value"></a>06.08.06.01. Default Value</h5><p>如果设备为多单元类型，有些单元由于故障无法上报配方参数，请将这些参数的特殊值上报如下: </p>
<img src="http://photo.wushaopei.com/qiniu502.png" width="80%">

<h5 id="06-08-06-02-PLC-MAP"><a href="#06-08-06-02-PLC-MAP" class="headerlink" title="06.08.06.02. PLC MAP"></a>06.08.06.02. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu503.png" width="80%">

<h5 id="06-08-06-03-Communication-Scenario"><a href="#06-08-06-03-Communication-Scenario" class="headerlink" title="06.08.06.03. Communication Scenario"></a>06.08.06.03. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu504.png" width="80%">

<h3 id="06-09-CIM-Message-Management"><a href="#06-09-CIM-Message-Management" class="headerlink" title="06.09. CIM Message Management"></a>06.09. CIM Message Management</h3><p>CIM报文用于通知特定设备的操作员特定信息。 当接收到CIM报文时，设备必须将其显示给操作员，并在本地保存历史数据。 设备应支持BC可以使用 touch panel number 向特定设备的特定 touch panel 发送一个或多个CIM消息。 </p>
<p>当设备接收到来自BC的CIM消息时，设备应该在 touch panel 上的弹出窗口中显示CIM消息。CIM消息弹出窗口应提供“确认”按钮，如果操作员确认，则清除CIM消息，届时设备应报告确认事件(请参阅CIM消息确认报告区域)。 </p>
<p>设备只清除经操作员确认或由BC发出的CIM报文清除命令指示的CIM报文。当接收到CIM消息时，将显示如下: </p>
<img src="http://photo.wushaopei.com/qiniu505.png" width="80%">

<p>如果设备在工程师或操作员确认前已接收到1条以上的CIM消息，则设备应在屏幕上进行最多5条CIM消息的缓冲。如果缓冲的CIM报文数量超过5条，则设备应将CIM报文的缓冲改为最新的(最新的)5条CIM报文 .</p>
<h4 id="06-09-01-CIM-Message-History-Management"><a href="#06-09-01-CIM-Message-History-Management" class="headerlink" title="06.09.01. CIM Message History Management"></a>06.09.01. CIM Message History Management</h4><p>设备应该在设备触摸面板上显示至少20条最近从BC收到的CIM消息的历史 </p>
<img src="http://photo.wushaopei.com/qiniu506.png" width="80%">

<h4 id="06-09-02-CIM-Message-Set-Command"><a href="#06-09-02-CIM-Message-Set-Command" class="headerlink" title="06.09.02. CIM Message Set Command"></a>06.09.02. CIM Message Set Command</h4><p>这是从主设备到设备的命令，指示CIM消息显示在设备触摸屏上。当收到消息时，设备会在弹出窗口中显示消息。每个CIM消息都有其惟一的ID，设备根据CIM消息ID管理CIM消息。 </p>
<ul>
<li><p>CIM Message： 设备应该预留足够的空间来显示一些CIM消息。 </p>
<p>设备在带有CIM消息ID的设备触摸屏上显示CIM消息 </p>
</li>
<li><p>设备应提供在触摸屏上显示CIM信息的屏幕。 如果设备接收到CIM消息集命令，它必须首先读取该数据并显示在屏幕上 </p>
</li>
<li><p>CIM Message ID： CIM消息ID是消息的唯一标识， 而消息内容则向操作员指示更详细的信息。如果CIM消息ID没有值， 设备应有显示空间。  根据CIM消息ID， 设备应显示信息，并做一些动作，如蜂鸣器到操作员和打开信号塔灯。</p>
<p>进入翻译页面</p>
</li>
</ul>
<h5 id="06-09-02-01-Signal-Tower-Management"><a href="#06-09-02-01-Signal-Tower-Management" class="headerlink" title="06.09.02.01. Signal Tower Management"></a>06.09.02.01. Signal Tower Management</h5><p>当设备收到BC的CIM报文时，信号塔灯和蜂鸣器的设备如下: </p>
<img src="http://photo.wushaopei.com/qiniu507.png" width="80%">

<h5 id="06-09-02-02-PLC-MAP"><a href="#06-09-02-02-PLC-MAP" class="headerlink" title="06.09.02.02. PLC MAP"></a>06.09.02.02. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu508.png" width="80%">

<h5 id="06-09-02-03-Communication-Scenario"><a href="#06-09-02-03-Communication-Scenario" class="headerlink" title="06.09.02.03. Communication Scenario"></a>06.09.02.03. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu509.png" width="80%">

<h4 id="06-09-03-CIM-Message-Clear-Command"><a href="#06-09-03-CIM-Message-Clear-Command" class="headerlink" title="06.09.03. CIM Message Clear Command"></a>06.09.03. CIM Message Clear Command</h4><p>这是从主设备到设备的命令，指示明确的CIM信息显示在触摸屏上。设备从CIM消息弹出窗口清除主设备基于CIM消息ID所指示的CIM消息，无论该CIM消息是否已被操作员确认。如果在弹出窗口中没有未确认的CIM消息，则设备关闭弹出窗口。必须保存CIM信息的历史。 </p>
<p>设备应该支持BC可以清除一个或多个CIM消息从一个特定的特定设备的触控面板使用触摸板数量和CIM消息ID。如果设备收到这个命令时,设备应明确只有CIM的信息由CIM表示消息ID从触摸面板由触控面板编号表示。 </p>
<p>如果CIM信息全部清除或确认，则设备应关闭CIM信息弹出显示，蜂鸣器和信号塔应更改为原始状态 </p>
<p>CIM消息清除命令或确认后，设备应重新安排弹出式显示如下: </p>
<img src="http://photo.wushaopei.com/qiniu510.png" width="80%">



<h5 id="06-09-03-01-PLC-MAP"><a href="#06-09-03-01-PLC-MAP" class="headerlink" title="06.09.03.01. PLC MAP"></a>06.09.03.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu511.png" width="80%">

<h5 id="06-09-03-02-Communication-Scenario"><a href="#06-09-03-02-Communication-Scenario" class="headerlink" title="06.09.03.02. Communication Scenario"></a>06.09.03.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu512.png" width="80%">

<h4 id="06-09-04-CIM-Message-Confirm-Report"><a href="#06-09-04-CIM-Message-Confirm-Report" class="headerlink" title="06.09.04. CIM Message Confirm Report"></a>06.09.04. CIM Message Confirm Report</h4><p>这表示操作员在设备触摸屏上确认了CIM信息。 经操作员确认后，设备将CIM消息的ID报告给主设备 。</p>
<p>如果CIM信息全部清除或确认，则设备应关闭CIM信息弹出显示，蜂鸣器和信号塔应更改为原始状态 。</p>
<p>CIM消息清除命令或确认后，设备应重新安排弹出式显示如下: </p>
<img src="http://photo.wushaopei.com/qiniu513.png" width="80%">

<h5 id="06-09-04-01-PLC-MAP"><a href="#06-09-04-01-PLC-MAP" class="headerlink" title="06.09.04.01. PLC MAP"></a>06.09.04.01. PLC MAP</h5><img src="http://photo.wushaopei.com/qiniu514.png" width="80%">

<h5 id="06-09-04-02-Communication-Scenario"><a href="#06-09-04-02-Communication-Scenario" class="headerlink" title="06.09.04.02. Communication Scenario"></a>06.09.04.02. Communication Scenario</h5><img src="http://photo.wushaopei.com/qiniu515.png" width="80%">

<h3 id="06-10-Date-Time-Set-Command"><a href="#06-10-Date-Time-Set-Command" class="headerlink" title="06.10. Date Time Set Command"></a>06.10. Date Time Set Command</h3><p>当设备接收到该命令时，设备根据该命令发送的时间调整其本地系统时间。 </p>
<p>BC将设备接收MES的日期时间或设备CIM模式更改为ON的日期时间设置为设备的日期时间 </p>
<h4 id="06-10-01-PLC-MAP"><a href="#06-10-01-PLC-MAP" class="headerlink" title="06.10.01. PLC MAP"></a>06.10.01. PLC MAP</h4><h5 id="06-10-01-01-Local-PLC-–-Link-Relay-B-Area"><a href="#06-10-01-01-Local-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.10.01.01. Local PLC – Link Relay (B Area)"></a>06.10.01.01. Local PLC – Link Relay (B Area)</h5><img src="http://photo.wushaopei.com/qiniu516.png" width="80%">

<h5 id="06-10-01-02-Master-PLC-–-Link-Register-W-Area"><a href="#06-10-01-02-Master-PLC-–-Link-Register-W-Area" class="headerlink" title="06.10.01.02. Master PLC – Link Register (W Area)"></a>06.10.01.02. Master PLC – Link Register (W Area)</h5><img src="http://photo.wushaopei.com/qiniu517.png" width="80%">

<h5 id="06-10-01-03-Master-PLC-–-Link-Relay-B-Area"><a href="#06-10-01-03-Master-PLC-–-Link-Relay-B-Area" class="headerlink" title="06.10.01.03. Master PLC – Link Relay (B Area)"></a>06.10.01.03. Master PLC – Link Relay (B Area)</h5><img src="http://photo.wushaopei.com/qiniu518.png" width="80%">

<h4 id="06-10-02-Communication-Scenario"><a href="#06-10-02-Communication-Scenario" class="headerlink" title="06.10.02. Communication Scenario"></a>06.10.02. Communication Scenario</h4><img src="http://photo.wushaopei.com/qiniu519.png" width="80%">


]]></content>
      <categories>
        <category>自动化开发</category>
      </categories>
  </entry>
  <entry>
    <title>微信小程序（一）入门</title>
    <url>/2020/05/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%88%E4%B8%80%EF%BC%89%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h2 id="微信小程序简介"><a href="#微信小程序简介" class="headerlink" title="微信小程序简介"></a>微信小程序简介</h2><h3 id="什么是微信小程序"><a href="#什么是微信小程序" class="headerlink" title="什么是微信小程序"></a>什么是微信小程序</h3><p>​    微信小程序是一种全新的连接用户与服务方式，它可以在微信内被便捷的获取和传播，同时具有出色的使用体验。</p>
<blockquote>
<p>手机端 app 的另外一种新的展现形式</p>
<p>无需下载过多占用手机内存的 app ，小程序直接打开</p>
</blockquote>
<h3 id="小程序必备技术点"><a href="#小程序必备技术点" class="headerlink" title="小程序必备技术点"></a>小程序必备技术点</h3><blockquote>
<p>HTML </p>
<p>JavaScript</p>
<p>CSS</p>
</blockquote>
<p>并不是所有 app 都适用小程序</p>
<blockquote>
<p>基于腾讯庞大的社交群体，可以为原生 app 导流</p>
<p>创业公司有限退出小程序，开发成本低</p>
<p>当做简单的工具使用，需要在 app 上频繁 crud 不适用</p>
</blockquote>
<hr>
<h2 id="微信小程序的简要注册流程"><a href="#微信小程序的简要注册流程" class="headerlink" title="微信小程序的简要注册流程"></a>微信小程序的简要注册流程</h2><h3 id="小程序注册流程"><a href="#小程序注册流程" class="headerlink" title="小程序注册流程"></a>小程序注册流程</h3><ul>
<li>需要有公众号（未认证个人/认证企业）</li>
<li>需要一个邮箱，1v1</li>
</ul>
<p><strong>完善小程序信息</strong></p>
<ul>
<li>小程序名称、头像、介绍、类型</li>
<li>绑定开发者，管理员默认，团队成员需要绑定</li>
</ul>
<h3 id="完善信息"><a href="#完善信息" class="headerlink" title="完善信息"></a>完善信息</h3><img src="http://photo.wushaopei.com/qiniu563.png" width="60%">

<p>使用未注册过的邮箱进行注册小程序，每个邮箱仅能注册一个小程序或一个公众号</p>
<img src="http://photo.wushaopei.com/qiniu564.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu565.png" width="60%">

<p><strong>扫码登录</strong></p>
<img src="http://photo.wushaopei.com/qiniu566.png" width="60%">

<p><strong>点击进入完善信息</strong></p>
<img src="http://photo.wushaopei.com/qiniu567.png" width="60%">

<p><strong>主要完善的信息如上图示例。</strong></p>
<h3 id="绑定开发者"><a href="#绑定开发者" class="headerlink" title="绑定开发者"></a>绑定开发者</h3><img src="http://photo.wushaopei.com/qiniu568.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu569.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu570.png" width="60%">

<p>通过点击编辑，扫码后进行添加用户（开发者）</p>
<hr>
<h2 id="微信开发者工具-helloworld"><a href="#微信开发者工具-helloworld" class="headerlink" title="微信开发者工具 helloworld"></a>微信开发者工具 helloworld</h2><p><strong>HelloWorld 第一个小程序 demo</strong></p>
<blockquote>
<p>开发工具下载</p>
<p>开发工具安装</p>
<p>默认项目编译并且运行</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu571.png" width="60%">

<p>选择更多</p>
<img src="http://photo.wushaopei.com/qiniu572.png" width="60%">

<p>选择小程序开发 - 工具 ，根据当前系统是 32位或64位点击 window 64\32进行下载</p>
<p>将下载的 zip包解压并执行安装操作，点击打开<img src="http://photo.wushaopei.com/qiniu573.png" alt="img"> 程序，根据需要选择是否输入 AppID，创建一个 demo ；</p>
<img src="http://photo.wushaopei.com/qiniu574.png" width="60%">

<p>登录进入后页面效果如下：</p>
<img src="http://photo.wushaopei.com/qiniu575.png" width="60%">

<p>页面布局：</p>
<img src="http://photo.wushaopei.com/qiniu576.png" width="60%">

<p>目录结构：</p>
<img src="http://photo.wushaopei.com/qiniu577.png" width="60%">

<blockquote>
<p>app.js 一个小程序只有一个</p>
<p>app.json 配置文件</p>
<p>app.wxss 微信的css 样式</p>
</blockquote>
<img src="http://photo.wushaopei.com/qiniu578.png" width="60%">

<blockquote>
<p>index.wxml 页面</p>
<p>index.js 页面里的 js</p>
<p>index.wxss 页面里的 css</p>
</blockquote>
<h2 id="运行微信官方的-demo-演示"><a href="#运行微信官方的-demo-演示" class="headerlink" title="运行微信官方的 demo 演示"></a>运行微信官方的 demo 演示</h2><img src="http://photo.wushaopei.com/qiniu579.png" width="50%">

<blockquote>
<p>下载 demo 源码</p>
<p>可在PC端或微信端打开</p>
</blockquote>
<h3 id="demo-页面"><a href="#demo-页面" class="headerlink" title="demo 页面"></a>demo 页面</h3><img src="http://photo.wushaopei.com/qiniu580.png" width="60%">

<img src="http://photo.wushaopei.com/qiniu581.png" width="60%">

<p><code>从 git 上down 测试代码；</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/wechat-miniprogram/miniprogram-demo.git</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="共有目录与私有目录的工程结构了解"><a href="#共有目录与私有目录的工程结构了解" class="headerlink" title="共有目录与私有目录的工程结构了解"></a>共有目录与私有目录的工程结构了解</h2><p><strong>小程序工程的构成</strong></p>
<img src="http://photo.wushaopei.com/qiniu582.png" width="60%">

<p><strong>主目录结构分析：</strong></p>
<img src="http://photo.wushaopei.com/qiniu583.png" width="60%">

<blockquote>
<p> app.js - 外部全局主 js , 可以当做一个父类</p>
<p>app.json - 全局配置文件</p>
<p>app.wxss - 全局主样式，公用</p>
</blockquote>
<p><strong>页面目录结构分析：</strong></p>
<img src="http://photo.wushaopei.com/qiniu584.png" width="60%">

<blockquote>
<p> items.js - 私有的js ,相当于子类</p>
<p>items.json - 以 json 对象形式存在的配置</p>
<p>items.wxml - 元素所渲染的页面</p>
<p>items.wxss - 私有样式</p>
</blockquote>
<hr>
<h2 id="手写属于自己的第一个-demo"><a href="#手写属于自己的第一个-demo" class="headerlink" title="手写属于自己的第一个 demo"></a>手写属于自己的第一个 demo</h2><img src="http://photo.wushaopei.com/qiniu585.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu586.png" width="90%">

<h3 id="关于app-js-："><a href="#关于app-js-：" class="headerlink" title="关于app.js ："></a>关于app.js ：</h3><p>这里清空onLaunch中的其他代码</p>
<img src="http://photo.wushaopei.com/qiniu587.png" width="90%">

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">onLaunch: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述 onLaunch 方法在微信小程序启动时自动进行加载。</p>
<h3 id="app-json-："><a href="#app-json-：" class="headerlink" title="app.json ："></a><strong>app.json ：</strong></h3><img src="http://photo.wushaopei.com/qiniu588.png" width="90%">

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"pages"</span>:[</span><br><span class="line">	<span class="string">"pages/index/index"</span>,</span><br><span class="line">	<span class="string">"pages/logs/logs"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"window"</span>:&#123;</span><br><span class="line">	<span class="string">"backgroundTextStyle"</span>:<span class="string">"light"</span>,</span><br><span class="line">	<span class="string">"navigationBarBackgroundColor"</span>: <span class="string">"#fff"</span>,</span><br><span class="line">	<span class="string">"navigationBarTitleText"</span>: <span class="string">"WeChat"</span>,</span><br><span class="line">	<span class="string">"navigationBarTextStyle"</span>:<span class="string">"black"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"style"</span>: <span class="string">"v2"</span>,</span><br><span class="line"><span class="string">"sitemapLocation"</span>: <span class="string">"sitemap.json"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中， pages 用于配置小程序中的页面路径，默认第一个路径为首页</p>
<p><strong>路径配置：</strong> <code>从 pages 根目录开始，再拼接页面单元名 + 页面wxml 的名称</code></p>
<h3 id="示例：创建-imooc-页面"><a href="#示例：创建-imooc-页面" class="headerlink" title="示例：创建 imooc 页面"></a><strong>示例：创建 imooc 页面</strong></h3><p>在pages 目录下创建imooc 目录，再创建 imooc page；</p>
<img src="http://photo.wushaopei.com/qiniu589.png" width="90%">

<img src="http://photo.wushaopei.com/qiniu590.png" width="90%">

<p>如上图，新创建的 page 会自动将路径添加到 app.json 的 pages 中，通过调整顺序可以将pages/imooc/imooc 作为首页进行访问；</p>
<p>效果如下：</p>
<img src="http://photo.wushaopei.com/qiniu591.png" width="90%">

<p>app.json 参数配置示例：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"pages"</span>: [<span class="string">"pages/index/index"</span>, <span class="string">"pages/logs/index"</span>],</span><br><span class="line">  <span class="string">"window"</span>: &#123;</span><br><span class="line">    <span class="string">"navigationBarTitleText"</span>: <span class="string">"Demo"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tabBar"</span>: &#123;</span><br><span class="line">    <span class="string">"list"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"pagePath"</span>: <span class="string">"pages/index/index"</span>,</span><br><span class="line">        <span class="string">"text"</span>: <span class="string">"首页"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"pagePath"</span>: <span class="string">"pages/logs/logs"</span>,</span><br><span class="line">        <span class="string">"text"</span>: <span class="string">"日志"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"networkTimeout"</span>: &#123;</span><br><span class="line">    <span class="string">"request"</span>: <span class="number">10000</span>,</span><br><span class="line">    <span class="string">"downloadFile"</span>: <span class="number">10000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"debug"</span>: <span class="literal">true</span>,&#125;</span><br></pre></td></tr></table></figure>

<h3 id="App-json-配置项列表"><a href="#App-json-配置项列表" class="headerlink" title="App.json 配置项列表"></a><strong>App.json 配置项列表</strong></h3><p>Window</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>描述</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>navigationBarBackgroundColor</td>
<td>HexColor</td>
<td>#000000</td>
<td>导航栏背景颜色，如 #000000</td>
<td></td>
</tr>
<tr>
<td>navigationBarTextStyle</td>
<td>string</td>
<td>white</td>
<td>导航栏标题颜色，仅支持 black / white</td>
<td></td>
</tr>
<tr>
<td>navigationBarTitleText</td>
<td>string</td>
<td></td>
<td>导航栏标题文字内容</td>
<td></td>
</tr>
<tr>
<td>navigationStyle</td>
<td>string</td>
<td>default</td>
<td>导航栏样式，仅支持以下值： default 默认样式 custom 自定义导航栏，只保留右上角胶囊按钮。参见注 2。</td>
<td>微信客户端 6.6.0</td>
</tr>
<tr>
<td>backgroundColor</td>
<td>HexColor</td>
<td>#ffffff</td>
<td>窗口的背景色</td>
<td></td>
</tr>
<tr>
<td>backgroundTextStyle</td>
<td>string</td>
<td>dark</td>
<td>下拉 loading 的样式，仅支持 dark / light</td>
<td></td>
</tr>
<tr>
<td>backgroundColorTop</td>
<td>string</td>
<td>#ffffff</td>
<td>顶部窗口的背景色，仅 iOS 支持</td>
<td>微信客户端 6.5.16</td>
</tr>
<tr>
<td>backgroundColorBottom</td>
<td>string</td>
<td>#ffffff</td>
<td>底部窗口的背景色，仅 iOS 支持</td>
<td>微信客户端 6.5.16</td>
</tr>
<tr>
<td>enablePullDownRefresh</td>
<td>boolean</td>
<td>false</td>
<td>是否开启全局的下拉刷新。 详见 <a href="#onpulldownrefresh">Page.onPullDownRefresh</a></td>
<td></td>
</tr>
<tr>
<td>onReachBottomDistance</td>
<td>number</td>
<td>50</td>
<td>页面上拉触底事件触发时距页面底部距离，单位为 px。 详见 <a href="#onreachbottom">Page.onReachBottom</a></td>
<td></td>
</tr>
<tr>
<td>pageOrientation</td>
<td>string</td>
<td>portrait</td>
<td>屏幕旋转设置，支持 auto / portrait / landscape  详见 <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/resizable.html" target="_blank" rel="noopener">响应显示区域变化</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.0</a> (auto) / <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.5.0</a> (landscape)</td>
</tr>
</tbody></table>
<ul>
<li>注 1：HexColor（十六进制颜色值），如”#ff00ff”</li>
<li>注 2：关于navigationStyle <ul>
<li>客户端 7.0.0 以下版本，navigationStyle 只在 app.json 中生效。</li>
<li>客户端 6.7.2 版本开始，navigationStyle: custom 对 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html" target="_blank" rel="noopener">web-view</a> 组件无效</li>
<li>开启 custom 后，低版本客户端需要做好兼容。开发者工具基础库版本切到 1.7.0（不代表最低版本，只供调试用）可方便切到旧视觉</li>
</ul>
</li>
</ul>
<p><strong>如：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"window"</span>: &#123;</span><br><span class="line">    <span class="string">"navigationBarBackgroundColor"</span>: <span class="string">"#ffffff"</span>,</span><br><span class="line">    <span class="string">"navigationBarTextStyle"</span>: <span class="string">"black"</span>,</span><br><span class="line">    <span class="string">"navigationBarTitleText"</span>: <span class="string">"微信接口功能演示"</span>,</span><br><span class="line">    <span class="string">"backgroundColor"</span>: <span class="string">"#eeeeee"</span>,</span><br><span class="line">    <span class="string">"backgroundTextStyle"</span>: <span class="string">"light"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小程序的页面布局"><a href="#小程序的页面布局" class="headerlink" title="小程序的页面布局"></a><strong>小程序的页面布局</strong></h3><img src="http://photo.wushaopei.com/qiniu592.png" width="50%">

<h3 id="tabBar"><a href="#tabBar" class="headerlink" title="tabBar"></a><strong>tabBar</strong></h3><p>如果小程序是一个多 tab 应用（客户端窗口的底部或顶部有 tab 栏可以切换页面），可以通过 tabBar 配置项指定 tab 栏的表现，以及 tab 切换时显示的对应页面。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>必填</strong></th>
<th><strong>默认值</strong></th>
<th><strong>描述</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>color</td>
<td>HexColor</td>
<td>是</td>
<td></td>
<td>tab 上的文字默认颜色，仅支持十六进制颜色</td>
<td></td>
</tr>
<tr>
<td>selectedColor</td>
<td>HexColor</td>
<td>是</td>
<td></td>
<td>tab 上的文字选中时的颜色，仅支持十六进制颜色</td>
<td></td>
</tr>
<tr>
<td>backgroundColor</td>
<td>HexColor</td>
<td>是</td>
<td></td>
<td>tab 的背景色，仅支持十六进制颜色</td>
<td></td>
</tr>
<tr>
<td>borderStyle</td>
<td>string</td>
<td>否</td>
<td>black</td>
<td>tabbar 上边框的颜色， 仅支持 black / white</td>
<td></td>
</tr>
<tr>
<td>list</td>
<td>Array</td>
<td>是</td>
<td></td>
<td>tab 的列表，详见 list 属性说明，最少 2 个、最多 5 个 tab</td>
<td></td>
</tr>
<tr>
<td>position</td>
<td>string</td>
<td>否</td>
<td>bottom</td>
<td>tabBar 的位置，仅支持 bottom / top</td>
<td></td>
</tr>
<tr>
<td>custom</td>
<td>boolean</td>
<td>否</td>
<td>false</td>
<td>自定义 tabBar，见<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/ability/custom-tabbar.html" target="_blank" rel="noopener">详情</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.5.0</a></td>
</tr>
</tbody></table>
<p>其中 list 接受一个数组，<strong>只能配置最少 2 个、最多 5 个 tab</strong>。tab 按数组的顺序排序，每个项都是一个对象，其属性值如下：</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>pagePath</td>
<td>string</td>
<td>是</td>
<td>页面路径，必须在 pages 中先定义</td>
</tr>
<tr>
<td>text</td>
<td>string</td>
<td>是</td>
<td>tab 上按钮文字</td>
</tr>
<tr>
<td>iconPath</td>
<td>string</td>
<td>否</td>
<td>图片路径，icon 大小限制为 40kb，建议尺寸为 81px * 81px，不支持网络图片。 <strong>当</strong> position <strong>为</strong> top <strong>时，不显示 icon。</strong></td>
</tr>
<tr>
<td>selectedIconPath</td>
<td>string</td>
<td>否</td>
<td>选中时的图片路径，icon 大小限制为 40kb，建议尺寸为 81px * 81px，不支持网络图片。 <strong>当</strong> position <strong>为</strong> top <strong>时，不显示 icon。</strong></td>
</tr>
</tbody></table>
<img src="http://photo.wushaopei.com/qiniu593.png" width="90%">

<h3 id="networkTimeout"><a href="#networkTimeout" class="headerlink" title="networkTimeout"></a><strong>networkTimeout</strong></h3><p>各类网络请求的超时时间，单位均为毫秒。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>必填</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>request</td>
<td>number</td>
<td>否</td>
<td>60000</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html" target="_blank" rel="noopener">wx.request</a> 的超时时间，单位：毫秒。</td>
</tr>
<tr>
<td>connectSocket</td>
<td>number</td>
<td>否</td>
<td>60000</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/websocket/wx.connectSocket.html" target="_blank" rel="noopener">wx.connectSocket</a> 的超时时间，单位：毫秒。</td>
</tr>
<tr>
<td>uploadFile</td>
<td>number</td>
<td>否</td>
<td>60000</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/upload/wx.uploadFile.html" target="_blank" rel="noopener">wx.uploadFile</a> 的超时时间，单位：毫秒。</td>
</tr>
<tr>
<td>downloadFile</td>
<td>number</td>
<td>否</td>
<td>60000</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/download/wx.downloadFile.html" target="_blank" rel="noopener">wx.downloadFile</a> 的超时时间，单位：毫秒。</td>
</tr>
</tbody></table>
<h3 id="简单数据绑定"><a href="#简单数据绑定" class="headerlink" title="简单数据绑定"></a>简单数据绑定</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--index.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;mytext&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!--Index.js：--&gt;</span><br><span class="line">Page(&#123;</span><br><span class="line">	data: &#123;</span><br><span class="line">		mytext: <span class="string">'这是第一个 demo'</span> </span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p> <strong>效果图：</strong></p>
<img src="http://photo.wushaopei.com/qiniu594.png" width="40%">

<p><strong>私有页面调用私有样式-示例：</strong></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;!<span class="selector-tag">--</span> <span class="selector-tag">Index</span><span class="selector-class">.wxss</span> <span class="selector-tag">--</span>&gt;</span><br><span class="line"><span class="selector-class">.txt-css</span> &#123;</span><br><span class="line"><span class="attribute">margin-top</span>: <span class="number">120px</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--index.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">"txt-css"</span>&gt;</span>&#123;&#123;mytext&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="wxss-样式文件的使用"><a href="#wxss-样式文件的使用" class="headerlink" title="wxss 样式文件的使用"></a>wxss 样式文件的使用</h2><h3 id="尺寸单位"><a href="#尺寸单位" class="headerlink" title="尺寸单位"></a>尺寸单位</h3><ul>
<li>rpx(responsive pixel): 可以根据屏幕宽度进行自适应。规定屏幕宽为 750px。如在Iphone6上，屏幕看宽度为375px，共有750个物理像素，则750rpx = 750物理像素，1rps = 0.5px = 1物理像素</li>
</ul>
<table>
<thead>
<tr>
<th><strong>设备</strong></th>
<th><strong>rpx换算 px（屏幕宽度/750）</strong></th>
<th><strong>px换算rpx(750/屏幕宽度)</strong></th>
</tr>
</thead>
<tbody><tr>
<td>iPhone5</td>
<td>1rpx = 0.42px</td>
<td>1px=2.34rpx</td>
</tr>
<tr>
<td>iPhone6</td>
<td>1rpx = 0.5px</td>
<td>1px = 2rpx</td>
</tr>
<tr>
<td>iPhone6 Plus</td>
<td>1rpx = 0.552px</td>
<td>1px = 1.81rpx</td>
</tr>
</tbody></table>
<p><strong>建议</strong>： 开发微信小程序时设计师可以用 iPhone6 作为视觉稿的标准</p>
<p><strong>注意</strong>：在较小的屏幕上不可避免的会有一些毛刺，请在开发时尽量避免这些情况。</p>
<h3 id="样式导入"><a href="#样式导入" class="headerlink" title="样式导入"></a><strong>样式导入</strong></h3><blockquote>
<p>使用@import 语句可以导入外联样式表， @import 后跟需要导入的外联样式表的相对路径，用 ； 表示语句结束</p>
</blockquote>
<p>示例代码：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** common.wxss **/</span></span><br><span class="line"><span class="selector-class">.small-p</span>&#123;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** app.wxss **/</span></span><br><span class="line"><span class="keyword">@import</span> “common.wxss”;</span><br><span class="line"><span class="selector-class">.middle-p</span>&#123;</span><br><span class="line"><span class="attribute">Padding</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="小程序默认加载的页面"><a href="#小程序默认加载的页面" class="headerlink" title="小程序默认加载的页面"></a>小程序默认加载的页面</h2><h3 id="小程序页面加载"><a href="#小程序页面加载" class="headerlink" title="小程序页面加载"></a>小程序页面加载</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">"pages"</span>: [</span><br><span class="line">	<span class="string">"pages/index/index"</span>,</span><br><span class="line">	<span class="string">"pages/index1/index1"</span>,</span><br><span class="line">	<span class="string">"pages/index2/index2"</span> </span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小程序默认加载 pages 中的第一个目录</p>
<p>其他目录需要通过触发才能加载</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--test.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">"txt-css txt-left"</span> <span class="attr">style</span>=<span class="string">"color:&#123;&#123;color&#125;&#125;;"</span>&gt;</span>&#123;&#123;mytext&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!--test.js--&gt;</span><br><span class="line">Page(&#123;</span><br><span class="line">	data: &#123;</span><br><span class="line">		mytext: <span class="string">'这是第一个 test页面'</span>,</span><br><span class="line">		color: <span class="string">"green"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="小程序app-的生命周期"><a href="#小程序app-的生命周期" class="headerlink" title="小程序app 的生命周期"></a>小程序app 的生命周期</h2><h3 id="Page-Object-object"><a href="#Page-Object-object" class="headerlink" title="Page(Object object)"></a><strong>Page(Object object)</strong></h3><blockquote>
<p>注册小程序中的一个页面。接受一个 Object 类型参数，其指定页面的初始数据、生命周期回调、事件处理函数等。</p>
</blockquote>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a><strong>参数</strong></h3><h4 id="Object-object"><a href="#Object-object" class="headerlink" title="Object object"></a><strong>Object object</strong></h4><table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><a href="#data">data</a></td>
<td>Object</td>
<td></td>
<td></td>
<td>页面的初始数据</td>
</tr>
<tr>
<td><a href="#onLoad-Object-query">onLoad</a></td>
<td>function</td>
<td></td>
<td></td>
<td>生命周期回调—监听页面加载</td>
</tr>
<tr>
<td><a href="#onShow">onShow</a></td>
<td>function</td>
<td></td>
<td></td>
<td>生命周期回调—监听页面显示</td>
</tr>
<tr>
<td><a href="#onReady">onReady</a></td>
<td>function</td>
<td></td>
<td></td>
<td>生命周期回调—监听页面初次渲染完成</td>
</tr>
<tr>
<td><a href="#onHide">onHide</a></td>
<td>function</td>
<td></td>
<td></td>
<td>生命周期回调—监听页面隐藏</td>
</tr>
<tr>
<td><a href="#onUnload">onUnload</a></td>
<td>function</td>
<td></td>
<td></td>
<td>生命周期回调—监听页面卸载</td>
</tr>
<tr>
<td><a href="#onPullDownRefresh">onPullDownRefresh</a></td>
<td>function</td>
<td></td>
<td></td>
<td>监听用户下拉动作</td>
</tr>
<tr>
<td><a href="#onReachBottom">onReachBottom</a></td>
<td>function</td>
<td></td>
<td></td>
<td>页面上拉触底事件的处理函数</td>
</tr>
<tr>
<td><a href="#onShareAppMessage-Object-object">onShareAppMessage</a></td>
<td>function</td>
<td></td>
<td></td>
<td>用户点击右上角转发</td>
</tr>
<tr>
<td><a href="#onPageScroll-Object-object">onPageScroll</a></td>
<td>function</td>
<td></td>
<td></td>
<td>页面滚动触发事件的处理函数</td>
</tr>
<tr>
<td><a href="#onResize-Object-object">onResize</a></td>
<td>function</td>
<td></td>
<td></td>
<td>页面尺寸改变时触发，详见 <a href="#%E5%9C%A8%E6%89%8B%E6%9C%BA%E4%B8%8A%E5%90%AF%E7%94%A8%E5%B1%8F%E5%B9%95%E6%97%8B%E8%BD%AC%E6%94%AF%E6%8C%81">响应显示区域变化</a></td>
</tr>
<tr>
<td><a href="#onTabItemTap-Object-object">onTabItemTap</a></td>
<td>function</td>
<td></td>
<td></td>
<td>当前是 tab 页时，点击 tab 时触发</td>
</tr>
<tr>
<td>其他</td>
<td>any</td>
<td></td>
<td></td>
<td>开发者可以添加任意的函数或数据到 Object 参数中，在页面的函数中用 this 可以访问</td>
</tr>
</tbody></table>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.jsPage(&#123;</span></span><br><span class="line">  data: &#123;</span><br><span class="line">    text: <span class="string">"This is page data."</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do some initialize when page load.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onShow: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when page show.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onReady: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when page ready.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onHide: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when page hide.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onUnload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when page close.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onPullDownRefresh: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when pull down.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onReachBottom: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when page reach bottom.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onShareAppMessage: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// return custom share data when user share.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onPageScroll: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when page scroll</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onResize: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when page resize</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onTabItemTap(item) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(item.index)</span><br><span class="line">    <span class="built_in">console</span>.log(item.pagePath)</span><br><span class="line">    <span class="built_in">console</span>.log(item.text)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// Event handler.</span></span><br><span class="line">  viewTap: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      text: <span class="string">'Set some data for updating view.'</span></span><br><span class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this is setData callback</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  customData: &#123;</span><br><span class="line">    hi: <span class="string">'MINA'</span></span><br><span class="line">  &#125;&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>onLaunch 当我们第一次打开 app 时会进行初始化，第一次初始化，该 onLaunch 事件会被触发，它只会被调用一次</li>
<li>onShow onShow随着第一次 onLaunch 时候一起被触发，on Show 指小程序被打开到前台会展现</li>
<li>onHide 指小程序从前台到后台的转变，隐藏到后台去的时候就会触发 on Hide 事件（e.g 双击home 点进其他程序时）</li>
<li>onError 当小程序出现一些错误的时候，会在这里跑出来；对错误时做出处理，与 java 中 exception 很像</li>
<li>其他 web开发者可以自行定义（全都是全局）</li>
</ul>
<h3 id="示例：将全局变量赋值给页面参数："><a href="#示例：将全局变量赋值给页面参数：" class="headerlink" title="示例：将全局变量赋值给页面参数："></a>示例：将全局变量赋值给页面参数：</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line">App(&#123;</span><br><span class="line">	onLaunch: <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"触发onLaunch"</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	onShow: <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"触发onShow"</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	onHide: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log()</span><br><span class="line">	&#125;,</span><br><span class="line">	onError: <span class="function"><span class="keyword">function</span> (<span class="params">msg</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(msg)</span><br><span class="line">	&#125;,</span><br><span class="line">	globalData: <span class="string">'I am global data'</span>,</span><br><span class="line">	courseName: <span class="string">"小程序实战"</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>test.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">	data: &#123;</span><br><span class="line">		mytext: <span class="string">'这是第一个 test页面'</span>,</span><br><span class="line">		color: <span class="string">"green"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	onLoad:<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="comment">// other.js</span></span><br><span class="line">		<span class="keyword">var</span> appInstance = getApp()</span><br><span class="line">		<span class="built_in">console</span>.log(appInstance.courseName) <span class="comment">// I am global data</span></span><br><span class="line">		<span class="keyword">this</span>.setData(&#123;</span><br><span class="line">			mytext: appInstance.courseName</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>test.wxml</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--index.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">"txt-css txt-left"</span> <span class="attr">style</span>=<span class="string">"color:&#123;&#123;color&#125;&#125;;"</span>&gt;</span>&#123;&#123;mytext&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>效果：</strong></p>
<img src="http://photo.wushaopei.com/qiniu595.png" width="40%">

<h3 id="data"><a href="#data" class="headerlink" title="data"></a><strong>data</strong></h3><blockquote>
<p>data 是页面第一次渲染使用的<strong>初始数据</strong>。</p>
</blockquote>
<p>​    页面加载时，data 将会以JSON字符串的形式由逻辑层传至渲染层，因此data中的数据必须是可以转成JSON的类型：字符串，数字，布尔值，对象，数组。</p>
<p>​    渲染层可以通过 <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/index.html" target="_blank" rel="noopener">WXML</a> 对数据进行绑定。</p>
<h3 id="示例代码："><a href="#示例代码：" class="headerlink" title="示例代码："></a><strong>示例代码：</strong></h3><p><a href="https://developers.weixin.qq.com/s/2PeBsKmn6EZ9" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;text&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;array[0].msg&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    text: <span class="string">'init data'</span>,</span><br><span class="line">    array: [&#123;<span class="attr">msg</span>: <span class="string">'1'</span>&#125;, &#123;<span class="attr">msg</span>: <span class="string">'2'</span>&#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="小程序中如何调试js-文件"><a href="#小程序中如何调试js-文件" class="headerlink" title="小程序中如何调试js 文件"></a>小程序中如何调试js 文件</h2><h3 id="创建-my-debug-demo"><a href="#创建-my-debug-demo" class="headerlink" title="创建 my-debug-demo"></a>创建 my-debug-demo</h3><img src="http://photo.wushaopei.com/qiniu596.png" width="40%">

<p><strong>使用debugger语句设置断点</strong></p>
<img src="http://photo.wushaopei.com/qiniu597.png" width="100%">

<blockquote>
<p>F8 下一步</p>
<p>F10 下一个断点</p>
</blockquote>
<hr>
<h2 id="私有页面的生命周期以及导航"><a href="#私有页面的生命周期以及导航" class="headerlink" title="私有页面的生命周期以及导航"></a>私有页面的生命周期以及导航</h2><h3 id="生命周期回调函数"><a href="#生命周期回调函数" class="headerlink" title="生命周期回调函数"></a><strong>生命周期回调函数</strong></h3><blockquote>
<p>生命周期的触发以及页面的路由方式<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/route.html" target="_blank" rel="noopener">详见</a>,</p>
</blockquote>
<p><strong>onLoad(Object query)</strong></p>
<blockquote>
<p>页面加载时触发。一个页面只会调用一次，可以在 onLoad 的参数中获取打开当前页面路径中的参数。man’;color:rgb”1_F ^</p>
</blockquote>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>类型</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>query</td>
<td>Object</td>
<td align="left">打开当前页面路径中的参数</td>
</tr>
</tbody></table>
<p><strong>onShow()</strong></p>
<p>页面显示/切入前台时触发。</p>
<p><strong>onReady()</strong></p>
<p>页面初次渲染完成时触发。一个页面只会调用一次，代表页面已经准备妥当，可以和视图层进行交互。</p>
<p>注意：对界面内容进行设置的 API 如<a href="https://developers.weixin.qq.com/miniprogram/dev/api/ui/navigation-bar/wx.setNavigationBarTitle.html" target="_blank" rel="noopener">wx.setNavigationBarTitle</a>，请在onReady之后进行。详见<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/page-life-cycle.html" target="_blank" rel="noopener">生命周期</a></p>
<p><strong>onHide()</strong></p>
<p>页面隐藏/切入后台时触发。 如 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateTo.html" target="_blank" rel="noopener">wx.navigateTo</a> 或底部 tab 切换到其他页面，小程序切入后台等。</p>
<p><strong>onUnload()</strong></p>
<p>页面卸载时触发。如<a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.redirectTo.html" target="_blank" rel="noopener">wx.redirectTo</a>或<a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateBack.html" target="_blank" rel="noopener">wx.navigateBack</a>到其他页面时。</p>
<h3 id="示例：页面跳转"><a href="#示例：页面跳转" class="headerlink" title="示例：页面跳转"></a>示例：页面跳转</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--index.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">"txt-css txt-left"</span> <span class="attr">style</span>=<span class="string">"color:&#123;&#123;color&#125;&#125;;"</span> <span class="attr">bindtap</span>=<span class="string">"clickMe"</span>&gt;</span>&#123;&#123;mytext&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!--index.js--&gt;</span><br><span class="line">clickMe: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	wx.navigateTo(&#123;</span><br><span class="line">		url: <span class="string">"../imooc/imooc"</span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu598.png" width="90%">

<p><strong>注意</strong>： 使用 navigateTo进行页面间的跳转，必须去掉 tarbar 才能进行页面之间的跳转</p>
<img src="http://photo.wushaopei.com/qiniu599.png" width="60%">

<p><strong>使用 wx.redirectTo进行页面跳转</strong></p>
<img src="http://photo.wushaopei.com/qiniu600.png" width="100%">

<p><strong>小结：</strong></p>
<blockquote>
<p>点击事件： bindtap</p>
<p>onLoad：监听页面加载</p>
<p>onReady:监听页面楚辞渲染完成</p>
<p>onShow: 监听页面显示</p>
<p>onHide: 监听页面隐藏 </p>
<p>onUnload: 监听页面卸载</p>
<p>Wx.navigatoT: 隐藏页面，并没有关闭，触发onHide事件</p>
<p>Wx.redirectTo： 卸载页面，关闭了，触发onUnload 事件</p>
</blockquote>
<hr>
<h2 id="小程序的事件"><a href="#小程序的事件" class="headerlink" title="小程序的事件"></a>小程序的事件</h2><blockquote>
<p>通过行为进行的人机交互方式</p>
<p>类似于 html 里的onClick ，onChange 事件等等</p>
</blockquote>
<h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p><strong>什么是事件</strong>？</p>
<ul>
<li>事件是视图层到逻辑层的通讯方式</li>
<li>事件可以将用户的行为反馈到逻辑层进行处理</li>
<li>事件可以绑定在组件上，当达到触发条件，就会执行逻辑层中对应的事件处理函数。</li>
<li>事件对象可以携带额外信息，如 id , dataset , touches.</li>
</ul>
<p><strong>事件的使用方式</strong></p>
<ul>
<li>在组件中绑定一个事件处理函数</li>
</ul>
<blockquote>
<p>如 bindtap，当用户点击该组件的时候会在该页面对应的 Page 中找到相应的事件处理函数。e</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"tapTest"</span> <span class="attr">bindtap</span>=<span class="string">"clickMe"</span>&gt;</span>Click Me!<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在相应的 Page 定义中写上相应的事件处理函数，参数是 e。</p>
<h3 id="自定义-——-触发点击事件："><a href="#自定义-——-触发点击事件：" class="headerlink" title="自定义  —— 触发点击事件："></a>自定义  —— 触发点击事件：</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!-- Events.js --&gt;</span><br><span class="line">clickMe: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"被点击事件触发"</span>);</span><br><span class="line">	<span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>点击效果：</strong></p>
<img src="http://photo.wushaopei.com/qiniu601.png" width="90%">

<ul>
<li>可以看到 log 出来的信息大致如下：</li>
</ul>
<img src="http://photo.wushaopei.com/qiniu602.png" width="90%">

<p><strong>添加更多的参数后：</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"tapTest"</span> <span class="attr">data-customData</span>=<span class="string">"我们自定义的数据"</span> <span class="attr">data-customName</span>=<span class="string">"green arrow"</span> <span class="attr">data-sex</span>=<span class="string">"男"</span> <span class="attr">bindtap</span>=<span class="string">"clickMe"</span>&gt;</span>Click Me!<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="事件详解"><a href="#事件详解" class="headerlink" title="事件详解"></a><strong>事件详解</strong></h3><p>事件分类</p>
<p>事件分为冒泡事件和非冒泡事件：</p>
<ol>
<li><p>冒泡事件：当一个组件上的事件被触发后，该事件会向父节点传递</p>
</li>
<li><p>非冒泡事件：当一个组件上的事件被触发后，该事件不会向父节点传递</p>
</li>
</ol>
<p>WXML的冒泡事件列表：</p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>触发条件</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Touchstart</td>
<td>手指触摸动作开始</td>
</tr>
<tr>
<td>Touchmove</td>
<td>手指触摸后移动</td>
</tr>
<tr>
<td>Touchcancel</td>
<td>手指触摸动作被打断，如来电提醒，弹窗</td>
</tr>
<tr>
<td>tap</td>
<td>手指触摸后马上离开</td>
</tr>
<tr>
<td>Longpress</td>
<td>手指触摸后，超过 350ms再离开，如果指定了事件回调函数并触发了这个事件，tap事件将不被触发</td>
</tr>
<tr>
<td>Longtap</td>
<td>手指触摸后，超过350 ms 再离开（推荐使用 longpress 事件代替）</td>
</tr>
<tr>
<td>Transitionend</td>
<td>会在 WXSS transition 或 wx.createAnimation 动画结束后触发</td>
</tr>
<tr>
<td>Animationstart</td>
<td>会在一个 WXSS animation 动画开始时触发</td>
</tr>
<tr>
<td>Animationiteration</td>
<td>会在一个 WXSS animation 一次迭代结束时触发</td>
</tr>
<tr>
<td>Animationend</td>
<td>会在一个 WXSS animation 动画完成时触发</td>
</tr>
<tr>
<td>Touchforcechange</td>
<td>在支持 3D Touch 的iPhone 设备，重按时会触发</td>
</tr>
</tbody></table>
<p>注： 除上表之外的其他组件自定义事件如无特殊声明都是非冒泡事件，如 <code>&lt;form/&gt;</code> 的 submit 事件，<code>&lt;input/&gt;</code>的input事件，<code>&lt;scroll-view/&gt;</code>的scroll 事件.</p>
<hr>
<h2 id="小程序抽离公用方法进行模块化"><a href="#小程序抽离公用方法进行模块化" class="headerlink" title="小程序抽离公用方法进行模块化."></a>小程序抽离公用方法进行模块化.</h2><ul>
<li>抽离通用方法作为通用函数</li>
<li>构建utils-common 类</li>
</ul>
<h3 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h3><p>​    可以将一些公共的代码抽离成为一个单独的 js 文件，作为一个模块，模块只用通过 module.exports 或者 exports 才能对外暴露接口</p>
<p><strong>需要注意的是：</strong></p>
<ul>
<li>exports 是 module.exports 的一个引用，因此在模块里边随意更改 exports 的指向会造成未知的错误。所以更推荐开发者采用module.exports 来暴露模块接口，除非你已经清晰知道这两者的关系。</li>
<li>小程序目前不支持直接引入 node_modules ，开发者需要使用到 node_modules 时候建议拷贝出相关的代码到小程序的代码当中</li>
</ul>
<h3 id="any-require-string-path"><a href="#any-require-string-path" class="headerlink" title="any require(string path)"></a><strong>any require(string path)</strong></h3><p>引入模块。返回模块通过 <a href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/module.html" target="_blank" rel="noopener">module.exports</a> 或 exports 暴露的接口。</p>
<h3 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a><strong>参数</strong></h3><table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>path</td>
<td>string</td>
<td>需要引入模块文件相对于当前文件的相对路径，或npm模块名，或npm模块路径。不支持绝对路径</td>
</tr>
</tbody></table>
<h4 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'Hello '</span> + name + <span class="string">' !'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayGoodbye</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Goodbye <span class="subst">$&#123;name&#125;</span> !`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.sayHello = sayHello</span><br><span class="line">exports.sayGoodbye = sayGoodbye</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.sayHello = sayHello</span><br><span class="line">exports.sayGoodbye = sayGoodbye</span><br></pre></td></tr></table></figure>

<p>在需要使用这些模块的文件中，使用 require(path) 将公共代码引入s</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/events/events.js</span></span><br><span class="line"><span class="keyword">var</span> common = <span class="built_in">require</span>(<span class="string">'../utils/common.js'</span>);</span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    clickMe: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"被点击事件触发"</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sex = e.currentTarget.dataset.sex;</span><br><span class="line">        <span class="keyword">var</span> customdata = e.currentTarget.dataset.customdata;</span><br><span class="line">        <span class="keyword">var</span> customname = e.currentTarget.dataset.customname;</span><br><span class="line">        <span class="built_in">console</span>.log(sex + <span class="string">"-- currentTarget"</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(customdata + <span class="string">"-- currentTarget"</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(customname + <span class="string">"-- currentTarget"</span>);</span><br><span class="line"></span><br><span class="line">        common.sayHello(<span class="string">"lee"</span>);</span><br><span class="line">        common.sayGoodbye(<span class="string">"imooc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>点击 clickMe 的效果：</p>
<img src="http://photo.wushaopei.com/qiniu603.png" width="90%">

<p><strong>Tips</strong></p>
<ol>
<li>Tip: require 暂时不支持绝对路径</li>
</ol>
<h3 id="Object-module"><a href="#Object-module" class="headerlink" title="Object module"></a><strong>Object module</strong></h3><p>当前模块对象</p>
<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a><strong>属性</strong></h4><table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>exports</td>
<td>Object</td>
<td>模块向外暴露的对象，使用require引用该模块时可以获取</td>
</tr>
</tbody></table>
<h4 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Hello <span class="subst">$&#123;name&#125;</span> !`</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayGoodbye</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Goodbye <span class="subst">$&#123;name&#125;</span> !`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.sayHello = sayHello</span><br><span class="line">exports.sayGoodbye = sayGoodbye</span><br></pre></td></tr></table></figure>

<h3 id="Object-exports"><a href="#Object-exports" class="headerlink" title="Object exports"></a><strong>Object exports</strong></h3><p>module.exports 的引用</p>
<h4 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Hello <span class="subst">$&#123;name&#125;</span> !`</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayGoodbye</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Goodbye <span class="subst">$&#123;name&#125;</span> !`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.sayHello = sayHello</span><br><span class="line">exports.sayGoodbye = sayGoodbye</span><br></pre></td></tr></table></figure>



<h2 id="视图层-细说数据绑定"><a href="#视图层-细说数据绑定" class="headerlink" title="视图层 - 细说数据绑定"></a>视图层 - 细说数据绑定</h2><ul>
<li>JQuery dom 操作 $ 选择器e</li>
<li>微信小程序是通过数据绑定vue/reactspan&gt;</li>
<li>*.js 中通过 data 对象与 *.wxml 的元素绑定  -&gt; Mustache 表达式语法</li>
</ul>
<h3 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h3><p>WXML 中的动态数据均来自对应 Page 的 data。</p>
<h4 id="简单绑定"><a href="#简单绑定" class="headerlink" title="简单绑定"></a><strong>简单绑定</strong></h4><p>数据绑定使用 Mustache 语法（双大括号）将变量包起来，可以作用于：</p>
<h5 id="内容"><a href="#内容" class="headerlink" title="内容"></a><strong>内容</strong></h5><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/dataBind/dataBind.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; pages&#x2F;dataBind&#x2F;dataBind.js</span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line">* 页面的初始数据</span><br><span class="line">*&#x2F;</span><br><span class="line">data: &#123;</span><br><span class="line">	msg: &quot;这是一个 msg&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu610.png" width="90%">

<h4 id="组件属性-需要在双引号之内"><a href="#组件属性-需要在双引号之内" class="headerlink" title="组件属性(需要在双引号之内)"></a><strong>组件属性(需要在双引号之内)</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"item-&#123;&#123;testId&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">   testId : “<span class="number">1001</span>”</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu611.png" width="90%">

<h4 id="控制属性-需要在双引号之内"><a href="#控制属性-需要在双引号之内" class="headerlink" title="控制属性(需要在双引号之内)"></a><strong>控制属性(需要在双引号之内)</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;condition&#125;&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    condition: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="关键字-需要在双引号之内"><a href="#关键字-需要在双引号之内" class="headerlink" title="关键字(需要在双引号之内)"></a><strong>关键字(需要在双引号之内)</strong></h4><blockquote>
<p>true：boolean 类型的 true，代表真值。</p>
<p>false： boolean 类型的 false，代表假值。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;false&#125;&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>特别注意：不要直接写</strong> checked=”false”<strong>，其计算结果是一个字符串，转成 boolean 类型后代表真值。</strong></p>
<h4 id="三元运算"><a href="#三元运算" class="headerlink" title="三元运算"></a><strong>三元运算</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">hidden</span>=<span class="string">"&#123;&#123;flag ? true : false&#125;&#125;"</span>&gt;</span> Hidden <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="算数运算"><a href="#算数运算" class="headerlink" title="算数运算"></a><strong>算数运算</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span> &#123;&#123;a + b&#125;&#125; + &#123;&#123;c&#125;&#125; + d <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: <span class="number">2</span>,</span><br><span class="line">    c: <span class="number">3</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>view中的内容为 3 + 3 + d。</strong></p>
</blockquote>
<h4 id="逻辑判断"><a href="#逻辑判断" class="headerlink" title="逻辑判断"></a><strong>逻辑判断</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;length &gt; 5&#125;&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="字符串运算"><a href="#字符串运算" class="headerlink" title="字符串运算"></a><strong>字符串运算</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;"hello" + name&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data:&#123;</span><br><span class="line">    name: <span class="string">'MINA'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="数据路径运算"><a href="#数据路径运算" class="headerlink" title="数据路径运算"></a><strong>数据路径运算</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;object.key&#125;&#125; &#123;&#123;array[0]&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    object: &#123;</span><br><span class="line">      key: <span class="string">'Hello '</span></span><br><span class="line">    &#125;,</span><br><span class="line">    array: [<span class="string">'MINA'</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="组合"><a href="#组合" class="headerlink" title="组合"></a><strong>组合</strong></h3><ul>
<li>也可以在 Mustache 内直接进行组合，构成新的对象或者数组。</li>
</ul>
<h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a><strong>数组</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[zero, 1, 2, 3, 4]&#125;&#125;"</span>&gt;</span> &#123;&#123;item&#125;&#125; <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    zero: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p> <strong>最终组合成数组[0, 1, 2, 3, 4]。</strong> </p>
</blockquote>
<h4 id="对象"><a href="#对象" class="headerlink" title="对象"></a><strong>对象</strong></h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"objectCombine"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;for: a, bar: b&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>最终组合成的对象是 {for: 1, bar: 2} ;</p>
</blockquote>
<p>也可以用扩展运算符 … 来将一个对象展开</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"objectCombine"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;...obj1, ...obj2, e: 5&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    obj1: &#123;</span><br><span class="line">      a: <span class="number">1</span>,</span><br><span class="line">      b: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    obj2: &#123;</span><br><span class="line">      c: <span class="number">3</span>,</span><br><span class="line">      d: <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>最终组合成的对象是 {a: 1, b: 2, c: 3, d: 4, e: 5}。</p>
</blockquote>
<p>如果对象的 key 和 value 相同，也可以间接地表达。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"objectCombine"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;foo, bar&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    foo: <span class="string">'my-foo'</span>,</span><br><span class="line">    bar: <span class="string">'my-bar'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>最终组合成的对象是 {foo: ‘my-foo’, bar:’my-bar’}。</p>
<p><strong>注意</strong>：上述方式可以随意组合，但是如有存在变量名相同的情况，后边的会覆盖前面，如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"objectCombine"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;...obj1, ...obj2, a, c: 6&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    obj1: &#123;</span><br><span class="line">      a: <span class="number">1</span>,</span><br><span class="line">      b: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    obj2: &#123;</span><br><span class="line">      b: <span class="number">3</span>,</span><br><span class="line">      c: <span class="number">4</span></span><br><span class="line">    &#125;,</span><br><span class="line">    a: <span class="number">5</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>最终组合成的对象是 {a: 5, b: 3, c: 6}。</p>
<p><strong>注意：</strong> 花括号和引号之间如果有空格，将最终被解析成为字符串</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[1,2,3]&#125;&#125; "</span>&gt;</span> &#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>等同于</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[1,2,3] + ' '&#125;&#125;"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="视图层-细说列表渲染"><a href="#视图层-细说列表渲染" class="headerlink" title="视图层 - 细说列表渲染"></a>视图层 - 细说列表渲染</h2><ul>
<li>for 循环</li>
<li><code>&lt;view wx:for&gt;</code></li>
<li><code>&lt;block wx:for&gt;</code></li>
</ul>
<h3 id="wx-for"><a href="#wx-for" class="headerlink" title="wx:for"></a><strong>wx:for</strong></h3><p>在组件上使用 wx:for 控制属性绑定一个数组，即可使用数组中各项的数据重复渲染该组件。</p>
<p>默认数组的当前项的下标变量名默认为 index，数组当前项的变量名默认为 item</p>
<p>使用 wx:for-item 可以指定数组当前元素的变量名，</p>
<p>使用 wx:for-index 可以指定数组当前下标的变量名：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/listFor/listFor.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;users&#125;&#125;"</span>&gt;</span></span><br><span class="line">		下标：&#123;&#123;index&#125;&#125;, 姓名： &#123;&#123;item.name&#125;&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;users&#125;&#125;"</span> <span class="attr">wx:for-index</span>=<span class="string">"num"</span> <span class="attr">wx:for-item</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">		下标： &#123;&#123;num&#125;&#125; ,姓名： &#123;&#123;user.name&#125;&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">data: &#123;</span><br><span class="line">	users:[</span><br><span class="line">		&#123;<span class="attr">name</span>: <span class="string">"jack"</span>&#125;,</span><br><span class="line">		&#123;<span class="attr">name</span>: <span class="string">"rose"</span>&#125;,</span><br><span class="line">		&#123;<span class="attr">name</span>: <span class="string">"lili"</span>&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu612.png" width="90%">

<p>wx:for 也可以嵌套，下边是一个九九乘法表</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[1, 2, 3, 4, 5, 6, 7, 8, 9]&#125;&#125;"</span> <span class="attr">wx:for-item</span>=<span class="string">"i"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[1, 2, 3, 4, 5, 6, 7, 8, 9]&#125;&#125;"</span> <span class="attr">wx:for-item</span>=<span class="string">"j"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;i &lt;= j&#125;&#125;"</span>&gt;</span></span><br><span class="line">      &#123;&#123;i&#125;&#125; * &#123;&#123;j&#125;&#125; = &#123;&#123;i * j&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="block-wx-for"><a href="#block-wx-for" class="headerlink" title="block wx:for"></a><strong>block wx:for</strong></h3><p>类似 block wx:if，也可以将 wx:for 用在  <code>&lt;block/&gt;</code>  标签上，以渲染一个包含多节点的结构块。例如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;users&#125;&#125;"</span>&gt;</span>  </span><br><span class="line">	下标：&#123;&#123;index&#125;&#125;, 姓名： &#123;&#123;item.name&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu613.png" width="90%">



<h2 id="视图层-wx-key-列表高级特性"><a href="#视图层-wx-key-列表高级特性" class="headerlink" title="视图层 - wx: key 列表高级特性"></a>视图层 - wx: key 列表高级特性</h2><ul>
<li>对于列表中的状态，页面里经常会动态的加载数据，加载数据后，原数据状态会漂移，此时可以利用 wx:key 保证我们的状态值不变</li>
</ul>
<h3 id="wx-key"><a href="#wx-key" class="headerlink" title="wx:key"></a><strong>wx:key</strong></h3><p>如果列表中项目的位置会动态改变或者有新的项目添加到列表中，并且希望列表中的项目保持自己的特征和状态（如 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/input.html" target="_blank" rel="noopener">input</a> 中的输入内容，<a href="https://developers.weixin.qq.com/miniprogram/dev/component/switch.html" target="_blank" rel="noopener">switch</a> 的选中状态），需要使用 wx:key 来指定列表中项目的唯一的标识符。</p>
<p><strong>wx:key</strong> 的值以两种形式提供:</p>
<ol>
<li>字符串，代表在 for 循环的 array 中 item 的某个 property，该 property 的值需要是列表中唯一的字符串或数字，且不能动态改变。</li>
<li>保留关键字 *this 代表在 for 循环中的 item 本身，这种表示需要 item 本身是一个唯一的字符串或者数字。</li>
</ol>
<p>当数据改变触发渲染层重新渲染的时候，会校正带有 key 的组件，框架会确保他们被重新排序，而不是重新创建，以确保使组件保持自身的状态，并且提高列表渲染时的效率。</p>
<p><strong>如不提供</strong> wx:key<strong>，会报一个</strong> warning<strong>， 如果明确知道该列表是静态，或者不必关注其顺序，可以选择忽略。</strong></p>
<p><strong>示例代码：</strong></p>
<p><a href="https://developers.weixin.qq.com/s/tpg5tKmv6kZt" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;objectArray&#125;&#125;"</span> <span class="attr">wx:key</span>=<span class="string">"unique"</span> <span class="attr">style</span>=<span class="string">"display: block;"</span>&gt;</span> &#123;&#123;item.id&#125;&#125; <span class="tag">&lt;/<span class="name">switch</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">bindtap</span>=<span class="string">"switch"</span>&gt;</span> Switch <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">bindtap</span>=<span class="string">"addToFront"</span>&gt;</span> Add to the front <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;numberArray&#125;&#125;"</span> <span class="attr">wx:key</span>=<span class="string">"*this"</span> <span class="attr">style</span>=<span class="string">"display: block;"</span>&gt;</span> &#123;&#123;item&#125;&#125; <span class="tag">&lt;/<span class="name">switch</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">bindtap</span>=<span class="string">"addNumberToFront"</span>&gt;</span> Add to the front <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    objectArray: [</span><br><span class="line">      &#123;<span class="attr">id</span>: <span class="number">5</span>, <span class="attr">unique</span>: <span class="string">'unique_5'</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">id</span>: <span class="number">4</span>, <span class="attr">unique</span>: <span class="string">'unique_4'</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">unique</span>: <span class="string">'unique_3'</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">unique</span>: <span class="string">'unique_2'</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">unique</span>: <span class="string">'unique_1'</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">id</span>: <span class="number">0</span>, <span class="attr">unique</span>: <span class="string">'unique_0'</span>&#125;,</span><br><span class="line">    ],</span><br><span class="line">    numberArray: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">switch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> length = <span class="keyword">this</span>.data.objectArray.length</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">      <span class="keyword">const</span> x = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * length)</span><br><span class="line">      <span class="keyword">const</span> y = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * length)</span><br><span class="line">      <span class="keyword">const</span> temp = <span class="keyword">this</span>.data.objectArray[x]</span><br><span class="line">      <span class="keyword">this</span>.data.objectArray[x] = <span class="keyword">this</span>.data.objectArray[y]</span><br><span class="line">      <span class="keyword">this</span>.data.objectArray[y] = temp</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      objectArray: <span class="keyword">this</span>.data.objectArray</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  addToFront: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> length = <span class="keyword">this</span>.data.objectArray.length</span><br><span class="line">    <span class="keyword">this</span>.data.objectArray = [&#123;<span class="attr">id</span>: length, <span class="attr">unique</span>: <span class="string">'unique_'</span> + length&#125;].concat(<span class="keyword">this</span>.data.objectArray)</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      objectArray: <span class="keyword">this</span>.data.objectArray</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  addNumberToFront: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.data.numberArray = [ <span class="keyword">this</span>.data.numberArray.length + <span class="number">1</span> ].concat(<span class="keyword">this</span>.data.numberArray)</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      numberArray: <span class="keyword">this</span>.data.numberArray</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a><strong>注意：</strong></h4><p>当 wx:for 的值为字符串时，会将字符串解析成字符串数组</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"array"</span>&gt;</span></span><br><span class="line">  &#123;&#123;item&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>等同于</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;['a','r','r','a','y']&#125;&#125;"</span>&gt;</span></span><br><span class="line">  &#123;&#123;item&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 花括号和引号之间如果有空格，将最终被解析成为字符串</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[1,2,3]&#125;&#125; "</span>&gt;</span></span><br><span class="line">  &#123;&#123;item&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>等同于</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[1,2,3] + ' '&#125;&#125;"</span> &gt;</span></span><br><span class="line">  &#123;&#123;item&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="视图层-细说条件渲染与条件懒加载模式"><a href="#视图层-细说条件渲染与条件懒加载模式" class="headerlink" title="视图层 - 细说条件渲染与条件懒加载模式"></a>视图层 - 细说条件渲染与条件懒加载模式</h2><h3 id="视图层-细说条件渲染"><a href="#视图层-细说条件渲染" class="headerlink" title="视图层 - 细说条件渲染"></a>视图层 - 细说条件渲染</h3><ul>
<li>Java if jstl  c:if</li>
<li><code>&lt;view wx:if=””&gt;</code></li>
<li><code>&lt;block wx:if=””&gt;</code></li>
</ul>
<h3 id="wx-if"><a href="#wx-if" class="headerlink" title="wx:if"></a><strong>wx:if</strong></h3><p>在框架中，使用 wx:if=”” 来判断是否需要渲染该代码块：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;condition&#125;&#125;"</span>&gt;</span> True <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以用 wx:elif 和 wx:else 来添加一个 else 块：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;length &gt; 5&#125;&#125;"</span>&gt;</span> 1 <span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:elif</span>=<span class="string">"&#123;&#123;length &gt; 2&#125;&#125;"</span>&gt;</span> 2 <span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span>&gt;</span> 3 <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="block-wx-if"><a href="#block-wx-if" class="headerlink" title="block wx:if"></a><strong>block wx:if</strong></h3><p>因为 wx:if 是一个控制属性，需要将它添加到一个标签上。如果要一次性判断多个组件标签，可以使用一个<code>&lt;block/&gt;</code>标签将多个组件包装起来，并在上边使用 wx:if 控制属性。 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span> view1 <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span> view2 <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong><code>&lt;block/&gt;</code> 并不是一个组件，它仅仅是一个包装元素，不会在页面中做任何渲染，只接受控制属性。</p>
<h3 id="wx-if-vs-hidden"><a href="#wx-if-vs-hidden" class="headerlink" title="wx:if vs hidden"></a>wx:if <strong>vs</strong> hidden</h3><p>因为 wx:if 之中的模板也可能包含数据绑定，所以当 wx:if 的条件值切换时，框架有一个局部渲染的过程，因为它会确保条件块在切换时销毁或重新渲染。</p>
<p>同时 wx:if 也是<strong>惰性的</strong>，如果在初始渲染条件为 false，框架什么也不做，在条件第一次变成真的时候才开始局部渲染。</p>
<p>相比之下，hidden 就简单的多，组件始终会被渲染，只是简单的控制显示与隐藏。</p>
<p>一般来说，wx:if 有更高的切换消耗而 hidden 有更高的初始渲染消耗。因此，如果需要频繁切换的情景下，用 hidden 更好，如果在运行时条件不大可能改变则 wx:if 较好。</p>
<h2 id="小程序页面通用模板的使用"><a href="#小程序页面通用模板的使用" class="headerlink" title="小程序页面通用模板的使用"></a>小程序页面通用模板的使用</h2><h3 id="为页面定义通用模板"><a href="#为页面定义通用模板" class="headerlink" title="为页面定义通用模板"></a>为页面定义通用模板</h3><ul>
<li><code>&lt;template name=”[templateName]”&gt;</code></li>
<li>引用模板 is= “[templateName]”</li>
<li>传入参数 data=</li>
</ul>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a><strong>模板</strong></h3><p>WXML提供模板（template），可以在模板中定义代码片段，然后在不同的地方调用。</p>
<h4 id="定义模板"><a href="#定义模板" class="headerlink" title="定义模板"></a><strong>定义模板</strong></h4><p>使用 name 属性，作为模板的名字。然后在<code>&lt;template/&gt;</code>内定义代码片段，如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  index: int</span></span><br><span class="line"><span class="comment">  msg: string</span></span><br><span class="line"><span class="comment">  time: string</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"msgItem"</span>&gt;</span></span><br><span class="line">  	 <span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">text</span>&gt;</span> &#123;&#123;index&#125;&#125;: &#123;&#123;msg&#125;&#125; <span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">   		<span class="tag">&lt;<span class="name">text</span>&gt;</span> Time: &#123;&#123;time&#125;&#125; <span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">	 <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用模板"><a href="#使用模板" class="headerlink" title="使用模板"></a><strong>使用模板</strong></h4><p>使用 is 属性，声明需要的使用的模板，然后将模板所需要的 data 传入，如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"msgItem"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;...item&#125;&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    item: &#123;</span><br><span class="line">      index: <span class="number">0</span>,</span><br><span class="line">      msg: <span class="string">'this is a template'</span>,</span><br><span class="line">      time: <span class="string">'2016-09-15'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>is 属性可以使用 Mustache 语法，来动态决定具体需要渲染哪个模板：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"odd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span> odd <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"even"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span> even <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;[1, 2, 3, 4, 5]&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"&#123;&#123;item % 2 == 0 ? 'even' : 'odd'&#125;&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="模板的作用域"><a href="#模板的作用域" class="headerlink" title="模板的作用域"></a><strong>模板的作用域</strong></h4><p>模板拥有自己的作用域，只能使用 data 传入的数据以及模板定义文件中定义的 <wxs /> 模块。</p>
<h2 id="wxs-模块讲解-1-页面引用"><a href="#wxs-模块讲解-1-页面引用" class="headerlink" title="wxs 模块讲解 1 - 页面引用"></a>wxs 模块讲解 1 - 页面引用</h2><h3 id="WXS-模块"><a href="#WXS-模块" class="headerlink" title="WXS 模块"></a>WXS 模块</h3><p>WXS 代码可以编写在 wxml 文件中的<code>&lt;wxs&gt;</code> 标签内，或以 .wxs 为后缀名的文件内。</p>
<h3 id="模块"><a href="#模块" class="headerlink" title="模块"></a><strong>模块</strong></h3><p>每一个 .wxs 文件和 <code>&lt;wxs&gt;</code>标签都是一个单独的模块。</p>
<p>每个模块都有自己独立的作用域。即在一个模块里面定义的变量与函数，默认为私有的，对其他模块不可见。</p>
<p>一个模块要想对外暴露其内部的私有变量与函数，只能通过 module.exports 实现。</p>
<h4 id="wxs-文件"><a href="#wxs-文件" class="headerlink" title=".wxs 文件"></a><strong>.wxs 文件</strong></h4><p>在<strong>微信开发者工具</strong>里面，右键可以直接创建 .wxs 文件，在其中直接编写 WXS 脚本。</p>
<p><strong>示例代码：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">/ <span class="regexp">/pages/</span>comm.wxs</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="string">"'hello world' from comm.wxs"</span>;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  foo: foo,</span><br><span class="line">  bar: bar</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上述例子在 <code>/pages/comm.wxs</code> 的文件里面编写了 WXS 代码。该 .wxs 文件可以被其他的 .wxs 文件 或 WXML 中的<code>&lt;wxs&gt;</code>标签引用。</p>
<h4 id="module-对象"><a href="#module-对象" class="headerlink" title="module 对象"></a><strong>module 对象</strong></h4><p>每个 wxs 模块均有一个内置的 module 对象。</p>
<h5 id="属性-1"><a href="#属性-1" class="headerlink" title="属性"></a><strong>属性</strong></h5><p>· exports: 通过该属性，可以对外共享本模块的私有变量与函数。</p>
<p><strong>示例代码：</strong></p>
<p><a href="https://developers.weixin.qq.com/s/KYgu1Km36pZP" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// /pages/tools.wxs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="string">"'hello world' from tools.wxs"</span>;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  FOO: foo,</span><br><span class="line">  bar: bar,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.msg = <span class="string">"some msg"</span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- page/index/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wxs</span> <span class="attr">src</span>=<span class="string">"./../tools.wxs"</span> <span class="attr">module</span>=<span class="string">"tools"</span> /&gt;</span><span class="tag">&lt;<span class="name">view</span>&gt;</span> &#123;&#123;tools.msg&#125;&#125; <span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">view</span>&gt;</span> &#123;&#123;tools.bar(tools.FOO)&#125;&#125; <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>页面输出：</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">some msg</span><br><span class="line">'hello world' from tools.wxs</span><br></pre></td></tr></table></figure>



<h4 id="wxs模块的使用："><a href="#wxs模块的使用：" class="headerlink" title="wxs模块的使用："></a>wxs模块的使用：</h4><p>① js 代码块可以在页面中被引入使用</p>
<p>② 定义 *.wxs 文件，module.exports 暴露接口和属性</p>
<p><strong>示例：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Module.wxs</span><br><span class="line"><span class="keyword">var</span> name=<span class="string">"慕课网"</span>;</span><br><span class="line"><span class="keyword">var</span> age=<span class="number">18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> method = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">name: name,</span><br><span class="line">age: age,</span><br><span class="line">method: method</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">Wxs.wxml</span><br><span class="line"><span class="comment">&lt;!--pages/wxs/wxs.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">wxs</span> <span class="attr">src</span>=<span class="string">"../wxs/module.wxs"</span> <span class="attr">module</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">wxs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;item.age&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;item.method("这是一个参数")&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>效果：</strong> </p>
<img src="http://photo.wushaopei.com/qiniu614.png" width="90%">



<h2 id="wxs-模块讲解2-模块调用模块"><a href="#wxs-模块讲解2-模块调用模块" class="headerlink" title="wxs 模块讲解2 - 模块调用模块"></a>wxs 模块讲解2 - 模块调用模块</h2><h3 id="require函数"><a href="#require函数" class="headerlink" title="require函数"></a><strong>require函数</strong></h3><p>在.wxs模块中引用其他 wxs 文件模块，可以使用 require 函数。</p>
<p>引用的时候，要注意如下几点：</p>
<ul>
<li>只能引用 .wxs 文件模块，且必须使用相对路径。</li>
<li>wxs 模块均为单例，wxs 模块在第一次被引用时，会自动初始化为单例对象。多个页面，多个地方，多次引用，使用的都是同一个 wxs 模块对象。</li>
<li>如果一个 wxs 模块在定义之后，一直没有被引用，则该模块不会被解析与运行。</li>
</ul>
<p><strong>示例代码：</strong></p>
<p><a href="https://developers.weixin.qq.com/s/E4g94Kme6rZ6" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// /pages/tools.wxs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="string">"'hello world' from tools.wxs"</span>;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  FOO: foo,</span><br><span class="line">  bar: bar,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.msg = <span class="string">"some msg"</span>;</span><br><span class="line"><span class="comment">// /pages/logic.wxs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tools = <span class="built_in">require</span>(<span class="string">"./tools.wxs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(tools.FOO);</span><br><span class="line"><span class="built_in">console</span>.log(tools.bar(<span class="string">"logic.wxs"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(tools.msg);</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- /page/index/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wxs</span> <span class="attr">src</span>=<span class="string">"./../logic.wxs"</span> <span class="attr">module</span>=<span class="string">"logic"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>控制台输出：</strong></p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">'hello world' from tools.wxs</span><br><span class="line">logic.wxs</span><br><span class="line">some msg</span><br></pre></td></tr></table></figure>



<h2 id="小程序模板在外部页面引用"><a href="#小程序模板在外部页面引用" class="headerlink" title="小程序模板在外部页面引用"></a>小程序模板在外部页面引用</h2><p><strong>模板的外部引用</strong></p>
<ul>
<li><p>模板在某个 wxml 中定义完毕后可以被其他页面引用</p>
</li>
<li><p>关键字import</p>
</li>
<li><p>A引用B，B引用C，A不能引用C</p>
</li>
</ul>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a><strong>引用</strong></h3><p>WXML 提供两种文件引用方式 <code>import</code> 和 <code>include</code> 。</p>
<h4 id="import"><a href="#import" class="headerlink" title="import"></a><strong>import</strong></h4><p>import可以在该文件中使用目标文件定义的template，如：</p>
<p>在 item.wxml 中定义了一个叫item的template：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- item.wxml --&gt;</span><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123;text&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 index.wxml 中引用了 item.wxml，就可以使用item模板：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">"item.wxml"</span>/&gt;</span><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"item"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;text: 'forbar'&#125;&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="import-的作用域"><a href="#import-的作用域" class="headerlink" title="import 的作用域"></a><strong>import 的作用域</strong></h4><p>import 有作用域的概念，即只会 import 目标文件中定义的 template，而不会 import 目标文件 import 的 template。</p>
<p><strong>如：C import B，B import A，在C中可以使用B定义的</strong>template<strong>，在B中可以使用A定义的</strong>template<strong>，但是C不能使用A定义的</strong>template。� </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- A.wxml --&gt;</span><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"A"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span>&gt;</span> A template <span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- B.wxml --&gt;</span><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">"a.wxml"</span>/&gt;</span><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"B"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span>&gt;</span> B template <span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- C.wxml --&gt;</span><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">"b.wxml"</span>/&gt;</span><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"A"</span>/&gt;</span>  <span class="comment">&lt;!-- Error! Can not use tempalte when not import A. --&gt;</span><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"B"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="include"><a href="#include" class="headerlink" title="include"></a><strong>include</strong></h4><p>include 可以将目标文件<strong>除了</strong> <code>&lt;template/&gt;</code> <code>&lt;wxs/&gt;</code> 外的整个代码引入，相当于是拷贝到 include 位置，如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.wxml --&gt;</span><span class="tag">&lt;<span class="name">include</span> <span class="attr">src</span>=<span class="string">"header.wxml"</span>/&gt;</span><span class="tag">&lt;<span class="name">view</span>&gt;</span> body <span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">include</span> <span class="attr">src</span>=<span class="string">"footer.wxml"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- header.wxml --&gt;</span><span class="tag">&lt;<span class="name">view</span>&gt;</span> header <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- footer.wxml --&gt;</span><span class="tag">&lt;<span class="name">view</span>&gt;</span> footer <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>微信小程序</category>
      </categories>
      <tags>
        <tag>小程序注册</tag>
        <tag>helloworld</tag>
        <tag>目录结构</tag>
        <tag>生命周期</tag>
        <tag>调试debug</tag>
        <tag>数据绑定</tag>
        <tag>模板</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序（三）form表单组件</title>
    <url>/2020/05/14/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%88%E4%B8%89%EF%BC%89form%E8%A1%A8%E5%8D%95%E7%BB%84%E4%BB%B6/</url>
    <content><![CDATA[<h2 id="form组件"><a href="#form组件" class="headerlink" title="form组件"></a>form组件</h2><h3 id="from-组件-button-的使用"><a href="#from-组件-button-的使用" class="headerlink" title="from 组件 - button 的使用"></a>from 组件 - button 的使用</h3><h4 id="button"><a href="#button" class="headerlink" title="button"></a><strong>button</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>按钮。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>size</td>
<td>string</td>
<td>default</td>
<td>否</td>
<td>按钮的大小</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>type</td>
<td>string</td>
<td>default</td>
<td>否</td>
<td>按钮的样式类型</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>plain</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>按钮是否镂空，背景色透明</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>loading</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>名称前是否带 loading 图标</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>form-type</td>
<td>string</td>
<td></td>
<td>否</td>
<td>用于 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/form.html" target="_blank" rel="noopener">form</a> 组件，点击分别会触发 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/form.html" target="_blank" rel="noopener">form</a> 组件的 submit/reset 事件</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>open-type</td>
<td>string</td>
<td></td>
<td>否</td>
<td>微信开放能力</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>hover-class</td>
<td>string</td>
<td>button-hover</td>
<td>否</td>
<td>指定按钮按下去的样式类。当 hover-class=”none” 时，没有点击态效果</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>hover-stop-propagation</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>指定是否阻止本节点的祖先节点出现点击态</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>hover-start-time</td>
<td>number</td>
<td>20</td>
<td>否</td>
<td>按住后多久出现点击态，单位毫秒</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>hover-stay-time</td>
<td>number</td>
<td>70</td>
<td>否</td>
<td>手指松开后点击态保留时间，单位毫秒</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>lang</td>
<td>string</td>
<td>en</td>
<td>否</td>
<td>指定返回用户信息的语言，zh_CN 简体中文，zh_TW 繁体中文，en 英文。</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.3.0</a></td>
</tr>
<tr>
<td>session-from</td>
<td>string</td>
<td></td>
<td>否</td>
<td>会话来源，open-type=”contact”时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.4.0</a></td>
</tr>
<tr>
<td>send-message-title</td>
<td>string</td>
<td>当前标题</td>
<td>否</td>
<td>会话内消息卡片标题，open-type=”contact”时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>send-message-path</td>
<td>string</td>
<td>当前分享路径</td>
<td>否</td>
<td>会话内消息卡片点击跳转小程序路径，open-type=”contact”时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>send-message-img</td>
<td>string</td>
<td>截图</td>
<td>否</td>
<td>会话内消息卡片图片，open-type=”contact”时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>app-parameter</td>
<td>string</td>
<td></td>
<td>否</td>
<td>打开 APP 时，向 APP 传递的参数，open-type=launchApp时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.5</a></td>
</tr>
<tr>
<td>show-message-card</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否显示会话内消息卡片，设置此参数为 true，用户进入客服会话会在右下角显示”可能要发送的小程序”提示，用户点击后可以快速发送小程序消息，open-type=”contact”时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>bindgetuserinfo</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>用户点击该按钮时，会返回获取到的用户信息，回调的detail数据与<a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html" target="_blank" rel="noopener">wx.getUserInfo</a>返回的一致，open-type=”getUserInfo”时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.3.0</a></td>
</tr>
<tr>
<td>bindcontact</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>客服消息回调，open-type=”contact”时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>bindgetphonenumber</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>获取用户手机号回调，open-type=getPhoneNumber时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>binderror</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>当使用开放能力时，发生错误的回调，open-type=launchApp时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.5</a></td>
</tr>
<tr>
<td>bindopensetting</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>在打开授权设置页后回调，open-type=openSetting时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>bindlaunchapp</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>打开 APP 成功的回调，open-type=launchApp时有效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.4.4</a></td>
</tr>
</tbody></table>
<p><strong>size 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>default</td>
<td>默认大小</td>
<td></td>
</tr>
<tr>
<td>mini</td>
<td>小尺寸</td>
<td></td>
</tr>
</tbody></table>
<p><strong>type 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>primary</td>
<td>绿色</td>
<td></td>
</tr>
<tr>
<td>default</td>
<td>白色</td>
<td></td>
</tr>
<tr>
<td>warn</td>
<td>红色</td>
<td></td>
</tr>
</tbody></table>
<p><strong>form-type 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>submit</td>
<td>提交表单</td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>重置表单</td>
<td></td>
</tr>
</tbody></table>
<p><strong>open-type 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>contact</td>
<td>打开客服会话，如果用户在会话中点击消息卡片后返回小程序，可以从 bindcontact 回调中获得具体信息，<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/customer-message/customer-message.html" target="_blank" rel="noopener">具体说明</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>share</td>
<td>触发用户转发，使用前建议先阅读<a href="#%E4%BD%BF%E7%94%A8%E6%8C%87%E5%BC%95">使用指引</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>getPhoneNumber</td>
<td>获取用户手机号，可以从bindgetphonenumber回调中获取到用户信息，<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html" target="_blank" rel="noopener">具体说明</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>getUserInfo</td>
<td>获取用户信息，可以从bindgetuserinfo回调中获取到用户信息</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.3.0</a></td>
</tr>
<tr>
<td>launchApp</td>
<td>打开APP，可以通过app-parameter属性设定向APP传的参数<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/launchApp.html" target="_blank" rel="noopener">具体说明</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.5</a></td>
</tr>
<tr>
<td>openSetting</td>
<td>打开授权设置页</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>feedback</td>
<td>打开“意见反馈”页面，用户可提交反馈内容并上传<a href="https://developers.weixin.qq.com/miniprogram/dev/api/base/debug/wx.getLogManager.html" target="_blank" rel="noopener">日志</a>，开发者可以登录<a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener">小程序管理后台</a>后进入左侧菜单“客服反馈”页面获取到反馈内容</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.1.0</a></td>
</tr>
</tbody></table>
<p><strong>lang 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>en</td>
<td>英文</td>
<td></td>
</tr>
<tr>
<td>zh_CN</td>
<td>简体中文</td>
<td></td>
</tr>
<tr>
<td>zh_TW</td>
<td>繁体中文</td>
<td></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip"><a href="#Bug-amp-Tip" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li><p>tip: button-hover 默认为{background-color: rgba(0, 0, 0, 0.1); opacity: 0.7;}</p>
</li>
<li><p>tip: bindgetphonenumber 从1.2.0 开始支持，但是在1.5.3以下版本中无法使用<a href="https://developers.weixin.qq.com/miniprogram/dev/api/base/wx.canIUse.html" target="_blank" rel="noopener">wx.canIUse</a>进行检测，建议使用基础库版本进行判断。</p>
</li>
<li><p>tip: 在bindgetphonenumber 等返回加密信息的回调中调用 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html" target="_blank" rel="noopener">wx.login</a> 登录，可能会刷新登录态。此时服务器使用 code 换取的 sessionKey 不是加密时使用的 sessionKey，导致解密失败。建议开发者提前进行 login；或者在回调中先使用 checkSession 进行登录态检查，避免 login 刷新登录态。</p>
</li>
<li><p>tip: 从 2.1.0 起，button 可作为原生组件的子节点嵌入，以便在原生组件上使用 open-type 的能力。</p>
</li>
<li><p>tip: 目前设置了 form-type 的 button 只会对当前组件中的 form 有效。因而，将 button 封装在自定义组件中，而 from 在自定义组件外，将会使这个 button 的 form-type 失效。</p>
</li>
</ol>
<h4 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/ZHrWZqm66cZy" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/button/button.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"primary"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"default"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"warn"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"primary"</span> <span class="attr">plain</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>按钮</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">disabled</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">loading</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">form-type</span>=<span class="string">"submit"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">open-type</span>=<span class="string">""</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">"mini"</span> <span class="attr">type</span>=<span class="string">"warn"</span> <span class="attr">hover-class</span>=<span class="string">"none"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu643.png" width="30%">

<hr>
<h3 id="form-组件-checkbox-与-lable"><a href="#form-组件-checkbox-与-lable" class="headerlink" title="form 组件 -  checkbox 与 lable"></a>form 组件 -  checkbox 与 lable</h3><h4 id="checkbox-group"><a href="#checkbox-group" class="headerlink" title="checkbox-group"></a><strong>checkbox-group</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>多项选择器，内部由多个<a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox.html" target="_blank" rel="noopener">checkbox</a>组成。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>bindchange</td>
<td>EventHandle</td>
<td></td>
<td>否</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox-group.html" target="_blank" rel="noopener">checkbox-group</a>中选中项发生改变时触发 change 事件，detail = {value:[选中的checkbox的value的数组]}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h4 id="checkbox"><a href="#checkbox" class="headerlink" title="checkbox"></a><strong>checkbox</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>多选项目。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>string</td>
<td></td>
<td>否</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox.html" target="_blank" rel="noopener">checkbox</a>标识，选中时触发<a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox-group.html" target="_blank" rel="noopener">checkbox-group</a>的 change 事件，并携带 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox.html" target="_blank" rel="noopener">checkbox</a> 的 value</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>checked</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>当前是否选中，可用来设置默认选中</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>color</td>
<td>string</td>
<td>#09BB07</td>
<td>否</td>
<td>checkbox的颜色，同css的color</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h5 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h5><p><a href="https://developers.weixin.qq.com/s/hGa3DcmW6qYw" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<h4 id="label"><a href="#label" class="headerlink" title="label"></a><strong>label</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>用来改进表单组件的可用性。</p>
<p>使用for属性找到对应的id，或者将控件放在该标签下，当点击时，就会触发对应的控件。 for优先级高于内部控件，内部有多个控件的时候默认触发第一个控件。 目前可以绑定的控件有：<a href="https://developers.weixin.qq.com/miniprogram/dev/component/button.html" target="_blank" rel="noopener">button</a>, <a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox.html" target="_blank" rel="noopener">checkbox</a>, <a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio.html" target="_blank" rel="noopener">radio</a>, <a href="https://developers.weixin.qq.com/miniprogram/dev/component/switch.html" target="_blank" rel="noopener">switch</a>。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>for</td>
<td>string</td>
<td></td>
<td>否</td>
<td>绑定控件的 id</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h5 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h5><p><a href="https://developers.weixin.qq.com/s/alak1cmR6JYU" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/checkbox/checkbox.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">value</span>=<span class="string">"中国"</span>&gt;</span>中国<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">value</span>=<span class="string">"美国"</span> <span class="attr">disabled</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>美国<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">value</span>=<span class="string">"法国"</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>法国<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">value</span>=<span class="string">"德国"</span> <span class="attr">color</span>=<span class="string">"#9900cc"</span>&gt;</span>德国<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">id</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;item.checked&#125;&#125;"</span> <span class="attr">color</span>=<span class="string">"&#123;&#123;item.color&#125;&#125;"</span> <span class="attr">disabled</span>=<span class="string">"&#123;&#123;item.disable&#125;&#125;"</span>&gt;</span>&#123;&#123;item.value&#125;&#125;<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"1001"</span>&gt;</span>测试点击<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line">        array:[</span><br><span class="line">        &#123; <span class="attr">id</span>:<span class="string">"1001"</span>,<span class="attr">name</span>: <span class="string">"v中国"</span>, <span class="attr">value</span>: <span class="string">"中国"</span>, <span class="attr">checked</span>: <span class="literal">true</span>, <span class="attr">color</span>: <span class="string">"red"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1002"</span>,<span class="attr">name</span>: <span class="string">"v美国"</span>, <span class="attr">value</span>: <span class="string">"美国"</span>, <span class="attr">checked</span>: <span class="literal">true</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1003"</span>,<span class="attr">name</span>: <span class="string">"v俄国"</span>, <span class="attr">value</span>: <span class="string">"俄国"</span>, <span class="attr">checked</span>: <span class="literal">false</span>, <span class="attr">color</span>: <span class="string">"green"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu644.png" width="40%">



<h3 id="form的提交和重置"><a href="#form的提交和重置" class="headerlink" title="form的提交和重置"></a>form的提交和重置</h3><h4 id="form"><a href="#form" class="headerlink" title="form"></a><strong>form</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>表单。将组件内的用户输入的<a href="https://developers.weixin.qq.com/miniprogram/dev/component/switch.html" target="_blank" rel="noopener">switch</a> <a href="https://developers.weixin.qq.com/miniprogram/dev/component/input.html" target="_blank" rel="noopener">input</a> <a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox.html" target="_blank" rel="noopener">checkbox</a> <a href="https://developers.weixin.qq.com/miniprogram/dev/component/slider.html" target="_blank" rel="noopener">slider</a> <a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio.html" target="_blank" rel="noopener">radio</a> <a href="https://developers.weixin.qq.com/miniprogram/dev/component/picker.html" target="_blank" rel="noopener">picker</a> 提交。</p>
<p>当点击 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/form.html" target="_blank" rel="noopener">form</a> 表单中 form-type 为 submit 的 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/button.html" target="_blank" rel="noopener">button</a> 组件时，会将表单组件中的 value 值进行提交，需要在表单组件中加上 name 来作为 key。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>report-submit</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否返回 formId 用于发送<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/template-message.html" target="_blank" rel="noopener">模板消息</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>report-submit-timeout</td>
<td>number</td>
<td>0</td>
<td>否</td>
<td>等待一段时间（毫秒数）以确认 formId 是否生效。如果未指定这个参数，formId 有很小的概率是无效的（如遇到网络失败的情况）。指定这个参数将可以检测 formId 是否有效，以这个参数的时间作为这项检测的超时时间。如果失败，将返回 requestFormId:fail 开头的 formId</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.6.2</a></td>
</tr>
<tr>
<td>bindsubmit</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>携带 form 中的数据触发 submit 事件，event.detail = {value : {‘name’: ‘value’} , formId: ‘’}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindreset</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>表单重置时会触发 reset 事件</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h4 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p> <a href="https://developers.weixin.qq.com/s/MUaz7cmy6AYq" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/myform/myform.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">bindsubmit</span>=<span class="string">"formSubmit"</span> <span class="attr">bindreset</span>=<span class="string">"formReset"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox-group</span> <span class="attr">name</span>=<span class="string">"aa"</span> <span class="attr">bindchange</span>=<span class="string">"changed"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">value</span>=<span class="string">"美国"</span> <span class="attr">disabled</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>美国<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">value</span>=<span class="string">"法国"</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>法国<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">value</span>=<span class="string">"德国"</span> <span class="attr">color</span>=<span class="string">"#9900cc"</span>&gt;</span>德国<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox-group</span> <span class="attr">name</span>=<span class="string">"bb"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">id</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;item.checked&#125;&#125;"</span> <span class="attr">color</span>=<span class="string">"&#123;&#123;item.color&#125;&#125;"</span> <span class="attr">disabled</span>=<span class="string">"&#123;&#123;item.disable&#125;&#125;"</span>&gt;</span>&#123;&#123;item.value&#125;&#125;<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">form-type</span>=<span class="string">"submit"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">form-type</span>=<span class="string">"reset"</span>&gt;</span>重置<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 页面的初始数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">data: &#123;</span><br><span class="line">    array: [</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">"1001"</span>, <span class="attr">name</span>: <span class="string">"v中国"</span>, <span class="attr">value</span>: <span class="string">"中国"</span>, <span class="attr">checked</span>: <span class="literal">true</span>, <span class="attr">color</span>: <span class="string">"red"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">"1002"</span>, <span class="attr">name</span>: <span class="string">"v美国"</span>, <span class="attr">value</span>: <span class="string">"美国"</span>, <span class="attr">checked</span>: <span class="literal">true</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">"1003"</span>, <span class="attr">name</span>: <span class="string">"v俄国"</span>, <span class="attr">value</span>: <span class="string">"俄国"</span>, <span class="attr">checked</span>: <span class="literal">false</span>, <span class="attr">color</span>: <span class="string">"green"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">    &#125;,</span><br><span class="line">    changed:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    formSubmit:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    formReset: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"data has been resetted......."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">)&#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu645.png" width="100%">

<p> Form 中元素的 name 应该定义在 checkbox-group标签上而不是 checkbox标签上</p>
<h3 id="form-组件-input-文本框（上）"><a href="#form-组件-input-文本框（上）" class="headerlink" title="form 组件 - input 文本框（上）"></a>form 组件 - input 文本框（上）</h3><h4 id="input"><a href="#input" class="headerlink" title="input"></a><strong>input</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>输入框。该组件是<a href="https://developers.weixin.qq.com/miniprogram/dev/component/native-component.html" target="_blank" rel="noopener">原生组件</a>，使用时请注意相关限制</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>string</td>
<td></td>
<td>是</td>
<td>输入框的初始内容</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>type</td>
<td>string</td>
<td>text</td>
<td>否</td>
<td>input 的类型</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>password</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否是密码类型</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>placeholder</td>
<td>string</td>
<td></td>
<td>是</td>
<td>输入框为空时占位符</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>placeholder-style</td>
<td>string</td>
<td></td>
<td>是</td>
<td>指定 placeholder 的样式</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>placeholder-class</td>
<td>string</td>
<td>input-placeholder</td>
<td>否</td>
<td>指定 placeholder 的样式类</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>maxlength</td>
<td>number</td>
<td>140</td>
<td>否</td>
<td>最大输入长度，设置为 -1 的时候不限制最大长度</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>cursor-spacing</td>
<td>number</td>
<td>0</td>
<td>否</td>
<td>指定光标与键盘的距离，取 input 距离底部的距离和 cursor-spacing 指定的距离的最小值作为光标与键盘的距离</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>auto-focus</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>(即将废弃，请直接使用 focus )自动聚焦，拉起键盘</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>focus</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>获取焦点</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>confirm-type</td>
<td>string</td>
<td>done</td>
<td>否</td>
<td>设置键盘右下角按钮的文字，仅在type=’text’时生效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>confirm-hold</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>点击键盘右下角按钮时是否保持键盘不收起</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>cursor</td>
<td>number</td>
<td></td>
<td>是</td>
<td>指定focus时的光标位置</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>selection-start</td>
<td>number</td>
<td>-1</td>
<td>否</td>
<td>光标起始位置，自动聚集时有效，需与selection-end搭配使用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.0</a></td>
</tr>
<tr>
<td>selection-end</td>
<td>number</td>
<td>-1</td>
<td>否</td>
<td>光标结束位置，自动聚集时有效，需与selection-start搭配使用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.0</a></td>
</tr>
<tr>
<td>adjust-position</td>
<td>boolean</td>
<td>true</td>
<td>否</td>
<td>键盘弹起时，是否自动上推页面</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>hold-keyboard</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>focus时，点击页面的时候不收起键盘</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.8.2</a></td>
</tr>
<tr>
<td>bindinput</td>
<td>eventhandle</td>
<td></td>
<td>是</td>
<td>键盘输入时触发，event.detail = {value, cursor, keyCode}，keyCode 为键值，2.1.0 起支持，处理函数可以直接 return 一个字符串，将替换输入框的内容。</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindfocus</td>
<td>eventhandle</td>
<td></td>
<td>是</td>
<td>输入框聚焦时触发，event.detail = { value, height }，height 为键盘高度，在基础库 1.9.90 起支持</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindblur</td>
<td>eventhandle</td>
<td></td>
<td>是</td>
<td>输入框失去焦点时触发，event.detail = {value: value}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindconfirm</td>
<td>eventhandle</td>
<td></td>
<td>是</td>
<td>点击完成按钮时触发，event.detail = {value: value}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindkeyboardheightchange</td>
<td>eventhandle</td>
<td></td>
<td>是</td>
<td>键盘高度发生变化的时候触发此事件，event.detail = {height: height, duration: duration}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.7.0</a></td>
</tr>
</tbody></table>
<p><strong>type 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>text</td>
<td>文本输入键盘</td>
<td></td>
</tr>
<tr>
<td>number</td>
<td>数字输入键盘</td>
<td></td>
</tr>
<tr>
<td>idcard</td>
<td>身份证输入键盘</td>
<td></td>
</tr>
<tr>
<td>digit</td>
<td>带小数点的数字键盘</td>
<td></td>
</tr>
</tbody></table>
<p><strong>confirm-type 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>send</td>
<td>右下角按钮为“发送”</td>
<td></td>
</tr>
<tr>
<td>search</td>
<td>右下角按钮为“搜索”</td>
<td></td>
</tr>
<tr>
<td>next</td>
<td>右下角按钮为“下一个”</td>
<td></td>
</tr>
<tr>
<td>go</td>
<td>右下角按钮为“前往”</td>
<td></td>
</tr>
<tr>
<td>done</td>
<td>右下角按钮为“完成”</td>
<td></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-1"><a href="#Bug-amp-Tip-1" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li><p>tip: confirm-type的最终表现与手机输入法本身的实现有关，部分安卓系统输入法和第三方输入法可能不支持或不完全支持</p>
</li>
<li><p>tip : input 组件是一个原生组件，字体是系统字体，所以无法设置 font-family</p>
</li>
<li><p>tip : 在 input 聚焦期间，避免使用 css 动画</p>
</li>
<li><p>tip : 对于将 input 封装在自定义组件中、而 form 在自定义组件外的情况， form 将不能获得这个自定义组件中 input 的值。此时需要使用自定义组件的 <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/behaviors.html" target="_blank" rel="noopener">内置 behaviors</a> wx://form-field</p>
</li>
<li><p>tip : 键盘高度发生变化，keyboardheightchange事件可能会多次触发，开发者对于相同的height值应该忽略掉</p>
</li>
<li><p>bug : 微信版本 6.3.30, focus 属性设置无效</p>
</li>
<li><p>bug : 微信版本 6.3.30, placeholder 在聚焦时出现重影问题</p>
</li>
</ol>
<h4 id="示例代码-4"><a href="#示例代码-4" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/JYwgZ6ml6rYP" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/input/input.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"学习小程序实战"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"text"</span> <span class="attr">type</span>=<span class="string">"text"</span> &gt;</span>文本输入键盘<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"number"</span> <span class="attr">type</span>=<span class="string">"number"</span>&gt;</span>数字输入键盘<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"idcard"</span> <span class="attr">type</span>=<span class="string">"idcard"</span>&gt;</span>身份证输入键盘<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"digit"</span> <span class="attr">type</span>=<span class="string">"digit"</span>&gt;</span>  带小数点的数字键盘<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">密码框：<span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"密码框"</span> <span class="attr">password</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">Placeholder:<span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">placeholder</span>=<span class="string">"请输入你的用户名"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu646.png" width="40%">

<hr>
<h3 id="form-组件-input-文本框（下）"><a href="#form-组件-input-文本框（下）" class="headerlink" title="form 组件 - input 文本框（下）"></a>form 组件 - input 文本框（下）</h3><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/input.html" target="_blank" rel="noopener">https://developers.weixin.qq.com/miniprogram/dev/component/input.html</a></p>
<h3 id="form-组件-picker-普通选择器"><a href="#form-组件-picker-普通选择器" class="headerlink" title="form 组件 - picker 普通选择器"></a>form 组件 - picker 普通选择器</h3><h4 id="picker"><a href="#picker" class="headerlink" title="picker"></a><strong>picker</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>从底部弹起的滚动选择器。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>header-text</td>
<td>string</td>
<td></td>
<td>否</td>
<td>选择器的标题，仅安卓可用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.11.0</a></td>
</tr>
<tr>
<td>mode</td>
<td>string</td>
<td>selector</td>
<td>否</td>
<td>选择器类型</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindcancel</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>取消选择时触发</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
</tbody></table>
<p><strong>mode 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>selector</td>
<td>普通选择器</td>
<td></td>
</tr>
<tr>
<td>multiSelector</td>
<td>多列选择器</td>
<td></td>
</tr>
<tr>
<td>time</td>
<td>时间选择器</td>
<td></td>
</tr>
<tr>
<td>date</td>
<td>日期选择器</td>
<td></td>
</tr>
<tr>
<td>region</td>
<td>省市区选择器</td>
<td></td>
</tr>
</tbody></table>
<p>除了上述通用的属性，对于不同的mode，picker拥有不同的属性。</p>
<h4 id="普通选择器：mode-selector"><a href="#普通选择器：mode-selector" class="headerlink" title="普通选择器：mode = selector"></a><strong>普通选择器：mode = selector</strong></h4><table>
<thead>
<tr>
<th><strong>属性名</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>range</td>
<td>array/object array</td>
<td>[]</td>
<td>mode 为 selector 或 multiSelector 时，range 有效</td>
<td></td>
</tr>
<tr>
<td>range-key</td>
<td>string</td>
<td></td>
<td>当 range 是一个 Object Array 时，通过 range-key 来指定 Object 中 key 的值作为选择器显示内容</td>
<td></td>
</tr>
<tr>
<td>value</td>
<td>number</td>
<td>0</td>
<td>表示选择了 range 中的第几个（下标从 0 开始）</td>
<td></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>value 改变时触发 change 事件，event.detail = {value}</td>
<td></td>
</tr>
</tbody></table>
<h4 id="多列选择器：mode-multiSelector"><a href="#多列选择器：mode-multiSelector" class="headerlink" title="多列选择器：mode = multiSelector"></a><strong>多列选择器：mode = multiSelector</strong></h4><table>
<thead>
<tr>
<th><strong>属性名</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>range</td>
<td>array/object array</td>
<td>[]</td>
<td>mode 为 selector 或 multiSelector 时，range 有效</td>
<td></td>
</tr>
<tr>
<td>range-key</td>
<td>string</td>
<td></td>
<td>当 range 是一个 Object Array 时，通过 range-key 来指定 Object 中 key 的值作为选择器显示内容</td>
<td></td>
</tr>
<tr>
<td>value</td>
<td>array</td>
<td>[]</td>
<td>表示选择了 range 中的第几个（下标从 0 开始）</td>
<td></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>value 改变时触发 change 事件，event.detail = {value}</td>
<td></td>
</tr>
<tr>
<td>bindcolumnchange</td>
<td>eventhandle</td>
<td></td>
<td>列改变时触发</td>
<td></td>
</tr>
</tbody></table>
<h4 id="时间选择器：mode-time"><a href="#时间选择器：mode-time" class="headerlink" title="时间选择器：mode = time"></a><strong>时间选择器：mode = time</strong></h4><table>
<thead>
<tr>
<th><strong>属性名</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>string</td>
<td></td>
<td>表示选中的时间，格式为”hh:mm”</td>
<td></td>
</tr>
<tr>
<td>start</td>
<td>string</td>
<td></td>
<td>表示有效时间范围的开始，字符串格式为”hh:mm”</td>
<td></td>
</tr>
<tr>
<td>end</td>
<td>string</td>
<td></td>
<td>表示有效时间范围的结束，字符串格式为”hh:mm”</td>
<td></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>value 改变时触发 change 事件，event.detail = {value}</td>
<td></td>
</tr>
</tbody></table>
<h4 id="日期选择器：mode-date"><a href="#日期选择器：mode-date" class="headerlink" title="日期选择器：mode = date"></a><strong>日期选择器：mode = date</strong></h4><table>
<thead>
<tr>
<th><strong>属性名</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>string</td>
<td>0</td>
<td>表示选中的日期，格式为”YYYY-MM-DD”</td>
<td></td>
</tr>
<tr>
<td>start</td>
<td>string</td>
<td></td>
<td>表示有效日期范围的开始，字符串格式为”YYYY-MM-DD”</td>
<td></td>
</tr>
<tr>
<td>end</td>
<td>string</td>
<td></td>
<td>表示有效日期范围的结束，字符串格式为”YYYY-MM-DD”</td>
<td></td>
</tr>
<tr>
<td>fields</td>
<td>string</td>
<td>day</td>
<td>有效值 year,month,day，表示选择器的粒度</td>
<td></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>value 改变时触发 change 事件，event.detail = {value}</td>
<td></td>
</tr>
</tbody></table>
<p><em>fields 有效值：*</em></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>year</td>
<td>选择器粒度为年</td>
</tr>
<tr>
<td>month</td>
<td>选择器粒度为月份</td>
</tr>
<tr>
<td>day</td>
<td>选择器粒度为天</td>
</tr>
</tbody></table>
<h4 id="省市区选择器：mode-region-1-4-0"><a href="#省市区选择器：mode-region-1-4-0" class="headerlink" title="省市区选择器：mode = region 1.4.0"></a><strong>省市区选择器：mode = region</strong> <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.4.0</a></h4><table>
<thead>
<tr>
<th><strong>属性名</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>array</td>
<td>[]</td>
<td>表示选中的省市区，默认选中每一列的第一个值</td>
<td></td>
</tr>
<tr>
<td>custom-item</td>
<td>string</td>
<td></td>
<td>可为每一列的顶部添加一个自定义的项</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>value 改变时触发 change 事件，event.detail = {value, code, postcode}，其中字段 code 是统计用区划代码，postcode 是邮政编码</td>
<td></td>
</tr>
</tbody></table>
<h4 id="示例代码-5"><a href="#示例代码-5" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/pZb21cmH6qYX" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/pickeers/pickers.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"selector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span>&gt;</span></span><br><span class="line">请选择我</span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"selector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;arrayObj&#125;&#125;"</span> <span class="attr">range-key</span>=<span class="string">"name"</span></span></span><br><span class="line"><span class="tag"><span class="attr">bindchange</span>=<span class="string">"changeme"</span> <span class="attr">bindcancel</span>=<span class="string">"cancelme"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;showme&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/pickeers/pickers.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 页面的初始数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">data: &#123;</span><br><span class="line">    array:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>],</span><br><span class="line">    arrayObj:[</span><br><span class="line">            &#123; <span class="attr">id</span>:<span class="number">1001</span>, <span class="attr">name</span>: <span class="string">"jack"</span>&#125;,</span><br><span class="line">            &#123; <span class="attr">id</span>: <span class="number">1002</span>, <span class="attr">name</span>: <span class="string">"tom"</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">id</span>: <span class="number">1003</span>, <span class="attr">name</span>: <span class="string">"jetty"</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">id</span>: <span class="number">1004</span>, <span class="attr">name</span>: <span class="string">"hon"</span> &#125;</span><br><span class="line">        ],</span><br><span class="line">       	 showme: <span class="string">"请选择一个人名"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    changeme: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = e.detail.value;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"index下标值为："</span>+ index);</span><br><span class="line">    <span class="keyword">var</span> id = <span class="keyword">this</span>.data.arrayObj[index].id;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="keyword">this</span>.data.arrayObj[index].name;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">    showme: id + name</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">    cancelme:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"触发取消事件........."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu647.png" width="40%">

<hr>
<h3 id="form-组件-picker-多列选择器"><a href="#form-组件-picker-多列选择器" class="headerlink" title="form 组件 -  picker 多列选择器"></a>form 组件 -  picker 多列选择器</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">"margin-top:100rpx;"</span>&gt;</span>多列选择器<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"multiSelector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;arrayMulti&#125;&#125;"</span>&gt;</span>请选择我<span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"multiSelector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;arrayObjMulti&#125;&#125;"</span> <span class="attr">range-key</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag"><span class="attr">bindchange</span>=<span class="string">"changemeMulti"</span> <span class="attr">bindcolumnchange</span>=<span class="string">"columnchange"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;showme&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">changemeMulti: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> indexs = e.detail.value;</span><br><span class="line">    <span class="keyword">var</span> arrayObjMulti = <span class="keyword">this</span>.data.arrayObjMulti;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; indexs.length; i ++)&#123;</span><br><span class="line">        <span class="keyword">var</span> indexTmp = indexs[i];</span><br><span class="line">        <span class="keyword">var</span> id = arrayObjMulti[i][indexTmp].id;</span><br><span class="line">        <span class="keyword">var</span> name = arrayObjMulti[i][indexTmp].name;</span><br><span class="line">        <span class="built_in">console</span>.log(id + <span class="string">" "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu648.png" width="60%">

<hr>
<h3 id="form-组件-picker-view"><a href="#form-组件-picker-view" class="headerlink" title="form 组件 - picker-view"></a>form 组件 - picker-view</h3><h4 id="picker-view"><a href="#picker-view" class="headerlink" title="picker-view"></a><strong>picker-view</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>嵌入页面的滚动选择器。其中只可放置 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/picker-view-column.html" target="_blank" rel="noopener">picker-view-column</a>组件，其它节点不会显示。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>Array.<number></td>
<td></td>
<td>否</td>
<td>数组中的数字依次表示 picker-view 内的 picker-view-column 选择的第几项（下标从 0 开始），数字大于 picker-view-column 可选项长度时，选择最后一项。</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>indicator-style</td>
<td>string</td>
<td></td>
<td>否</td>
<td>设置选择器中间选中框的样式</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>indicator-class</td>
<td>string</td>
<td></td>
<td>否</td>
<td>设置选择器中间选中框的类名</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>mask-style</td>
<td>string</td>
<td></td>
<td>否</td>
<td>设置蒙层的样式</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>mask-class</td>
<td>string</td>
<td></td>
<td>否</td>
<td>设置蒙层的类名</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>滚动选择时触发change事件，event.detail = {value}；value为数组，表示 picker-view 内的 picker-view-column 当前选择的是第几项（下标从 0 开始）</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindpickstart</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>当滚动选择开始时候触发事件</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.3.1</a></td>
</tr>
<tr>
<td>bindpickend</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>当滚动选择结束时候触发事件</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.3.1</a></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-2"><a href="#Bug-amp-Tip-2" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li>tip: 滚动时在iOS自带振动反馈，可在系统设置 -&gt; 声音与触感 -&gt; 系统触感反馈中关闭</li>
</ol>
<h4 id="示例代码-6"><a href="#示例代码-6" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/YfbJZcmG6zYM" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/pickerview/pickerview.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker-view</span> <span class="attr">style</span>=<span class="string">"width:100%;height:250px;"</span> <span class="attr">bindchange</span> = <span class="string">"changeme"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;year&#125;&#125;"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;month&#125;&#125;"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;day&#125;&#125;"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span> &#123;&#123;myvalue&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line">        year: [<span class="number">2000</span>,<span class="number">2001</span>,<span class="number">2002</span>,<span class="number">2003</span>,<span class="number">2004</span>,<span class="number">2005</span>,<span class="number">2006</span>,<span class="number">2007</span>,<span class="number">2008</span>,<span class="number">2009</span>,<span class="number">2010</span>],</span><br><span class="line">        month: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>],</span><br><span class="line">        day: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">16</span>,<span class="number">17</span>,<span class="number">18</span>,<span class="number">19</span>,<span class="number">20</span>],</span><br><span class="line">        myvalue: <span class="string">"请选择日期"</span></span><br><span class="line">    &#125;,</span><br><span class="line">     changeme: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> indexs = e.detail.value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> year = <span class="keyword">this</span>.data.year[indexs[<span class="number">0</span>]];</span><br><span class="line">        <span class="keyword">var</span> month = <span class="keyword">this</span>.data.month[indexs[<span class="number">1</span>]];</span><br><span class="line">        <span class="keyword">var</span> day = <span class="keyword">this</span>.data.day[indexs[<span class="number">2</span>]];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">        myvalue: year + <span class="string">"年"</span> + month + <span class="string">"月"</span> + day + <span class="string">"日"</span></span><br><span class="line">     &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu649.png" width="60%">



<h3 id="form-组件-radio-单选框"><a href="#form-组件-radio-单选框" class="headerlink" title="form 组件 -  radio 单选框"></a>form 组件 -  radio 单选框</h3><h4 id="radio-group"><a href="#radio-group" class="headerlink" title="radio-group"></a><strong>radio-group</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>单项选择器，内部由多个 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio.html" target="_blank" rel="noopener">radio</a> 组成。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>bindchange</td>
<td>EventHandle</td>
<td></td>
<td>否</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio-group.html" target="_blank" rel="noopener">radio-group</a>中选中项发生改变时触发 change 事件，detail = {value:[选中的radio的value的数组]}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h4 id="radio"><a href="#radio" class="headerlink" title="radio"></a><strong>radio</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>单选项目。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>string</td>
<td></td>
<td>否</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio.html" target="_blank" rel="noopener">radio</a> 标识。当该<a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio.html" target="_blank" rel="noopener">radio</a> 选中时，<a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio-group.html" target="_blank" rel="noopener">radio-group</a> 的 change 事件会携带<a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio.html" target="_blank" rel="noopener">radio</a>的value</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>checked</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>当前是否选中</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>color</td>
<td>string</td>
<td>#09BB07</td>
<td>否</td>
<td>radio的颜色，同css的color</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h4 id="示例代码-7"><a href="#示例代码-7" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/tpbv9cmv6HYr" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/radio/radios.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">radio-group</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">radio</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>中国<span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">radio</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span> <span class="attr">disabled</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span>美国<span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">radio</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span> <span class="attr">color</span>=<span class="string">"red"</span>&gt;</span>德国<span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">radio-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">radio-group</span> <span class="attr">bindchange</span>=<span class="string">"changeme"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">radio</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span>&gt;</span>&#123;&#123;item.value&#125;&#125;<span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">radio-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;myvalue&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/radio/radios.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line">        array: [</span><br><span class="line">            &#123; <span class="attr">id</span>: <span class="string">"1001"</span>, <span class="attr">name</span>: <span class="string">"v中国"</span>, <span class="attr">value</span>: <span class="string">"中国"</span>, <span class="attr">checked</span>: <span class="literal">true</span>, <span class="attr">color</span>: <span class="string">"red"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">id</span>: <span class="string">"1002"</span>, <span class="attr">name</span>: <span class="string">"v美国"</span>, <span class="attr">value</span>: <span class="string">"美国"</span>, <span class="attr">checked</span>: <span class="literal">true</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">id</span>: <span class="string">"1003"</span>, <span class="attr">name</span>: <span class="string">"v俄国"</span>, <span class="attr">value</span>: <span class="string">"俄国"</span>, <span class="attr">checked</span>: <span class="literal">false</span>, <span class="attr">color</span>: <span class="string">"green"</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        ],</span><br><span class="line">        	myvalue:<span class="string">"请选择一个 radio "</span></span><br><span class="line">        &#125;,</span><br><span class="line">        changeme:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> value = e.detail.value;</span><br><span class="line">            <span class="keyword">this</span>.setData (&#123;</span><br><span class="line">            myvalue: value</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu650.png" width="60%">

<hr>
<h3 id="form-组件-slider-滑动选择器"><a href="#form-组件-slider-滑动选择器" class="headerlink" title="form 组件 - slider 滑动选择器"></a>form 组件 - slider 滑动选择器</h3><h4 id="slider"><a href="#slider" class="headerlink" title="slider"></a><strong>slider</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>滑动选择器。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>min</td>
<td>number</td>
<td>0</td>
<td>否</td>
<td>最小值</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>max</td>
<td>number</td>
<td>100</td>
<td>否</td>
<td>最大值</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>step</td>
<td>number</td>
<td>1</td>
<td>否</td>
<td>步长，取值必须大于 0，并且可被(max - min)整除</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>value</td>
<td>number</td>
<td>0</td>
<td>否</td>
<td>当前取值</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>color</td>
<td>color</td>
<td>#e9e9e9</td>
<td>否</td>
<td>背景条的颜色（请使用 backgroundColor）</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>selected-color</td>
<td>color</td>
<td>#1aad19</td>
<td>否</td>
<td>已选择的颜色（请使用 activeColor）</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>activeColor</td>
<td>color</td>
<td>#1aad19</td>
<td>否</td>
<td>已选择的颜色</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>backgroundColor</td>
<td>color</td>
<td>#e9e9e9</td>
<td>否</td>
<td>背景条的颜色</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>block-size</td>
<td>number</td>
<td>28</td>
<td>否</td>
<td>滑块的大小，取值范围为 12 - 28</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.0</a></td>
</tr>
<tr>
<td>block-color</td>
<td>color</td>
<td>#ffffff</td>
<td>否</td>
<td>滑块的颜色</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.0</a></td>
</tr>
<tr>
<td>show-value</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否显示当前 value</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>完成一次拖动后触发的事件，event.detail = {value}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindchanging</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>拖动过程中触发的事件，event.detail = {value}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.7.0</a></td>
</tr>
</tbody></table>
<h4 id="示例代码-8"><a href="#示例代码-8" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/3NbqVcm56OYS" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/slider/slider.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">slider</span> <span class="attr">min</span>=<span class="string">"10"</span> <span class="attr">max</span>=<span class="string">"90"</span> <span class="attr">show-value</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span> <span class="attr">activeColor</span>=<span class="string">"red"</span> <span class="attr">backgroundColor</span>=<span class="string">"blue"</span> <span class="attr">block-color</span>=<span class="string">"green"</span> <span class="attr">bindchanging</span>=<span class="string">"iamchanging"</span>&gt;</span><span class="tag">&lt;/<span class="name">slider</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">"background-color:green;width:100%;height:&#123;&#123;myheight&#125;&#125;;"</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/slider/slider.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line">        myheight: <span class="string">"500rpx"</span>,</span><br><span class="line">        staticHeight: <span class="number">500</span></span><br><span class="line">   &#125;,</span><br><span class="line">   iamchanging: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">var</span> val = e.detail.value;</span><br><span class="line">       <span class="keyword">var</span> newHeight = <span class="keyword">this</span>.data.staticHeight * (val/<span class="number">100</span>);</span><br><span class="line">       <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">       myheight: newHeight + <span class="string">"rpx"</span></span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu651.png" width="40%">

<hr>
<h3 id="form-组件-switch-开关"><a href="#form-组件-switch-开关" class="headerlink" title="form 组件 - switch 开关"></a>form 组件 - switch 开关</h3><h4 id="switch"><a href="#switch" class="headerlink" title="switch"></a><strong>switch</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>开关选择器。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>checked</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否选中</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>type</td>
<td>string</td>
<td>switch</td>
<td>否</td>
<td>样式，有效值：switch, checkbox</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>color</td>
<td>string</td>
<td>#04BE02</td>
<td>否</td>
<td>switch 的颜色，同 css 的 color</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindchange</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>checked 改变时触发 change 事件，event.detail={ value}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-3"><a href="#Bug-amp-Tip-3" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li>tip: switch类型切换时在iOS自带振动反馈，可在系统设置 -&gt; 声音与触感 -&gt; 系统触感反馈中关闭</li>
</ol>
<h4 id="示例代码-9"><a href="#示例代码-9" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/6db9lcmu6VYt" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/switch/switch.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span>&gt;</span>这是一个开关选择器<span class="tag">&lt;/<span class="name">switch</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span> <span class="attr">color</span>=<span class="string">"red"</span> <span class="attr">bindchange</span>=<span class="string">"changeme"</span>&gt;</span>开关<span class="tag">&lt;/<span class="name">switch</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">"background-color:&#123;&#123;color&#125;&#125;;width:100%;height:700rpx;"</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/switch/switch.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line">   	 color: <span class="string">"white"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    changeme: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> flag = e.detail.value;</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            <span class="comment">// 开灯</span></span><br><span class="line">            <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">            color: <span class="string">"white"</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 关灯</span></span><br><span class="line">            <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">            color: <span class="string">"black"</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu652.png" width="60%">

<hr>
<h3 id="form-组件-textarea"><a href="#form-组件-textarea" class="headerlink" title="form 组件 - textarea"></a>form 组件 - textarea</h3><h4 id="textarea"><a href="#textarea" class="headerlink" title="textarea"></a><strong>textarea</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>多行输入框。该组件是<a href="https://developers.weixin.qq.com/miniprogram/dev/component/native-component.html" target="_blank" rel="noopener">原生组件</a>，使用时请注意相关限制。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>string</td>
<td></td>
<td>否</td>
<td>输入框的内容</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>placeholder</td>
<td>string</td>
<td></td>
<td>否</td>
<td>输入框为空时占位符</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>placeholder-style</td>
<td>string</td>
<td></td>
<td>否</td>
<td>指定 placeholder 的样式，目前仅支持color,font-size和font-weight</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>placeholder-class</td>
<td>string</td>
<td>textarea-placeholder</td>
<td>否</td>
<td>指定 placeholder 的样式类</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>disabled</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否禁用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>maxlength</td>
<td>number</td>
<td>140</td>
<td>否</td>
<td>最大输入长度，设置为 -1 的时候不限制最大长度</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>auto-focus</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>自动聚焦，拉起键盘。</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>focus</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>获取焦点</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>auto-height</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否自动增高，设置auto-height时，style.height不生效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>fixed</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>如果 textarea 是在一个 position:fixed 的区域，需要显示指定属性 fixed 为 true</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>cursor-spacing</td>
<td>number</td>
<td>0</td>
<td>否</td>
<td>指定光标与键盘的距离。取textarea距离底部的距离和cursor-spacing指定的距离的最小值作为光标与键盘的距离</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>cursor</td>
<td>number</td>
<td>-1</td>
<td>否</td>
<td>指定focus时的光标位置</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>show-confirm-bar</td>
<td>boolean</td>
<td>true</td>
<td>否</td>
<td>是否显示键盘上方带有”完成“按钮那一栏</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.6.0</a></td>
</tr>
<tr>
<td>selection-start</td>
<td>number</td>
<td>-1</td>
<td>否</td>
<td>光标起始位置，自动聚集时有效，需与selection-end搭配使用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.0</a></td>
</tr>
<tr>
<td>selection-end</td>
<td>number</td>
<td>-1</td>
<td>否</td>
<td>光标结束位置，自动聚集时有效，需与selection-start搭配使用</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.0</a></td>
</tr>
<tr>
<td>adjust-position</td>
<td>boolean</td>
<td>true</td>
<td>否</td>
<td>键盘弹起时，是否自动上推页面</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.9.90</a></td>
</tr>
<tr>
<td>hold-keyboard</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>focus时，点击页面的时候不收起键盘</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.8.2</a></td>
</tr>
<tr>
<td>disable-default-padding</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>是否去掉 iOS 下的默认内边距</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.0</a></td>
</tr>
<tr>
<td>bindfocus</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>输入框聚焦时触发，event.detail = { value, height }，height 为键盘高度，在基础库 1.9.90 起支持</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindblur</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>输入框失去焦点时触发，event.detail = {value, cursor}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindlinechange</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>输入框行数变化时调用，event.detail = {height: 0, heightRpx: 0, lineCount: 0}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindinput</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>当键盘输入时，触发 input 事件，event.detail = {value, cursor, keyCode}，keyCode 为键值，目前工具还不支持返回keyCode参数。<strong>bindinput 处理函数的返回值并不会反映到 textarea 上</strong></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindconfirm</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>点击完成时， 触发 confirm 事件，event.detail = {value: value}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindkeyboardheightchange</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>键盘高度发生变化的时候触发此事件，event.detail = {height: height, duration: duration}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.7.0</a></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-4"><a href="#Bug-amp-Tip-4" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li><p>tip: textarea 的 blur 事件会晚于页面上的 tap 事件，如果需要在 button 的点击事件获取 textarea，可以使用 form 的 bindsubmit。</p>
</li>
<li><p>tip: 不建议在多行文本上对用户的输入进行修改，所以 textarea 的 bindinput 处理函数并不会将返回值反映到 textarea 上。</p>
</li>
<li><p>tip : 键盘高度发生变化，keyboardheightchange事件可能会多次触发，开发者对于相同的height值应该忽略掉</p>
</li>
<li><p>bug: 微信版本 6.3.30，textarea 在列表渲染时，新增加的 textarea 在自动聚焦时的位置计算错误。</p>
</li>
</ol>
<h4 id="示例代码-10"><a href="#示例代码-10" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/QAwRn6m86tYu" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"section"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">bindblur</span>=<span class="string">"bindTextAreaBlur"</span> <span class="attr">auto-height</span> <span class="attr">placeholder</span>=<span class="string">"自动变高"</span> /&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"section"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">placeholder</span>=<span class="string">"placeholder颜色是红色的"</span> <span class="attr">placeholder-style</span>=<span class="string">"color:red;"</span>  /&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"section"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">placeholder</span>=<span class="string">"这是一个可以自动聚焦的textarea"</span> <span class="attr">auto-focus</span> /&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"section"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">placeholder</span>=<span class="string">"这个只有在按钮点击的时候才聚焦"</span> <span class="attr">focus</span>=<span class="string">"&#123;&#123;focus&#125;&#125;"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"btn-area"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">bindtap</span>=<span class="string">"bindButtonTap"</span>&gt;</span>使得输入框获取焦点<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"section"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">bindsubmit</span>=<span class="string">"bindFormSubmit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">placeholder</span>=<span class="string">"form 中的 textarea"</span> <span class="attr">name</span>=<span class="string">"textarea"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">form-type</span>=<span class="string">"submit"</span>&gt;</span> 提交 <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//textarea.jsPage(&#123;</span></span><br><span class="line">  data: &#123;</span><br><span class="line">    height: <span class="number">20</span>,</span><br><span class="line">    focus: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  bindButtonTap: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      focus: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  bindTextAreaBlur: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.detail.value)</span><br><span class="line">  &#125;,</span><br><span class="line">  bindFormSubmit: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.detail.value.textarea)</span><br><span class="line">  &#125;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>练习：</strong></p>
<img src="http://photo.wushaopei.com/qiniu653.png" width="100%">

<hr>
<h3 id="导航标签与传值"><a href="#导航标签与传值" class="headerlink" title="导航标签与传值"></a>导航标签与传值</h3><h4 id="navigator"><a href="#navigator" class="headerlink" title="navigator"></a><strong>navigator</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>页面链接。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>target</td>
<td>string</td>
<td>self</td>
<td>否</td>
<td>在哪个目标上发生跳转，默认当前小程序</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>url</td>
<td>string</td>
<td></td>
<td>否</td>
<td>当前小程序内的跳转链接</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>open-type</td>
<td>string</td>
<td>navigate</td>
<td>否</td>
<td>跳转方式</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>delta</td>
<td>number</td>
<td>1</td>
<td>否</td>
<td>当 open-type 为 ‘navigateBack’ 时有效，表示回退的层数</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>app-id</td>
<td>string</td>
<td></td>
<td>否</td>
<td>当target=”miniProgram”时有效，要打开的小程序 appId</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>path</td>
<td>string</td>
<td></td>
<td>否</td>
<td>当target=”miniProgram”时有效，打开的页面路径，如果为空则打开首页</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>extra-data</td>
<td>object</td>
<td></td>
<td>否</td>
<td>当target=”miniProgram”时有效，需要传递给目标小程序的数据，目标小程序可在 App.onLaunch()，App.onShow() 中获取到这份数据。<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/app.html" target="_blank" rel="noopener">详情</a></td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>version</td>
<td>string</td>
<td>release</td>
<td>否</td>
<td>当target=”miniProgram”时有效，要打开的小程序版本</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>hover-class</td>
<td>string</td>
<td>navigator-hover</td>
<td>否</td>
<td>指定点击时的样式类，当hover-class=”none”时，没有点击态效果</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>hover-stop-propagation</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>指定是否阻止本节点的祖先节点出现点击态</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>hover-start-time</td>
<td>number</td>
<td>50</td>
<td>否</td>
<td>按住后多久出现点击态，单位毫秒</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>hover-stay-time</td>
<td>number</td>
<td>600</td>
<td>否</td>
<td>手指松开后点击态保留时间，单位毫秒</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindsuccess</td>
<td>string</td>
<td></td>
<td>否</td>
<td>当target=”miniProgram”时有效，跳转小程序成功</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>bindfail</td>
<td>string</td>
<td></td>
<td>否</td>
<td>当target=”miniProgram”时有效，跳转小程序失败</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
<tr>
<td>bindcomplete</td>
<td>string</td>
<td></td>
<td>否</td>
<td>当target=”miniProgram”时有效，跳转小程序完成</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.0.7</a></td>
</tr>
</tbody></table>
<p><strong>target 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>self</td>
<td>当前小程序</td>
<td></td>
</tr>
<tr>
<td>miniProgram</td>
<td>其它小程序</td>
<td></td>
</tr>
</tbody></table>
<p><strong>open-type 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>navigate</td>
<td>对应 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateTo.html" target="_blank" rel="noopener">wx.navigateTo</a> 或 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/miniprogram-navigate/wx.navigateToMiniProgram.html" target="_blank" rel="noopener">wx.navigateToMiniProgram</a> 的功能</td>
<td></td>
</tr>
<tr>
<td>redirect</td>
<td>对应 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.redirectTo.html" target="_blank" rel="noopener">wx.redirectTo</a> 的功能</td>
<td></td>
</tr>
<tr>
<td>switchTab</td>
<td>对应 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.switchTab.html" target="_blank" rel="noopener">wx.switchTab</a> 的功能</td>
<td></td>
</tr>
<tr>
<td>reLaunch</td>
<td>对应 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.reLaunch.html" target="_blank" rel="noopener">wx.reLaunch</a> 的功能</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>navigateBack</td>
<td>对应 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateBack.html" target="_blank" rel="noopener">wx.navigateBack</a> 的功能</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.1.0</a></td>
</tr>
<tr>
<td>exit</td>
<td>退出小程序，target=”miniProgram”时生效</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.1.0</a></td>
</tr>
</tbody></table>
<p><strong>version 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>develop</td>
<td>开发版</td>
<td></td>
</tr>
<tr>
<td>trial</td>
<td>体验版</td>
<td></td>
</tr>
<tr>
<td>release</td>
<td>正式版，仅在当前小程序为开发版或体验版时此参数有效；如果当前小程序是正式版，则打开的小程序必定是正式版。</td>
<td></td>
</tr>
</tbody></table>
<h4 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a><strong>使用限制</strong></h4><ol>
<li><p>需要用户确认跳转 从 2.3.0 版本开始，在跳转至其他小程序前，将统一增加弹窗，询问是否跳转，用户确认后才可以跳转其他小程序。如果用户点击取消，则回调 fail cancel。</p>
</li>
<li><p>每个小程序可跳转的其他小程序数量限制为不超过 10 个 从 2.4.0 版本以及指定日期（具体待定）开始，开发者提交新版小程序代码时，如使用了跳转其他小程序功能，则需要在代码配置中声明将要跳转的小程序名单，限定不超过 10 个，否则将无法通过审核。该名单可在发布新版时更新，不支持动态修改。配置方法详见 <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/config.html" target="_blank" rel="noopener">配置</a>。调用此接口时，所跳转的 appId 必须在配置列表中，否则回调 fail appId “${appId}” is not in navigateToMiniProgramAppIdList。</p>
</li>
</ol>
<h4 id="关于调试"><a href="#关于调试" class="headerlink" title="关于调试"></a><strong>关于调试</strong></h4><p>· 在开发者工具上调用此 API 并不会真实的跳转到另外的小程序，但是开发者工具会校验本次调用跳转是否成功。<a href="#%E8%B7%B3%E8%BD%AC%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95%E6%94%AF%E6%8C%81">详情</a></p>
<p>· 开发者工具上支持被跳转的小程序处理接收参数的调试。<a href="#%E8%B7%B3%E8%BD%AC%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95%E6%94%AF%E6%8C%81">详情</a></p>
<h4 id="Bug-amp-Tip-5"><a href="#Bug-amp-Tip-5" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li>tip：navigator-hover 默认为 {background-color: rgba(0, 0, 0, 0.1); opacity: 0.7;}, <a href="https://developers.weixin.qq.com/miniprogram/dev/component/navigator.html" target="_blank" rel="noopener">navigator</a> 的子节点背景色应为透明色</li>
</ol>
<h4 id="示例代码-11"><a href="#示例代码-11" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/2Ec11cmI6BY1" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/nav/page2/page2.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span>&gt;</span>pages/nav/page2/page2.wxml<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>这是第2页<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">url</span>=<span class="string">"../page3/page3"</span>&gt;</span>跳转到第3页<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">open-type</span>=<span class="string">"navigateBack"</span> &gt;</span>返回<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--pages/nav/page3/page3.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span>&gt;</span>pages/nav/page3/page3.wxml<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>这是第3页<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">url</span>=<span class="string">"../page2/page2"</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">url</span>=<span class="string">"../page1/page1"</span>&gt;</span>跳转到第1页<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">open-type</span>=<span class="string">"navigateBack"</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/nav/page2/page2.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 生命周期函数--监听页面加载</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    onLoad: <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">    	<span class="built_in">console</span>.log(options)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu654.png" width="100%">

<hr>
<h3 id="image图片组件"><a href="#image图片组件" class="headerlink" title="image图片组件"></a>image图片组件</h3><ul>
<li><p>audio</p>
</li>
<li><p>image</p>
</li>
<li><p>video </p>
</li>
<li><p>camera</p>
</li>
<li><p>live-player</p>
</li>
<li><p>live-pusher</p>
</li>
</ul>
<h4 id="image"><a href="#image" class="headerlink" title="image"></a><strong>image</strong></h4><p>基础库 1.0.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>图片。支持 JPG、PNG、SVG、WEBP、GIF 等格式，<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.3.0</a> 起支持云文件ID。</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>src</td>
<td>string</td>
<td></td>
<td>否</td>
<td>图片资源地址</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>mode</td>
<td>string</td>
<td>scaleToFill</td>
<td>否</td>
<td>图片裁剪、缩放的模式</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>webp</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>默认不解析 webP 格式，只支持网络资源</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.9.0</a></td>
</tr>
<tr>
<td>lazy-load</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>图片懒加载，在即将进入一定范围（上下三屏）时才开始加载</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.5.0</a></td>
</tr>
<tr>
<td>show-menu-by-longpress</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>开启长按图片显示识别小程序码菜单</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.7.0</a></td>
</tr>
<tr>
<td>binderror</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>当错误发生时触发，event.detail = {errMsg}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
<tr>
<td>bindload</td>
<td>eventhandle</td>
<td></td>
<td>否</td>
<td>当图片载入完毕时触发，event.detail = {height, width}</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.0.0</a></td>
</tr>
</tbody></table>
<p><strong>mode 的合法值</strong></p>
<table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>scaleToFill</td>
<td>缩放模式，不保持纵横比缩放图片，使图片的宽高完全拉伸至填满 image 元素</td>
<td></td>
</tr>
<tr>
<td>aspectFit</td>
<td>缩放模式，保持纵横比缩放图片，使图片的长边能完全显示出来。也就是说，可以完整地将图片显示出来。</td>
<td></td>
</tr>
<tr>
<td>aspectFill</td>
<td>缩放模式，保持纵横比缩放图片，只保证图片的短边能完全显示出来。也就是说，图片通常只在水平或垂直方向是完整的，另一个方向将会发生截取。</td>
<td></td>
</tr>
<tr>
<td>widthFix</td>
<td>缩放模式，宽度不变，高度自动变化，保持原图宽高比不变</td>
<td></td>
</tr>
<tr>
<td>heightFix</td>
<td>缩放模式，高度不变，宽度自动变化，保持原图宽高比不变</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.3</a></td>
</tr>
<tr>
<td>top</td>
<td>裁剪模式，不缩放图片，只显示图片的顶部区域</td>
<td></td>
</tr>
<tr>
<td>bottom</td>
<td>裁剪模式，不缩放图片，只显示图片的底部区域</td>
<td></td>
</tr>
<tr>
<td>center</td>
<td>裁剪模式，不缩放图片，只显示图片的中间区域</td>
<td></td>
</tr>
<tr>
<td>left</td>
<td>裁剪模式，不缩放图片，只显示图片的左边区域</td>
<td></td>
</tr>
<tr>
<td>right</td>
<td>裁剪模式，不缩放图片，只显示图片的右边区域</td>
<td></td>
</tr>
<tr>
<td>top left</td>
<td>裁剪模式，不缩放图片，只显示图片的左上边区域</td>
<td></td>
</tr>
<tr>
<td>top right</td>
<td>裁剪模式，不缩放图片，只显示图片的右上边区域</td>
<td></td>
</tr>
<tr>
<td>bottom left</td>
<td>裁剪模式，不缩放图片，只显示图片的左下边区域</td>
<td></td>
</tr>
<tr>
<td>bottom right</td>
<td>裁剪模式，不缩放图片，只显示图片的右下边区域</td>
<td></td>
</tr>
</tbody></table>
<h4 id="Bug-amp-Tip-6"><a href="#Bug-amp-Tip-6" class="headerlink" title="Bug &amp; Tip"></a><strong>Bug &amp; Tip</strong></h4><ol>
<li><p>tip：image组件默认宽度300px、高度240px</p>
</li>
<li><p>tip：image组件中二维码/小程序码图片不支持长按识别。仅在wx.previewImage中支持长按识别</p>
</li>
</ol>
<h4 id="示例代码-12"><a href="#示例代码-12" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><p><a href="https://developers.weixin.qq.com/s/3Kcaatmc7Z5s" target="_blank" rel="noopener">在开发者工具中预览效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/image/image.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;src&#125;&#125;"</span> <span class="attr">mode</span>=<span class="string">"&#123;&#123;item.mode&#125;&#125;"</span> <span class="attr">lazy-load</span>=<span class="string">"&#123;&#123;false&#125;&#125;"</span> <span class="attr">style</span>=<span class="string">"width:200px;height:200px"</span> <span class="attr">bindload</span>=<span class="string">"load"</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/image/image.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 页面的初始数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">data: &#123;</span><br><span class="line">array: [&#123;</span><br><span class="line">mode: <span class="string">'scaleToFill'</span>,</span><br><span class="line">text: <span class="string">'scaleToFill：不保持纵横比缩放图片，使图片完全适应'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'aspectFit'</span>,</span><br><span class="line">text: <span class="string">'aspectFit：保持纵横比缩放图片，使图片的长边能完全显示出来'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'aspectFill'</span>,</span><br><span class="line">text: <span class="string">'aspectFill：保持纵横比缩放图片，只保证图片的短边能完全显示出来'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'top'</span>,</span><br><span class="line">text: <span class="string">'top：不缩放图片，只显示图片的顶部区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'bottom'</span>,</span><br><span class="line">text: <span class="string">'bottom：不缩放图片，只显示图片的底部区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'center'</span>,</span><br><span class="line">text: <span class="string">'center：不缩放图片，只显示图片的中间区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'left'</span>,</span><br><span class="line">text: <span class="string">'left：不缩放图片，只显示图片的左边区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'right'</span>,</span><br><span class="line">text: <span class="string">'right：不缩放图片，只显示图片的右边边区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'top left'</span>,</span><br><span class="line">text: <span class="string">'top left：不缩放图片，只显示图片的左上边区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'top right'</span>,</span><br><span class="line">text: <span class="string">'top right：不缩放图片，只显示图片的右上边区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'bottom left'</span>,</span><br><span class="line">text: <span class="string">'bottom left：不缩放图片，只显示图片的左下边区域'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">mode: <span class="string">'bottom right'</span>,</span><br><span class="line">text: <span class="string">'bottom right：不缩放图片，只显示图片的右下边区域'</span></span><br><span class="line">&#125;],</span><br><span class="line">src: <span class="string">"https://res.wx.qq.com/wxdoc/dist/assets/img/0.4cb08bb4.jpg"</span></span><br><span class="line">&#125;,</span><br><span class="line">load: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log( e.detail)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="小程序与后端通信-内网穿透"><a href="#小程序与后端通信-内网穿透" class="headerlink" title="小程序与后端通信 - 内网穿透"></a>小程序与后端通信 - 内网穿透</h3><p><strong>小程序不能直接访问后台接口</strong></p>
<ul>
<li><p>通过内网穿透实现暴露到公网</p>
</li>
<li><p>工具 : ngrok      ngrok.com/</p>
<p><a href="https://ngrok.com/download" target="_blank" rel="noopener">https://ngrok.com/download</a></p>
</li>
</ul>
<p>使用教程： <a href="https://blog.csdn.net/xyy731121463/article/details/95019597" target="_blank" rel="noopener">https://blog.csdn.net/xyy731121463/article/details/95019597</a></p>
<hr>
<h3 id="小程序与后端通信-wx-request使用"><a href="#小程序与后端通信-wx-request使用" class="headerlink" title="小程序与后端通信 - wx.request使用"></a>小程序与后端通信 - wx.request使用</h3><h4 id="RequestTask-wx-request-Object-object"><a href="#RequestTask-wx-request-Object-object" class="headerlink" title="RequestTask wx.request(Object object)"></a><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.html" target="_blank" rel="noopener">RequestTask</a> <strong>wx.request(Object object)</strong></h4><p>发起 HTTPS 网络请求。使用前请注意阅读<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html" target="_blank" rel="noopener">相关说明</a>。</p>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a><strong>参数</strong></h4><h5 id="Object-object"><a href="#Object-object" class="headerlink" title="Object object"></a><strong>Object object</strong></h5><table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>默认值</strong></th>
<th><strong>必填</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>url</td>
<td>string</td>
<td></td>
<td>是</td>
<td>开发者服务器接口地址</td>
<td></td>
</tr>
<tr>
<td>data</td>
<td>string/object/ArrayBuffer</td>
<td></td>
<td>否</td>
<td>请求的参数</td>
<td></td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td></td>
<td>否</td>
<td>设置请求的 header，header 中不能设置 Referer。 content-type 默认为 application/json</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>number</td>
<td></td>
<td>否</td>
<td>超时时间，单位为毫秒</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.0</a></td>
</tr>
<tr>
<td>method</td>
<td>string</td>
<td>GET</td>
<td>否</td>
<td>HTTP 请求方法</td>
<td></td>
</tr>
<tr>
<td>dataType</td>
<td>string</td>
<td>json</td>
<td>否</td>
<td>返回的数据格式</td>
<td></td>
</tr>
<tr>
<td>responseType</td>
<td>string</td>
<td>text</td>
<td>否</td>
<td>响应的数据类型</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.7.0</a></td>
</tr>
<tr>
<td>enableHttp2</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>开启 http2</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.4</a></td>
</tr>
<tr>
<td>enableQuic</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>开启 quic</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.4</a></td>
</tr>
<tr>
<td>enableCache</td>
<td>boolean</td>
<td>false</td>
<td>否</td>
<td>开启 cache</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.4</a></td>
</tr>
<tr>
<td>success</td>
<td>function</td>
<td></td>
<td>否</td>
<td>接口调用成功的回调函数</td>
<td></td>
</tr>
<tr>
<td>fail</td>
<td>function</td>
<td></td>
<td>否</td>
<td>接口调用失败的回调函数</td>
<td></td>
</tr>
<tr>
<td>complete</td>
<td>function</td>
<td></td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
<td></td>
</tr>
</tbody></table>
<h5 id="object-method-的合法值"><a href="#object-method-的合法值" class="headerlink" title="object.method 的合法值"></a><strong>object.method 的合法值</strong></h5><table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>OPTIONS</td>
<td>HTTP 请求 OPTIONS</td>
<td></td>
</tr>
<tr>
<td>GET</td>
<td>HTTP 请求 GET</td>
<td></td>
</tr>
<tr>
<td>HEAD</td>
<td>HTTP 请求 HEAD</td>
<td></td>
</tr>
<tr>
<td>POST</td>
<td>HTTP 请求 POST</td>
<td></td>
</tr>
<tr>
<td>PUT</td>
<td>HTTP 请求 PUT</td>
<td></td>
</tr>
<tr>
<td>DELETE</td>
<td>HTTP 请求 DELETE</td>
<td></td>
</tr>
<tr>
<td>TRACE</td>
<td>HTTP 请求 TRACE</td>
<td></td>
</tr>
<tr>
<td>CONNECT</td>
<td>HTTP 请求 CONNECT</td>
<td></td>
</tr>
</tbody></table>
<h5 id="object-dataType-的合法值"><a href="#object-dataType-的合法值" class="headerlink" title="object.dataType 的合法值"></a><strong>object.dataType 的合法值</strong></h5><table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>json</td>
<td>返回的数据为 JSON，返回后会对返回的数据进行一次 JSON.parse</td>
<td></td>
</tr>
<tr>
<td>其他</td>
<td>不对返回的内容进行 JSON.parse</td>
<td></td>
</tr>
</tbody></table>
<h5 id="object-responseType-的合法值"><a href="#object-responseType-的合法值" class="headerlink" title="object.responseType 的合法值"></a><strong>object.responseType 的合法值</strong></h5><table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>text</td>
<td>响应的数据为文本</td>
<td></td>
</tr>
<tr>
<td>arraybuffer</td>
<td>响应的数据为 ArrayBuffer</td>
<td></td>
</tr>
</tbody></table>
<h5 id="object-success-回调函数"><a href="#object-success-回调函数" class="headerlink" title="object.success 回调函数"></a><strong>object.success 回调函数</strong></h5><p><strong>参数</strong></p>
<h6 id="Object-res"><a href="#Object-res" class="headerlink" title="Object res"></a><strong>Object res</strong></h6><table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>最低版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>data</td>
<td>string/Object/Arraybuffer</td>
<td>开发者服务器返回的数据</td>
<td></td>
</tr>
<tr>
<td>statusCode</td>
<td>number</td>
<td>开发者服务器返回的 HTTP 状态码</td>
<td></td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td>开发者服务器返回的 HTTP Response Header</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">1.2.0</a></td>
</tr>
<tr>
<td>cookies</td>
<td>Array.<string></td>
<td>开发者服务器返回的 cookies，格式为字符串数组</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.0</a></td>
</tr>
<tr>
<td>profile</td>
<td>Object</td>
<td>网络请求过程中一些调试信息</td>
<td><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">2.10.4</a></td>
</tr>
</tbody></table>
<p><strong>res.profile 的结构</strong></p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>redirectStart</td>
<td>number</td>
<td>第一个 HTTP 重定向发生时的时间。有跳转且是同域名内的重定向才算，否则值为 0</td>
</tr>
<tr>
<td>redirectEnd</td>
<td>number</td>
<td>最后一个 HTTP 重定向完成时的时间。有跳转且是同域名内部的重定向才算，否则值为 0</td>
</tr>
<tr>
<td>fetchStart</td>
<td>number</td>
<td>组件准备好使用 HTTP 请求抓取资源的时间，这发生在检查本地缓存之前</td>
</tr>
<tr>
<td>domainLookupStart</td>
<td>number</td>
<td>DNS 域名查询开始的时间，如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</td>
</tr>
<tr>
<td>domainLookupEnd</td>
<td>number</td>
<td>DNS 域名查询完成的时间，如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</td>
</tr>
<tr>
<td>connectStart</td>
<td>number</td>
<td>HTTP（TCP） 开始建立连接的时间，如果是持久连接，则与 fetchStart 值相等。注意如果在传输层发生了错误且重新建立连接，则这里显示的是新建立的连接开始的时间</td>
</tr>
<tr>
<td>connectEnd</td>
<td>number</td>
<td>HTTP（TCP） 完成建立连接的时间（完成握手），如果是持久连接，则与 fetchStart 值相等。注意如果在传输层发生了错误且重新建立连接，则这里显示的是新建立的连接完成的时间。注意这里握手结束，包括安全连接建立完成、SOCKS 授权通过</td>
</tr>
<tr>
<td>SSLconnectionStart</td>
<td>number</td>
<td>SSL建立连接的时间,如果不是安全连接,则值为 0</td>
</tr>
<tr>
<td>SSLconnectionEnd</td>
<td>number</td>
<td>SSL建立完成的时间,如果不是安全连接,则值为 0</td>
</tr>
<tr>
<td>requestStart</td>
<td>number</td>
<td>HTTP请求读取真实文档开始的时间（完成建立连接），包括从本地读取缓存。连接错误重连时，这里显示的也是新建立连接的时间</td>
</tr>
<tr>
<td>requestEnd</td>
<td>number</td>
<td>HTTP请求读取真实文档结束的时间</td>
</tr>
<tr>
<td>responseStart</td>
<td>number</td>
<td>HTTP 开始接收响应的时间（获取到第一个字节），包括从本地读取缓存</td>
</tr>
<tr>
<td>responseEnd</td>
<td>number</td>
<td>HTTP 响应全部接收完成的时间（获取到最后一个字节），包括从本地读取缓存</td>
</tr>
<tr>
<td>rtt</td>
<td>number</td>
<td>当次请求连接过程中实时 rtt</td>
</tr>
<tr>
<td>estimate_nettype</td>
<td>string</td>
<td>评估的网络状态 slow 2g/2g/3g/4g</td>
</tr>
<tr>
<td>httpRttEstimate</td>
<td>number</td>
<td>协议层根据多个请求评估当前网络的 rtt（仅供参考）</td>
</tr>
<tr>
<td>transportRttEstimate</td>
<td>number</td>
<td>传输层根据多个请求评估的当前网络的 rtt（仅供参考）</td>
</tr>
<tr>
<td>downstreamThroughputKbpsEstimate</td>
<td>number</td>
<td>评估当前网络下载的kbps</td>
</tr>
<tr>
<td>throughputKbps</td>
<td>number</td>
<td>当前网络的实际下载kbps</td>
</tr>
<tr>
<td>peerIP</td>
<td>string</td>
<td>当前请求的IP</td>
</tr>
<tr>
<td>port</td>
<td>number</td>
<td>当前请求的端口</td>
</tr>
<tr>
<td>socketReused</td>
<td>boolean</td>
<td>是否复用连接</td>
</tr>
<tr>
<td>sendBytesCount</td>
<td>number</td>
<td>发送的字节数</td>
</tr>
<tr>
<td>receivedBytedCount</td>
<td>number</td>
<td>收到字节数</td>
</tr>
</tbody></table>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a><strong>返回值</strong></h4><h4 id="RequestTask"><a href="#RequestTask" class="headerlink" title="RequestTask"></a><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.html" target="_blank" rel="noopener">RequestTask</a></h4><p>基础库 1.4.0 开始支持，低版本需做<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html" target="_blank" rel="noopener">兼容处理</a>。</p>
<p>请求任务对象</p>
<h4 id="data-参数说明"><a href="#data-参数说明" class="headerlink" title="data 参数说明"></a><strong>data 参数说明</strong></h4><p>最终发送给服务器的数据是 String 类型，如果传入的 data 不是 String 类型，会被转换成 String 。转换规则如下：</p>
<ul>
<li>对于 GET 方法的数据，会将数据转换成 query string（encodeURIComponent(k)=encodeURIComponent(v)&amp;encodeURIComponent(k)=encodeURIComponent(v)…）</li>
<li>对于 POST 方法且 header[‘content-type’] 为 application/json 的数据，会对数据进行 JSON 序列化</li>
<li>对于 POST 方法且 header[‘content-type’] 为 application/x-www-form-urlencoded 的数据，会将数据转换成 query string （encodeURIComponent(k) = encodeURIComponent(v) &amp; encodeURIComponent(k)=encodeURIComponent(v)…）</li>
</ul>
<h4 id="示例代码-13"><a href="#示例代码-13" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pages/requestInterface/requestInterface.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 页面的初始数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    clickme: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        wx.request(&#123;</span><br><span class="line">        url: <span class="string">'http://m3hfuc.natappfree.cc/info'</span>, </span><br><span class="line">        data: &#123;</span><br><span class="line">            id: <span class="number">1001</span>,</span><br><span class="line">            name: <span class="string">"慕课网"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        header: &#123;</span><br><span class="line">        	<span class="string">'content-type'</span>: <span class="string">'application/json'</span> </span><br><span class="line">        &#125;,</span><br><span class="line">        success(res) &#123;</span><br><span class="line">      	  <span class="built_in">console</span>.log(res.data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/requestInterface/requestInterface.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">bindtap</span>=<span class="string">"clickme"</span>&gt;</span>点击<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/info"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonResult  <span class="title">hello2</span><span class="params">(Info info)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	System.out.print(info.toString());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> JsonResult(<span class="number">1</span>,<span class="string">"ok"</span>,info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.webcode.springboot.util;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> JsonResult.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wushaopei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020年5月14日</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于封装服务器到客户端的Json返回值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> soft01</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonResult</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Serializable将对象的状态保存在存储媒体中以便可以在以后重新创建出完全相同的副本</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SUCCESS=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ERROR=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OTHER=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line">    <span class="keyword">private</span> String message = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="keyword">private</span> String pass=<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">()</span></span>&#123;</span><br><span class="line">        state = SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//为了方便，重载n个构造器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">(<span class="keyword">int</span> state, String message, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">(<span class="keyword">int</span> state,String error)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(state,error,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">(<span class="keyword">int</span> state,T data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(state,<span class="string">""</span>,data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">(String error)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(ERROR,error,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(SUCCESS,<span class="string">""</span>,data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">(<span class="keyword">int</span> state)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(state,<span class="string">""</span>,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonResult</span><span class="params">(Throwable e)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(ERROR,e.getMessage(),<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"JsonResult [state="</span> + state + <span class="string">", message="</span> + message + <span class="string">", pass="</span> + pass + <span class="string">", data="</span> + data + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Info</span> </span>&#123;	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">private</span> String name;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="http://photo.wushaopei.com/qiniu666.png" width="80%">

<h4 id="关注橘长的微信公众号，获取有趣文章"><a href="#关注橘长的微信公众号，获取有趣文章" class="headerlink" title="关注橘长的微信公众号，获取有趣文章"></a>关注橘长的微信公众号，获取有趣文章</h4><p><img src="http://photo.wushaopei.com/weixinbanner.jpg " alt="公共号"></p>

]]></content>
      <categories>
        <category>微信小程序</category>
      </categories>
      <tags>
        <tag>button</tag>
      </tags>
  </entry>
</search>
